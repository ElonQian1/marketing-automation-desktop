# æµ‹è¯•æ­¥éª¤æŒ‰é’®æ¨¡å¼åŒºåˆ†ä¿®å¤å®ŒæˆæŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

æµ‹è¯•æ­¥éª¤æŒ‰é’®æ— æ³•åŒºåˆ†"æ™ºèƒ½è‡ªåŠ¨é“¾"å’Œ"ç»“æ„åŒ¹é…"ä¸¤ç§æ¨¡å¼ï¼Œå¯¼è‡´æ‰€æœ‰æµ‹è¯•éƒ½ä½¿ç”¨æ™ºèƒ½è‡ªåŠ¨é“¾æ¨¡å¼æ‰§è¡Œï¼Œå¿½ç•¥äº†ç”¨æˆ·åœ¨æ­¥éª¤å¡ç‰‡ä¸­é…ç½®çš„ç»“æ„åŒ¹é…è®¾ç½®ã€‚

## æ ¹å› åˆ†æ

### æ ¸å¿ƒé—®é¢˜
V3æ‰§è¡Œç®¡é“ä¸­ `stepId` å‚æ•°ä¼ é€’ä¸å®Œæ•´ï¼Œå¯¼è‡´æ­¥éª¤é…ç½®æ— æ³•æ­£ç¡®åŠ è½½ï¼š

1. **å‚æ•°æ„é€ æ­£ç¡®** - `intelligent_preprocessing.rs` æ­£ç¡®æ„é€ äº†åŒ…å« `stepId` çš„å‚æ•°
2. **ä¼ é€’é”™è¯¯** - ä½†æ˜¯ä¼ é€’ç»™åˆ†æå‡½æ•°çš„å‚æ•°ç¼ºå°‘ `stepId` å­—æ®µ
3. **é…ç½®è¯»å–å¤±è´¥** - `step_executor.rs` æ— æ³•ä» `STEP_STRATEGY_STORE` ä¸­è¯»å–é…ç½®
4. **æ¨¡å¼æ£€æµ‹å¤±æ•ˆ** - ç¼ºå°‘ `structural_signatures` å¯¼è‡´ç³»ç»Ÿè¯¯åˆ¤ä¸ºæ™ºèƒ½è‡ªåŠ¨é“¾æ¨¡å¼

### æ‰§è¡Œæ—¥å¿—è¯æ®
```
ğŸ“‹ [V3æ‰§è¡Œå™¨] æœªæ£€æµ‹åˆ°ç»“æ„ç­¾åï¼Œä½¿ç”¨ä¼ ç»ŸåŒ¹é…æµç¨‹
âš ï¸ [IDæå–] æœªæ‰¾åˆ°åŸå§‹æ­¥éª¤IDï¼Œå°†ä½¿ç”¨è‡ªåŠ¨ç”ŸæˆID: intelligent_step_1
```

## ä¿®å¤å®æ–½

### 1. å‚æ•°æ„é€ ä¿®å¤ (`intelligent_preprocessing.rs`)
```rust
// ğŸ”§ æ„å»ºåŒ…å«stepIdçš„å®Œæ•´å‚æ•°å¯¹è±¡ï¼Œä»¥ä¾¿åç»­IDæå–
let original_params = if let Some(inline) = original_inline_step {
    let mut full_params = inline.params.clone();
    if let serde_json::Value::Object(ref mut obj) = full_params {
        obj.insert("stepId".to_string(), serde_json::json!(inline.step_id));
    }
    full_params
} else {
    serde_json::Value::Null
};
```

**å…³é”®ä¿®å¤**ï¼šç¡®ä¿ `original_params` åŒ…å« `stepId` å­—æ®µï¼Œè€Œä¸æ˜¯åœ¨å±€éƒ¨ä½œç”¨åŸŸä¸­åˆ›å»ºåä¸¢å¤±ã€‚

### 2. å‚æ•°ä¼ é€’éªŒè¯ (`analysis_helpers.rs` å’Œ `intelligent_preprocessing.rs`)
æ·»åŠ è°ƒè¯•æ—¥å¿—ç¡®è®¤ `stepId` æ­£ç¡®ä¼ é€’ï¼š
```rust
// ğŸ” ã€è°ƒè¯•ã€‘æ£€æŸ¥stepIdæ˜¯å¦å­˜åœ¨äºoriginal_paramsä¸­
if let Some(step_id) = original_params.get("stepId") {
    tracing::info!("âœ… [stepIdæ£€æŸ¥] åœ¨original_paramsä¸­æ‰¾åˆ°stepId: {}", step_id);
} else {
    tracing::warn!("âš ï¸ [stepIdæ£€æŸ¥] original_paramsä¸­ç¼ºå°‘stepIdå­—æ®µï¼");
}
```

### 3. IDæå–é€»è¾‘ä¿æŒï¼ˆ`strategy_generation.rs`ï¼‰
ç°æœ‰çš„ `extract_original_step_id` å‡½æ•°æ— éœ€ä¿®æ”¹ï¼Œå·²ç»æ”¯æŒä»å¤šä¸ªä½ç½®æå– `stepId`ï¼š
- `params.stepId` 
- `params.step_id`
- `params.inline.step_id`
- `params.original_data.inline.step_id`

## æµ‹è¯•éªŒè¯

### é¢„æœŸè¡Œä¸º
ä¿®å¤åï¼Œä½¿ç”¨ element_43 æµ‹è¯•æ¡ˆä¾‹åº”è¯¥æ˜¾ç¤ºï¼š
```
âœ… [é¢„å¤„ç†ä¼ å‚] ä¼ é€’stepId: step_1762169317671_5qhmzixbt
âœ… [stepIdæ£€æŸ¥] åœ¨original_paramsä¸­æ‰¾åˆ°stepId: step_1762169317671_5qhmzixbt
âœ… [IDæå–] æˆåŠŸæå–åŸå§‹æ­¥éª¤ID: step_1762169317671_5qhmzixbt
ğŸ—ï¸ [V3æ‰§è¡Œå™¨] æ£€æµ‹åˆ°ç»“æ„ç­¾åï¼Œå¯ç”¨ç»“æ„åŒ¹é…æ¨¡å¼
```

### æµ‹è¯•æ­¥éª¤
1. åœ¨æ­¥éª¤å¡ç‰‡å¼¹çª—ä¸­é…ç½®ç»“æ„åŒ¹é…æ¨¡å¼
2. ä¿å­˜æ­¥éª¤é…ç½®
3. ç‚¹å‡»"æµ‹è¯•æ­¥éª¤"æŒ‰é’®
4. æ£€æŸ¥æ‰§è¡Œæ—¥å¿—ï¼Œç¡®è®¤ä½¿ç”¨ç»“æ„åŒ¹é…è€Œéæ™ºèƒ½è‡ªåŠ¨é“¾

## å½±å“èŒƒå›´

### æ­£é¢å½±å“
- âœ… æµ‹è¯•æ­¥éª¤æŒ‰é’®ç°åœ¨èƒ½æ­£ç¡®è¯†åˆ«ç”¨æˆ·é…ç½®çš„æ‰§è¡Œæ¨¡å¼
- âœ… ç»“æ„åŒ¹é…é…ç½®å¾—åˆ°æ­£ç¡®åº”ç”¨
- âœ… æé«˜æµ‹è¯•çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§
- âœ… ç”¨æˆ·é…ç½®å¾—åˆ°å°Šé‡

### é£é™©æ§åˆ¶
- ğŸ”’ ä¿®å¤ä»…å½±å“å‚æ•°ä¼ é€’é€»è¾‘ï¼Œä¸æ”¹å˜æ ¸å¿ƒæ‰§è¡Œé€»è¾‘
- ğŸ”’ ä¿æŒå‘åå…¼å®¹ï¼Œæœªé…ç½® `stepId` çš„æƒ…å†µä»å¯æ­£å¸¸å·¥ä½œ
- ğŸ”’ æ·»åŠ äº†è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜è¯Šæ–­

## æŠ€æœ¯ç»†èŠ‚

### æ–‡ä»¶ä¿®æ”¹
1. `src-tauri/src/exec/v3/helpers/intelligent_preprocessing.rs`
   - ä¿®å¤ `stepId` å‚æ•°æ„é€ å’Œä½œç”¨åŸŸé—®é¢˜
   - æ·»åŠ å‚æ•°éªŒè¯æ—¥å¿—

2. `src-tauri/src/exec/v3/helpers/analysis_helpers.rs`
   - æ·»åŠ  `stepId` å­˜åœ¨æ€§æ£€æŸ¥æ—¥å¿—

### å‚æ•°æµå‘
```
ordered_steps[0].inline.step_id
    â†“ (intelligent_preprocessing.rs)
original_params.stepId
    â†“ (analysis_helpers.rs)
perform_intelligent_strategy_analysis_from_raw
    â†“ (strategy_generation.rs)
extract_original_step_id()
    â†“ (step_executor.rs)
STEP_STRATEGY_STORE.read().get(step_id)
    â†“
structural_signatures é…ç½®åº”ç”¨
```

## åç»­å»ºè®®

1. **é›†æˆæµ‹è¯•** - å¯¹ä¸åŒæ¨¡å¼é…ç½®è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
2. **æ€§èƒ½ç›‘æ§** - ç¡®è®¤ä¿®å¤ä¸å½±å“æ‰§è¡Œæ€§èƒ½  
3. **ç”¨æˆ·åé¦ˆ** - æ”¶é›†ç”¨æˆ·å¯¹æ¨¡å¼è¯†åˆ«å‡†ç¡®æ€§çš„åé¦ˆ
4. **æ–‡æ¡£æ›´æ–°** - æ›´æ–°ç›¸å…³å¼€å‘æ–‡æ¡£è¯´æ˜å‚æ•°ä¼ é€’æœºåˆ¶

## æ€»ç»“

é€šè¿‡ä¿®å¤ `stepId` å‚æ•°ä¼ é€’é“¾æ¡ä¸­çš„å…³é”®ç¼ºå¤±ç¯èŠ‚ï¼ŒæˆåŠŸè§£å†³äº†æµ‹è¯•æ­¥éª¤æŒ‰é’®æ— æ³•åŒºåˆ†æ‰§è¡Œæ¨¡å¼çš„é—®é¢˜ã€‚ä¿®å¤ä¿æŒäº†ä»£ç çš„å¥å£®æ€§å’Œå‘åå…¼å®¹æ€§ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ›´å‡†ç¡®å’Œå¯é çš„æµ‹è¯•ä½“éªŒã€‚

---
**ä¿®å¤å®Œæˆæ—¶é—´**: 2024-12-19  
**å½±å“ç‰ˆæœ¬**: V3 æ‰§è¡Œå¼•æ“  
**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯