# ğŸ” æ§åˆ¶å°æ—¥å¿—ä¼˜åŒ–ä¸ç©ºæ•°æ®é—®é¢˜è¿½è¸ªæ–¹æ¡ˆ

## ğŸ“Š å½“å‰æ—¥å¿—é—®é¢˜åˆ†æ

### 1. **æ ¸å¿ƒé—®é¢˜ï¼šå‰ç«¯å‘é€ç©ºæ•°æ®**
```
âš ï¸ [convertElementToContext] å…ƒç´ æ²¡æœ‰xmlCacheIdï¼ŒXMLå†…å®¹å°†ä¸ºç©º
âŒ [å…³é”®æ•°æ®ç¼ºå¤±] XMLå†…å®¹ä¸ºç©ºæˆ–è¿‡çŸ­ï¼{elementId: 'element_41', xmlContentLength: 0, ...}
```

**æ ¹æœ¬åŸå› **ï¼šå…ƒç´ æ²¡æœ‰ `xmlCacheId`ï¼Œå¯¼è‡´æ— æ³•ä»ç¼“å­˜ä¸­è·å–XMLã€‚

### 2. **æ—¥å¿—å™ªéŸ³é—®é¢˜**
- âœ… `CompactStrategyMenu` ç»„ä»¶æŒ‚è½½æ—¥å¿—é‡å¤ **50+** æ¬¡
- âœ… `DraggableStepCard` æ¸²æŸ“æ—¥å¿—é‡å¤ **40+** æ¬¡  
- âœ… è¿›åº¦æ›´æ–°æ—¥å¿—é‡å¤ **30+** æ¬¡
- âœ… "æœªçŸ¥ä»»åŠ¡" è­¦å‘Šé‡å¤ **20+** æ¬¡
- âœ… `usePageFinder` é…ç½®æ—¥å¿—é‡å¤ **15+** æ¬¡

---

## ğŸ¯ ä¼˜åŒ–ç­–ç•¥

### é˜¶æ®µ1ï¼šä¿ç•™å…³é”®é”™è¯¯ï¼Œç§»é™¤å™ªéŸ³ âœ…

#### A. åˆ›å»ºæ—¥å¿—çº§åˆ«æ§åˆ¶å™¨
```typescript
// src/utils/logger-config.ts
export const LOG_LEVELS = {
  CRITICAL_ERROR: true,   // âŒ å¿…é¡»ä¿ç•™
  WARNING: true,          // âš ï¸ å¿…é¡»ä¿ç•™
  DATA_FLOW: true,        // ğŸ”„ æ•°æ®æµæ—¥å¿—ï¼ˆå…³é”®ï¼‰
  COMPONENT_MOUNT: false, // ğŸš€ ç»„ä»¶æŒ‚è½½ï¼ˆå™ªéŸ³ï¼‰
  RENDER: false,          // ğŸ¯ ç»„ä»¶æ¸²æŸ“ï¼ˆå™ªéŸ³ï¼‰
  PROGRESS: false,        // ğŸ“Š è¿›åº¦æ›´æ–°ï¼ˆå™ªéŸ³ï¼‰
  STATE_SYNC: false,      // ğŸ”„ çŠ¶æ€åŒæ­¥ï¼ˆå™ªéŸ³ï¼‰
  CONFIG: false,          // ğŸ“‹ é…ç½®æ—¥å¿—ï¼ˆå™ªéŸ³ï¼‰
};

// é˜²æŠ–æ—¥å¿—å‡½æ•°
const logCache = new Map<string, number>();
export function logOnce(key: string, message: string, ...args: any[]) {
  const now = Date.now();
  const lastLog = logCache.get(key);
  if (!lastLog || now - lastLog > 5000) { // 5ç§’å†…åªæ‰“å°ä¸€æ¬¡
    console.log(message, ...args);
    logCache.set(key, now);
  }
}
```

#### B. éœ€è¦ä¼˜åŒ–çš„æ–‡ä»¶åŠä¿®æ”¹

**1. `CompactStrategyMenu.tsx`**
```typescript
// è¡Œ89 - å‡å°‘ç»„ä»¶æŒ‚è½½æ—¥å¿—
useEffect(() => {
  if (LOG_LEVELS.COMPONENT_MOUNT) { // ğŸ”¥ æ·»åŠ å¼€å…³
    console.log('ğŸš€ [CompactStrategyMenu] ç»„ä»¶å·²æŒ‚è½½', { stepId });
  }
  return () => {
    if (LOG_LEVELS.COMPONENT_MOUNT) {
      console.log('ğŸ”š [CompactStrategyMenu] ç»„ä»¶å¸è½½', { stepId });
    }
  };
}, []);

// è¡Œ366 - å‡å°‘çŠ¶æ€å˜åŒ–æ—¥å¿—
useEffect(() => {
  if (LOG_LEVELS.STATE_SYNC && (çŠ¶æ€çœŸæ­£æ”¹å˜æ—¶)) { // ğŸ”¥ åªåœ¨å…³é”®çŠ¶æ€å˜åŒ–æ—¶æ‰“å°
    console.log('ğŸ” [CompactStrategyMenu] çŠ¶æ€å˜åŒ–:', ...);
  }
}, [disabled, analysisStatus, ...]);
```

**2. `DraggableStepCard.tsx`**
```typescript
// è¡Œ668 - å‡å°‘æ¸²æŸ“æ—¥å¿—
{LOG_LEVELS.RENDER && console.log('ğŸ¯ [DraggableStepCard] æ¸²æŸ“ CompactStrategyMenu', { stepId, hasSelector })}
```

**3. `use-intelligent-analysis-workflow.ts`**
```typescript
// è¡Œ187 - ä½¿ç”¨é˜²æŠ–æ—¥å¿—
useEffect(() => {
  const handleProgress = (payload) => {
    if (LOG_LEVELS.PROGRESS) {
      logOnce(`progress_${jobId}`, 'ğŸ“Š [Workflow] æ”¶åˆ°åˆ†æè¿›åº¦', { jobId, progress });
    }
    // å®é™…å¤„ç†é€»è¾‘...
  };
}, []);

// è¡Œ200 - åªåœ¨çœŸæ­£æœªçŸ¥æ—¶è­¦å‘Š
if (!currentJobs.has(jobId) && jobId !== lastKnownJobId) { // ğŸ”¥ é¿å…é‡å¤è­¦å‘Š
  console.warn('âš ï¸ [Workflow] æ”¶åˆ°æœªçŸ¥ä»»åŠ¡çš„è¿›åº¦æ›´æ–°', { jobId });
  lastKnownJobId = jobId;
}
```

**4. `usePageFinder.tsx`**
```typescript
// è¡Œ919 - ç§»é™¤å†—ä½™é…ç½®æ—¥å¿—
if (LOG_LEVELS.CONFIG && initialViewMode !== lastViewMode) { // ğŸ”¥ åªåœ¨å˜åŒ–æ—¶æ‰“å°
  console.log('ğŸ“‹ [usePageFinder] pageFinderProps é…ç½®:', { visible, initialViewMode });
  lastViewMode = initialViewMode;
}
```

**5. `useSmartScriptBuilder.ts`**
```typescript
// è¡Œ100 - åªåœ¨å…³é”®çŠ¶æ€å˜åŒ–æ—¶æ‰“å°
if (LOG_LEVELS.STATE_SYNC && (oldStatus !== newStatus || Math.abs(newProgress - oldProgress) >= 20)) {
  console.log('ğŸ”„ [çŠ¶æ€åŒæ­¥] æ›´æ–°æ­¥éª¤å¡çŠ¶æ€:', { stepId, oldStatus, newStatus, oldProgress, newProgress });
}
```

---

### é˜¶æ®µ2ï¼šå¢å¼ºå…³é”®æ•°æ®æµæ—¥å¿— ğŸ”

**ç›®æ ‡**ï¼šæ¸…æ™°è¿½è¸ª XML ä¸ºç©ºçš„å®Œæ•´è·¯å¾„

#### éœ€è¦å¢å¼ºçš„æ—¥å¿—ç‚¹ï¼š

**1. å…ƒç´ é€‰æ‹©æ—¶ - `ElementSelectionPopover.tsx`**
```typescript
onQuickCreate={(element) => {
  console.log('ğŸ¯ [ç”¨æˆ·æ“ä½œ] å¿«é€Ÿåˆ›å»ºæ­¥éª¤å¡ç‰‡:', {
    elementId: element.id,
    hasXmlCacheId: !!(element as any).xmlCacheId,
    xmlCacheId: (element as any).xmlCacheId,
    elementBounds: element.bounds,
  });
  // ...
}
```

**2. XML ç¼“å­˜ç®¡ç†å™¨ - `XmlCacheManager.ts`**
```typescript
public putXml(cacheId: string, xmlContent: string, hash?: string): void {
  console.log('ğŸ’¾ [XmlCache] å­˜å‚¨XML:', {
    cacheId,
    xmlLength: xmlContent.length,
    hash: hash?.substring(0, 16),
    timestamp: Date.now(),
  });
  // ...
}

public getCachedXml(cacheId: string): XmlCacheEntry | undefined {
  const entry = this.cache.get(cacheId);
  if (!entry) {
    console.warn('âš ï¸ [XmlCache] æœªæ‰¾åˆ°ç¼“å­˜:', { cacheId, availableKeys: Array.from(this.cache.keys()).slice(0, 5) });
  } else {
    console.log('âœ… [XmlCache] è¯»å–ç¼“å­˜æˆåŠŸ:', { cacheId, xmlLength: entry.xmlContent.length });
  }
  return entry;
}
```

**3. å…ƒç´ æŠ“å–æ—¶ - `VisualElementView.tsx` æˆ– UI æŠ“å–æœåŠ¡**
```typescript
// åœ¨ UI å…ƒç´ æŠ“å–æ—¶ç«‹å³åˆ†é… xmlCacheId
const elementsWithCache = elements.map(el => {
  const xmlCacheId = generateCacheId();
  XmlCacheManager.getInstance().putXml(xmlCacheId, currentXmlSnapshot, xmlHash);
  
  console.log('ğŸ·ï¸ [å…ƒç´ æŠ“å–] åˆ†é…xmlCacheId:', {
    elementId: el.id,
    xmlCacheId,
    xmlLength: currentXmlSnapshot.length,
  });
  
  return {
    ...el,
    xmlCacheId, // ğŸ”¥ ç¡®ä¿å…ƒç´ æºå¸¦ xmlCacheId
  };
});
```

**4. æ•°æ®å‘é€åˆ°åç«¯å‰ - `intelligent-analysis-backend.ts`**
```typescript
public async startIntelligentAnalysis(
  element_context: ElementSelectionContext,
  // ...
): Promise<{ job_id: string; ... }> {
  console.log('ğŸ“¤ [å‘é€åˆ°åç«¯] è¯·æ±‚æ•°æ®æ£€æŸ¥:', {
    original_xml_length: element_context.xmlSnapshot?.xmlContent?.length || 0,
    original_xml_exists: !!element_context.xmlSnapshot?.xmlContent,
    selected_xpath: element_context.smartMatching?.selectedXPath,
    children_texts: element_context.smartMatching?.childrenTexts || [],
    element_bounds: element_context.smartMatching?.originalBounds,
  });
  
  // ğŸš¨ å¦‚æœ XML ä¸ºç©ºï¼Œç«‹å³æ‹¦æˆªå¹¶è­¦å‘Š
  if (!element_context.xmlSnapshot?.xmlContent || element_context.xmlSnapshot.xmlContent.length < 100) {
    console.error('ğŸš« [é˜»æ­¢å‘é€] XMLå†…å®¹ä¸ºç©ºï¼Œä¸­æ­¢åç«¯è¯·æ±‚ï¼', element_context);
    throw new Error('XMLå†…å®¹ç¼ºå¤±ï¼Œæ— æ³•å¯åŠ¨æ™ºèƒ½åˆ†æ');
  }
  
  // ...
}
```

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Step 1: åˆ›å»ºæ—¥å¿—é…ç½®æ–‡ä»¶
```bash
# åˆ›å»º src/utils/logger-config.ts
```

### Step 2: æ‰¹é‡æ›¿æ¢æ—¥å¿—
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š
1. âœ… ç§»é™¤ `CompactStrategyMenu` æŒ‚è½½æ—¥å¿—ï¼ˆå‡å°‘ 50+ æ¡ï¼‰
2. âœ… ç§»é™¤ `DraggableStepCard` æ¸²æŸ“æ—¥å¿—ï¼ˆå‡å°‘ 40+ æ¡ï¼‰
3. âœ… é˜²æŠ– `analysis:progress` æ—¥å¿—ï¼ˆå‡å°‘ 30+ æ¡ï¼‰
4. âœ… ä¿®å¤ "æœªçŸ¥ä»»åŠ¡" é‡å¤è­¦å‘Šï¼ˆå‡å°‘ 20+ æ¡ï¼‰
5. âœ… ç§»é™¤ `usePageFinder` é…ç½®æ—¥å¿—ï¼ˆå‡å°‘ 15+ æ¡ï¼‰

### Step 3: å¢å¼ºå…³é”®æ—¥å¿—
1. âœ… å…ƒç´ é€‰æ‹©æ—¶æ£€æŸ¥ `xmlCacheId`
2. âœ… XML ç¼“å­˜å­˜å–æ—¶è¯¦ç»†æ—¥å¿—
3. âœ… å…ƒç´ æŠ“å–æ—¶åˆ†é… `xmlCacheId`
4. âœ… å‘é€åç«¯å‰éªŒè¯æ•°æ®å®Œæ•´æ€§

### Step 4: æµ‹è¯•éªŒè¯
```
é¢„æœŸç»“æœï¼š
- æ§åˆ¶å°æ—¥å¿—å‡å°‘ 80%
- åªä¿ç•™å…³é”®é”™è¯¯å’Œè­¦å‘Š
- æ¸…æ™°è¿½è¸ª XML ç©ºæ•°æ®çš„å®Œæ•´è·¯å¾„
```

---

## ğŸ“‹ ä¼˜åŒ–åçš„æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸æµç¨‹ï¼ˆæ— é”™è¯¯ï¼‰ï¼š
```
ğŸ¯ [ç”¨æˆ·æ“ä½œ] å¿«é€Ÿåˆ›å»ºæ­¥éª¤å¡ç‰‡: {elementId: 'element_41', hasXmlCacheId: true, xmlCacheId: 'xml_1761626423', ...}
âœ… [XmlCache] è¯»å–ç¼“å­˜æˆåŠŸ: {cacheId: 'xml_1761626423', xmlLength: 58524}
âœ… [convertElementToContext] ä»ç¼“å­˜è·å–XMLæˆåŠŸ: {xmlCacheId: 'xml_1761626423', xmlContentLength: 58524, ...}
ğŸ“¤ [å‘é€åˆ°åç«¯] è¯·æ±‚æ•°æ®æ£€æŸ¥: {original_xml_length: 58524, original_xml_exists: true, ...}
âœ… [BackendService] åˆ†æä»»åŠ¡å·²å¯åŠ¨ {job_id: '6cb942bd...', ...}
ğŸ† [åˆ†æå®Œæˆ] score=0.88
```

### é”™è¯¯æµç¨‹ï¼ˆXMLä¸ºç©ºï¼‰ï¼š
```
ğŸ¯ [ç”¨æˆ·æ“ä½œ] å¿«é€Ÿåˆ›å»ºæ­¥éª¤å¡ç‰‡: {elementId: 'element_41', hasXmlCacheId: false, xmlCacheId: undefined, ...}
âš ï¸ [convertElementToContext] å…ƒç´ æ²¡æœ‰xmlCacheIdï¼ŒXMLå†…å®¹å°†ä¸ºç©º
âŒ [å…³é”®æ•°æ®ç¼ºå¤±] XMLå†…å®¹ä¸ºç©ºæˆ–è¿‡çŸ­ï¼{elementId: 'element_41', xmlContentLength: 0, warning: 'è¿™å°†å¯¼è‡´åç«¯æ— æ³•è¿›è¡Œå¤±è´¥æ¢å¤å’Œæ™ºèƒ½åˆ†æï¼'}
ğŸš« [é˜»æ­¢å‘é€] XMLå†…å®¹ä¸ºç©ºï¼Œä¸­æ­¢åç«¯è¯·æ±‚ï¼
```

---

## ğŸ› é—®é¢˜æ ¹æºå®šä½

### å½“å‰æ€€ç–‘ç‚¹ï¼š
1. âœ… **å…ƒç´ æŠ“å–æ—¶æœªåˆ†é… `xmlCacheId`**ï¼ˆæœ€å¯èƒ½ï¼‰
   - ä½ç½®ï¼š`VisualElementView.tsx` æˆ– `useVisualMode.ts`
   - ç—‡çŠ¶ï¼šå…ƒç´ å¯¹è±¡ä¸­ç¼ºå°‘ `xmlCacheId` å­—æ®µ

2. âœ… **XML ç¼“å­˜åœ¨å…ƒç´ é€‰æ‹©å‰è¢«æ¸…é™¤**
   - ä½ç½®ï¼š`XmlCacheManager.ts` çš„æ¸…ç†é€»è¾‘
   - ç—‡çŠ¶ï¼š`getCachedXml()` è¿”å› `undefined`

3. âœ… **å…ƒç´ æ•°æ®ä¼ é€’è¿‡ç¨‹ä¸­ä¸¢å¤± `xmlCacheId`**
   - ä½ç½®ï¼š`ElementSelectionPopover.tsx` â†’ `useIntelligentStepCardIntegration.ts`
   - ç—‡çŠ¶ï¼šæ•°æ®ä¼ é€’é“¾è·¯ä¸­å­—æ®µä¸¢å¤±

### ä¸‹ä¸€æ­¥ï¼š
1. åœ¨å…ƒç´ æŠ“å–æ—¶æ·»åŠ æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦åˆ†é…äº† `xmlCacheId`
2. æ£€æŸ¥ XML ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
3. è¿½è¸ªå…ƒç´ æ•°æ®çš„å®Œæ•´ä¼ é€’è·¯å¾„

---

## âœ… æˆåŠŸæ ‡å‡†

1. æ§åˆ¶å°æ—¥å¿—å‡å°‘ **80%**
2. åªä¿ç•™ **âŒ é”™è¯¯** å’Œ **âš ï¸ è­¦å‘Š**
3. å¯ä»¥æ¸…æ™°è¿½è¸ª **XML ç©ºæ•°æ®çš„å®Œæ•´è·¯å¾„**
4. æ‰¾åˆ°å¹¶ä¿®å¤ **`xmlCacheId` ç¼ºå¤±çš„æ ¹æœ¬åŸå› **
