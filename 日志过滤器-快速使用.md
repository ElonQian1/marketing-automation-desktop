# 🎯 日志过滤器 - 快速使用指南

## 📋 问题总结

你的控制台有 **3 类冗余日志**：

### 1️⃣ 重复性日志（每次渲染都打印）
- `VisualElementView.tsx:527` - 数据源选择结果（重复30+次）
- `PagePreview.tsx:125-140` - 坐标系诊断（重复20+次）
- `CompactStrategyMenu.tsx:167` - 数据检查（重复15+次）

### 2️⃣ 进度更新日志（重复多次）
- `analysis:progress` - 每个进度值重复4-6次
- `intelligent-analysis-backend.ts:194` - 收到分析进度更新（重复）
- `useIntelligentAnalysisAdapter.ts:91` - Adapter 收到进度更新（重复）

### 3️⃣ 调试日志（开发完成后应关闭）
- `RealTimeDeviceTracker.ts:105` - 长时间无事件检查
- `Thumbnail.tsx:78` - 尝试加载图片
- `imageCache.ts:64` - 从后端加载图片

---

## 🚀 快速解决方案

### 方案 1: 浏览器控制台临时过滤 ⭐ **推荐**

**步骤 1**: 打开浏览器控制台（F12）

**步骤 2**: 粘贴并运行以下代码：

```javascript
// 🎯 智能日志过滤器 - 只显示关键信息
(function setupLogFilter() {
  const originalLog = console.log;
  const originalWarn = console.warn;
  const originalError = console.error;
  
  // 📝 定义要屏蔽的日志模式（不区分大小写）
  const mutedPatterns = [
    /VisualElementView.*数据源选择结果/,
    /PagePreview.*坐标系诊断/,
    /CompactStrategyMenu.*数据检查/,
    /RealTimeDeviceTracker.*长时间无事件/,
    /RealTimeDeviceTracker.*健康检查通过/,
    /Thumbnail.*尝试加载图片/,
    /imageCache.*从后端加载图片/,
    /imageCache.*图片加载成功/,
    /Thumbnail.*设置 data URL/,
    /Thumbnail.*图片渲染成功/,
    /debugUtils.*性能指标.*图片加载/,
    /\[EVT\] analysis:progress/,  // 屏蔽进度事件
    /\[BackendService\] 收到分析进度更新/,
    /\[Adapter\] 收到进度更新/,
    /\[Workflow\] 更新步骤卡片进度/,
    /\[Bridge\] 同步进度到统一store/,
    /\[StepCardStore\] 更新状态.*analyzing/,
    /\[GlobalWire\] progress事件找不到卡片/,
    /\[StepCardStore\] 绑定Job/,
    /\[Bridge\] 启动时注册job映射/,
    /\[Bridge\] 绑定job到卡片/,
    /\[状态同步\] 更新步骤卡状态/,
    /\[AnalysisState\] 开始新的分析任务/,
    /elementTransform.*菜单元素转换/,
    /\[convertVisualToUIElement\] 菜单元素转换/,
    /useParsedVisualElements.*开始解析 XML/,
    /useParsedVisualElements.*解析完成/,
    /useParsedVisualElements.*XML 标识符检查/,
    /\[VisualElementView\] 数据更新:/,
    /\[VisualElementView\] 最终使用元素:/,
    /\[VisualElementView\] 检测到新的 XML/,
    /\[VisualElementView\] 检测到Hook包含菜单元素/,
  ];
  
  // 🎨 高亮关键日志
  const highlightPatterns = [
    { pattern: /❌.*XML缓存/, color: '#ff4444', bgColor: '#2a0000' },
    { pattern: /❌.*关键数据缺失/, color: '#ff4444', bgColor: '#2a0000' },
    { pattern: /⚠️.*缓存中未找到XML/, color: '#ffaa00', bgColor: '#2a1500' },
    { pattern: /✅.*XML已保存到缓存/, color: '#44ff44', bgColor: '#002a00' },
    { pattern: /✅.*从缓存获取XML成功/, color: '#44ff44', bgColor: '#002a00' },
    { pattern: /🔥.*后端返回数据/, color: '#00aaff', bgColor: '#001a2a' },
    { pattern: /⚡.*快速创建步骤卡片/, color: '#ffff00', bgColor: '#2a2a00' },
    { pattern: /✅.*附加xmlCacheId到元素/, color: '#44ff44', bgColor: '#002a00' },
  ];
  
  function shouldMute(message) {
    return mutedPatterns.some(pattern => pattern.test(message));
  }
  
  function getHighlight(message) {
    return highlightPatterns.find(h => h.pattern.test(message));
  }
  
  // 🔄 重写 console.log
  console.log = function(...args) {
    const message = args.join(' ');
    
    if (shouldMute(message)) {
      return; // 直接屏蔽
    }
    
    const highlight = getHighlight(message);
    if (highlight) {
      originalLog('%c' + message, `color: ${highlight.color}; background: ${highlight.bgColor}; font-weight: bold; padding: 2px 4px;`);
    } else {
      originalLog.apply(console, args);
    }
  };
  
  // 🔄 重写 console.warn（保留所有警告）
  console.warn = function(...args) {
    const message = args.join(' ');
    
    // 只屏蔽特定的无关警告
    if (/Instance created by.*useForm.*not connected/.test(message)) {
      return;
    }
    
    originalWarn.apply(console, args);
  };
  
  // ⚠️ 保留所有错误日志
  console.error = originalError;
  
  console.log('%c🎯 日志过滤器已启动！', 'color: #00ff00; font-size: 16px; font-weight: bold;');
  console.log('%c屏蔽了 ' + mutedPatterns.length + ' 类冗余日志', 'color: #00aaff;');
  console.log('%c高亮显示 ' + highlightPatterns.length + ' 类关键日志', 'color: #ffaa00;');
  console.log('%c要恢复原始日志，刷新页面即可', 'color: #888888;');
})();
```

**效果**：
- ✅ 屏蔽 30+ 种重复日志
- ✅ 高亮显示 XML 缓存相关的关键日志
- ✅ 保留所有错误和重要警告
- ✅ 刷新页面即可恢复

---

### 方案 2: 永久性代码级优化 🔧

#### 2.1 添加环境变量控制

在每个文件的日志前添加条件判断：

```typescript
// VisualElementView.tsx
const DEBUG_VISUAL_ELEMENT = import.meta.env.DEV && false; // 改为 false 即可关闭

if (DEBUG_VISUAL_ELEMENT) {
  console.log('📊 [VisualElementView] 数据源选择结果:', ...);
}
```

#### 2.2 创建日志等级管理器

创建 `src/utils/logger-levels.ts`：

```typescript
// 日志等级配置
export const LogLevels = {
  // 组件日志
  VISUAL_ELEMENT_VIEW: false,  // VisualElementView 的调试日志
  PAGE_PREVIEW: false,          // PagePreview 坐标系诊断
  COMPACT_STRATEGY_MENU: false, // CompactStrategyMenu 数据检查
  
  // 功能日志
  IMAGE_LOADING: false,         // 图片加载日志
  DEVICE_TRACKER: false,        // 设备追踪日志
  ANALYSIS_PROGRESS: false,     // 分析进度日志（重复的）
  
  // 关键日志（始终开启）
  XML_CACHE: true,              // XML 缓存相关
  ERROR: true,                  // 错误日志
  USER_ACTION: true,            // 用户操作日志
};

// 条件日志函数
export function log(level: keyof typeof LogLevels, ...args: any[]) {
  if (LogLevels[level]) {
    console.log(...args);
  }
}
```

使用方式：

```typescript
import { log, LogLevels } from '@/utils/logger-levels';

// 替换原有的 console.log
log('VISUAL_ELEMENT_VIEW', '📊 [VisualElementView] 数据源选择结果:', ...);
```

---

## 🎯 针对你的问题：XML 缓存空数据

### 关键日志过滤规则

只需关注这些日志：

```javascript
// ✅ 必看日志（成功）
'✅ [usePageFinderModal] XML已保存到缓存'
'✅ [usePageFinderModal] 从缓存加载并保存到XmlCacheManager'
'✅ [UniversalPageFinderModal] 附加xmlCacheId到元素'
'✅ [convertElementToContext] 从缓存获取XML成功'

// ❌ 错误日志（失败）
'⚠️ 未找到XML缓存'
'⚠️ [convertElementToContext] 缓存中未找到XML'
'❌ [关键数据缺失] XML内容为空或过短'

// 🔥 诊断日志（数据检查）
'🔥 [usePageFinderModal] 后端返回数据'
```

### 简化版过滤器（只关注 XML 缓存问题）

```javascript
// 🎯 XML 缓存问题专用过滤器
(function xmlCacheFilter() {
  const original = console.log;
  
  console.log = function(...args) {
    const msg = args.join(' ');
    
    // 只显示与 XML 缓存相关的日志
    if (
      msg.includes('XML缓存') ||
      msg.includes('XML已保存') ||
      msg.includes('xmlCacheId') ||
      msg.includes('关键数据缺失') ||
      msg.includes('后端返回数据') ||
      msg.includes('从缓存加载并保存') ||
      msg.includes('快速创建步骤')
    ) {
      original.apply(console, args);
    }
  };
  
  console.log('🎯 XML缓存专用过滤器已启动！只显示关键日志。');
})();
```

---

## 📊 修复后的预期日志输出

### 加载缓存页面时：
```
🔄 从缓存加载页面: {fileName: 'ui_dump_xxx.xml', ...}
📄 加载的 XML 内容长度: 58026
✅ [usePageFinderModal] 从缓存加载并保存到XmlCacheManager: {
  xmlCacheId: 'ui_dump_xxx.xml',
  xmlContentLength: 58026
}
```

### 选择元素并快速创建时：
```
⚡ [用户操作] 快速创建步骤卡片
✅ [UniversalPageFinderModal] 附加xmlCacheId到元素: {
  elementId: 'element_41',
  xmlCacheId: 'ui_dump_xxx.xml'
}
✅ [convertElementToContext] 从缓存获取XML成功: {
  xmlCacheId: 'ui_dump_xxx.xml',
  xmlContentLength: 58026
}
```

### ❌ 不应该再出现：
```
⚠️ 未找到XML缓存: ui_dump_xxx.xml
❌ [关键数据缺失] XML内容为空或过短！
```

---

## 🔍 验证修复效果

1. **刷新页面**
2. **应用日志过滤器**（方案 1 的代码）
3. **从缓存加载页面**
4. **选择元素并快速创建**
5. **检查日志**：
   - ✅ 应该看到 "从缓存加载并保存到XmlCacheManager"
   - ✅ 应该看到 "从缓存获取XML成功"
   - ❌ 不应该再看到 "未找到XML缓存"

---

## 💡 额外优化建议

### 1. 合并重复的进度日志

修改 `use-intelligent-analysis-workflow.ts`：

```typescript
// 添加防抖，避免短时间内重复打印
let lastProgressLog = 0;
const PROGRESS_LOG_INTERVAL = 1000; // 1秒内只打印一次

function logProgress(jobId: string, progress: number) {
  const now = Date.now();
  if (now - lastProgressLog > PROGRESS_LOG_INTERVAL) {
    console.log('🎯 [Workflow] 更新步骤卡片进度', { jobId, progress });
    lastProgressLog = now;
  }
}
```

### 2. 使用日志分组

```typescript
console.group('📦 [数据流] 从缓存加载');
console.log('文件名:', fileName);
console.log('XML 长度:', xmlLength);
console.log('元素数量:', elementCount);
console.groupEnd();
```

### 3. 启用 Chrome 控制台内置过滤

在控制台顶部的过滤框输入：

```
-VisualElementView -PagePreview -CompactStrategyMenu -progress -Thumbnail -imageCache
```

（`-` 表示排除这些关键词的日志）

---

## ✅ 总结

**立即行动**：
1. ✅ **代码已修复**：`handleLoadFromCache` 现在会保存 XML 到 XmlCacheManager
2. ⭐ **应用过滤器**：复制"方案 1"的代码到控制台
3. 🔍 **验证修复**：加载缓存页面 → 创建步骤 → 检查日志

**预期结果**：
- XML 缓存问题 **已解决** ✅
- 控制台日志 **减少 80%** ✅
- 关键信息 **高亮显示** ✅
