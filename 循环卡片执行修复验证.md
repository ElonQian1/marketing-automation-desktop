# 循环卡片执行修复验证

## 问题描述

**原问题**: 循环卡片的播放按钮工作正常,但执行脚本时行为不同。

**根本原因**: 前端在构建 V3 ChainSpec 时,对所有步骤类型硬编码了 `action: "smart_selection"`,而没有从步骤的 `step_type` 字段读取正确的 action 类型。

## 修复内容

### 文件: `src/pages/SmartScriptBuilderPage/helpers/executeScript.ts`

**修改位置**: 第155行附近

**原代码**:
```typescript
const chainSpec = {
  chainId: `step_execution_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
  orderedSteps: [{
    inline: {
      stepId: clickStep.id,
      action: "smart_selection",  // ❌ 硬编码
      params: params
    },
    ref: null
  }],
  // ...
};
```

**修复后**:
```typescript
// 🔥 修复：从步骤类型动态获取action，而不是硬编码
const action = clickStep.step_type || "smart_selection";

const chainSpec = {
  chainId: `step_execution_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
  orderedSteps: [{
    inline: {
      stepId: clickStep.id,
      action: action,  // ✅ 使用步骤实际类型
      params: params
    },
    ref: null
  }],
  // ...
};
```

## 修复原理

1. **循环卡片的步骤类型**:
   - 循环开始步骤: `step_type: "loop_start"`
   - 循环结束步骤: `step_type: "loop_end"`
   - 普通滚动步骤: `step_type: "swipe"` 或 `"smart_scroll"`

2. **后端处理**:
   - 后端 `ScriptPreprocessor` 会识别 `loop_start`/`loop_end` 类型
   - 通过 `linearize_ast()` 展开循环,重复循环体内的步骤
   - 例如:循环3次,每次2个滚动,展开后变成6个滚动步骤

3. **V3引擎匹配**:
   - 后端V3引擎的 `SingleStepAction` 枚举已支持 `LoopStart` 和 `LoopEnd`
   - 但V3引擎主要用于智能选择,循环控制在预处理阶段完成

## 验证步骤

### 1. 准备测试脚本

创建一个包含循环的脚本:
```
循环开始 (loop_id: "test_loop", loop_count: 3)
  滚动步骤 (direction: "down", repeat: 2)
循环结束 (loop_id: "test_loop")
```

### 2. 执行脚本

点击"执行脚本"按钮

### 3. 预期结果

后端日志应该显示:
```
🔄 控制流预处理成功：处理完成，生成 6 个执行步骤
```

实际执行:
- 第1次循环: 滚动2次
- 第2次循环: 滚动2次  
- 第3次循环: 滚动2次
- 总计: 6次滚动

### 4. 检查日志

**成功标志**:
- ✅ 不会看到 `smart_selection` 尝试点击循环标记
- ✅ 看到正确的6次滚动操作
- ✅ 每次滚动之间有2秒间隔

**失败标志**(修复前的行为):
- ❌ 看到 `开始智能策略分析 (Step 0-6)` 尝试智能选择
- ❌ 只执行2次滚动(循环没有展开)
- ❌ 出现 `smart_selection` 失败的错误

## 相关文件

### 前端
- `src/pages/SmartScriptBuilderPage/helpers/executeScript.ts` (已修复)
- `src/modules/smart-script-management/serializers/loop-serializer.ts` (循环序列化)
- `src/types/loopScript.ts` (类型定义)

### 后端
- `src-tauri/src/services/execution/orchestrator.rs` (脚本执行编排)
- `src-tauri/src/services/script_execution/control_flow/preprocessor.rs` (预处理器)
- `src-tauri/src/services/script_execution/control_flow/parser.rs` (循环解析和线性化)
- `src-tauri/src/exec/v3/types.rs` (V3类型定义)

## 提交信息

```bash
git add src/pages/SmartScriptBuilderPage/helpers/executeScript.ts
git commit -m "修复: 循环卡片执行时使用正确的action类型

问题:
- 执行脚本时,循环开始/结束步骤的action被硬编码为'smart_selection'
- 导致后端尝试执行智能选择而不是循环控制
- 循环没有正确展开,只执行一次迭代

修复:
- 从步骤的step_type字段读取action类型
- 确保循环开始/结束步骤使用'loop_start'/'loop_end' action
- 后端ScriptPreprocessor正确识别并展开循环

影响:
- 循环卡片执行脚本时行为现在与播放按钮一致
- 正确展开循环,执行所有迭代
- 不再有智能选择失败的错误"
```

## 后续建议

1. **测试覆盖**:
   - 添加单元测试验证executeScript正确处理循环类型
   - 添加集成测试验证完整的循环执行流程

2. **代码审查**:
   - 检查其他文件是否也有硬编码action的问题
   - 例如: `intelligent-analysis-backend-v3.ts`, `step-pack-service.ts`

3. **文档更新**:
   - 更新循环卡片使用文档
   - 添加action类型映射说明

## 测试时间

修复完成时间: 2025年1月30日
预计测试时间: 10分钟
