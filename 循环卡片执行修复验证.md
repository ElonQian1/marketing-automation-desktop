# å¾ªç¯å¡ç‰‡æ‰§è¡Œä¿®å¤éªŒè¯

## é—®é¢˜æè¿°

**åŸé—®é¢˜**: å¾ªç¯å¡ç‰‡çš„æ’­æ”¾æŒ‰é’®å·¥ä½œæ­£å¸¸,ä½†æ‰§è¡Œè„šæœ¬æ—¶è¡Œä¸ºä¸åŒã€‚

**æ ¹æœ¬åŸå› **: å‰ç«¯åœ¨æ„å»º V3 ChainSpec æ—¶,å¯¹æ‰€æœ‰æ­¥éª¤ç±»å‹ç¡¬ç¼–ç äº† `action: "smart_selection"`,è€Œæ²¡æœ‰ä»æ­¥éª¤çš„ `step_type` å­—æ®µè¯»å–æ­£ç¡®çš„ action ç±»å‹ã€‚

## ä¿®å¤å†…å®¹

### æ–‡ä»¶: `src/pages/SmartScriptBuilderPage/helpers/executeScript.ts`

**ä¿®æ”¹ä½ç½®**: ç¬¬155è¡Œé™„è¿‘

**åŸä»£ç **:
```typescript
const chainSpec = {
  chainId: `step_execution_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
  orderedSteps: [{
    inline: {
      stepId: clickStep.id,
      action: "smart_selection",  // âŒ ç¡¬ç¼–ç 
      params: params
    },
    ref: null
  }],
  // ...
};
```

**ä¿®å¤å**:
```typescript
// ğŸ”¥ ä¿®å¤ï¼šä»æ­¥éª¤ç±»å‹åŠ¨æ€è·å–actionï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 
const action = clickStep.step_type || "smart_selection";

const chainSpec = {
  chainId: `step_execution_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
  orderedSteps: [{
    inline: {
      stepId: clickStep.id,
      action: action,  // âœ… ä½¿ç”¨æ­¥éª¤å®é™…ç±»å‹
      params: params
    },
    ref: null
  }],
  // ...
};
```

## ä¿®å¤åŸç†

1. **å¾ªç¯å¡ç‰‡çš„æ­¥éª¤ç±»å‹**:
   - å¾ªç¯å¼€å§‹æ­¥éª¤: `step_type: "loop_start"`
   - å¾ªç¯ç»“æŸæ­¥éª¤: `step_type: "loop_end"`
   - æ™®é€šæ»šåŠ¨æ­¥éª¤: `step_type: "swipe"` æˆ– `"smart_scroll"`

2. **åç«¯å¤„ç†**:
   - åç«¯ `ScriptPreprocessor` ä¼šè¯†åˆ« `loop_start`/`loop_end` ç±»å‹
   - é€šè¿‡ `linearize_ast()` å±•å¼€å¾ªç¯,é‡å¤å¾ªç¯ä½“å†…çš„æ­¥éª¤
   - ä¾‹å¦‚:å¾ªç¯3æ¬¡,æ¯æ¬¡2ä¸ªæ»šåŠ¨,å±•å¼€åå˜æˆ6ä¸ªæ»šåŠ¨æ­¥éª¤

3. **V3å¼•æ“åŒ¹é…**:
   - åç«¯V3å¼•æ“çš„ `SingleStepAction` æšä¸¾å·²æ”¯æŒ `LoopStart` å’Œ `LoopEnd`
   - ä½†V3å¼•æ“ä¸»è¦ç”¨äºæ™ºèƒ½é€‰æ‹©,å¾ªç¯æ§åˆ¶åœ¨é¢„å¤„ç†é˜¶æ®µå®Œæˆ

## éªŒè¯æ­¥éª¤

### 1. å‡†å¤‡æµ‹è¯•è„šæœ¬

åˆ›å»ºä¸€ä¸ªåŒ…å«å¾ªç¯çš„è„šæœ¬:
```
å¾ªç¯å¼€å§‹ (loop_id: "test_loop", loop_count: 3)
  æ»šåŠ¨æ­¥éª¤ (direction: "down", repeat: 2)
å¾ªç¯ç»“æŸ (loop_id: "test_loop")
```

### 2. æ‰§è¡Œè„šæœ¬

ç‚¹å‡»"æ‰§è¡Œè„šæœ¬"æŒ‰é’®

### 3. é¢„æœŸç»“æœ

åç«¯æ—¥å¿—åº”è¯¥æ˜¾ç¤º:
```
ğŸ”„ æ§åˆ¶æµé¢„å¤„ç†æˆåŠŸï¼šå¤„ç†å®Œæˆï¼Œç”Ÿæˆ 6 ä¸ªæ‰§è¡Œæ­¥éª¤
```

å®é™…æ‰§è¡Œ:
- ç¬¬1æ¬¡å¾ªç¯: æ»šåŠ¨2æ¬¡
- ç¬¬2æ¬¡å¾ªç¯: æ»šåŠ¨2æ¬¡  
- ç¬¬3æ¬¡å¾ªç¯: æ»šåŠ¨2æ¬¡
- æ€»è®¡: 6æ¬¡æ»šåŠ¨

### 4. æ£€æŸ¥æ—¥å¿—

**æˆåŠŸæ ‡å¿—**:
- âœ… ä¸ä¼šçœ‹åˆ° `smart_selection` å°è¯•ç‚¹å‡»å¾ªç¯æ ‡è®°
- âœ… çœ‹åˆ°æ­£ç¡®çš„6æ¬¡æ»šåŠ¨æ“ä½œ
- âœ… æ¯æ¬¡æ»šåŠ¨ä¹‹é—´æœ‰2ç§’é—´éš”

**å¤±è´¥æ ‡å¿—**(ä¿®å¤å‰çš„è¡Œä¸º):
- âŒ çœ‹åˆ° `å¼€å§‹æ™ºèƒ½ç­–ç•¥åˆ†æ (Step 0-6)` å°è¯•æ™ºèƒ½é€‰æ‹©
- âŒ åªæ‰§è¡Œ2æ¬¡æ»šåŠ¨(å¾ªç¯æ²¡æœ‰å±•å¼€)
- âŒ å‡ºç° `smart_selection` å¤±è´¥çš„é”™è¯¯

## ç›¸å…³æ–‡ä»¶

### å‰ç«¯
- `src/pages/SmartScriptBuilderPage/helpers/executeScript.ts` (å·²ä¿®å¤)
- `src/modules/smart-script-management/serializers/loop-serializer.ts` (å¾ªç¯åºåˆ—åŒ–)
- `src/types/loopScript.ts` (ç±»å‹å®šä¹‰)

### åç«¯
- `src-tauri/src/services/execution/orchestrator.rs` (è„šæœ¬æ‰§è¡Œç¼–æ’)
- `src-tauri/src/services/script_execution/control_flow/preprocessor.rs` (é¢„å¤„ç†å™¨)
- `src-tauri/src/services/script_execution/control_flow/parser.rs` (å¾ªç¯è§£æå’Œçº¿æ€§åŒ–)
- `src-tauri/src/exec/v3/types.rs` (V3ç±»å‹å®šä¹‰)

## æäº¤ä¿¡æ¯

```bash
git add src/pages/SmartScriptBuilderPage/helpers/executeScript.ts
git commit -m "ä¿®å¤: å¾ªç¯å¡ç‰‡æ‰§è¡Œæ—¶ä½¿ç”¨æ­£ç¡®çš„actionç±»å‹

é—®é¢˜:
- æ‰§è¡Œè„šæœ¬æ—¶,å¾ªç¯å¼€å§‹/ç»“æŸæ­¥éª¤çš„actionè¢«ç¡¬ç¼–ç ä¸º'smart_selection'
- å¯¼è‡´åç«¯å°è¯•æ‰§è¡Œæ™ºèƒ½é€‰æ‹©è€Œä¸æ˜¯å¾ªç¯æ§åˆ¶
- å¾ªç¯æ²¡æœ‰æ­£ç¡®å±•å¼€,åªæ‰§è¡Œä¸€æ¬¡è¿­ä»£

ä¿®å¤:
- ä»æ­¥éª¤çš„step_typeå­—æ®µè¯»å–actionç±»å‹
- ç¡®ä¿å¾ªç¯å¼€å§‹/ç»“æŸæ­¥éª¤ä½¿ç”¨'loop_start'/'loop_end' action
- åç«¯ScriptPreprocessoræ­£ç¡®è¯†åˆ«å¹¶å±•å¼€å¾ªç¯

å½±å“:
- å¾ªç¯å¡ç‰‡æ‰§è¡Œè„šæœ¬æ—¶è¡Œä¸ºç°åœ¨ä¸æ’­æ”¾æŒ‰é’®ä¸€è‡´
- æ­£ç¡®å±•å¼€å¾ªç¯,æ‰§è¡Œæ‰€æœ‰è¿­ä»£
- ä¸å†æœ‰æ™ºèƒ½é€‰æ‹©å¤±è´¥çš„é”™è¯¯"
```

## åç»­å»ºè®®

1. **æµ‹è¯•è¦†ç›–**:
   - æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯executeScriptæ­£ç¡®å¤„ç†å¾ªç¯ç±»å‹
   - æ·»åŠ é›†æˆæµ‹è¯•éªŒè¯å®Œæ•´çš„å¾ªç¯æ‰§è¡Œæµç¨‹

2. **ä»£ç å®¡æŸ¥**:
   - æ£€æŸ¥å…¶ä»–æ–‡ä»¶æ˜¯å¦ä¹Ÿæœ‰ç¡¬ç¼–ç actionçš„é—®é¢˜
   - ä¾‹å¦‚: `intelligent-analysis-backend-v3.ts`, `step-pack-service.ts`

3. **æ–‡æ¡£æ›´æ–°**:
   - æ›´æ–°å¾ªç¯å¡ç‰‡ä½¿ç”¨æ–‡æ¡£
   - æ·»åŠ actionç±»å‹æ˜ å°„è¯´æ˜

## æµ‹è¯•æ—¶é—´

ä¿®å¤å®Œæˆæ—¶é—´: 2025å¹´1æœˆ30æ—¥
é¢„è®¡æµ‹è¯•æ—¶é—´: 10åˆ†é’Ÿ
