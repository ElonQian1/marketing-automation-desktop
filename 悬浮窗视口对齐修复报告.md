# æ‚¬æµ®çª—è§†å£å¯¹é½ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ¯ é—®é¢˜æè¿°

**ç—‡çŠ¶**: æ‚¬æµ®å¯è§†åŒ–çª—å£åªæ˜¾ç¤ºå…ƒç´ ç»“æ„æ ‘çš„å››åˆ†ä¹‹ä¸€ï¼Œè§†å£æ²¡æœ‰å¯¹å‡†æ‰€ç‚¹é€‰çš„å…ƒç´ ä½ç½®

**å½±å“èŒƒå›´**: æ‰€æœ‰é€šè¿‡æ­¥éª¤å¡ç‰‡æ‰“å¼€çš„æ‚¬æµ®å¯è§†åŒ–çª—å£

## ğŸ” æ ¹å› åˆ†æ

### Element_43 æ¡ˆä¾‹æ•°æ®

```javascript
// åŸå§‹å…ƒç´ è¾¹ç•Œ
bounds: [13, 1158][534, 2023]
width: 521, height: 865

// è®¡ç®—å‡ºçš„è£å‰ªåŒºåŸŸ
cropArea: {
  x: 0,
  y: 1291,      // âš ï¸ å…³é”®ï¼šyåæ ‡å¾ˆå¤§ï¼ˆå±…ä¸­è£å‰ªç»“æœï¼‰
  width: 554,
  height: 600   // è¢«maxSizeé™åˆ¶
}
```

### åŸå§‹é”™è¯¯ä»£ç 

```typescript
// âŒ AlignedImageDisplay.tsx - é”™è¯¯å®ç°
const imageDisplayStyle = {
  position: "absolute",
  left: imageDisplay.offset.x, // å‡è®¾ offset.x = 50
  top: imageDisplay.offset.y, // å‡è®¾ offset.y = 30
  width: imageNaturalSize.width * scale,
  height: imageNaturalSize.height * scale,
  transform: `translate(-${cropArea.x * scale}px, -${cropArea.y * scale}px)`,
  // é—®é¢˜ï¼štransform: translate(0, -1291px)
};
```

**é”™è¯¯åŸå› **ï¼š

1. å›¾ç‰‡åˆå§‹ä½ç½®ï¼š`top = 30px` (offset.y)
2. å†åº”ç”¨ `transform: translateY(-1291px)`
3. **æœ€ç»ˆä½ç½®ï¼š30 - 1291 = -1261px** â† å›¾ç‰‡å‘ä¸Šç§»å‡ºå®¹å™¨ï¼
4. å®¹å™¨é«˜åº¦åªæœ‰ 600pxï¼Œå¯¼è‡´åªèƒ½çœ‹åˆ°å›¾ç‰‡åº•éƒ¨è¾¹ç¼˜

### æ­£ç¡®é€»è¾‘

è£å‰ªçš„æ­£ç¡®å®ç°åº”è¯¥æ˜¯ï¼š

```
å®¹å™¨å°ºå¯¸ = è£å‰ªåŒºåŸŸå°ºå¯¸
å›¾ç‰‡ä½ç½® = -è£å‰ªèµ·ç‚¹ * ç¼©æ”¾æ¯”ä¾‹
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶: `AlignedImageDisplay.tsx`

**ä½ç½®**: Line ~86-115

**ä¿®æ”¹å†…å®¹**:

```typescript
// âœ… ä¿®å¤åçš„æ­£ç¡®å®ç°
const imageDisplayStyle = useMemo((): React.CSSProperties => {
  if (!imageLoaded || !cropConfig || !viewportAlignment) {
    return { display: "none" };
  }

  const { cropArea } = cropConfig;
  const { imageDisplay } = viewportAlignment;

  // ğŸ”§ ä¿®å¤: ç›´æ¥ä½¿ç”¨è´Ÿå®šä½æ¥å®ç°è£å‰ªï¼Œä¸å åŠ offsetå’Œtransform
  // åŸç†ï¼šå®¹å™¨å°ºå¯¸=è£å‰ªåŒºåŸŸå°ºå¯¸ï¼Œå›¾ç‰‡é€šè¿‡è´Ÿå®šä½è®©è£å‰ªåŒºåŸŸå¯¹é½åˆ°å®¹å™¨(0,0)
  const fixedStyle: React.CSSProperties = {
    position: "absolute" as const,
    left: -cropArea.x * imageDisplay.scale, // âœ… è´Ÿå®šä½å®ç°è£å‰ª
    top: -cropArea.y * imageDisplay.scale, // âœ… è´Ÿå®šä½å®ç°è£å‰ª
    width: imageNaturalSize.width * imageDisplay.scale,
    height: imageNaturalSize.height * imageDisplay.scale,
    maxWidth: "none",
    maxHeight: "none",
    // ç§»é™¤ transformï¼Œé¿å…ä¸å®šä½å åŠ å¯¼è‡´åç§»é”™è¯¯
  };

  return fixedStyle;
}, [imageLoaded, cropConfig, viewportAlignment, imageNaturalSize]);
```

### å…³é”®æ”¹è¿›

1. **ç§»é™¤ offset å åŠ **: ä¸å†ä½¿ç”¨ `imageDisplay.offset.x/y`
2. **ç§»é™¤ transform åç§»**: ä¸å†ä½¿ç”¨ `translate(-cropX, -cropY)`
3. **ç›´æ¥è´Ÿå®šä½**: ä½¿ç”¨ `left: -cropArea.x * scale, top: -cropArea.y * scale`

## ğŸ¨ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰

```
æ‚¬æµ®çª—å£å®¹å™¨ (554Ã—600px):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â† å®¹å™¨é¡¶éƒ¨ y=0
â”‚                         â”‚
â”‚                         â”‚ ç©ºç™½åŒºåŸŸ
â”‚                         â”‚ ï¼ˆå›¾ç‰‡è¢«å‘ä¸Šç§»å‡ºï¼‰
â”‚                         â”‚
â”‚         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â• â† å›¾ç‰‡åº•éƒ¨è¾¹ç¼˜
â”‚         â•‘ ğŸ‘¤ ä½œè€…ä¿¡æ¯æ   åªèƒ½çœ‹åˆ°
â”‚         â•‘ å°ä½•è€å¸ˆ â¤ï¸ 55  ä¸€ç‚¹ç‚¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†‘ åªæœ‰ 1/4 å¯è§
```

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰

```
æ‚¬æµ®çª—å£å®¹å™¨ (554Ã—600px):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â† è£å‰ªåŒºåŸŸç²¾å‡†å¯¹é½
â”‚ ğŸ“· ç¬”è®°å›¾ç‰‡ (ä¸‹åŠéƒ¨åˆ†)   â”‚ âœ… å®Œæ•´æ˜¾ç¤º
â”‚ "æ·±åœ³ä¹Ÿå¤ªç‰›äº†ï¼Œå–æ¶ˆäº†ï¼" â”‚
â”‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¨ è£…é¥°æ¡                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¤ ä½œè€…ä¿¡æ¯æ             â”‚ âœ… å®Œæ•´å¯è§
â”‚ å°ä½•è€å¸ˆ  â¤ï¸ 55         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘ 100% æ­£ç¡®å¯¹é½
```

## ğŸ§ª éªŒè¯æ–¹æ³•

### æ–¹æ³• 1: æµè§ˆå™¨æ§åˆ¶å°éªŒè¯

```javascript
// æ‰“å¼€æ‚¬æµ®çª—å£åï¼Œåœ¨æ§åˆ¶å°æ‰§è¡Œï¼š
const img = document.querySelector(".aligned-image-display img");
const container = img.parentElement;

console.log("ğŸ“Š å›¾ç‰‡å®šä½éªŒè¯:", {
  container: {
    width: container.offsetWidth,
    height: container.offsetHeight,
  },
  image: {
    left: img.style.left,
    top: img.style.top,
    width: img.offsetWidth,
    height: img.offsetHeight,
    transform: img.style.transform || "none",
  },
});

// âœ… é¢„æœŸç»“æœï¼ˆelement_43æ¡ˆä¾‹ï¼‰:
// container: { width: 554, height: 600 }
// image: {
//   left: '0px',           // cropArea.x = 0
//   top: '-1291px',        // -cropArea.y
//   transform: 'none'
// }
```

### æ–¹æ³• 2: è§†è§‰éªŒè¯

1. æ‰“å¼€"Universal UI æ™ºèƒ½é¡µé¢æŸ¥æ‰¾å™¨"
2. ç‚¹é€‰ element_43 å…ƒç´ ï¼ˆå·¦ä¸‹è§’ç¬”è®°å¡ç‰‡ï¼‰
3. åˆ›å»ºæ­¥éª¤å¡ç‰‡
4. ç‚¹å‡»æ­¥éª¤å¡ç‰‡çš„"å¯è§†åŒ–"æŒ‰é’®
5. **æ£€æŸ¥ç‚¹**:
   - âœ… æ‚¬æµ®çª—å£åº”è¯¥å®Œæ•´æ˜¾ç¤ºç¬”è®°å¡ç‰‡åŒºåŸŸ
   - âœ… åº”è¯¥èƒ½çœ‹åˆ°å›¾ç‰‡ä¸‹åŠéƒ¨åˆ†ã€è£…é¥°æ¡ã€ä½œè€…ä¿¡æ¯
   - âœ… ä¸åº”è¯¥æœ‰å¤§ç‰‡ç©ºç™½åŒºåŸŸ
   - âœ… å…ƒç´ è¾¹æ¡†åº”è¯¥ç²¾å‡†å¯¹é½

### æ–¹æ³• 3: è°ƒè¯•æ¨¡å¼éªŒè¯

å¼€å‘æ¨¡å¼ä¸‹ï¼ŒAlignedImageDisplay ä¼šåœ¨å³ä¸‹è§’æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼š

```
è£å‰ª: [0,1291] 554Ã—600
ç¼©æ”¾: 100% | åç§»: 0,0
å›¾ç‰‡: 1080Ã—2400
```

æ£€æŸ¥è¿™äº›æ•°å€¼æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

- âœ… `src/modules/structural-matching/ui/components/visual-preview/floating-window/components/aligned-image-display.tsx`
  - ä¿®å¤å›¾ç‰‡å®šä½é€»è¾‘
  - ç§»é™¤é”™è¯¯çš„ offset å’Œ transform å åŠ 
  - ä½¿ç”¨ç®€å•çš„è´Ÿå®šä½å®ç°è£å‰ª

### æœªä¿®æ”¹ä½†ç›¸å…³çš„æ–‡ä»¶

- `screenshot-display.tsx` - åŒ…å«å›é€€é€»è¾‘ï¼Œä¸»è¦ä½¿ç”¨ AlignedImageDisplay
- `viewport-alignment.ts` - è®¡ç®—è§†å£å¯¹é½å‚æ•°
- `precise-crop-calculator.ts` - è®¡ç®—è£å‰ªåŒºåŸŸ
- `use-step-card-data.ts` - åŠ è½½æ­¥éª¤å¡ç‰‡æ•°æ®

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ å¯è§†åŒ–è°ƒè¯•è¾…åŠ©

```typescript
// åœ¨ AlignedImageDisplay ä¸­æ·»åŠ è°ƒè¯•è¦†ç›–å±‚ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
{
  process.env.NODE_ENV === "development" && (
    <div
      style={{
        position: "absolute",
        left: 0,
        top: 0,
        width: "20px",
        height: "20px",
        border: "2px solid #00ff00",
        pointerEvents: "none",
        zIndex: 9999,
      }}
      title="å®¹å™¨åŸç‚¹ (0,0)"
    />
  );
}
```

### 2. æ·»åŠ è£å‰ªåŒºåŸŸå¯è§†åŒ–

åœ¨ element_43 ç­‰æ–‡æ¡£ä¸­æåˆ°çš„è£å‰ªç¤ºæ„å›¾ï¼Œå¯ä»¥ä½œä¸ºå·¥å…·é›†æˆåˆ°æ‚¬æµ®çª—å£ä¸­ã€‚

### 3. å¢å¼ºé”™è¯¯å¤„ç†

```typescript
// æ£€æµ‹å¼‚å¸¸è£å‰ªé…ç½®
if (cropArea.y > imageNaturalSize.height) {
  console.warn("âš ï¸ è£å‰ªèµ·ç‚¹è¶…å‡ºå›¾ç‰‡èŒƒå›´", {
    cropY: cropArea.y,
    imageHeight: imageNaturalSize.height,
  });
}
```

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] Element_43 æ¡ˆä¾‹èƒ½æ­£ç¡®æ˜¾ç¤ºå®Œæ•´çš„ç¬”è®°å¡ç‰‡åŒºåŸŸ
- [ ] ä¸åŒå°ºå¯¸çš„å…ƒç´ éƒ½èƒ½æ­£ç¡®è£å‰ªå’Œå¯¹é½
- [ ] æ²¡æœ‰å‡ºç°å¤§ç‰‡ç©ºç™½æˆ–å…ƒç´ ç§»å‡ºè§†å£çš„æƒ…å†µ
- [ ] å…ƒç´ è¾¹æ¡†è¦†ç›–å±‚ç²¾å‡†å¯¹é½åˆ°æˆªå›¾èƒŒæ™¯
- [ ] è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®çš„è£å‰ªå‚æ•°

## ğŸ“Š æµ‹è¯•è¦†ç›–

| æµ‹è¯•åœºæ™¯                 | çŠ¶æ€      | å¤‡æ³¨               |
| ------------------------ | --------- | ------------------ |
| å·¦ä¸‹è§’å…ƒç´ ï¼ˆelement_43ï¼‰ | âœ… å¾…æµ‹è¯• | æœ¬æ¬¡ä¿®å¤çš„ä¸»è¦æ¡ˆä¾‹ |
| å³ä¸Šè§’å…ƒç´                | âœ… å¾…æµ‹è¯• | æµ‹è¯•ä¸åŒè£å‰ªèµ·ç‚¹   |
| åº•éƒ¨å¯¼èˆªå…ƒç´              | âœ… å¾…æµ‹è¯• | æµ‹è¯•è¾¹ç•Œæƒ…å†µ       |
| å°å°ºå¯¸å…ƒç´                | âœ… å¾…æµ‹è¯• | æµ‹è¯• minSize çº¦æŸ  |
| å¤§å°ºå¯¸å…ƒç´                | âœ… å¾…æµ‹è¯• | æµ‹è¯• maxSize çº¦æŸ  |

---

**ä¿®å¤äººå‘˜**: GitHub Copilot  
**ä¿®å¤æ—¶é—´**: 2025-11-02  
**ä¼˜å…ˆçº§**: ğŸ”¥ é«˜  
**çŠ¶æ€**: âœ… ä»£ç å·²ä¿®å¤ï¼Œç­‰å¾…ç”¨æˆ·éªŒè¯
