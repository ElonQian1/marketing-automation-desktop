# ç»“æ„åŒ¹é…æ•°æ®æºç»Ÿä¸€æœåŠ¡ - å¯ç”¨æŒ‡å—

## ğŸ¯ é—®é¢˜è§£å†³

**ä¹‹å‰çš„é—®é¢˜ï¼š** ç»“æ„åŒ¹é…åŠŸèƒ½æœ‰5ä¸ªä¸åŒçš„æ•°æ®æºï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼š
1. `CompactStrategyMenu` - `window._structuralMatchingElement`  
2. `ElementStructureTree` - `XmlCacheManager.getInstance().getCachedXml()`
3. æ­¥éª¤å¡ç‰‡ - `card.original_element`
4. Hookå‚æ•° - `selectedElement`
5. æ¨¡æ€æ¡†æ˜¾ç¤ºæ•°æ® - å¯èƒ½å·²è¿‡æ—¶

**è§£å†³æ–¹æ¡ˆï¼š** åˆ›å»ºäº† `StructuralMatchingDataProvider` ç»Ÿä¸€æ•°æ®æºç®¡ç†æœåŠ¡ã€‚

## ğŸ“¦ æ–°å¢æœåŠ¡

### 1. `StructuralMatchingDataProvider` - æ ¸å¿ƒæ•°æ®æä¾›è€…
- **ä½ç½®ï¼š** `src/modules/structural-matching/domain/services/structural-matching-data-provider.ts`
- **èŒè´£ï¼š** ç»Ÿä¸€å¤šä¸ªæ•°æ®æºï¼Œæä¾›ä¸€è‡´çš„å…ƒç´ æ•°æ®æ¥å£
- **ç‰¹æ€§ï¼š** æ•°æ®éªŒè¯ã€å¢å¼ºã€ç¼“å­˜ã€è°ƒè¯•è¿½æº¯

### 2. `useStructuralMatchingData` - React Hook
- **ä½ç½®ï¼š** `src/modules/structural-matching/ui/hooks/use-structural-matching-data.ts`  
- **èŒè´£ï¼š** ç®€åŒ–æ•°æ®æä¾›è€…çš„ä½¿ç”¨
- **ç‰¹æ€§ï¼š** è‡ªåŠ¨è·å–ã€åˆ·æ–°ã€é”™è¯¯å¤„ç†

## ğŸš€ å¿«é€Ÿå¯ç”¨æ­¥éª¤

### æ­¥éª¤1: ä¿®æ”¹ CompactStrategyMenu

**æ›¿æ¢ç°æœ‰çš„æ•°æ®ä¼ é€’é€»è¾‘ï¼š**

```typescript
// âŒ æ—§æ–¹å¼ - ä½¿ç”¨å…¨å±€å˜é‡
window._structuralMatchingElement = processedElement;
setStructuralMatchingModalVisible(true);

// âœ… æ–°æ–¹å¼ - ä½¿ç”¨ç»Ÿä¸€æ•°æ®æœåŠ¡
import { StructuralMatchingDataProvider } from '@structural-matching';

const dataProvider = StructuralMatchingDataProvider.getInstance();
await dataProvider.getUnifiedElementData(
  element.id,
  xmlCacheId,
  { 
    stepCard: card,
    selectionContext: fullVisualElements.selectedElement 
  }
);
setStructuralMatchingModalVisible(true);
```

### æ­¥éª¤2: ä¿®æ”¹ StructuralMatchingModal

**ä½¿ç”¨ç»Ÿä¸€Hookï¼š**

```typescript
// âœ… æ–°æ–¹å¼
import { useStructuralMatchingElement } from '@structural-matching';

const StructuralMatchingModal = ({ elementId, xmlCacheId, stepCardData, ... }) => {
  const { data, loading, error } = useStructuralMatchingElement(
    elementId,
    xmlCacheId,
    { stepCard: stepCardData },
    { 
      autoFetch: true,
      onError: (error) => console.error('æ•°æ®è·å–å¤±è´¥:', error)
    }
  );

  if (loading) return <Spin />;
  if (error) return <Alert message={error.message} type="error" />;
  if (!data) return <Alert message="æ•°æ®è·å–å¤±è´¥" type="warning" />;

  // ä½¿ç”¨ data.element æ›¿ä»£ä¹‹å‰çš„å¤šä¸ªæ•°æ®æº
  return (
    <ElementStructureTree 
      element={data.element}
      xmlContent={xmlContent} // ä»ç¼“å­˜è·å–
    />
  );
};
```

### æ­¥éª¤3: ä¿®æ”¹ useHierarchicalMatchingModal

**ç»Ÿä¸€æ•°æ®å…¥å£ï¼š**

```typescript
// âœ… é›†æˆç»Ÿä¸€æ•°æ®æœåŠ¡
import { useStructuralMatchingData } from '@structural-matching';

export const useHierarchicalMatchingModal = () => {
  const { data: unifiedData, fetchData } = useStructuralMatchingData({
    enableValidation: true,
    enableEnhancement: true,
  });

  const generateStructuralSignatures = useCallback(async (elementId: string, xmlCacheId?: string) => {
    // ç¡®ä¿ä½¿ç”¨ç»Ÿä¸€æ•°æ®æº
    await fetchData(elementId, xmlCacheId);
    
    if (!unifiedData) {
      throw new Error('æ— æ³•è·å–ç»Ÿä¸€å…ƒç´ æ•°æ®');
    }

    // ä½¿ç”¨ unifiedData.element è¿›è¡Œåç»­å¤„ç†
    return processElement(unifiedData.element);
  }, [fetchData, unifiedData]);

  return { generateStructuralSignatures, unifiedData };
};
```

## ğŸ”§ é…ç½®é€‰é¡¹

### æ•°æ®æºä¼˜å…ˆçº§é…ç½®
```typescript
const dataProvider = StructuralMatchingDataProvider.getInstance({
  priorityOrder: ['xml_cache', 'step_card', 'selection_context'],
  enableValidation: true,
  enableEnhancement: true,
  caching: {
    enabled: true,
    ttl: 30000, // 30ç§’ç¼“å­˜
  }
});
```

### Hookä½¿ç”¨é…ç½®
```typescript
const { data, loading, error, getDebugInfo } = useStructuralMatchingData({
  autoFetch: true,
  enableValidation: true,
  enableEnhancement: true,
  onError: (error) => {
    console.error('æ•°æ®è·å–å¤±è´¥:', error);
    // å¯ä»¥æ·»åŠ ç”¨æˆ·æç¤º
  },
  onSuccess: (data) => {
    console.log('æ•°æ®è·å–æˆåŠŸ:', data);
  }
});
```

## ğŸ¯ éªŒè¯æµ‹è¯•

### 1. æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
```typescript
// åœ¨æ§åˆ¶å°è¿è¡Œï¼ŒéªŒè¯æ‰€æœ‰æ•°æ®æºè¿”å›ä¸€è‡´ç»“æœ
const provider = StructuralMatchingDataProvider.getInstance();
const elementId = 'element_12';
const xmlCacheId = 'ui_dump_xxx';

const data = await provider.getUnifiedElementData(elementId, xmlCacheId);
console.log('ç»Ÿä¸€æ•°æ®:', data);

// æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
console.log('éªŒè¯ç»“æœ:', data.validation);
console.log('æ•°æ®æ¥æº:', data.dataSource);
```

### 2. ç¼“å­˜æ€§èƒ½æµ‹è¯•  
```typescript
// ç¬¬ä¸€æ¬¡è·å–ï¼ˆä»æºè·å–ï¼‰
console.time('ç¬¬ä¸€æ¬¡è·å–');
await provider.getUnifiedElementData(elementId, xmlCacheId);
console.timeEnd('ç¬¬ä¸€æ¬¡è·å–');

// ç¬¬äºŒæ¬¡è·å–ï¼ˆä»ç¼“å­˜è·å–ï¼‰
console.time('ç¼“å­˜è·å–'); 
await provider.getUnifiedElementData(elementId, xmlCacheId);
console.timeEnd('ç¼“å­˜è·å–');

// æŸ¥çœ‹ç¼“å­˜ä¿¡æ¯
console.log('è°ƒè¯•ä¿¡æ¯:', provider.getDebugInfo());
```

### 3. é”™è¯¯å›é€€æµ‹è¯•
```typescript
// æµ‹è¯•æ•°æ®æºå¤±è´¥æ—¶çš„å›é€€æœºåˆ¶
const data = await provider.getUnifiedElementData(
  'invalid_element',
  'invalid_cache',
  {
    stepCard: { original_element: mockElement },
    selectionContext: mockElement
  }
);
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### è°ƒè¯•ä¿¡æ¯è·å–
```typescript
const { getDebugInfo } = useStructuralMatchingData();

// è·å–è¯¦ç»†è°ƒè¯•ä¿¡æ¯
getDebugInfo();
// è¾“å‡º: { cacheSize, config, cacheEntries: [{ elementId, source, age }] }
```

### æ€§èƒ½ç›‘æ§
```typescript
// æ¯ä¸ªæ•°æ®è·å–éƒ½ä¼šæœ‰è¯¦ç»†æ—¥å¿—
// ğŸ” [StructuralDataProvider] è·å–ç»Ÿä¸€å…ƒç´ æ•°æ®
// ğŸ¯ [StructuralDataProvider] ä½¿ç”¨ç¼“å­˜æ•°æ®  
// âœ… [StructuralDataProvider] æˆåŠŸè·å–æ•°æ®ï¼Œæ¥æº: xml_cache
```

## âš ï¸ è¿ç§»æ³¨æ„äº‹é¡¹

1. **æ¸è¿›å¼æ›¿æ¢ï¼š** å¯ä»¥é€ä¸ªç»„ä»¶æ›¿æ¢ï¼Œæ–°æ—§æ–¹å¼å¯ä»¥å…±å­˜
2. **æ•°æ®æ ¼å¼å…¼å®¹ï¼š** æ–°çš„ç»Ÿä¸€æ ¼å¼å‘ä¸‹å…¼å®¹ç°æœ‰æ ¼å¼
3. **é”™è¯¯å¤„ç†ï¼š** æ–°å¢äº†å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶
4. **æ€§èƒ½ä¼˜åŒ–ï¼š** å†…ç½®ç¼“å­˜é¿å…é‡å¤æ•°æ®è·å–

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¯ç”¨ï¼š** åœ¨ `CompactStrategyMenu.tsx` ä¸­æ›¿æ¢å…¨å±€å˜é‡æ–¹å¼
2. **Hooké›†æˆï¼š** åœ¨ `StructuralMatchingModal` ä¸­ä½¿ç”¨æ–°Hook
3. **éªŒè¯æµ‹è¯•ï¼š** è¿è¡Œæµ‹è¯•ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **æ€§èƒ½éªŒè¯ï¼š** ç¡®è®¤ç¼“å­˜æœºåˆ¶å·¥ä½œæ­£å¸¸
5. **é€æ­¥è¿ç§»ï¼š** å°†å…¶ä»–ç»„ä»¶è¿ç§»åˆ°æ–°çš„æ•°æ®æœåŠ¡

**ç°åœ¨å¯ä»¥è¿è¡Œæµ‹è¯•æ¥éªŒè¯ç»Ÿä¸€æ•°æ®æœåŠ¡æ˜¯å¦è§£å†³äº†ä¹‹å‰çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼** ğŸš€