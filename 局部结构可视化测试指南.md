// 🎯 局部结构可视化测试指南

## 测试目标

验证悬浮窗口能够：

1. ✅ 只显示选中元素区域的背景截图（裁剪其他部分）
2. ✅ 只渲染选中元素及其子元素的结构树
3. ✅ 调整坐标系以选中元素为中心
4. ✅ 实现可拖拽、可折叠的窗口管理

## 关键功能实现

### 1. 背景图片裁剪

```typescript
// 计算背景图片的裁剪样式
const backgroundStyle = useMemo(() => {
  if (!screenshotUrl || !selectedElementBounds) {
    return { backgroundImage: `url(${screenshotUrl})` };
  }

  // 计算背景图片的position和size来实现裁剪效果
  const cropX = -selectedElementBounds.x;
  const cropY = -selectedElementBounds.y;

  return {
    backgroundImage: `url(${screenshotUrl})`,
    backgroundPosition: `${cropX}px ${cropY}px`,
    backgroundRepeat: "no-repeat",
    backgroundSize: "auto",
  };
}, [screenshotUrl, selectedElementBounds]);
```

### 2. 局部元素过滤

```typescript
// 提取选中元素及其子元素的局部结构
const extractLocalElementStructure = (
  allElements: VisualUIElement[],
  selectedElementId: string
): VisualUIElement[] => {
  const selectedElement = allElements.find((el) => el.id === selectedElementId);
  if (!selectedElement) return [];

  const selectedBounds = selectedElement.position;
  if (!selectedBounds) return [selectedElement];

  // 过滤出在选中元素bounds内的所有元素
  const localElements = allElements.filter((element) => {
    if (element.id === selectedElementId) return true;
    return isElementInBounds(element, selectedBounds);
  });

  return localElements;
};
```

### 3. 坐标系调整

```typescript
// 计算相对于选中元素的局部坐标
const localX = elementBounds.x - selectedElementBounds.x;
const localY = elementBounds.y - selectedElementBounds.y;
```

## 测试步骤

### 步骤 1: 打开结构树模态框

1. 选择任意步骤卡片
2. 点击"结构匹配"按钮
3. 进入"元素结构树 (新版组件)"

### 步骤 2: 验证悬浮预览

1. 悬停在结构树的任意节点上
2. 观察右上角的悬浮窗口是否出现
3. 检查是否只显示选中元素区域

### 步骤 3: 测试窗口功能

1. ✅ 拖拽：点击标题栏拖动窗口
2. ✅ 折叠：点击折叠按钮
3. ✅ 关闭：点击关闭按钮

### 步骤 4: 验证精确裁剪

1. 选择不同大小的元素
2. 检查背景图片是否精确裁剪到该元素区域
3. 检查其他区域是否被隐藏

## 核心改进

### 🎯 对比原版 vs 新版

| 功能     | 原版 FloatingVisualOverlay  | 新版 (精确局部)            |
| -------- | --------------------------- | -------------------------- |
| 背景图片 | 显示完整页面截图            | 只显示选中元素区域（裁剪） |
| 元素渲染 | 显示所有页面元素            | 只显示选中元素的结构树     |
| 坐标系   | 使用页面绝对坐标            | 以选中元素为原点的相对坐标 |
| 数据加载 | 基于 PagePreview 的复杂渲染 | 直接的局部元素渲染         |
| 性能     | 渲染大量元素，性能较低      | 只渲染局部元素，性能更好   |

### 🚀 技术优势

1. **精确聚焦**：用户只看到关心的元素区域
2. **性能优化**：减少渲染元素数量
3. **视觉清晰**：背景裁剪消除干扰
4. **用户体验**：符合"局部结构预览"的期望

## 可能的问题与解决

### 问题 1: 背景图片不显示

- **原因**：`screenshotUrl` 为空或路径错误
- **调试**：检查控制台中的数据加载日志

### 问题 2: 元素坐标偏移

- **原因**：`selectedElementBounds` 计算错误
- **调试**：检查 bounds 解析是否正确

### 问题 3: 过滤后元素为空

- **原因**：`isElementInBounds` 逻辑错误
- **调试**：检查边界检测算法

## 下一步优化

1. **智能缩放**：根据元素大小自动调整窗口尺寸
2. **高精度裁剪**：使用 Canvas 实现像素级精确裁剪
3. **动画过渡**：添加平滑的显示/隐藏动画
4. **快捷键支持**：支持 ESC 关闭、方向键移动等
