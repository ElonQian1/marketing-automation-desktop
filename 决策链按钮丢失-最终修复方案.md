# å†³ç­–é“¾æŒ‰é’®ä¸¢å¤± - æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜æ€»ç»“

**ç—‡çŠ¶ï¼š** ä¿å­˜è„šæœ¬åé‡æ–°æ‰“å¼€ï¼Œå†³ç­–é“¾é…ç½®æŒ‰é’®ï¼ˆğŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾ã€ğŸ¯ ç¬¬ä¸€ä¸ªã€ğŸ‘† ç‚¹å‡»ï¼‰å®Œå…¨æ¶ˆå¤±

**æ ¹æœ¬åŸå› ï¼š** `step.strategySelector` å’Œ `step.enableStrategySelector` å­—æ®µåœ¨åºåˆ—åŒ–/ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¸¢å¤±

## âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

é‡‡ç”¨**æ˜¾å¼ä¿å­˜åˆ° parameters** çš„ç­–ç•¥ï¼Œè€Œä¸æ˜¯ä¾èµ– `extensions` æœºåˆ¶ã€‚

### ä¿®å¤å†…å®¹

ä¿®æ”¹äº† `src/modules/smart-script-management/serializers/universal-script-serializer.ts`ï¼š

#### 1. åºåˆ—åŒ–æ—¶ä¿å­˜å­—æ®µï¼ˆç¬¬17-37è¡Œï¼‰

```typescript
static transformToExtendedStepData(step: any, index: number): ExtendedStepData {
  const stepData: ExtendedStepData = {
    id: step.id || `step_${Date.now()}_${index}`,
    stepType: step.step_type || step.type || 'tap',
    name: step.name || `æ­¥éª¤ ${index + 1}`,
    description: step.description || '',
    enabled: step.enabled !== false,
    order: step.order !== undefined ? step.order : index,
    status: step.status || 'active',
    parameters: { ...step.parameters, ...step.params }
  };

  // ğŸ”¥ ã€å…³é”®ä¿®å¤ã€‘å°† strategySelector ç›¸å…³å­—æ®µä¿å­˜åˆ° parameters ä¸­
  // ç¡®ä¿è¿™äº›å­—æ®µåœ¨åºåˆ—åŒ–åèƒ½å¤Ÿè¢«æ­£ç¡®ä¿å­˜å’Œæ¢å¤
  if (step.enableStrategySelector !== undefined) {
    stepData.parameters._enableStrategySelector = step.enableStrategySelector;
  }
  if (step.strategySelector !== undefined) {
    stepData.parameters._strategySelector = step.strategySelector;
  }

  // ... å…¶ä½™ä»£ç 
}
```

#### 2. ååºåˆ—åŒ–æ—¶æ¢å¤å­—æ®µï¼ˆç¬¬158-180è¡Œï¼‰

```typescript
// ğŸ”¥ ã€å…³é”®ä¿®å¤ã€‘ä» parameters ä¸­æ¢å¤ strategySelector ç›¸å…³å­—æ®µ
// è¿™äº›å­—æ®µåœ¨åºåˆ—åŒ–æ—¶è¢«ä¿å­˜åˆ°äº† parameters ä¸­ï¼ˆä½¿ç”¨ _ å‰ç¼€ï¼‰
if (stepData.parameters._enableStrategySelector !== undefined) {
  step.enableStrategySelector = stepData.parameters._enableStrategySelector;
  console.log('âœ… [DataTransformer] ä» parameters æ¢å¤ enableStrategySelector:', step.enableStrategySelector);
}
if (stepData.parameters._strategySelector !== undefined) {
  step.strategySelector = stepData.parameters._strategySelector;
  console.log('âœ… [DataTransformer] ä» parameters æ¢å¤ strategySelector:', {
    hasData: !!step.strategySelector,
    selectedStrategy: step.strategySelector?.selectedStrategy
  });
}
```

## ğŸ” ä¸ºä»€ä¹ˆè¿™æ ·ä¿®å¤ï¼Ÿ

### é—®é¢˜åˆ†æ

1. **åŸæœ‰æœºåˆ¶å¤±æ•ˆ**ï¼š
   - `extensions` æœºåˆ¶ç†è®ºä¸Šåº”è¯¥è‡ªåŠ¨ä¿å­˜æ‰€æœ‰æœªçŸ¥å­—æ®µ
   - ä½†å®é™…æµ‹è¯•ä¸­å‘ç°è¿™äº›å­—æ®µæ²¡æœ‰è¢«æ­£ç¡®ä¿å­˜/æ¢å¤

2. **å¯èƒ½åŸå› **ï¼š
   - `strategySelector` å¯¹è±¡å¯èƒ½åŒ…å«ä¸å¯åºåˆ—åŒ–çš„å†…å®¹
   - åç«¯ Rust ä»£ç å¯èƒ½æ²¡æœ‰æ­£ç¡®å¤„ç† `extensions` å­—æ®µ
   - æŸä¸ªåºåˆ—åŒ–å™¨å¯èƒ½è¦†ç›–äº†é€šç”¨é€»è¾‘

3. **è§£å†³æ€è·¯**ï¼š
   - ä¸ä¾èµ–è‡ªåŠ¨æœºåˆ¶ï¼Œæ˜¾å¼å°†å­—æ®µä¿å­˜åˆ° `parameters` ä¸­
   - `parameters` æ˜¯æ‰€æœ‰æ­¥éª¤éƒ½æœ‰çš„æ ‡å‡†å­—æ®µï¼Œä¿è¯è¢«æ­£ç¡®åºåˆ—åŒ–
   - ä½¿ç”¨ `_` å‰ç¼€é¿å…ä¸ä¸šåŠ¡å­—æ®µå†²çª

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### å‰ç½®æ¡ä»¶

ç¡®ä¿ä»£ç å·²ç»é‡æ–°ç¼–è¯‘ï¼ˆå¦‚æœçƒ­é‡è½½æ­£åœ¨è¿è¡Œï¼Œåº”è¯¥ä¼šè‡ªåŠ¨ç¼–è¯‘ï¼‰ã€‚

### æµ‹è¯•æµç¨‹

1. **åˆ›å»ºæ™ºèƒ½æ­¥éª¤**
   - æ‰“å¼€åº”ç”¨
   - åˆ›å»ºä¸€ä¸ªæ–°çš„æ™ºèƒ½æ­¥éª¤ï¼ˆtap æˆ– smart_find_elementï¼‰
   - ç‚¹å‡»"æ™ºèƒ½åˆ†ææˆ‘æŒ‰é’®"
   - é€‰æ‹©ä¸€ä¸ªå…ƒç´ 
   - é…ç½®å†³ç­–é“¾æŒ‰é’®ï¼ˆä¾‹å¦‚é€‰æ‹©"ğŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾"ï¼‰

2. **éªŒè¯åˆå§‹çŠ¶æ€**
   - ç¡®è®¤å†³ç­–é“¾æŒ‰é’®æ˜¾ç¤ºæ­£å¸¸
   - ç¡®è®¤å¯ä»¥åˆ‡æ¢ä¸åŒæ¨¡å¼

3. **ä¿å­˜è„šæœ¬**
   - ç‚¹å‡»"ä¿å­˜è„šæœ¬"æŒ‰é’®
   - **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰**
   - è§‚å¯Ÿæ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
     ```
     âœ… [DataTransformer] ä» parameters æ¢å¤ enableStrategySelector: true
     âœ… [DataTransformer] ä» parameters æ¢å¤ strategySelector: {...}
     ```

4. **é‡æ–°åŠ è½½è„šæœ¬**
   - å…³é—­å½“å‰è„šæœ¬
   - ä»è„šæœ¬åˆ—è¡¨ä¸­é‡æ–°æ‰“å¼€åˆšæ‰ä¿å­˜çš„è„šæœ¬
   - **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**
   - è§‚å¯Ÿæ˜¯å¦æœ‰æ¢å¤æ—¥å¿—ï¼ˆåŒä¸Šï¼‰

5. **éªŒè¯ç»“æœ**
   - âœ… å†³ç­–é“¾æŒ‰é’®åº”è¯¥æ­£å¸¸æ˜¾ç¤º
   - âœ… æŒ‰é’®é…ç½®åº”è¯¥ä¿æŒä¸å˜
   - âœ… å¯ä»¥ç»§ç»­åˆ‡æ¢æ¨¡å¼

## ğŸ“Š é¢„æœŸç»“æœ

### æˆåŠŸæŒ‡æ ‡

1. **æ§åˆ¶å°æ—¥å¿—**ï¼š
   ```
   âœ… [DataTransformer] ä» parameters æ¢å¤ enableStrategySelector: true
   âœ… [DataTransformer] ä» parameters æ¢å¤ strategySelector: {
     hasData: true,
     selectedStrategy: "smart-auto"
   }
   ```

2. **UI è¡¨ç°**ï¼š
   - å†³ç­–é“¾æŒ‰é’®å®Œæ•´æ˜¾ç¤º
   - æŒ‰é’®é…ç½®æ­£ç¡®ï¼ˆæ˜¾ç¤ºä¹‹å‰é€‰æ‹©çš„æ¨¡å¼ï¼‰
   - è¾…åŠ©æŒ‰é’®ï¼ˆæ‰¹é‡ã€éšæœºç­‰ï¼‰æ˜¾ç¤ºæ­£ç¡®

3. **æŒä¹…åŒ–**ï¼š
   - å¤šæ¬¡ä¿å­˜/é‡æ–°åŠ è½½åé…ç½®ä¾ç„¶æ­£ç¡®
   - ä¸ä¼šå‡ºç°æŒ‰é’®æ¶ˆå¤±çš„é—®é¢˜

## ğŸ› æ•…éšœæ’é™¤

### å¦‚æœæŒ‰é’®ä»ç„¶ä¸æ˜¾ç¤º

#### æ£€æŸ¥æ¸…å•ï¼š

1. **ä»£ç æ˜¯å¦é‡æ–°ç¼–è¯‘ï¼Ÿ**
   - æ£€æŸ¥ç»ˆç«¯è¾“å‡ºï¼Œç¡®è®¤ç¼–è¯‘æˆåŠŸ
   - å¦‚æœçƒ­é‡è½½æ²¡æœ‰è§¦å‘ï¼Œæ‰‹åŠ¨é‡å¯ï¼š`npm run tauri dev`

2. **æ§åˆ¶å°æ˜¯å¦æœ‰æ—¥å¿—ï¼Ÿ**
   - å¦‚æœæ²¡æœ‰çœ‹åˆ° `âœ… [DataTransformer]` æ—¥å¿—ï¼š
     â†’ å¯èƒ½åºåˆ—åŒ–å™¨æ²¡æœ‰è¢«è°ƒç”¨
     â†’ æˆ–è€…å­—æ®µä»ä¸€å¼€å§‹å°±ä¸å­˜åœ¨

3. **æ£€æŸ¥åŸå§‹æ•°æ®**ï¼š
   ```javascript
   // åœ¨ä¿å­˜å‰ï¼Œåœ¨æ§åˆ¶å°è¿è¡Œï¼š
   const step = window.__DEBUG_STEPS__?.[0]; // å‡è®¾æœ‰è°ƒè¯•æ¥å£
   console.log('enableStrategySelector:', step.enableStrategySelector);
   console.log('strategySelector:', step.strategySelector);
   ```

4. **æ£€æŸ¥åºåˆ—åŒ–åçš„æ•°æ®**ï¼š
   - åœ¨ Rust åç«¯æ—¥å¿—ä¸­æŸ¥æ‰¾åºåˆ—åŒ–çš„ JSON
   - æ£€æŸ¥ `parameters` ä¸­æ˜¯å¦åŒ…å«ï¼š
     - `_enableStrategySelector`
     - `_strategySelector`

### å¦‚æœæ—¥å¿—æ˜¾ç¤ºæ¢å¤æˆåŠŸä½†æŒ‰é’®ä»ä¸æ˜¾ç¤º

å¯èƒ½æ˜¯ç»„ä»¶æ¸²æŸ“æ¡ä»¶çš„é—®é¢˜ã€‚æ£€æŸ¥ï¼š

1. **DraggableStepCard.tsx ç¬¬683è¡Œ**ï¼š
   ```typescript
   {step.enableStrategySelector && step.strategySelector && (() => {
     // CompactStrategyMenu æ¸²æŸ“
   })()}
   ```

2. **åœ¨æ§åˆ¶å°ä¸­æ‰‹åŠ¨æ£€æŸ¥æ­¥éª¤å¯¹è±¡**ï¼š
   ```javascript
   // åœ¨ React DevTools ä¸­æ£€æŸ¥ DraggableStepCard ç»„ä»¶çš„ props
   // æˆ–è€…æ·»åŠ ä¸´æ—¶æ—¥å¿—
   ```

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµ

```
åˆ›å»ºæ­¥éª¤ (useIntelligentStepCardIntegration)
  â†“
è®¾ç½® enableStrategySelector: true
è®¾ç½® strategySelector: { ... }
  â†“
ä¿å­˜è„šæœ¬ (ç‚¹å‡»ä¿å­˜æŒ‰é’®)
  â†“
åºåˆ—åŒ– (UniversalScriptSerializer.transformToExtendedStepData)
  â†“
ä¿å­˜åˆ° parameters._enableStrategySelector
ä¿å­˜åˆ° parameters._strategySelector
  â†“
ä¼ ç»™åç«¯ Rust (invoke "save_script")
  â†“
ä¿å­˜åˆ°æ–‡ä»¶/æ•°æ®åº“
  â†“
é‡æ–°åŠ è½½è„šæœ¬ (ä»åˆ—è¡¨æ‰“å¼€)
  â†“
ä»åç«¯è¯»å– (invoke "load_script")
  â†“
ååºåˆ—åŒ– (UniversalScriptSerializer.transformFromExtendedStepData)
  â†“
ä» parameters._enableStrategySelector æ¢å¤
ä» parameters._strategySelector æ¢å¤
  â†“
DraggableStepCard æ¸²æŸ“
  â†“
æ£€æŸ¥ step.enableStrategySelector && step.strategySelector
  â†“
æ¸²æŸ“ CompactStrategyMenu ç»„ä»¶
  â†“
æ˜¾ç¤ºå†³ç­–é“¾æŒ‰é’® âœ…
```

### å­—æ®µå‘½åçº¦å®š

- ä½¿ç”¨ `_` å‰ç¼€è¡¨ç¤ºå†…éƒ¨åºåˆ—åŒ–å­—æ®µ
- é¿å…ä¸ä¸šåŠ¡å­—æ®µå†²çª
- ååºåˆ—åŒ–æ—¶æ¢å¤ä¸ºåŸå§‹å­—æ®µå

## ğŸ‰ é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œç”¨æˆ·åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… åˆ›å»ºåŒ…å«å†³ç­–é“¾é…ç½®çš„æ™ºèƒ½æ­¥éª¤
2. âœ… ä¿å­˜è„šæœ¬
3. âœ… é‡æ–°æ‰“å¼€è„šæœ¬
4. âœ… çœ‹åˆ°å†³ç­–é“¾æŒ‰é’®å®Œæ•´æ˜¾ç¤º
5. âœ… æŒ‰é’®é…ç½®ä¿æŒä¸å˜
6. âœ… å¯ä»¥ç»§ç»­ä½¿ç”¨å’Œä¿®æ”¹é…ç½®

---

**è¯·æŒ‰ç…§ä¸Šè¿°æµ‹è¯•æ­¥éª¤éªŒè¯ä¿®å¤æ•ˆæœï¼Œå¹¶å°†ç»“æœåé¦ˆç»™æˆ‘ï¼**

å¦‚æœé—®é¢˜è§£å†³ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
- ç§»é™¤è°ƒè¯•æ—¥å¿—
- æ›´æ–°ç›¸å…³æ–‡æ¡£
- è€ƒè™‘æ˜¯å¦éœ€è¦å¯¹å…¶ä»–ç±»ä¼¼å­—æ®µåº”ç”¨ç›¸åŒçš„ä¿®å¤ç­–ç•¥

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ï¼š
- å®Œæ•´çš„æ§åˆ¶å°æ—¥å¿—è¾“å‡º
- ä¿å­˜çš„è„šæœ¬ JSON æ–‡ä»¶å†…å®¹ï¼ˆå¦‚æœå¯ä»¥è®¿é—®ï¼‰
- ä»»ä½•é”™è¯¯æˆ–è­¦å‘Šä¿¡æ¯
