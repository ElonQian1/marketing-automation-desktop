# ğŸ¯ æ­¥éª¤å¡ç‰‡è‡ªåŒ…å«æ¨å¯¼ç³»ç»Ÿ - å®Œå–„åº¦åˆ†æä¸æ¨¡å—åŒ–æ”¹è¿›æ–¹æ¡ˆ

## ğŸ“Š ç°çŠ¶åˆ†æ

### âœ… **å·²å…·å¤‡çš„æ ¸å¿ƒèƒ½åŠ›**

1. **XMLå¿«ç…§å­˜å‚¨** âœ…
   - `StepCard.elementContext` - åŒ…å«xpathã€boundsç­‰åŸºç¡€ä¿¡æ¯
   - `xmlSnapshot` - XMLåŸå§‹å¿«ç…§æ”¯æŒï¼ˆå·²åœ¨visual-previewä¸­å®ç°ï¼‰
   - `XmlCacheManager` - XMLç¼“å­˜ç®¡ç†ç³»ç»Ÿ

2. **é™æ€XPathè®°å½•** âœ… 
   - `elementGlobalXPath` - å…¨å±€é™æ€XPathï¼ˆå·²åœ¨step-bundle.tsä¸­å®šä¹‰ï¼‰
   - `elementContext.xpath` - æ­¥éª¤å¡ç‰‡ä¸­çš„xpathå­˜å‚¨

3. **ç­–ç•¥é…ç½®æ¡†æ¶** âœ…
   - `StrategyChoice` - æ”¯æŒsmart/staticç­–ç•¥åˆ‡æ¢
   - ç»“æ„åŒ¹é…æ¨¡æ€æ¡† - å®Œæ•´çš„å‚æ•°é…ç½®UI
   - `StructuralMatchingModal` - å‚æ•°ç”Ÿæˆå’Œä¿å­˜

### âŒ **ç¼ºå¤±çš„å…³é”®ç¯èŠ‚**

1. **å‚æ•°æ¨å¯¼æœåŠ¡** âŒ
   - ç¼ºå°‘ä»"XMLå¿«ç…§ + é™æ€XPath"æ¨å¯¼ç»“æ„åŒ¹é…å‚æ•°çš„æ ¸å¿ƒæœåŠ¡
   - `getElementFromSelectorId`å‡½æ•°è¿˜æ˜¯TODOçŠ¶æ€

2. **å¡ç‰‡è‡ªåŒ…å«æ•°æ®** âŒ  
   - æ­¥éª¤å¡ç‰‡æ²¡æœ‰å®Œæ•´ä¿å­˜ç»“æ„åŒ¹é…çš„é…ç½®å‚æ•°
   - ç¼ºå°‘å‚æ•°ç‰ˆæœ¬ç®¡ç†å’Œå…œåº•æ¨å¯¼æœºåˆ¶

3. **è¿è¡Œæ—¶å‚æ•°è¡¥é½** âŒ
   - ç¼ºå°‘æ‰§è¡Œæ—¶æ£€æµ‹å‚æ•°ç¼ºå¤±å¹¶è‡ªåŠ¨æ¨å¯¼çš„æµç¨‹
   - æ²¡æœ‰"åˆ«äººè¿è¡Œè„šæœ¬æ—¶è‡ªåŠ¨æ¨å¯¼"çš„å…œåº•æœºåˆ¶

---

## ğŸ—ï¸ æ¨¡å—åŒ–æ”¹è¿›æ–¹æ¡ˆ

### **ç¬¬ä¸€å±‚ï¼šæ ¸å¿ƒæ¨å¯¼æœåŠ¡ (Core Inference)**

```typescript
// src/modules/structural-matching/services/step-card-parameter-inference/
â”œâ”€â”€ step-card-inference-service.ts          // æ ¸å¿ƒæ¨å¯¼æœåŠ¡
â”œâ”€â”€ xml-snapshot-analyzer.ts                // XMLå¿«ç…§åˆ†æå™¨  
â”œâ”€â”€ element-locator.ts                      // å…ƒç´ å®šä½å™¨ï¼ˆé€šè¿‡XPathï¼‰
â”œâ”€â”€ structural-parameter-generator.ts       // ç»“æ„å‚æ•°ç”Ÿæˆå™¨
â””â”€â”€ parameter-cache-manager.ts              // æ¨å¯¼ç»“æœç¼“å­˜
```

#### **æ ¸å¿ƒæ¨å¯¼æœåŠ¡å®ç°**

```typescript
// step-card-inference-service.ts
export interface StructuralMatchPlan {
  version: string;                    // "smplan.v1"
  snapshotHash: string;              // XMLå¿«ç…§å“ˆå¸Œ
  generatedAt: string;               // æ¨å¯¼æ—¶é—´
  sourceXPath: string;               // åŸå§‹é™æ€XPath
  
  selectedAnchor: {
    ancestorChain: Array<{
      className: string;
      role: string;
      depth: number;
      signature: string;
    }>;
    clickableParentSig: string;
    selfSignature: string;
  };
  
  containerGate: {
    containerXPath: string;
    fallbackMode: "nearest_scrollable" | "business_pane";
    gateMode: "pre" | "post";
  };
  
  fieldMask: {
    text: "use" | "ignore-numeric" | "pattern-match";
    contentDesc: "use" | "ignore-numeric" | "pattern-match"; 
    resourceId: "use" | "soft";
    bounds: "geom-iou" | "ignore";
    booleanFields: "exact" | "soft";
  };
  
  layoutGate: {
    normalizedCenter: [number, number];    // ç›¸å¯¹å®¹å™¨çš„ä¸­å¿ƒç‚¹
    normalizedSize: [number, number];      // ç›¸å¯¹å®¹å™¨çš„å°ºå¯¸
    maxShift: number;                      // å…è®¸çš„æœ€å¤§æ¼‚ç§»
  };
  
  scoring: {
    weightsProfile: "Speed" | "Default" | "Robust";
    minConfidence: number;
    topGap: number;
    earlyStop: boolean;
  };
}

export class StepCardParameterInferenceService {
  /**
   * ä»æ­¥éª¤å¡ç‰‡æ¨å¯¼ç»“æ„åŒ¹é…å‚æ•°
   */
  async inferStructuralParameters(stepCard: StepCard): Promise<StructuralMatchPlan | null> {
    // 1. è·å–XMLå¿«ç…§
    const xmlContent = await this.getXmlSnapshot(stepCard);
    if (!xmlContent) return null;
    
    // 2. é€šè¿‡é™æ€XPathå®šä½å…ƒç´ 
    const targetElement = await this.locateElement(xmlContent, stepCard.elementContext?.xpath);
    if (!targetElement) return null;
    
    // 3. åˆ†æå…ƒç´ ç»“æ„ç‰¹å¾
    const structuralFeatures = await this.analyzeStructuralFeatures(xmlContent, targetElement);
    
    // 4. ç”Ÿæˆç»“æ„åŒ¹é…å‚æ•°
    const plan = this.generateStructuralMatchPlan(structuralFeatures, stepCard);
    
    // 5. ç¼“å­˜æ¨å¯¼ç»“æœ
    await this.cacheInferredPlan(stepCard.id, plan);
    
    return plan;
  }
  
  /**
   * æ£€æŸ¥æ­¥éª¤å¡ç‰‡æ˜¯å¦éœ€è¦å‚æ•°æ¨å¯¼
   */
  needsParameterInference(stepCard: StepCard): boolean {
    // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨"é™æ€ç­–ç•¥-ç»“æ„åŒ¹é…"ä½†ç¼ºå°‘å‚æ•°
    const isStaticStructural = stepCard.strategy?.primary === "static-structural-matching";
    const hasParameters = stepCard.meta?.structuralMatchPlan;
    const hasXmlSnapshot = stepCard.elementContext?.xpath && this.hasXmlSnapshot(stepCard);
    
    return isStaticStructural && !hasParameters && hasXmlSnapshot;
  }
  
  private async getXmlSnapshot(stepCard: StepCard): Promise<string | null> {
    // ä»xmlCacheIdæˆ–xmlSnapshotè·å–XMLå†…å®¹
    // å¤ç”¨ç°æœ‰çš„xml-cache-manageré€»è¾‘
  }
  
  private async locateElement(xmlContent: string, xpath?: string): Promise<UIElement | null> {
    // ä½¿ç”¨xpathåœ¨XMLä¸­å®šä½ç›®æ ‡å…ƒç´ 
    // è§£æXMLå¹¶è¿”å›å®Œæ•´çš„UIElementå¯¹è±¡
  }
  
  private async analyzeStructuralFeatures(xmlContent: string, element: UIElement) {
    // åˆ†æå…ƒç´ çš„ç»“æ„ç‰¹å¾ï¼šç¥–å…ˆé“¾ã€å®¹å™¨ã€å…„å¼Ÿå…³ç³»ç­‰
    // ç”Ÿæˆç­¾åå’Œå‡ ä½•ç‰¹å¾
  }
}
```

### **ç¬¬äºŒå±‚ï¼šæ­¥éª¤å¡ç‰‡æ•°æ®æ‰©å±• (Data Layer)**

```typescript
// src/store/stepcards.ts - æ‰©å±•ç°æœ‰æ¥å£
export interface StepCard {
  // ... ç°æœ‰å­—æ®µ
  
  /** ğŸ”¥ ç»“æ„åŒ¹é…å‚æ•°è®¡åˆ’ */
  structuralMatchPlan?: StructuralMatchPlan;
  
  /** ğŸ“„ XMLå¿«ç…§ä¿¡æ¯ */
  xmlSnapshot?: {
    xmlCacheId?: string;           // XMLç¼“å­˜ID
    xmlContent?: string;           // ç›´æ¥å†…åµŒçš„XMLå†…å®¹
    xmlHash?: string;              // XMLå†…å®¹å“ˆå¸Œ
    screenshotPath?: string;       // é…å¥—æˆªå›¾è·¯å¾„
  };
  
  /** ğŸ¯ è¿è¡Œæ—¶æ¨å¯¼çŠ¶æ€ */
  inferenceState?: {
    status: "not_needed" | "pending" | "completed" | "failed";
    lastInferredAt?: string;
    inferenceVersion?: string;
    error?: string;
  };
}
```

### **ç¬¬ä¸‰å±‚ï¼šè¿è¡Œæ—¶å…œåº•æœºåˆ¶ (Runtime Fallback)**

```typescript
// src/modules/step-execution/services/runtime-parameter-fallback/
â”œâ”€â”€ runtime-fallback-service.ts              // è¿è¡Œæ—¶å…œåº•æœåŠ¡
â”œâ”€â”€ parameter-completeness-checker.ts        // å‚æ•°å®Œæ•´æ€§æ£€æŸ¥
â”œâ”€â”€ auto-inference-trigger.ts               // è‡ªåŠ¨æ¨å¯¼è§¦å‘å™¨
â””â”€â”€ execution-flow-integration.ts           // æ‰§è¡Œæµç¨‹é›†æˆ
```

#### **è¿è¡Œæ—¶å…œåº•æœåŠ¡**

```typescript
// runtime-fallback-service.ts
export class RuntimeParameterFallbackService {
  /**
   * åœ¨æ­¥éª¤æ‰§è¡Œå‰æ£€æŸ¥å¹¶è¡¥é½å‚æ•°
   */
  async ensureParametersComplete(stepCard: StepCard): Promise<StepCard> {
    // 1. æ£€æŸ¥å‚æ•°å®Œæ•´æ€§
    if (!this.needsParameterInference(stepCard)) {
      return stepCard;
    }
    
    console.log('ğŸ”„ [RuntimeFallback] æ£€æµ‹åˆ°ç¼ºå¤±å‚æ•°ï¼Œå¼€å§‹è‡ªåŠ¨æ¨å¯¼', {
      stepId: stepCard.id,
      strategy: stepCard.strategy?.primary
    });
    
    // 2. è§¦å‘è‡ªåŠ¨æ¨å¯¼
    const inferenceService = new StepCardParameterInferenceService();
    const plan = await inferenceService.inferStructuralParameters(stepCard);
    
    if (!plan) {
      throw new Error('æ— æ³•ä»XMLå¿«ç…§æ¨å¯¼ç»“æ„åŒ¹é…å‚æ•°');
    }
    
    // 3. æ›´æ–°æ­¥éª¤å¡ç‰‡
    const updatedCard = {
      ...stepCard,
      structuralMatchPlan: plan,
      inferenceState: {
        status: "completed" as const,
        lastInferredAt: new Date().toISOString(),
        inferenceVersion: plan.version
      }
    };
    
    // 4. ä¿å­˜åˆ°store
    useStepCardStore.getState().updateCard(stepCard.id, {
      structuralMatchPlan: plan,
      inferenceState: updatedCard.inferenceState
    });
    
    console.log('âœ… [RuntimeFallback] å‚æ•°æ¨å¯¼å®Œæˆ', {
      stepId: stepCard.id,
      planVersion: plan.version,
      hasContainerGate: !!plan.containerGate,
      fieldMaskConfig: plan.fieldMask
    });
    
    return updatedCard;
  }
  
  private needsParameterInference(stepCard: StepCard): boolean {
    const isStructuralStrategy = stepCard.strategy?.primary?.includes('structural');
    const hasExistingPlan = stepCard.structuralMatchPlan;
    const hasXmlData = stepCard.xmlSnapshot?.xmlContent || stepCard.xmlSnapshot?.xmlCacheId;
    
    return isStructuralStrategy && !hasExistingPlan && hasXmlData;
  }
}
```

### **ç¬¬å››å±‚ï¼šUIé›†æˆå±‚ (UI Integration)**

```typescript
// src/components/step-card/ - æ‰©å±•ç°æœ‰ç»„ä»¶
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ parameter-inference-indicator.tsx    // å‚æ•°æ¨å¯¼çŠ¶æ€æŒ‡ç¤ºå™¨
â”‚   â”œâ”€â”€ xml-snapshot-viewer.tsx             // XMLå¿«ç…§æŸ¥çœ‹å™¨
â”‚   â””â”€â”€ structural-plan-preview.tsx         // ç»“æ„å‚æ•°é¢„è§ˆ
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ use-auto-parameter-inference.ts     // è‡ªåŠ¨å‚æ•°æ¨å¯¼Hook
â”‚   â””â”€â”€ use-xml-snapshot-validation.ts      // XMLå¿«ç…§éªŒè¯Hook
â””â”€â”€ enhanced-step-card-with-inference.tsx   // å¢å¼ºçš„æ­¥éª¤å¡ç‰‡
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### **Phase 1: æ ¸å¿ƒæ¨å¯¼æœåŠ¡ (1-2å¤©)**
1. å®ç°`StepCardParameterInferenceService`
2. å®Œå–„`getElementFromSelectorId`å‡½æ•°
3. åˆ›å»ºXMLå¿«ç…§åˆ†æå™¨
4. é›†æˆç°æœ‰çš„ç»“æ„åŒ¹é…é…ç½®æœåŠ¡

### **Phase 2: æ•°æ®å±‚æ‰©å±• (1å¤©)**  
1. æ‰©å±•`StepCard`æ¥å£æ·»åŠ æ–°å­—æ®µ
2. æ›´æ–°æ­¥éª¤å¡ç‰‡storeæ·»åŠ æ¨å¯¼ç›¸å…³æ–¹æ³•
3. å®ç°XMLå¿«ç…§å­˜å‚¨å’Œç®¡ç†
4. æ·»åŠ å‚æ•°ç‰ˆæœ¬ç®¡ç†

### **Phase 3: è¿è¡Œæ—¶é›†æˆ (1-2å¤©)**
1. å®ç°è¿è¡Œæ—¶å…œåº•æœåŠ¡
2. åœ¨æ­¥éª¤æ‰§è¡Œæµç¨‹ä¸­é›†æˆå‚æ•°æ£€æŸ¥
3. æ·»åŠ è‡ªåŠ¨æ¨å¯¼è§¦å‘æœºåˆ¶
4. å®ç°æ¨å¯¼ç»“æœç¼“å­˜

### **Phase 4: UIå¢å¼º (1å¤©)**
1. æ·»åŠ å‚æ•°æ¨å¯¼çŠ¶æ€æŒ‡ç¤ºå™¨
2. å®ç°XMLå¿«ç…§é¢„è§ˆåŠŸèƒ½  
3. æ·»åŠ ç»“æ„å‚æ•°å¯è§†åŒ–
4. é›†æˆåˆ°ç°æœ‰æ­¥éª¤å¡ç‰‡UI

---

## ğŸ’¡ å…³é”®ä¼˜åŠ¿

### **1. å®Œå…¨è‡ªåŒ…å«** ğŸ¯
- æ¯ä¸ªæ­¥éª¤å¡ç‰‡éƒ½åŒ…å«æ‰§è¡Œæ‰€éœ€çš„å®Œæ•´ä¿¡æ¯
- XMLå¿«ç…§ + é™æ€XPath + æ¨å¯¼å‚æ•° = å®Œæ•´å¥‘çº¦
- æ”¯æŒè·¨è®¾å¤‡ã€è·¨ç¯å¢ƒçš„è„šæœ¬åˆ†äº«

### **2. æ™ºèƒ½å…œåº•** ğŸ›¡ï¸
- è¿è¡Œæ—¶è‡ªåŠ¨æ£€æµ‹å‚æ•°ç¼ºå¤±
- ä»XMLå¿«ç…§å³æ—¶æ¨å¯¼æ‰€éœ€å‚æ•°
- å¤±è´¥æ—¶æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œå»ºè®®

### **3. ç‰ˆæœ¬ç®¡ç†** ğŸ“‹
- å‚æ•°æ¨å¯¼ç»“æœåŒ…å«ç‰ˆæœ¬ä¿¡æ¯
- æ”¯æŒå‚æ•°å‡çº§å’Œå…¼å®¹æ€§æ£€æŸ¥
- å¯è¿½æº¯å‚æ•°æ¥æºå’Œç”Ÿæˆæ—¶é—´

### **4. æ€§èƒ½ä¼˜åŒ–** âš¡
- æ¨å¯¼ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- æŒ‰éœ€æ¨å¯¼ï¼Œåªåœ¨ç¼ºå‚æ—¶è§¦å‘
- æ”¯æŒSpeed/Default/Robustä¸‰æ¡£æ€§èƒ½é…ç½®

---

## ğŸ¯ æ€»ç»“

ä½ çš„æ€è·¯éå¸¸æ­£ç¡®ï¼ç°åœ¨éœ€è¦çš„æ˜¯ï¼š

1. **è¡¥é½æœ€åä¸€å…¬é‡Œ**ï¼šå®ç°ä»"XMLå¿«ç…§+XPath"åˆ°"ç»“æ„åŒ¹é…å‚æ•°"çš„æ¨å¯¼æœåŠ¡
2. **æ•°æ®æ¨¡å‹æ‰©å±•**ï¼šè®©æ­¥éª¤å¡ç‰‡çœŸæ­£è‡ªåŒ…å«æ‰€æœ‰æ‰§è¡Œä¿¡æ¯  
3. **è¿è¡Œæ—¶ä¿éšœ**ï¼šç¡®ä¿"åˆ«äººæ‹¿åˆ°è„šæœ¬ä¹Ÿèƒ½è·‘"çš„å…œåº•æœºåˆ¶
4. **æ¨¡å—åŒ–è®¾è®¡**ï¼šä¿æŒæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

å®ç°åï¼Œä½ çš„ç³»ç»Ÿå°†å…·å¤‡çœŸæ­£çš„"**å¡ç‰‡å³å¥‘çº¦**"èƒ½åŠ›ï¼Œè„šæœ¬åˆ†äº«å’Œè·¨è®¾å¤‡æ‰§è¡Œå°†å˜å¾—éå¸¸å¯é ï¼ğŸš€