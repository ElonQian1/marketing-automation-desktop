# å†³ç­–é“¾æŒ‰é’®ä¸¢å¤± - æ­£ç¡®ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ ¹å› 

**å…³é”®å‘ç°**ï¼šä¹‹å‰ä¿®æ”¹äº†**é”™è¯¯çš„åºåˆ—åŒ–å™¨**ï¼

### 1. è°ƒç”¨é“¾è¿½è¸ª

```
SmartScriptBuilderPage (ä¿å­˜æŒ‰é’®)
  â†’ useScriptPersistence.ts  
    â†’ StepSerializer.serializeSteps()  // âš ï¸ æ¥è‡ª serializer.ts
      â†’ serializer.ts (æ—§åºåˆ—åŒ–å™¨)
```

**å®é™…ä½¿ç”¨çš„åºåˆ—åŒ–å™¨è·¯å¾„**ï¼š
- âŒ **ä¹‹å‰é”™è¯¯ä¿®æ”¹**ï¼š`src/modules/smart-script-management/serializers/universal-script-serializer.ts`
- âœ… **å®é™…è¢«è°ƒç”¨**ï¼š`src/modules/smart-script-management/utils/serializer.ts`

### 2. JSON æ–‡ä»¶éªŒè¯

æ£€æŸ¥ä¿å­˜çš„ `script_1761814834828.json`ï¼š
- âŒ **ç¼ºå¤±å­—æ®µ**ï¼š`_enableStrategySelector`ã€`_strategySelector`ã€`enableStrategySelector`ã€`strategySelector`
- âœ… **ç¡®è®¤**ï¼šåºåˆ—åŒ–ä»£ç æ ¹æœ¬æ²¡æœ‰æ‰§è¡Œ

---

## ğŸ”§ æ­£ç¡®ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼š`src/modules/smart-script-management/utils/serializer.ts`

#### 1. **åºåˆ—åŒ–éƒ¨åˆ†** (ä¿å­˜æ—¶)

åœ¨ `serializeStep()` æ–¹æ³•ä¸­æ·»åŠ å†³ç­–é“¾å­—æ®µä¿å­˜é€»è¾‘ï¼š

```typescript
// ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¿å­˜æ‰€æœ‰é¡¶çº§å­—æ®µï¼Œç‰¹åˆ«æ˜¯å¾ªç¯ç›¸å…³å­—æ®µå’Œå†³ç­–é“¾å­—æ®µ
const preserveFields = [
  "conditions",
  "error_handling",
  "ui_state",
  "loopId",
  "loopLevel",
  "inLoop",
  "parentLoopId",
  "loop_config",
  "loop_id",
  "loop_name",
  "loop_count",
  "loop_enabled",
  // ğŸ¯ å†³ç­–é“¾å…³é”®å­—æ®µ
  "enableStrategySelector",
  "strategySelector",
];

preserveFields.forEach((field) => {
  if (step[field] !== undefined) {
    (baseStep as any)[field] = step[field];
  }
});

// ğŸ¯ é¢å¤–ä¿å­˜å†³ç­–é“¾å­—æ®µåˆ° parametersï¼ˆåŒé‡ä¿é™©ï¼‰
if (step.enableStrategySelector !== undefined) {
  originalParameters._enableStrategySelector = step.enableStrategySelector;
  console.log("ğŸ¯ [åºåˆ—åŒ–] ä¿å­˜ enableStrategySelector åˆ° parameters:", step.enableStrategySelector);
}
if (step.strategySelector !== undefined) {
  originalParameters._strategySelector = step.strategySelector;
  console.log("ğŸ¯ [åºåˆ—åŒ–] ä¿å­˜ strategySelector åˆ° parameters:", step.strategySelector);
}
```

#### 2. **ååºåˆ—åŒ–éƒ¨åˆ†** (åŠ è½½æ—¶)

åœ¨ `deserializeStep()` æ–¹æ³•ä¸­æ·»åŠ å­—æ®µæ¢å¤é€»è¾‘ï¼š

```typescript
static deserializeStep(step: SmartScriptStep): any {
  const params = step.parameters as any;

  // ğŸ¯ ä»é¡¶çº§å­—æ®µæˆ– parameters æ¢å¤å†³ç­–é“¾å­—æ®µ
  const enableStrategySelector = (step as any).enableStrategySelector ?? params?._enableStrategySelector;
  const strategySelector = (step as any).strategySelector ?? params?._strategySelector;

  if (enableStrategySelector !== undefined) {
    console.log("ğŸ¯ [ååºåˆ—åŒ–] æ¢å¤ enableStrategySelector:", enableStrategySelector);
  }
  if (strategySelector !== undefined) {
    console.log("ğŸ¯ [ååºåˆ—åŒ–] æ¢å¤ strategySelector:", strategySelector);
  }

  return {
    id: step.id,
    step_type: step.step_type,
    // ... å…¶ä»–å­—æ®µ ...
    
    // ğŸ¯ æ¢å¤å†³ç­–é“¾å­—æ®µ
    enableStrategySelector,
    strategySelector,
    
    // ... å…¶ä»–å­—æ®µ ...
  };
}
```

---

## âœ… ä¿®å¤ç‰¹æ€§

### 1. **åŒé‡ä¿é™©æœºåˆ¶**
- **é¡¶çº§å­—æ®µ**ï¼š`step.enableStrategySelector`ã€`step.strategySelector`
- **parameters åµŒå¥—**ï¼š`step.parameters._enableStrategySelector`ã€`step.parameters._strategySelector`
- **æ¢å¤ä¼˜å…ˆçº§**ï¼šé¡¶çº§å­—æ®µä¼˜å…ˆï¼Œparameters ä½œä¸ºå¤‡ä»½

### 2. **è°ƒè¯•æ—¥å¿—**
åºåˆ—åŒ–æ—¶ï¼š
```
ğŸ¯ [åºåˆ—åŒ–] ä¿å­˜ enableStrategySelector åˆ° parameters: true
ğŸ¯ [åºåˆ—åŒ–] ä¿å­˜ strategySelector åˆ° parameters: { selectedStrategy: "...", ... }
```

ååºåˆ—åŒ–æ—¶ï¼š
```
ğŸ¯ [ååºåˆ—åŒ–] æ¢å¤ enableStrategySelector: true
ğŸ¯ [ååºåˆ—åŒ–] æ¢å¤ strategySelector: { selectedStrategy: "...", ... }
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. **é‡æ–°æµ‹è¯•å®Œæ•´æµç¨‹**

```bash
# 1. ç¡®ä¿ä»£ç å·²ç¼–è¯‘ï¼ˆTauri dev åº”è¯¥è‡ªåŠ¨çƒ­é‡è½½ï¼‰
# å¦‚æœæ²¡æœ‰è‡ªåŠ¨é‡è½½ï¼Œé‡å¯å¼€å‘æœåŠ¡å™¨

# 2. åœ¨ç•Œé¢ä¸­æ“ä½œ
- åˆ›å»ºæ–°æ­¥éª¤
- ç‚¹å‡»å†³ç­–é“¾æŒ‰é’®ï¼ˆğŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾ã€ğŸ¯ ç¬¬ä¸€ä¸ªã€ğŸ‘† ç‚¹å‡»ï¼‰
- ä¿å­˜è„šæœ¬
- é‡æ–°æ‰“å¼€è„šæœ¬
- âœ… éªŒè¯ï¼šå†³ç­–é“¾æŒ‰é’®åº”è¯¥ä¿ç•™
```

### 2. **éªŒè¯ä¿å­˜çš„ JSON**

ä¿å­˜åæ£€æŸ¥ JSON æ–‡ä»¶ï¼ˆ`src-tauri/data/scripts/` ç›®å½•ï¼‰ï¼š

**åº”è¯¥åŒ…å«ä»¥ä¸‹å­—æ®µä¹‹ä¸€**ï¼š
```json
{
  "steps": [
    {
      "id": "step_xxx",
      "enableStrategySelector": true,  // âœ… é¡¶çº§å­—æ®µ
      "strategySelector": {            // âœ… é¡¶çº§å­—æ®µ
        "selectedStrategy": "smart-auto",
        // ...
      },
      "parameters": {
        "_enableStrategySelector": true,  // âœ… å‚æ•°å¤‡ä»½
        "_strategySelector": { ... }       // âœ… å‚æ•°å¤‡ä»½
      }
    }
  ]
}
```

### 3. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**

**ä¿å­˜æ—¶åº”çœ‹åˆ°**ï¼š
```
ğŸ¯ [åºåˆ—åŒ–] ä¿å­˜ enableStrategySelector åˆ° parameters: true
ğŸ¯ [åºåˆ—åŒ–] ä¿å­˜ strategySelector åˆ° parameters: Object
```

**åŠ è½½æ—¶åº”çœ‹åˆ°**ï¼š
```
ğŸ¯ [ååºåˆ—åŒ–] æ¢å¤ enableStrategySelector: true
ğŸ¯ [ååºåˆ—åŒ–] æ¢å¤ strategySelector: Object
```

---

## ğŸ“Š ä¿®å¤å¯¹æ¯”

| é¡¹ç›® | ä¹‹å‰çŠ¶æ€ | ä¿®å¤å |
|------|---------|--------|
| **ä¿®æ”¹æ–‡ä»¶** | âŒ universal-script-serializer.ts (æœªè¢«è°ƒç”¨) | âœ… serializer.ts (å®é™…ä½¿ç”¨) |
| **åºåˆ—åŒ–** | âŒ å­—æ®µæœªä¿å­˜ | âœ… åŒé‡ä¿é™©ä¿å­˜ |
| **ååºåˆ—åŒ–** | âŒ å­—æ®µæœªæ¢å¤ | âœ… ä¼˜å…ˆçº§æ¢å¤ |
| **è°ƒè¯•æ—¥å¿—** | âŒ æ— æ—¥å¿— | âœ… å®Œæ•´æ—¥å¿— |
| **JSON æ–‡ä»¶** | âŒ ç¼ºå°‘å­—æ®µ | âœ… åŒ…å«æ‰€æœ‰å­—æ®µ |

---

## ğŸ” æ ¹å› åˆ†æ

### ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ

1. **é¡¹ç›®å­˜åœ¨å¤šä¸ªåºåˆ—åŒ–å™¨**ï¼š
   - `universal-script-serializer.ts`ï¼ˆè¾ƒæ–°ï¼Œä½†æœªè¢«ä½¿ç”¨ï¼‰
   - `serializer.ts`ï¼ˆæ—§ç‰ˆï¼Œå®é™…è¢«è°ƒç”¨ï¼‰
   - `universal-serializer.ts`ï¼ˆå¦ä¸€ä¸ªç‰ˆæœ¬ï¼‰
   - `modernized-script-serializer.ts`ï¼ˆåŒ…è£…å™¨ï¼‰

2. **è°ƒç”¨é“¾é”™è¯¯å‡è®¾**ï¼š
   - è®¤ä¸ºä½¿ç”¨äº† `universal-script-serializer.ts`
   - å®é™…ä½¿ç”¨çš„æ˜¯ `serializer.ts`

3. **ä¿®æ”¹äº†é”™è¯¯çš„æ–‡ä»¶**ï¼š
   - ä¿®æ”¹äº† `universal-script-serializer.ts`
   - ä½† `useScriptPersistence.ts` ç›´æ¥å¼•ç”¨ `serializer.ts`

---

## âœ¨ æ€»ç»“

**ä¿®å¤çŠ¶æ€**ï¼šâœ… **å·²å®Œæˆ**

**å…³é”®æ”¹åŠ¨**ï¼š
1. âœ… åœ¨ **æ­£ç¡®çš„åºåˆ—åŒ–å™¨** (`serializer.ts`) ä¸­æ·»åŠ å­—æ®µä¿å­˜é€»è¾‘
2. âœ… å®ç°åŒé‡ä¿é™©æœºåˆ¶ï¼ˆé¡¶çº§ + parametersï¼‰
3. âœ… æ·»åŠ å®Œæ•´çš„è°ƒè¯•æ—¥å¿—
4. âœ… å®ç°ä¼˜å…ˆçº§æ¢å¤ç­–ç•¥

**é¢„æœŸæ•ˆæœ**ï¼š
- ä¿å­˜è„šæœ¬åé‡æ–°æ‰“å¼€ï¼Œå†³ç­–é“¾æŒ‰é’®å®Œæ•´ä¿ç•™
- JSON æ–‡ä»¶åŒ…å«æ‰€æœ‰å¿…è¦çš„å†³ç­–é“¾é…ç½®
- æ§åˆ¶å°æ˜¾ç¤ºåºåˆ—åŒ–/ååºåˆ—åŒ–æ—¥å¿—

---

## ğŸ“ åç»­å»ºè®®

1. **ç»Ÿä¸€åºåˆ—åŒ–å™¨**ï¼šé¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ªåºåˆ—åŒ–å™¨ï¼Œå»ºè®®ç»Ÿä¸€ä¸ºä¸€ä¸ª
2. **ç±»å‹å®šä¹‰**ï¼šä¸º `enableStrategySelector` å’Œ `strategySelector` æ·»åŠ æ­£å¼çš„ç±»å‹å®šä¹‰
3. **æµ‹è¯•è¦†ç›–**ï¼šæ·»åŠ å•å…ƒæµ‹è¯•ç¡®ä¿åºåˆ—åŒ–/ååºåˆ—åŒ–æ­£ç¡®æ€§

---

**æµ‹è¯•æ—¶é—´**ï¼šè¯·ç«‹å³æµ‹è¯•ï¼Œç¡®è®¤ä¿®å¤ç”Ÿæ•ˆï¼
