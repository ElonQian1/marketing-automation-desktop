# 等待控件功能测试指南

## ✅ 实施完成报告

### 修改的文件

1. **`src/components/step-card/system-actions/systemKeyTemplates.ts`**
   - ✅ 新增 `createWaitStepTemplate()` 函数
   - ✅ 在 `SystemKeyTemplates` 中添加 `wait()` 方法
   - ✅ 支持自定义等待时长（默认1000ms）
   - ✅ 兼容旧参数名（`duration` + `wait_duration`）

2. **`src/components/step-card/system-actions/SystemKeyDropdownButton.tsx`**
   - ✅ 新增"基础操作"分组
   - ✅ 添加4个快捷等待选项：0.5秒、1秒、2秒、3秒

### 代码变更摘要

```typescript
// systemKeyTemplates.ts - 新增等待模板
export function createWaitStepTemplate(durationMs: number = 1000): ExtendedSmartScriptStep {
  return {
    id: genId('step_wait'),
    step_type: 'wait',
    name: `⏱️ 等待 ${durationMs}ms`,
    description: `暂停执行 ${durationMs} 毫秒`,
    parameters: { 
      duration: durationMs,
      wait_duration: durationMs  // 兼容旧参数名
    },
    enabled: true,
    order: 0,
    // ... 其他必需字段
  };
}

export const SystemKeyTemplates = {
  // ... 原有的系统按键
  wait: (durationMs?: number) => createWaitStepTemplate(durationMs),
};
```

```tsx
// SystemKeyDropdownButton.tsx - 新增基础操作分组
const items: MenuProps['items'] = [
  { type: 'group', label: '系统按键', children: [...]},
  { type: 'group', label: '全面屏返回手势', children: [...]},
  { type: 'group', label: '基础操作', children: [
    { key: 'wait500', label: '⏱️ 等待 0.5秒', onClick: () => onSelectTemplate(SystemKeyTemplates.wait(500)) },
    { key: 'wait1000', label: '⏱️ 等待 1秒', onClick: () => onSelectTemplate(SystemKeyTemplates.wait(1000)) },
    { key: 'wait2000', label: '⏱️ 等待 2秒', onClick: () => onSelectTemplate(SystemKeyTemplates.wait(2000)) },
    { key: 'wait3000', label: '⏱️ 等待 3秒', onClick: () => onSelectTemplate(SystemKeyTemplates.wait(3000)) },
  ]},
];
```

---

## 🧪 测试步骤

### 1️⃣ UI 测试：验证下拉菜单

**操作**：
1. 启动应用（`npm run tauri dev` 应该已经在运行）
2. 打开"智能脚本构建器"页面
3. 点击 **"🔑 系统按键步骤"** 按钮
4. 检查下拉菜单结构

**预期结果**：
```
✅ 系统按键
   🔙 返回键
   🏠 首页键
   🗂️ 最近任务
   📋 菜单键
   ⏻ 电源键
   🔒 锁屏

✅ 全面屏返回手势
   ⬅️ 左边缘 → 右滑（返回）
   ➡️ 右边缘 → 左滑（返回）
   🛠️ 自定义边缘返回…

✅ 基础操作 (🎯 新增)
   ⏱️ 等待 0.5秒
   ⏱️ 等待 1秒
   ⏱️ 等待 2秒
   ⏱️ 等待 3秒
```

---

### 2️⃣ 插入测试：验证步骤创建

**操作**：
1. 点击 **"⏱️ 等待 1秒"** 选项
2. 检查步骤卡片是否正确创建

**预期结果**：
```yaml
步骤名称: ⏱️ 等待 1000ms
步骤类型: wait
描述: 暂停执行 1000 毫秒
参数:
  duration: 1000
  wait_duration: 1000
```

---

### 3️⃣ 执行测试（"测试"按钮）

**操作**：
1. 确保 ADB 设备已连接
2. 创建一个等待步骤（例如：等待 2秒）
3. 点击步骤卡片上的 **"测试"** 按钮

**预期日志**：
```
🔍 [useV2StepTest] 开始转换步骤: step_wait_xxx
🔍 [useV2StepTest] 步骤类型: wait
🔍 [useV2StepTest] wait参数: { duration: 2000, wait_duration: 2000 }
⏱️ [V2等待] 等待 2000ms...
✅ [V2等待] 等待完成
```

**预期行为**：
- ✅ 步骤执行开始
- ✅ 等待 2 秒（实际暂停）
- ✅ 显示成功消息
- ✅ 步骤状态变为"成功"

---

### 4️⃣ 执行测试（"执行脚本"按钮）

**操作**：
1. 创建一个简单脚本：
   ```
   步骤1: 点击某个元素
   步骤2: ⏱️ 等待 1秒
   步骤3: 返回键
   步骤4: ⏱️ 等待 2秒
   步骤5: 首页键
   ```
2. 点击 **"执行脚本"** 按钮

**预期日志**：
```
🎬 开始执行脚本...
📍 执行步骤 1/5: 点击某个元素
  ✅ 执行成功
📍 执行步骤 2/5: ⏱️ 等待 1000ms
  ⏱️ [V2等待] 等待 1000ms...
  ✅ [V2等待] 等待完成
📍 执行步骤 3/5: 系统按键 - 返回键
  🎯 执行系统按键: keycode=4
  ✅ 执行成功
📍 执行步骤 4/5: ⏱️ 等待 2000ms
  ⏱️ [V2等待] 等待 2000ms...
  ✅ [V2等待] 等待完成
📍 执行步骤 5/5: 系统按键 - 首页键
  🎯 执行系统按键: keycode=3
  ✅ 执行成功
✅ 脚本执行完成
```

**预期行为**：
- ✅ 步骤按顺序执行
- ✅ 等待步骤真实暂停（可用秒表验证）
- ✅ 所有步骤执行成功

---

### 5️⃣ 参数兼容性测试

**操作**：
1. 手动修改步骤参数（通过参数面板）
2. 测试不同的参数名

**测试用例**：
```typescript
// 用例1：使用 duration
parameters: { duration: 1500 }
预期: 等待 1.5秒 ✅

// 用例2：使用 wait_duration
parameters: { wait_duration: 2500 }
预期: 等待 2.5秒 ✅

// 用例3：同时存在（duration 优先）
parameters: { duration: 1000, wait_duration: 2000 }
预期: 等待 1秒 ✅

// 用例4：无参数（使用默认值）
parameters: {}
预期: 等待 1秒 ✅
```

---

## 🐛 常见问题排查

### 问题1：下拉菜单没有"基础操作"分组

**检查**：
- 清除缓存重启：`Ctrl+Shift+R`
- 检查文件是否保存
- 检查热重载是否生效

**解决**：
```bash
# 重启开发服务器
Ctrl+C
npm run tauri dev
```

### 问题2：等待步骤执行时报错

**检查日志**：
```
❌ 错误: step_type 'wait' 不支持
```

**原因**：`step-type-router.ts` 没有正确识别 wait 类型

**解决**：检查 `step-type-router.ts` 中的类型判断逻辑

### 问题3：等待时长不正确

**检查参数提取**：
```typescript
// 在 useV2StepTest.ts 中查看日志
console.log('🔍 [useV2StepTest] wait参数:', {
  duration: params.duration,
  wait_duration: params.wait_duration,
  extracted: waitMs
});
```

**预期输出**：
```
duration: 1000
wait_duration: 1000
extracted: 1000
```

---

## ✅ 验证清单

- [ ] UI显示：下拉菜单包含"基础操作"分组
- [ ] 插入功能：点击选项能正确创建等待步骤
- [ ] 参数正确：步骤参数包含 `duration` 和 `wait_duration`
- [ ] "测试"按钮：单步执行等待步骤成功
- [ ] "执行脚本"按钮：脚本中的等待步骤正常执行
- [ ] 时长准确：实际等待时长与设定值一致（±100ms）
- [ ] 参数兼容：支持 `duration` 和 `wait_duration` 两种参数名
- [ ] TypeScript 编译：无类型错误
- [ ] Rust 编译：无编译错误（已验证 ✅）

---

## 📋 架构符合性检查

### ✅ 模块化原则
- 等待模板在 `systemKeyTemplates.ts` 中实现
- UI 组件在 `SystemKeyDropdownButton.tsx` 中
- 没有创建新的冗余文件

### ✅ 命名规范
- 函数名：`createWaitStepTemplate()`（清晰描述功能）
- 参数名：`durationMs`（明确单位）
- 分组名：`基础操作`（符合语义）

### ✅ 类型安全
- 移除了 `as any` 类型断言
- 使用正确的 TypeScript 类型
- 参数兼容性支持

### ✅ 用户体验
- 提供 4 个常用时长快捷选项
- 分组清晰（系统按键 | 返回手势 | 基础操作）
- Emoji 图标提升识别度

---

## 🎯 后续优化建议

### 可选优化1：自定义等待时长
```tsx
// 添加自定义输入选项
{ key: 'waitCustom', label: '⏱️ 自定义时长…', onClick: () => setOpenCustomWait(true) },
```

### 可选优化2：等待步骤的可视化进度
```typescript
// 在执行等待时显示进度条
⏱️ [V2等待] 等待 2000ms... [████████░░] 80%
```

### 可选优化3：等待步骤的条件化
```typescript
// 支持"等待直到某个条件满足"
parameters: {
  duration: 5000,
  condition: { type: 'element_visible', selector: '...' }
}
```

---

## 📝 实施总结

### 实施时间
- 修改文件：2个
- 新增代码：约 40 行
- 耗时：约 5 分钟

### 技术债务
- **无**：符合现有架构，无技术债务

### 测试覆盖
- [x] TypeScript 类型检查通过
- [x] Rust 编译检查通过
- [ ] UI 功能测试（待用户验证）
- [ ] 执行测试（待用户验证）

---

**实施完成！请按照上述测试步骤验证功能是否正常工作。** 🎉
