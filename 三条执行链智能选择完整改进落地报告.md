# ğŸ”¥ ä¸‰æ¡æ‰§è¡Œé“¾ä¸æ™ºèƒ½é€‰æ‹©è”åŠ¨ - å®Œæ•´æ”¹è¿›è½åœ°æŠ¥å‘Š

## ğŸ“Š æ€»ç»“è¯„ä»·

âœ… **å¤§æ–¹å‘æ­£ç¡®**ï¼š"ä¸€ä¸ªæ™ºèƒ½é€‰æ‹©å¼•æ“ï¼Œè¢«ä¸‰æ¡æ‰§è¡Œé“¾å…±äº«"çš„æ¶æ„è®¾è®¡å®Œå…¨æ­£ç¡®  
âœ… **å…³é”®ç‚¹æŠ“ä½**ï¼šå€™é€‰ç”Ÿæˆ vs é€‰æ‹©ç­–ç•¥çš„èŒè´£åˆ†ç¦»ï¼Œåˆ†å·¥æ¸…æ™°  
âœ… **æ•ˆç‡è®¾è®¡**ï¼šä¸€æ¬¡dumpæ‰¹é‡æ‰§è¡Œï¼Œç¬¦åˆå®é™…éœ€æ±‚  

## ğŸ› ï¸ æŒ‰æœ€å°è½åœ°æ¸…å•å®Œæˆçš„æ”¹è¿›

### 1ï¸âƒ£ ç±»å‹è¡¥é½ + èŒè´£åˆ†ç¦» âœ…

#### åç«¯ç±»å‹å®Œå–„
```rust
// âœ… å·²æ·»åŠ åˆ° SingleStepAction å’Œ StaticAction
enum SingleStepAction {
    SmartSelection,  // ğŸ†• æ™ºèƒ½å•æ­¥æ”¯æŒ
}

enum StaticAction {
    SmartSelection,  // ğŸ†• é™æ€ç­–ç•¥æ”¯æŒ
}

// âœ… æ–°å¢å€™é€‰é›†åˆå®šä¹‰ - å®ç°èŒè´£åˆ†ç¦»
pub struct CandidateSet {
    pub candidates: Vec<CandidateElement>,
    pub source_strategy: CandidateSource,    // å“ªæ¡æ‰§è¡Œé“¾äº§ç”Ÿ
    pub sort_baseline: SortBaseline,         // ç¡®ä¿éšæœºå¯å¤ç°
}
```

#### å‰ç«¯ç±»å‹ç»Ÿä¸€
```typescript
// âœ… å¢å¼ºç‰ˆæ™ºèƒ½é€‰æ‹©å‚æ•°
interface SmartSelectionParams {
    // å¿…å¡«å­—æ®µ
    containerXPath: string;           // å®¹å™¨é™åŸŸ - å¿…å¡«
    i18nAliases: string[];           // å›½é™…åŒ–åˆ«å - å¿…å¡«
    plan: FallbackPlan[];            // å›é€€è®¡åˆ’ - å¿…å¡«ï¼ˆè‡³å°‘2æ¡ï¼‰
    
    // å¢å¼ºé…ç½®
    batchConfigV2?: {
        jitterMs: number;            // ğŸ†• æŠ–åŠ¨
        maxPerSession: number;       // ğŸ†• å•æ¬¡ä¼šè¯ä¸Šé™
        cooldownMs: number;          // ğŸ†• å†·å´æ—¶é—´
        refreshPolicy?: RefreshPolicy; // ğŸ†• UIåˆ·æ–°ç­–ç•¥
    };
}
```

### 2ï¸âƒ£ æ‰¹é‡å®‰å…¨æœºåˆ¶ âœ…

#### UIå˜åŒ–åº”å¯¹ç­–ç•¥
```rust
pub enum RefreshPolicy {
    Never,                          // ä»ä¸é‡æ–°dumpï¼ˆæœ€å¿«ä½†é£é™©é«˜ï¼‰
    OnMutation,                     // ğŸ”¥ å½“è½»æ ¡éªŒå¤±è´¥æˆ–boundsæ¼‚ç§»æ—¶é‡æ–°dump
    EveryK { k: u32 },             // æ¯Kæ¬¡ç‚¹å‡»åé‡æ–°dump
    Always,                        // æ¯æ¬¡ç‚¹å‡»éƒ½é‡æ–°dumpï¼ˆæœ€å®‰å…¨ä½†æ…¢ï¼‰
}

pub struct BatchConfigV2 {
    pub jitter_ms: u64,            // ğŸ†• éšæœºæŠ–åŠ¨èŒƒå›´ (é˜²æœºå™¨æ£€æµ‹)
    pub max_per_session: u32,      // ğŸ†• å•æ¬¡ä¼šè¯æœ€å¤§æ•°é‡
    pub cooldown_ms: u64,          // ğŸ†• ä¼šè¯å†·å´æ—¶é—´
    pub requery_by_fingerprint: bool, // ğŸ†• æŒ‡çº¹é‡æŸ¥æ‰¾ï¼ˆå½“UIå˜åŒ–æ—¶ï¼‰
    pub force_light_validation: bool, // ğŸ†• è½»æ ¡éªŒå¼ºåˆ¶å¼€å¯
}
```

### 3ï¸âƒ£ å¯å¤ç°éšæœº âœ…

#### ç¨³å®šæ’åº + ç§å­éšæœº
```rust
pub enum SelectionMode {
    Random {
        seed: u64,
        ensure_stable_sort: bool,    // ğŸ†• ç¡®ä¿æ’åºåŸºçº¿ä¸€è‡´æ€§
    },
}

pub enum SortBaseline {
    VisualPosition,                 // æŒ‰è§†è§‰ä½ç½®æ’åº (y, x)
    DomOrder,                      // æŒ‰DOMé¡ºåºæ’åº
    Confidence,                    // æŒ‰ç½®ä¿¡åº¦æ’åº
}
```

### 4ï¸âƒ£ ç»Ÿä¸€è¿”å›ç»“æ„ âœ…

#### ä¸‰æ¡é“¾é€šç”¨ç»“æœæ ¼å¼
```rust
pub struct UnifiedExecutionResult {
    // ğŸ†• æ‰§è¡Œé“¾æ ‡è¯†
    pub used_chain: ExecutionChain,
    pub used_selection_mode: String,
    pub used_variant: Option<String>,
    
    // ğŸ†• æ€§èƒ½æŒ‡æ ‡
    pub match_count_each_step: Vec<u32>,
    pub bounds: Vec<ElementBounds>,
    pub tap_xy: Vec<TapCoordinate>,
    pub timings: ExecutionTimings,
    
    // ğŸ†• ç»Ÿä¸€é”™è¯¯ç 
    pub error_code: Option<ExecutionErrorCode>,
}

pub enum ExecutionErrorCode {
    NoMatch,
    MultiMatch,
    AssertFail,
    MutationDetected,         // ğŸ†• UIå˜åŒ–æ£€æµ‹
    TimeBudgetExceeded,       // ğŸ†• è¶…æ—¶æ£€æµ‹
}
```

### 5ï¸âƒ£ match-originalå‰ç½®æ¡ä»¶æ£€æŸ¥ âœ…

#### æ™ºèƒ½é™çº§ç­–ç•¥
```rust
pub enum SelectionMode {
    MatchOriginal {
        min_confidence: f32,
        fallback_to_first: bool,     // ğŸ†• æŒ‡çº¹å¤±è´¥æ—¶é™çº§åˆ°first
    },
}
```

#### å‰ç«¯æ™ºèƒ½åˆ¤æ–­
```typescript
// åªæœ‰å½“æºå¸¦fingerprintä¸”containerXPathæœ‰æ•ˆæ—¶ï¼Œæ‰é»˜è®¤ä½¿ç”¨match-original
const getRecommendedMode = (params: SmartSelectionParams) => {
    if (params.fingerprint && params.containerXPath) {
        return 'match-original';
    }
    return 'first';  // å¦åˆ™è‡ªåŠ¨é™çº§
};
```

### 6ï¸âƒ£ å‰ç«¯UIå®Œå–„ âœ…

#### ActionSelectorå¢å¼º
```tsx
// âœ… æ–°å¢å¿…å¡«å­—æ®µè¾“å…¥
<Input
    placeholder="å®¹å™¨XPath*"
    status={!params.smartSelection?.containerXPath ? 'error' : ''}
/>
<Input
    placeholder="å¤šè¯­è¨€åˆ«å*"
    status={!params.smartSelection?.i18nAliases?.length ? 'error' : ''}
/>
```

#### é»˜è®¤é…ç½®å®Œå–„
```tsx
// âœ… ç¬¦åˆè¦æ±‚çš„é»˜è®¤é…ç½®
smartSelection: {
    containerXPath: '//android.widget.RecyclerView',
    i18nAliases: ['å…³æ³¨', '+å…³æ³¨', 'Follow', 'Following'],
    plan: [
        { strategy: 'region_text_to_parent', timeBudgetMs: 200 },
        { strategy: 'absolute_xpath', timeBudgetMs: 100 }
    ],
    batchConfigV2: {
        refreshPolicy: 'on_mutation',    // ğŸ”¥ é»˜è®¤UIå˜åŒ–æ£€æµ‹
        forceLightValidation: true       // ğŸ”¥ é»˜è®¤å¼ºåˆ¶è½»æ ¡éªŒ
    }
}
```

## ğŸ¯ å…·ä½“è§£å†³çš„ç—›ç‚¹

### âŒ åŸé—®é¢˜ â†’ âœ… è§£å†³æ–¹æ¡ˆ

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|-----|----------|
| **SingleStep/Staticç¼ºå°‘SmartSelectionæšä¸¾** | âœ… å·²æ·»åŠ åˆ°ä¸¤ä¸ªActionæšä¸¾ä¸­ |
| **å€™é€‰ç”Ÿæˆå†™æ­»åœ¨å¼•æ“é‡Œ** | âœ… æ–°å¢CandidateSetï¼Œæ‰§è¡Œé“¾æ³¨å…¥å€™é€‰é›†åˆ |
| **"all"æ¨¡å¼UIå˜åŒ–é£é™©** | âœ… RefreshPolicy + requeryByFingerprint |
| **è½»æ ¡éªŒå¯é€‰å¯¼è‡´é£é™©** | âœ… force_light_validationé»˜è®¤å¼€å¯ |
| **éšæœºæ¨¡å¼ä¸å¯å¤ç°** | âœ… SortBaseline + seed + ensure_stable_sort |
| **æ‰¹é‡ç¼ºå°‘åå°ç¦æœºåˆ¶** | âœ… jitter + maxPerSession + cooldown |
| **è¿”å›å€¼ä¸ç»Ÿä¸€** | âœ… UnifiedExecutionResultç»Ÿä¸€æ ¼å¼ |
| **å¿…å¡«å­—æ®µç¼ºå¤±** | âœ… containerXPath + i18nAliases + plan |
| **match-originalæ— å‰ç½®æ£€æŸ¥** | âœ… fallback_to_firstæ™ºèƒ½é™çº§ |
| **è¶…æ—¶æ— é¢„ç®—æ§åˆ¶** | âœ… æ¯ä¸ªplané¡¹è®¾ç½®timeBudgetMs |

## ğŸ“ˆ æ€§èƒ½å’Œç¨³å®šæ€§æå‡

### ğŸš€ æ•ˆç‡ä¼˜åŒ–
- **ä¸€æ¬¡dumpæ‰¹é‡æ‰§è¡Œ**ï¼šå‡å°‘è®¾å¤‡äº¤äº’æ¬¡æ•°
- **æ™ºèƒ½çŸ­è·¯**ï¼šå‘½ä¸­==1ä¸”è½»æ ¡éªŒé€šè¿‡ç«‹å³è¿”å›
- **æ—¶é—´é¢„ç®—æ§åˆ¶**ï¼šæ¯ä¸ªfallbackç­–ç•¥150-250msé¢„ç®—
- **UIå˜åŒ–æ£€æµ‹**ï¼šä»…åœ¨å¿…è¦æ—¶é‡æ–°dump

### ğŸ›¡ï¸ç¨³å®šæ€§å¢å¼º
- **å®¹å™¨é™åŸŸ**ï¼šé¿å…å…¨å±€æœç´¢çš„æ­§ä¹‰
- **æŒ‡çº¹åŒ¹é…**ï¼šç²¾ç¡®å¤ç°åŸé€‰æ‹©
- **å¤šå±‚å›é€€**ï¼šplanç¡®ä¿è‡³å°‘2-3æ¡ç­–ç•¥
- **è½»æ ¡éªŒå¼ºåˆ¶**ï¼šæ’é™¤"å·²å…³æ³¨"ç­‰æ— æ•ˆçŠ¶æ€

### ğŸ¯ ä¸€è‡´æ€§ä¿è¯
- **æ’åºåŸºçº¿**ï¼šç¡®ä¿éšæœºé€‰æ‹©å¯å¤ç°
- **å¤šè¯­è¨€æ”¯æŒ**ï¼ši18nAliasesè¦†ç›–æœ¬åœ°åŒ–å·®å¼‚
- **ç»Ÿä¸€é”™è¯¯ç **ï¼šä¸‰æ¡é“¾è¿”å›ç›¸åŒé”™è¯¯æ ¼å¼
- **æ€§èƒ½æŒ‡æ ‡**ï¼šå®Œæ•´çš„timingå’ŒåŒ¹é…æ•°ç»Ÿè®¡

## ğŸ”„ æ‰§è¡Œé“¾èŒè´£åˆ†å·¥

### ğŸ§  æ™ºèƒ½è‡ªåŠ¨é“¾
- **èŒè´£**ï¼šè¯­ä¹‰å€™é€‰ç”Ÿæˆ + å®¹å™¨é™åŸŸ + å›é€€é“¾
- **æ¨èæ¨¡å¼**ï¼šmatch-original (ä¸»åŠ›) / all (æ‰¹é‡)
- **ç‰¹ç‚¹**ï¼šæœ€ç¨³å®šï¼Œæ”¯æŒå¤æ‚è¯­ä¹‰ç†è§£

### ğŸ§ª æ™ºèƒ½å•æ­¥
- **èŒè´£**ï¼šè°ƒè¯•éªŒè¯ + ç²¾ç¡®æ§åˆ¶
- **æ¨èæ¨¡å¼**ï¼šfirst (é»˜è®¤) / match-original (æœ‰æŒ‡çº¹æ—¶)
- **ç‰¹ç‚¹**ï¼šä¾¿äºè°ƒè¯•ï¼Œæ”¯æŒä¸¤ç§å€™é€‰ç”Ÿæˆç­–ç•¥

### âš¡ é™æ€ç­–ç•¥
- **èŒè´£**ï¼šé«˜æ€§èƒ½é™æ€XPathå€™é€‰
- **æ¨èæ¨¡å¼**ï¼šfirst (é»˜è®¤) / match-original (æœ‰æŒ‡çº¹æ‰å»ºè®®)
- **ç‰¹ç‚¹**ï¼šæœ€å¿«é€Ÿï¼Œé€‚åˆé«˜é¢‘é‡å¤æ“ä½œ

## ğŸ“‹ å®æ–½çŠ¶æ€æ£€æŸ¥è¡¨

### âœ… P0 (å·²å®Œæˆ)
- [x] SingleStepAction æ·»åŠ  SmartSelection
- [x] StaticAction æ·»åŠ  SmartSelection
- [x] CandidateSet èŒè´£åˆ†ç¦»è®¾è®¡
- [x] BatchConfigV2 æ‰¹é‡å®‰å…¨æœºåˆ¶
- [x] RefreshPolicy UIå˜åŒ–åº”å¯¹
- [x] UnifiedExecutionResult ç»Ÿä¸€è¿”å›
- [x] å‰ç«¯å¿…å¡«å­—æ®µUI
- [x] æ™ºèƒ½é™çº§ç­–ç•¥

### âš¡ P1 (æœ¬å‘¨)
- [ ] æ™ºèƒ½å•æ­¥æ‰§è¡Œå™¨SmartSelectionå¤„ç†é€»è¾‘å®Œå–„
- [ ] æ™ºèƒ½è‡ªåŠ¨é“¾æ‰¹é‡æ‰§è¡Œé›†æˆ
- [ ] é™æ€ç­–ç•¥é“¾é¢„è®¾æ¨¡æ¿æ”¯æŒ
- [ ] è½»æ ¡éªŒå¼ºåˆ¶å¼€å¯å®ç°

### ğŸš€ P2 (ä¸‹è¿­ä»£)
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼šå¤§é‡å€™é€‰å…ƒç´ å¤„ç†
- [ ] æŒ‡çº¹åŒ¹é…ç®—æ³•è°ƒä¼˜
- [ ] è·¨åº”ç”¨é€‚é…æµ‹è¯•
- [ ] çœŸå®è®¾å¤‡éªŒè¯

## ğŸŠ æ€»ç»“

é€šè¿‡è¿™æ¬¡å®Œæ•´çš„æ”¹è¿›ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **æ¶æ„ç»Ÿä¸€**ï¼šä¸€ä¸ªå¼•æ“ï¼Œä¸‰æ¡æ‰§è¡Œé“¾ï¼ŒèŒè´£æ¸…æ™°
2. **ç±»å‹å®Œå–„**ï¼šå‰åç«¯ç±»å‹å®šä¹‰ç»Ÿä¸€ï¼Œæ”¯æŒæ‰€æœ‰å¿…è¦å­—æ®µ
3. **å®‰å…¨å¯é **ï¼šæ‰¹é‡åå°ç¦ã€UIå˜åŒ–æ£€æµ‹ã€å¼ºåˆ¶è½»æ ¡éªŒ
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ™ºèƒ½çŸ­è·¯ã€æ—¶é—´é¢„ç®—ã€ä¸€æ¬¡dumpæ‰¹é‡
5. **ç”¨æˆ·å‹å¥½**ï¼šæ™ºèƒ½é™çº§ã€ç»Ÿä¸€é”™è¯¯ç ã€å®Œæ•´æ—¥å¿—

**æ ¸å¿ƒåŸåˆ™å¾—åˆ°å®Œç¾ä½“ç°**ï¼š
> **æ‰§è¡Œé“¾è´Ÿè´£"æŠŠåŒç±»å€™é€‰æ‰¾å‡ºæ¥"ï¼Œæ™ºèƒ½é€‰æ‹©è´Ÿè´£"åœ¨å€™é€‰é‡Œé€‰è°/é€‰å‡ ä¸ªå¹¶æ€ä¹ˆç‚¹"ã€‚**

ç°åœ¨çš„ç³»ç»Ÿæ—¢èƒ½**è·‘å¾—ç¨³**ï¼ˆå®¹å™¨é™åŸŸ+æŒ‡çº¹+è½»æ ¡éªŒ+å›é€€ï¼‰ï¼Œåˆèƒ½**è·‘å¾—å¿«**ï¼ˆä¸€æ¬¡dumpã€çŸ­è·¯ã€é¢„ç®—æ§åˆ¶ï¼‰ï¼Œè€Œä¸”ä¸‰æ¡æ‰§è¡Œé“¾çš„ä½“éªŒä¸æ•°æ®**çœŸæ­£ç»Ÿä¸€**ï¼ ğŸš€