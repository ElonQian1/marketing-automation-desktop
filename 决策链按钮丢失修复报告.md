# ğŸ”§ å†³ç­–é“¾æŒ‰é’®ä¸¢å¤±é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼šä¿å­˜è„šæœ¬åé‡æ–°æ‰“å¼€ï¼Œæ­¥éª¤å¡ç‰‡ä¸Šçš„å†³ç­–é“¾é…ç½®æŒ‰é’®ï¼ˆ"ğŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾"ã€"ğŸ¯ ç¬¬ä¸€ä¸ª"ã€"ğŸ‘† ç‚¹å‡»"ï¼‰å…¨éƒ¨æ¶ˆå¤±äº†ã€‚

### é—®é¢˜ç°è±¡å¯¹æ¯”

**ä¿å­˜å‰**ï¼š
- âœ… æ˜¾ç¤º `ğŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾ âœ…`
- âœ… æ˜¾ç¤º `ğŸ¯ ç¬¬ä¸€ä¸ª âœ…` 
- âœ… æ˜¾ç¤º `ğŸ‘† ç‚¹å‡» âœ…`
- âœ… æœ‰åˆ·æ–°ã€æ—¥å¿—ã€æœç´¢ç­‰è¾…åŠ©æŒ‰é’®

**é‡æ–°æ‰“å¼€å**ï¼š
- âŒ å†³ç­–é“¾é…ç½®æŒ‰é’®å…¨éƒ¨æ¶ˆå¤±
- âŒ è¾…åŠ©æŒ‰é’®ä¹Ÿæ¶ˆå¤±
- âŒ åªå‰©ä¸‹æµ‹è¯•æŒ‰é’®

---

## ğŸ” æ ¹å› åˆ†æ

### 1. æ•°æ®æµç¨‹

```
ç”¨æˆ·é€‰æ‹©é…ç½® 
  â†“
CompactStrategyMenu ç»„ä»¶
  â†“
ä¿å­˜åˆ°åç«¯ API (invoke('save_smart_selection_config'))
  â†“
âœ… åç«¯ä¿å­˜æˆåŠŸ
  â†“
âŒ ä½†æ˜¯æ²¡æœ‰æ›´æ–°æ­¥éª¤çš„ parameters
  â†“
åºåˆ—åŒ–è„šæœ¬æ—¶ä¸¢å¤±é…ç½®
```

### 2. å…³é”®ä»£ç ä½ç½®

**`src/components/strategy-selector/CompactStrategyMenu.tsx`**

```typescript
// âŒ é—®é¢˜ä»£ç ï¼šåªä¿å­˜åˆ°åç«¯ï¼Œæ²¡æœ‰æ›´æ–°æ­¥éª¤å‚æ•°
const handleSelectionModeClick = async ({ key }: { key: string }) => {
  switch (key) {
    case 'first':
      setSelectionMode('first');
      await saveConfigDirectly('first', null);  // åªä¿å­˜åˆ°åç«¯
      break;
    // ... å…¶ä»–æ¨¡å¼
  }
};

const handleOperationTypeClick = ({ key }: { key: string }) => {
  switch (key) {
    case 'tap':
      setOperationType('tap');  // åªæ›´æ–°æœ¬åœ°çŠ¶æ€
      break;
    // ... å…¶ä»–æ“ä½œç±»å‹
  }
};
```

### 3. ç¼ºå¤±çš„ç¯èŠ‚

æ­¥éª¤çš„ `parameters` ä¸­éœ€è¦ä¿å­˜ä»¥ä¸‹é…ç½®ï¼š

```typescript
{
  parameters: {
    // ... å…¶ä»–å‚æ•°
    decisionChain: {
      executionChain: 'intelligent_chain',  // æ‰§è¡Œé“¾ç±»å‹
      selectionMode: 'first',               // é€‰æ‹©æ¨¡å¼
      operationType: 'tap',                 // æ“ä½œç±»å‹
      batchConfig: { ... },                 // æ‰¹é‡é…ç½®ï¼ˆå¦‚æœæ˜¯æ‰¹é‡æ¨¡å¼ï¼‰
      randomConfig: { ... },                // éšæœºé…ç½®ï¼ˆå¦‚æœæ˜¯éšæœºæ¨¡å¼ï¼‰
      matchOriginalConfig: { ... }          // ç²¾ç¡®åŒ¹é…é…ç½®ï¼ˆå¦‚æœæ˜¯ç²¾ç¡®åŒ¹é…ï¼‰
    }
  }
}
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: æ›´æ–° `CompactStrategyMenu` ä¿å­˜é€»è¾‘

åœ¨ `handleSelectionModeClick` å’Œ `handleOperationTypeClick` ä¸­æ·»åŠ å¯¹ `onUpdateStepParameters` çš„è°ƒç”¨ï¼š

```typescript
// src/components/strategy-selector/CompactStrategyMenu.tsx

const handleSelectionModeClick = async ({ key }: { key: string }) => {
  switch (key) {
    case 'first':
      setSelectionMode('first');
      await saveConfigDirectly('first', null);
      
      // âœ… æ–°å¢ï¼šåŒæ—¶æ›´æ–°æ­¥éª¤å‚æ•°
      if (stepId && onUpdateStepParameters) {
        onUpdateStepParameters(stepId, {
          decisionChain: {
            executionChain: 'intelligent_chain',
            selectionMode: 'first',
            operationType,
            batchConfig: null
          }
        });
      }
      break;
    
    case 'all':
      setSelectionMode('all');
      const newBatchConfig = { ... };
      await saveConfigDirectly('all', newBatchConfig);
      
      // âœ… æ–°å¢ï¼šåŒæ—¶æ›´æ–°æ­¥éª¤å‚æ•°
      if (stepId && onUpdateStepParameters) {
        onUpdateStepParameters(stepId, {
          decisionChain: {
            executionChain: 'intelligent_chain',
            selectionMode: 'all',
            operationType,
            batchConfig: newBatchConfig
          }
        });
      }
      break;
    
    // ... å…¶ä»–æ¨¡å¼ç±»ä¼¼å¤„ç†
  }
};

const handleOperationTypeClick = ({ key }: { key: string }) => {
  const newOperationType = key as ActionKind;
  setOperationType(newOperationType);
  
  // âœ… æ–°å¢ï¼šåŒæ—¶æ›´æ–°æ­¥éª¤å‚æ•°
  if (stepId && onUpdateStepParameters) {
    onUpdateStepParameters(stepId, {
      decisionChain: {
        executionChain: 'intelligent_chain',
        selectionMode,
        operationType: newOperationType,
        batchConfig: selectionMode === 'all' ? batchConfig : null
      }
    });
  }
};
```

### ä¿®å¤2: åºåˆ—åŒ–å™¨ç¡®ä¿ä¿å­˜ `decisionChain`

åºåˆ—åŒ–å™¨å·²ç»é€šè¿‡ `BaseStepSerializer` çš„ `preserveOriginalFields: true` é…ç½®ä¿å­˜æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ `decisionChain`ï¼Œæ— éœ€ä¿®æ”¹ã€‚

### ä¿®å¤3: ååºåˆ—åŒ–æ—¶æ¢å¤å†³ç­–é“¾é…ç½®

åœ¨ `DraggableStepCard` ç»„ä»¶ä¸­ï¼Œä» `step.parameters.decisionChain` æ¢å¤é…ç½®å¹¶ä¼ é€’ç»™ `CompactStrategyMenu`ï¼š

```tsx
// src/components/DraggableStepCard.tsx

// ä»æ­¥éª¤å‚æ•°ä¸­è¯»å–å†³ç­–é“¾é…ç½®
const decisionChain = step.parameters?.decisionChain as {
  executionChain?: string;
  selectionMode?: SelectionMode;
  operationType?: ActionKind;
  batchConfig?: any;
} | undefined;

<CompactStrategyMenu
  selector={...}
  events={...}
  stepId={step.id}
  // âœ… ä¼ é€’åˆå§‹é…ç½®
  initialSelectionMode={decisionChain?.selectionMode || 'first'}
  initialOperationType={decisionChain?.operationType || 'tap'}
  initialBatchConfig={decisionChain?.batchConfig}
  onUpdateStepParameters={onUpdateStepParameters}
/>
```

ç„¶ååœ¨ `CompactStrategyMenu` ä¸­ä½¿ç”¨è¿™äº›åˆå§‹å€¼ï¼š

```typescript
// src/components/strategy-selector/CompactStrategyMenu.tsx

interface CompactStrategyMenuProps {
  // ... ç°æœ‰å±æ€§
  initialSelectionMode?: SelectionMode;
  initialOperationType?: ActionKind;
  initialBatchConfig?: BatchConfig;
}

const CompactStrategyMenu: React.FC<CompactStrategyMenuProps> = ({
  // ... ç°æœ‰å±æ€§
  initialSelectionMode = 'first',
  initialOperationType = 'tap',
  initialBatchConfig = DEFAULT_BATCH_CONFIG,
}) => {
  const [selectionMode, setSelectionMode] = useState<SelectionMode>(initialSelectionMode);
  const [operationType, setOperationType] = useState<ActionKind>(initialOperationType);
  const [batchConfig, setBatchConfig] = useState<BatchConfig>(initialBatchConfig);
  
  // ...
};
```

---

## ğŸ¯ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ `CompactStrategyMenu.tsx`

1. æ·»åŠ åˆå§‹é…ç½®å±æ€§
2. åœ¨ `handleSelectionModeClick` ä¸­è°ƒç”¨ `onUpdateStepParameters`
3. åœ¨ `handleOperationTypeClick` ä¸­è°ƒç”¨ `onUpdateStepParameters`
4. åœ¨ `handleExecutionChainClick` (å¦‚æœæœ‰) ä¸­è°ƒç”¨ `onUpdateStepParameters`

### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ `DraggableStepCard.tsx`

1. ä» `step.parameters.decisionChain` è¯»å–é…ç½®
2. å°†é…ç½®ä¼ é€’ç»™ `CompactStrategyMenu`

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯

1. åˆ›å»ºä¸€ä¸ªæ­¥éª¤ï¼Œé€‰æ‹©é…ç½®
2. ä¿å­˜è„šæœ¬
3. é‡æ–°æ‰“å¼€è„šæœ¬
4. éªŒè¯æŒ‰é’®æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

---

## ğŸ“ é™„åŠ å»ºè®®

### 1. ç»Ÿä¸€é…ç½®é”®å

å»ºè®®åœ¨é¡¹ç›®ä¸­ç»Ÿä¸€ä½¿ç”¨ `decisionChain` ä½œä¸ºå†³ç­–é“¾é…ç½®çš„é”®åï¼š

```typescript
// src/types/decision-chain-config.ts
export interface DecisionChainConfig {
  executionChain: 'intelligent_chain' | 'single_step' | 'static_strategy';
  selectionMode: SelectionMode;
  operationType: ActionKind;
  batchConfig?: BatchConfig;
  randomConfig?: RandomConfig;
  matchOriginalConfig?: MatchOriginalConfig;
}
```

### 2. æ·»åŠ é…ç½®éªŒè¯

åœ¨åŠ è½½æ­¥éª¤æ—¶éªŒè¯é…ç½®çš„å®Œæ•´æ€§ï¼š

```typescript
function validateDecisionChainConfig(config: any): DecisionChainConfig | null {
  if (!config) return null;
  
  return {
    executionChain: config.executionChain || 'intelligent_chain',
    selectionMode: config.selectionMode || 'first',
    operationType: config.operationType || 'tap',
    batchConfig: config.batchConfig,
    randomConfig: config.randomConfig,
    matchOriginalConfig: config.matchOriginalConfig
  };
}
```

### 3. æ·»åŠ å•å…ƒæµ‹è¯•

```typescript
describe('DecisionChain Persistence', () => {
  it('should save decision chain config to step parameters', () => {
    // æµ‹è¯•ä¿å­˜é…ç½®
  });
  
  it('should restore decision chain config from step parameters', () => {
    // æµ‹è¯•æ¢å¤é…ç½®
  });
});
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šæ—§è„šæœ¬æ²¡æœ‰ `decisionChain` å­—æ®µï¼Œéœ€è¦æä¾›é»˜è®¤å€¼
2. **æ·±åº¦åˆå¹¶**ï¼šæ›´æ–°é…ç½®æ—¶ä½¿ç”¨æ·±åº¦åˆå¹¶ï¼Œé¿å…è¦†ç›–å…¶ä»–é…ç½®
3. **ç±»å‹å®‰å…¨**ï¼šç¡®ä¿ TypeScript ç±»å‹å®šä¹‰å®Œæ•´

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼š
- âœ… ä¿å­˜è„šæœ¬æ—¶ï¼Œå†³ç­–é“¾é…ç½®è¢«æ­£ç¡®åºåˆ—åŒ–
- âœ… é‡æ–°æ‰“å¼€è„šæœ¬æ—¶ï¼Œå†³ç­–é“¾æŒ‰é’®æ­£ç¡®æ˜¾ç¤º
- âœ… é…ç½®çŠ¶æ€ï¼ˆé€‰ä¸­çš„æ¨¡å¼ã€æ“ä½œç±»å‹ï¼‰æ­£ç¡®æ¢å¤
- âœ… é«˜çº§é…ç½®ï¼ˆæ‰¹é‡ã€éšæœºã€ç²¾ç¡®åŒ¹é…ï¼‰ä¹Ÿæ­£ç¡®æ¢å¤

---

**ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
**é¢„è®¡å·¥ä½œé‡**ï¼š2-3å°æ—¶
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ï¼ˆéœ€è¦æµ‹è¯•å‘åå…¼å®¹æ€§ï¼‰
