# 批量归档功能模块

## 📋 功能概述

批量归档功能为联系人导入向导的号码池提供了高效的多选和归档操作，允许用户选择多个号码并将其重置为"未导入到任何手机"的状态。

## 🏗️ 模块架构

### 📁 文件结构
```
src/modules/contact-import/ui/batch-manager/components/
└── bulk-actions/                 # 批量操作模块
    ├── BulkActionsBar.tsx       # 批量操作栏 (~118行)
    ├── BulkArchiveDialog.tsx    # 归档确认对话框 (~138行)
    └── index.ts                 # 模块导出
```

### 🔧 核心组件

#### 1. **BulkActionsBar** (批量操作栏)
- **功能**: 当用户选择号码时显示，提供批量归档等操作
- **特性**:
  - 实时显示选中号码的统计信息（已导入/待导入/已生成VCF）
  - 智能归档按钮（仅对可归档的号码生效）
  - 优雅的梯度背景和视觉反馈
- **大小**: ~118行（符合架构约束）

#### 2. **BulkArchiveDialog** (归档确认对话框)
- **功能**: 显示将要归档的号码详情，确认后执行归档操作
- **特性**:
  - 详细的操作说明和影响预览
  - 号码列表表格显示（支持分页）
  - 批量数据库操作处理
- **大小**: ~138行（符合架构约束）

### 📊 增强的组件

#### 3. **NumbersTable** (增强多选功能)
- **新增功能**: 
  - `selection` prop 支持多选配置
  - `rowSelection` 表格行选择
  - 保持原有筛选和分页功能
- **当前大小**: ~285行（在可接受范围内）

#### 4. **BatchManagerDrawer** (集成批量操作)
- **新增功能**:
  - 批量选择状态管理
  - BulkActionsBar 集成
  - 归档完成后的数据刷新
- **当前大小**: ~120行（保持轻量级）

## 🛠️ 技术实现

### 前端服务层
#### contactNumberService.ts
```typescript
/**
 * 批量将指定ID的号码重置为未导入状态
 * @param numberIds 要归档的号码ID数组
 * @returns 操作影响的行数
 */
export async function markContactNumbersAsNotImported(numberIds: number[]): Promise<number>
```

### 后端 Rust 层
#### Tauri 命令
```rust
#[tauri::command]
pub async fn mark_contact_numbers_as_not_imported(number_ids: Vec<i64>) -> Result<i64, String>
```

#### 数据库操作
```rust
/// 批量将指定ID的号码重置为未导入状态
pub fn mark_numbers_as_not_imported_by_ids(conn: &Connection, number_ids: &[i64]) -> SqlResult<i64>
```

**数据库更新操作**:
- `used = 0` - 标记为未使用
- `used_at = NULL` - 清除使用时间
- `used_batch = NULL` - 清除批次信息
- `status = 'not_imported'` - 重置状态
- `imported_device_id = NULL` - 清除设备关联

## 🎯 使用流程

### 1. **选择号码**
- 在号码池页面，使用表格左侧的复选框选择需要归档的号码
- 支持单选、多选、全选操作
- 选择状态会实时显示在批量操作栏中

### 2. **查看统计**
- 批量操作栏会显示选中号码的详细统计：
  - 总数、已导入数量、待导入数量、已生成VCF数量
  - 可归档数量（已导入或已生成VCF的号码）

### 3. **执行归档**
- 点击"批量归档"按钮（仅在有可归档号码时可用）
- 弹出确认对话框，显示将要归档的号码详情
- 确认后执行批量数据库更新操作

### 4. **结果反馈**
- 操作完成后显示成功消息
- 自动刷新数据并清除选择状态
- 归档的号码状态被重置为"未导入"

## 📋 架构合规性

### ✅ 模块化设计
- 每个组件职责单一，文件大小控制在500行以内
- 清晰的模块边界和导出规范
- 支持独立测试和维护

### ✅ DDD 架构遵循
- 使用统一的服务层接口
- 遵循现有的数据访问模式
- 保持领域逻辑和表现层分离

### ✅ 类型安全
- 完整的 TypeScript 类型定义
- 严格的接口约束
- 编译时错误检测

### ✅ 用户体验
- 直观的多选操作界面
- 实时的状态反馈
- 优雅的确认流程

## 🔮 未来扩展

该模块化设计为未来功能扩展提供了良好的基础：

- **批量导出**: 可添加批量导出为VCF/CSV功能
- **批量分配**: 支持将选中号码分配到特定设备
- **批量标签**: 为选中号码添加行业标签
- **操作历史**: 记录批量操作的历史记录

---

*创建日期: 2025年1月*  
*模块版本: v1.0*  
*架构合规: ✅ 通过*