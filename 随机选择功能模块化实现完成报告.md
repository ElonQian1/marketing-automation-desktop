# éšæœºé€‰æ‹©åŠŸèƒ½æ¨¡å—åŒ–å®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡ä»»åŠ¡å®Œæˆäº†æ™ºèƒ½é€‰æ‹©ç³»ç»Ÿä¸­"éšæœºé€‰æ‹©"åŠŸèƒ½çš„æ¨¡å—åŒ–å®ç°ï¼ŒæŒ‰ç…§é¡¹ç›®æ¶æ„è§„èŒƒåˆ›å»ºäº†æ¸…æ™°çš„æ¨¡å—ç»“æ„ï¼Œå¹¶é›†æˆåˆ°ç°æœ‰çš„ `CompactStrategyMenu` ç»„ä»¶ä¸­ã€‚

## âœ¨ å®ç°å†…å®¹

### 1. æ¨¡å—åŒ–æ¶æ„è®¾è®¡

åˆ›å»ºäº†ç¬¦åˆé¡¹ç›®è§„èŒƒçš„ä¸‰å±‚æ¨¡å—ç»“æ„ï¼š

```
src/components/strategy-selector/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ selection-config.ts       # ç»Ÿä¸€ç±»å‹å®šä¹‰
â”œâ”€â”€ panels/
â”‚   â””â”€â”€ RandomConfigPanel.tsx     # éšæœºé€‰æ‹©UIç»„ä»¶
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ selection-mode-converter.ts   # æ¨¡å¼è½¬æ¢å·¥å…·
â”‚   â””â”€â”€ selection-config-saver.ts     # ä¿å­˜é€»è¾‘å·¥å…·
â””â”€â”€ index.ts                      # æ¨¡å—å¯¼å‡º
```

### 2. æ ¸å¿ƒç»„ä»¶ - RandomConfigPanel

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- âœ… è‡ªå®šä¹‰ç§å­è¾“å…¥ï¼ˆæ•°å­—ï¼‰
- âœ… è‡ªåŠ¨ç”Ÿæˆç§å­é€‰é¡¹
- âœ… ç¨³å®šæ’åºå¼€å…³ï¼ˆä¿è¯æ¯æ¬¡æ‰§è¡Œç»“æœä¸€è‡´ï¼‰
- âœ… å®æ—¶é…ç½®ä¿å­˜
- âœ… ç”¨æˆ·å‹å¥½çš„æç¤ºä¿¡æ¯

**UI è®¾è®¡ï¼š**
```tsx
<div className="random-config-panel">
  {/* ç§å­é…ç½® */}
  <div className="seed-control">
    <Switch checked={!customSeedEnabled} />
    <span>è‡ªåŠ¨ç”Ÿæˆ</span>
    {customSeedEnabled && (
      <Input type="number" value={seed} />
    )}
  </div>
  
  {/* ç¨³å®šæ’åº */}
  <div className="stable-sort-control">
    <Switch checked={ensureStableSort} />
    <span>å¯ç”¨ç¨³å®šæ’åº</span>
  </div>
</div>
```

### 3. ç±»å‹å®šä¹‰ç³»ç»Ÿ

**types/selection-config.ts:**
```typescript
// æ‰¹é‡é…ç½®
export interface BatchConfig {
  interval_ms: number;
  max_count: number;
  jitter_ms: number;
  continue_on_error: boolean;
  show_progress: boolean;
  match_direction: 'forward' | 'backward';
}

// éšæœºé…ç½®
export interface RandomConfig {
  seed: number | null;  // null è¡¨ç¤ºè‡ªåŠ¨ç”Ÿæˆ
  ensure_stable_sort: boolean;
  custom_seed_enabled: boolean;
}

// é€‰æ‹©æ¨¡å¼
export type SelectionMode = 
  | 'first' 
  | 'last' 
  | 'all' 
  | 'random' 
  | 'match-original' 
  | 'auto';

// é»˜è®¤é…ç½®
export const DEFAULT_BATCH_CONFIG: BatchConfig = { ... };
export const DEFAULT_RANDOM_CONFIG: RandomConfig = { 
  seed: null,
  ensure_stable_sort: true,
  custom_seed_enabled: false
};
```

### 4. å·¥å…·å‡½æ•°

#### æ¨¡å¼è½¬æ¢å™¨ (selection-mode-converter.ts)

**åŠŸèƒ½ï¼š** å°†å‰ç«¯ SelectionMode å­—ç¬¦ä¸²è½¬æ¢ä¸ºåç«¯æœŸæœ›çš„æšä¸¾å¯¹è±¡æ ¼å¼

```typescript
export function convertSelectionModeToBackend(
  mode: SelectionMode,
  batchConfig: BatchConfig,
  randomConfig: RandomConfig
) {
  switch (mode) {
    case 'random':
      return {
        type: 'Random',
        seed: randomConfig.custom_seed_enabled 
          ? randomConfig.seed 
          : null,  // null è§¦å‘åç«¯è‡ªåŠ¨ç”Ÿæˆ
        ensure_stable_sort: randomConfig.ensure_stable_sort
      };
    // ... å…¶ä»–æ¨¡å¼
  }
}
```

#### é…ç½®ä¿å­˜å™¨ (selection-config-saver.ts)

**åŠŸèƒ½ï¼š** ç»Ÿä¸€å¤„ç†æ‰€æœ‰é€‰æ‹©æ¨¡å¼çš„é…ç½®ä¿å­˜é€»è¾‘

```typescript
export interface SaveConfigParams {
  stepId: string;
  selectorId?: string;
  mode: SelectionMode;
  batchConfig?: BatchConfig | null;
  randomConfig?: RandomConfig;
  message: MessageInstance;
}

export async function saveSelectionConfigWithFeedback(
  params: SaveConfigParams
): Promise<boolean> {
  // 1. å‡†å¤‡ä¿å­˜å‚æ•°
  // 2. è°ƒç”¨åç«¯ API
  // 3. åŒé‡ä¿å­˜ï¼ˆstepId + selectorIdï¼‰
  // 4. æ˜¾ç¤ºç”¨æˆ·åé¦ˆ
}
```

**æ”¹è¿›ç‚¹ï¼š**
- âœ… å¯¹è±¡å‚æ•°æ›¿ä»£å¤šä¸ªä½ç½®å‚æ•°ï¼ˆæ›´æ˜“ç»´æŠ¤ï¼‰
- âœ… æ”¯æŒå¤šç§é…ç½®ç±»å‹ï¼ˆbatch, randomï¼‰
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- âœ… è‡ªåŠ¨å…œåº•é€»è¾‘ï¼ˆä» store è·å– selectorIdï¼‰

### 5. é›†æˆåˆ° CompactStrategyMenu

**çŠ¶æ€ç®¡ç†ï¼š**
```typescript
const [randomConfig, setRandomConfig] = useState<RandomConfig>(
  DEFAULT_RANDOM_CONFIG
);
```

**UI æ¸²æŸ“ï¼š**
```tsx
{/* ğŸ² éšæœºé…ç½®é¢æ¿ */}
{selectionMode === 'random' && (
  <RandomConfigPanel
    config={randomConfig}
    onChange={(newConfig) => {
      setRandomConfig(newConfig);
      // å®æ—¶ä¿å­˜é…ç½®
      if (stepId) {
        saveSelectionConfigWithFeedback({
          stepId,
          selectorId: stepId,
          mode: 'random',
          randomConfig: newConfig,
          message
        }).catch(console.error);
      }
    }}
  />
)}
```

**æ¨¡å¼åˆ‡æ¢å¤„ç†ï¼š**
```typescript
case 'random':
  setSelectionMode('random');
  const newRandomConfig: RandomConfig = {
    seed: null,
    ensure_stable_sort: true,
    custom_seed_enabled: false,
  };
  setRandomConfig(newRandomConfig);
  
  await saveSelectionConfigWithFeedback({
    stepId: stepId!,
    selectorId: stepId,
    mode: 'random',
    randomConfig: newRandomConfig,
    message
  });
  break;
```

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. æ¨¡å—åŒ–è®¾è®¡
- **èŒè´£åˆ†ç¦»**ï¼šç±»å‹ã€UIã€é€»è¾‘åˆ†åˆ«ç‹¬ç«‹
- **å¯å¤ç”¨æ€§**ï¼šå·¥å…·å‡½æ•°å¯è¢«å…¶ä»–æ¨¡å—ä½¿ç”¨
- **å¯æµ‹è¯•æ€§**ï¼šæ¯ä¸ªæ¨¡å—éƒ½å¯ç‹¬ç«‹æµ‹è¯•

### 2. ç±»å‹å®‰å…¨
```typescript
// ä¸¥æ ¼çš„ç±»å‹çº¦æŸ
interface RandomConfig {
  seed: number | null;  // æ˜ç¡® null çš„è¯­ä¹‰
  ensure_stable_sort: boolean;
  custom_seed_enabled: boolean;
}

// æšä¸¾ç±»å‹ç¡®ä¿æ¨¡å¼ä¸€è‡´æ€§
type SelectionMode = 'first' | 'last' | 'all' | 'random' | 'match-original' | 'auto';
```

### 3. å®æ—¶ä¿å­˜æœºåˆ¶
```typescript
onChange={(newConfig) => {
  setRandomConfig(newConfig);  // æ›´æ–°æœ¬åœ°çŠ¶æ€
  
  // ç«‹å³ä¿å­˜åˆ°åç«¯
  saveSelectionConfigWithFeedback({
    stepId,
    mode: 'random',
    randomConfig: newConfig,
    message
  }).catch(console.error);
}}
```

### 4. åŒé‡ä¿å­˜ç­–ç•¥
```typescript
// 1. ä¿å­˜åˆ° stepId
await invoke('save_smart_selection_config', {
  stepId: stepId,
  ...params
});

// 2. ä¿å­˜åˆ° selectorIdï¼ˆå…œåº•ï¼Œæ”¯æŒè·¨æ­¥éª¤å¤ç”¨ï¼‰
if (selectorId) {
  await invoke('save_smart_selection_config', {
    stepId: selectorId,
    ...params
  });
}
```

## ğŸ“Š æ–‡ä»¶æ”¹åŠ¨ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶ (5ä¸ª)
1. `types/selection-config.ts` - ç±»å‹å®šä¹‰ï¼ˆ~100è¡Œï¼‰
2. `panels/RandomConfigPanel.tsx` - UIç»„ä»¶ï¼ˆ~150è¡Œï¼‰
3. `utils/selection-mode-converter.ts` - è½¬æ¢å·¥å…·ï¼ˆ~80è¡Œï¼‰
4. `utils/selection-config-saver.ts` - ä¿å­˜å·¥å…·ï¼ˆ~120è¡Œï¼‰
5. `index.ts` - æ¨¡å—å¯¼å‡ºï¼ˆ~20è¡Œï¼‰

### ä¿®æ”¹æ–‡ä»¶ (1ä¸ª)
- `CompactStrategyMenu.tsx` - é›†æˆéšæœºé…ç½®ï¼ˆ+50è¡Œ, -20è¡Œï¼‰

**æ€»è®¡ï¼š** +520è¡Œ, -20è¡Œ

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

### åŸºç¡€åŠŸèƒ½
- [x] éšæœºé€‰æ‹©æ¨¡å¼å¯æ­£å¸¸åˆ‡æ¢
- [x] éšæœºé…ç½®é¢æ¿æ­£ç¡®æ˜¾ç¤º/éšè—
- [x] è‡ªå®šä¹‰ç§å­è¾“å…¥æ­£å¸¸å·¥ä½œ
- [x] è‡ªåŠ¨ç”Ÿæˆç§å­é€‰é¡¹æ­£å¸¸å·¥ä½œ
- [x] ç¨³å®šæ’åºå¼€å…³æ­£å¸¸å·¥ä½œ

### ä¿å­˜æœºåˆ¶
- [x] é…ç½®ä¿®æ”¹åè‡ªåŠ¨ä¿å­˜
- [x] æ¨¡å¼åˆ‡æ¢æ—¶ä¿å­˜é»˜è®¤é…ç½®
- [x] åŒé‡ä¿å­˜ï¼ˆstepId + selectorIdï¼‰
- [x] ä¿å­˜æˆåŠŸæ˜¾ç¤ºæç¤ºæ¶ˆæ¯
- [x] ä¿å­˜å¤±è´¥æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯

### ç±»å‹å®‰å…¨
- [x] TypeScript ç¼–è¯‘é€šè¿‡
- [x] æ‰€æœ‰ç±»å‹å®šä¹‰å®Œæ•´
- [x] æ— ç±»å‹é”™è¯¯æˆ–è­¦å‘Šï¼ˆé™¤ globalScore æœªä½¿ç”¨ï¼‰

### ä»£ç è´¨é‡
- [x] ç¬¦åˆé¡¹ç›®å‘½åè§„èŒƒ
- [x] ç¬¦åˆæ¨¡å—åŒ–æ¶æ„
- [x] ä»£ç æ³¨é‡Šå®Œæ•´
- [x] æ–‡ä»¶å¤´ä¿¡æ¯é½å…¨

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. ç”¨æˆ·æ“ä½œæµç¨‹

1. **é€‰æ‹©éšæœºæ¨¡å¼**
   ```
   ç”¨æˆ·ç‚¹å‡»ä¸‹æ‹‰èœå• â†’ é€‰æ‹© "ğŸ² éšæœºé€‰æ‹©"
   ```

2. **é…ç½®éšæœºå‚æ•°**
   - é»˜è®¤å¯ç”¨è‡ªåŠ¨ç”Ÿæˆç§å­
   - å¯åˆ‡æ¢åˆ°è‡ªå®šä¹‰ç§å­å¹¶è¾“å…¥æ•°å­—
   - å¯å¼€å¯/å…³é—­ç¨³å®šæ’åº

3. **å®æ—¶ä¿å­˜**
   - æ¯æ¬¡ä¿®æ”¹é…ç½®åè‡ªåŠ¨ä¿å­˜
   - æ˜¾ç¤ºæˆåŠŸæç¤ºæ¶ˆæ¯

4. **æ‰§è¡Œæµ‹è¯•**
   - ç‚¹å‡»"æµ‹è¯•æ‰§è¡Œ"æŒ‰é’®
   - ç³»ç»Ÿä½¿ç”¨é…ç½®çš„éšæœºå‚æ•°æ‰§è¡Œ

### 2. å¼€å‘è€…é›†æˆ

```typescript
// å¯¼å…¥æ¨¡å—
import {
  RandomConfigPanel,
  convertSelectionModeToBackend,
  saveSelectionConfigWithFeedback,
  DEFAULT_RANDOM_CONFIG,
  type RandomConfig
} from './components/strategy-selector';

// ä½¿ç”¨ç»„ä»¶
<RandomConfigPanel
  config={randomConfig}
  onChange={handleChange}
/>

// è½¬æ¢æ¨¡å¼
const backendMode = convertSelectionModeToBackend(
  'random',
  batchConfig,
  randomConfig
);

// ä¿å­˜é…ç½®
await saveSelectionConfigWithFeedback({
  stepId,
  mode: 'random',
  randomConfig,
  message
});
```

## ğŸ”„ ä¸ç°æœ‰åŠŸèƒ½çš„å…¼å®¹æ€§

### æ‰¹é‡å…¨éƒ¨æ¨¡å¼
- âœ… ç»§ç»­ä½¿ç”¨ `BatchConfig`
- âœ… é…ç½®é¢æ¿ç‹¬ç«‹æ˜¾ç¤º
- âœ… ä¿å­˜é€»è¾‘ç‹¬ç«‹å¤„ç†

### å…¶ä»–é€‰æ‹©æ¨¡å¼
- âœ… first/last æ¨¡å¼ä¸å—å½±å“
- âœ… auto æ¨¡å¼æ­£å¸¸å·¥ä½œ
- âœ… match-original æ¨¡å¼æ­£å¸¸å·¥ä½œ

### æ‰§è¡Œé€»è¾‘
- âœ… å…±ç”¨ `convertSelectionModeToBackend`
- âœ… å…±ç”¨ `saveSelectionConfigWithFeedback`
- âœ… å…±ç”¨ `createSmartSelectionProtocol`

## ğŸ“ å¾…æ”¹è¿›é¡¹

### çŸ­æœŸä¼˜åŒ–
1. **ç§»é™¤ globalScore æœªä½¿ç”¨è­¦å‘Š**
   ```typescript
   // é€‰é¡¹1: ä½¿ç”¨å®ƒ
   console.log('Global score:', globalScore);
   
   // é€‰é¡¹2: ç§»é™¤å®ƒ
   // const globalScore = ...
   ```

2. **å¢å¼ºé”™è¯¯å¤„ç†**
   - æ·»åŠ ç§å­å€¼èŒƒå›´éªŒè¯
   - æ·»åŠ ç½‘ç»œé”™è¯¯é‡è¯•æœºåˆ¶

3. **UI ä¼˜åŒ–**
   - æ·»åŠ ç§å­è¾“å…¥çš„å ä½ç¬¦æç¤º
   - æ·»åŠ é…ç½®é¢„è§ˆåŠŸèƒ½

### é•¿æœŸè§„åˆ’
1. **æ€§èƒ½ç›‘æ§**
   - è®°å½•éšæœºé€‰æ‹©çš„æ‰§è¡Œæ—¶é—´
   - ç»Ÿè®¡ç§å­ä½¿ç”¨é¢‘ç‡

2. **é«˜çº§åŠŸèƒ½**
   - æ”¯æŒç§å­å†å²è®°å½•
   - æ”¯æŒç§å­æ”¶è—åŠŸèƒ½
   - æ”¯æŒéšæœºç­–ç•¥æ¨¡æ¿

3. **æµ‹è¯•è¦†ç›–**
   - æ·»åŠ å•å…ƒæµ‹è¯•
   - æ·»åŠ é›†æˆæµ‹è¯•
   - æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•

## ğŸ¯ æ€»ç»“

æœ¬æ¬¡å®ç°æˆåŠŸå®Œæˆäº†éšæœºé€‰æ‹©åŠŸèƒ½çš„æ¨¡å—åŒ–æ”¹é€ ï¼Œä¸»è¦æˆå°±åŒ…æ‹¬ï¼š

âœ… **æ¶æ„ä¼˜åŒ–** - åˆ›å»ºæ¸…æ™°çš„ä¸‰å±‚æ¨¡å—ç»“æ„
âœ… **åŠŸèƒ½å®Œå–„** - å®ç°å®Œæ•´çš„éšæœºé€‰æ‹©é…ç½®UI
âœ… **ä»£ç è´¨é‡** - ç±»å‹å®‰å…¨ã€å®æ—¶ä¿å­˜ã€é”™è¯¯å¤„ç†
âœ… **å‘åå…¼å®¹** - ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œå¹³æ»‘é›†æˆ

**æŠ€æœ¯å€ºåŠ¡ï¼š** æ— æ–°å¢æŠ€æœ¯å€ºåŠ¡ï¼Œåè€Œå‡å°‘äº†ä»£ç é‡å¤

**æ€§èƒ½å½±å“ï¼š** æ— æ˜æ˜¾æ€§èƒ½å½±å“ï¼Œå®æ—¶ä¿å­˜æœºåˆ¶é«˜æ•ˆ

**ç”¨æˆ·ä½“éªŒï¼š** æä¾›ç›´è§‚çš„é…ç½®ç•Œé¢å’Œå³æ—¶åé¦ˆ

---

**æäº¤è®°å½•ï¼š** f5b04691
**åˆ›å»ºæ—¶é—´ï¼š** 2025-01-XX
**å¼€å‘è€…ï¼š** AI Assistant + ç”¨æˆ·åä½œ
