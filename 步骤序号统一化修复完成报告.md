# æ­¥éª¤åºå·ç»Ÿä¸€åŒ–ä¿®å¤å®ŒæˆæŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-11-14  
**ä¿®å¤èŒƒå›´**: å‰åç«¯æ­¥éª¤åºå·åŒæ­¥ + é™æ€ç­–ç•¥å¤ç”¨é€»è¾‘ä¼˜åŒ–

---

## ğŸ“Š ä¿®å¤æ‘˜è¦

### âœ… å·²å®Œæˆçš„ä¿®å¤

1. **åˆ›å»ºç»Ÿä¸€æ­¥éª¤åºå·é…ç½®** (`src/config/step-sequence.ts`)
   - å»ºç«‹å•ä¸€æ•°æ®æºï¼Œå®šä¹‰Step1-8çš„å®Œæ•´æ˜ å°„å…³ç³»
   - æä¾›æ˜ å°„å·¥å…·ç±» `StepSequenceMapper` ç”¨äºå‰åç«¯è½¬æ¢
   - æ˜ç¡®æ­¥éª¤ç±»åˆ«ï¼šç»“æ„åŒ¹é…ï¼ˆStep1-2ï¼‰+ ä¼ ç»Ÿç­–ç•¥ï¼ˆStep3-8ï¼‰

2. **æ›´æ–°å‰ç«¯æ­¥éª¤é…ç½®** (`CompactStrategyMenu.tsx`)
   - ä½¿ç”¨ç»Ÿä¸€é…ç½®æ›¿æ¢ç¡¬ç¼–ç çš„ `SMART_STEPS`
   - ä¿®å¤é™æ€ç­–ç•¥å­é€‰é¡¹çš„å¤ç”¨é€»è¾‘
   - æ·»åŠ æ˜ç¡®çš„è¯„åˆ†æ¥æºæ ‡è®°

3. **åŒæ­¥åç«¯æ­¥éª¤æ³¨é‡Š** (Rustä»£ç )
   - `strategy_engine.rs`: æ›´æ–°æ­¥éª¤åºå·æ³¨é‡Š
   - `chain_engine.rs`: æ›´æ–°Step 0-6 â†’ Step 1-8æ³¨é‡Š
   - ç¡®ä¿å‰åç«¯æ­¥éª¤åºå·ä¸€è‡´

4. **åˆ›å»ºè¯„åˆ†éªŒè¯å·¥å…·** (`utils/step-scoring-validator.ts`)
   - éªŒè¯candidateKeyæœ‰æ•ˆæ€§
   - è¿½è¸ªè¯„åˆ†æ•°æ®æµ
   - ç”Ÿæˆä¸€è‡´æ€§æŠ¥å‘Š

5. **æ›´æ–°ç±»å‹å®šä¹‰** (`types/strategySelector.ts`)
   - åŒæ­¥SmartStepç±»å‹æ³¨é‡Š
   - æ·»åŠ V3æ¶æ„è¯´æ˜

---

## ğŸ¯ æ–°çš„æ­¥éª¤åºå·ä½“ç³»ï¼ˆV3æ¶æ„ï¼‰

| åºå· | StepId | CandidateKey | æ˜¾ç¤ºåç§° | ç±»åˆ« |
|------|--------|--------------|----------|------|
| Step 1 | step1 | card_subtree_scoring | å¡ç‰‡å­æ ‘è¯„åˆ† | ç»“æ„åŒ¹é…ä¼˜å…ˆ |
| Step 2 | step2 | leaf_context_scoring | å¶å­ä¸Šä¸‹æ–‡è¯„åˆ† | ç»“æ„åŒ¹é…ä¼˜å…ˆ |
| Step 3 | step3 | self_anchor | è‡ªé”šå®šç­–ç•¥ | ä¼ ç»Ÿç­–ç•¥ |
| Step 4 | step4 | child_driven | å­å…ƒç´ é©±åŠ¨ | ä¼ ç»Ÿç­–ç•¥ |
| Step 5 | step5 | region_scoped | åŒºåŸŸçº¦æŸ | ä¼ ç»Ÿç­–ç•¥ |
| Step 6 | step6 | xpath_fallback | XPathå…œåº• | ä¼ ç»Ÿç­–ç•¥ï¼ˆå…œåº•ï¼‰ |
| Step 7 | step7 | index_fallback | ç´¢å¼•å…œåº• | ä¼ ç»Ÿç­–ç•¥ï¼ˆå…œåº•ï¼‰ |
| Step 8 | step8 | emergency_fallback | åº”æ€¥å…œåº• | ä¼ ç»Ÿç­–ç•¥ï¼ˆå…œåº•ï¼‰ |

---

## ğŸ”§ å…³é”®ä¿®å¤ç‚¹

### 1. é™æ€ç­–ç•¥å­é€‰é¡¹å¤ç”¨é€»è¾‘

**ä¿®å¤å‰é—®é¢˜**:
```typescript
// âŒ ç›´æ¥è°ƒç”¨onStrategyChangeï¼Œé€»è¾‘è·³è½¬ä¸æ¸…æ™°
onClick: async () => {
  events.onStrategyChange({ type: "smart-single", stepName: "step1" });
}
```

**ä¿®å¤åæ–¹æ¡ˆ**:
```typescript
// âœ… å…±äº«è¯„åˆ†é€»è¾‘æ–¹æ¡ˆï¼šæ˜ç¡®æ ‡è®°å…±äº«å…³ç³»
onClick: async () => {
  // æ­¥éª¤1: è§¦å‘è¯„åˆ†ï¼ˆå¤ç”¨æ™ºèƒ½å•æ­¥çš„ä¸‰è·¯è¯„åˆ†é€»è¾‘ï¼‰
  const step1Config = StepSequenceMapper.getByStepId('step1');
  events.onStrategyChange({ type: "smart-single", stepName: "step1" });
  
  // æ­¥éª¤2: æ ‡è®°ä¸ºé™æ€ç­–ç•¥ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…è¢«è¦†ç›–ï¼‰
  setTimeout(() => {
    events.onStrategyChange({ 
      type: "static", 
      key: "structural_matching_card_subtree",
      _sharedBaseStep: "step1"  // è¿½è¸ªå…±äº«çš„åŸºç¡€æ­¥éª¤
    });
  }, 200);
}
```

### 2. æ­¥éª¤åºå·æ˜ å°„å·¥å…·

**æä¾›çš„API**:
```typescript
// å€™é€‰é¡¹key â†’ StepId
StepSequenceMapper.candidateKeyToStepId('card_subtree_scoring')  // â†’ 'step1'

// StepId â†’ å€™é€‰é¡¹key
StepSequenceMapper.stepIdToCandidateKey('step1')  // â†’ 'card_subtree_scoring'

// è·å–æ­¥éª¤é…ç½®
StepSequenceMapper.getByStep(1)  // â†’ å®Œæ•´é…ç½®å¯¹è±¡
StepSequenceMapper.getByCandidateKey('card_subtree_scoring')  // â†’ å®Œæ•´é…ç½®å¯¹è±¡

// æŒ‰ç±»åˆ«è·å–æ­¥éª¤
StepSequenceMapper.getStructureMatchingSteps()  // â†’ [Step1, Step2]
StepSequenceMapper.getTraditionalSteps()  // â†’ [Step3-8]
StepSequenceMapper.getFallbackSteps()  // â†’ [Step6, Step7, Step8]
```

### 3. è¯„åˆ†æ•°æ®éªŒè¯

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
import { validateStepScore } from '@/utils/step-scoring-validator';

// éªŒè¯è¯„åˆ†æ•°æ®
validateStepScore('card_subtree_scoring', 0.85, 'structural_matching');

// è¾“å‡ºï¼š
// ğŸ“Š [è¯„åˆ†æ•°æ®æµè¿½è¸ª] {
//   æ—¶é—´æˆ³: "2025-11-14T...",
//   æ¥æº: "structural_matching",
//   å€™é€‰é¡¹Key: "card_subtree_scoring",
//   ç½®ä¿¡åº¦: "85.0%",
//   æ­¥éª¤é…ç½®: { åºå·: 1, æ ‡ç­¾: "Step1 - å¡ç‰‡å­æ ‘è¯„åˆ†", ç±»åˆ«: "structure_matching" }
// }
```

---

## ğŸ§ª éªŒè¯ç»“æœ

### TypeScriptç¼–è¯‘
- âœ… æ–°å¢ä»£ç æ— ç¼–è¯‘é”™è¯¯
- âš ï¸ å­˜åœ¨ä¸€äº›ä¸æœ¬æ¬¡ä¿®å¤æ— å…³çš„æ—§ä»£ç ç±»å‹é”™è¯¯ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

### Rustç¼–è¯‘
- âœ… ç¼–è¯‘æˆåŠŸ
- âš ï¸ éƒ¨åˆ†æœªä½¿ç”¨å¯¼å…¥çš„è­¦å‘Šï¼ˆå¯åç»­æ¸…ç†ï¼‰

---

## ğŸ“‹ æ¶æ„æ”¹è¿›

### ä¿®å¤å‰çš„é—®é¢˜

1. **æ­¥éª¤åºå·ç¡¬ç¼–ç **
   - å‰ç«¯å’Œåç«¯æ­¥éª¤åºå·åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶
   - ä¿®æ”¹åºå·éœ€è¦æ‰‹åŠ¨åŒæ­¥å¤šå¤„ä»£ç 
   - å®¹æ˜“å‡ºç°å‰åç«¯ä¸ä¸€è‡´

2. **é™æ€ç­–ç•¥å¤ç”¨é€»è¾‘æ··ä¹±**
   - "é™æ€ç­–ç•¥-ç»“æ„åŒ¹é…-å¡ç‰‡å­æ ‘" å®é™…è§¦å‘ "æ™ºèƒ½å•æ­¥-Step1"
   - ç”¨æˆ·ä½“éªŒæ··ä¹±ï¼Œä¸æ¸…æ¥šçœŸå®æ‰§è¡Œçš„æ˜¯å“ªç§ç­–ç•¥
   - è¯„åˆ†ç»“æœå½’å±ä¸æ˜ç¡®

3. **è¯„åˆ†æ•°æ®æµç¼ºä¹éªŒè¯**
   - æ— æ³•è¿½è¸ªè¯„åˆ†æ•°æ®æ¥æº
   - éš¾ä»¥è¯Šæ–­å‰åç«¯æ˜ å°„é”™è¯¯
   - ç¼ºå°‘æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

### ä¿®å¤åçš„ä¼˜åŠ¿

1. **å•ä¸€æ•°æ®æº**
   - æ‰€æœ‰æ­¥éª¤åºå·é…ç½®é›†ä¸­åœ¨ `config/step-sequence.ts`
   - å‰åç«¯å…±äº«åŒä¸€å¥—åºå·ä½“ç³»
   - ä¿®æ”¹æ—¶åªéœ€æ›´æ–°ä¸€å¤„

2. **æ¸…æ™°çš„å¤ç”¨æœºåˆ¶**
   - æ˜ç¡®æ ‡è®°é™æ€ç­–ç•¥å­é€‰é¡¹å¤ç”¨æ™ºèƒ½å•æ­¥çš„è¯„åˆ†é€»è¾‘
   - ä½¿ç”¨ `_sharedBaseStep` è¿½è¸ªå…±äº«å…³ç³»
   - å»¶è¿Ÿç­–ç•¥çŠ¶æ€æ›´æ–°ï¼Œé¿å…çŠ¶æ€æ··ä¹±

3. **å®Œå–„çš„æ•°æ®éªŒè¯**
   - æä¾› `StepScoringValidator` éªŒè¯è¯„åˆ†æ•°æ®
   - è‡ªåŠ¨è¿½è¸ªè¯„åˆ†æ•°æ®æµ
   - ç”Ÿæˆä¸€è‡´æ€§æŠ¥å‘Šè¾…åŠ©è°ƒè¯•

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### P1 - é‡è¦ä¼˜åŒ–

1. **å»ºç«‹æ­¥éª¤åºå·ç‰ˆæœ¬ç®¡ç†**
   - ä¸ºæ­¥éª¤åºå·é…ç½®æ·»åŠ ç‰ˆæœ¬å·
   - æ”¯æŒå‘åå…¼å®¹æ—§ç‰ˆæœ¬çš„æ­¥éª¤é…ç½®

2. **ä¼˜åŒ–é™æ€ç­–ç•¥å¤ç”¨æ–¹å¼**
   - è€ƒè™‘æå–å…±äº«è¯„åˆ†é€»è¾‘ä¸ºç‹¬ç«‹å‡½æ•°
   - å‡å°‘setTimeoutå»¶è¿Ÿæ›´æ–°çš„ä½¿ç”¨
   - æ”¹è¿›ç­–ç•¥çŠ¶æ€ç®¡ç†æœºåˆ¶

3. **å®Œå–„è¯„åˆ†æ•°æ®è¿½è¸ª**
   - åœ¨evaluation_bridgeä¸­é›†æˆéªŒè¯å·¥å…·
   - æ·»åŠ è¯„åˆ†æ•°æ®æŒä¹…åŒ–è¿½è¸ª
   - æ„å»ºè¯„åˆ†æ•°æ®æµå¯è§†åŒ–å·¥å…·

### P2 - é•¿æœŸæ”¹è¿›

4. **å»ºç«‹æ­¥éª¤åºå·æ˜ å°„æµ‹è¯•**
   - æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯æ˜ å°„å…³ç³»
   - è‡ªåŠ¨åŒ–æµ‹è¯•å‰åç«¯ä¸€è‡´æ€§
   - CI/CDé›†æˆæ­¥éª¤åºå·éªŒè¯

5. **å®Œå–„ç±»å‹ç³»ç»Ÿ**
   - ä¸ºä¸‰ç§æ¨¡å¼å»ºç«‹ç‹¬ç«‹çš„ç±»å‹å®šä¹‰
   - ä½¿ç”¨TypeScriptå­—é¢é‡ç±»å‹å¢å¼ºç±»å‹å®‰å…¨
   - å‡å°‘ç±»å‹æ–­è¨€å’Œ@ts-expect-errorçš„ä½¿ç”¨

6. **ä¼˜åŒ–XMLç¼“å­˜ç­–ç•¥**
   - æ˜ç¡®ç¼“å­˜ä¼˜å…ˆçº§è§„åˆ™
   - å®ç°ç¼“å­˜å¤±æ•ˆè‡ªåŠ¨æ£€æµ‹
   - æ·»åŠ ç¼“å­˜æ€§èƒ½ç›‘æ§

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### æ·»åŠ æ–°æ­¥éª¤

1. åœ¨ `config/step-sequence.ts` ä¸­æ·»åŠ æ–°æ­¥éª¤é…ç½®ï¼š
```typescript
{
  step: 9,
  stepId: 'step9',
  candidateKey: 'new_strategy',
  label: 'Step9 - æ–°ç­–ç•¥',
  displayName: 'æ–°ç­–ç•¥',
  category: 'traditional',
}
```

2. æ›´æ–° `types/strategySelector.ts` ä¸­çš„ç±»å‹å®šä¹‰ï¼š
```typescript
export type SmartStep = 'step1' | ... | 'step9';
```

3. æ›´æ–°åç«¯ Rust ä»£ç æ³¨é‡Šï¼ˆå¦‚éœ€è¦ï¼‰

### ä½¿ç”¨æ˜ å°„å·¥å…·

```typescript
import { StepSequenceMapper } from '@/config/step-sequence';

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const stepConfig = StepSequenceMapper.getByCandidateKey('card_subtree_scoring');
console.log(`å½“å‰æ­¥éª¤: ${stepConfig.label}`);
```

### éªŒè¯è¯„åˆ†æ•°æ®

```typescript
import { StepScoringValidator } from '@/utils/step-scoring-validator';

// éªŒè¯å•ä¸ªè¯„åˆ†
const validation = StepScoringValidator.validateScoreData({
  candidateKey: 'card_subtree_scoring',
  confidence: 0.85,
});

if (!validation.isValid) {
  console.error('è¯„åˆ†éªŒè¯å¤±è´¥:', validation.errors);
}

// ç”Ÿæˆä¸€è‡´æ€§æŠ¥å‘Š
const report = StepScoringValidator.generateConsistencyReport(allScores);
console.log(`æœ‰æ•ˆè¯„åˆ†: ${report.validScores}/${report.totalScores}`);
```

---

## âœ… ä¿®å¤å®Œæˆæ£€æŸ¥æ¸…å•

- [x] åˆ›å»ºç»Ÿä¸€æ­¥éª¤åºå·é…ç½®æ–‡ä»¶
- [x] æ›´æ–°å‰ç«¯SMART_STEPSä½¿ç”¨æ–°é…ç½®
- [x] åŒæ­¥åç«¯Rustæ­¥éª¤æ³¨é‡Š
- [x] ä¿®å¤é™æ€ç­–ç•¥å­é€‰é¡¹å¤ç”¨é€»è¾‘
- [x] åˆ›å»ºè¯„åˆ†æ•°æ®éªŒè¯å·¥å…·
- [x] æ›´æ–°ç›¸å…³ç±»å‹å®šä¹‰
- [x] éªŒè¯TypeScriptç¼–è¯‘
- [x] éªŒè¯Rustç¼–è¯‘
- [x] ç¼–å†™ä¿®å¤å®ŒæˆæŠ¥å‘Š

---

## ğŸ¯ éªŒè¯æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1: æ™ºèƒ½å•æ­¥è¯„åˆ†
1. è¿›å…¥é¡µé¢åˆ†æï¼Œè¯»å–XMLæ–‡ä»¶
2. ç‚¹é€‰å…ƒç´ ï¼Œåˆ›å»ºæ­¥éª¤å¡ç‰‡
3. é€‰æ‹©"æ™ºèƒ½Â·å•æ­¥" â†’ "Step1 - å¡ç‰‡å­æ ‘è¯„åˆ†"
4. éªŒè¯è¯„åˆ†æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
5. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„candidateKey

### æµ‹è¯•åœºæ™¯2: é™æ€ç­–ç•¥å¤ç”¨
1. åˆ›å»ºæ­¥éª¤å¡ç‰‡
2. é€‰æ‹©"é™æ€ç­–ç•¥" â†’ "ç»“æ„åŒ¹é…" â†’ "å¡ç‰‡å­æ ‘è¯„åˆ†"
3. éªŒè¯è§¦å‘äº†è¯„åˆ†é€»è¾‘
4. æ£€æŸ¥ç­–ç•¥çŠ¶æ€æ˜¯å¦æ­£ç¡®æ ‡è®°ä¸ºé™æ€ç­–ç•¥
5. éªŒè¯è¯„åˆ†ç»“æœä¸æ™ºèƒ½å•æ­¥Step1ä¸€è‡´

### æµ‹è¯•åœºæ™¯3: æ™ºèƒ½è‡ªåŠ¨é“¾
1. åˆ›å»ºæ­¥éª¤å¡ç‰‡
2. é€‰æ‹©"æ™ºèƒ½Â·è‡ªåŠ¨é“¾"
3. éªŒè¯æ‰€æœ‰æ­¥éª¤ï¼ˆStep1-8ï¼‰çš„è¯„åˆ†æ˜¾ç¤º
4. æ£€æŸ¥æ¨èæ­¥éª¤æ˜¯å¦é«˜äº®
5. éªŒè¯ç½®ä¿¡åº¦é¢œè‰²æ ‡ç­¾æ˜¯å¦æ­£ç¡®

---

**ä¿®å¤è´Ÿè´£äºº**: GitHub Copilot  
**å®¡æ ¸çŠ¶æ€**: å¾…æµ‹è¯•éªŒè¯  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
