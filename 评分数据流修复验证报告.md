# è¯„åˆ†æ•°æ®æµä¿®å¤éªŒè¯æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜è¯Šæ–­

### åŸå§‹é—®é¢˜
ç”¨æˆ·åé¦ˆï¼š"é™æ€åˆ†æçš„è¯„åˆ†ï¼Œéƒ½å¥½åƒä¸€ä¸ªç¡¬ç¼–ç ï¼Œä¸æ˜¯çœŸçš„"

### æ ¹æœ¬åŸå› 
è¯„åˆ†æ•°æ®ç¡®å®æ˜¯**çœŸå®åç«¯æ•°æ®**ï¼Œä½†ç”±äº**é”®åä¸åŒ¹é…**å¯¼è‡´æ— æ³•æ­£ç¡®æ˜¾ç¤ºï¼š

1. **å­˜å‚¨æ—¶ä½¿ç”¨**ï¼š`stepId: 'CardSubtree'` / `stepId: 'LeafContext'`
2. **æŸ¥è¯¢æ—¶ä½¿ç”¨**ï¼š`getStepConfidence('card_subtree_scoring')` / `getStepConfidence('leaf_context_scoring')`
3. **ç»“æœ**ï¼šé”®ä¸åŒ¹é… â†’ è¯„åˆ†æŸ¥è¯¢å¤±è´¥ â†’ æ˜¾ç¤ºä¸º `undefined`

## ğŸ”§ å·²æœ‰åŸºç¡€è®¾æ–½ï¼ˆæœªè¢«ä½¿ç”¨ï¼‰

### StepSequenceMapperï¼ˆå·²å®ç°ï¼‰
```typescript
// src/config/step-sequence.ts
StepSequenceMapper.candidateKeyToStepId('card_subtree_scoring')  // â†’ 'step1'
StepSequenceMapper.stepIdToCandidateKey('step1')  // â†’ 'card_subtree_scoring'
```

### step-score-store.tsï¼ˆå·²å®ç°ï¼‰
```typescript
// æ”¯æŒåŒé”®å­˜å‚¨ï¼šstepId + candidateKey
setCandidateScore(stepId, candidateKey, confidence)
getCandidateScore(stepId, candidateKey)
```

### step-scoring-validator.tsï¼ˆå·²å®ç°ï¼‰
```typescript
// éªŒè¯è¯„åˆ†æ•°æ®ä¸€è‡´æ€§
validateCandidateKey(candidateKey)
validateScoreData({ stepId, candidateKey, confidence })
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼šsmart-auto-scoring.ts

**ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰**ï¼š
```typescript
results.push({
  stepId: 'CardSubtree',  // âŒ ä½¿ç”¨åç«¯è¿”å›çš„modeåç§°
  confidence: cardSubtreeOutcome.conf,
  // ...
});

results.push({
  stepId: 'LeafContext',  // âŒ ä½¿ç”¨åç«¯è¿”å›çš„modeåç§°
  confidence: leafContextOutcome.conf,
  // ...
});
```

**ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰**ï¼š
```typescript
results.push({
  stepId: 'card_subtree_scoring',  // âœ… ä½¿ç”¨candidateKeyä¸èœå•æŸ¥è¯¢åŒ¹é…
  confidence: cardSubtreeOutcome.conf,
  // ...
});

results.push({
  stepId: 'leaf_context_scoring',  // âœ… ä½¿ç”¨candidateKeyä¸èœå•æŸ¥è¯¢åŒ¹é…
  confidence: leafContextOutcome.conf,
  // ...
});
```

## ğŸ¯ æ•°æ®æµéªŒè¯

### å®Œæ•´æ•°æ®æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»ç­–ç•¥èœå•
   â†“
2. è°ƒç”¨è¯„åˆ†å‡½æ•°ï¼ˆå¦‚ executeSmartAutoScoringï¼‰
   â†“
3. è°ƒç”¨åç«¯ API: recommend_structure_mode_v2
   â†“
4. åç«¯è¿”å›è¯„åˆ†ç»“æœ
   {
     outcomes: [
       { mode: 'CardSubtree', conf: 0.85, ... },
       { mode: 'LeafContext', conf: 0.78, ... }
     ]
   }
   â†“
5. å­˜å‚¨åˆ° analysis-state-store
   stepScores: {
     'card_subtree_scoring': { confidence: 0.85, ... },  // âœ… ä½¿ç”¨candidateKey
     'leaf_context_scoring': { confidence: 0.78, ... }   // âœ… ä½¿ç”¨candidateKey
   }
   â†“
6. èœå•æ˜¾ç¤ºæŸ¥è¯¢
   getStepConfidence('card_subtree_scoring')  // âœ… é”®åŒ¹é…æˆåŠŸ
   â†’ è¿”å› 0.85
   â†’ æ˜¾ç¤º "85%"
```

### ä¸‰ç§ç­–ç•¥æ¨¡å¼çš„ç»Ÿä¸€å¤„ç†

| ç­–ç•¥æ¨¡å¼ | è¯„åˆ†å‡½æ•° | å­˜å‚¨é”® | æŸ¥è¯¢é”® | çŠ¶æ€ |
|---------|---------|--------|--------|------|
| æ™ºèƒ½Â·è‡ªåŠ¨é“¾ | `executeSmartAutoScoring` | `card_subtree_scoring` | `card_subtree_scoring` | âœ… å·²ä¿®å¤ |
| æ™ºèƒ½Â·å•æ­¥ | `executeSmartSingleScoring` | `candidateKey` | `candidateKey` | âœ… å·²æ­£ç¡® |
| é™æ€ç­–ç•¥ | `executeStaticCardSubtreeScoring` | `candidateKey` | `candidateKey` | âœ… å·²æ­£ç¡® |

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. ç¼–è¯‘æ£€æŸ¥
```bash
npm run type-check
```
é¢„æœŸç»“æœï¼šâœ… æ— TypeScripté”™è¯¯

### 2. åŠŸèƒ½æµ‹è¯•
1. æ‰“å¼€é¡µé¢åˆ†æï¼ŒåŠ è½½XMLæ–‡ä»¶
2. ç‚¹é€‰å…ƒç´ ï¼Œç”Ÿæˆæ­¥éª¤å¡ç‰‡
3. ä¾æ¬¡æµ‹è¯•ä¸‰ç§ç­–ç•¥ï¼š
   - **æ™ºèƒ½Â·è‡ªåŠ¨é“¾**ï¼šç‚¹å‡»ååº”æ˜¾ç¤º Step1ã€Step2 è¯„åˆ†
   - **æ™ºèƒ½Â·å•æ­¥ â†’ Step1**ï¼šåº”æ˜¾ç¤ºçœŸå®è¯„åˆ†ç™¾åˆ†æ¯”
   - **é™æ€ç­–ç•¥ â†’ ç»“æ„åŒ¹é… â†’ å¡ç‰‡å­æ ‘è¯„åˆ†**ï¼šåº”æ˜¾ç¤ºçœŸå®è¯„åˆ†ç™¾åˆ†æ¯”

### 3. æ§åˆ¶å°éªŒè¯
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåº”çœ‹åˆ°ï¼š
```
âœ… [æ™ºèƒ½Â·è‡ªåŠ¨é“¾] Step1è¯„åˆ†å®Œæˆ: 85.0%
âœ… [æ™ºèƒ½Â·è‡ªåŠ¨é“¾] Step2è¯„åˆ†å®Œæˆ: 78.0%
ğŸ’¾ [æ™ºèƒ½Â·è‡ªåŠ¨é“¾] å·²å­˜å‚¨è¯„åˆ†åˆ° analysis-state-store
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
- è¯„åˆ†æ˜¾ç¤ºï¼š`undefined` æˆ–ä¸æ˜¾ç¤º
- æ§åˆ¶å°ï¼š`âš ï¸ [AnalysisState] æ— æ³•æŸ¥è¯¢åˆ°è¯„åˆ†`

### ä¿®å¤å
- è¯„åˆ†æ˜¾ç¤ºï¼š`85%` `78%`ï¼ˆçœŸå®åç«¯æ•°æ®ï¼‰
- æ§åˆ¶å°ï¼š`âœ… [æ™ºèƒ½Â·è‡ªåŠ¨é“¾] Step1è¯„åˆ†å®Œæˆ: 85.0%`

## ğŸ” ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/components/strategy-selector/scoring/smart-auto-scoring.ts` âœ…

### å·²éªŒè¯æ­£ç¡®çš„æ–‡ä»¶
- `src/components/strategy-selector/scoring/smart-single-scoring.ts` âœ…
- `src/components/strategy-selector/scoring/static-scoring.ts` âœ…

### æ”¯æŒåŸºç¡€è®¾æ–½
- `src/config/step-sequence.ts` - æ­¥éª¤åºå·æ˜ å°„
- `src/stores/step-score-store.ts` - è¯„åˆ†ç¼“å­˜å­˜å‚¨
- `src/stores/analysis-state-store.ts` - åˆ†æçŠ¶æ€ç®¡ç†
- `src/utils/step-scoring-validator.ts` - è¯„åˆ†æ•°æ®éªŒè¯

## âœ… ç»“è®º

ä¿®å¤å·²å®Œæˆï¼è¯„åˆ†æ•°æ®ç°åœ¨åº”è¯¥èƒ½æ­£ç¡®æ˜¾ç¤ºã€‚æ‰€æœ‰ä¸‰ç§ç­–ç•¥æ¨¡å¼ï¼ˆæ™ºèƒ½Â·è‡ªåŠ¨é“¾ã€æ™ºèƒ½Â·å•æ­¥ã€é™æ€ç­–ç•¥ï¼‰éƒ½ç»Ÿä¸€ä½¿ç”¨ `candidateKey` ä½œä¸ºå­˜å‚¨é”®ï¼Œç¡®ä¿èœå•æŸ¥è¯¢æ—¶èƒ½æ­£ç¡®åŒ¹é…ã€‚
