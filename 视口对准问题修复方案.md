# ğŸš¨ è§†å£å¯¹å‡†é—®é¢˜ - æ ¹å› åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸ“Š **é—®é¢˜ç°è±¡**

**ç”¨æˆ·åé¦ˆ**: "è§†å£è£å‰ªçœ‹åˆ°çš„åªæœ‰å››åˆ†ä¹‹ä¸€åœ¨è§†å£å†…"

**ç—‡çŠ¶åˆ†æ**:
- âœ… å›¾ç‰‡èƒ½å¤ŸåŠ è½½
- âŒ æ˜¾ç¤ºåŒºåŸŸä¸¥é‡åç§»ï¼Œåªçœ‹åˆ°ä¸€å°éƒ¨åˆ†
- âŒ è£å‰ªåŒºåŸŸå®šä½é”™è¯¯

---

## ğŸ” **æ ¹å› åˆ†æ**

### 1ï¸âƒ£ **å½“å‰å®šä½é€»è¾‘å­˜åœ¨ç¼ºé™·**

```typescript
// å½“å‰ aligned-image-display.tsx ä¸­çš„é—®é¢˜ä»£ç 
const imageDisplayStyle = {
  position: "absolute",
  left: -cropArea.x * imageDisplay.scale + imageDisplay.offset.x,  // â† é—®é¢˜æ‰€åœ¨
  top: -cropArea.y * imageDisplay.scale + imageDisplay.offset.y,   // â† é—®é¢˜æ‰€åœ¨
  width: imageNaturalSize.width * imageDisplay.scale,
  height: imageNaturalSize.height * imageDisplay.scale,
};
```

**é—®é¢˜åˆ†æ**:
- `cropArea.x = 0, cropArea.y = 1291` (element_43çš„è£å‰ªèµ·ç‚¹)
- `scale` é€šå¸¸ < 1 (ç¼©å°æ˜¾ç¤º)
- `left = -0 * 0.6 + offset = offset` âœ… æ°´å¹³æ­£å¸¸
- `top = -1291 * 0.6 + offset = -774 + offset` âŒ **ä¸¥é‡è´Ÿåç§»ï¼**

**ç»“æœ**: å›¾ç‰‡è¢«å‘ä¸Šæ¨ç§»774pxï¼Œå¯¼è‡´å¤§éƒ¨åˆ†å†…å®¹åœ¨è§†å£å¤–ï¼

### 2ï¸âƒ£ **æ•°æ®æµéªŒè¯**

ä»¥ element_43 ä¸ºä¾‹:
```typescript
// è¾“å…¥æ•°æ®
åŸå§‹å±å¹•å°ºå¯¸: 1080 Ã— 2400
ç”¨æˆ·ç‚¹å‡»åŒºåŸŸ: [13,1158][534,2023]
è®¡ç®—åè£å‰ªåŒºåŸŸ: [0,1291][554,1891]  // cropArea.y=1291 æ˜¯å…³é”®

// è®¡ç®—è¿‡ç¨‹
scale = 0.6 (å‡è®¾)
offset.x = 20, offset.y = 40 (å‡è®¾)

// é”™è¯¯çš„å®šä½è®¡ç®—
top = -1291 * 0.6 + 40 = -774.6 + 40 = -734.6px

// ç»“æœ: å›¾ç‰‡å‘ä¸Šåç§»734pxï¼Œåªæœ‰åº•éƒ¨è¾¹ç¼˜å¯è§ï¼
```

---

## ğŸ› ï¸ **ä¿®å¤æ–¹æ¡ˆ**

### æ–¹æ¡ˆA: **ä¿®æ­£å®šä½é€»è¾‘** (æ¨è)

```typescript
// ä¿®å¤åçš„å›¾ç‰‡å®šä½è®¡ç®—
const imageDisplayStyle = useMemo((): React.CSSProperties => {
  if (!imageLoaded || !cropConfig || !viewportAlignment) {
    return { display: "none" };
  }

  const { cropArea } = cropConfig;
  const { imageDisplay } = viewportAlignment;

  // ğŸ”§ ä¿®å¤: ä½¿ç”¨CSS transformè€Œä¸æ˜¯è´Ÿå€¼å®šä½
  return {
    position: "absolute" as const,
    left: imageDisplay.offset.x,                    // â† ç®€åŒ–: åªä½¿ç”¨offset
    top: imageDisplay.offset.y,                     // â† ç®€åŒ–: åªä½¿ç”¨offset
    width: imageNaturalSize.width * imageDisplay.scale,
    height: imageNaturalSize.height * imageDisplay.scale,
    transform: `translate(-${cropArea.x * imageDisplay.scale}px, -${cropArea.y * imageDisplay.scale}px)`, // â† æ–°å¢: ç”¨transformå¤„ç†è£å‰ªåç§»
    transformOrigin: "0 0",                         // â† æ–°å¢: å˜æ¢åŸç‚¹
    maxWidth: "none",
    maxHeight: "none",
  };
}, [imageLoaded, cropConfig, viewportAlignment, imageNaturalSize]);
```

**ä¿®å¤åŸç†**:
1. `left/top` åªè´Ÿè´£å®¹å™¨å†…çš„å±…ä¸­å¯¹é½ (offset)
2. `transform: translate()` è´Ÿè´£è£å‰ªåŒºåŸŸçš„ç²¾ç¡®å®šä½
3. åˆ†ç¦»å…³æ³¨ç‚¹ï¼Œé¿å…å¤æ‚çš„è´Ÿå€¼è®¡ç®—

### æ–¹æ¡ˆB: **æ•°æ®éªŒè¯å¢å¼º**

```typescript
// åœ¨ precise-crop-calculator.ts ä¸­å¢åŠ è¾¹ç•Œæ£€æŸ¥
export function calculatePreciseCrop(elementTreeData, options) {
  // ... ç°æœ‰é€»è¾‘ ...
  
  // ğŸ”§ æ–°å¢: è¾¹ç•ŒéªŒè¯
  const screenSize = { width: 1080, height: 2400 }; // ä»XMLè·å–
  
  // ç¡®ä¿è£å‰ªåŒºåŸŸä¸è¶…å‡ºå±å¹•èŒƒå›´
  minX = Math.max(0, Math.min(minX, screenSize.width - cropWidth));
  minY = Math.max(0, Math.min(minY, screenSize.height - cropHeight));
  
  // ç¡®ä¿è£å‰ªåŒºåŸŸæœ‰æ•ˆ
  if (minX + cropWidth > screenSize.width) {
    cropWidth = screenSize.width - minX;
  }
  if (minY + cropHeight > screenSize.height) {
    cropHeight = screenSize.height - minY;
  }
  
  console.log("ğŸ” [è¾¹ç•Œæ£€æŸ¥]", {
    è£å‰ªåŒºåŸŸ: `[${minX},${minY}][${minX + cropWidth},${minY + cropHeight}]`,
    å±å¹•èŒƒå›´: `[0,0][${screenSize.width},${screenSize.height}]`,
    æ˜¯å¦è¶Šç•Œ: minX + cropWidth > screenSize.width || minY + cropHeight > screenSize.height
  });
  
  // ... è¿”å›ç»“æœ ...
}
```

### æ–¹æ¡ˆC: **è°ƒè¯•å¯è§†åŒ–å¢å¼º**

```typescript
// åœ¨ AlignedImageDisplay ç»„ä»¶ä¸­å¢åŠ è°ƒè¯•è¾¹æ¡†
const debugStyles = process.env.NODE_ENV === 'development' ? {
  // å®¹å™¨è°ƒè¯•è¾¹æ¡†
  containerDebug: {
    border: "2px dashed red",
    boxShadow: "inset 0 0 10px rgba(255,0,0,0.2)"
  },
  
  // å›¾ç‰‡è°ƒè¯•è¾¹æ¡†  
  imageDebug: {
    border: "2px solid blue",
    boxShadow: "0 0 10px rgba(0,0,255,0.3)"
  }
} : {};

return (
  <div style={{...containerStyle, ...debugStyles.containerDebug}}>
    <img 
      style={{...imageDisplayStyle, ...debugStyles.imageDebug}} 
      // ... other props
    />
    
    {/* è°ƒè¯•ä¿¡æ¯é¢æ¿ */}
    {process.env.NODE_ENV === 'development' && (
      <div style={{
        position: "absolute", top: 0, right: 0,
        backgroundColor: "rgba(0,0,0,0.8)", color: "white",
        padding: "8px", fontSize: "11px", fontFamily: "monospace"
      }}>
        <div>è£å‰ª: [{cropArea.x},{cropArea.y}] {cropArea.width}Ã—{cropArea.height}</div>
        <div>ç¼©æ”¾: {Math.round(imageDisplay.scale * 100)}%</div>
        <div>åç§»: x={imageDisplay.offset.x}, y={imageDisplay.offset.y}</div>
        <div>å›¾ç‰‡: {imageNaturalSize.width}Ã—{imageNaturalSize.height}</div>
        <div>è®¡ç®—ä½ç½®: left={-cropArea.x * imageDisplay.scale + imageDisplay.offset.x}</div>
        <div>è®¡ç®—ä½ç½®: top={-cropArea.y * imageDisplay.scale + imageDisplay.offset.y}</div>
      </div>
    )}
  </div>
);
```

---

## âš¡ **å¿«é€Ÿä¿®å¤æ­¥éª¤**

### 1. **ç«‹å³åº”ç”¨æ–¹æ¡ˆA**
```bash
# ç¼–è¾‘ aligned-image-display.tsx
# æ›¿æ¢ imageDisplayStyle çš„è®¡ç®—é€»è¾‘
```

### 2. **éªŒè¯ä¿®å¤æ•ˆæœ**
```typescript
// æµ‹è¯•æ•°æ® (element_43)
cropArea: { x: 0, y: 1291, width: 554, height: 600 }
scale: 0.6
offset: { x: 20, y: 40 }

// ä¿®å¤å‰ (é”™è¯¯)
top: -1291 * 0.6 + 40 = -734.6px  â† å›¾ç‰‡åœ¨è§†å£å¤–

// ä¿®å¤å (æ­£ç¡®)  
top: 40px                         â† å›¾ç‰‡åœ¨è§†å£å†…
transform: translate(0, -774.6px) â† ç²¾ç¡®è£å‰ªåç§»
```

### 3. **ç¡®è®¤å…³é”®æŒ‡æ ‡**
- âœ… å›¾ç‰‡å®Œå…¨åœ¨å®¹å™¨å†…æ˜¾ç¤º
- âœ… è£å‰ªåŒºåŸŸç²¾ç¡®å¯¹å‡†element_43
- âœ… æ²¡æœ‰ä¸å¿…è¦çš„ç©ºç™½åŒºåŸŸ
- âœ… å…ƒç´ è¾¹æ¡†æ­£ç¡®è¦†ç›–åœ¨å¯¹åº”ä½ç½®

---

## ğŸ¯ **é¢„æœŸä¿®å¤æ•ˆæœ**

**ä¿®å¤å‰**:
```
æ‚¬æµ®çª—å£è§†å£ (554Ã—600):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ (å¤§éƒ¨åˆ†åŒºåŸŸç©ºç™½)         â”‚ 
â”‚                         â”‚ 
â”‚                         â”‚ 
â”‚                         â”‚ 
â”‚ â–ˆâ–ˆâ–ˆâ–ˆ â† åªçœ‹åˆ°å›¾ç‰‡ä¸€è§’    â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
```

**ä¿®å¤å**:
```
æ‚¬æµ®çª—å£è§†å£ (554Ã—600):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚ ğŸ“· ç¬”è®°å›¾ç‰‡ (ä¸‹åŠéƒ¨åˆ†)   â”‚ âœ… å®Œæ•´æ˜¾ç¤º
â”‚ "æ·±åœ³ä¹Ÿå¤ªç‰›äº†ï¼Œå–æ¶ˆäº†ï¼" â”‚ âœ… æ–‡å­—æ¸…æ™°
â”‚ ï½ï½ï½ æ¸å˜è£…é¥°æ¡ ï½ï½ï½  â”‚ âœ… è£…é¥°å¯è§
â”‚ ğŸ‘¤ å°ä½•è€å¸ˆ    â¤ï¸ 55    â”‚ âœ… ä¿¡æ¯å®Œæ•´
â”‚ [ç»¿è‰²è¾¹æ¡†æ ‡ç¤ºå…ƒç´ è¾¹ç•Œ]   â”‚ âœ… è¾¹æ¡†å¯¹é½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
```

ç«‹å³åº”ç”¨**æ–¹æ¡ˆA**å°±èƒ½è§£å†³é—®é¢˜ï¼ğŸš€