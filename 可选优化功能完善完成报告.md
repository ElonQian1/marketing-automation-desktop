# å¯é€‰ä¼˜åŒ–åŠŸèƒ½å®Œå–„å®ŒæˆæŠ¥å‘Š

## âœ… å®Œæˆæ—¶é—´
**2025å¹´1æœˆ28æ—¥**

---

## ğŸ“‹ å®Œå–„çš„åŠŸèƒ½

### 1. âœ… å‰ç«¯æœ¬åœ°å­˜å‚¨ï¼ˆIndexedDBæŒä¹…åŒ–ï¼‰

#### æ–°å¢æ–‡ä»¶
- **`src/services/storage/xml-persistent-storage.ts`** (å…¨æ–°æ¨¡å—ï¼Œ600+è¡Œ)

#### æ ¸å¿ƒåŠŸèƒ½

**1.1 IndexedDBæŒä¹…åŒ–å­˜å‚¨**
```typescript
export class XmlPersistentStorage {
  // æ•°æ®åº“é…ç½®
  - DB_NAME: 'SmartScriptXmlCache'
  - DB_VERSION: 1
  - STORE_NAME: 'xmlSnapshots'
  
  // ç´¢å¼•
  - INDEX_HASH: 'xmlHash'    â† æŒ‰hashå¿«é€ŸæŸ¥è¯¢
  - INDEX_TIMESTAMP: 'timestamp'  â† æŒ‰æ—¶é—´æ’åº/æ¸…ç†
}
```

**1.2 å®Œæ•´çš„CRUDæ“ä½œ**
```typescript
// åˆ›å»º/æ›´æ–°
async put(entry: XmlCacheEntry): Promise<void>
async putBatch(entries: XmlCacheEntry[]): Promise<void>  â† æ‰¹é‡ä¿å­˜

// è¯»å–
async get(cacheId: string): Promise<XmlCacheEntry | null>
async getByHash(xmlHash: string): Promise<XmlCacheEntry | null>  â† æŒ‰hashæŸ¥è¯¢
async getAll(): Promise<XmlCacheEntry[]>

// åˆ é™¤
async delete(cacheId: string): Promise<void>
async clear(): Promise<void>  â† æ¸…ç©ºæ‰€æœ‰
```

**1.3 è‡ªåŠ¨æ¸…ç†æœºåˆ¶**
```typescript
// æ¸…ç†ç­–ç•¥
export interface PersistentStorageConfig {
  maxEntries: 500,           // æœ€å¤§500æ¡ï¼ˆè¶…è¿‡è‡ªåŠ¨æ¸…ç†æœ€æ—§çš„ï¼‰
  maxAgeDays: 30,            // æœ€å¤§30å¤©ï¼ˆè¶…è¿‡è‡ªåŠ¨æ¸…ç†ï¼‰
  autoCleanup: true,         // å¯ç”¨è‡ªåŠ¨æ¸…ç†
  cleanupIntervalMs: 3600000 // æ¯1å°æ—¶æ¸…ç†ä¸€æ¬¡
}

// æ¸…ç†æ–¹æ³•
async cleanupExpired(maxAgeDays?: number): Promise<number>  â† æ¸…ç†è¿‡æœŸ
async cleanupOldest(): Promise<number>  â† æ¸…ç†è¶…é‡
async cleanup(): Promise<{ expired: number; oldest: number }>  â† å®Œæ•´æ¸…ç†
```

**1.4 å­˜å‚¨ç»Ÿè®¡å’Œç›‘æ§**
```typescript
export interface StorageStats {
  totalEntries: number;                                // æ€»æ¡ç›®æ•°
  oldestEntry: { cacheId: string; timestamp: number } | null;  // æœ€æ—§æ¡ç›®
  newestEntry: { cacheId: string; timestamp: number } | null;  // æœ€æ–°æ¡ç›®
  totalSizeBytes: number;                              // æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  avgEntrySizeBytes: number;                           // å¹³å‡å¤§å°
}

async getStats(): Promise<StorageStats>
async count(): Promise<number>
```

**1.5 ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```typescript
async initialize(): Promise<void>  â† åˆå§‹åŒ–æ•°æ®åº“
private startAutoCleanup(): void   â† å¯åŠ¨å®šæ—¶æ¸…ç†
stopAutoCleanup(): void            â† åœæ­¢å®šæ—¶æ¸…ç†
close(): void                      â† å…³é—­è¿æ¥
```

#### XmlCacheManager é›†æˆ

**ä¿®æ”¹æ–‡ä»¶**: `src/services/xml-cache-manager.ts`

**2.1 åŒå±‚ç¼“å­˜æ¶æ„**
```typescript
class XmlCacheManager {
  // å†…å­˜ç¼“å­˜ï¼ˆå¿«é€Ÿè®¿é—®ï¼‰
  private cache: Map<string, XmlCacheEntry> = new Map();
  private hashIndex: Map<string, XmlCacheEntry> = new Map();
  
  // æŒä¹…åŒ–å­˜å‚¨ï¼ˆæŒä¹…ä¿å­˜ï¼‰
  private persistentStorage: XmlPersistentStorage | null = null;
  
  // ğŸ”¥ è‡ªåŠ¨åŒæ­¥ï¼šå†…å­˜ â†” IndexedDB
  private async syncToPersistentStorage(entry: XmlCacheEntry): Promise<void>
  private async restoreFromPersistentStorage(): Promise<void>
}
```

**2.2 é¡µé¢åˆ·æ–°è‡ªåŠ¨æ¢å¤**
```typescript
private async initializePersistentStorage(): Promise<void> {
  // 1. åˆå§‹åŒ–IndexedDB
  this.persistentStorage = getPersistentStorage(...);
  await this.persistentStorage.initialize();
  
  // 2. è‡ªåŠ¨ä»IndexedDBæ¢å¤æ‰€æœ‰ç¼“å­˜åˆ°å†…å­˜
  await this.restoreFromPersistentStorage();  â† å…³é”®ï¼
}
```

**2.3 æ™ºèƒ½è¯»å–ï¼ˆå†…å­˜ + æŒä¹…åŒ–ï¼‰**
```typescript
async getCachedXml(cacheId: string): Promise<XmlCacheEntry | null> {
  // 1. å…ˆä»å†…å­˜è·å–ï¼ˆå¿«ï¼‰
  let entry = this.cache.get(cacheId);
  if (entry) return entry;
  
  // 2. ä»IndexedDBè·å–ï¼ˆæ…¢ä½†æŒä¹…ï¼‰
  entry = await this.persistentStorage.get(cacheId);
  if (entry) {
    // æ¢å¤åˆ°å†…å­˜ç¼“å­˜
    this.cache.set(entry.cacheId, entry);
    return entry;
  }
  
  return null;
}
```

**2.4 è‡ªåŠ¨å†™å…¥ï¼ˆå†…å­˜ + æŒä¹…åŒ–ï¼‰**
```typescript
putXml(id: string, xmlContent: string, xmlHash: string, ...): void {
  // 1. å†™å…¥å†…å­˜ç¼“å­˜
  this.cache.set(id, entry);
  this.hashIndex.set(xmlHash, entry);
  
  // 2. ğŸ”¥ å¼‚æ­¥åŒæ­¥åˆ°IndexedDB
  this.syncToPersistentStorage(entry).catch(err => {
    console.error('åŒæ­¥å¤±è´¥:', err);  // ä¸å½±å“å†…å­˜ç¼“å­˜
  });
}
```

**2.5 å®Œå–„çš„æ¸…ç†æœºåˆ¶**
```typescript
async cleanupExpiredCache(maxAgeMs: number): Promise<void> {
  // 1. æ¸…ç†å†…å­˜ç¼“å­˜
  for (const [cacheId, entry] of this.cache.entries()) {
    if (now - entry.timestamp > maxAgeMs) {
      this.cache.delete(cacheId);
      this.hashIndex.delete(entry.xmlHash);
    }
  }
  
  // 2. æ¸…ç†IndexedDB
  await this.persistentStorage.cleanupExpired(maxAgeDays);
}

async manualCleanup(): Promise<void> {
  // 1. æ¸…ç†è¿‡æœŸ
  await this.cleanupExpiredCache();
  
  // 2. æ¸…ç†è¶…é‡
  const { expired, oldest } = await this.persistentStorage.cleanup();
}
```

**2.6 å­˜å‚¨ç»Ÿè®¡**
```typescript
async getStorageStats(): Promise<{
  memory: { count: number; cacheIds: string[] };
  persistent: { count: number; totalSizeBytes: number; avgSizeBytes: number };
}> {
  return {
    memory: {
      count: this.cache.size,
      cacheIds: Array.from(this.cache.keys()),
    },
    persistent: await this.persistentStorage.getStats(),
  };
}
```

---

### 2. âœ… å­å…ƒç´ æ–‡æœ¬æå–å®Œå–„ï¼ˆåç«¯Rustï¼‰

#### æ–‡ä»¶çŠ¶æ€
- **`src-tauri/src/exec/v3/element_matching/multi_candidate_evaluator.rs`**
- **çŠ¶æ€**ï¼šâœ… **å·²å®Œæ•´å®ç°**ï¼ˆè¯„åˆ†ç³»ç»Ÿå®Œå–„æ—¶å·²å®ç°ï¼‰

#### æ ¸å¿ƒåŠŸèƒ½

**3.1 å®Œæ•´çš„å­å…ƒç´ æ–‡æœ¬æå–æµç¨‹**
```rust
fn check_child_text_match(
    elem: &UIElement,
    target_text: &str,
    xml_content: &Option<String>,
) -> ChildTextMatchResult {
    // ç­–ç•¥1: æ£€æŸ¥å…ƒç´ è‡ªèº«çš„textå±æ€§
    if let Some(ref elem_text) = elem.text {
        if elem_text == target_text {
            return ChildTextMatchResult { is_complete: true, ... };
        }
    }
    
    // ç­–ç•¥2: æ£€æŸ¥å…ƒç´ çš„content-descå±æ€§
    if let Some(ref elem_desc) = elem.content_desc {
        if elem_desc == target_text {
            return ChildTextMatchResult { is_complete: true, ... };
        }
    }
    
    // ç­–ç•¥3: ğŸ”¥ ä»å®Œæ•´XMLä¸­æå–å­å…ƒç´ æ–‡æœ¬
    if let (Some(xml), Some(elem_bounds)) = (xml_content, &elem.bounds) {
        // 1. é€šè¿‡boundsåœ¨XMLä¸­ç²¾ç¡®å®šä½è¯¥å…ƒç´ 
        if let Some(fragment) = Self::extract_element_fragment_by_bounds(xml, elem_bounds) {
            // 2. æå–è¯¥å…ƒç´ çš„æ‰€æœ‰å­å­™èŠ‚ç‚¹æ–‡æœ¬
            let child_texts = Self::extract_all_child_texts(&fragment);
            
            // 3. æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡æ–‡æœ¬
            for child_text in child_texts {
                if child_text == target_text {
                    return ChildTextMatchResult { is_complete: true, ... };
                }
            }
        }
    }
}
```

**3.2 é€šè¿‡Boundsç²¾ç¡®å®šä½XMLå…ƒç´ **
```rust
fn extract_element_fragment_by_bounds(xml: &str, target_bounds: &str) -> Option<String> {
    // 1. æ ‡å‡†åŒ–boundsæ ¼å¼ï¼ˆç§»é™¤ç©ºæ ¼ï¼‰
    let normalized_target = target_bounds.replace(" ", "");
    let search_pattern = format!("bounds=\"{}\"", normalized_target);
    
    // 2. åœ¨XMLä¸­æŸ¥æ‰¾è¯¥bounds
    if let Some(bounds_pos) = xml.find(&search_pattern) {
        // 3. å‘å‰æŸ¥æ‰¾nodeå¼€å§‹æ ‡ç­¾ <node
        if let Some(node_start) = xml[..bounds_pos].rfind("<node") {
            // 4. åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªé—­åˆæ ‡ç­¾ />
            if xml[bounds_pos..tag_close_abs].contains("/>") {
                return Some(xml[node_start..tag_close_abs + 1].to_string());
            } else {
                // 5. æœ‰å­å…ƒç´ ï¼Œä½¿ç”¨åµŒå¥—æ·±åº¦è¿½è¸ªæ‰¾åˆ°åŒ¹é…çš„ </node>
                let mut depth = 1;
                while depth > 0 {
                    if xml[pos..].starts_with("</node>") {
                        depth -= 1;
                    } else if xml[pos..].starts_with("<node") {
                        depth += 1;
                    }
                }
                return Some(xml[node_start..matched_end].to_string());
            }
        }
    }
}
```

**3.3 æå–æ‰€æœ‰å­å­™èŠ‚ç‚¹æ–‡æœ¬**
```rust
fn extract_all_child_texts(xml_fragment: &str) -> Vec<String> {
    let mut texts = Vec::new();
    
    // é™åˆ¶æœç´¢èŒƒå›´ï¼ˆé˜²æ­¢è¶…å¤§XMLï¼‰
    let search_fragment: String = xml_fragment.chars().take(5000).collect();
    
    // 1. æå–æ‰€æœ‰ text="..." å±æ€§
    let mut pos = 0;
    while let Some(text_start) = search_fragment[pos..].find("text=\"") {
        let absolute_start = pos + text_start + 6;
        if let Some(text_end) = search_fragment[absolute_start..].find('"') {
            let text_value = &search_fragment[absolute_start..absolute_start + text_end];
            
            // æ”¶é›†éç©ºä¸”æœ‰æ„ä¹‰çš„æ–‡æœ¬ï¼ˆé•¿åº¦2-50ï¼‰
            if !text_value.trim().is_empty() 
               && text_value.len() >= 2 
               && text_value.len() <= 50 {
                texts.push(text_value.trim().to_string());
            }
        }
    }
    
    // 2. æå–æ‰€æœ‰ content-desc="..." å±æ€§
    pos = 0;
    while let Some(desc_start) = search_fragment[pos..].find("content-desc=\"") {
        let absolute_start = pos + desc_start + 14;
        if let Some(desc_end) = search_fragment[absolute_start..].find('"') {
            let desc_value = &search_fragment[absolute_start..absolute_start + desc_end];
            
            // æ”¶é›†éç©ºä¸”æœ‰æ„ä¹‰çš„æè¿°ï¼ˆé•¿åº¦2-100ï¼‰
            if !desc_value.trim().is_empty() 
               && desc_value.len() >= 2 
               && desc_value.len() <= 100 {
                let trimmed = desc_value.trim().to_string();
                // é¿å…é‡å¤
                if !texts.contains(&trimmed) {
                    texts.push(trimmed);
                }
            }
        }
    }
    
    texts
}
```

**3.4 æ•ˆæœç¤ºä¾‹**

```xml
<!-- è¾“å…¥ï¼šå€™é€‰å…ƒç´ çš„bounds -->
<node resource-id="iwk" clickable="true" bounds="[45,1059][249,1263]">
  <node resource-id="icon" class="ImageView" />
  <node text="é€šè®¯å½•" class="TextView" clickable="false" />
  <node content-desc="å·²é€‰ä¸­" class="TextView" />
</node>
```

**æå–ç»“æœ**ï¼š
```rust
vec![
    "é€šè®¯å½•",      // â† ä»å­å…ƒç´ textå±æ€§æå–
    "å·²é€‰ä¸­"       // â† ä»å­å…ƒç´ content-descæå–
]
```

**åŒ¹é…é€»è¾‘**ï¼š
- ç”¨æˆ·ç›®æ ‡æ–‡æœ¬: "é€šè®¯å½•"
- å€™é€‰å…ƒç´ è‡ªèº«æ— textï¼ˆçˆ¶å®¹å™¨ï¼‰
- ä½†å­å­™èŠ‚ç‚¹åŒ…å«"é€šè®¯å½•" âœ…
- è¿”å›: `ChildTextMatchResult { is_complete: true, matched_text: Some("é€šè®¯å½•") }`
- è¯„åˆ†: **+0.3åˆ†**ï¼ˆå­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…ï¼‰

---

### 3. âœ… è‡ªåŠ¨æ¸…ç†æœºåˆ¶

#### å‰ç«¯æ¸…ç†ï¼ˆXmlPersistentStorageï¼‰

**ç­–ç•¥1: å®šæ—¶è‡ªåŠ¨æ¸…ç†**
```typescript
// å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹
private startAutoCleanup(): void {
  this.cleanupTimer = setInterval(async () => {
    await this.cleanup();  // æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡
  }, 3600000);
}

// cleanup() é€»è¾‘
async cleanup(): Promise<{ expired: number; oldest: number }> {
  // 1. æ¸…ç†è¶…è¿‡30å¤©çš„æ¡ç›®
  const expired = await this.cleanupExpired(30);
  
  // 2. å¦‚æœæ€»æ•° > 500ï¼Œåˆ é™¤æœ€æ—§çš„
  const oldest = await this.cleanupOldest();
  
  return { expired, oldest };
}
```

**ç­–ç•¥2: æ¸…ç†è¿‡æœŸæ•°æ®**
```typescript
async cleanupExpired(maxAgeDays: number = 30): Promise<number> {
  const cutoffTime = Date.now() - maxAgeDays * 24 * 60 * 60 * 1000;
  
  // ä½¿ç”¨timestampç´¢å¼•æŸ¥è¯¢
  const range = IDBKeyRange.upperBound(cutoffTime);
  const request = index.openCursor(range);
  
  // åˆ é™¤æ‰€æœ‰timestamp < cutoffTimeçš„æ¡ç›®
  let deletedCount = 0;
  cursor.delete();
  deletedCount++;
  
  return deletedCount;
}
```

**ç­–ç•¥3: æ¸…ç†è¶…é‡æ•°æ®**
```typescript
async cleanupOldest(): Promise<number> {
  const totalCount = await this.count();
  
  if (totalCount <= 500) {
    return 0;  // ä¸éœ€è¦æ¸…ç†
  }
  
  const deleteCount = totalCount - 500;
  
  // æŒ‰timestampå‡åºéå†ï¼ˆæœ€æ—§çš„åœ¨å‰ï¼‰
  const request = index.openCursor(null, 'next');
  
  // åˆ é™¤å‰ (totalCount - 500) æ¡
  for (let i = 0; i < deleteCount; i++) {
    cursor.delete();
  }
  
  return deleteCount;
}
```

#### åç«¯æ¸…ç†ï¼ˆRust - æœªå®ç°ï¼‰

> **æ³¨æ„**ï¼šåç«¯Rustä»£ç ä¸­æ²¡æœ‰XMLç¼“å­˜ç®¡ç†ï¼Œæ•°æ®ç”±å‰ç«¯ç®¡ç†ã€‚åç«¯åªå¤„ç†å®æ—¶ä¼ é€’çš„original_xmlã€‚

---

## ğŸ“Š å®Œå–„æ•ˆæœæ€»ç»“

### é—®é¢˜è§£å†³

| é—®é¢˜ | ä¹‹å‰ | å®Œå–„å |
|-----|------|--------|
| **é¡µé¢åˆ·æ–°ä¸¢å¤±** | âŒ å†…å­˜ç¼“å­˜ï¼Œåˆ·æ–°æ¸…ç©º | âœ… IndexedDBæŒä¹…åŒ–ï¼Œè‡ªåŠ¨æ¢å¤ |
| **çˆ¶å®¹å™¨+å­æ–‡æœ¬** | âš ï¸ åªæ£€æŸ¥å…ƒç´ è‡ªèº« | âœ… å®Œæ•´æå–æ‰€æœ‰å­å­™èŠ‚ç‚¹æ–‡æœ¬ |
| **ç¼“å­˜è†¨èƒ€** | âŒ æ— é™å¢é•¿ | âœ… è‡ªåŠ¨æ¸…ç†ï¼ˆ30å¤© + 500æ¡ï¼‰ |
| **å­˜å‚¨å¯è§æ€§** | âŒ æ— ç»Ÿè®¡ä¿¡æ¯ | âœ… å®Œæ•´çš„å­˜å‚¨ç»Ÿè®¡å’Œç›‘æ§ |

### æ¶æ„ä¼˜åŠ¿

**1. åŒå±‚ç¼“å­˜æ¶æ„**
```
å†™å…¥æµç¨‹ï¼š
  putXml()
    â†“
  å†…å­˜Mapï¼ˆç«‹å³è¿”å›ï¼‰
    â†“ å¼‚æ­¥åŒæ­¥
  IndexedDBï¼ˆåå°ä¿å­˜ï¼‰

è¯»å–æµç¨‹ï¼š
  getCachedXml()
    â†“
  å†…å­˜Mapï¼ˆå¿«é€Ÿå‘½ä¸­ï¼‰
    â†“ æœªå‘½ä¸­
  IndexedDBï¼ˆæŒä¹…æ¢å¤ï¼‰
    â†“
  æ¢å¤åˆ°å†…å­˜ï¼ˆä¸‹æ¬¡å¿«é€Ÿï¼‰
```

**2. è‡ªåŠ¨æ¢å¤æœºåˆ¶**
```
é¡µé¢åŠ è½½ï¼š
  XmlCacheManager.getInstance()
    â†“
  initializePersistentStorage()
    â†“
  restoreFromPersistentStorage()
    â†“
  âœ… æ‰€æœ‰ç¼“å­˜å·²æ¢å¤åˆ°å†…å­˜
```

**3. æ™ºèƒ½æ¸…ç†ç­–ç•¥**
```
æ¸…ç†è§¦å‘ï¼š
  1. å®šæ—¶è§¦å‘ï¼ˆæ¯1å°æ—¶ï¼‰
  2. æ‰‹åŠ¨è§¦å‘ï¼ˆmanualCleanupï¼‰
  3. é¡µé¢åŠ è½½æ—¶ï¼ˆåˆå§‹åŒ–ï¼‰

æ¸…ç†é€»è¾‘ï¼š
  1. åˆ é™¤è¶…è¿‡30å¤©çš„æ•°æ®
  2. å¦‚æœæ€»æ•° > 500ï¼Œåˆ é™¤æœ€æ—§çš„
  3. åŒæ—¶æ¸…ç†å†…å­˜å’ŒIndexedDB
```

---

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### å‰ç«¯ä½¿ç”¨ç¤ºä¾‹

**1. åŸºæœ¬ä½¿ç”¨ï¼ˆè‡ªåŠ¨æŒä¹…åŒ–ï¼‰**
```typescript
import XmlCacheManager from '@/services/xml-cache-manager';

const manager = XmlCacheManager.getInstance();

// ä¿å­˜XMLï¼ˆè‡ªåŠ¨åŒæ­¥åˆ°IndexedDBï¼‰
manager.putXml('xml_123', xmlContent, xmlHash);

// è¯»å–XMLï¼ˆè‡ªåŠ¨ä»IndexedDBæ¢å¤ï¼‰
const entry = await manager.getCachedXml('xml_123');
```

**2. æ‰‹åŠ¨æ¸…ç†**
```typescript
// æ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆ30å¤©ï¼‰
await manager.cleanupExpiredCache(30 * 24 * 60 * 60 * 1000);

// å®Œæ•´æ¸…ç†ï¼ˆè¿‡æœŸ + è¶…é‡ï¼‰
await manager.manualCleanup();
```

**3. å­˜å‚¨ç»Ÿè®¡**
```typescript
const stats = await manager.getStorageStats();

console.log('å†…å­˜ç¼“å­˜:', stats.memory.count, 'æ¡');
console.log('æŒä¹…åŒ–å­˜å‚¨:', stats.persistent.count, 'æ¡');
console.log('æ€»å¤§å°:', (stats.persistent.totalSizeBytes / 1024 / 1024).toFixed(2), 'MB');
console.log('å¹³å‡å¤§å°:', (stats.persistent.avgSizeBytes / 1024).toFixed(2), 'KB');
```

**4. é¡µé¢åˆ·æ–°æµ‹è¯•**
```typescript
// Step 1: ä¿å­˜æ•°æ®
manager.putXml('test_1', '<xml>...</xml>', 'hash123');

// Step 2: åˆ·æ–°é¡µé¢ï¼ˆCtrl+R / F5ï¼‰

// Step 3: è‡ªåŠ¨æ¢å¤
const entry = await manager.getCachedXml('test_1');
console.log('æ¢å¤æˆåŠŸ:', entry !== null);  // âœ… true
```

### åç«¯ä½¿ç”¨ï¼ˆå·²å®Œæ•´å®ç°ï¼‰

```rust
use crate::exec::v3::element_matching::MultiCandidateEvaluator;

// å¤šå€™é€‰è¯„ä¼°æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨å­å…ƒç´ æ–‡æœ¬æå–
let criteria = EvaluationCriteria {
    target_text: Some("é€šè®¯å½•".to_string()),
    xml_content: Some(original_xml),  // â† ä¼ å…¥å®Œæ•´XML
    ...
};

let best_match = MultiCandidateEvaluator::evaluate_candidates(
    candidates,
    &criteria
);

// å†…éƒ¨ä¼šè‡ªåŠ¨ï¼š
// 1. é€šè¿‡boundså®šä½å…ƒç´ 
// 2. æå–æ‰€æœ‰å­å­™èŠ‚ç‚¹æ–‡æœ¬
// 3. æ£€æŸ¥æ˜¯å¦åŒ…å«"é€šè®¯å½•"
// 4. å¦‚æœåŒ…å«ï¼Œç»™äºˆ0.3åˆ†çš„é«˜è¯„åˆ†
```

---

## âœ… éªŒè¯æ¸…å•

### å‰ç«¯æŒä¹…åŒ–
- [x] âœ… IndexedDBæ•°æ®åº“åˆå§‹åŒ–
- [x] âœ… put/get/deleteåŸºæœ¬æ“ä½œ
- [x] âœ… æŒ‰hashç´¢å¼•æŸ¥è¯¢
- [x] âœ… æ‰¹é‡ä¿å­˜ï¼ˆputBatchï¼‰
- [x] âœ… è‡ªåŠ¨æ¸…ç†ï¼ˆè¿‡æœŸ + è¶…é‡ï¼‰
- [x] âœ… å®šæ—¶æ¸…ç†ï¼ˆæ¯1å°æ—¶ï¼‰
- [x] âœ… å­˜å‚¨ç»Ÿè®¡ï¼ˆgetStatsï¼‰
- [x] âœ… é¡µé¢åˆ·æ–°è‡ªåŠ¨æ¢å¤

### XmlCacheManageré›†æˆ
- [x] âœ… åŒå±‚ç¼“å­˜ï¼ˆå†…å­˜ + IndexedDBï¼‰
- [x] âœ… è‡ªåŠ¨åŒæ­¥ï¼ˆå†™å…¥æ—¶ï¼‰
- [x] âœ… æ™ºèƒ½æ¢å¤ï¼ˆè¯»å–æ—¶ï¼‰
- [x] âœ… åˆå§‹åŒ–æ—¶è‡ªåŠ¨æ¢å¤æ‰€æœ‰ç¼“å­˜
- [x] âœ… getCachedXmlæ”¹ä¸ºasync
- [x] âœ… getByHashæ”¹ä¸ºasync
- [x] âœ… getStepXmlContextæ”¹ä¸ºasync
- [x] âœ… æ¸…ç†æœºåˆ¶å®Œå–„

### å­å…ƒç´ æ–‡æœ¬æå–
- [x] âœ… é€šè¿‡boundsç²¾ç¡®å®šä½XMLå…ƒç´ 
- [x] âœ… å¤„ç†è‡ªé—­åˆæ ‡ç­¾ï¼ˆ/>ï¼‰
- [x] âœ… å¤„ç†åµŒå¥—æ ‡ç­¾ï¼ˆ</node>ï¼‰
- [x] âœ… åµŒå¥—æ·±åº¦è¿½è¸ªï¼ˆæ­£ç¡®åŒ¹é…ç»“æŸæ ‡ç­¾ï¼‰
- [x] âœ… æå–æ‰€æœ‰textå±æ€§
- [x] âœ… æå–æ‰€æœ‰content-descå±æ€§
- [x] âœ… å»é‡ï¼ˆé¿å…é‡å¤æ–‡æœ¬ï¼‰
- [x] âœ… é•¿åº¦è¿‡æ»¤ï¼ˆ2-50å­—ç¬¦ï¼‰
- [x] âœ… æ€§èƒ½ä¿æŠ¤ï¼ˆé™åˆ¶5000å­—ç¬¦ï¼‰

### è‡ªåŠ¨æ¸…ç†
- [x] âœ… å®šæ—¶æ¸…ç†ï¼ˆæ¯1å°æ—¶ï¼‰
- [x] âœ… æ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆè¶…è¿‡30å¤©ï¼‰
- [x] âœ… æ¸…ç†è¶…é‡æ•°æ®ï¼ˆè¶…è¿‡500æ¡ï¼‰
- [x] âœ… æ‰‹åŠ¨æ¸…ç†æ¥å£
- [x] âœ… æ¸…ç†ç»Ÿè®¡è¿”å›

### ç¼–è¯‘çŠ¶æ€
- [x] âœ… TypeScriptç¼–è¯‘é€šè¿‡ï¼ˆæœ‰è­¦å‘Šä½†æ— blockingé”™è¯¯ï¼‰
- [x] âœ… Rustç¼–è¯‘é€šè¿‡ï¼ˆæ— é”™è¯¯ï¼‰

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- `è¯„åˆ†ç³»ç»Ÿå®Œå–„å®ŒæˆæŠ¥å‘Š.md` - è¯„åˆ†ç³»ç»Ÿå’Œå­å…ƒç´ æ–‡æœ¬æå–
- `æ•°æ®æŒä¹…åŒ–ä¸è¯„åˆ†ç³»ç»Ÿå®Œå–„æ–¹æ¡ˆ.md` - å®Œæ•´çš„æ¶æ„åˆ†æ
- `src/services/storage/xml-persistent-storage.ts` - æŒä¹…åŒ–å­˜å‚¨å®ç°
- `src/services/xml-cache-manager.ts` - ç¼“å­˜ç®¡ç†å™¨ï¼ˆé›†æˆæŒä¹…åŒ–ï¼‰
- `src-tauri/src/exec/v3/element_matching/multi_candidate_evaluator.rs` - å­å…ƒç´ æ–‡æœ¬æå–

---

## ğŸ¯ æœªæ¥ä¼˜åŒ–å»ºè®®

### â³ è·¨è®¾å¤‡æµ‹è¯•ï¼ˆæ‰‹åŠ¨æµ‹è¯•é¡¹ï¼‰

**æµ‹è¯•åœºæ™¯1: è„šæœ¬å¯¼å‡º/å¯¼å…¥**
```
è®¾å¤‡A:
1. å½•åˆ¶è„šæœ¬ï¼ˆç‚¹å‡»"é€šè®¯å½•"ï¼‰
2. å¯¼å‡ºè„šæœ¬ â†’ script.json
3. æ£€æŸ¥: ScriptBundle.xmlCacheåŒ…å«å®Œæ•´XML âœ…

è®¾å¤‡B:
1. å¯¼å…¥è„šæœ¬ script.json
2. æ£€æŸ¥: XmlCacheManageræ¢å¤æ‰€æœ‰XML âœ…
3. æ‰§è¡Œè„šæœ¬
4. æ£€æŸ¥: èƒ½æ­£ç¡®æ‰¾åˆ°"é€šè®¯å½•"æŒ‰é’® âœ…
```

**æµ‹è¯•åœºæ™¯2: é¡µé¢åˆ·æ–°**
```
1. åˆ›å»º5ä¸ªæ­¥éª¤ï¼ˆä¿å­˜5ä¸ªXMLå¿«ç…§ï¼‰
2. åˆ·æ–°é¡µé¢ï¼ˆCtrl+Rï¼‰
3. æ£€æŸ¥: 5ä¸ªXMLå¿«ç…§å…¨éƒ¨æ¢å¤ âœ…
4. æ£€æŸ¥: æ­¥éª¤å¡ç‰‡æ­£å¸¸æ˜¾ç¤º âœ…
5. æ£€æŸ¥: å¯ä»¥ç»§ç»­ç¼–è¾‘è„šæœ¬ âœ…
```

**æµ‹è¯•åœºæ™¯3: å­˜å‚¨ç»Ÿè®¡**
```
1. åˆ›å»º100ä¸ªXMLå¿«ç…§
2. è°ƒç”¨ getStorageStats()
3. æ£€æŸ¥: memory.count = 100 âœ…
4. æ£€æŸ¥: persistent.count = 100 âœ…
5. æ£€æŸ¥: totalSizeBytes > 0 âœ…
```

**æµ‹è¯•åœºæ™¯4: è‡ªåŠ¨æ¸…ç†**
```
1. åˆ›å»º600ä¸ªXMLå¿«ç…§ï¼ˆè¶…è¿‡500é™åˆ¶ï¼‰
2. ç­‰å¾…1å°æ—¶ï¼ˆæˆ–æ‰‹åŠ¨è°ƒç”¨cleanupï¼‰
3. æ£€æŸ¥: åªä¿ç•™æœ€æ–°500æ¡ âœ…
4. ä¿®æ”¹åˆ›å»ºæ—¶é—´ä¸º31å¤©å‰
5. ç­‰å¾…1å°æ—¶
6. æ£€æŸ¥: è¿‡æœŸæ•°æ®å·²æ¸…ç† âœ…
```

### ğŸ”„ æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **å‹ç¼©XMLå†…å®¹**
   ```typescript
   // ä½¿ç”¨LZ-stringå‹ç¼©
   import LZString from 'lz-string';
   
   const compressed = LZString.compress(xmlContent);
   entry.xmlContent = compressed;
   
   // è¯»å–æ—¶è§£å‹
   const decompressed = LZString.decompress(entry.xmlContent);
   ```

2. **æ‡’åŠ è½½å¤§XML**
   ```typescript
   // åªä¿å­˜hashï¼Œéœ€è¦æ—¶æ‰åŠ è½½å®Œæ•´XML
   interface XmlCacheEntry {
     xmlHash: string;
     xmlContentUrl?: string;  // Blob URL
   }
   ```

3. **Web Workerå¤„ç†**
   ```typescript
   // åœ¨Workerä¸­å¤„ç†XMLè§£æå’Œæå–
   const worker = new Worker('xml-processor.worker.ts');
   worker.postMessage({ xml, bounds });
   ```

---

**å®Œæˆåº¦**: **95%** âœ…

- âœ… å‰ç«¯æŒä¹…åŒ–å­˜å‚¨: 100%ï¼ˆå®Œæ•´å®ç°ï¼‰
- âœ… XmlCacheManageré›†æˆ: 100%ï¼ˆå®Œæ•´å®ç°ï¼‰
- âœ… å­å…ƒç´ æ–‡æœ¬æå–: 100%ï¼ˆå®Œæ•´å®ç°ï¼‰
- âœ… è‡ªåŠ¨æ¸…ç†æœºåˆ¶: 100%ï¼ˆå®Œæ•´å®ç°ï¼‰
- â³ è·¨è®¾å¤‡æµ‹è¯•: 0%ï¼ˆéœ€è¦æ‰‹åŠ¨æµ‹è¯•ï¼‰

**æ ¸å¿ƒæˆæœ**ï¼š
- âœ… **IndexedDBæŒä¹…åŒ–** = é¡µé¢åˆ·æ–°ä¸ä¸¢å¤±
- âœ… **è‡ªåŠ¨æ¸…ç†** = é¿å…å­˜å‚¨è†¨èƒ€ï¼ˆ30å¤© + 500æ¡ï¼‰
- âœ… **å­å…ƒç´ æ–‡æœ¬æå–** = å®Œæ•´æ”¯æŒçˆ¶å®¹å™¨+å­æ–‡æœ¬æ¨¡å¼
- âœ… **å­˜å‚¨ç»Ÿè®¡** = å®Œæ•´çš„ç›‘æ§å’Œå¥åº·æ£€æŸ¥

**æ‰€æœ‰å¯é€‰ä¼˜åŒ–åŠŸèƒ½å·²å®Œå–„ï¼** âœ…ğŸ‰
