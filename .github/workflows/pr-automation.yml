# .github/workflows/pr-automation.yml
name: PR è‡ªåŠ¨åŒ–ï¼ˆæ ‡ç­¾/å¤§å°æ§åˆ¶ï¼‰

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  pr-automation:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§­ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ è‡ªåŠ¨æ·»åŠ PRæ ‡ç­¾
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            const pr = context.payload.pull_request;
            
            // æ ¹æ®æ–‡ä»¶å˜åŒ–è‡ªåŠ¨æ·»åŠ æ ‡ç­¾
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            const labels = [];
            
            // æ£€æŸ¥ä¿®æ”¹çš„æ–‡ä»¶ç±»å‹
            const hasTypeScript = files.some(f => f.filename.match(/\.(ts|tsx)$/));
            const hasRust = files.some(f => f.filename.includes('src-tauri/'));
            const hasTests = files.some(f => f.filename.includes('test') || f.filename.includes('spec'));
            const hasWorkflows = files.some(f => f.filename.includes('.github/workflows/'));
            const hasEvents = files.some(f => f.filename.includes('event') || f.filename.includes('analysis'));
            
            // æ ¹æ®PRæ ‡é¢˜å’Œæè¿°åˆ¤æ–­ç±»å‹
            const title = pr.title.toLowerCase();
            const body = (pr.body || '').toLowerCase();
            
            if (title.includes('fix') || title.includes('ä¿®å¤') || title.includes('ğŸ›')) {
              labels.push('bug');
            } else if (title.includes('feat') || title.includes('åŠŸèƒ½') || title.includes('âœ¨')) {
              labels.push('enhancement');
            } else if (title.includes('refactor') || title.includes('é‡æ„') || title.includes('â™»ï¸')) {
              labels.push('refactor');
            } else if (title.includes('docs') || title.includes('æ–‡æ¡£') || title.includes('ğŸ“š')) {
              labels.push('documentation');
            }
            
            // æŠ€æœ¯æ ˆæ ‡ç­¾
            if (hasTypeScript) labels.push('typescript');
            if (hasRust) labels.push('rust');
            if (hasTests) labels.push('tests');
            if (hasWorkflows) labels.push('ci/cd');
            if (hasEvents) labels.push('event-system');
            
            // æ·»åŠ æ ‡ç­¾
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels
              });
            }

      - name: ğŸ“ æ£€æŸ¥PRå¤§å°å¹¶æ·»åŠ æ ‡ç­¾
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            const pr = context.payload.pull_request;
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            // è®¡ç®—å˜æ›´ç»Ÿè®¡
            let additions = 0;
            let deletions = 0;
            let changedFiles = files.length;
            
            files.forEach(file => {
              additions += file.additions;
              deletions += file.deletions;
            });
            
            const totalChanges = additions + deletions;
            
            // æ ¹æ®å˜æ›´é‡æ·»åŠ å¤§å°æ ‡ç­¾
            let sizeLabel = '';
            if (totalChanges <= 50) {
              sizeLabel = 'size/XS';
            } else if (totalChanges <= 200) {
              sizeLabel = 'size/S';
            } else if (totalChanges <= 500) {
              sizeLabel = 'size/M';
            } else if (totalChanges <= 1000) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }
            
            // ç§»é™¤æ—§çš„å¤§å°æ ‡ç­¾
            const existingLabels = pr.labels.map(label => label.name);
            const sizeLabels = existingLabels.filter(label => label.startsWith('size/'));
            
            for (const label of sizeLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                name: label
              });
            }
            
            // æ·»åŠ æ–°çš„å¤§å°æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel]
            });
            
            // å¦‚æœPRè¿‡å¤§ï¼Œæ·»åŠ è¯„è®ºæé†’
            if (totalChanges > 800) {
              const comment = `
            ## ğŸš¨ å¤§å‹ PR æé†’
            
            è¿™ä¸ª PR åŒ…å«äº† **${totalChanges}** è¡Œå˜æ›´ï¼ˆ${changedFiles} ä¸ªæ–‡ä»¶ï¼‰ï¼Œæ¯”è¾ƒå¤§ã€‚
            
            **å»ºè®®**ï¼š
            - è€ƒè™‘å°†åŠŸèƒ½æ‹†åˆ†æˆå¤šä¸ªå° PR
            - ç¡®ä¿æœ‰å……åˆ†çš„æµ‹è¯•è¦†ç›–
            - è¯¦ç»†è¯´æ˜å˜æ›´å†…å®¹å’Œæµ‹è¯•æ–¹æ³•
            
            **ç»Ÿè®¡**ï¼š
            - ğŸ“ æ–‡ä»¶æ•°é‡: ${changedFiles}
            - â• æ–°å¢è¡Œæ•°: ${additions}
            - â– åˆ é™¤è¡Œæ•°: ${deletions}
            - ğŸ“Š æ€»å˜æ›´é‡: ${totalChanges}
            `;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }

      - name: ğŸ¯ æ£€æŸ¥å…³é”®æ–‡ä»¶å˜æ›´
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            const pr = context.payload.pull_request;
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            // æ£€æŸ¥å…³é”®æ–‡ä»¶å˜æ›´
            const criticalFiles = files.filter(f => 
              f.filename.includes('package.json') ||
              f.filename.includes('Cargo.toml') ||
              f.filename.includes('src-tauri/tauri.conf.json') ||
              f.filename.includes('.github/workflows/') ||
              f.filename.includes('eslint.config') ||
              f.filename.includes('tsconfig')
            );
            
            if (criticalFiles.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['critical-files']
              });
              
              const fileList = criticalFiles.map(f => `- \`${f.filename}\``).join('\n');
              
              const comment = `
            ## âš ï¸ å…³é”®æ–‡ä»¶å˜æ›´æ£€æµ‹
            
            æ­¤ PR ä¿®æ”¹äº†ä»¥ä¸‹å…³é”®æ–‡ä»¶ï¼Œè¯·ä»”ç»†å®¡æŸ¥ï¼š
            
            ${fileList}
            
            **è¯·ç¡®ä¿**ï¼š
            - é…ç½®å˜æ›´ç»è¿‡å……åˆ†æµ‹è¯•
            - ä¾èµ–å‡çº§ä¸ä¼šå¼•å…¥breaking changes
            - CI/CD å·¥ä½œæµå˜æ›´ä¸ä¼šå½±å“ç°æœ‰æµç¨‹
            `;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }

      - name: ğŸ” äº‹ä»¶ç³»ç»Ÿå˜æ›´æ£€æµ‹
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            const pr = context.payload.pull_request;
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });
            
            // æ£€æŸ¥æ˜¯å¦æ¶‰åŠäº‹ä»¶ç³»ç»Ÿæ–‡ä»¶
            const eventFiles = files.filter(f => 
              f.filename.includes('event') ||
              f.filename.includes('analysis') ||
              f.filename.includes('stepcards') ||
              f.filename.includes('unified') ||
              f.filename.includes('hook') && f.filename.includes('analysis')
            );
            
            if (eventFiles.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['event-system', 'needs-testing']
              });
              
              const comment = `
            ## ğŸ”„ äº‹ä»¶ç³»ç»Ÿå˜æ›´æ£€æµ‹
            
            æ­¤ PR æ¶‰åŠäº‹ä»¶ç³»ç»Ÿç›¸å…³æ–‡ä»¶ï¼Œè‡ªåŠ¨è§¦å‘é¢å¤–æ£€æŸ¥ï¼š
            
            **å°†æ‰§è¡Œ**ï¼š
            - ğŸ­ E2E äº‹ä»¶å›æ”¾æµ‹è¯•
            - ğŸ“Š äº‹ä»¶è¯æ®åŒ…æ”¶é›†
            - ğŸ” çŠ¶æ€åŒæ­¥éªŒè¯
            
            **è¯·ç¡®è®¤**ï¼š
            - [ ] äº‹ä»¶è·¯ç”±é€»è¾‘æ­£ç¡®
            - [ ] jobId ç»‘å®šæœºåˆ¶å·¥ä½œæ­£å¸¸
            - [ ] UI çŠ¶æ€åŒæ­¥æ— è¯¯
            - [ ] æ²¡æœ‰å¼•å…¥äº‹ä»¶æ³„æ¼
            `;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }