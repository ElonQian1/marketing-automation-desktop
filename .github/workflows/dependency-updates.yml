# .github/workflows/dependency-updates.yml
name: ä¾èµ–æ›´æ–°æœºå™¨äºº

on:
  schedule:
    - cron: "0 2 * * 1"  # æ¯å‘¨ä¸€ 10:00 åŒ—äº¬æ—¶é—´ (UTC 2:00)
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§­ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¦ å®‰è£… Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ¦€ å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ æ£€æŸ¥ npm ä¾èµ–æ›´æ–°
        id: npm-updates
        run: |
          npm outdated --json > npm-outdated.json || true
          
          if [ -s npm-outdated.json ] && [ "$(cat npm-outdated.json)" != "{}" ]; then
            echo "has_npm_updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ å‘ç° npm ä¾èµ–æ›´æ–°"
          else
            echo "has_npm_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… npm ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
          fi

      - name: ğŸ¦€ æ£€æŸ¥ Cargo ä¾èµ–æ›´æ–°
        id: cargo-updates
        run: |
          cd src-tauri
          cargo install cargo-outdated || true
          cargo outdated --format json > ../cargo-outdated.json || echo '{}' > ../cargo-outdated.json
          
          if [ -s ../cargo-outdated.json ] && [ "$(cat ../cargo-outdated.json)" != "{}" ]; then
            echo "has_cargo_updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ¦€ å‘ç° Cargo ä¾èµ–æ›´æ–°"
          else
            echo "has_cargo_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… Cargo ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
          fi

      - name: ğŸ“‹ ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
        if: steps.npm-updates.outputs.has_npm_updates == 'true' || steps.cargo-updates.outputs.has_cargo_updates == 'true'
        run: |
          echo "# ğŸ“¦ ä¾èµ–æ›´æ–°æŠ¥å‘Š $(date '+%Y-%m-%d')" > update-report.md
          echo "" >> update-report.md
          
          if [ "${{ steps.npm-updates.outputs.has_npm_updates }}" == "true" ]; then
            echo "## ğŸŸ¦ Node.js ä¾èµ–æ›´æ–°" >> update-report.md
            echo '```json' >> update-report.md
            cat npm-outdated.json >> update-report.md
            echo '```' >> update-report.md
            echo "" >> update-report.md
          fi
          
          if [ "${{ steps.cargo-updates.outputs.has_cargo_updates }}" == "true" ]; then
            echo "## ğŸ¦€ Rust ä¾èµ–æ›´æ–°" >> update-report.md
            echo '```json' >> update-report.md
            cat cargo-outdated.json >> update-report.md
            echo '```' >> update-report.md
          fi
          
          echo "## ğŸ¯ è‡ªåŠ¨åŒ–æ“ä½œ" >> update-report.md
          echo "- æœ¬PRå°†è‡ªåŠ¨æ‰§è¡Œå°ç‰ˆæœ¬ä¾èµ–æ›´æ–°" >> update-report.md
          echo "- å¤§ç‰ˆæœ¬æ›´æ–°éœ€è¦äººå·¥å®¡æŸ¥" >> update-report.md
          echo "- CI å…¨ç»¿åå°†è‡ªåŠ¨åˆå¹¶" >> update-report.md

      - name: ğŸ”„ æ‰§è¡Œå°ç‰ˆæœ¬æ›´æ–°
        if: steps.npm-updates.outputs.has_npm_updates == 'true' || steps.cargo-updates.outputs.has_cargo_updates == 'true'
        run: |
          # æ›´æ–° npm ä¾èµ–ï¼ˆå°ç‰ˆæœ¬ï¼‰
          if [ "${{ steps.npm-updates.outputs.has_npm_updates }}" == "true" ]; then
            npm update
          fi
          
          # æ›´æ–° Cargo ä¾èµ–ï¼ˆå°ç‰ˆæœ¬ï¼‰
          if [ "${{ steps.cargo-updates.outputs.has_cargo_updates }}" == "true" ]; then
            cd src-tauri
            cargo update
          fi

      - name: ğŸ§ª è¿è¡Œå¿«é€Ÿæµ‹è¯•
        if: steps.npm-updates.outputs.has_npm_updates == 'true' || steps.cargo-updates.outputs.has_cargo_updates == 'true'
        run: |
          # å®‰è£…ä¾èµ–
          npm ci
          
          # TypeScript æ£€æŸ¥
          npx tsc --noEmit || exit 1
          
          # Rust æ£€æŸ¥
          cd src-tauri
          cargo check || exit 1

      - name: ğŸ“¤ åˆ›å»ºæ›´æ–° PR
        if: steps.npm-updates.outputs.has_npm_updates == 'true' || steps.cargo-updates.outputs.has_cargo_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ“¦ è‡ªåŠ¨æ›´æ–°ä¾èµ– $(date '+%Y-%m-%d')"
          title: "ğŸ“¦ ä¾èµ–æ›´æ–° $(date '+%Y-%m-%d')"
          body-path: update-report.md
          branch: auto-dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated
            size/M

  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm' }
      - uses: dtolnay/rust-toolchain@stable
      
      - name: ğŸ” npm å®‰å…¨å®¡è®¡
        run: |
          npm audit --audit-level=high --json > npm-audit.json || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é«˜å±æ¼æ´
          if grep -q '"level":"high"' npm-audit.json || grep -q '"level":"critical"' npm-audit.json; then
            echo "âš ï¸ å‘ç°é«˜å±å®‰å…¨æ¼æ´"
            npm audit --audit-level=high
          else
            echo "âœ… npm å®‰å…¨æ£€æŸ¥é€šè¿‡"
          fi

      - name: ğŸ¦€ Cargo å®‰å…¨å®¡è®¡
        run: |
          cargo install cargo-audit || true
          cd src-tauri
          cargo audit --json > ../cargo-audit.json || true
          
          if [ -s ../cargo-audit.json ]; then
            echo "âš ï¸ Cargo å®‰å…¨æŠ¥å‘Šï¼š"
            cargo audit
          else
            echo "âœ… Cargo å®‰å…¨æ£€æŸ¥é€šè¿‡"
          fi

      - name: ğŸ“Š ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports
          path: |
            npm-audit.json
            cargo-audit.json