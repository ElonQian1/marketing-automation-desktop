# .github/workflows/event-routing-validation.yml
name: äº‹ä»¶è·¯ç”±ä¿®å¤éªŒè¯

on:
  pull_request:
    paths:
      - "src/store/**"
      - "src/services/unified-analysis-events.ts"
      - "src/hooks/useUnifiedSmartAnalysis.ts"
      - "src/components/step-cards/**"
      - "src/components/strategy-selector/**"
      - "tests/e2e/event-routing-fix.spec.ts"
  push:
    branches: [ main ]
    paths:
      - "src/store/**"
      - "src/services/unified-analysis-events.ts"
      - "src/hooks/useUnifiedSmartAnalysis.ts"
  workflow_dispatch:

jobs:
  event-routing-validation:
    name: äº‹ä»¶è·¯ç”±ä¿®å¤éªŒè¯
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ§­ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ðŸŸ¦ å®‰è£… Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ðŸ¦€ å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ“š Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ðŸ—ï¸ æž„å»ºå‰ç«¯
        run: npm run build

      - name: ðŸ”§ æž„å»º Rust åŽç«¯
        run: |
          cd src-tauri
          cargo build

      - name: ðŸŽ­ å®‰è£… Playwright
        run: npx playwright install --with-deps chromium

      - name: ðŸŽ¯ è¿è¡Œäº‹ä»¶è·¯ç”±ä¿®å¤æµ‹è¯•
        run: npx playwright test event-routing-fix.spec.ts --reporter=json,html
        env:
          CI: true

      - name: ðŸ“Š æ”¶é›†äº‹ä»¶è¯æ®
        if: always()
        run: |
          mkdir -p evidence/screenshots
          mkdir -p evidence/logs
          
          # æ”¶é›† Playwright æŠ¥å‘Š
          [ -d playwright-report ] && cp -r playwright-report evidence/ || true
          
          # æ”¶é›†æµ‹è¯•ç»“æžœ
          [ -f test-results.json ] && cp test-results.json evidence/ || true
          
          # æ”¶é›†åº”ç”¨æ—¥å¿—ï¼ˆå¦‚æžœæœ‰ï¼‰
          [ -f debug/flows/backend-events.jsonl ] && cp debug/flows/backend-events.jsonl evidence/logs/ || true
          
          # æ”¶é›†ç³»ç»Ÿä¿¡æ¯
          echo "æµ‹è¯•çŽ¯å¢ƒä¿¡æ¯:" > evidence/system-info.txt
          echo "Nodeç‰ˆæœ¬: $(node --version)" >> evidence/system-info.txt
          echo "npmç‰ˆæœ¬: $(npm --version)" >> evidence/system-info.txt
          echo "Rustç‰ˆæœ¬: $(rustc --version)" >> evidence/system-info.txt
          echo "ç³»ç»Ÿ: $(uname -a)" >> evidence/system-info.txt
          echo "æ—¶é—´: $(date)" >> evidence/system-info.txt

      - name: ðŸ“ˆ åˆ†æžæµ‹è¯•ç»“æžœ
        if: always()
        run: |
          if [ -f test-results.json ]; then
            echo "## ðŸŽ¯ äº‹ä»¶è·¯ç”±æµ‹è¯•ç»“æžœåˆ†æž" >> $GITHUB_STEP_SUMMARY
            
            # æå–å…³é”®æŒ‡æ ‡
            TOTAL_TESTS=$(jq -r '.suites[].specs | length' test-results.json 2>/dev/null || echo "æœªçŸ¥")
            PASSED_TESTS=$(jq -r '[.suites[].specs[].tests[] | select(.status == "passed")] | length' test-results.json 2>/dev/null || echo "0")
            FAILED_TESTS=$(jq -r '[.suites[].specs[].tests[] | select(.status == "failed")] | length' test-results.json 2>/dev/null || echo "0")
            
            echo "- ðŸ“Š æ€»æµ‹è¯•æ•°: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… é€šè¿‡: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY  
            echo "- âŒ å¤±è´¥: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED_TESTS" = "0" ]; then
              echo "- ðŸŽ‰ **æ‰€æœ‰äº‹ä»¶è·¯ç”±æµ‹è¯•é€šè¿‡ï¼ä¿®å¤éªŒè¯æˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸ **å‘çŽ°å¤±è´¥æµ‹è¯•ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ æ— æ³•æ‰¾åˆ°æµ‹è¯•ç»“æžœæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“Ž ä¸Šä¼ è¯æ®åŒ…
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: event-routing-evidence-${{ github.run_number }}
          path: evidence/
          retention-days: 7

      - name: ðŸ› å¤±è´¥æ—¶çš„è°ƒè¯•ä¿¡æ¯
        if: failure()
        run: |
          echo "## ðŸ” è°ƒè¯•ä¿¡æ¯æ”¶é›†" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ä¸Šä¼ çš„è¯æ®åŒ…èŽ·å–è¯¦ç»†ä¿¡æ¯ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- playwright-report/ - è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šå’Œæˆªå›¾" >> $GITHUB_STEP_SUMMARY
          echo "- logs/ - åº”ç”¨å’Œäº‹ä»¶æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "- system-info.txt - æµ‹è¯•çŽ¯å¢ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæœ€è¿‘çš„æ—¥å¿—ç‰‡æ®µ
          if [ -f evidence/logs/backend-events.jsonl ]; then
            echo "### ðŸ“‹ æœ€è¿‘çš„åŽç«¯äº‹ä»¶:" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            tail -5 evidence/logs/backend-events.jsonl >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: âœ… æˆåŠŸæ—¶çš„ç¡®è®¤ä¿¡æ¯
        if: success()
        run: |
          echo "## ðŸŽ‰ äº‹ä»¶è·¯ç”±ä¿®å¤éªŒè¯æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… éªŒè¯é€šè¿‡çš„å…³é”®åŠŸèƒ½:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— jobId ç²¾ç¡®ç»‘å®šæœºåˆ¶" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ ç»Ÿä¸€äº‹ä»¶è·¯ç”±ç³»ç»Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š UI çŠ¶æ€åŒæ­¥ï¼ˆanalyzing â†’ readyï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§  æ™ºèƒ½åˆ†æžæŒ‰é’®çŠ¶æ€ç®¡ç†" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ˆ è¿›åº¦æ›´æ–°æ­£ç¡®æ˜¾ç¤º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜:" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ æ—§ç‰ˆï¼šåŽç«¯å®Œæˆä½†å‰ç«¯æŒ‰é’®å¡åœ¨ 'ðŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾ ðŸ”„ 0%'" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ–°ç‰ˆï¼šæ­£ç¡®çš„çŠ¶æ€è½¬æ¢ 'ðŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾' â†’ 'ðŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾ ðŸ”„ X%' â†’ 'ðŸ§  æ™ºèƒ½Â·è‡ªåŠ¨é“¾ âœ…'" >> $GITHUB_STEP_SUMMARY