# 结构匹配运行时测试指南 (Phase 3)

## 📋 概述

**完成时间**: 2025年11月3日  
**测试页面**: `src/pages/test/sm-runtime-test-page.tsx`  
**路由路径**: 开发模式 → "🔬 结构匹配运行时测试"

---

## 🚀 快速启动

### 1. 启动应用

```bash
cd d:\rust\active-projects\小红书\employeeGUI
npm run tauri dev
```

### 2. 访问测试页面

1. 启动后在左侧菜单找到 **"🔬 结构匹配运行时测试"**（仅开发模式显示）
2. 点击进入测试页面

---

## 🧪 测试流程

### Step 1: 准备XML数据

**方式A - 使用示例数据**:
- 点击 **"加载示例XML"** 按钮
- 系统会自动加载包含小红书列表的模拟XML

**方式B - 使用真实数据**:
1. 在ADB设备上执行 `adb shell uiautomator dump`
2. 获取 `/sdcard/window_dump.xml` 内容
3. 粘贴到左侧文本框

### Step 2: 配置匹配参数

选择匹配模式（默认 `default`）:
- **Speed**: 快速模式（跳过部分检查）
- **Default**: 默认模式（平衡速度和准确性）
- **Robust**: 鲁棒模式（最全面的检查）

### Step 3: 执行测试

点击 **"执行匹配"** 按钮，系统将：
1. 调用 Rust 后端 `sm_match_once` 命令
2. 显示执行状态（加载动画）
3. 返回匹配结果

---

## 📊 结果解读

### ✅ 成功响应

**容器信息卡片**:
- **容器节点ID**: 识别出的容器节点ID（如 RecyclerView）
- **布局类型**: `RecyclerView` / `ListView` / `ScrollView` 等
- **平均得分**: 所有匹配项的平均置信度（百分比）

**匹配项列表**:
- **节点ID**: UI元素的唯一标识
- **得分**: 单个元素的匹配置信度
- **边界坐标**: 
  - 左(left) / 上(top) / 右(right) / 下(bottom)
  - 自动计算宽度和高度

### ❌ 失败响应

显示错误信息，可能原因：
- XML格式错误
- 后端编译错误
- 算法内部异常

---

## 🎯 预期结果（示例XML）

使用内置示例XML时，应该看到：

```json
{
  "success": true,
  "elapsedMs": 10-50,
  "result": {
    "containerId": 1,  // RecyclerView节点
    "layoutType": "RecyclerView",
    "items": [
      {
        "nodeId": 2,
        "score": 0.75-0.95,
        "bounds": { "left": 24, "top": 188, "right": 516, "bottom": 680 }
      },
      {
        "nodeId": 6,
        "score": 0.75-0.95,
        "bounds": { "left": 564, "top": 188, "right": 1056, "bottom": 680 }
      }
    ],
    "score": 0.80-0.90
  }
}
```

**解释**:
- 识别出 `RecyclerView` 作为容器（节点ID=1）
- 找到 2 个子项（ViewGroup 节点，包含图片+文字）
- 每个子项得分应在 75%-95% 之间

---

## 🐛 故障排查

### 问题1: 点击按钮无反应

**检查**:
```bash
# 后端是否编译成功
cd src-tauri
cargo check
```

### 问题2: 返回错误 "Failed to build XmlIndexer"

**原因**: XML格式不正确  
**解决**: 确保XML是标准的 `uiautomator dump` 输出格式

### 问题3: 找不到匹配项（items为空数组）

**可能原因**:
1. XML中没有 RecyclerView/ListView/ScrollView 容器
2. 容器内的子元素不符合骨架规则
3. 选择的模式过于严格

**调试**:
- 切换到 `speed` 模式重试
- 检查XML中是否有列表容器
- 查看浏览器控制台的详细日志

### 问题4: 编译错误

**检查TypeScript**:
```bash
npm run type-check
```

**检查Rust**:
```bash
cd src-tauri
cargo check
```

---

## 📁 相关文件

### 前端文件

| 文件路径 | 作用 | 行数 |
|---------|------|------|
| `src/pages/test/sm-runtime-test-page.tsx` | 测试页面主组件 | ~330 |
| `src/components/NativeAntDesignApp.tsx` | 路由配置（添加菜单项） | - |

### 后端文件

| 文件路径 | 作用 | 行数 |
|---------|------|------|
| `src-tauri/src/commands/structure_match_runtime.rs` | Tauri命令层 | ~245 |
| `src-tauri/src/domain/structure_runtime_match/adapters/xml_indexer_adapter.rs` | XmlIndexer适配器 | ~300 |
| `src-tauri/src/domain/structure_runtime_match/orchestrator.rs` | 核心匹配算法 | - |

---

## 🔄 后续优化建议

### Phase 3 完成后可以做：

1. **增强配置选项**:
   - [ ] 支持自定义骨架规则（skeleton_rules）
   - [ ] 支持字段规则（field_rules）
   - [ ] 容器提示（container_hint）

2. **可视化增强**:
   - [ ] 在结果中显示每个节点的class/text属性
   - [ ] 绘制边界框图形（Canvas渲染）
   - [ ] 高亮显示得分最高的元素

3. **性能监控**:
   - [ ] 显示各阶段耗时（容器识别/分类/评分）
   - [ ] 添加缓存命中率统计
   - [ ] 支持批量测试多个XML

4. **错误处理**:
   - [ ] 更详细的错误分类
   - [ ] 提供修复建议
   - [ ] 记录测试历史

---

## ✅ 验收标准

### Phase 3 完成的标志：

- [x] 测试页面可正常访问
- [x] 可以加载示例XML
- [x] 可以执行 `sm_match_once` 命令
- [x] 成功返回匹配结果
- [x] 结果包含容器信息和匹配项列表
- [x] 界面显示边界坐标和得分
- [ ] 真实设备XML测试通过（待验证）

---

## 📞 支持

遇到问题时：
1. 检查浏览器控制台（F12）
2. 检查 Tauri 控制台输出
3. 查看 `cargo check` 编译日志
4. 参考上文"故障排查"章节

---

**Phase 3 基础集成测试完成！** 🎉
