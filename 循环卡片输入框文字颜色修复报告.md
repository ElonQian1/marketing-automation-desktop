# 循环卡片输入框文字颜色修复报告

## 🐛 问题描述

**现象**：循环卡片中的 InputNumber（数字输入框）出现"黑底深字"问题，文字不可见。

**根本原因**：CSS 样式冲突导致
1. 全局深色主题设置了暗色背景
2. `.light-theme-force` 通配符选择器强制所有子元素使用深色文字
3. InputNumber 内部的 `.ant-input-number-input` 没有独立的颜色覆盖

```css
/* ❌ 错误的通配符选择器 */
.loop-card.light-theme-force * {
  color: #111827 !important;  /* 深色文字 */
}

/* 结果：深色背景 + 深色文字 = 看不见 */
```

---

## ✅ 修复方案

### 原则：**独立基准线 + 显式覆盖**

每个表面（Surface）都应该有独立的颜色基准线，而不是依赖通配符继承。

### 1️⃣ 修复 `tokens.css`（全局样式）

**文件**：`src/styles/tokens.css`

**修改**：在 `.light-theme-force` 中添加 InputNumber 支持

```css
/* Input 组件颜色覆盖 */
.light-theme-force .ant-input,
.light-theme-force .ant-select-selector,
.light-theme-force .ant-input-number,           /* 🎯 新增 */
.light-theme-force .ant-input-number-input {    /* 🎯 新增 */
  color: var(--text-inverse, #1e293b) !important;
  background: var(--bg-light-base, #ffffff) !important;
}
```

**效果**：所有使用 `.light-theme-force` 的浅色容器中的输入框都会正确显示深色文字。

---

### 2️⃣ 修复 `loop.css`（循环卡片全局样式）

**文件**：`src/styles/surfaces/loop.css`

**修改**：添加 InputNumber 输入框的强制样式

```css
/* ===== 表单控件样式重写 ===== */

.loop-step-card .ant-input-number {
  background: var(--bg-light-base, #ffffff) !important;
  border-color: var(--loop-card-border) !important;
}

/* 🎯 关键修复：InputNumber 内部输入框文字颜色 */
.loop-step-card .ant-input-number-input {
  color: var(--loop-card-text-primary) !important;
  background: var(--bg-light-base, #ffffff) !important;
}
```

**效果**：所有 `.loop-step-card` 中的 InputNumber 都会显示正确的文字颜色。

---

### 3️⃣ 修复 `LoopStartCard/styles.css`（循环开始/结束卡片）

**文件**：`src/components/LoopStartCard/styles.css`

**修改前**（错误）：
```css
/* ❌ 通配符选择器导致所有子元素被强制设置颜色 */
.loop-card.light-theme-force,
.loop-card.light-theme-force * {
  color: #111827 !important;
}
```

**修改后**（正确）：
```css
/* ✅ 显式指定需要深色文字的元素 */
.loop-card.light-theme-force {
  color: #111827 !important;
}

/* 普通文本元素使用深色文字 */
.loop-card.light-theme-force span,
.loop-card.light-theme-force p,
.loop-card.light-theme-force div,
.loop-card.light-theme-force .ant-typography {
  color: #111827 !important;
}

.loop-card.light-theme-force .ant-typography-secondary {
  color: #6b7280 !important;
}

/* 🎯 关键修复：表单输入框使用深色文字 + 白色背景 */
.loop-card.light-theme-force .ant-input,
.loop-card.light-theme-force .ant-input-number,
.loop-card.light-theme-force .ant-input-number-input,
.loop-card.light-theme-force .ant-select-selector {
  color: #111827 !important;
  background: #ffffff !important;
}
```

**关键变化**：
1. ❌ 删除通配符选择器 `*`
2. ✅ 显式列出需要深色文字的元素（span, p, div, .ant-typography）
3. ✅ 为表单控件单独设置：深色文字 + 白色背景

---

## 🎯 设计原则总结

### 1. **避免通配符选择器（`*`）**

**错误示范**：
```css
.container * {
  color: black !important;
}
```

**问题**：会影响所有子元素，包括不应该被修改的组件（如输入框、按钮等）。

**正确做法**：
```css
.container span,
.container p,
.container div {
  color: black !important;
}
```

---

### 2. **独立基准线原则**

每个表面（Surface）应该有独立的颜色基准：

```css
/* 浅色表面 */
.light-surface {
  background: white;
  color: black;
}

/* 浅色表面中的输入框 */
.light-surface input {
  background: white;
  color: black;
}

/* 深色表面 */
.dark-surface {
  background: black;
  color: white;
}

/* 深色表面中的输入框 */
.dark-surface input {
  background: #333;
  color: white;
}
```

---

### 3. **Ant Design 输入组件的嵌套结构**

```html
<span class="ant-input-number">          <!-- 外层容器 -->
  <input class="ant-input-number-input"> <!-- 实际输入框 ⚠️ 需要单独设置 -->
</span>
```

**关键点**：
- `.ant-input-number`：外层容器样式
- `.ant-input-number-input`：**实际的输入框**，必须单独设置颜色！

**完整覆盖**：
```css
.container .ant-input-number {
  border-color: #ddd;
}

.container .ant-input-number-input {  /* 🎯 关键 */
  color: black !important;
  background: white !important;
}
```

---

## 📋 修改文件清单

| 文件 | 修改内容 | 影响范围 |
|------|---------|---------|
| `src/styles/tokens.css` | 在 `.light-theme-force` 中添加 `.ant-input-number-input` 支持 | 全局所有使用 `.light-theme-force` 的浅色容器 |
| `src/styles/surfaces/loop.css` | 为 `.loop-step-card` 添加 `.ant-input-number-input` 样式 | 所有循环卡片（通用类） |
| `src/components/LoopStartCard/styles.css` | 删除通配符 `*`，显式指定文字颜色 | LoopStartCard 和 LoopEndCard |

---

## ✅ 验证清单

### 1️⃣ 循环开始卡片（LoopStartCard）
- [ ] InputNumber 输入框背景是白色
- [ ] InputNumber 输入框文字是深色（#111827）
- [ ] 输入数字时文字清晰可见
- [ ] 悬停/聚焦时边框颜色正常（绿色）

### 2️⃣ 循环结束卡片（LoopEndCard）
- [ ] InputNumber 输入框背景是白色
- [ ] InputNumber 输入框文字是深色（#111827）
- [ ] 配置模态框中的输入框正常显示

### 3️⃣ 其他浅色容器
- [ ] 所有使用 `.light-theme-force` 的组件中的输入框都正常
- [ ] 参数面板中的输入框正常
- [ ] 设置窗口中的输入框正常

---

## 🔍 类似问题排查指南

### 如何发现"白底白字"或"黑底深字"问题？

1. **检查通配符选择器**：
   ```bash
   # 搜索可能导致问题的通配符
   grep -r "\..*\s\*\s*{" src/styles/
   ```

2. **检查 Ant Design 输入组件**：
   - 确保 `.ant-input-number-input` 有独立的颜色设置
   - 确保 `.ant-select-selector` 有独立的颜色设置
   - 确保 `.ant-input` 有独立的颜色设置

3. **检查颜色对比度**：
   ```typescript
   // 使用浏览器开发工具检查计算后的颜色
   background-color: rgb(xxx, xxx, xxx)
   color: rgb(xxx, xxx, xxx)
   
   // 对比度至少应该 >= 4.5:1 (WCAG AA 标准)
   ```

### 修复模板：

```css
/* 步骤1：检查父容器 */
.parent-container {
  background: var(--bg-light-base, #ffffff);
  color: var(--text-inverse, #1e293b);
}

/* 步骤2：避免通配符 */
/* ❌ 不要这样写 */
.parent-container * {
  color: inherit;
}

/* ✅ 应该这样写 */
.parent-container span,
.parent-container p,
.parent-container div {
  color: var(--text-inverse, #1e293b);
}

/* 步骤3：显式覆盖输入组件 */
.parent-container .ant-input,
.parent-container .ant-input-number-input,
.parent-container .ant-select-selector {
  color: var(--text-inverse, #1e293b) !important;
  background: var(--bg-light-base, #ffffff) !important;
}
```

---

## 🎨 设计系统建议

### 定义颜色表面（Color Surfaces）

建议在设计系统中定义标准的颜色表面：

```css
/* 浅色表面（用于卡片、模态框等） */
.surface-light {
  background: var(--bg-light-base, #ffffff);
  color: var(--text-inverse, #1e293b);
}

.surface-light input,
.surface-light .ant-input-number-input {
  color: var(--text-inverse, #1e293b) !important;
  background: var(--bg-light-base, #ffffff) !important;
}

/* 深色表面（用于侧边栏、顶栏等） */
.surface-dark {
  background: var(--bg-base, #0f172a);
  color: var(--text-1, #f8fafc);
}

.surface-dark input,
.surface-dark .ant-input-number-input {
  color: var(--text-1, #f8fafc) !important;
  background: var(--bg-elevated, #1e293b) !important;
}

/* 强调表面（用于通知、警告等） */
.surface-accent {
  background: var(--brand-100, #e0eaff);
  color: var(--brand-900, #334085);
}

.surface-accent input,
.surface-accent .ant-input-number-input {
  color: var(--brand-900, #334085) !important;
  background: var(--bg-light-base, #ffffff) !important;
}
```

---

## 📝 实施总结

### 修改统计
- **修改文件数**：3 个
- **新增代码行**：约 20 行
- **删除代码行**：约 5 行
- **修复时间**：约 10 分钟

### 技术债务
- **无新增技术债务**
- **消除遗留问题**：通配符选择器的滥用

### 测试覆盖
- [x] TypeScript 类型检查通过
- [ ] UI 功能测试（待用户验证）
- [ ] 对比度测试（待用户验证）

---

## 🚀 后续优化建议

### 1. 创建颜色表面组件库
```typescript
// src/components/surfaces/LightSurface.tsx
export const LightSurface: React.FC<PropsWithChildren> = ({ children }) => {
  return (
    <div className="surface-light">
      {children}
    </div>
  );
};
```

### 2. 自动化对比度检测
```typescript
// 在开发环境中自动检测颜色对比度
if (process.env.NODE_ENV === 'development') {
  checkContrastRatio(backgroundColor, textColor);
}
```

### 3. 设计 Token 标准化
```typescript
// 统一所有表面的颜色定义
export const surfaceTokens = {
  light: {
    background: '#ffffff',
    text: '#1e293b',
    input: { background: '#ffffff', text: '#1e293b' },
  },
  dark: {
    background: '#0f172a',
    text: '#f8fafc',
    input: { background: '#1e293b', text: '#f8fafc' },
  },
};
```

---

**修复完成！请刷新页面验证循环卡片中的 InputNumber 是否显示正常。** 🎉
