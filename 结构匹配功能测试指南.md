# 🏗️ 结构匹配功能测试指南

**测试时间**: 2025年10月31日  
**修复状态**: ✅ 已修复 - 菜单点击现在可以打开模态框

---

## 🐛 问题诊断

### 原问题
用户点击"静态策略 → 结构匹配"菜单项后，**没有看到模态框弹出**。

### 根本原因
```tsx
// ❌ 旧代码 (第663行)
onClick: () => {
  // TODO: 打开对应的配置模态框
  console.log(`📌 [ActionSelector] 选择静态策略: ${sub.key}`);
}
```

**问题**: 点击事件只是打印日志，没有实际打开模态框。

---

## ✅ 修复内容

### 1️⃣ 添加导入
```tsx
// 第12行
import { StructuralMatchingModal, type StructuralMatchingConfig } from '../../modules/structural-matching';
```

### 2️⃣ 添加状态管理
```tsx
// 第42-43行
const [structuralMatchingVisible, setStructuralMatchingVisible] = useState(false);
const [structuralMatchingConfig, setStructuralMatchingConfig] = useState<StructuralMatchingConfig | null>(null);
```

### 3️⃣ 修改菜单点击事件
```tsx
// 第663-672行
onClick: () => {
  console.log(`📌 [ActionSelector] 选择静态策略: ${sub.key}`);
  if (sub.key === 'structural_matching') {
    setStructuralMatchingVisible(true);  // ✅ 打开模态框
  } else if (sub.key === 'xpath_recovery') {
    console.log('🔧 XPath恢复功能待实现');
  }
}
```

### 4️⃣ 添加模态框组件
```tsx
// 第947-963行
<StructuralMatchingModal
  visible={structuralMatchingVisible}
  selectedElement={{
    class: 'android.widget.FrameLayout',
    'resource-id': 'com.xingin.xhs:id/note_item',
    'content-desc': '笔记 测试标题 来自作者 100赞',
    bounds: '[0,0][100,100]',
    text: '',
    children: []
  }}
  initialConfig={structuralMatchingConfig}
  onClose={() => setStructuralMatchingVisible(false)}
  onConfirm={(config) => {
    console.log('✅ [ActionSelector] 保存结构匹配配置', config);
    setStructuralMatchingConfig(config);
    setStructuralMatchingVisible(false);
  }}
/>
```

---

## 🧪 测试步骤

### 立即验证（前端功能测试）

1. **启动开发服务器**
   ```bash
   npm run tauri dev
   ```

2. **打开步骤卡片**
   - 进入脚本编辑页面
   - 添加或编辑一个步骤

3. **打开结构匹配配置**
   - 点击"执行链选择"按钮（🧠 智能·自动链）
   - 选择"📌 静态策略"
   - 展开子菜单
   - **点击"🏗️ 结构匹配"**

4. **验证模态框打开** ✅
   - 应该看到结构匹配配置模态框弹出
   - 显示顶部状态栏（预计得分、匹配度、状态）
   - 显示阈值滑块
   - 显示两个标签页：
     - "字段配置" - 6个字段的配置选项
     - "评分预览" - 实时预览面板

5. **测试配置功能**
   - ✅ 调整全局阈值滑块（0-100%）
   - ✅ 切换字段启用/禁用（Switch开关）
   - ✅ 调整字段权重（0-2x）
   - ✅ 切换匹配模式下拉框
   - ✅ 查看实时预览变化

6. **测试保存**
   - 点击"确认"按钮
   - 检查浏览器控制台：
     ```
     ✅ [ActionSelector] 保存结构匹配配置 {configId: "...", fields: [...], ...}
     ```

7. **测试重新打开**
   - 再次点击"🏗️ 结构匹配"
   - 应该加载之前保存的配置

---

## 🎨 预期界面

### 模态框布局
```
┌─────────────────────────────────────────────────┐
│ 结构匹配配置                          [X]       │
├─────────────────────────────────────────────────┤
│ 预计得分: 0.50/0.80  匹配度: 62.5%  [预计通过] │
├─────────────────────────────────────────────────┤
│ 全局阈值                                        │
│ ════════●═════════ 60%                         │
├─────────────────────────────────────────────────┤
│ [字段配置] [评分预览]                           │
│                                                 │
│ ☑ Resource-ID          权重: ─●─ 1.0x         │
│   匹配模式: [都非空即可 ▼]                      │
│   规则: 完全0.30 | 都非空0.10 | ...            │
│                                                 │
│ ☑ Content-Desc (笔记核心) 权重: ─●─ 1.0x      │
│ ☑ Text                  权重: ─●─ 0.8x         │
│ ☑ Class Name            权重: ─●─ 0.9x         │
│ ☑ Children Structure    权重: ──●─ 1.2x ⭐     │
│ ☐ Bounds (默认禁用)                            │
├─────────────────────────────────────────────────┤
│               [重置为默认配置]                   │
│                         [取消]  [确认]          │
└─────────────────────────────────────────────────┘
```

---

## 🔍 问题排查

### 如果模态框还是不显示

#### 检查1: 查看控制台日志
```javascript
// 点击菜单项时应该看到:
📌 [ActionSelector] 选择静态策略: structural_matching
```

#### 检查2: React DevTools
- 打开React DevTools
- 搜索 `StructuralMatchingModal`
- 检查 `visible` 属性是否为 `true`

#### 检查3: CSS样式
```bash
# 检查是否有CSS冲突导致模态框被隐藏
# 在浏览器DevTools中搜索 .structural-matching-modal
```

#### 检查4: 依赖是否正确导入
```tsx
// 确认这行没有报错
import { StructuralMatchingModal, type StructuralMatchingConfig } from '../../modules/structural-matching';
```

---

## 📊 当前实施状态

| 功能模块 | 状态 | 说明 |
|---------|------|------|
| ✅ 前端模块 | 完成 | 13个文件，DDD架构 |
| ✅ 后端模块 | 完成 | Rust评分器，编译通过 |
| ✅ 菜单集成 | 完成 | ActionSelector.tsx |
| ✅ 模态框触发 | 完成 | 点击菜单打开模态框 |
| ⏳ 元素传递 | 待完善 | 当前使用模拟元素 |
| ⏳ 配置持久化 | 待完善 | 保存到步骤数据 |
| ⏳ 后端调用 | 待完善 | Tauri命令集成 |

---

## 🚀 下一步计划

### 短期（立即可做）
1. ✅ **验证模态框打开** - 完成测试步骤1-7
2. ⏳ **传递真实元素** - 从步骤卡片获取实际选中的元素
3. ⏳ **持久化配置** - 保存到 Zustand store 或步骤数据

### 中期（需要后端支持）
4. ⏳ **创建Tauri命令** - `evaluate_structural_match`
5. ⏳ **连接前后端** - 调用Rust评分器
6. ⏳ **实测小红书** - 用真实APP验证准确性

---

## ✅ 修复确认清单

- [x] 导入 `StructuralMatchingModal` 组件
- [x] 添加状态管理（visible、config）
- [x] 修改菜单点击事件（打开模态框）
- [x] 渲染模态框组件
- [x] 处理确认/取消回调
- [x] TypeScript类型检查通过
- [ ] 浏览器测试通过（用户待验证）

---

**现在请重新测试**: 点击"静态策略 → 结构匹配"应该能看到模态框弹出！🎉
