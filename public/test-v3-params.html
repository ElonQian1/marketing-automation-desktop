<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V3 å‚æ•°æå–æµ‹è¯•</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        button { 
            background: #2196F3; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #1976D2; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
        }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª V3 å‚æ•°æå–ä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>æµ‹è¯•ç›®æ ‡</h3>
            <p>éªŒè¯ V3 ç³»ç»Ÿæ˜¯å¦èƒ½æ­£ç¡®æå–åµŒå¥—çš„ smartSelection å‚æ•°ç»“æ„ï¼š</p>
            <pre>params: { smartSelection: { targetText: "å·²å…³æ³¨" } }</pre>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ§åˆ¶</h3>
            <button onclick="testBasicParameterExtraction()">æµ‹è¯•åŸºæœ¬å‚æ•°æå–</button>
            <button onclick="testNestedSmartSelection()">æµ‹è¯•åµŒå¥— smartSelection</button>
            <button onclick="testParameterFallback()">æµ‹è¯•å‚æ•°å›é€€é“¾</button>
            <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        </div>

        <div id="results" class="test-section">
            <h3>æµ‹è¯•ç»“æœ</h3>
            <div id="output">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        let outputDiv;
        
        window.addEventListener('DOMContentLoaded', () => {
            outputDiv = document.getElementById('output');
        });

        function addResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-section ${statusClass}`;
            resultDiv.innerHTML = `
                <div class="status">[${timestamp}] ${message}</div>
            `;
            
            if (outputDiv.firstChild && outputDiv.firstChild.textContent.includes('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®')) {
                outputDiv.innerHTML = '';
            }
            
            outputDiv.appendChild(resultDiv);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function clearResults() {
            outputDiv.innerHTML = 'ç»“æœå·²æ¸…é™¤...';
        }

        async function testBasicParameterExtraction() {
            addResult('ğŸ§ª æµ‹è¯•åŸºæœ¬å‚æ•°æå–...');
            
            try {
                // ç›´æ¥ targetText å‚æ•°æ ¼å¼
                const basicSpec = {
                    steps: [{
                        stepId: `test-basic-${Date.now()}`,
                        stepType: "SmartSelection",
                        stepName: "åŸºæœ¬å‚æ•°æµ‹è¯•",
                        params: {
                            targetText: "å·²å…³æ³¨"
                        }
                    }],
                    mode: "intelligent",
                    threshold: 0.7,
                    orderedSteps: []
                };

                const envelope = {
                    deviceId: "test-device",
                    sessionId: `test-${Date.now()}`,
                    spec: basicSpec,
                    constraints: {
                        timeoutMs: 10000,
                        maxRetries: 1,
                        screenChangeRequired: false
                    }
                };

                addResult('ğŸ“¤ å‘é€åŸºæœ¬å‚æ•°æµ‹è¯•è¯·æ±‚...');
                
                if (typeof window.__TAURI__ === 'undefined') {
                    throw new Error('Tauri API ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿åº”ç”¨åœ¨ Tauri ç¯å¢ƒä¸­è¿è¡Œ');
                }

                const { invoke } = window.__TAURI__.core;
                const result = await invoke('execute_chain_by_inline_v3', { envelope });
                
                addResult(`âœ… åŸºæœ¬å‚æ•°æå–æˆåŠŸ: ${result.status}`, 'success');
                addResult(`ç»“æœè¯¦æƒ…: ${JSON.stringify(result, null, 2)}`);
                
            } catch (error) {
                addResult(`âŒ åŸºæœ¬å‚æ•°æå–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testNestedSmartSelection() {
            addResult('ğŸ§ª æµ‹è¯•åµŒå¥— smartSelection å‚æ•°æå–...');
            
            try {
                // åµŒå¥— smartSelection å‚æ•°æ ¼å¼ï¼ˆå‰ç«¯ V3 æ ¼å¼ï¼‰
                const nestedSpec = {
                    steps: [{
                        stepId: `test-nested-${Date.now()}`,
                        stepType: "SmartSelection",
                        stepName: "åµŒå¥—å‚æ•°æµ‹è¯•",
                        params: {
                            smartSelection: {
                                targetText: "å·²å…³æ³¨",
                                mode: "text",
                                minConfidence: 0.6,
                                batchConfig: null
                            }
                        }
                    }],
                    mode: "intelligent", 
                    threshold: 0.7,
                    orderedSteps: []
                };

                const envelope = {
                    deviceId: "test-device",
                    sessionId: `test-${Date.now()}`,
                    spec: nestedSpec,
                    constraints: {
                        timeoutMs: 10000,
                        maxRetries: 1,
                        screenChangeRequired: false
                    }
                };

                addResult('ğŸ“¤ å‘é€åµŒå¥—å‚æ•°æµ‹è¯•è¯·æ±‚...');
                addResult(`å‚æ•°ç»“æ„: ${JSON.stringify(nestedSpec.steps[0].params, null, 2)}`);
                
                if (typeof window.__TAURI__ === 'undefined') {
                    throw new Error('Tauri API ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿åº”ç”¨åœ¨ Tauri ç¯å¢ƒä¸­è¿è¡Œ');
                }

                const { invoke } = window.__TAURI__.core;
                const result = await invoke('execute_chain_by_inline_v3', { envelope });
                
                addResult(`âœ… åµŒå¥—å‚æ•°æå–æˆåŠŸ: ${result.status}`, 'success');
                
                if (result.status === 'executed') {
                    addResult('ğŸ‰ å‚æ•°æå–ä¿®å¤æˆåŠŸï¼V3 ç³»ç»Ÿæ­£ç¡®å¤„ç†äº†åµŒå¥—çš„ smartSelection ç»“æ„', 'success');
                } else {
                    addResult(`âš ï¸ æ‰§è¡ŒçŠ¶æ€: ${result.status}, æ¶ˆæ¯: ${result.message || 'æ— æ¶ˆæ¯'}`);
                }
                
                addResult(`ç»“æœè¯¦æƒ…: ${JSON.stringify(result, null, 2)}`);
                
            } catch (error) {
                addResult(`âŒ åµŒå¥—å‚æ•°æå–å¤±è´¥: ${error.message}`, 'error');
                
                if (error.message?.includes('SmartSelectionæ­¥éª¤ç¼ºå°‘targetTextå‚æ•°')) {
                    addResult('ğŸ” å‚æ•°æå–ä»æœ‰é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•', 'error');
                }
            }
        }

        async function testParameterFallback() {
            addResult('ğŸ§ª æµ‹è¯•å‚æ•°æå–å›é€€é“¾...');
            
            const testCases = [
                {
                    name: "ä½¿ç”¨ contentDesc å›é€€",
                    params: { smartSelection: { contentDesc: "å·²å…³æ³¨" } }
                },
                {
                    name: "ä½¿ç”¨ text å›é€€",
                    params: { smartSelection: { text: "å·²å…³æ³¨" } }
                },
                {
                    name: "æ··åˆå‚æ•°",
                    params: { 
                        smartSelection: { 
                            targetText: "å·²å…³æ³¨",
                            contentDesc: "å…³æ³¨æŒ‰é’®",
                            mode: "text"
                        } 
                    }
                }
            ];

            for (const testCase of testCases) {
                try {
                    addResult(`ğŸ“‹ æµ‹è¯•: ${testCase.name}`);
                    
                    const spec = {
                        steps: [{
                            stepId: `test-fallback-${Date.now()}`,
                            stepType: "SmartSelection",
                            stepName: testCase.name,
                            params: testCase.params
                        }],
                        mode: "intelligent",
                        threshold: 0.7,
                        orderedSteps: []
                    };

                    const envelope = {
                        deviceId: "test-device",
                        sessionId: `test-${Date.now()}`,
                        spec: spec,
                        constraints: {
                            timeoutMs: 5000,
                            maxRetries: 1,
                            screenChangeRequired: false
                        }
                    };

                    if (typeof window.__TAURI__ === 'undefined') {
                        throw new Error('Tauri API ä¸å¯ç”¨');
                    }

                    const { invoke } = window.__TAURI__.core;
                    const result = await invoke('execute_chain_by_inline_v3', { envelope });
                    
                    addResult(`   âœ… ${testCase.name}: ${result.status}`, 'success');
                    
                } catch (error) {
                    addResult(`   âŒ ${testCase.name}: ${error.message}`, 'error');
                }
            }
            
            addResult('ğŸ å‚æ•°å›é€€é“¾æµ‹è¯•å®Œæˆ');
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºçŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof window.__TAURI__ !== 'undefined') {
                addResult('âœ… Tauri ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª', 'success');
            } else {
                addResult('âš ï¸ æœªæ£€æµ‹åˆ° Tauri ç¯å¢ƒï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨', 'error');
            }
        });
    </script>
</body>
</html>