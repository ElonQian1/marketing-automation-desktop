# 点击规范化测试工具使用指南

## 📋 概述

点击规范化测试工具已成功集成到项目中，用于验证"点击回收+容器限域"功能。这是实现"三路自动选型总线"的第一个重要步骤。

## 🎯 功能描述

### 核心能力
- **点击回收**: 将任意点击层（如TextView、ImageView）回收到卡片根或可点父
- **容器限域**: 限定在RecyclerView容器内，避免误操作
- **瀑布流分析**: 自动识别左列/右列位置，提供列内排序信息
- **IoU碰撞检测**: 精确识别重叠元素的层次关系

### 测试命令
1. **`test_click_normalization`** - 主测试命令
   - 输入: XML内容 + 点击bounds
   - 输出: 完整规范化结果（容器、卡片根、可点父、列信息）

2. **`analyze_xml_structure`** - 辅助分析命令  
   - 输入: XML内容
   - 输出: 结构分析报告（候选节点统计、可点击统计）

## 🚀 使用方式

### 后端测试（Rust）
```bash
# 编译检查
cd src-tauri && cargo check

# 运行应用
npm run tauri dev
```

### 前端测试页面
访问测试页面：`/click-normalizer-test`

**输入示例**：
- XML内容：从设备UI Dump获取的完整XML
- 点击bounds：`100,200,300,400` （left,top,right,bottom）

**输出解析**：
- 容器节点：识别到的RecyclerView容器
- 卡片根节点：FrameLayout，clickable=false，有content-desc
- 可点父节点：FrameLayout，clickable=true  
- 原始点击节点：用户实际点击的元素
- 列信息：左列/右列，列内位置，同列卡片总数

## 📊 测试场景

### 核心测试用例
1. **正常瀑布流卡片**
   - 左列卡片点击 → 识别左列位置
   - 右列卡片点击 → 识别右列位置
   - 内部TextView点击 → 回收到卡片根

2. **边界情况**
   - 卡片边缘点击 → 容器限域保护
   - 重叠元素点击 → IoU碰撞检测
   - 异常XML结构 → 错误处理

3. **性能验证**
   - 大型XML解析速度
   - 复杂嵌套结构处理
   - 内存使用情况

## 🔧 架构集成点

### 已完成
✅ **click_normalizer.rs** - 核心算法实现  
✅ **测试命令集成** - 前后端通信  
✅ **模块导出** - structure_runtime_match模块  
✅ **类型系统** - NormalizedNode, ColumnInfo等  
✅ **错误处理** - anyhow Result模式  

### 进行中  
🔄 **三路评分器集成** - 基于规范化结果的智能评分  
🔄 **模态框UI改造** - 零配置用户体验  
🔄 **自动推荐引擎** - 策略自动选型  

### 待实施
⏳ **批量测试套件** - 自动化回归测试  
⏳ **性能监控面板** - 实时性能指标  
⏳ **学习数据采集** - 用户行为分析  

## 🎨 前端页面特性

### UI组件
- **参数输入区**: XML内容 + bounds输入
- **操作按钮**: 点击规范化测试 + XML结构分析  
- **结果展示**: 四类节点信息卡片
- **列信息面板**: 瀑布流位置可视化
- **统计信息**: 节点数量、可点击统计

### 样式规范
- **浅色主题强制**: `.light-theme-force` 类防止白底白字
- **颜色语义化**: 容器紫色、卡片根绿色、可点父橙色
- **响应式布局**: Row/Col栅格系统适配

## 📈 下一步计划

### 第一优先级：三路评分器
```rust
pub struct AutoModeSelector {
    click_normalizer: ClickNormalizer,
    subtree_scorer: SubtreeScorer,        // 子树匹配
    leaf_context_scorer: LeafContextScorer, // 叶子+上下文  
    text_exact_scorer: TextExactScorer,   // 文本精确匹配
}
```

### 第二优先级：模态框集成
- 自动调用规范化 → 评分 → 推荐
- 用户确认或一键应用
- 学习反馈循环

### 第三优先级：性能优化  
- XML解析缓存
- 规范化结果缓存
- 增量更新机制

## 🔍 调试技巧

### 常见问题排查
1. **找不到容器** → 检查XML中是否有RecyclerView
2. **找不到卡片根** → 检查FrameLayout的content-desc
3. **bounds解析错误** → 确保格式为 "left,top,right,bottom"
4. **前端通信失败** → 检查命令是否正确注册到main.rs

### 日志查看
```bash
# Rust后端日志
RUST_LOG=debug npm run tauri dev

# 前端控制台
开发者工具 → Console → 搜索 "click_normalization"
```

---

## 📝 总结

点击规范化测试工具为"三路自动选型总线"奠定了坚实基础。通过精确的点击回收和容器限域，我们能够：

1. **消除点击歧义** - 统一到卡片根层级
2. **提供上下文信息** - 瀑布流列位置、容器关系
3. **支持智能评分** - 为后续三路评分提供标准化输入
4. **保证操作安全** - 容器限域防止误操作

这标志着结构匹配系统从"手动配置"向"自动推荐"迈出的关键一步。