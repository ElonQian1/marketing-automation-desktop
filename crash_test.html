<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCF导入崩溃修复测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>VCF导入崩溃修复测试</h1>
    
    <div class="test-section info">
        <h3>测试说明</h3>
        <p>此页面用于测试VCF导入功能的崩溃修复。请确保：</p>
        <ul>
            <li>已连接至少一台Android设备</li>
            <li>准备了测试用的联系人文件</li>
            <li>设备已开启USB调试</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>步骤1: 设备选择</h3>
        <input type="text" id="deviceId" placeholder="输入设备ID (如: emulator-5554)" style="width: 200px; padding: 5px;">
        <button onclick="detectDevices()">自动检测设备</button>
        <div id="deviceList"></div>
    </div>

    <div class="test-section">
        <h3>步骤2: 选择联系人文件</h3>
        <input type="file" id="fileInput" accept=".txt,.csv,.vcf" onchange="handleFileSelect()">
        <p id="fileInfo"></p>
    </div>

    <div class="test-section">
        <h3>步骤3: 测试导入</h3>
        <button onclick="testVcfImport()" id="testBtn" disabled>开始测试导入</button>
        <button onclick="testCrashFix()" id="crashTestBtn" disabled>测试崩溃修复</button>
        <div id="testResult"></div>
    </div>

    <div class="test-section">
        <h3>日志输出</h3>
        <button onclick="clearLog()">清空日志</button>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        import { invoke } from '/tauri.js';
        
        let selectedDeviceId = '';
        let selectedFilePath = '';
        
        window.log = function(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}">${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        window.detectDevices = async function() {
            log('开始检测设备...');
            try {
                const devices = await invoke('get_adb_devices');
                const deviceList = document.getElementById('deviceList');
                if (devices && devices.length > 0) {
                    deviceList.innerHTML = '<h4>检测到的设备:</h4>';
                    devices.forEach(device => {
                        const button = document.createElement('button');
                        button.textContent = device;
                        button.onclick = () => selectDevice(device);
                        deviceList.appendChild(button);
                    });
                    log(`检测到 ${devices.length} 台设备`, 'success');
                } else {
                    deviceList.innerHTML = '<p style="color: orange;">未检测到设备，请检查USB连接和调试设置</p>';
                    log('未检测到设备', 'error');
                }
            } catch (error) {
                log(`设备检测失败: ${error}`, 'error');
                document.getElementById('deviceList').innerHTML = '<p style="color: red;">设备检测失败</p>';
            }
        };
        
        window.selectDevice = function(deviceId) {
            selectedDeviceId = deviceId;
            document.getElementById('deviceId').value = deviceId;
            log(`已选择设备: ${deviceId}`, 'success');
            updateTestButtons();
        };
        
        window.handleFileSelect = function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                selectedFilePath = file.path || file.name;
                document.getElementById('fileInfo').innerHTML = `
                    <p><strong>文件名:</strong> ${file.name}</p>
                    <p><strong>大小:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    <p><strong>类型:</strong> ${file.type || '未知'}</p>
                `;
                log(`已选择文件: ${file.name}`, 'success');
                updateTestButtons();
            }
        };
        
        function updateTestButtons() {
            const hasDevice = selectedDeviceId !== '';
            const hasFile = selectedFilePath !== '';
            document.getElementById('testBtn').disabled = !(hasDevice && hasFile);
            document.getElementById('crashTestBtn').disabled = !(hasDevice && hasFile);
        }
        
        window.testVcfImport = async function() {
            if (!selectedDeviceId || !selectedFilePath) {
                alert('请先选择设备和文件');
                return;
            }
            
            log('开始测试VCF导入...');
            document.getElementById('testBtn').disabled = true;
            
            try {
                const result = await invoke('import_vcf_contacts_async_safe', {
                    deviceId: selectedDeviceId,
                    contactsFilePath: selectedFilePath
                });
                
                const resultDiv = document.getElementById('testResult');
                if (result.success) {
                    resultDiv.className = 'test-section success';
                    resultDiv.innerHTML = `
                        <h4>✅ 导入成功！</h4>
                        <p><strong>总联系人:</strong> ${result.total_contacts}</p>
                        <p><strong>已导入:</strong> ${result.imported_contacts}</p>
                        <p><strong>失败:</strong> ${result.failed_contacts}</p>
                        <p><strong>耗时:</strong> ${result.duration || 0} 秒</p>
                        <p><strong>消息:</strong> ${result.message}</p>
                        ${result.details ? `<p><strong>详情:</strong> ${result.details}</p>` : ''}
                    `;
                    log('VCF导入成功完成', 'success');
                } else {
                    resultDiv.className = 'test-section error';
                    resultDiv.innerHTML = `
                        <h4>❌ 导入失败</h4>
                        <p><strong>错误消息:</strong> ${result.message}</p>
                        ${result.details ? `<p><strong>错误详情:</strong> ${result.details}</p>` : ''}
                    `;
                    log(`VCF导入失败: ${result.message}`, 'error');
                }
            } catch (error) {
                document.getElementById('testResult').className = 'test-section error';
                document.getElementById('testResult').innerHTML = `
                    <h4>💥 程序错误</h4>
                    <p><strong>错误:</strong> ${error}</p>
                `;
                log(`程序错误: ${error}`, 'error');
            } finally {
                document.getElementById('testBtn').disabled = false;
            }
        };
        
        window.testCrashFix = async function() {
            if (!selectedDeviceId || !selectedFilePath) {
                alert('请先选择设备和文件');
                return;
            }
            
            log('开始测试崩溃修复...');
            document.getElementById('crashTestBtn').disabled = true;
            
            try {
                const result = await invoke('test_vcf_import_crash_fix', {
                    deviceId: selectedDeviceId,
                    contactsFilePath: selectedFilePath
                });
                
                const resultDiv = document.getElementById('testResult');
                resultDiv.className = 'test-section success';
                resultDiv.innerHTML = `
                    <h4>🛡️ 崩溃修复测试</h4>
                    <p><strong>结果:</strong> ${result}</p>
                    <p>如果程序没有崩溃，说明修复有效！</p>
                `;
                log(`崩溃修复测试完成: ${result}`, 'success');
            } catch (error) {
                document.getElementById('testResult').className = 'test-section error';
                document.getElementById('testResult').innerHTML = `
                    <h4>⚠️ 崩溃修复测试</h4>
                    <p><strong>捕获到错误:</strong> ${error}</p>
                    <p>程序没有崩溃，错误被安全处理！</p>
                `;
                log(`崩溃修复测试捕获错误: ${error}`, 'error');
            } finally {
                document.getElementById('crashTestBtn').disabled = false;
            }
        };
        
        // 页面加载时自动检测设备
        window.addEventListener('load', () => {
            log('页面加载完成，可以开始测试');
            detectDevices();
        });
    </script>
</body>
</html>