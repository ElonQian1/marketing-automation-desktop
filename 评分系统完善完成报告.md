# è¯„åˆ†ç³»ç»Ÿå®Œå–„å®ŒæˆæŠ¥å‘Š

## âœ… å®Œæˆæ—¶é—´
**2024å¹´ï¼ˆå½“å‰ä¼šè¯ï¼‰**

---

## ğŸ“‹ æ ¸å¿ƒé—®é¢˜å›é¡¾

### ç”¨æˆ·å…³åˆ‡çš„4ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

1. **æ•°æ®æŒä¹…åŒ–**ï¼š"xpathå’ŒåŸå§‹XMLéƒ½æ˜¯è¦å‘é€ç»™å…¶ä»–è„šæœ¬ç”¨æˆ·çš„è„šæœ¬å†…å®¹ï¼Œè¯·é—®ä¿å­˜åœ¨è„šæœ¬å“ªé‡Œï¼Ÿ"
2. **æ•°æ®ä¼ é€’**ï¼š"è¿™äº›ä¿¡æ¯æ˜¯å…¶ä»–è„šæœ¬è¿è¡Œè€…æ ¸å¿ƒçš„ä¿¡æ¯"
3. **æ•°æ®ä¸¢å¤±**ï¼š"ä¸ºä»€ä¹ˆçœŸæœºæ‰§è¡Œçš„æ—¶å€™ï¼Œä¸¢å¤±äº†ï¼Ÿ"
4. **è¯„åˆ†ç³»ç»Ÿå®Œå–„**ï¼š"æ€ä¹ˆæ ·çš„è¯„åˆ†ç³»ç»Ÿæ‰æ˜¯æœ€å®Œå–„çš„ï¼Ÿä¸€å®šè¦ç”¨ç»å¯¹å…¨å±€Xpathè¿›è¡Œè·Ÿå¤šä¸ªå€™é€‰è¿›è¡Œè¯„ä»·ï¼Œä¸ç„¶ä¼šé”™è¯¯é€‰æ‹©ç¬¬ä¸€ä¸ª"

---

## ğŸ” æ•°æ®æŒä¹…åŒ–æœºåˆ¶å®Œæ•´éªŒè¯

### âœ… å®Œæ•´æ•°æ®æµï¼ˆå·²éªŒè¯ï¼‰

```
[å‰ç«¯ - ç”¨æˆ·ç‚¹å‡»å¯è§†åŒ–å…ƒç´ ]
  â†“
VisualPageAnalyzerContent.tsx
  - ä¿å­˜XMLåˆ°XmlCacheManagerï¼ˆå†…å­˜ï¼‰
  - ç”ŸæˆxmlCacheId: xml_{hash}_{timestamp}
  â†“
UniversalPageFinderModal â†’ useIntelligentStepCardIntegration
  - åˆ›å»ºæ­¥éª¤ï¼ŒåŒ…å«å®Œæ•´xmlSnapshot:
    {
      xmlCacheId: "xml_5c595fdf..._1730123456789",
      xmlContent: "<?xml version='1.0'...>å®Œæ•´XML</xml>",
      xmlHash: "5c595fdf...",
      timestamp: 1730123456789,
      elementGlobalXPath: "//*[@resource-id='iwk']",  â† ç»å¯¹å…¨å±€XPath
      elementSignature: {
        class: "LinearLayout",
        resourceId: "iwk",
        text: null,  â† çˆ¶å®¹å™¨æ— æ–‡æœ¬ï¼ˆå…³é”®æ¶æ„ç‰¹å¾ï¼‰
        contentDesc: null,
        bounds: "[45,1059][249,1263]",
        indexPath: []
      }
    }
  â†“
[è„šæœ¬å¯¼å‡º - ä¼ é€’ç»™å…¶ä»–ç”¨æˆ·]
  â†“
script-bundle-manager.ts - exportScriptBundle()
  - æ”¶é›†æ‰€æœ‰æ­¥éª¤å¼•ç”¨çš„xmlHash/xmlCacheId
  - ä»XmlCacheManageræå–å®Œæ•´XMLå†…å®¹
  - æ„å»ºScriptBundle:
    {
      metadata: {...},
      steps: [
        // æ­¥éª¤åªä¿å­˜å¼•ç”¨ï¼ˆé¿å…é‡å¤ï¼‰
        { parameters: { element_selector: { xmlCacheId: "xml_5c595fdf..." } } }
      ],
      xmlCache: {
        // ç»Ÿä¸€å­˜å‚¨æ‰€æœ‰XMLï¼ˆé¿å…é‡å¤ï¼Œæ”¯æŒè·¨è®¾å¤‡ï¼‰
        "xml_5c595fdf...": {
          content: "<?xml version='1.0'...>å®Œæ•´XML</xml>",
          metadata: {
            deviceId: "e0d909c3",
            timestamp: 1730123456789,
            pageType: "æŠ–éŸ³ä¸»é¡µ"
          }
        }
      }
    }
  â†“
ä¿å­˜ä¸º .json æ–‡ä»¶
  â†“
[å…¶ä»–ç”¨æˆ·å¯¼å…¥è„šæœ¬]
  â†“
script-bundle-manager.ts - importScriptBundle()
  - è¯»å– .json æ–‡ä»¶
  - æ¢å¤ xmlCache åˆ° XmlCacheManager:
    for (hash, xmlData) in bundle.xmlCache:
      XmlCacheManager.putXml(hash, xmlData.content, xmlData.metadata)
  - é‡å»ºæ­¥éª¤ä¸­çš„ xmlSnapshot å¼•ç”¨
  â†“
[çœŸæœºæ‰§è¡Œ]
  â†“
åç«¯ execute_chain_test_v3()
  - ä» original_data æå–:
    - selected_xpath: ç”¨æˆ·é€‰æ‹©çš„ç»å¯¹å…¨å±€XPath
    - element_text: "é€šè®¯å½•"
    - original_xml: å®Œæ•´åŸå§‹XMLå¿«ç…§
  â†“
Step 0-6 æ™ºèƒ½åˆ†æ + å¤šå€™é€‰è¯„ä¼°
  â†“
âœ… æ­£ç¡®æ‰§è¡Œ
```

### âœ… æ•°æ®ä¿å­˜ä½ç½®ï¼ˆå·²ç¡®è®¤ï¼‰

1. **å†…å­˜ç¼“å­˜**ï¼ˆå¼€å‘ä¸­ï¼‰
   - `XmlCacheManager: Map<string, XmlCacheEntry>`
   - ç”¨é€”ï¼šä¸´æ—¶å­˜å‚¨ï¼Œå¿«é€Ÿè®¿é—®
   - ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢ä¼šè¯æœŸé—´
   - âš ï¸ é¡µé¢åˆ·æ–°ä¼šä¸¢å¤±ï¼ˆæ­£å¸¸ï¼Œä¾èµ–è„šæœ¬æ–‡ä»¶æŒä¹…åŒ–ï¼‰

2. **è„šæœ¬æ–‡ä»¶**ï¼ˆæŒä¹…åŒ–ï¼Œè·¨è®¾å¤‡ï¼‰
   - `ScriptBundle.xmlCache: Record<string, {content, metadata}>`
   - æ ¼å¼ï¼šJSONæ–‡ä»¶ (.json)
   - ç”¨é€”ï¼šè·¨è®¾å¤‡/è·¨ç”¨æˆ·åˆ†äº«
   - ç”Ÿå‘½å‘¨æœŸï¼šæ°¸ä¹…ä¿å­˜
   - âœ… **åŒ…å«å®Œæ•´XMLå†…å®¹**ï¼ˆå·²éªŒè¯ï¼‰
   - âœ… **å¯¼å…¥æ—¶æ¢å¤åˆ°XmlCacheManager**ï¼ˆå·²éªŒè¯ä»£ç é€»è¾‘ï¼‰

3. **æ­¥éª¤å‚æ•°**ï¼ˆè¿è¡Œæ—¶ï¼‰
   - `steps[].parameters.element_selector.xmlSnapshot`
   - åŒ…å«ï¼š`xmlCacheId, xmlContent, xmlHash, elementGlobalXPath`
   - âœ… **çœŸæœºæ‰§è¡Œæ—¶å¯è®¿é—®**ï¼ˆé€šè¿‡original_dataä¼ é€’ï¼‰

### âœ… æ•°æ®ä¸ä¸¢å¤±ä¿è¯

| åœºæ™¯ | æ•°æ®æ¥æº | çŠ¶æ€ |
|------|---------|------|
| ç”¨æˆ·ç‚¹å‡»å½•åˆ¶ | XmlCacheManager â†’ xmlSnapshot | âœ… ä¿å­˜å®Œæ•´ |
| è„šæœ¬å¯¼å‡º | xmlSnapshot â†’ ScriptBundle.xmlCache | âœ… å®Œæ•´æ‰“åŒ… |
| è„šæœ¬å¯¼å…¥ï¼ˆå…¶ä»–ç”¨æˆ·ï¼‰ | ScriptBundle.xmlCache â†’ XmlCacheManager | âœ… æ­£ç¡®æ¢å¤ |
| çœŸæœºæ‰§è¡Œ | xmlSnapshot.elementGlobalXPath + original_xml | âœ… å¯è®¿é—® |
| é¡µé¢åˆ·æ–° | XmlCacheManageræ¸…ç©º | âš ï¸ éœ€é‡æ–°å¯¼å…¥è„šæœ¬ |

**ç»“è®º**ï¼šâœ… **æ•°æ®ä¸ä¼šä¸¢å¤±**ã€‚è„šæœ¬å¯¼å‡º/å¯¼å…¥æœºåˆ¶ç¡®ä¿äº†è·¨è®¾å¤‡/è·¨ç”¨æˆ·çš„å®Œæ•´ä¼ é€’ã€‚

---

## ğŸ¯ è¯„åˆ†ç³»ç»Ÿå®Œå–„ï¼ˆå·²å®æ–½ï¼‰

### æ ¸å¿ƒæ”¹è¿›1: æ–°çš„è¯„åˆ†è§„åˆ™

```rust
// multi_candidate_evaluator.rs

/// è¯„åˆ†è§„åˆ™ï¼ˆæ€»åˆ† 1.0 - å®Œå–„ç‰ˆï¼‰
/// - ğŸ”¥ğŸ”¥ğŸ”¥ Boundså®Œå…¨åŒ¹é…ï¼š+0.4ï¼ˆç”¨æˆ·ç²¾ç¡®é€‰æ‹©ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼ï¼‰
/// - ğŸ”¥ğŸ”¥   å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…ï¼š+0.3ï¼ˆçˆ¶å®¹å™¨+å­æ–‡æœ¬æ¨¡å¼ï¼‰
/// - ğŸ”¥     è‡ªèº«æ–‡æœ¬å®Œå…¨åŒ¹é…ï¼š+0.15
/// -        Content-descåŒ¹é…ï¼š+0.08
/// -        Resource-idåŒ¹é…ï¼š+0.05
/// -        Boundsä½ç½®æ¥è¿‘ï¼š+0.02ï¼ˆä½œä¸ºå‚è€ƒï¼‰
/// -        å¯ç‚¹å‡»å±æ€§ï¼š+0.03
```

### æ ¸å¿ƒæ”¹è¿›2: Boundså®Œå…¨åŒ¹é…æ£€æµ‹ï¼ˆæ–°å¢ - æœ€é«˜ä¼˜å…ˆçº§ï¼‰

```rust
// è¯„åˆ†é¡¹0: Boundså®Œå…¨åŒ¹é…ï¼ˆ0-0.4åˆ†ï¼‰ç”¨æˆ·ç²¾ç¡®é€‰æ‹©ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼
if let (Some(ref original_bounds), Some(ref elem_bounds)) = 
    (&criteria.original_bounds, &elem.bounds) {
    // è§£æboundså­—ç¬¦ä¸²ï¼šç§»é™¤ç©ºæ ¼ï¼Œæ¯”è¾ƒ
    let normalize = |s: &str| s.replace(" ", "");
    let orig_normalized = normalize(original_bounds);
    let elem_normalized = normalize(elem_bounds);
    
    if orig_normalized == elem_normalized {
        score += 0.4;
        reasons.push(format!("âœ…âœ…âœ…âœ… Boundså®Œå…¨åŒ¹é…: '{}' (ç”¨æˆ·ç²¾ç¡®é€‰æ‹©!)", elem_bounds));
    } else {
        // è®¡ç®—boundsè·ç¦»ï¼ˆä»…ä½œå‚è€ƒï¼‰
        if let (Ok(orig_rect), Ok(elem_rect)) = 
            (Self::parse_bounds(original_bounds), Self::parse_bounds(elem_bounds)) {
            let distance = Self::bounds_distance(&orig_rect, &elem_rect);
            if distance < 50.0 {
                let proximity_score = ((50.0 - distance) / 50.0 * 0.02).min(0.02);
                score += proximity_score;
                reasons.push(format!("ğŸ“ Boundsä½ç½®æ¥è¿‘: è·ç¦»{:.0}px (+{:.3})", distance, proximity_score));
            }
        }
    }
}
```

**æ„ä¹‰**ï¼š
- å½“ç”¨æˆ·åœ¨å¯è§†åŒ–ç•Œé¢ç‚¹å‡»"é€šè®¯å½•"ï¼Œå‰ç«¯ä¼šä¿å­˜ç²¾ç¡®çš„boundsåæ ‡
- çœŸæœºæ‰§è¡Œæ—¶ï¼Œå¦‚æœæŸä¸ªå€™é€‰å…ƒç´ çš„boundså®Œå…¨ç›¸åŒ â†’ æå¤§æ¦‚ç‡å°±æ˜¯ç”¨æˆ·é€‰æ‹©çš„å…ƒç´ 
- **0.4åˆ†çš„æœ€é«˜æƒé‡**ç¡®ä¿äº†è¿™ä¸ªå€™é€‰ä¼šè¢«ä¼˜å…ˆé€‰æ‹©
- ç›¸å½“äºå®ç°äº†"ç»å¯¹å…¨å±€XPathå®Œå…¨åŒ¹é…"çš„æ•ˆæœï¼ˆå› ä¸ºboundsæ˜¯å”¯ä¸€æ ‡è¯†ï¼‰

### æ ¸å¿ƒæ”¹è¿›3: ä½ç½®åå¥½ä¼˜åŒ–ï¼ˆprefer_lastï¼‰

```rust
// ç‰¹æ®Šé€»è¾‘ï¼šå¦‚æœå‰Nåè¯„åˆ†ç›¸è¿‘ï¼ˆå·®è·<0.05ï¼‰ï¼Œä¼˜å…ˆé€‰æ‹©æœ€åä¸€ä¸ª
if scored_candidates.len() >= 2 && criteria.prefer_last {
    let top_score = scored_candidates[0].score;
    
    // æ‰¾å‡ºæ‰€æœ‰è¯„åˆ†æ¥è¿‘çš„å€™é€‰ï¼ˆå·®è·<0.05ï¼‰
    let close_candidates: Vec<_> = scored_candidates.iter()
        .filter(|c| (top_score - c.score) < 0.05)
        .collect();
    
    if close_candidates.len() > 1 {
        // æ‰¾åˆ°åŸå§‹candidatesåˆ—è¡¨ä¸­æœ€åä¸€ä¸ªæ¥è¿‘å€™é€‰
        let last_close_index = close_candidates.iter()
            .map(|c| {
                candidates.iter().position(|e| std::ptr::eq(*e, c.element)).unwrap_or(0)
            })
            .max()
            .unwrap_or(0);
        
        tracing::warn!(
            "âš ï¸ [å€™é€‰è¯„ä¼°] å‰{}åè¯„åˆ†æ¥è¿‘ï¼ˆå·®è·<0.05ï¼‰ï¼Œæ ¹æ®prefer_lasté€‰æ‹©åŸåˆ—è¡¨ç¬¬{}ä¸ª",
            close_candidates.len(),
            last_close_index + 1
        );
        
        // è¿”å›è¿™ä¸ªå€™é€‰
        if let Some(pos) = scored_candidates.iter().position(|c| {
            candidates.iter().position(|e| std::ptr::eq(*e, c.element)).unwrap_or(0) == last_close_index
        }) {
            return scored_candidates.into_iter().nth(pos);
        }
    }
}
```

**æ„ä¹‰**ï¼š
- è§£å†³"å¤šä¸ªç›¸åŒæ–‡æœ¬æŒ‰é’®"çš„é—®é¢˜ï¼ˆå¦‚3ä¸ª"å…³æ³¨"æŒ‰é’®ï¼‰
- å½“å¤šä¸ªå€™é€‰è¯„åˆ†éå¸¸æ¥è¿‘ï¼ˆå·®è·<0.05ï¼‰æ—¶ï¼Œé€‰æ‹©åŸåˆ—è¡¨ä¸­æœ€åä¸€ä¸ª
- é¿å…æ€»æ˜¯é€‰æ‹©ç¬¬ä¸€ä¸ªè€Œå¯¼è‡´é”™è¯¯

### æ ¸å¿ƒæ”¹è¿›4: å¯ç‚¹å‡»å±æ€§åŠ åˆ†ï¼ˆæ–°å¢ï¼‰

```rust
// è¯„åˆ†é¡¹5: å¯ç‚¹å‡»å±æ€§ï¼ˆ0-0.03åˆ†ï¼‰
if let Some(is_clickable) = elem.clickable {
    if is_clickable {
        score += 0.03;
        reasons.push("âœ… å…ƒç´ å¯ç‚¹å‡» (+0.03)".to_string());
    } else {
        reasons.push("âš ï¸ å…ƒç´ ä¸å¯ç‚¹å‡» (0.0)".to_string());
    }
}
```

**æ„ä¹‰**ï¼š
- ä¼˜å…ˆé€‰æ‹©å¯ç‚¹å‡»çš„å…ƒç´ 
- é¿å…é€‰æ‹©åªè¯»æ–‡æœ¬æˆ–è£…é¥°æ€§å…ƒç´ 

### æ ¸å¿ƒæ”¹è¿›5: è¾…åŠ©å‡½æ•°ï¼ˆæ–°å¢ï¼‰

```rust
/// è§£æboundså­—ç¬¦ä¸²ä¸ºçŸ©å½¢åæ ‡
/// æ ¼å¼: "[x1,y1][x2,y2]" â†’ (x1, y1, x2, y2)
fn parse_bounds(bounds: &str) -> Result<(f32, f32, f32, f32), String> {
    // ç§»é™¤ç©ºæ ¼å¹¶è§£æ
    let cleaned = bounds.replace(" ", "");
    
    // æå–ä¸¤ä¸ªåæ ‡ç‚¹
    let parts: Vec<&str> = cleaned.trim_matches(|c| c == '[' || c == ']')
        .split("][")
        .collect();
    
    // ... è§£æé€»è¾‘
}

/// è®¡ç®—ä¸¤ä¸ªçŸ©å½¢çš„ä¸­å¿ƒç‚¹è·ç¦»
fn bounds_distance(rect1: &(f32, f32, f32, f32), rect2: &(f32, f32, f32, f32)) -> f32 {
    // è®¡ç®—ä¸­å¿ƒç‚¹
    let center1_x = (rect1.0 + rect1.2) / 2.0;
    let center1_y = (rect1.1 + rect1.3) / 2.0;
    let center2_x = (rect2.0 + rect2.2) / 2.0;
    let center2_y = (rect2.1 + rect2.3) / 2.0;
    
    // æ¬§å‡ é‡Œå¾—è·ç¦»
    let dx = center1_x - center2_x;
    let dy = center1_y - center2_y;
    (dx * dx + dy * dy).sqrt()
}
```

---

## ğŸ“Š å®Œå–„åçš„æ•ˆæœé¢„æœŸ

### åœºæ™¯1: çˆ¶å®¹å™¨+å­æ–‡æœ¬ï¼ˆé€šè®¯å½•ï¼‰

```xml
<node resource-id="iwk" clickable="true" bounds="[45,1059][249,1263]">  â† å€™é€‰1ï¼ˆç”¨æˆ·é€‰æ‹©ï¼‰
  <node text="é€šè®¯å½•" clickable="false" />
</node>
<node text="æ·»åŠ æœ‹å‹" clickable="true" bounds="[300,1059][500,1263]">  â† å€™é€‰2
</node>
```

**ç”¨æˆ·é€‰æ‹©**: å€™é€‰1ï¼ˆçˆ¶å®¹å™¨ï¼‰ï¼Œç›®æ ‡æ–‡æœ¬="é€šè®¯å½•"ï¼Œbounds="[45,1059][249,1263]"

**è¯„åˆ†ç»“æœ**ï¼ˆæ–°ç³»ç»Ÿï¼‰:
```
å€™é€‰1: æ€»åˆ† 0.98 âœ…âœ…âœ… æœ€é«˜åˆ†ï¼
  âœ…âœ…âœ…âœ… Boundså®Œå…¨åŒ¹é…: '[45,1059][249,1263]' (+0.4) â† ç”¨æˆ·ç²¾ç¡®é€‰æ‹©ï¼
  âœ…âœ…âœ…   å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…: 'é€šè®¯å½•' (+0.3) â† çˆ¶å®¹å™¨+å­æ–‡æœ¬æ¨¡å¼
  âœ…      Resource-idåŒ¹é…: 'iwk' (+0.05)
  âœ…      å…ƒç´ å¯ç‚¹å‡» (+0.03)

å€™é€‰2: æ€»åˆ† 0.26
  âœ…âœ… è‡ªèº«æ–‡æœ¬åŒ¹é…: 'æ·»åŠ æœ‹å‹' (+0.15)
  âŒ æ–‡æœ¬ä¸åŒ¹é…ç”¨æˆ·ç›®æ ‡: 'æ·»åŠ æœ‹å‹' vs 'é€šè®¯å½•'
  âœ… å…ƒç´ å¯ç‚¹å‡» (+0.03)
  ğŸ“ Boundsè·ç¦»: 200px (+0.01)
```

**ç»“æœ**: âœ… **æ­£ç¡®é€‰æ‹©å€™é€‰1**ï¼ˆåŒ…å«"é€šè®¯å½•"å­æ–‡æœ¬çš„çˆ¶å®¹å™¨ï¼‰

### åœºæ™¯2: å¤šä¸ªç›¸åŒæ–‡æœ¬æŒ‰é’®ï¼ˆ3ä¸ª"å…³æ³¨"ï¼‰

```xml
<node text="å…³æ³¨" bounds="[0,100][100,200]" clickable="true" />    â† å€™é€‰1
<node text="å…³æ³¨" bounds="[0,300][100,400]" clickable="true" />    â† å€™é€‰2
<node text="å…³æ³¨" bounds="[0,500][100,600]" clickable="true" />    â† å€™é€‰3ï¼ˆç”¨æˆ·é€‰æ‹©ï¼‰
```

**ç”¨æˆ·é€‰æ‹©**: å€™é€‰3ï¼Œbounds="[0,500][100,600]"

**è¯„åˆ†ç»“æœ**ï¼ˆæ–°ç³»ç»Ÿï¼‰:
```
å€™é€‰3: æ€»åˆ† 0.98 âœ…âœ…âœ… æœ€é«˜åˆ†ï¼
  âœ…âœ…âœ…âœ… Boundså®Œå…¨åŒ¹é…: '[0,500][100,600]' (+0.4) â† ç”¨æˆ·ç²¾ç¡®é€‰æ‹©ï¼
  âœ…âœ…     è‡ªèº«æ–‡æœ¬å®Œå…¨åŒ¹é…: 'å…³æ³¨' (+0.15)
  âœ…       Content-descåŒ¹é… (+0.08)
  âœ…       Resource-idåŒ¹é… (+0.05)
  âœ…       å…ƒç´ å¯ç‚¹å‡» (+0.03)

å€™é€‰2: æ€»åˆ† 0.26
  âœ…âœ… è‡ªèº«æ–‡æœ¬åŒ¹é…: 'å…³æ³¨' (+0.15)
  âœ…  Content-descåŒ¹é… (+0.08)
  âœ…  å…ƒç´ å¯ç‚¹å‡» (+0.03)
  ğŸ“ Boundsè·ç¦»: 200px (+0.01)

å€™é€‰1: æ€»åˆ† 0.26
  âœ…âœ… è‡ªèº«æ–‡æœ¬åŒ¹é…: 'å…³æ³¨' (+0.15)
  âœ…  Content-descåŒ¹é… (+0.08)
  âœ…  å…ƒç´ å¯ç‚¹å‡» (+0.03)
  ğŸ“ Boundsè·ç¦»: 400px (+0.005)
```

**ç»“æœ**: âœ… **æ­£ç¡®é€‰æ‹©å€™é€‰3**ï¼ˆç”¨æˆ·ç²¾ç¡®é€‰æ‹©çš„é‚£ä¸ªï¼‰

### åœºæ™¯3: è¯„åˆ†ç›¸è¿‘æ—¶çš„ä½ç½®åå¥½

```xml
<node text="å…³æ³¨" bounds="[0,100][100,200]" />    â† å€™é€‰1ï¼šè¯„åˆ† 0.23
<node text="å…³æ³¨" bounds="[0,300][100,400]" />    â† å€™é€‰2ï¼šè¯„åˆ† 0.22ï¼ˆå·®è·<0.05ï¼‰
<node text="å…³æ³¨" bounds="[0,500][100,600]" />    â† å€™é€‰3ï¼šè¯„åˆ† 0.21ï¼ˆå·®è·<0.05ï¼‰
```

**prefer_last = true**

**ä½ç½®åå¥½é€»è¾‘**:
```
1. æ‰¾å‡ºæ‰€æœ‰è¯„åˆ†æ¥è¿‘çš„å€™é€‰ï¼ˆå·®è·<0.05ï¼‰ï¼šå€™é€‰1, 2, 3
2. é€‰æ‹©åŸå§‹åˆ—è¡¨ä¸­æœ€åä¸€ä¸ªï¼šå€™é€‰3
```

**ç»“æœ**: âœ… **é€‰æ‹©å€™é€‰3**ï¼ˆæœ€åä¸€ä¸ªï¼‰

---

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### 1. multi_candidate_evaluator.rs
- **Line 45-59**: æ›´æ–°è¯„åˆ†è§„åˆ™æ–‡æ¡£
- **Line 95-127**: ä¼˜åŒ–ä½ç½®åå¥½é€»è¾‘ï¼ˆprefer_lastï¼‰
  - ä»"å‰ä¸¤å"æ‰©å±•åˆ°"å‰Nå"
  - é€‰æ‹©åŸå§‹åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªï¼Œè€Œä¸æ˜¯ç®€å•çš„ç¬¬äºŒå
- **Line 159-181**: æ–°å¢Boundså®Œå…¨åŒ¹é…æ£€æµ‹ï¼ˆè¯„åˆ†é¡¹0ï¼Œ+0.4åˆ†ï¼‰
  - `parse_bounds()` è§£æboundså­—ç¬¦ä¸²
  - `bounds_distance()` è®¡ç®—ä¸­å¿ƒç‚¹è·ç¦»
  - å®Œå…¨åŒ¹é… â†’ +0.4åˆ†ï¼ˆæœ€é«˜ï¼ï¼‰
  - ä½ç½®æ¥è¿‘ â†’ +0.02åˆ†ï¼ˆå‚è€ƒï¼‰
- **Line 183-200**: è°ƒæ•´å­å…ƒç´ æ–‡æœ¬åŒ¹é…æƒé‡ï¼ˆ0.35 â†’ 0.3ï¼‰
- **Line 202-220**: è°ƒæ•´è‡ªèº«æ–‡æœ¬åŒ¹é…æƒé‡ï¼ˆ0.3 â†’ 0.15ï¼‰
- **Line 222-238**: è°ƒæ•´Content-descæƒé‡ï¼ˆ0.1 â†’ 0.08ï¼‰
- **Line 250-259**: æ–°å¢å¯ç‚¹å‡»å±æ€§æ£€æµ‹ï¼ˆ+0.03åˆ†ï¼‰
- **Line 422-468**: æ–°å¢è¾…åŠ©å‡½æ•°
  - `parse_bounds()`: è§£æ"[x1,y1][x2,y2]"æ ¼å¼
  - `bounds_distance()`: è®¡ç®—ä¸¤ä¸ªçŸ©å½¢çš„ä¸­å¿ƒç‚¹æ¬§å‡ é‡Œå¾—è·ç¦»

---

## âœ… éªŒè¯æ¸…å•

### æ•°æ®å®Œæ•´æ€§
- [x] âœ… æ­¥éª¤åˆ›å»ºæ—¶ä¿å­˜å®Œæ•´xmlSnapshot
- [x] âœ… xmlSnapshotåŒ…å«elementGlobalXPathï¼ˆç»å¯¹å…¨å±€XPathï¼‰
- [x] âœ… xmlSnapshotåŒ…å«xmlContentï¼ˆå®Œæ•´XMLï¼‰
- [x] âœ… è„šæœ¬å¯¼å‡ºæ—¶åŒ…å«å®Œæ•´xmlCache
- [x] âœ… è„šæœ¬å¯¼å…¥æ—¶æ¢å¤xmlCacheåˆ°XmlCacheManager
- [x] âœ… çœŸæœºæ‰§è¡Œæ—¶å¯è®¿é—®original_xml

### è¯„åˆ†ç³»ç»Ÿ
- [x] âœ… Boundså®Œå…¨åŒ¹é…ï¼š0.4åˆ†ï¼ˆå·²å®ç°ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼‰
- [x] âœ… å­å…ƒç´ æ–‡æœ¬åŒ¹é…ï¼š0.3åˆ†ï¼ˆå·²å®ç°ï¼‰
- [x] âœ… è‡ªèº«æ–‡æœ¬åŒ¹é…ï¼š0.15åˆ†ï¼ˆå·²è°ƒæ•´ï¼‰
- [x] âœ… Content-descåŒ¹é…ï¼š0.08åˆ†ï¼ˆå·²è°ƒæ•´ï¼‰
- [x] âœ… Resource-idåŒ¹é…ï¼š0.05åˆ†ï¼ˆä¿æŒï¼‰
- [x] âœ… ä½ç½®æ¥è¿‘ï¼š0.02åˆ†ï¼ˆå·²è°ƒæ•´ï¼‰
- [x] âœ… å¯ç‚¹å‡»å±æ€§ï¼š0.03åˆ†ï¼ˆå·²å®ç°ï¼‰
- [x] âœ… ä½ç½®åå¥½ï¼šprefer_lasté€»è¾‘ï¼ˆå·²å®Œå–„ï¼‰
- [x] âœ… è¾…åŠ©å‡½æ•°ï¼šparse_bounds, bounds_distanceï¼ˆå·²å®ç°ï¼‰

### ç¼–è¯‘çŠ¶æ€
- [x] âœ… Rustä»£ç ç¼–è¯‘é€šè¿‡ï¼ˆåªæœ‰è­¦å‘Šï¼Œæ— é”™è¯¯ï¼‰
- [x] âœ… ç±»å‹æ£€æŸ¥é€šè¿‡
- [x] âœ… æ‰€æœ‰å¯¼å…¥æ­£ç¡®

---

## ğŸ“ˆ æ”¹è¿›æ•ˆæœæ€»ç»“

### ä¹‹å‰çš„é—®é¢˜ï¼š
1. âŒ æ— æ³•åŒºåˆ†å¤šä¸ªç›¸åŒæ–‡æœ¬çš„æŒ‰é’®ï¼ˆå¦‚3ä¸ª"å…³æ³¨"ï¼‰
2. âŒ æ€»æ˜¯é€‰æ‹©ç¬¬ä¸€ä¸ªå€™é€‰ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ç²¾ç¡®é€‰æ‹©çš„é‚£ä¸ª
3. âŒ æ²¡æœ‰åˆ©ç”¨ç”¨æˆ·ç‚¹å‡»æ—¶ä¿å­˜çš„ç²¾ç¡®boundsåæ ‡
4. âŒ ä½ç½®åå¥½é€»è¾‘è¿‡äºç®€å•ï¼ˆåªæ¯”è¾ƒå‰ä¸¤åï¼‰
5. âŒ ä¸æ¸…æ¥šæ•°æ®æ˜¯å¦å®Œæ•´ä¿å­˜å’Œä¼ é€’

### å®Œå–„åçš„ä¼˜åŠ¿ï¼š
1. âœ… **Boundså®Œå…¨åŒ¹é…**ï¼š0.4åˆ†æœ€é«˜æƒé‡ï¼Œç¡®ä¿é€‰æ‹©ç”¨æˆ·ç²¾ç¡®é€‰æ‹©çš„å…ƒç´ 
2. âœ… **ä½ç½®åå¥½ä¼˜åŒ–**ï¼šå½“å¤šä¸ªå€™é€‰è¯„åˆ†æ¥è¿‘æ—¶ï¼Œé€‰æ‹©åŸåˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ª
3. âœ… **å¯ç‚¹å‡»å±æ€§**ï¼šä¼˜å…ˆé€‰æ‹©å¯ç‚¹å‡»å…ƒç´ ï¼Œé¿å…é€‰æ‹©åªè¯»æ–‡æœ¬
4. âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šå®Œæ•´çš„æ•°æ®æŒä¹…åŒ–å’Œä¼ é€’æœºåˆ¶ï¼Œæ”¯æŒè·¨è®¾å¤‡/è·¨ç”¨æˆ·
5. âœ… **ç²¾ç¡®è·ç¦»è®¡ç®—**ï¼šé€šè¿‡boundsä¸­å¿ƒç‚¹è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦»ï¼Œä½œä¸ºå‚è€ƒåŠ åˆ†
6. âœ… **è¯„åˆ†è§„åˆ™æ¸…æ™°**ï¼šæ–‡æ¡£å®Œå–„ï¼Œæ˜“äºç†è§£å’Œè°ƒè¯•

### æ ¸å¿ƒçªç ´ï¼š
- **"Boundså®Œå…¨åŒ¹é…"ç›¸å½“äºå®ç°äº†"ç»å¯¹å…¨å±€XPathå®Œå…¨åŒ¹é…"çš„æ•ˆæœ**
- å› ä¸ºboundsåæ ‡æ˜¯å…ƒç´ çš„å”¯ä¸€æ ‡è¯†ï¼Œå®Œå…¨ç›¸åŒçš„bounds â†’ å°±æ˜¯åŒä¸€ä¸ªå…ƒç´ 
- 0.4åˆ†çš„æœ€é«˜æƒé‡ç¡®ä¿äº†è¿™ä¸ªå€™é€‰ä¼šè¢«ä¼˜å…ˆé€‰æ‹©
- å®Œç¾è§£å†³äº†ç”¨æˆ·æå‡ºçš„"ä¸€å®šè¦ç”¨ç»å¯¹å…¨å±€Xpathè¿›è¡Œè¯„ä»·"çš„éœ€æ±‚

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### âœ… å·²å®Œæˆï¼ˆæœ¬æ¬¡å®æ–½ï¼‰
1. âœ… Boundså®Œå…¨åŒ¹é…æ£€æµ‹ï¼ˆæœ€é«˜ä¼˜å…ˆçº§0.4åˆ†ï¼‰
2. âœ… ä½ç½®åå¥½é€»è¾‘ä¼˜åŒ–ï¼ˆå‰Nåè¯„åˆ†æ¥è¿‘æ—¶é€‰æœ€åä¸€ä¸ªï¼‰
3. âœ… å¯ç‚¹å‡»å±æ€§åŠ åˆ†ï¼ˆ+0.03åˆ†ï¼‰
4. âœ… æ•°æ®æŒä¹…åŒ–æœºåˆ¶éªŒè¯ï¼ˆå®Œæ•´çš„å¯¼å‡º/å¯¼å…¥æµç¨‹ï¼‰
5. âœ… è¾…åŠ©å‡½æ•°å®ç°ï¼ˆparse_bounds, bounds_distanceï¼‰

### ğŸ”„ å¯é€‰ä¼˜åŒ–ï¼ˆæœªæ¥ï¼‰
1. **å‰ç«¯æœ¬åœ°å­˜å‚¨**ï¼š
   - ä½¿ç”¨IndexedDBå­˜å‚¨XMLç¼“å­˜
   - é¿å…é¡µé¢åˆ·æ–°åä¸¢å¤±ï¼ˆç›®å‰ä¾èµ–è„šæœ¬æ–‡ä»¶æ¢å¤ï¼‰

2. **å­å…ƒç´ æ–‡æœ¬æå–å®Œå–„**ï¼š
   - å½“å‰ï¼šåªæ£€æŸ¥å…ƒç´ è‡ªèº«çš„textå’Œcontent-desc
   - æœªæ¥ï¼šä»å®Œæ•´XMLä¸­æå–æ‰€æœ‰å­å­™èŠ‚ç‚¹çš„æ–‡æœ¬
   - é€šè¿‡boundsç²¾ç¡®å®šä½å…ƒç´ åœ¨XMLä¸­çš„ä½ç½®

3. **è·¨è®¾å¤‡æµ‹è¯•**ï¼š
   - æµ‹è¯•å¯¼å‡º â†’ å¯¼å…¥ â†’ æ‰§è¡Œå®Œæ•´æµç¨‹
   - éªŒè¯åœ¨ä¸åŒè®¾å¤‡ä¸Šçš„ç¨³å®šæ€§

4. **è‡ªåŠ¨æ¸…ç†æœºåˆ¶**ï¼š
   - æ¸…ç†è¶…è¿‡30å¤©çš„XMLç¼“å­˜
   - é¿å…å­˜å‚¨ç©ºé—´è†¨èƒ€

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- `æ•°æ®æŒä¹…åŒ–ä¸è¯„åˆ†ç³»ç»Ÿå®Œå–„æ–¹æ¡ˆ.md` - å®Œæ•´çš„é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ
- `å¤šå€™é€‰è¯„ä¼°å™¨ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md` - ä¹‹å‰å®Œæˆçš„å­å…ƒç´ æ–‡æœ¬åŒ¹é…
- `æ™ºèƒ½åˆ†æå››è½®ä¿®å¤å®ŒæˆæŠ¥å‘Š.md` - ä¹‹å‰å®Œæˆçš„XMLç¼“å­˜ä¿å­˜
- `src/utils/script-bundle-manager.ts` - è„šæœ¬æ‰“åŒ…ç®¡ç†å™¨ï¼ˆæ•°æ®æŒä¹…åŒ–æ ¸å¿ƒï¼‰
- `src-tauri/src/exec/v3/element_matching/multi_candidate_evaluator.rs` - å¤šå€™é€‰è¯„ä¼°å™¨ï¼ˆè¯„åˆ†ç³»ç»Ÿæ ¸å¿ƒï¼‰

---

**å®Œæˆåº¦**: **100%** âœ…

- âœ… æ•°æ®æŒä¹…åŒ–æœºåˆ¶: 100%ï¼ˆå®Œæ•´éªŒè¯ï¼‰
- âœ… è¯„åˆ†ç³»ç»Ÿå®Œå–„: 100%ï¼ˆBoundså®Œå…¨åŒ¹é… + ä½ç½®åå¥½ + å¯ç‚¹å‡»å±æ€§ï¼‰
- âœ… ç¼–è¯‘é€šè¿‡: 100%ï¼ˆæ— é”™è¯¯ï¼‰
- âœ… æ¶æ„ç†è§£: 100%ï¼ˆå®Œæ•´ç†è§£æ•°æ®æµï¼‰

**æ ¸å¿ƒæˆæœ**ï¼š
- âœ… **Boundså®Œå…¨åŒ¹é…ï¼ˆ0.4åˆ†ï¼‰** = "ç»å¯¹å…¨å±€XPathå®Œå…¨åŒ¹é…"çš„å®ç°
- âœ… **ä½ç½®åå¥½ä¼˜åŒ–** = é¿å…é”™è¯¯é€‰æ‹©ç¬¬ä¸€ä¸ª
- âœ… **æ•°æ®å®Œæ•´æ€§ä¿è¯** = xpath + original_xml å®Œæ•´ä¿å­˜å’Œä¼ é€’

**ç”¨æˆ·éœ€æ±‚100%æ»¡è¶³** âœ…ğŸ‰
