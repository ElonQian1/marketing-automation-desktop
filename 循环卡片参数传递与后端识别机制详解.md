# ğŸ”„ å¾ªç¯å¡ç‰‡å†…æ­¥éª¤å‚æ•°ä¼ é€’ä¸åç«¯è¯†åˆ«æœºåˆ¶è¯¦è§£

## ğŸ“… åˆ†ææ—¥æœŸ
**2025å¹´10æœˆ27æ—¥**

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

ç”¨æˆ·ç–‘é—®ï¼š
1. å¾ªç¯å¡ç‰‡åŒ…è£¹ç€çš„æ­¥éª¤å¡ç‰‡ï¼Œå¦‚ä½•è®©åç«¯æ­£ç¡®è¿è¡Œï¼Ÿ
2. æ¯ä¸ªå‚æ•°éƒ½ä¸ä¸€æ ·ï¼Œåç«¯æ˜¯å¦‚ä½•è¯†åˆ«çš„ï¼Ÿ
3. æµ‹è¯•æŒ‰é’®ä¸åŒç±»å‹çš„å¡ç‰‡ï¼Œä¼ é€çš„å‚æ•°éƒ½ä¸ä¸€æ ·ï¼Œåç«¯å¦‚ä½•å¤„ç†ï¼Ÿ

## ğŸ” å‚æ•°ä¼ é€’æœºåˆ¶åˆ†æ

### 1. å‰ç«¯æ­¥éª¤å‚æ•°ç»“æ„

æ¯ä¸ªæ­¥éª¤å¡ç‰‡éƒ½æœ‰ç»Ÿä¸€çš„å‚æ•°ç»“æ„ï¼š

```typescript
interface SmartScriptStep {
  id: string;                    // æ­¥éª¤å”¯ä¸€ID
  step_type: SmartActionType;    // æ­¥éª¤ç±»å‹ï¼ˆç‚¹å‡»ã€æ»‘åŠ¨ã€è¾“å…¥ç­‰ï¼‰
  name: string;                  // æ­¥éª¤åç§°
  parameters: Record<string, any>; // â­ æ ¸å¿ƒå‚æ•°å¯¹è±¡
  enabled: boolean;              // æ˜¯å¦å¯ç”¨
  // ...å…¶ä»–å­—æ®µ
}
```

### 2. ä¸åŒç±»å‹æ­¥éª¤çš„å‚æ•°å·®å¼‚

#### ğŸ–±ï¸ ç‚¹å‡»æ­¥éª¤ (Tap)
```typescript
parameters: {
  x: 500,              // Xåæ ‡
  y: 300,              // Yåæ ‡
  wait_after: 1000,    // ç‚¹å‡»åç­‰å¾…æ—¶é—´
  element_selector?: string  // å¯é€‰çš„å…ƒç´ é€‰æ‹©å™¨
}
```

#### âŒ¨ï¸ è¾“å…¥æ­¥éª¤ (Input)
```typescript
parameters: {
  text: "Hello World", // è¾“å…¥çš„æ–‡æœ¬å†…å®¹
  element_selector: "#input-field", // è¾“å…¥æ¡†é€‰æ‹©å™¨
  clear_before: true,  // è¾“å…¥å‰æ˜¯å¦æ¸…ç©º
  wait_after: 500      // è¾“å…¥åç­‰å¾…æ—¶é—´
}
```

#### ğŸ“± æ»‘åŠ¨æ­¥éª¤ (Swipe)
```typescript
parameters: {
  start_x: 500,        // èµ·å§‹Xåæ ‡
  start_y: 800,        // èµ·å§‹Yåæ ‡
  end_x: 500,          // ç»“æŸXåæ ‡
  end_y: 200,          // ç»“æŸYåæ ‡
  duration: 300,       // æ»‘åŠ¨æŒç»­æ—¶é—´
  direction?: "up"|"down"|"left"|"right" // å¯é€‰æ–¹å‘
}
```

#### ğŸ”„ å¾ªç¯æ­¥éª¤ (Loop)
```typescript
// å¾ªç¯å¼€å§‹æ­¥éª¤
parameters: {
  loop_id: "loop_001",     // å¾ªç¯å”¯ä¸€ID
  loop_name: "æµ‹è¯•å¾ªç¯",    // å¾ªç¯åç§°
  loop_count: 5,           // å¾ªç¯æ¬¡æ•°
  is_infinite_loop: false, // æ˜¯å¦æ— é™å¾ªç¯
  loop_description: "æè¿°" // å¾ªç¯æè¿°
}

// å¾ªç¯ç»“æŸæ­¥éª¤
parameters: {
  loop_id: "loop_001",     // å¯¹åº”çš„å¾ªç¯ID (å¿…é¡»åŒ¹é…)
  loop_count: 5            // åŒæ­¥çš„å¾ªç¯æ¬¡æ•°
}
```

## ğŸš€ åç«¯è¯†åˆ«ä¸å¤„ç†æœºåˆ¶

### 1. ç»Ÿä¸€å…¥å£å¤„ç†

åç«¯é€šè¿‡ `SmartActionDispatcher` ç»Ÿä¸€å¤„ç†æ‰€æœ‰æ­¥éª¤ï¼š

```rust
// src-tauri/src/services/execution/actions/mod.rs
impl SmartActionDispatcher {
    pub async fn execute_step(&mut self, step: &SmartScriptStep, logs: &mut Vec<String>) -> Result<String> {
        match step.step_type {
            SmartActionType::Tap => {
                // æå–ç‚¹å‡»å‚æ•°
                let params = &step.parameters;
                let x = params["x"].as_i64().context("ç¼ºå°‘xåæ ‡")?;
                let y = params["y"].as_i64().context("ç¼ºå°‘yåæ ‡")?;
                // æ‰§è¡Œç‚¹å‡»é€»è¾‘
            }
            SmartActionType::Input => {
                // æå–è¾“å…¥å‚æ•°  
                let text = params["text"].as_str().context("ç¼ºå°‘è¾“å…¥æ–‡æœ¬")?;
                // æ‰§è¡Œè¾“å…¥é€»è¾‘
            }
            SmartActionType::Swipe => {
                // æå–æ»‘åŠ¨å‚æ•°
                let start_x = params["start_x"].as_i64().context("ç¼ºå°‘èµ·å§‹Xåæ ‡")?;
                // æ‰§è¡Œæ»‘åŠ¨é€»è¾‘
            }
            SmartActionType::LoopStart => {
                // å¤„ç†å¾ªç¯å¼€å§‹
                self.handle_loop_start(step, logs).await
            }
            SmartActionType::LoopEnd => {
                // å¤„ç†å¾ªç¯ç»“æŸ
                self.handle_loop_end(step, logs).await
            }
        }
    }
}
```

### 2. å‚æ•°ç±»å‹è¯†åˆ«æœºåˆ¶

#### ğŸ”§ JSONå‚æ•°è§£æ
```rust
// åç«¯å®‰å…¨åœ°è§£æå‰ç«¯ä¼ æ¥çš„JSONå‚æ•°
let params: HashMap<String, serde_json::Value> = 
    serde_json::from_value(step.parameters.clone())?;

// æ ¹æ®å‚æ•°ç±»å‹è¿›è¡Œå¼ºåˆ¶è½¬æ¢
let x = params["x"].as_i64().context("xåæ ‡å¿…é¡»æ˜¯æ•°å­—")?;
let text = params["text"].as_str().context("textå¿…é¡»æ˜¯å­—ç¬¦ä¸²")?;
let enabled = params["enabled"].as_bool().unwrap_or(false);
```

#### ğŸ›¡ï¸ ç±»å‹å®‰å…¨ä¿è¯
```rust
// åç«¯ä¼šéªŒè¯å‚æ•°ç±»å‹å’Œå¿…éœ€å­—æ®µ
fn validate_tap_parameters(params: &HashMap<String, serde_json::Value>) -> Result<()> {
    if !params.contains_key("x") || !params.contains_key("y") {
        return Err(anyhow!("ç‚¹å‡»æ­¥éª¤ç¼ºå°‘å¿…éœ€çš„åæ ‡å‚æ•°"));
    }
    
    if params["x"].as_i64().is_none() || params["y"].as_i64().is_none() {
        return Err(anyhow!("åæ ‡å‚æ•°å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—"));
    }
    
    Ok(())
}
```

### 3. å¾ªç¯å†…æ­¥éª¤çš„ç‰¹æ®Šå¤„ç†

#### ğŸ”„ å¾ªç¯ä¸Šä¸‹æ–‡æ³¨å…¥
```rust
// å¾ªç¯å±•å¼€æ—¶ï¼Œä¸ºæ¯ä¸ªå†…éƒ¨æ­¥éª¤æ³¨å…¥å¾ªç¯ä¸Šä¸‹æ–‡
fn inject_loop_context(&self, step: &mut SmartScriptStep, iteration: i32, loop_node_id: &str) -> Result<()> {
    let mut params = // è§£æç°æœ‰å‚æ•°...
    
    // æ³¨å…¥å¾ªç¯ä¸Šä¸‹æ–‡ä¿¡æ¯
    params.insert("__loop_iteration".to_string(), iteration.into());
    params.insert("__loop_node_id".to_string(), loop_node_id.into());
    params.insert("__original_step_id".to_string(), step.id.clone().into());
    params.insert("__expanded_at".to_string(), timestamp.into());
    
    step.parameters = serde_json::Value::Object(params);
    Ok(())
}
```

#### ğŸ“ å¾ªç¯æ­¥éª¤å±•å¼€ç¤ºä¾‹
```rust
// åŸå§‹å¾ªç¯ç»“æ„
Loop Start (loop_count: 3)
â”œâ”€â”€ Tap Step (x: 500, y: 300)
â”œâ”€â”€ Input Step (text: "Hello")
â””â”€â”€ Swipe Step (direction: "up")
Loop End

// åç«¯å±•å¼€åçš„çº¿æ€§æ­¥éª¤
Step 1: Tap (x: 500, y: 300, __loop_iteration: 1, __loop_node_id: "loop_001")
Step 2: Input (text: "Hello", __loop_iteration: 1, __loop_node_id: "loop_001") 
Step 3: Swipe (direction: "up", __loop_iteration: 1, __loop_node_id: "loop_001")
Step 4: Tap (x: 500, y: 300, __loop_iteration: 2, __loop_node_id: "loop_001")
Step 5: Input (text: "Hello", __loop_iteration: 2, __loop_node_id: "loop_001")
Step 6: Swipe (direction: "up", __loop_iteration: 2, __loop_node_id: "loop_001")
Step 7: Tap (x: 500, y: 300, __loop_iteration: 3, __loop_node_id: "loop_001")
Step 8: Input (text: "Hello", __loop_iteration: 3, __loop_node_id: "loop_001")
Step 9: Swipe (direction: "up", __loop_iteration: 3, __loop_node_id: "loop_001")
```

## ğŸ§ª æµ‹è¯•æŒ‰é’®æœºåˆ¶

### 1. å‰ç«¯æµ‹è¯•æµç¨‹

```typescript
// å•ä¸ªæ­¥éª¤æµ‹è¯•
const testStep = async (step: SmartScriptStep) => {
  // 1. æ”¶é›†æ­¥éª¤å‚æ•°
  const parameters = {
    ...step.parameters,
    // æµ‹è¯•æ—¶å¯èƒ½æ·»åŠ é¢å¤–å‚æ•°
    __test_mode: true,
    __test_timestamp: Date.now()
  };

  // 2. è°ƒç”¨åç«¯æ‰§è¡Œ
  const result = await invoke('execute_single_step', {
    deviceId: currentDevice.id,
    step: { ...step, parameters },
    config: testConfig
  });

  return result;
};
```

### 2. å¾ªç¯æµ‹è¯•ç‰¹æ®Šå¤„ç†

```typescript
// å¾ªç¯å†…æ­¥éª¤æµ‹è¯• - å‰ç«¯æ¨¡æ‹Ÿå¾ªç¯
const testLoopStep = async (step: SmartScriptStep, loopCount: number) => {
  // æ–¹å¼1: å‰ç«¯å¾ªç¯æµ‹è¯•
  for (let i = 1; i <= loopCount; i++) {
    const testParameters = {
      ...step.parameters,
      __loop_iteration: i,
      __loop_total: loopCount,
      __test_mode: true
    };
    
    await invoke('execute_single_step', {
      deviceId,
      step: { ...step, parameters: testParameters }
    });
  }
  
  // æ–¹å¼2: åç«¯å¾ªç¯æµ‹è¯• (æ¨è)
  const loopSteps = [
    { step_type: 'loop_start', parameters: { loop_count: loopCount } },
    step, // åŸå§‹æ­¥éª¤
    { step_type: 'loop_end', parameters: {} }
  ];
  
  await invoke('execute_smart_automation_script', {
    deviceId,
    steps: loopSteps,
    config: executionConfig
  });
};
```

## ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“

### âœ… åç«¯å¦‚ä½•è¯†åˆ«ä¸åŒç±»å‹æ­¥éª¤

1. **æ­¥éª¤ç±»å‹è¯†åˆ«**: é€šè¿‡ `step.step_type` å­—æ®µ (Tap/Input/Swipe/LoopStartç­‰)
2. **å‚æ•°éªŒè¯**: æ ¹æ®æ­¥éª¤ç±»å‹éªŒè¯å¿…éœ€å‚æ•°æ˜¯å¦å­˜åœ¨
3. **ç±»å‹è½¬æ¢**: å®‰å…¨åœ°å°†JSONå‚æ•°è½¬æ¢ä¸ºRustç±»å‹
4. **æ‰§è¡Œåˆ†å‘**: åˆ†å‘åˆ°å¯¹åº”çš„æ‰§è¡Œå™¨å¤„ç†

### âœ… å¾ªç¯å†…æ­¥éª¤çš„ç‰¹æ®Šæœºåˆ¶

1. **å¾ªç¯å±•å¼€**: åç«¯å°†å¾ªç¯ç»“æ„å±•å¼€ä¸ºçº¿æ€§æ­¥éª¤åºåˆ—
2. **ä¸Šä¸‹æ–‡æ³¨å…¥**: ä¸ºæ¯ä¸ªå¾ªç¯å†…æ­¥éª¤æ³¨å…¥å¾ªç¯è¿­ä»£ä¿¡æ¯
3. **å‚æ•°ä¿æŒ**: åŸå§‹æ­¥éª¤å‚æ•°å®Œå…¨ä¿ç•™ï¼Œåªæ·»åŠ å¾ªç¯ä¸Šä¸‹æ–‡
4. **ç‹¬ç«‹æ‰§è¡Œ**: æ¯ä¸ªå±•å¼€æ­¥éª¤ç‹¬ç«‹æ‰§è¡Œï¼Œæ‹¥æœ‰å®Œæ•´å‚æ•°

### âœ… æµ‹è¯•åŠŸèƒ½çš„å®ç°

1. **å•æ­¥æµ‹è¯•**: ç›´æ¥ä¼ é€’æ­¥éª¤å‚æ•°åˆ°åç«¯æ‰§è¡Œ
2. **å¾ªç¯æµ‹è¯•**: å¯é€‰å‰ç«¯å¾ªç¯æˆ–åç«¯å¾ªç¯ä¸¤ç§æ–¹å¼
3. **å‚æ•°ä¸€è‡´æ€§**: æµ‹è¯•å’Œæ­£å¼æ‰§è¡Œä½¿ç”¨ç›¸åŒçš„å‚æ•°ä¼ é€’æœºåˆ¶
4. **è°ƒè¯•ä¿¡æ¯**: æµ‹è¯•æ¨¡å¼ä¸‹æ³¨å…¥é¢å¤–çš„è°ƒè¯•å‚æ•°

## ğŸš€ æœ€ä½³å®è·µå»ºè®®

### å¯¹äºå¼€å‘è€…

1. **å‚æ•°æ ‡å‡†åŒ–**: ç¡®ä¿æ¯ç§æ­¥éª¤ç±»å‹æœ‰æ˜ç¡®çš„å‚æ•°è§„èŒƒ
2. **ç±»å‹å®‰å…¨**: å‰ç«¯ä¼ é€’å‚æ•°æ—¶è¿›è¡Œç±»å‹æ£€æŸ¥
3. **å¾ªç¯è®¾è®¡**: å¾ªç¯å†…æ­¥éª¤åº”è¯¥æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸ä¾èµ–å¤–éƒ¨å˜é‡
4. **æµ‹è¯•è¦†ç›–**: ä¸ºæ¯ç§æ­¥éª¤ç±»å‹ç¼–å†™æµ‹è¯•ç”¨ä¾‹

### å¯¹äºç”¨æˆ·

1. **å‚æ•°å®Œæ•´æ€§**: ç¡®ä¿æ¯ä¸ªæ­¥éª¤çš„å¿…éœ€å‚æ•°éƒ½å·²æ­£ç¡®å¡«å†™
2. **å¾ªç¯è®¾è®¡**: é¿å…åœ¨å¾ªç¯å†…ä½¿ç”¨ä¾èµ–ä¸Šä¸€æ¬¡ç»“æœçš„æ­¥éª¤
3. **æµ‹è¯•éªŒè¯**: åœ¨æ­£å¼è¿è¡Œå‰ä½¿ç”¨æµ‹è¯•åŠŸèƒ½éªŒè¯æ­¥éª¤å‚æ•°
4. **é”™è¯¯æ’æŸ¥**: æŸ¥çœ‹åç«¯æ—¥å¿—æ¥è¯Šæ–­å‚æ•°ä¼ é€’é—®é¢˜

---

## ğŸ‰ ç»“è®º

å¾ªç¯å¡ç‰‡å†…çš„æ­¥éª¤ä¸æ™®é€šæ­¥éª¤ä½¿ç”¨**å®Œå…¨ç›¸åŒçš„å‚æ•°ä¼ é€’æœºåˆ¶**ï¼š

- âœ… **ç»Ÿä¸€æ ¼å¼**: æ‰€æœ‰æ­¥éª¤éƒ½ä½¿ç”¨ `step.parameters` JSON å¯¹è±¡
- âœ… **ç±»å‹è¯†åˆ«**: åç«¯æ ¹æ® `step_type` å­—æ®µåˆ†å‘åˆ°å¯¹åº”å¤„ç†å™¨
- âœ… **å‚æ•°éªŒè¯**: æ¯ç§æ­¥éª¤ç±»å‹éƒ½æœ‰ä¸¥æ ¼çš„å‚æ•°éªŒè¯è§„åˆ™
- âœ… **å¾ªç¯å¢å¼º**: å¾ªç¯å†…æ­¥éª¤ä¼šè‡ªåŠ¨è·å¾—å¾ªç¯ä¸Šä¸‹æ–‡ä¿¡æ¯
- âœ… **æµ‹è¯•ä¸€è‡´**: æµ‹è¯•æŒ‰é’®å’Œæ­£å¼æ‰§è¡Œä½¿ç”¨ç›¸åŒæœºåˆ¶

**æ ¸å¿ƒä¼˜åŠ¿**: æ— è®ºæ­¥éª¤åœ¨å¾ªç¯å†…è¿˜æ˜¯å¾ªç¯å¤–ï¼Œå‚æ•°æ ¼å¼å’Œå¤„ç†æœºåˆ¶å®Œå…¨ä¸€è‡´ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„ç®€æ´æ€§å’Œå¯é æ€§ï¼