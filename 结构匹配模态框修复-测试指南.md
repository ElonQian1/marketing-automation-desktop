# ç»“æ„åŒ¹é…æ¨¡æ€æ¡†ä¿®å¤ - æµ‹è¯•æŒ‡å—

## ğŸ¯ ä¿®å¤å†…å®¹

**é—®é¢˜**: æ¨¡æ€æ¡†èƒ½æ­£ç¡®å±•ç¤ºæ•°æ®ï¼Œä½†ç‚¹å‡»ç¡®å®šåç”Ÿæˆçš„å‚æ•°é…ç½®å­—æ®µä¸å¯¹ï¼Œåç«¯æ²¡æœ‰æ­£å¸¸å·¥ä½œ

**æ ¹æœ¬åŸå› **: `structural-matching-modal.tsx` çš„ `handleConfirm` å‡½æ•°åœ¨ç”Ÿæˆ `structural_signatures` æ—¶ï¼Œåªå¤åˆ¶äº† `role` å’Œ `depth`ï¼Œ**æ²¡æœ‰å¤åˆ¶ `fingerprint` å­—æ®µ**ï¼ˆåŒ…å«å…³é”®çš„ `selected_element_bounds` ä¿¡æ¯ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**: åœ¨ `handleConfirm` å‡½æ•°ä¸­æ·»åŠ  `fingerprint` å­—æ®µå¤åˆ¶

---

## ğŸ“ ä¿®å¤è¯¦æƒ…

### æ–‡ä»¶ä½ç½®
`src/components/structural-matching/structural-matching-modal.tsx`

### ä¿®æ”¹å†…å®¹

**ä¿®å¤å‰** (Lines 150-152):
```typescript
structuralSignatures = {
  container: {
    role: snapshot.container?.fingerprint?.role || 'Frame',
    depth: 1
    // âŒ ç¼ºå°‘: fingerprint å­—æ®µ!
  },
  skeleton: snapshot.field_rules.rules.map(...)
};
```

**ä¿®å¤å**:
```typescript
structuralSignatures = {
  container: {
    role: snapshot.container?.fingerprint?.role || 'Frame',
    depth: 1,
    fingerprint: snapshot.container?.fingerprint || undefined // âœ… å·²æ·»åŠ !
  },
  skeleton: snapshot.field_rules.rules.map(...)
};
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# å¦‚æœå·²ç»åœ¨è¿è¡Œï¼Œè·³è¿‡æ­¤æ­¥éª¤
npm run tauri dev
```

- çƒ­é‡è½½ä¼šè‡ªåŠ¨åº”ç”¨ä»£ç å˜æ›´
- å¦‚æœä¸ç¡®å®šï¼Œå¯ä»¥æŒ‰ `Ctrl+F5` å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨

### 2. æ‰§è¡Œæµ‹è¯•æµç¨‹

**æ“ä½œè·¯å¾„**: XMLåˆ†æ â†’ ç¼“å­˜ â†’ æ­¥éª¤å¡ç‰‡ â†’ ç»“æ„åŒ¹é…æ¨¡æ€æ¡† â†’ ç‚¹å‡»ç¡®å®š

#### è¯¦ç»†æ­¥éª¤ï¼š

1. **æ‰“å¼€æ™ºèƒ½åˆ†æç»„ä»¶**
   - é€‰æ‹©æµ‹è¯•ç”¨XMLï¼ˆå¦‚ç€‘å¸ƒæµé¡µé¢ï¼‰
   
2. **ç¼“å­˜XMLæ•°æ®**
   - ç‚¹å‡»"ç¼“å­˜XMLæ•°æ®"æŒ‰é’®
   - ç¡®è®¤ç¼“å­˜æˆåŠŸ
   
3. **æ‰“å¼€æ­¥éª¤å¡ç‰‡**
   - å®šä½åˆ°ç›®æ ‡å…ƒç´ ï¼ˆå¦‚ `element_32`ï¼‰
   - ç‚¹å‡»æ‰“å¼€æ­¥éª¤å¡ç‰‡
   
4. **æ‰“å¼€ç»“æ„åŒ¹é…æ¨¡æ€æ¡†**
   - åœ¨æ­¥éª¤å¡ç‰‡ä¸­é€‰æ‹©"ç»“æ„åŒ¹é…"
   - æ¨¡æ€æ¡†åº”è¯¥æ­£ç¡®æ˜¾ç¤ºå…ƒç´ ä¿¡æ¯å’Œè¾¹ç•Œ
   
5. **ç¡®è®¤é…ç½®å¹¶æäº¤**
   - ç‚¹å‡»æ¨¡æ€æ¡†çš„"ç¡®å®š"æŒ‰é’®
   - **å…³é”®æ£€æŸ¥ç‚¹**: åç«¯åº”è¯¥æ¥æ”¶åˆ°å®Œæ•´çš„å‚æ•°

---

## âœ… é¢„æœŸç»“æœ

### å‰ç«¯æ§åˆ¶å°æ—¥å¿—

åº”è¯¥çœ‹åˆ°ç±»ä¼¼æ—¥å¿—ï¼ˆå¦‚æœæœ‰è°ƒè¯•è¾“å‡ºï¼‰:

```javascript
âœ… [Modal Fix] å·²æ­£ç¡®å¤åˆ¶ fingerprint å­—æ®µ: {
  hasFingerprint: true,
  fingerprintRole: "AUTO_DETECT",
  hasBounds: true,
  bounds: [546, 225, 1067, 1083]
}
```

### åç«¯ç»ˆç«¯æ—¥å¿—

**ä¿®å¤å‰çš„é”™è¯¯æ—¥å¿—**:
```rust
âš ï¸ [V3 SM Integration] æœªèƒ½æå–å®¹å™¨æç¤ºï¼ŒSMå°†ä½¿ç”¨æ ¹èŠ‚ç‚¹ä½œä¸ºèµ·ç‚¹
â„¹ï¸ [SM Runtime] æ— boundsæç¤ºï¼Œä½¿ç”¨æ ¹èŠ‚ç‚¹0
```

**ä¿®å¤åçš„æ­£ç¡®æ—¥å¿—**:
```rust
âœ… [V3 SM Integration] æå–å®¹å™¨æç¤ºæˆåŠŸ: bounds=[546, 225, 1067, 1083]
âœ… [SM Runtime] é€šè¿‡boundså®šä½åˆ°èŠ‚ç‚¹: node_id=32
ğŸ—ï¸ [SM Runtime] å®¹å™¨é™åŸŸå®Œæˆ: container_id=32  // ä¸æ˜¯0!
```

### åç«¯æ¥æ”¶çš„æ•°æ®ç»“æ„

**ä¿®å¤å‰** (ä¸å®Œæ•´):
```json
{
  "container": {
    "role": "AUTO_DETECT",
    "depth": 1
    // âŒ ç¼ºå°‘ fingerprint!
  },
  "skeleton": [...]
}
```

**ä¿®å¤å** (å®Œæ•´):
```json
{
  "container": {
    "role": "AUTO_DETECT",
    "depth": 1,
    "fingerprint": {
      "role": "AUTO_DETECT",
      "hints": {
        "selected_element_id": "element_32",
        "selected_element_bounds": [546, 225, 1067, 1083],
        "selected_element_class": "android.widget.FrameLayout",
        "strategy": "scrollable_ancestor"
      }
    }
  },
  "skeleton": [...]
}
```

---

## ğŸš¨ å¦‚æœæµ‹è¯•å¤±è´¥

### åœºæ™¯1: ä»ç„¶æ²¡æœ‰ fingerprint å­—æ®µ

**å¯èƒ½åŸå› **: ä»£ç æœªé‡æ–°åŠ è½½

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤æ–‡ä»¶å·²ä¿å­˜
2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Sources æ ‡ç­¾
3. æ‰¾åˆ° `structural-matching-modal.tsx`
4. ç¡®è®¤ä»£ç å·²æ›´æ–°ï¼ˆLine 152 åº”è¯¥æœ‰ `fingerprint: ...`ï¼‰
5. å¦‚æœæ²¡æ›´æ–°ï¼Œç¡¬åˆ·æ–°: `Ctrl+Shift+Delete` â†’ æ¸…é™¤ç¼“å­˜

### åœºæ™¯2: fingerprint å­˜åœ¨ä½† bounds æ ¼å¼é”™è¯¯

**æ£€æŸ¥**: å‰ç«¯æ—¥å¿—ä¸­ `selected_element_bounds` çš„å€¼

**é¢„æœŸæ ¼å¼**: `[left, top, right, bottom]` æ•°å­—æ•°ç»„

**è§£å†³æ–¹æ¡ˆ**:
- å¦‚æœæ˜¯å­—ç¬¦ä¸²: æ£€æŸ¥ `use-hierarchical-matching-modal.ts` çš„ bounds æå–é€»è¾‘
- å¦‚æœæ˜¯ç©ºæ•°ç»„: æ£€æŸ¥å…ƒç´ æ˜¯å¦æœ‰ `bounds` å±æ€§

### åœºæ™¯3: åç«¯ä»ç„¶ä½¿ç”¨æ ¹èŠ‚ç‚¹ 0

**æ£€æŸ¥**: åç«¯æ—¥å¿—ä¸­ `container_gate` æ¨¡å—çš„è¾“å‡º

**å¯èƒ½åŸå› **:
1. Rust ä»£ç ååºåˆ—åŒ–å¤±è´¥
2. `fingerprint.hints` ç»“æ„ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥åç«¯æ—¥å¿—ä¸­çš„å®Œæ•´é”™è¯¯ä¿¡æ¯
- ç¡®è®¤åç«¯æœŸæœ›çš„ `fingerprint` ç»“æ„ä¸å‰ç«¯å‘é€çš„ä¸€è‡´

---

## ğŸ“Š éªŒè¯æ¸…å•

æµ‹è¯•å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹æ‰€æœ‰é¡¹ç›®ï¼š

- [ ] æ¨¡æ€æ¡†èƒ½æ­£ç¡®æ‰“å¼€å¹¶æ˜¾ç¤ºå…ƒç´ ä¿¡æ¯
- [ ] æ¨¡æ€æ¡†æ˜¾ç¤ºæ­£ç¡®çš„ boundsï¼ˆè¾¹ç•Œåæ ‡ï¼‰
- [ ] ç‚¹å‡»"ç¡®å®š"åæ²¡æœ‰å‰ç«¯é”™è¯¯
- [ ] å‰ç«¯æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º fingerprint å­—æ®µå·²å¤åˆ¶
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤ºæˆåŠŸæå–å®¹å™¨æç¤ºï¼ˆboundsï¼‰
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®çš„å®¹å™¨èŠ‚ç‚¹IDï¼ˆä¸æ˜¯0ï¼‰
- [ ] åç«¯èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œç»“æ„åŒ¹é…

---

## ğŸ” è°ƒè¯•æŠ€å·§

### å‰ç«¯è°ƒè¯•

åœ¨ `structural-matching-modal.tsx` çš„ `handleConfirm` å‡½æ•°ä¸­æ·»åŠ ä¸´æ—¶æ—¥å¿—:

```typescript
// Line 155 é™„è¿‘
console.log('ğŸ” [Debug] snapshot.container:', snapshot.container);
console.log('ğŸ” [Debug] fingerprint:', snapshot.container?.fingerprint);
console.log('ğŸ” [Debug] structuralSignatures:', structuralSignatures);
```

### åç«¯è°ƒè¯•

åœ¨ Rust åç«¯çš„ `structure_match_runtime.rs` ä¸­æŸ¥æ‰¾:

```rust
// æŸ¥æ‰¾å®¹å™¨é™åŸŸç›¸å…³æ—¥å¿—
// åº”è¯¥çœ‹åˆ° fingerprint.hints.selected_element_bounds
```

---

## ğŸ’¡ æŠ€æœ¯èƒŒæ™¯

### æ•°æ®æµ

```
XMLåˆ†æ 
  â†’ ç”Ÿæˆ StructuralSnapshot (åŒ…å« container.fingerprint)
  â†’ ç”¨æˆ·æ‰“å¼€æ¨¡æ€æ¡†
  â†’ ç”¨æˆ·ç‚¹å‡»ç¡®å®š
  â†’ handleConfirm ç”Ÿæˆ structural_signatures
  â†’ å‘é€åˆ°åç«¯
  â†’ åç«¯ SM Runtime ä½¿ç”¨ bounds å®šä½å®¹å™¨
  â†’ åœ¨å®¹å™¨èŒƒå›´å†…æ‰§è¡Œç»“æ„åŒ¹é…
```

### ä¸ºä»€ä¹ˆ bounds å¾ˆé‡è¦

- **æ²¡æœ‰ bounds**: åç«¯é»˜è®¤ä½¿ç”¨æ ¹èŠ‚ç‚¹ï¼ˆnode_id=0ï¼‰ï¼ŒåŒ¹é…èŒƒå›´å¤ªå¤§ï¼Œå®¹æ˜“è¯¯åŒ¹é…
- **æœ‰ bounds**: åç«¯ç²¾ç¡®å®šä½åˆ°ç›®æ ‡å®¹å™¨ï¼ˆå¦‚ element_32ï¼‰ï¼ŒåŒ¹é…èŒƒå›´å‡†ç¡®ï¼ŒæˆåŠŸç‡é«˜

### ç›¸å…³æ–‡ä»¶

1. **use-hierarchical-matching-modal.ts** (Lines 360-410)
   - Hook å±‚ï¼šç”Ÿæˆ structural signatures
   - âœ… å®ç°æ­£ç¡®ï¼ŒåŒ…å« bounds æå–é€»è¾‘

2. **structural-snapshot-generator.ts** (Lines 175-210)
   - Service å±‚ï¼šç”Ÿæˆ structural snapshots
   - âœ… å®ç°æ­£ç¡®ï¼Œ`analyzeContainer()` æ–¹æ³•åŒ…å« fingerprint

3. **structural-matching-modal.tsx** (Lines 145-195)
   - UI å±‚ï¼šå¤„ç†ç”¨æˆ·ç¡®è®¤æ“ä½œ
   - âŒ **ä¹‹å‰æœ‰bug**: åªå¤åˆ¶ role å’Œ depth
   - âœ… **å·²ä¿®å¤**: ç°åœ¨å®Œæ•´å¤åˆ¶ fingerprint

4. **structure_match_runtime.rs** (Backend)
   - åç«¯æ‰§è¡Œå±‚ï¼šä½¿ç”¨ bounds å®šä½å®¹å™¨
   - âœ… å·²å‡†å¤‡å¥½æ¥æ”¶å®Œæ•´æ•°æ®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‰ç«¯æ—¥å¿—.md](./å‰ç«¯æ—¥å¿—.md) - åŸå§‹æµ‹è¯•æ—¥å¿—ï¼ˆä¿®å¤å‰ï¼‰
- [åç«¯æ—¥å¿—.md](./åç«¯æ—¥å¿—.md) - åç«¯é”™è¯¯æ—¥å¿—ï¼ˆä¿®å¤å‰ï¼‰
- [ç€‘å¸ƒæµå¡ç‰‡ç»“æ„è¯´æ˜.md](./ç€‘å¸ƒæµå¡ç‰‡ç»“æ„è¯´æ˜.md) - æµ‹è¯•å…ƒç´ ç»“æ„

---

## ğŸ‰ é¢„æœŸæ”¹è¿›

ä¿®å¤åï¼Œç»“æ„åŒ¹é…åŠŸèƒ½åº”è¯¥ï¼š

1. âœ… **å®¹å™¨å®šä½å‡†ç¡®**: ä¸å†ä½¿ç”¨æ ¹èŠ‚ç‚¹0ï¼Œè€Œæ˜¯ç²¾ç¡®å®šä½åˆ°ç›®æ ‡å®¹å™¨
2. âœ… **åŒ¹é…èŒƒå›´ç²¾ç¡®**: åªåœ¨ç›®æ ‡å®¹å™¨å†…æœç´¢ï¼Œé¿å…è¯¯åŒ¹é…
3. âœ… **æˆåŠŸç‡æå‡**: é€šè¿‡ bounds ç²¾ç¡®é™åŸŸï¼ŒåŒ¹é…æ›´å¯é 
4. âœ… **æ€§èƒ½ä¼˜åŒ–**: æœç´¢èŒƒå›´ç¼©å°ï¼Œæ‰§è¡Œé€Ÿåº¦æ›´å¿«

---

**æµ‹è¯•è´Ÿè´£äºº**: _____________
**æµ‹è¯•æ—¥æœŸ**: _____________
**æµ‹è¯•ç»“æœ**: â¬œ é€šè¿‡  â¬œ å¤±è´¥

**å¤‡æ³¨**:
