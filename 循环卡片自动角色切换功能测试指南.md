# 循环卡片自动角色切换功能测试指南

## 🎯 功能概述

新增的循环拖拽管理器现在支持：
- ✅ **自动角色切换**：结束卡片被拖拽到前面自动变成开始卡片
- ✅ **智能绑定**：通过 `loop_id` 确保配对唯一性
- ✅ **性能优化**：防抖处理避免频繁更新影响拖拽体验
- ✅ **模块化架构**：完全遵循 DDD 分层，便于扩展

## 🧪 测试步骤

### 基础功能测试

#### 1. 创建循环卡片
1. 打开脚本构建器
2. 点击"创建循环"按钮
3. ✅ **验证**：应该创建一对循环开始/结束卡片

#### 2. 测试基础拖拽
1. 拖拽任意普通步骤卡片
2. ✅ **验证**：拖拽应该正常工作，无性能问题

#### 3. 测试状态联动
1. 点击循环开始卡片的"开始测试"按钮
2. ✅ **验证**：循环结束卡片应该显示"正在执行"状态
3. 点击循环结束卡片的"停止测试"按钮
4. ✅ **验证**：两个卡片都应该回到停止状态

### 🎯 核心功能测试：自动角色切换

#### 测试场景 1：结束卡片前移变开始
```
初始状态：[普通步骤] → [循环开始] → [普通步骤] → [循环结束]
操作：将 [循环结束] 拖拽到 [循环开始] 前面
预期结果：[普通步骤] → [循环开始] → [普通步骤] → [循环结束]
         （原结束变开始，原开始变结束）
```

**具体测试步骤**：
1. 创建循环：开始 → 普通步骤 → 结束
2. 将结束卡片拖拽到开始卡片前面
3. ✅ **验证**：
   - 原本的"循环结束"卡片现在显示为"循环开始"
   - 原本的"循环开始"卡片现在显示为"循环结束"
   - 两个卡片的 `loop_id` 保持一致
   - 配置参数正确同步

#### 测试场景 2：开始卡片后移变结束
```
初始状态：[循环开始] → [普通步骤] → [循环结束] → [普通步骤]
操作：将 [循环开始] 拖拽到 [循环结束] 后面
预期结果：[循环开始] → [普通步骤] → [循环结束] → [普通步骤]
         （原开始变结束，原结束变开始）
```

**具体测试步骤**：
1. 创建循环：开始 → 普通步骤 → 结束 → 普通步骤
2. 将开始卡片拖拽到结束卡片后面
3. ✅ **验证**：角色自动切换正确

#### 测试场景 3：多个循环混合
```
初始状态：[循环A开始] → [循环B开始] → [循环A结束] → [循环B结束]
操作：将 [循环A结束] 拖拽到 [循环A开始] 前面
预期结果：只有循环A的两个卡片互换角色，循环B不受影响
```

**具体测试步骤**：
1. 创建两个不同的循环（确保 `loop_id` 不同）
2. 混合排列它们的开始/结束卡片
3. 拖拽其中一个循环的卡片
4. ✅ **验证**：
   - 只影响对应的循环配对
   - 其他循环不受影响
   - 每个循环的 `loop_id` 保持独立

### 🚀 性能测试

#### 测试场景 4：大量步骤下的拖拽响应
1. 创建 20+ 个步骤（包含多个循环）
2. 快速连续拖拽循环卡片
3. ✅ **验证**：
   - 拖拽应该流畅，无明显卡顿
   - 角色切换有适当延迟（150ms 防抖）
   - 不应该出现重复处理或无限循环

### 🔍 边界情况测试

#### 测试场景 5：相同位置拖拽
1. 将循环卡片拖拽到自己的位置
2. ✅ **验证**：不应该触发角色切换

#### 测试场景 6：非循环卡片拖拽
1. 拖拽普通步骤卡片到任意位置
2. ✅ **验证**：不应该影响循环角色切换逻辑

#### 测试场景 7：单个循环卡片
1. 删除循环中的一个卡片（只剩开始或只剩结束）
2. ✅ **验证**：
   - 不应该抛出错误
   - 剩余卡片应该正常显示
   - 拖拽应该正常工作

## 🐛 常见问题排查

### 问题 1：角色切换不生效
**可能原因**：
- `loop_id` 不匹配
- `allSteps` 参数未正确传递
- 防抖时间未等待完成

**排查步骤**：
1. 检查浏览器控制台是否有错误
2. 确认两个卡片的 `loop_id` 相同
3. 等待 150ms 后再检查结果

### 问题 2：拖拽卡顿
**可能原因**：
- 防抖时间设置过短
- 大量步骤导致计算量大
- React 重渲染过频繁

**排查步骤**：
1. 开启开发模式日志查看处理频率
2. 检查是否有重复的 `useLoopDragManager` 调用
3. 验证 `useMemo`/`useCallback` 优化是否生效

### 问题 3：配对状态错误
**可能原因**：
- `LoopPairingService` 逻辑问题
- 步骤数组状态不同步

**排查步骤**：
1. 手动调用 `loopDragManager.validateAllPairs()` 查看验证结果
2. 检查 `onStepsChange` 回调是否正确触发
3. 确认 `allSteps` 和 `steps` 数据一致性

## 🎯 调试技巧

### 1. 开启调试模式
```tsx
// 在 DraggableStepsContainer 中临时开启
const loopDragManager = useLoopDragManager({
  allSteps: allSteps || steps,
  onStepsChange,
  debug: true, // 开启调试日志
});
```

### 2. 手动检查配对状态
```tsx
// 在浏览器控制台执行
const pairs = loopDragManager.getLoopPairs();
console.log('当前循环配对:', pairs);

const errors = loopDragManager.validateAllPairs();
console.log('配对验证错误:', errors);
```

### 3. 性能监控
```tsx
// 监控拖拽频率
const startTime = performance.now();
loopDragManager.checkAndSwitchRoles();
console.log('角色切换耗时:', performance.now() - startTime, 'ms');
```

## ✅ 验收标准

### 基础功能 ✅
- [x] 循环卡片正常创建和显示
- [x] 基础拖拽功能正常
- [x] 循环测试状态联动正确

### 核心功能 🎯
- [ ] 结束卡片前移自动变开始卡片
- [ ] 开始卡片后移自动变结束卡片
- [ ] 多循环互不干扰
- [ ] `loop_id` 绑定正确

### 性能要求 🚀
- [ ] 20+ 步骤下拖拽流畅
- [ ] 150ms 防抖生效
- [ ] 无内存泄漏或重复处理

### 边界情况 🔍
- [ ] 相同位置拖拽无副作用
- [ ] 非循环卡片不受影响
- [ ] 单个循环卡片无错误

---

## 📝 测试反馈模板

```
测试环境：[开发/生产]
测试时间：[YYYY-MM-DD HH:mm]
测试人员：[姓名]

基础功能测试：
□ 循环创建 - [通过/失败]
□ 基础拖拽 - [通过/失败]
□ 状态联动 - [通过/失败]

核心功能测试：
□ 结束前移变开始 - [通过/失败]
□ 开始后移变结束 - [通过/失败]
□ 多循环混合 - [通过/失败]

性能测试：
□ 大量步骤拖拽 - [通过/失败]
□ 防抖效果 - [通过/失败]

发现问题：
1. [问题描述]
2. [复现步骤]
3. [预期行为]
4. [实际行为]

总体评价：[优秀/良好/需改进/不合格]
```