# 局部结构可视化功能测试指南

## 🎯 功能概述

在结构匹配模态框中，新增了局部可视化预览功能：

- **左侧：元素结构树** - 层级配置和字段匹配规则
- **右侧：局部可视化预览** - 显示选中元素周围的局部结构
- **悬浮联动高亮** - 鼠标悬停左侧树节点时，右侧对应元素高亮

## 🔧 核心技术实现

### 1. 局部可视化组件 (`StructuralLocalPreview`)

```typescript
// src/modules/structural-matching/ui/components/visual-preview/structural-local-preview.tsx

✅ 复用 PagePreview 核心逻辑
✅ 从完整XML中提取局部相关元素
✅ 智能区域范围计算（1.5倍扩展）
✅ 支持父子元素关系
✅ 与树节点联动高亮
```

### 2. 增强的联动系统

```typescript
// 悬停事件处理
const handleTreeHover = useCallback((nodeKey: string | null) => {
  // 将树节点key转换为元素ID
  const elementId = deriveElementIdFromNodeKey(nodeKey);
  handleTreeNodeHover(elementId);
}, [deriveElementIdFromNodeKey, handleTreeNodeHover]);
```

### 3. 元素范围提取策略

- **以选中元素为中心**
- **1.5倍区域扩展**
- **包含父子关系元素**
- **视觉接近的同级元素**

## 🧪 测试步骤

### 步骤 1：打开结构匹配模态框

1. 启动应用：`npm run tauri dev`
2. 进入页面分析功能
3. 选择任一元素
4. 点击"结构匹配配置"按钮

### 步骤 2：验证可视化预览

1. 观察右侧是否显示"🔍 局部结构可视化"面板
2. 检查是否显示设备框架和元素布局
3. 验证元素数量显示是否正确（例：显示 8 个局部元素（总计 45 个））

### 步骤 3：测试悬停联动

1. **鼠标悬停左侧树节点**：
   - 悬停"外层"节点 → 右侧应高亮选中元素
   - 悬停"第1层"节点 → 右侧应高亮对应子元素
   - 悬停"第2层"节点 → 右侧应高亮对应孙元素

2. **观察状态反馈**：
   - 底部状态栏显示当前悬停节点
   - 高亮元素ID实时更新
   - 联动状态显示"已激活"

### 步骤 4：验证视觉效果

1. **元素颜色区分**：
   - 🟢 绿色：可点击元素
   - 🔵 蓝色：有文本元素  
   - 🟠 橙色：有描述元素
   - ⚫ 灰色：普通元素

2. **高亮效果**：
   - 高亮元素有红色边框
   - 放大效果 (scale 1.05)
   - 阴影效果增强

3. **设备框架**：
   - 模拟手机外观
   - 正确的比例缩放
   - 设备信息显示

## 🐛 常见问题排查

### 问题 1：右侧无可视化内容

**症状**：显示"无可视化元素数据"

**排查步骤**：
1. 检查控制台是否有XML缓存错误
2. 确认选中元素是否包含`xmlCacheId`
3. 验证XML解析是否成功

**解决方案**：
```bash
# 检查控制台日志
🔍 [StructuralLocalPreview] 找到选中元素
🏗️ [StructuralLocalPreview] 转换局部可视化元素
```

### 问题 2：悬停无联动效果

**症状**：鼠标悬停树节点但右侧无高亮

**排查步骤**：
1. 检查树节点是否正确捕获hover事件
2. 验证`deriveElementIdFromNodeKey`函数返回值
3. 确认`handleTreeNodeHover`被正确调用

**调试日志**：
```bash
🐭 [Tree] Mouse over node: root-0-1
🎯 [ElementStructureTreeWithPreview] Derived element ID: element_xx_child_1
```

### 问题 3：元素位置错乱

**症状**：可视化元素位置不正确

**原因**：
- Bounds解析失败
- 坐标系转换问题
- 缩放计算错误

**解决方案**：
检查`parseBounds`函数和坐标转换逻辑

## 📊 性能监控

### 关键指标

1. **XML解析时间**：< 500ms
2. **元素转换时间**：< 100ms  
3. **渲染帧率**：60fps
4. **内存占用**：< 50MB

### 性能优化

1. **缓存XML解析结果**
2. **虚拟化长列表**
3. **防抖hover事件**
4. **按需加载元素**

## 🎨 样式规范

### 色彩系统

```css
/* 元素类型颜色 */
--clickable-color: #52c41a;     /* 可点击 - 绿色 */
--text-color: #1890ff;          /* 文本 - 蓝色 */
--desc-color: #faad14;          /* 描述 - 橙色 */
--normal-color: #8c8c8c;        /* 普通 - 灰色 */

/* 高亮效果 */
--highlight-border: #ff4d4f;    /* 高亮边框 - 红色 */
--hover-border: #faad14;        /* 悬停边框 - 橙色 */
```

### 动画效果

```css
/* 元素过渡 */
transition: all 0.2s ease;

/* 高亮缩放 */
transform: scale(1.05);

/* 阴影增强 */
box-shadow: 0 4px 12px rgba(255,77,79,0.4);
```

## 🚀 后续优化

### 短期优化

1. **增强hover精度**：更精确的树节点事件捕获
2. **添加快捷键**：支持键盘导航
3. **优化移动端**：触摸设备适配

### 长期规划

1. **3D可视化**：立体层级展示
2. **动画过渡**：元素切换动画
3. **智能布局**：自适应最佳显示角度
4. **导出功能**：可视化图片导出

## 📝 测试清单

- [ ] 模态框正常打开
- [ ] 右侧显示局部可视化
- [ ] 左侧树节点hover正常
- [ ] 右侧元素高亮联动
- [ ] 状态栏信息准确
- [ ] 设备框架显示正确
- [ ] 元素颜色区分清晰
- [ ] 缩放比例合适
- [ ] 性能表现良好
- [ ] 无控制台错误

---

## 💡 使用提示

1. **最佳悬停方式**：缓慢移动鼠标到树节点上，停留0.15秒触发高亮
2. **查看详细信息**：悬停可视化元素查看tooltip信息
3. **调整视图**：可视化会自动缩放以适应容器大小
4. **理解层级**：深度标识帮助理解元素层级关系

通过这个局部可视化功能，用户可以更直观地理解元素的结构关系，提升结构匹配配置的准确性！