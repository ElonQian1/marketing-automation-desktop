# 视口图片位置修复验证指南

## 问题描述

用户反馈："视口裁剪的图片位置不对"，悬浮视觉窗口中的截图显示位置不正确。

## 修复内容

### 1. 核心修复位置

- **文件**: `src/modules/structural-matching/ui/components/visual-preview/floating-window/components/aligned-image-display.tsx`
- **方法**: `getImageDisplayStyle()`
- **修复类型**: 图片定位算法优化

### 2. 修复前的问题

```typescript
// 🚫 修复前：复杂的 transform + objectPosition 组合导致位置错乱
return {
  position: "absolute" as const,
  left: imageDisplay.offset.x,
  top: imageDisplay.offset.y,
  width: cropArea.width * imageDisplay.scale,
  height: cropArea.height * imageDisplay.scale,
  objectFit: "none" as const,
  objectPosition: `-${cropArea.x * imageDisplay.scale}px -${
    cropArea.y * imageDisplay.scale
  }px`,
  transform: `scale(${imageDisplay.scale})`,
  transformOrigin: "0 0",
  // ... 多种定位方式冲突
};
```

### 3. 修复后的方案

```typescript
// ✅ 修复后：简化的 CSS clip 定位方案
return {
  position: "absolute" as const,
  left: -cropArea.x * imageDisplay.scale + imageDisplay.offset.x,
  top: -cropArea.y * imageDisplay.scale + imageDisplay.offset.y,
  width: imageNaturalSize.width * imageDisplay.scale,
  height: imageNaturalSize.height * imageDisplay.scale,
  maxWidth: "none",
  maxHeight: "none",
};
```

## 修复原理

### 1. 定位逻辑简化

- **避免复杂组合**: 不再同时使用 `objectPosition`、`transform` 和 `left/top` 定位
- **单一定位方式**: 仅使用 `left/top` 配合容器的 `overflow:hidden` 来实现裁剪效果

### 2. 计算公式

- **水平位置**: `left = -cropArea.x * scale + containerOffset.x`
- **垂直位置**: `top = -cropArea.y * scale + containerOffset.y`
- **图片尺寸**: 使用原始图片尺寸乘以缩放比例

### 3. 裁剪机制

- **容器裁剪**: 依赖父容器的 `overflow: hidden` 来裁剪超出部分
- **精确定位**: 通过负偏移来显示裁剪区域的正确部分

## 验证步骤

### 1. 测试环境准备

```bash
# 确保开发服务器运行
npm run tauri dev
```

### 2. 测试用例验证

1. **打开结构匹配功能**
2. **选择任意步骤卡片**
3. **点击"可视化预览"按钮**
4. **观察悬浮窗口中的截图显示**

### 3. 预期结果

- ✅ **图片显示正确**: 截图应该显示在正确的位置
- ✅ **裁剪区域准确**: 显示的区域应该对应选中的元素
- ✅ **无位置偏移**: 图片不应该出现明显的位置错位
- ✅ **缩放比例正常**: 图片缩放应该保持正确的比例

### 4. 调试日志

修复后的代码会输出详细的调试信息：

```javascript
🎨 [AlignedImageDisplay] 计算图片显示样式: {
  cropArea: { x: 100, y: 200, width: 300, height: 150 },
  imageDisplay: {
    scale: 0.8,
    offset: { x: 10, y: 20 },
    containerSize: { width: 400, height: 300 }
  },
  imageNaturalSize: { width: 1080, height: 1920 }
}
```

## 文件结构说明

### 相关组件

- **AlignedImageDisplay**: 核心图片显示组件（已修复）
- **ScreenshotDisplay**: 截图显示容器组件
- **FloatingVisualWindow**: 悬浮窗口主组件
- **ViewportAlignment**: 视口对齐计算工具

### 依赖关系

```
FloatingVisualWindow
├── ScreenshotDisplay
│   └── AlignedImageDisplay (✅ 已修复)
└── ViewportAlignment (计算工具)
```

## 注意事项

### 1. 性能考虑

- 调试日志会在修复验证完成后禁用
- 图片加载时会有临时的"📷 加载截图中..."提示

### 2. 浏览器兼容性

- CSS `overflow: hidden` 裁剪在所有现代浏览器中都支持良好
- 避免了复杂的 CSS transform 组合，提高了兼容性

### 3. 错误处理

- 图片加载失败会显示错误状态
- 无效的裁剪配置会隐藏图片显示

## 如果仍有问题

### 1. 检查控制台日志

查看是否有 `🎨 [AlignedImageDisplay]` 的调试信息

### 2. 验证数据完整性

确保 `cropConfig` 和 `viewportAlignment` 数据正确

### 3. 浏览器开发者工具

检查图片元素的实际 CSS 样式是否符合预期

---

**修复完成时间**: 2025 年 11 月 1 日  
**修复范围**: 悬浮视觉窗口图片定位算法  
**影响组件**: AlignedImageDisplay 组件  
**测试建议**: 使用多个不同的步骤卡片验证修复效果
