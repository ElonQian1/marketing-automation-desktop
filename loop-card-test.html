<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾ªç¯å¡ç‰‡ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            background: #2d2d2d;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #555;
            border-radius: 8px;
        }
        
        /* æ¨¡æ‹Ÿé—®é¢˜çš„é»‘åº•é»‘å­—å¡ç‰‡ */
        .problematic-card {
            background: black;
            color: black;
            padding: 20px;
            margin: 10px 0;
            border: 1px solid #333;
            border-radius: 8px;
        }
        
        /* åº”è¯¥æ˜¯ç™½åº•é»‘å­—çš„å¾ªç¯å¡ç‰‡ */
        .loop-step-card {
            background: white;
            color: #333;
            padding: 20px;
            margin: 10px 0;
            border: 1px solid #d9d9d9;
            border-radius: 8px;
        }
        
        .step-card {
            background: white;
            color: #333;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
        }
        
        .white-background-allowed {
            background: white;
            color: #333;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
        }
        
        .button {
            padding: 8px 16px;
            margin: 5px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        
        .button:hover {
            background: #f0f0f0;
        }
        
        .test-button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        .emergency-button {
            background: #ff4d4f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #555;
        }
        
        .status.success {
            background: #f6ffed;
            border-color: #b7eb8f;
            color: #389e0d;
        }
        
        .status.error {
            background: #fff2f0;
            border-color: #ffccc7;
            color: #cf1322;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¨ å¾ªç¯å¡ç‰‡ä¸»é¢˜ä¿®å¤æµ‹è¯•é¡µé¢</h1>
        
        <div class="test-section">
            <h2>æµ‹è¯•æ§åˆ¶</h2>
            <button class="test-button" onclick="runEmergencyFix()">è¿è¡Œç´§æ€¥ä¿®å¤è„šæœ¬</button>
            <button class="test-button" onclick="loadThemeSystem()">åŠ è½½ä¸»é¢˜ç³»ç»Ÿ</button>
            <button class="test-button" onclick="createProblematicCard()">åˆ›å»ºé—®é¢˜å¡ç‰‡</button>
            <button class="emergency-button" onclick="forceRefresh()">å¼ºåˆ¶åˆ·æ–°</button>
            
            <div id="status" class="status">å‡†å¤‡å°±ç»ª</div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”´ é—®é¢˜æ¼”ç¤ºï¼šé»‘åº•é»‘å­—å¡ç‰‡ï¼ˆåº”è¯¥è¢«ä¿®å¤ï¼‰</h2>
            <div class="problematic-card loop-step-card" id="problem-card-1">
                <h3>è¿™æ˜¯ä¸€ä¸ªé—®é¢˜å¡ç‰‡</h3>
                <p>è¿™æ®µæ–‡å­—åº”è¯¥æ˜¯é»‘åº•é»‘å­—ï¼ˆä¸å¯è¯»ï¼‰ï¼Œä¿®å¤ååº”è¯¥å˜æˆç™½åº•é»‘å­—</p>
                <button class="button">æŒ‰é’®</button>
                <span class="ant-tag">æ ‡ç­¾</span>
            </div>
            
            <div class="problematic-card step-card" id="problem-card-2">
                <h3>å¦ä¸€ä¸ªé—®é¢˜å¡ç‰‡</h3>
                <p>è¿™ä¹Ÿæ˜¯é»‘åº•é»‘å­—ï¼Œéœ€è¦ä¿®å¤</p>
                <button class="button">æ“ä½œ</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç™½åº•é»‘å­—å¾ªç¯å¡ç‰‡</h2>
            <div class="loop-step-card" data-loop-badge="1">
                <h3>æ­£ç¡®çš„å¾ªç¯æ­¥éª¤å¡ç‰‡</h3>
                <p>è¿™ä¸ªå¡ç‰‡åº”è¯¥ä¿æŒç™½åº•é»‘å­—ï¼Œæ¸…æ™°å¯è¯»</p>
                <button class="button">æ‰§è¡Œæ­¥éª¤</button>
                <span class="ant-tag ant-tag-blue">å¾ªç¯</span>
            </div>
            
            <div class="step-card white-background-allowed">
                <h3>ç™½è‰²èƒŒæ™¯å…è®¸çš„å¡ç‰‡</h3>
                <p>è¿™ç±»å¡ç‰‡åº”è¯¥ä¿æŒç™½è‰²èƒŒæ™¯</p>
                <button class="button">ç¼–è¾‘</button>
                <button class="button">åˆ é™¤</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š ä¿®å¤ç»Ÿè®¡</h2>
            <div id="stats">ç­‰å¾…ä¿®å¤...</div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ› ï¸ è°ƒè¯•å·¥å…·</h2>
            <button class="test-button" onclick="checkThemeSystem()">æ£€æŸ¥ä¸»é¢˜ç³»ç»ŸçŠ¶æ€</button>
            <button class="test-button" onclick="highlightLoopCards()">é«˜äº®å¾ªç¯å¡ç‰‡</button>
            <button class="test-button" onclick="showComputedStyles()">æ˜¾ç¤ºè®¡ç®—æ ·å¼</button>
            <button class="emergency-button" onclick="clearAllFixes()">æ¸…é™¤æ‰€æœ‰ä¿®å¤</button>
            
            <div id="debug-info" style="margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        // è¿è¡Œç´§æ€¥ä¿®å¤è„šæœ¬
        async function runEmergencyFix() {
            updateStatus('æ­£åœ¨è¿è¡Œç´§æ€¥ä¿®å¤è„šæœ¬...', 'info');
            
            try {
                // è¿™é‡Œä¼šåŠ è½½æˆ‘ä»¬çš„ç´§æ€¥ä¿®å¤è„šæœ¬
                const response = await fetch('./emergency-fix-loop-cards.js');
                const script = await response.text();
                eval(script);
                
                updateStatus('ç´§æ€¥ä¿®å¤è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼', 'success');
                updateStats();
            } catch (error) {
                updateStatus(`ç´§æ€¥ä¿®å¤è„šæœ¬æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                console.error('ç´§æ€¥ä¿®å¤å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ä¸»é¢˜ç³»ç»Ÿ
        function loadThemeSystem() {
            updateStatus('ä¸»é¢˜ç³»ç»Ÿåº”è¯¥å·²é€šè¿‡åº”ç”¨è‡ªåŠ¨åŠ è½½', 'info');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€çš„ä¿®å¤æ–¹æ³•
            if (typeof window.fixLoopCards === 'function') {
                window.fixLoopCards();
                updateStatus('ä¸»é¢˜ç³»ç»Ÿä¿®å¤æ–¹æ³•å·²æ‰§è¡Œ', 'success');
            } else if (typeof window.fixLoopCardsEmergency === 'function') {
                window.fixLoopCardsEmergency();
                updateStatus('ç´§æ€¥ä¿®å¤æ–¹æ³•å·²æ‰§è¡Œ', 'success');
            } else {
                updateStatus('æœªæ‰¾åˆ°ä¸»é¢˜ç³»ç»Ÿä¿®å¤æ–¹æ³•', 'error');
            }
            
            updateStats();
        }
        
        // åˆ›å»ºé—®é¢˜å¡ç‰‡
        function createProblematicCard() {
            const container = document.querySelector('.test-section:nth-child(3)');
            const newCard = document.createElement('div');
            newCard.className = 'problematic-card loop-step-card';
            newCard.style.background = 'black';
            newCard.style.color = 'black';
            newCard.innerHTML = `
                <h3>åŠ¨æ€åˆ›å»ºçš„é—®é¢˜å¡ç‰‡</h3>
                <p>è¿™æ˜¯é€šè¿‡JavaScriptåŠ¨æ€åˆ›å»ºçš„é»‘åº•é»‘å­—å¡ç‰‡ï¼Œæ—¶é—´: ${new Date().toLocaleTimeString()}</p>
                <button class="button">åŠ¨æ€æŒ‰é’®</button>
            `;
            container.appendChild(newCard);
            
            updateStatus('å·²åˆ›å»ºæ–°çš„é—®é¢˜å¡ç‰‡', 'info');
            
            // å¦‚æœæœ‰è‡ªåŠ¨ä¿®å¤ï¼Œç¨åè§¦å‘
            setTimeout(() => {
                if (typeof window.fixLoopCardsEmergency === 'function') {
                    window.fixLoopCardsEmergency();
                    updateStatus('è‡ªåŠ¨ä¿®å¤å·²è§¦å‘', 'success');
                }
            }, 500);
        }
        
        // æ£€æŸ¥ä¸»é¢˜ç³»ç»ŸçŠ¶æ€
        function checkThemeSystem() {
            const debugInfo = document.getElementById('debug-info');
            let info = [];
            
            info.push('=== ä¸»é¢˜ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ ===');
            
            // æ£€æŸ¥å…¨å±€æ–¹æ³•
            info.push(`themeOverrideManager: ${typeof window.themeOverrideManager}`);
            info.push(`fixLoopCards: ${typeof window.fixLoopCards}`);
            info.push(`fixLoopCardsEmergency: ${typeof window.fixLoopCardsEmergency}`);
            info.push(`getLoopCardStats: ${typeof window.getLoopCardStats}`);
            
            // æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
            if (typeof window.getThemeStats === 'function') {
                try {
                    const stats = window.getThemeStats();
                    info.push('=== ä¿®å¤ç»Ÿè®¡ ===');
                    Object.entries(stats).forEach(([key, value]) => {
                        info.push(`${key}: ${JSON.stringify(value)}`);
                    });
                } catch (e) {
                    info.push(`ç»Ÿè®¡è·å–å¤±è´¥: ${e.message}`);
                }
            }
            
            // æ£€æŸ¥å¾ªç¯å¡ç‰‡
            const loopCards = document.querySelectorAll('.loop-step-card, .step-card, .white-background-allowed');
            info.push(`=== å¾ªç¯å¡ç‰‡æ£€æŸ¥ (${loopCards.length}ä¸ª) ===`);
            
            loopCards.forEach((card, index) => {
                const computed = window.getComputedStyle(card);
                const isFixed = card.getAttribute('data-white-theme-forced') === 'true';
                info.push(`å¡ç‰‡${index + 1}: bg=${computed.backgroundColor}, color=${computed.color}, å·²ä¿®å¤=${isFixed}`);
            });
            
            debugInfo.textContent = info.join('\n');
        }
        
        // é«˜äº®å¾ªç¯å¡ç‰‡
        function highlightLoopCards() {
            const cards = document.querySelectorAll('.loop-step-card, .step-card, .white-background-allowed');
            
            cards.forEach((card, index) => {
                const originalStyle = card.style.cssText;
                card.style.boxShadow = '0 0 10px #ff4d4f';
                card.style.border = '2px solid #ff4d4f';
                
                setTimeout(() => {
                    card.style.cssText = originalStyle;
                }, 2000);
            });
            
            updateStatus(`å·²é«˜äº® ${cards.length} ä¸ªå¾ªç¯å¡ç‰‡`, 'info');
        }
        
        // æ˜¾ç¤ºè®¡ç®—æ ·å¼
        function showComputedStyles() {
            const debugInfo = document.getElementById('debug-info');
            const cards = document.querySelectorAll('.loop-step-card, .step-card, .white-background-allowed');
            let info = ['=== è®¡ç®—æ ·å¼è¯¦æƒ… ==='];
            
            cards.forEach((card, index) => {
                const computed = window.getComputedStyle(card);
                info.push(`å¡ç‰‡ ${index + 1}:`);
                info.push(`  background-color: ${computed.backgroundColor}`);
                info.push(`  color: ${computed.color}`);
                info.push(`  border-color: ${computed.borderColor}`);
                info.push(`  classes: ${card.className}`);
                info.push(`  data-white-theme-forced: ${card.getAttribute('data-white-theme-forced')}`);
                info.push('');
            });
            
            debugInfo.textContent = info.join('\n');
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const stats = document.getElementById('stats');
            let info = [];
            
            const loopCards = document.querySelectorAll('.loop-step-card, .step-card, .white-background-allowed');
            const fixedCards = document.querySelectorAll('[data-white-theme-forced="true"]');
            
            info.push(`æ€»å¾ªç¯å¡ç‰‡: ${loopCards.length}`);
            info.push(`å·²ä¿®å¤å¡ç‰‡: ${fixedCards.length}`);
            
            if (typeof window.getLoopCardStats === 'function') {
                try {
                    const themStats = window.getLoopCardStats();
                    info.push(`ä¸»é¢˜ç³»ç»Ÿç»Ÿè®¡: ${JSON.stringify(themStats)}`);
                } catch (e) {
                    info.push(`ä¸»é¢˜ç»Ÿè®¡è·å–å¤±è´¥: ${e.message}`);
                }
            }
            
            stats.innerHTML = info.join('<br>');
        }
        
        // æ¸…é™¤æ‰€æœ‰ä¿®å¤
        function clearAllFixes() {
            // ç§»é™¤å¼ºåˆ¶ä¿®å¤æ ‡è®°
            document.querySelectorAll('[data-white-theme-forced="true"]').forEach(card => {
                card.removeAttribute('data-white-theme-forced');
                card.style.cssText = '';
            });
            
            // ç§»é™¤ç´§æ€¥ä¿®å¤CSS
            const emergencyStyle = document.getElementById('loop-card-emergency-fix');
            if (emergencyStyle) {
                emergencyStyle.remove();
            }
            
            updateStatus('å·²æ¸…é™¤æ‰€æœ‰ä¿®å¤', 'info');
            updateStats();
        }
        
        // å¼ºåˆ¶åˆ·æ–°
        function forceRefresh() {
            location.reload();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ›´æ–°ç»Ÿè®¡
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
            updateStatus('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œè¯·è¿è¡Œä¿®å¤æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>