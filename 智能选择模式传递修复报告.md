# 智能选择模式传递修复报告

## 问题描述

用户报告：当选择"第一个"模式时，系统实际执行的是"批量全部"（all）模式。这个问题出现在普通步骤卡片和循环执行中。

## 根因分析

通过分析执行日志和代码，发现问题在于：

1. **参数传递链断裂**：`smartSelection` 配置在 `convertSmartStepToV2Request` 转换过程中被完全忽略
2. **接口类型缺失**：`StepExecutionRequest` 和 `V2ExecutionRequest` 接口中缺少 `smartSelection` 字段
3. **后端参数缺失**：转换到 `RunStepRequestV2` 时没有传递智能选择配置

## 修复措施

### 1. 扩展接口定义

**修改文件**: `src/infrastructure/gateways/StepExecutionGateway.ts`
- 在 `StepExecutionRequest` 接口中添加 `smartSelection` 参数

**修改文件**: `src/infrastructure/gateways/adapters/v2Adapter.ts`  
- 在 `V2ExecutionRequest` 接口中添加完整的智能选择和其他必要参数

**修改文件**: `src/types/runStepV2.ts`
- 在 `BaseStep` 接口中添加智能选择配置支持

### 2. 修复参数传递

**修改文件**: `src/hooks/useV2StepTest.ts`
- 在 `convertSmartStepToV2Request` 函数中提取并传递 `smartSelection` 配置
- 添加调试日志用于参数验证

**修改文件**: `src/infrastructure/gateways/StepExecutionGateway.ts`
- 在 `executeV2` 方法中传递所有必要参数到 V2 适配器

**修改文件**: `src/infrastructure/gateways/adapters/v2Adapter.ts`
- 在 `convertToV2Request` 函数中将智能选择参数添加到 `baseStep`

## 修复效果

修复后的参数传递链：

```
用户选择模式 → SmartScriptStep.parameters.smartSelection 
→ convertSmartStepToV2Request 提取
→ StepExecutionRequest.smartSelection 
→ V2ExecutionRequest.smartSelection
→ RunStepRequestV2.step.smartSelection
→ 后端处理
```

## 验证方法

1. **参数日志检查**：查看 `convertSmartStepToV2Request` 的调试日志
   ```
   🎯 [V2转换] smartSelection配置检查: { hasSmartSelection: true, mode: 'first', ... }
   ```

2. **后端日志确认**：确保后端收到正确的 `mode` 参数
   ```
   "smartSelection": { "mode": "first", ... } // 而不是 "all"
   ```

## 注意事项

- 修复涵盖了所有执行路径：单步测试、循环执行、脚本执行
- 保持了完整的向后兼容性
- 添加了调试日志便于问题追踪

## 测试建议

1. 创建一个包含"关注"按钮的步骤
2. 设置智能选择模式为"第一个"
3. 执行步骤并检查日志
4. 确认只点击一个元素而不是批量执行

修复完成后，用户选择的模式应该正确传递到后端并按预期执行。