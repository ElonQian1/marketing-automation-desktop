<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精确主题协调器测试页面</title>
    <style>
        /* 模拟循环卡片样式 */
        .step-card {
            margin: 10px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: white;
        }
        
        .step-card .loop-skin {
            background: #f0f0f0;
            padding: 10px;
            margin: 5px 0;
        }
        
        /* 模拟ADB检查器样式 */
        .adb-inspector {
            margin: 10px;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #2d2d2d;
            color: #fff;
        }
        
        .adb-xml-content {
            background: #1e1e1e;
            color: #e6e6e6;
            padding: 10px;
            font-family: monospace;
        }
        
        /* 其他暗色组件 */
        .dark-component {
            background: #333;
            color: #fff;
            padding: 15px;
            margin: 10px;
            border-radius: 5px;
        }
        
        /* 控制按钮 */
        .controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            z-index: 1000;
        }
        
        .controls button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
        }
        
        /* 状态显示 */
        .status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h4>精确主题协调器测试</h4>
        <button onclick="analyzeCurrentState()">分析当前状态</button>
        <button onclick="forceRefixLoopCards()">强制修复循环卡片</button>
        <button onclick="forceProtectDarkTheme()">强制保护暗色主题</button>
        <button onclick="toggleDebugMode()">切换调试模式</button>
        <button onclick="getStats()">获取统计信息</button>
        <button onclick="clearHighlights()">清除高亮</button>
    </div>
    
    <div class="status" id="status">
        状态：加载中...
    </div>
    
    <h1>精确主题协调器测试页面</h1>
    
    <h2>模拟循环卡片区域</h2>
    <div class="step-card" data-test-type="loop-card">
        <h3>循环卡片 #1</h3>
        <div class="loop-skin">
            这是一个循环皮肤内容，应该保持白色背景和黑色文字
        </div>
        <p>这个卡片应该被精确主题协调器识别为循环卡片</p>
    </div>
    
    <div class="step-card loop-card" data-test-type="loop-card">
        <h3>循环卡片 #2</h3>
        <div class="loop-skin">
            另一个循环皮肤，测试批量处理
        </div>
        <p>这也是一个循环卡片</p>
    </div>
    
    <h2>模拟ADB检查器区域</h2>
    <div class="adb-inspector" data-test-type="adb-inspector">
        <h3>ADB XML 检查器</h3>
        <div class="adb-xml-content">
            &lt;node index="0" text="Button" class="android.widget.Button"&gt;
                &lt;node index="1" text="Click me" bounds="[100,200][300,250]"/&gt;
            &lt;/node&gt;
        </div>
        <p>这个区域应该保持暗色主题，不被循环卡片修复器影响</p>
    </div>
    
    <h2>其他暗色组件</h2>
    <div class="dark-component" data-test-type="dark-component">
        <h3>普通暗色组件</h3>
        <p>这是一个普通的暗色主题组件，应该被保护器保护</p>
    </div>
    
    <div class="dark-component" data-test-type="dark-component">
        <h3>另一个暗色组件</h3>
        <p>这也应该保持暗色主题</p>
    </div>
    
    <script>
        // 等待页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('页面加载完成，等待精确主题协调器初始化...');
            
            // 等待精确主题协调器初始化
            setTimeout(function() {
                checkThemeCoordinator();
            }, 1000);
            
            // 定期更新状态
            setInterval(function() {
                updateStats();
            }, 5000);
        });
        
        function checkThemeCoordinator() {
            if (typeof window.preciseThemeCoordinator !== 'undefined') {
                updateStatus('✅ 精确主题协调器已加载');
                logAvailableMethods();
            } else {
                updateStatus('❌ 精确主题协调器未找到');
            }
        }
        
        function logAvailableMethods() {
            const methods = [
                'preciseThemeCoordinator',
                'getPreciseThemeStats',
                'analyzeThemeConflicts',
                'fixPreciseLoopCards',
                'protectDarkTheme',
                'analyzeLoopSelectors',
                'highlightLoopCards',
                'removeLoopHighlight'
            ];
            
            let available = [];
            let missing = [];
            
            methods.forEach(method => {
                if (typeof window[method] !== 'undefined') {
                    available.push(method);
                } else {
                    missing.push(method);
                }
            });
            
            console.log('🔧 可用的调试方法:', available);
            if (missing.length > 0) {
                console.log('⚠️ 缺失的方法:', missing);
            }
        }
        
        function analyzeCurrentState() {
            if (typeof window.analyzeThemeConflicts === 'function') {
                window.analyzeThemeConflicts();
                updateStatus('🔍 主题冲突分析完成，查看控制台');
            } else {
                updateStatus('❌ analyzeThemeConflicts 方法不可用');
            }
        }
        
        function forceRefixLoopCards() {
            if (typeof window.fixPreciseLoopCards === 'function') {
                window.fixPreciseLoopCards();
                updateStatus('🔧 强制修复循环卡片完成');
            } else {
                updateStatus('❌ fixPreciseLoopCards 方法不可用');
            }
        }
        
        function forceProtectDarkTheme() {
            if (typeof window.protectDarkTheme === 'function') {
                window.protectDarkTheme();
                updateStatus('🛡️ 强制保护暗色主题完成');
            } else {
                updateStatus('❌ protectDarkTheme 方法不可用');
            }
        }
        
        function toggleDebugMode() {
            if (typeof window.hybridThemeOverrideManager !== 'undefined') {
                if (typeof window.hybridThemeOverrideManager.enableDebug === 'function') {
                    window.hybridThemeOverrideManager.enableDebug();
                    updateStatus('🔧 调试模式已启用');
                } else {
                    updateStatus('❌ enableDebug 方法不可用');
                }
            } else {
                updateStatus('❌ hybridThemeOverrideManager 不可用');
            }
        }
        
        function getStats() {
            if (typeof window.getPreciseThemeStats === 'function') {
                const stats = window.getPreciseThemeStats();
                console.log('📊 精确主题协调器统计:', stats);
                updateStatus('📊 统计信息已输出到控制台');
            } else {
                updateStatus('❌ getPreciseThemeStats 方法不可用');
            }
        }
        
        function clearHighlights() {
            if (typeof window.removeLoopHighlight === 'function') {
                window.removeLoopHighlight();
                updateStatus('🧹 高亮清除完成');
            } else {
                updateStatus('❌ removeLoopHighlight 方法不可用');
            }
        }
        
        function updateStats() {
            if (typeof window.getPreciseThemeStats === 'function') {
                const stats = window.getPreciseThemeStats();
                const statusEl = document.getElementById('status');
                const content = `
                    精确主题协调器状态：
                    - 已初始化: ${stats.initialized ? '✅' : '❌'}
                    - 有效循环卡片: ${stats.validLoopCards}
                    - 暗色保护元素: ${stats.darkProtectedElements}
                    - 循环卡片修复: ${stats.loopCardFixer?.fixedCards || 0}
                    - 暗色主题保护: ${stats.darkThemeProtector?.protectedElements || 0}
                    - 冲突检测: ${stats.conflictResolver?.conflictsDetected || 0}
                `;
                statusEl.innerHTML = content.replace(/\n\s+/g, '<br>').trim();
            }
        }
        
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusEl.innerHTML = `[${timestamp}] ${message}`;
            console.log(`[${timestamp}] ${message}`);
        }
    </script>
</body>
</html>