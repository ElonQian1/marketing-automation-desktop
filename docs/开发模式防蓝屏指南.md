# 开发模式防蓝屏指南

## 🚨 问题背景

你提到在开发过程中经常遇到蓝屏问题，怀疑是内存泄漏导致的。经过代码审查，我们发现了以下风险点并已修复。

---

## ✅ 已修复的风险点

### 1. **ADB设备跟踪器连接泄漏**

**问题**：
- `TcpStream`连接在超时后没有显式关闭
- Windows系统可能不会立即释放网络资源
- 30秒一次的重连循环可能累积大量未关闭的连接

**修复**（已完成）：
```rust
// src-tauri/src/services/adb_device_tracker.rs

// ✅ 在函数结束时显式关闭连接
let _ = stream.shutdown(std::net::Shutdown::Both);
debug!("🧹 TcpStream已关闭");
```

**影响**：
- 防止Windows系统累积半开连接
- 确保资源在每次重连前被正确释放

---

### 2. **无限重连循环优化**

**问题**：
- 连接失败后立即重试，可能快速消耗系统资源
- 没有退出提示信息，难以调试

**修复**（已完成）：
```rust
// ✅ 添加停止信号日志
if !*running {
    info!("⏹️ 收到停止信号，退出设备跟踪循环");
    break;
}

// ✅ 防止无限重连导致资源耗尽，添加延迟
sleep(Duration::from_millis(500)).await;
```

**影响**：
- 降低CPU占用，防止连接风暴
- 提供明确的退出日志，便于调试

---

## 📊 日志系统安全性分析

### ✅ **不会导致内存泄漏**

1. **tracing日志（后端控制台）**：
   - ❌ 不会显示在前端浏览器控制台
   - ✅ 直接输出到stdout，不累积内存
   - ✅ 每条日志处理后立即释放

2. **LOG_COLLECTOR（可发送到前端）**：
   - ✅ 有容量限制：最多1000条
   - ✅ 超出时自动删除最旧的（`VecDeque::pop_front()`）
   - ✅ 固定内存占用：~500KB（可忽略）

### 📝 日志级别建议

**开发模式**（当前）：
```rust
// main.rs
"info,employee_gui=debug"  // 显示详细调试信息
```

**生产模式**（建议）：
```rust
// 修改为仅显示警告和错误
"warn,employee_gui=info"
```

或通过环境变量控制：
```bash
# 开发模式（详细日志）
RUST_LOG=debug npm run tauri dev

# 生产模式（精简日志）
RUST_LOG=warn npm run tauri build
```

---

## 🛡️ 防蓝屏最佳实践

### 1. **定期重启开发环境**

开发模式下推荐每2-3小时重启一次`npm run tauri dev`：
```powershell
# 1. 停止当前进程（Ctrl+C）
# 2. 清理Rust缓存（可选，仅在怀疑编译问题时使用）
cargo clean

# 3. 重新启动
npm run tauri dev
```

### 2. **监控系统资源**

使用Windows任务管理器（Ctrl+Shift+Esc）监控：
- **内存占用**：超过1.5GB时重启
- **句柄数**：超过5000时警惕
- **CPU持续100%**：检查是否有死循环

### 3. **使用增量编译**

在`src-tauri/.cargo/config.toml`中已配置：
```toml
[build]
incremental = true  # ✅ 已启用
```

### 4. **避免频繁全量编译**

```powershell
# ❌ 避免使用（除非必要）
cargo clean

# ✅ 使用检查模式（不生成可执行文件）
cargo check

# ✅ 增量编译（默认）
cargo build
```

---

## 🔍 问题排查清单

如果再次遇到蓝屏，按以下步骤排查：

### Step 1: 检查内存占用
```powershell
# 查看Rust进程内存
Get-Process | Where-Object {$_.ProcessName -like "*employee*"} | Select-Object ProcessName, WS
```

### Step 2: 检查后台任务
```powershell
# 查看是否有遗留的ADB进程
Get-Process | Where-Object {$_.ProcessName -like "*adb*"}

# 如果有，可以杀掉
Stop-Process -Name "adb" -Force
```

### Step 3: 检查日志输出
查看后端控制台是否有：
- `❌ ADB设备跟踪连接失败` - 频繁出现表示网络问题
- `⚠️ 内存使用警告` - 表示内存压力
- `🔄 准备重连` - 30秒一次正常，1秒多次异常

### Step 4: 清理临时文件
```powershell
# 清理Rust编译缓存
cd "d:\rust\active-projects\小红书\employeeGUI\src-tauri"
cargo clean

# 清理Node模块（如果必要）
cd ..
Remove-Item -Recurse -Force node_modules
npm install
```

---

## 🎯 代码层面保护措施总结

| 保护措施 | 状态 | 说明 |
|---------|------|------|
| TcpStream显式关闭 | ✅ 已实现 | 防止连接泄漏 |
| 重连延迟保护 | ✅ 已实现 | 防止连接风暴 |
| 日志容量限制 | ✅ 已实现 | 固定1000条上限 |
| 退出信号日志 | ✅ 已实现 | 便于调试 |
| broadcast channel限制 | ✅ 已实现 | 容量100 |

---

## 💡 建议的开发工作流

```
1. 启动开发环境
   └─> npm run tauri dev

2. 开发2-3小时后
   └─> 停止(Ctrl+C) → 重启

3. 发现内存异常
   └─> 检查任务管理器 → 查看后端日志 → 重启

4. 提交代码前
   └─> cargo check (快速检查)
   └─> 重启测试 (确保没有内存泄漏)
```

---

## 📞 紧急情况处理

如果开发过程中系统变得非常卡顿：

1. **立即保存所有文件**（VS Code会自动保存）
2. **强制结束进程**：
   ```powershell
   Stop-Process -Name "employee-gui" -Force
   Stop-Process -Name "adb" -Force
   ```
3. **重启电脑**（如果无法恢复）
4. **检查Windows事件查看器**：
   - Win+R → `eventvwr.msc`
   - 查看"Windows日志 → 系统"中的错误

---

## 🔧 未来改进计划

如果问题仍然频繁出现，可以考虑：

1. **添加内存监控**（需要添加sysinfo依赖）
2. **实现自动重启机制**（检测到高内存时自动重启ADB跟踪器）
3. **限制日志输出频率**（开发模式减少DEBUG日志）
4. **使用发布模式开发**（`cargo build --release`）

---

## ✅ 结论

**当前修复已大幅降低内存泄漏风险**：
- ✅ TcpStream连接会正确关闭
- ✅ 日志不会无限累积
- ✅ 重连循环有保护机制

**正常使用建议**：
- 每2-3小时重启开发环境
- 监控任务管理器内存占用
- 遇到异常立即保存并重启

如果仍遇到蓝屏，很可能是**其他因素**：
- 硬件问题（内存条、电源）
- Windows驱动问题
- 其他后台程序冲突

建议先观察修复后的效果，如有需要再进一步排查。
