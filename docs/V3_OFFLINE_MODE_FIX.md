# V3 离线模式与评分显示修复报告

## 1. 问题分析

用户反馈在点击瀑布流卡片（透明层）时：
1.  **UI卡顿/报错**：前端提示 "没有选中的设备"，导致 UI 冻结。
2.  **评分显示不全**：第一次只显示部分分数，刷新后才显示完整。
3.  **评分疑问**：透明层点击后，文本评分为 0 是否合理。

### 根因定位

通过分析 `1.2、前端日志.md` 和 `use-intelligent-analysis-workflow.ts` 代码：

1.  **UI卡顿与显示不全**：
    *   用户在分析 "缓存的XML"（离线/无设备连接状态）。
    *   V3 工作流强制检查 `deviceId`，发现无设备时抛出错误。
    *   错误触发 `catch` 块，执行 "V3 -> V2 降级回退"。
    *   降级过程触发了 React 状态切换 (`currentExecutionVersion` 变更为 "v2")。
    *   **Race Condition**：状态切换导致事件监听器重置，而此时后端分析已经极快完成（因为是缓存），导致前端错过了部分 `analysis:done` 事件或渲染时机不对，造成 UI 闪烁、卡顿和评分显示不完整。

2.  **评分合理性**：
    *   后端日志显示：
        *   `heuristic_id_scoring`: **0.95** (结构ID匹配极好)
        *   `card_subtree_scoring`: **0.812** (卡片内部结构匹配很好)
        *   `text_exact_scoring`: **0.00** (文本匹配为0)
    *   **结论**：这是完全正确的。用户点击的是 "透明点选层" (`FrameLayout`)，该节点本身**没有文本**。文本存在于其子节点中（由 `card_subtree_scoring` 覆盖）。因此文本分为 0 是符合预期的。

## 2. 修复方案

已修改 `src/modules/universal-ui/hooks/use-intelligent-analysis-workflow.ts`：

1.  **启用 V3 离线模式**：
    *   在检查设备 ID 时，如果发现存在 `xmlCacheId` 或 `snapshotId`（即分析缓存/快照），则允许 `deviceId` 为空。
    *   自动注入虚拟设备 ID `"offline_snapshot_mode"`。
    *   将 `xmlCacheId` 传递给 V3 后端配置。

2.  **消除降级回退**：
    *   现在 V3 可以在无设备情况下直接分析缓存，不再抛出错误。
    *   不再触发 V2 降级，避免了 UI 状态切换和事件监听器重置。
    *   消除了 UI 卡顿和竞态条件。

## 3. 验证预期

1.  **流畅度**：点击分析应立即响应，无卡顿。
2.  **完整性**：评分应一次性全部显示，无需刷新。
3.  **准确性**：
    *   "智能自动链" 徽章应为绿色（基于 0.95 的高分）。
    *   文本评分 0 是正常的（针对透明层）。

## 4. 后续建议

*   如果用户需要执行操作（如点击），则必须连接设备。但在 "分析/生成卡片" 阶段，离线模式现在已完全支持。
