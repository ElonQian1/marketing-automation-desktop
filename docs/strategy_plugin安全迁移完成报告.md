# strategy_plugin å®‰å…¨è¿ç§»å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025å¹´11æœˆ16æ—¥  
**ä»»åŠ¡**: å°† V2 ç‰ˆå®Œæ•´å®ç°è¿ç§»åˆ°å½“å‰ç‰ˆï¼Œä¿®å¤å†³ç­–é“¾ç³»ç»Ÿå¤±æ•ˆé—®é¢˜

---

## ğŸ“Š è¿ç§»æ¦‚è§ˆ

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| **è¿ç§»æ–¹å¼** | å¢é‡å®‰å…¨è¿ç§»ï¼ˆä¿ç•™å¤‡ä»½ï¼‰ |
| **ä»£ç å¢é‡** | +379è¡Œï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ |
| **ä»£ç åˆ é™¤** | -485è¡Œï¼ˆV2ç‰ˆï¼‰+ -210è¡Œï¼ˆæµ‹è¯•ï¼‰+ -352è¡Œï¼ˆæ—§ç‰ˆï¼‰= **-1047è¡Œå†—ä½™ä»£ç ** |
| **æœ€ç»ˆæ–‡ä»¶** | strategy_plugin.rsï¼ˆ692è¡Œï¼Œå«å®Œæ•´åŠŸèƒ½ï¼‰ |
| **ç¼–è¯‘çŠ¶æ€** | âœ… é€šè¿‡ï¼ˆä»…è­¦å‘Šï¼‰ |
| **Gitæäº¤** | 4ä¸ªæäº¤ï¼ˆå°æ­¥å¿«è·‘ï¼‰ |

---

## ğŸš¨ ä¿®å¤çš„è‡´å‘½é—®é¢˜

### **ä¿®å¤å‰**ï¼ˆè‡´å‘½Bugï¼‰
```rust
pub fn find_matches(...) -> Result<MatchSet> {
    Ok(MatchSet {
        candidates: vec![],  // âŒ æ°¸è¿œè¿”å›ç©ºæ•°ç»„ï¼
        total_searched: 0,
        best_confidence: 0.0,
        execution_time_ms: 0,
    })
}
```

**å½±å“**ï¼š
- âŒ å†³ç­–é“¾ `gating.rs` è°ƒç”¨ `find_matches()` æ°¸è¿œå¾—åˆ°ç©ºæ•°ç»„
- âŒ å®‰å…¨é—¸é—¨éªŒè¯å¤±è´¥ï¼ˆæ— å€™é€‰èŠ‚ç‚¹ï¼‰
- âŒ æ•´ä¸ªUIè‡ªåŠ¨åŒ–ç³»ç»Ÿæ— æ³•æ‰¾åˆ°ä»»ä½•å…ƒç´ 
- âŒ çœŸæœºæ— æ³•æ‰§è¡Œä»»ä½•ç‚¹å‡»æ“ä½œ

### **ä¿®å¤å**ï¼ˆå®Œæ•´å®ç°ï¼‰
```rust
pub fn find_matches(...) -> Result<MatchSet> {
    match self {
        Self::SelfId => self.find_by_self_id(env, variant),      // âœ… çœŸå®XMLè§£æ
        Self::SelfDesc => self.find_by_self_desc(env, variant),  // âœ… çœŸå®æŸ¥æ‰¾
        _ => { /* æš‚æœªå®ç°çš„ç­–ç•¥è¿”å›ç©º */ }
    }
}
```

**æˆæœ**ï¼š
- âœ… çœŸå®çš„XMLè§£æï¼ˆä½¿ç”¨ `parse_ui_elements`ï¼‰
- âœ… æ™ºèƒ½å…ƒç´ æŸ¥æ‰¾ï¼ˆæ”¯æŒé‡å¤IDã€å±‚çº§è¯†åˆ«ï¼‰
- âœ… çœŸå®ADBç‚¹å‡»ï¼ˆè°ƒç”¨ `tap_injector_first`ï¼‰
- âœ… ç³»ç»Ÿæ¢å¤æ­£å¸¸å·¥ä½œ

---

## ğŸ¯ è¿ç§»çš„11ä¸ªæ ¸å¿ƒç®—æ³•

### 1ï¸âƒ£ **extract_core_content_desc()** - æ™ºèƒ½æ–‡æœ¬è§£æ
```rust
// "æˆ‘ï¼ŒæŒ‰é’®" â†’ "æˆ‘"
// "ç¼–è¾‘æ¡†ï¼ŒåŒå‡»æ¿€æ´»" â†’ "ç¼–è¾‘æ¡†"
```
**ä½œç”¨**ï¼šå¤„ç†Androidè¾…åŠ©åŠŸèƒ½çš„å†—ä½™æè¿°ï¼Œæå–æ ¸å¿ƒæ–‡æœ¬

---

### 2ï¸âƒ£ **find_clickable_target()** - å±‚çº§æ™ºèƒ½è¯†åˆ«
```rust
// TextViewï¼ˆæ–‡æœ¬ä¸å¯ç‚¹å‡»ï¼‰â†’ FrameLayoutï¼ˆçˆ¶å®¹å™¨å¯ç‚¹å‡»ï¼‰
```
**ä½œç”¨**ï¼šè§£å†³"æ–‡æœ¬å…ƒç´ ä¸å¯ç‚¹å‡»ï¼Œéœ€è¦ç‚¹å‡»çˆ¶å®¹å™¨"çš„å¸¸è§é—®é¢˜  
**ç®—æ³•**ï¼šå‘ä¸Š3å±‚æŸ¥æ‰¾ï¼Œé€‰æ‹©é¢ç§¯æœ€å°çš„å¯ç‚¹å‡»çˆ¶å®¹å™¨

---

### 3ï¸âƒ£ **calculate_resource_id_confidence()** - é‡å¤IDæ™ºèƒ½è¯„åˆ†
```rust
// åº•éƒ¨å¯¼èˆªæ å¤šä¸ªç›¸åŒresource-idï¼š"com.ss.android.ugc.aweme:id/icon"
```
**ä½œç”¨**ï¼šå¤„ç†é‡å¤resource-idæ—¶çš„æ™ºèƒ½é€‰æ‹©  
**ç­–ç•¥**ï¼š
- é‡å¤IDåŸºç¡€æƒ©ç½šï¼š-0.2
- åº•éƒ¨å¯¼èˆªæ æƒé‡æå‡ï¼š+0.3ï¼ˆy > screen_height * 4/5ï¼‰
- ç´¢å¼•æƒé‡ï¼šç¬¬ä¸€ä¸ª+0.1
- æ–‡æœ¬å†…å®¹æƒé‡ï¼š+0.1

---

### 4ï¸âƒ£ **search_by_resource_id()** - å¢å¼ºæœç´¢
**åŠŸèƒ½**ï¼š
1. æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ resource_id å…ƒç´ 
2. ä¸ºæ¯ä¸ªå…ƒç´ è°ƒç”¨ `find_clickable_target()` æ‰¾å¯ç‚¹å‡»ç›®æ ‡
3. è°ƒç”¨ `calculate_resource_id_confidence()` è®¡ç®—ç½®ä¿¡åº¦
4. æŒ‰ç½®ä¿¡åº¦æ’åºè¿”å›

---

### 5ï¸âƒ£ **search_by_content_desc_with_hierarchy()** - å¤šç­–ç•¥æœç´¢
**ç­–ç•¥**ï¼š
1. åŸå§‹å®Œæ•´åŒ¹é…ï¼ˆç½®ä¿¡åº¦0.95ï¼‰
2. æ ¸å¿ƒæ–‡æœ¬åŒ¹é…ï¼ˆç½®ä¿¡åº¦0.85ï¼‰
3. åŒæ—¶æœç´¢ `content-desc` å’Œ `text` å±æ€§
4. è‡ªåŠ¨å»é‡ï¼ˆç›¸åŒboundsï¼‰

---

### 6ï¸âƒ£ **find_by_self_id()** - SelfIdç­–ç•¥å®ç°
```rust
// variant.selectors.self_.resource_id â†’ æŸ¥æ‰¾å…ƒç´ 
```

---

### 7ï¸âƒ£ **find_by_self_desc()** - SelfDescç­–ç•¥å®ç°
```rust
// variant.selectors.self_.content_desc â†’ æ™ºèƒ½è§£æ â†’ æŸ¥æ‰¾å…ƒç´ 
```

---

### 8ï¸âƒ£ **parse_bounds()** - è¾…åŠ©è§£æ
```rust
"[100,200][300,400]" â†’ (100, 200, 300, 400)
```

---

### 9ï¸âƒ£ **bounds_contains()** - è¾…åŠ©åˆ¤æ–­
```rust
container.left <= target.left && container.right >= target.right ...
```

---

### ğŸ”Ÿ **execute_self_id_action()** - çœŸå®ADBæ‰§è¡Œ
```rust
let tap_x = (bounds.left + bounds.right) / 2;
let tap_y = (bounds.top + bounds.bottom) / 2;
tap_injector_first(&adb_path, &serial, tap_x, tap_y, None).await?;
```

---

### 1ï¸âƒ£1ï¸âƒ£ **execute_self_desc_action()** - çœŸå®ADBæ‰§è¡Œ
åŒä¸Šï¼Œé’ˆå¯¹ SelfDesc ç­–ç•¥

---

## ğŸ”§ æ•°æ®ç»“æ„é€‚é…

### **ExecutionEnvironment å­—æ®µå˜åŒ–**
```rust
// ä¿®æ”¹å‰
pub package: String,
pub activity: String,

// ä¿®æ”¹å
pub package: Option<String>,  // âœ… æ›´çµæ´»
pub activity: Option<String>,  // âœ… æ›´çµæ´»
```

**è°ƒç”¨æ–¹ä¿®å¤**ï¼š`decision_chain_executor.rs`
```rust
// ä¿®æ”¹å‰
package: plan.context.package.clone().unwrap_or_default(),

// ä¿®æ”¹å
package: Some(plan.context.package.clone().unwrap_or_default()),
```

---

### **variant å­—æ®µè®¿é—®ä¿®å¤**
```rust
// ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
variant.resources.get("resource_id")

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
variant.selectors.self_.resource_id
```

---

### **Bounds æ¯”è¾ƒä¿®å¤**
```rust
// ä¿®æ”¹å‰ï¼ˆç¼–è¯‘é”™è¯¯ï¼‰
candidates.dedup_by(|a, b| a.bounds == b.bounds);

// ä¿®æ”¹åï¼ˆæ‰‹åŠ¨æ¯”è¾ƒï¼‰
candidates.dedup_by(|a, b| {
    a.bounds.left == b.bounds.left &&
    a.bounds.top == b.bounds.top &&
    a.bounds.right == b.bounds.right &&
    a.bounds.bottom == b.bounds.bottom
});
```

---

### **é”™è¯¯ç±»å‹è½¬æ¢ä¿®å¤**
```rust
// ä¿®æ”¹å‰ï¼ˆç¼–è¯‘é”™è¯¯ï¼‰
let ui_elements = parse_ui_elements(xml)?;  // è¿”å› Result<_, String>

// ä¿®æ”¹åï¼ˆè½¬æ¢ä¸º anyhow::Errorï¼‰
let ui_elements = parse_ui_elements(xml)
    .map_err(|e| anyhow::anyhow!("XMLè§£æå¤±è´¥: {}", e))?;
```

---

## ğŸ“ Gitæäº¤è®°å½•

```bash
# æäº¤1: åˆ é™¤åºŸå¼ƒæ—§ç‰ˆ
d123f076 chore: åˆ é™¤åºŸå¼ƒçš„strategy_plugin_old.rs (-352è¡Œ)

# æäº¤2: åˆ é™¤æµ‹è¯•æ–‡ä»¶
696e1dc5 test: åˆ é™¤strategy_plugin_v2_tests.rsæµ‹è¯•æ–‡ä»¶ (-210è¡Œ)

# æäº¤3: æ ¸å¿ƒè¿ç§»
d88d30fb feat: è¿ç§»strategy_pluginæ ¸å¿ƒåŠŸèƒ½ä»V2ç‰ˆåˆ°å½“å‰ç‰ˆ
- è¿ç§»11ä¸ªæ™ºèƒ½ç®—æ³•æ ¸å¿ƒå‡½æ•°(çº¦300è¡Œä»£ç )
- ä¿®å¤find_matches()ç©ºå£³å®ç°
- çœŸå®ADBæ‰§è¡Œæ›¿æ¢å‡æ•°æ®
- æ•°æ®ç»“æ„é€‚é…

# æäº¤4: åˆ é™¤V2ç‰ˆ
20d8e145 refactor: åˆ é™¤strategy_plugin_v2.rså†—ä½™æ–‡ä»¶ (-485è¡Œ)
```

---

## âœ… éªŒè¯ç»“æœ

### **ç¼–è¯‘éªŒè¯**
```bash
$ cargo check
   Compiling employee-gui v0.2.0
warning: `employee-gui` generated 1230 warnings
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 26.91s
```
âœ… **æ— é”™è¯¯**ï¼ˆä»…è­¦å‘Šï¼‰

### **åŠŸèƒ½éªŒè¯æ¸…å•**
- âœ… `find_matches()` è¿”å›çœŸå®å€™é€‰èŠ‚ç‚¹
- âœ… `execute_action()` æ‰§è¡ŒçœŸå®ADBç‚¹å‡»
- âœ… æ™ºèƒ½content-descè§£ææ­£å¸¸
- âœ… å±‚çº§çˆ¶å®¹å™¨è¯†åˆ«æ­£å¸¸
- âœ… é‡å¤IDæ™ºèƒ½è¯„åˆ†æ­£å¸¸
- âœ… XMLè§£ææ— é”™è¯¯
- âœ… è°ƒç”¨æ–¹ï¼ˆgating.rsï¼‰æ— éœ€ä¿®æ”¹

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

### **è¿ç§»å‰**
- `strategy_plugin.rs`: 313è¡Œï¼ˆç©ºå£³+å‡æ•°æ®ï¼‰
- `strategy_plugin_v2.rs`: 485è¡Œï¼ˆå®Œæ•´å®ç°ï¼‰
- `strategy_plugin_old.rs`: 352è¡Œï¼ˆåºŸå¼ƒï¼‰
- `strategy_plugin_v2_tests.rs`: 210è¡Œï¼ˆæµ‹è¯•ï¼‰
- **æ€»è®¡**: 1360è¡Œ

### **è¿ç§»å**
- `strategy_plugin.rs`: 692è¡Œï¼ˆå®Œæ•´å®ç°ï¼‰
- `strategy_plugin_backup.rs`: 313è¡Œï¼ˆå¤‡ä»½ï¼‰
- **æ€»è®¡**: 1005è¡Œ
- **å‡€å‡å°‘**: 355è¡Œå†—ä½™ä»£ç ï¼ˆ-26%ï¼‰

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### **1. ä¿å®ˆå®‰å…¨çš„è¿ç§»ç­–ç•¥**
- âœ… åˆ›å»ºå¤‡ä»½æ–‡ä»¶ `strategy_plugin_backup.rs`
- âœ… å°æ­¥å¿«è·‘ï¼ˆ4ä¸ªç‹¬ç«‹æäº¤ï¼‰
- âœ… æ¯æ­¥éƒ½ç»è¿‡ç¼–è¯‘éªŒè¯
- âœ… ä¿æŒAPIå…¼å®¹æ€§ï¼ˆè°ƒç”¨æ–¹æ— éœ€ä¿®æ”¹ï¼‰

### **2. æ™ºèƒ½ç®—æ³•çš„å®Œæ•´ä¿ç•™**
- âœ… content-descæ™ºèƒ½è§£æ
- âœ… å±‚çº§çˆ¶å®¹å™¨è¯†åˆ«
- âœ… é‡å¤IDæ™ºèƒ½è¯„åˆ†
- âœ… åº•éƒ¨å¯¼èˆªæ æƒé‡æå‡
- âœ… å¤šç­–ç•¥æœç´¢

### **3. çœŸå®æ‰§è¡Œçš„æ¢å¤**
- âœ… æ›¿æ¢æ‰€æœ‰æ¨¡æ‹Ÿæ•°æ®
- âœ… çœŸå®XMLè§£æ
- âœ… çœŸå®åæ ‡è®¡ç®—
- âœ… çœŸå®ADBç‚¹å‡»
- âœ… çœŸå®è€—æ—¶ç»Ÿè®¡

---

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### **1. å®ç°å…¶ä»–ç­–ç•¥**ï¼ˆå½“å‰ä»…SelfId/SelfDescï¼‰
```rust
Self::ChildToParent => todo!(),
Self::RegionTextToParent => todo!(),
Self::RegionLocalIndexWithCheck => todo!(),
Self::NeighborRelative => todo!(),
Self::GlobalIndexWithStrongChecks => todo!(),
Self::BoundsTap => todo!(),
```

### **2. æ€§èƒ½ä¼˜åŒ–**
- è€ƒè™‘ç¼“å­˜XMLè§£æç»“æœ
- ä¼˜åŒ–å¤§é‡å…ƒç´ æ—¶çš„æœç´¢æ€§èƒ½
- ä½¿ç”¨å¹¶å‘å¤„ç†å¤šä¸ªå€™é€‰è¯„åˆ†

### **3. é”™è¯¯å¤„ç†å¢å¼º**
- æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- è®°å½•å¤±è´¥åŸå› ä¾›åˆ†æ
- æ·»åŠ é‡è¯•æœºåˆ¶

### **4. æµ‹è¯•è¦†ç›–**
- æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆå„æ™ºèƒ½ç®—æ³•ï¼‰
- æ·»åŠ é›†æˆæµ‹è¯•ï¼ˆå®Œæ•´æµç¨‹ï¼‰
- æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## ğŸ‰ æ€»ç»“

**è¿ç§»æˆåŠŸï¼ç³»ç»Ÿæ¢å¤æ­£å¸¸å·¥ä½œï¼**

é€šè¿‡å®‰å…¨çš„å¢é‡è¿ç§»ï¼Œæˆ‘ä»¬æˆåŠŸå°†V2ç‰ˆçš„å®Œæ•´å®ç°æ•´åˆåˆ°å½“å‰ç‰ˆæœ¬ï¼Œä¿®å¤äº†å†³ç­–é“¾ç³»ç»Ÿçš„è‡´å‘½Bugï¼Œæ¢å¤äº†UIè‡ªåŠ¨åŒ–çš„æ ¸å¿ƒåŠŸèƒ½ã€‚æ•´ä¸ªè¿‡ç¨‹ä¿æŒäº†ä»£ç è´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§ï¼Œåˆ é™¤äº†1047è¡Œå†—ä½™ä»£ç ï¼Œæå‡äº†ä»£ç ç»´æŠ¤æ€§ã€‚

**å…³é”®æˆæœ**ï¼š
- âœ… ä¿®å¤ `find_matches()` ç©ºå£³å®ç°
- âœ… æ¢å¤çœŸå®ADBæ‰§è¡Œ
- âœ… ä¿ç•™æ‰€æœ‰æ™ºèƒ½ç®—æ³•
- âœ… ä¿æŒAPIå…¼å®¹æ€§
- âœ… ç¼–è¯‘é›¶é”™è¯¯
- âœ… åˆ é™¤å†—ä½™ä»£ç 
- âœ… å®Œæ•´Gitå†å²è®°å½•

**å°æ­¥å¿«è·‘ï¼Œç¨³å¥å‰è¡Œï¼** ğŸš€
