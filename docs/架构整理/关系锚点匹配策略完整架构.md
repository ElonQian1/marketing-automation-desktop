# å…³ç³»é”šç‚¹åŒ¹é…ç­–ç•¥å®Œæ•´æ¶æ„

> **ç›®æ ‡**ï¼šè§£å†³"ä¸­å±‚æ— æ–‡æœ¬æŒ‰é’®"çš„ç²¾ç¡®åŒ¹é…é—®é¢˜ï¼Œä½¿ç”¨å­å…ƒç´ /å…„å¼Ÿå…ƒç´ /çˆ¶å…ƒç´ æ–‡æœ¬ä½œä¸ºé”šç‚¹

## ğŸ“‹ ç›®å½•

- [æ ¸å¿ƒé—®é¢˜](#æ ¸å¿ƒé—®é¢˜)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [è¯„åˆ†ç³»ç»Ÿ](#è¯„åˆ†ç³»ç»Ÿ)
- [æ‰§è¡Œæµç¨‹](#æ‰§è¡Œæµç¨‹)
- [æ–‡ä»¶ç»“æ„](#æ–‡ä»¶ç»“æ„)
- [æ•°æ®ä¼ é€’](#æ•°æ®ä¼ é€’)

---

## æ ¸å¿ƒé—®é¢˜

### é—®é¢˜æè¿°

ç”¨æˆ·ç‚¹å‡»çš„æ˜¯**ä¸­å±‚æ— æ–‡æœ¬å®¹å™¨**ï¼ˆå¦‚åº•éƒ¨å¯¼èˆªçš„"é€šè®¯å½•"æŒ‰é’®ï¼‰ï¼š

```
ç»“æ„å±‚æ¬¡ï¼š
â”œâ”€â”€ å¤–å±‚å®¹å™¨ [0,1043][1080,1279] âŒ å¤ªå¤§
â”‚   â”œâ”€â”€ ä¸­å±‚å®¹å™¨ [45,1059][249,1263] âœ… ç”¨æˆ·é€‰æ‹©çš„å¯ç‚¹å‡»å±‚
â”‚   â”‚   â””â”€â”€ å­å…ƒç´  Text="é€šè®¯å½•" ğŸ¯ é”šç‚¹
â”‚   â””â”€â”€ å…¶ä»–å…„å¼Ÿ...
```

**ä¼ ç»ŸåŒ¹é…é—®é¢˜**ï¼š
- âŒ ç›´æ¥æ–‡æœ¬åŒ¹é…ï¼šä¸­å±‚å®¹å™¨è‡ªå·±æ²¡æœ‰ text/content-desc
- âŒ Bounds åŒ¹é…ï¼šçœŸæœº XML ä¸­å…ƒç´ é¡ºåº/bounds å¯èƒ½å˜åŒ–
- âŒ å¤šå€™é€‰è¯„ä¼°å™¨ï¼šå®¹æ˜“é€‰é”™å¤–å±‚å¤§å®¹å™¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ä½¿ç”¨å­å…ƒç´ æ–‡æœ¬ "é€šè®¯å½•" ä½œä¸ºé”šç‚¹
- âœ… æ‰¾åˆ°æ‰€æœ‰åŒ…å« "é€šè®¯å½•" çš„å…ƒç´ 
- âœ… ç”¨å®Œå–„çš„è¯„åˆ†ç³»ç»Ÿé€‰æ‹©æœ€æ¥è¿‘ç”¨æˆ·é€‰æ‹©çš„å¯ç‚¹å‡»å±‚

---

## æ¶æ„è®¾è®¡

### 1ï¸âƒ£ å‰ç«¯ï¼šæ£€æµ‹å¹¶æ ‡è®°ç­–ç•¥

**æ–‡ä»¶**ï¼š`src/pages/SmartScriptBuilderPage/hooks/useIntelligentStepCardIntegration.ts`

```typescript
// ğŸ¯ æ£€æµ‹ä¸­å±‚æ— æ–‡æœ¬å®¹å™¨
const isMiddleLayerContainer = !element.text && context.elementText;

// è®¾ç½®åŒ¹é…ç­–ç•¥æ ‡è®°
const matchingStrategy = isMiddleLayerContainer 
  ? 'anchor_by_child_or_parent_text'  // ğŸ¯ å…³ç³»é”šç‚¹ç­–ç•¥
  : 'direct_match';                    // ç›´æ¥åŒ¹é…

// æå–é”šç‚¹æ•°æ®
elementSignature: {
  childrenTexts: ['é€šè®¯å½•'],        // å­å…ƒç´ æ–‡æœ¬
  siblingTexts: ['é€šè®¯å½•', 'è”ç³»äºº'], // å…„å¼Ÿå…ƒç´ æ–‡æœ¬
  parentInfo: { /* çˆ¶å…ƒç´ ä¿¡æ¯ */ },
  matchingStrategy: 'anchor_by_child_or_parent_text'
}
```

### 2ï¸âƒ£ æ•°æ®ä¼ é€’ï¼šå®Œæ•´ä¸Šä¸‹æ–‡

**æ–‡ä»¶**ï¼š`src/pages/SmartScriptBuilderPage/helpers/intelligentDataTransfer.ts`

```typescript
// æ„å»º original_dataï¼ˆåç«¯æ¢å¤æ•°æ®ï¼‰
original_data: {
  original_xml: "<58KB XMLå¿«ç…§>",
  selected_xpath: "//element_41",
  element_bounds: "[45,1059][249,1263]",
  
  // ğŸ¯ å…³é”®ï¼šå…³ç³»æ•°æ®
  children_texts: ["é€šè®¯å½•"],
  sibling_texts: ["é€šè®¯å½•", "è”ç³»äºº"],
  parent_info: { text: "", contentDesc: "åº•éƒ¨å¯¼èˆª" },
  
  // ğŸ¯ å…³é”®ï¼šç­–ç•¥æ ‡è®°
  matching_strategy: "anchor_by_child_or_parent_text"
}
```

### 3ï¸âƒ£ åç«¯ï¼šç­–ç•¥è·¯ç”±å™¨

**æ–‡ä»¶**ï¼š`src-tauri/src/exec/v3/recovery_manager.rs`

```rust
// ğŸ¯ Step 0: æ£€æŸ¥åŒ¹é…ç­–ç•¥æ ‡è®°
if let Some(ref strategy_tag) = recovery_ctx.matching_strategy {
    if strategy_tag.starts_with("anchor_by_") {
        // ğŸ¯ ä¼˜å…ˆä½¿ç”¨ç­–ç•¥è·¯ç”±å™¨
        match try_strategy_router(recovery_ctx, current_elements, strategy_tag) {
            Ok(result) => return Ok(result), // âœ… æˆåŠŸç›´æ¥è¿”å›
            Err(e) => {
                // âš ï¸ å¤±è´¥å›é€€åˆ°ä¼ ç»Ÿæµç¨‹
                tracing::warn!("ç­–ç•¥è·¯ç”±å™¨å¤±è´¥: {:?}, å›é€€", e);
            }
        }
    }
}

// Step 1-N: ä¼ ç»Ÿæ¢å¤æµç¨‹ï¼ˆåå¤‡ï¼‰
// ...
```

### 4ï¸âƒ£ ç­–ç•¥æ‰§è¡Œå™¨

**æ–‡ä»¶**ï¼š`src-tauri/src/services/execution/matching/strategies/anchor_by_relation_strategy.rs`

```rust
// æ ¸å¿ƒé€»è¾‘
impl AnchorByRelationStrategyProcessor {
    async fn process(&self, context, ui_elements) {
        // 1. æå–é”šç‚¹é…ç½®
        let config = extract_anchor_config(params);
        // config.anchor_texts = ["é€šè®¯å½•"]
        // config.user_bounds = "[45,1059][249,1263]"
        
        // 2. åœ¨ XML ä¸­æŸ¥æ‰¾åŒ…å«é”šç‚¹æ–‡æœ¬çš„å…ƒç´ 
        let candidates = find_elements_with_anchor_text(xml, &config.anchor_texts);
        // æ‰¾åˆ°ï¼šå¤–å±‚å®¹å™¨ã€ä¸­å±‚å®¹å™¨ã€å­æ–‡æœ¬å…ƒç´ ...
        
        // 3. ğŸ¯ ä½¿ç”¨è¯„åˆ†ç³»ç»Ÿé€‰æ‹©æœ€ä½³å€™é€‰
        let best = select_best_candidate(candidates, &config);
        
        // 4. è®¡ç®—ç‚¹å‡»åæ ‡å¹¶è¿”å›
        Ok(StrategyResult { xpath, coordinates, ... })
    }
}
```

---

## è¯„åˆ†ç³»ç»Ÿ

### ğŸ“Š è¯„åˆ†æƒé‡è®¾è®¡

**æ–‡ä»¶**ï¼š`src-tauri/src/services/execution/matching/strategies/candidate_scorer.rs`

```
æ€»åˆ† = æ–‡æœ¬åŒ¹é…(40åˆ†) + Boundsä½ç½®(30åˆ†) + å¯ç‚¹å‡»æ€§(20åˆ†) + å°ºå¯¸åˆç†æ€§(10åˆ†)
```

#### 1ï¸âƒ£ æ–‡æœ¬åŒ¹é…å¾—åˆ†ï¼ˆ40åˆ†ï¼‰- **æœ€é«˜ä¼˜å…ˆçº§**

```rust
if å…ƒç´ æ–‡æœ¬ == é”šç‚¹æ–‡æœ¬ {
    40åˆ†  // âœ… å®Œå…¨åŒ¹é… â†’ é«˜åˆ†ç›´æ¥é€‰å–
} else if å…ƒç´ æ–‡æœ¬.contains(é”šç‚¹æ–‡æœ¬) {
    20åˆ†  // âš ï¸ åŒ…å«åŒ¹é… â†’ ä¸­ç­‰åˆ†æ•°
} else {
    0åˆ†   // âŒ æ— åŒ¹é…
}
```

**å®ä¾‹**ï¼š
- `text="é€šè®¯å½•"` â†’ 40åˆ† âœ…
- `text="é€šè®¯å½• (3)"` â†’ 20åˆ† âš ï¸
- `text="è”ç³»äºº"` â†’ 0åˆ† âŒ

#### 2ï¸âƒ£ Bounds ä½ç½®å¾—åˆ†ï¼ˆ30åˆ†ï¼‰

```rust
if å…ƒç´ bounds == ç”¨æˆ·bounds {
    30åˆ†  // âœ… å®Œå…¨åŒ¹é…
} else {
    let distance = calculate_center_distance(å…ƒç´ bounds, ç”¨æˆ·bounds);
    
    if distance <= å®¹å·®(20px) {
        30åˆ†  // âœ… å®¹å·®å†…
    } else if distance <= å®¹å·®*2 {
        20åˆ†  // âš ï¸ æ¥è¿‘
    } else if distance <= å®¹å·®*5 {
        10åˆ†  // âš ï¸ è¾ƒè¿œ
    } else {
        5åˆ†   // âŒ å¾ˆè¿œ
    }
}
```

**å®ä¾‹**ï¼š
- `bounds="[45,1059][249,1263]"` å®Œå…¨åŒ¹é… â†’ 30åˆ† âœ…
- `bounds="[50,1060][250,1264]"` è·ç¦»10px â†’ 30åˆ† âœ…
- `bounds="[0,1043][1080,1279]"` è·ç¦»500px â†’ 5åˆ† âŒ

#### 3ï¸âƒ£ å¯ç‚¹å‡»æ€§å¾—åˆ†ï¼ˆ20åˆ†ï¼‰

```rust
if clickable == "true" {
    20åˆ†  // âœ… å¯ç‚¹å‡»
} else if !require_clickable {
    10åˆ†  // âš ï¸ ä¸å¯ç‚¹å‡»ä½†å¯æ¥å—
} else {
    0åˆ†   // âŒ ä¸å¯ç‚¹å‡»ä¸”è¦æ±‚å¯ç‚¹å‡»
}
```

#### 4ï¸âƒ£ å°ºå¯¸åˆç†æ€§å¾—åˆ†ï¼ˆ10åˆ†ï¼‰

```rust
// é¿å…é€‰æ‹©è¿‡å¤§çš„çˆ¶å®¹å™¨æˆ–éšè—çš„å°å…ƒç´ 
let (width, height) = calculate_size(å…ƒç´ bounds);
let (user_width, user_height) = calculate_size(ç”¨æˆ·bounds);

let similarity = calculate_size_similarity(å…ƒç´ , ç”¨æˆ·);

if similarity > 0.8 {
    10åˆ†  // âœ… å°ºå¯¸ç›¸ä¼¼
} else if similarity > 0.5 {
    5åˆ†   // âš ï¸ å°ºå¯¸å·®å¼‚
} else {
    2åˆ†   // âŒ å°ºå¯¸å·®å¼‚è¿‡å¤§
}
```

**å®ä¾‹**ï¼š
- ä¸­å±‚å®¹å™¨ `204x204px` vs ç”¨æˆ·é€‰æ‹© `200x200px` â†’ ç›¸ä¼¼åº¦ 98% â†’ 10åˆ† âœ…
- å¤–å±‚å®¹å™¨ `1080x236px` vs ç”¨æˆ·é€‰æ‹© `200x200px` â†’ ç›¸ä¼¼åº¦ 20% â†’ 2åˆ† âŒ

### ğŸ† è¯„åˆ†å®ä¾‹

å‡è®¾çœŸæœº XML ä¸­æœ‰ 3 ä¸ªå€™é€‰å…ƒç´ ï¼š

```
å€™é€‰1: å¤–å±‚å®¹å™¨
  text=""
  bounds=[0,1043][1080,1279]  (1080x236px)
  clickable=true
  
  è¯„åˆ†ï¼š
  - æ–‡æœ¬åŒ¹é…: 0åˆ† (æ— æ–‡æœ¬)
  - Boundsä½ç½®: 5åˆ† (è·ç¦»å¾ˆè¿œ)
  - å¯ç‚¹å‡»æ€§: 20åˆ† (å¯ç‚¹å‡»)
  - å°ºå¯¸åˆç†æ€§: 2åˆ† (è¿‡å¤§)
  æ€»åˆ†: 27åˆ† âŒ

å€™é€‰2: ä¸­å±‚å®¹å™¨ (ç”¨æˆ·é€‰æ‹©)
  text=""
  bounds=[45,1059][249,1263]  (204x204px)
  clickable=true
  
  è¯„åˆ†ï¼š
  - æ–‡æœ¬åŒ¹é…: 0åˆ† (æ— æ–‡æœ¬ï¼Œä½†åŒ…å«å­å…ƒç´ "é€šè®¯å½•")
  - Boundsä½ç½®: 30åˆ† (å®Œå…¨åŒ¹é…)
  - å¯ç‚¹å‡»æ€§: 20åˆ† (å¯ç‚¹å‡»)
  - å°ºå¯¸åˆç†æ€§: 10åˆ† (å°ºå¯¸åŒ¹é…)
  æ€»åˆ†: 60åˆ† âœ…

å€™é€‰3: å­æ–‡æœ¬å…ƒç´ 
  text="é€šè®¯å½•"
  bounds=[80,1100][180,1150]  (100x50px)
  clickable=false
  
  è¯„åˆ†ï¼š
  - æ–‡æœ¬åŒ¹é…: 40åˆ† (å®Œå…¨åŒ¹é…) âœ…
  - Boundsä½ç½®: 20åˆ† (æ¥è¿‘)
  - å¯ç‚¹å‡»æ€§: 0åˆ† (ä¸å¯ç‚¹å‡»)
  - å°ºå¯¸åˆç†æ€§: 3åˆ† (è¿‡å°)
  æ€»åˆ†: 63åˆ† ğŸ¯
```

**ç»“æœ**ï¼šé€‰æ‹©å€™é€‰3ï¼ˆå­æ–‡æœ¬å…ƒç´ ï¼‰63åˆ†

**ä½†æ˜¯**ï¼šå¦‚æœæ£€æµ‹åˆ°å€™é€‰3ä¸å¯ç‚¹å‡»ï¼Œä¼šè‡ªåŠ¨å¯»æ‰¾å…¶å¯ç‚¹å‡»çš„çˆ¶å®¹å™¨ â†’ å›åˆ°å€™é€‰2 âœ…

---

## æ‰§è¡Œæµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ï¼šç”¨æˆ·ç‚¹å‡»ä¸­å±‚æ— æ–‡æœ¬å®¹å™¨                                â”‚
â”‚ - æ£€æµ‹ï¼š!element.text && context.elementText            â”‚
â”‚ - æå–ï¼šchildren_texts = ["é€šè®¯å½•"]                      â”‚
â”‚ - æ ‡è®°ï¼šmatching_strategy = "anchor_by_child_text"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ ğŸ“¦ æ­¥éª¤å¡ç‰‡ (original_data)
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯ V3 æ‰§è¡Œé“¾                                            â”‚
â”‚ 1. çœŸæœº dump XML                                         â”‚
â”‚ 2. å°è¯• XPath ç›´æ¥åŒ¹é… â†’ âŒ å¤±è´¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ ğŸ”§ è§¦å‘æ¢å¤æœºåˆ¶
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Recovery Manager (recovery_manager.rs)                   â”‚
â”‚ - æ£€æŸ¥ matching_strategy æ ‡è®°                            â”‚
â”‚ - å‘ç° "anchor_by_child_or_parent_text"                 â”‚
â”‚ - ğŸ¯ è·¯ç”±åˆ°ç­–ç•¥å¤„ç†å™¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ ğŸ¯ ç­–ç•¥è·¯ç”±
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Anchor By Relation Strategy (anchor_by_relation_strategy)â”‚
â”‚                                                           â”‚
â”‚ Step 1: æå–é”šç‚¹é…ç½®                                      â”‚
â”‚   config.anchor_texts = ["é€šè®¯å½•"]                       â”‚
â”‚   config.user_bounds = "[45,1059][249,1263]"            â”‚
â”‚                                                           â”‚
â”‚ Step 2: åœ¨çœŸæœº XML ä¸­æŸ¥æ‰¾åŒ…å«é”šç‚¹æ–‡æœ¬çš„å…ƒç´                 â”‚
â”‚   find_elements_with_anchor_text(xml, ["é€šè®¯å½•"])        â”‚
â”‚   â†’ æ‰¾åˆ° 3 ä¸ªå€™é€‰ï¼šå¤–å±‚å®¹å™¨ã€ä¸­å±‚å®¹å™¨ã€å­æ–‡æœ¬å…ƒç´             â”‚
â”‚                                                           â”‚
â”‚ Step 3: ğŸ† ä½¿ç”¨è¯„åˆ†ç³»ç»Ÿå¯¹å€™é€‰è¿›è¡Œè¯„åˆ†                      â”‚
â”‚   CandidateScorer::score_and_rank_candidates()           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ å€™é€‰1: å¤–å±‚å®¹å™¨ â†’ 27åˆ†                   â”‚          â”‚
â”‚   â”‚ å€™é€‰2: ä¸­å±‚å®¹å™¨ â†’ 60åˆ†                   â”‚          â”‚
â”‚   â”‚ å€™é€‰3: å­æ–‡æœ¬å…ƒç´  â†’ 63åˆ† ğŸ¯              â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                           â”‚
â”‚ Step 4: é€‰æ‹©æœ€é«˜åˆ†å€™é€‰                                    â”‚
â”‚   best_candidate = å€™é€‰3 (å­æ–‡æœ¬å…ƒç´ )                     â”‚
â”‚   âš ï¸ æ£€æµ‹åˆ°ä¸å¯ç‚¹å‡» â†’ å¯»æ‰¾å¯ç‚¹å‡»çˆ¶å…ƒç´  â†’ å€™é€‰2           â”‚
â”‚                                                           â”‚
â”‚ Step 5: è®¡ç®—ç‚¹å‡»åæ ‡å¹¶è¿”å›                                â”‚
â”‚   bounds = "[45,1059][249,1263]"                        â”‚
â”‚   coordinates = (147, 1161)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ âœ… è¿”å›ç»“æœ
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step Executor (step_executor.rs)                         â”‚
â”‚ - æ‰§è¡Œç‚¹å‡»: tap_at_position(147, 1161)                   â”‚
â”‚ - âœ… æˆåŠŸç‚¹å‡»"é€šè®¯å½•"æŒ‰é’®                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ–‡ä»¶ç»“æ„

### æ¨¡å—åŒ–ç»„ç»‡ï¼ˆéµå¾ªé¡¹ç›®è§„èŒƒï¼‰

```
src-tauri/src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ execution/
â”‚       â””â”€â”€ matching/
â”‚           â””â”€â”€ strategies/
â”‚               â”œâ”€â”€ mod.rs                           # ç­–ç•¥å·¥å‚
â”‚               â”œâ”€â”€ anchor_by_relation_strategy.rs  # ğŸ¯ å…³ç³»é”šç‚¹ç­–ç•¥
â”‚               â””â”€â”€ candidate_scorer.rs             # ğŸ¯ è¯„åˆ†ç³»ç»Ÿ
â”‚
â”œâ”€â”€ exec/
â”‚   â””â”€â”€ v3/
â”‚       â”œâ”€â”€ recovery_manager.rs                     # ğŸ¯ é›†æˆç­–ç•¥è·¯ç”±å™¨
â”‚       â””â”€â”€ element_matching/
â”‚           â””â”€â”€ multi_candidate_evaluator.rs        # ä¼ ç»Ÿè¯„ä¼°å™¨ï¼ˆåå¤‡ï¼‰
â”‚
â””â”€â”€ ...

src/pages/SmartScriptBuilderPage/
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useIntelligentStepCardIntegration.ts        # ğŸ¯ å‰ç«¯æ£€æµ‹ä¸æå–
â”‚
â””â”€â”€ helpers/
    â””â”€â”€ intelligentDataTransfer.ts                  # ğŸ¯ æ•°æ®æ‰“åŒ…ä¼ é€’
```

### å…³é”®æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | èŒè´£ | å…³é”®å‡½æ•° |
|------|------|----------|
| `useIntelligentStepCardIntegration.ts` | æ£€æµ‹ä¸­å±‚å®¹å™¨ï¼Œæå–é”šç‚¹æ•°æ® | `detectMiddleLayerContainer()` |
| `intelligentDataTransfer.ts` | æ‰“åŒ… original_data | `buildBackendParameters()` |
| `recovery_manager.rs` | ç­–ç•¥è·¯ç”±å…¥å£ | `try_strategy_router()` |
| `anchor_by_relation_strategy.rs` | å…³ç³»é”šç‚¹åŒ¹é…æ‰§è¡Œ | `find_elements_with_anchor_text()`, `select_best_candidate()` |
| `candidate_scorer.rs` | å€™é€‰å…ƒç´ è¯„åˆ† | `score_and_rank_candidates()` |

---

## æ•°æ®ä¼ é€’

### å‰ç«¯ â†’ åç«¯æ•°æ®æµ

```typescript
// ğŸ¯ å‰ç«¯æ„å»ºçš„æ•°æ®åŒ…
{
  step_type: "smart_tap",
  parameters: {
    // åŸºç¡€ä¿¡æ¯
    element_selector: "//element_41",
    bounds: "[45,1059][249,1263]",
    text: "é€šè®¯å½•",
    
    // ğŸ¯ å…³é”®ï¼šoriginal_data
    original_data: {
      // åŸå§‹ XML å¿«ç…§ï¼ˆ58KBï¼‰
      original_xml: "<hierarchy>...</hierarchy>",
      xml_hash: "e0d909c3...",
      
      // ç”¨æˆ·é€‰æ‹©çš„ç²¾ç¡®ä¿¡æ¯
      selected_xpath: "//element_41",
      element_bounds: "[45,1059][249,1263]",
      element_text: "é€šè®¯å½•",
      
      // ğŸ¯ å…³é”®ï¼šå…³ç³»é”šç‚¹æ•°æ®
      children_texts: ["é€šè®¯å½•"],
      sibling_texts: ["é€šè®¯å½•", "è”ç³»äºº"],
      parent_info: {
        text: "",
        contentDesc: "åº•éƒ¨å¯¼èˆªæ ",
        resourceId: "com.app:id/bottom_nav"
      },
      
      // ğŸ¯ å…³é”®ï¼šç­–ç•¥æ ‡è®°
      matching_strategy: "anchor_by_child_or_parent_text",
      
      // å…ƒæ•°æ®
      key_attributes: {
        "resource-id": "com.app:id/contacts_tab",
        "content-desc": "",
        "text": "",
        "class": "android.widget.FrameLayout"
      },
      
      // æ•°æ®å®Œæ•´æ€§æ ‡è®°
      data_integrity: {
        has_original_xml: true,
        has_user_xpath: true,
        has_children_texts: true,
        has_sibling_texts: true,
        has_parent_info: true,
        extraction_timestamp: 1698463232000
      }
    }
  }
}
```

### åç«¯è¯»å–æ•°æ®

```rust
// recovery_manager.rs - RecoveryContext::from_params()

let recovery_ctx = RecoveryContext {
    // åŸå§‹ XML
    original_xml: original_data["original_xml"],  // 58KB
    
    // ç”¨æˆ·é€‰æ‹©
    selected_xpath: original_data["selected_xpath"],  // "//element_41"
    element_bounds: original_data["element_bounds"],  // "[45,1059][249,1263]"
    
    // ğŸ¯ å…³ç³»æ•°æ®
    children_texts: original_data["children_texts"],  // ["é€šè®¯å½•"]
    sibling_texts: original_data["sibling_texts"],    // ["é€šè®¯å½•", "è”ç³»äºº"]
    parent_info: original_data["parent_info"],         // { ... }
    
    // ğŸ¯ ç­–ç•¥æ ‡è®°
    matching_strategy: original_data["matching_strategy"],  // "anchor_by_child_..."
    
    // ...
};
```

---

## æµ‹è¯•éªŒè¯

### 1ï¸âƒ£ å•å…ƒæµ‹è¯•ï¼ˆè¯„åˆ†ç³»ç»Ÿï¼‰

```rust
#[test]
fn test_text_exact_match_gets_high_score() {
    let candidate = hashmap!{
        "text" => "é€šè®¯å½•",
        "bounds" => "[45,1059][249,1263]",
        "clickable" => "true"
    };
    
    let config = ScoringConfig {
        anchor_texts: vec!["é€šè®¯å½•".to_string()],
        user_bounds: Some("[45,1059][249,1263]".to_string()),
        ..Default::default()
    };
    
    let score = CandidateScorer::score_candidate(&candidate, &config);
    
    // æ–‡æœ¬å®Œå…¨åŒ¹é…(40) + Boundså®Œå…¨åŒ¹é…(30) + å¯ç‚¹å‡»(20) + å°ºå¯¸åŒ¹é…(10) = 100åˆ†
    assert_eq!(score.total_score, 100.0);
}
```

### 2ï¸âƒ£ é›†æˆæµ‹è¯•ï¼ˆç«¯åˆ°ç«¯ï¼‰

```typescript
// æµ‹è¯•æµç¨‹
1. å‰ç«¯ç‚¹å‡»åº•éƒ¨å¯¼èˆª"é€šè®¯å½•"æŒ‰é’®
2. æ£€æŸ¥æ­¥éª¤å¡ç‰‡æ•°æ®ï¼š
   âœ… matchingStrategy = "anchor_by_child_or_parent_text"
   âœ… children_texts = ["é€šè®¯å½•"]
   âœ… original_data å®Œæ•´

3. åç«¯æ‰§è¡Œï¼š
   âœ… ç­–ç•¥è·¯ç”±å™¨è¢«è§¦å‘
   âœ… æ‰¾åˆ° 3 ä¸ªå€™é€‰å…ƒç´ 
   âœ… è¯„åˆ†ç»“æœæ­£ç¡®
   âœ… é€‰æ‹©æœ€ä½³å€™é€‰ï¼ˆä¸­å±‚å®¹å™¨ï¼‰

4. çœŸæœºæ“ä½œï¼š
   âœ… ç‚¹å‡»åæ ‡ (147, 1161)
   âœ… æˆåŠŸæ‰“å¼€é€šè®¯å½•é¡µé¢
```

---

## ä¸ Step 0-6 æ™ºèƒ½ç­–ç•¥çš„å…³ç³»

### é›†æˆä½ç½®

```
Step 0-6 æ™ºèƒ½ç­–ç•¥ç³»ç»Ÿ
â”œâ”€â”€ Step 0: è§„èŒƒåŒ–è¾“å…¥
â”œâ”€â”€ Step 1: Self-Anchor (resource-id/content-desc ç›´æ¥å®šä½)
â”œâ”€â”€ Step 2: Child-Driven (å­æ ‘æ‰¾é”šç‚¹) ğŸ¯ å…³ç³»é”šç‚¹ç­–ç•¥åœ¨è¿™é‡Œ
â”œâ”€â”€ Step 3: Content-Desc å®šä½
â”œâ”€â”€ Step 4: Region-Scoped (åŒºåŸŸé™å®š)
â”œâ”€â”€ Step 5: é‚»å±…ç›¸å¯¹å®šä½
â””â”€â”€ Step 6: XPath ç´¢å¼•å…œåº•
```

### æ‰§è¡Œä¼˜å…ˆçº§

```
V3 æ‰§è¡Œé“¾
â”œâ”€â”€ 1ï¸âƒ£ XPath ç›´æ¥åŒ¹é…ï¼ˆæœ€å¿«ï¼‰
â”‚
â”œâ”€â”€ 2ï¸âƒ£ å¤±è´¥æ¢å¤æœºåˆ¶å¯åŠ¨
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ¯ æ£€æŸ¥ matching_strategy æ ‡è®°
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ "anchor_by_child_or_parent_text" â†’ ç­–ç•¥è·¯ç”±å™¨ âœ… ä¼˜å…ˆ
â”‚   â”‚   â”œâ”€â”€ "direct_match" â†’ ä¼ ç»Ÿæµç¨‹
â”‚   â”‚   â””â”€â”€ å…¶ä»–...
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ”§ ç­–ç•¥è·¯ç”±å™¨å¤±è´¥ â†’ å›é€€åˆ°ä¼ ç»Ÿæµç¨‹
â”‚
â””â”€â”€ 3ï¸âƒ£ ä¼ ç»Ÿæ¢å¤æµç¨‹ï¼ˆMulti-Candidate Evaluatorï¼‰
```

---

## æ€»ç»“

### âœ… å®Œæˆçš„åŠŸèƒ½

1. **å‰ç«¯æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«ä¸­å±‚æ— æ–‡æœ¬å®¹å™¨
2. **æ•°æ®æå–**ï¼šæå–å­/å…„å¼Ÿ/çˆ¶å…ƒç´ æ–‡æœ¬ä½œä¸ºé”šç‚¹
3. **ç­–ç•¥æ ‡è®°**ï¼šæ˜ç¡®å‘ŠçŸ¥åç«¯ä½¿ç”¨å…³ç³»é”šç‚¹ç­–ç•¥
4. **ç­–ç•¥è·¯ç”±**ï¼šåç«¯ä¼˜å…ˆä½¿ç”¨ç­–ç•¥è·¯ç”±å™¨
5. **è¯„åˆ†ç³»ç»Ÿ**ï¼šå®Œå–„çš„4ç»´åº¦è¯„åˆ†ï¼ˆæ–‡æœ¬40 + ä½ç½®30 + å¯ç‚¹å‡»20 + å°ºå¯¸10ï¼‰
6. **æ¨¡å—åŒ–**ï¼šç¬¦åˆé¡¹ç›®è§„èŒƒçš„å­æ–‡ä»¶å¤¹ç»„ç»‡

### ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

1. **æ–‡æœ¬å®Œå…¨åŒ¹é… â†’ é«˜åˆ†ç›´æ¥é€‰å–**ï¼ˆ40åˆ†ï¼‰
2. **æ— æ³•ç²¾å‡†åŒ¹é… â†’ Bounds è¾…åŠ©è¯„åˆ†**ï¼ˆ30åˆ†ï¼‰
3. **è€ƒè™‘éšè—å…ƒç´ **ï¼šå°ºå¯¸åˆç†æ€§æ£€æµ‹ï¼ˆ10åˆ†ï¼‰
4. **é¿å…å¤§å®¹å™¨**ï¼šå°ºå¯¸ç›¸ä¼¼åº¦è¯„åˆ†ï¼ˆ10åˆ†ï¼‰
5. **å®Œæ•´æ—¥å¿—**ï¼šæ¯ä¸ªå€™é€‰çš„è¯¦ç»†è¯„åˆ†è§£é‡Š

### ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

1. âœ… æ”¯æŒæ›´å¤šå…³ç³»ç±»å‹ï¼ˆå­ã€å…„å¼Ÿã€çˆ¶ã€ç¥–å…ˆï¼‰
2. âœ… æ”¯æŒæ–‡æœ¬åŒä¹‰è¯ï¼ˆ"é€šè®¯å½•" = "Contacts"ï¼‰
3. âœ… æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼é”šç‚¹
4. âœ… åŠ¨æ€è°ƒæ•´è¯„åˆ†æƒé‡
5. âœ… æœºå™¨å­¦ä¹ ä¼˜åŒ–æƒé‡é…ç½®

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-28  
**ä½œè€…**: AI ç¼–ç¨‹åŠ©æ‰‹  
**é¡¹ç›®**: marketing-automation-desktop
