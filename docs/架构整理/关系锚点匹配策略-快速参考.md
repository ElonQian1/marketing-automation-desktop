# 关系锚点匹配策略 - 快速参考

> **一句话总结**：当用户选择的是中层无文本按钮时，使用子/父元素文本作为锚点，通过完善的评分系统精确定位。

---

## 🎯 核心原理

### 问题场景
```
用户点击：[45,1059][249,1263] (中层容器，无text)
    └── 包含子元素：Text="通讯录" 🎯
```

### 解决方案
1. **前端检测**：识别"中层无文本容器"模式
2. **提取锚点**：获取子/兄弟/父元素文本
3. **后端匹配**：使用文本锚点在真机XML中查找
4. **评分选择**：4维度评分选择最佳候选

---

## 📊 评分权重（总分100）

| 维度 | 权重 | 说明 |
|------|------|------|
| **文本匹配** | 40分 | ✅ 完全匹配40分 / ⚠️ 包含匹配20分 / ❌ 无匹配0分 |
| **Bounds位置** | 30分 | ✅ 完全匹配30分 / ⚠️ 容差内30分 / ❌ 超出递减 |
| **可点击性** | 20分 | ✅ 可点击20分 / ❌ 不可点击0分 |
| **尺寸合理性** | 10分 | ✅ 尺寸相似10分 / ⚠️ 差异递减 / ❌ 过大过小低分 |

**核心规则**：
- 🎯 **子/父元素文本完全匹配 → 高分直接选取（40分）**
- 📍 **无法精准文本匹配 → Bounds 辅助评分（30分）**
- ✅ **避免选择过大父容器或隐藏小元素（10分）**

---

## 🚀 使用流程

### 1️⃣ 前端自动检测
```typescript
// useIntelligentStepCardIntegration.ts 自动执行
const isMiddleLayerContainer = !element.text && context.elementText;

if (isMiddleLayerContainer) {
  matchingStrategy = 'anchor_by_child_or_parent_text'; // 🎯
  childrenTexts = extractChildTexts(element);           // ["通讯录"]
  siblingTexts = extractSiblingTexts(element);         // ["通讯录", "联系人"]
}
```

### 2️⃣ 后端自动路由
```rust
// recovery_manager.rs 自动执行
if matching_strategy == "anchor_by_child_or_parent_text" {
    // 🎯 优先使用关系锚点策略
    try_strategy_router(recovery_ctx, current_elements, strategy_tag)
}
```

### 3️⃣ 评分系统自动选择
```rust
// candidate_scorer.rs 自动执行
let scored = CandidateScorer::score_and_rank_candidates(candidates, config);

// 示例结果：
// [排名 1] 总分: 63.0 | 文本: 40 | 位置: 20 | 可点击: 0 | 尺寸: 3
// [排名 2] 总分: 60.0 | 文本: 0 | 位置: 30 | 可点击: 20 | 尺寸: 10
// [排名 3] 总分: 27.0 | 文本: 0 | 位置: 5 | 可点击: 20 | 尺寸: 2
```

---

## 📝 实际案例

### 场景：底部导航"通讯录"按钮

**用户操作**：
- 点击底部导航的"通讯录"图标
- 元素结构：外层容器 > 中层容器（可点击）> 子元素（文本"通讯录"）

**系统识别**：
```javascript
// 前端检测结果
{
  matchingStrategy: 'anchor_by_child_or_parent_text',
  children_texts: ['通讯录'],
  sibling_texts: ['通讯录', '联系人'],
  element_bounds: '[45,1059][249,1263]'
}
```

**后端评分**：
```
真机XML中找到3个候选：

1. 子文本元素 [80,1100][180,1150]
   - 文本匹配: 40分 ✅ (text="通讯录" 完全匹配)
   - Bounds位置: 20分 ⚠️ (距离50px)
   - 可点击性: 0分 ❌ (不可点击)
   - 尺寸合理性: 3分 ❌ (过小 100x50)
   总分: 63分

2. 中层容器 [45,1059][249,1263] 🎯
   - 文本匹配: 0分 ⚠️ (自己无文本，但包含"通讯录")
   - Bounds位置: 30分 ✅ (完全匹配用户选择)
   - 可点击性: 20分 ✅ (可点击)
   - 尺寸合理性: 10分 ✅ (尺寸匹配204x204)
   总分: 60分

3. 外层容器 [0,1043][1080,1279]
   - 文本匹配: 0分 ❌
   - Bounds位置: 5分 ❌ (距离500px)
   - 可点击性: 20分 ✅
   - 尺寸合理性: 2分 ❌ (过大 1080x236)
   总分: 27分
```

**最终选择**：
- **子文本元素** 63分（最高分）
- ⚠️ **但检测到不可点击** → 寻找可点击父元素
- ✅ **最终选择：中层容器** [45,1059][249,1263] ✅

---

## 🔧 关键文件

| 文件 | 作用 | 位置 |
|------|------|------|
| **前端检测** | 识别中层容器并提取锚点 | `useIntelligentStepCardIntegration.ts` |
| **数据传递** | 打包 original_data | `intelligentDataTransfer.ts` |
| **策略路由** | 路由到正确的策略处理器 | `recovery_manager.rs` |
| **策略执行** | 关系锚点匹配逻辑 | `anchor_by_relation_strategy.rs` |
| **评分系统** | 4维度候选评分 | `candidate_scorer.rs` |

---

## 🎯 核心优势

✅ **自动检测**：前端自动识别中层无文本容器，无需手动配置  
✅ **完全匹配优先**：子/父文本完全匹配直接高分选取（40分）  
✅ **Bounds辅助**：文本无法匹配时使用位置辅助评分（30分）  
✅ **避免错误**：容器大小检测避免选择过大父容器或隐藏小元素  
✅ **详细日志**：每个候选的完整评分解释，方便调试  

---

## 🐛 调试技巧

### 查看评分详情
```rust
// 后端日志会输出：
[排名 1] 总分: 63.0 | Bounds: [80,1100][180,1150] | Text: '通讯录'
  详情: ✅ 文本完全匹配: ["通讯录"] | 📍 Bounds距离: 50px → 20.0分 | ❌ 元素不可点击（要求可点击） | ⚠️ 元素过小 (100x50) → 3分
```

### 常见问题排查

**问题1**：选择了错误的外层大容器
- **检查**：尺寸合理性得分是否过低（<5分）
- **优化**：调整 `bounds_tolerance` 参数

**问题2**：选择了不可点击的子文本元素
- **检查**：可点击性得分是否为0
- **处理**：策略会自动寻找可点击父元素

**问题3**：文本匹配得分为0
- **检查**：`children_texts` 是否正确传递
- **验证**：前端日志中的 `children_texts` 字段

---

## 📚 相关文档

- 📖 [关系锚点匹配策略完整架构.md](./关系锚点匹配策略完整架构.md) - 完整技术文档
- 📖 [Step 0-6智能策略系统完整架构.md](./Step 0-6智能策略系统完整架构.md) - 整体系统架构

---

**版本**: v1.0  
**更新**: 2025-10-28  
**状态**: ✅ 生产就绪
