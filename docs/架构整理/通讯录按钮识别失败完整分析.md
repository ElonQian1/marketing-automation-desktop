# "é€šè®¯å½•"æŒ‰é’®è¯†åˆ«å¤±è´¥ - å®Œæ•´æ¶æ„åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**ç—‡çŠ¶**ï¼šç”¨æˆ·ç‚¹å‡»"é€šè®¯å½•"æŒ‰é’®ï¼Œä½†ç³»ç»Ÿæœ€ç»ˆç‚¹å‡»äº†"æ·»åŠ æœ‹å‹"  
**æ ¹æœ¬åŸå› **ï¼šå‰ç«¯ä¼ é€’é”™è¯¯bounds + åç«¯è¯„åˆ†ç³»ç»Ÿæœªç”Ÿæ•ˆ  
**å½±å“èŒƒå›´**ï¼šæ‰€æœ‰ "å¯ç‚¹å‡»çˆ¶å®¹å™¨ + æ–‡æœ¬å­å…ƒç´ " çš„UIæ¨¡å¼

---

## ğŸ” 1. "é€šè®¯å½•"æŒ‰é’®çš„XMLç»“æ„åˆ†æ

### å®é™…XMLç»“æ„
```xml
<node content-desc="é€šè®¯å½•ï¼Œ" bounds="[29,1043][265,1279]">
  <!-- âœ… å¯ç‚¹å‡»çˆ¶å®¹å™¨ -->
  <node resource-id="com.ss.android.ugc.aweme:id/iwk" 
        class="android.widget.LinearLayout"
        clickable="true" 
        bounds="[45,1059][249,1263]">
    
    <!-- å›¾æ ‡å­å…ƒç´  -->
    <node resource-id="com.ss.android.ugc.aweme:id/icon" 
          class="android.widget.ImageView"
          bounds="[110,1093][184,1167]" />
    
    <!-- âœ… æ–‡æœ¬å­å…ƒç´  -->
    <node text="é€šè®¯å½•" 
          resource-id="com.ss.android.ugc.aweme:id/title" 
          class="android.widget.TextView"
          clickable="false"
          bounds="[99,1196][195,1240]" />
  </node>
</node>
```

### å…³é”®ç‰¹å¾
- **çˆ¶å…ƒç´ **ï¼š`bounds=[45,1059][249,1263]`ï¼Œ`clickable="true"`
- **å­å…ƒç´ æ–‡æœ¬**ï¼š"é€šè®¯å½•"ï¼Œ`clickable="false"`
- **æ¨¡å¼**ï¼šå…¸å‹çš„ **Android "çˆ¶å®¹å™¨å¯ç‚¹å‡» + å­å…ƒç´ åŒ…å«æ–‡æœ¬"** æ¶æ„

---

## âŒ 2. å½“å‰å®ç°çš„ä¸‰å¤§é—®é¢˜

### é—®é¢˜ 1ï¼šå‰ç«¯ä¼ é€’é”™è¯¯æ•°æ®

**ç”¨æˆ·å®é™…ç‚¹å‡»**ï¼š
```
bounds=[45,1059][249,1263]  // âœ… æ­£ç¡®ï¼šé€šè®¯å½•æŒ‰é’®
text="é€šè®¯å½•"
```

**å‰ç«¯å®é™…ä¼ é€’**ï¼š
```json
{
  "element_bounds": "[0,1321][1080,1447]",  // âŒ é”™è¯¯ï¼šç›¸å·®262px
  "element_text": "",                       // âŒ ç¼ºå¤±ï¼šæ²¡æœ‰æå–æ–‡æœ¬
  "selected_xpath": "//*[contains(@class, 'FrameLayout')]", // âŒ å¤ªå®½æ³›
  "original_xml": ""                        // âŒ ç¼ºå¤±ï¼šæ²¡æœ‰ä¿å­˜å¿«ç…§
}
```

**å½±å“**ï¼šåç«¯æ”¶åˆ°çš„æ˜¯å®Œå…¨é”™è¯¯çš„åŒºåŸŸï¼Œæ— æ³•æ­£ç¡®è¯†åˆ«

---

### é—®é¢˜ 2ï¼šåç«¯Step 0-6ç­–ç•¥æœªæ­£ç¡®æ‰§è¡Œ

#### 2.1 æ™ºèƒ½åˆ†æè™½ç„¶ç”Ÿæˆäº†æ­£ç¡®å€™é€‰
```rust
// æ—¥å¿—æ˜¾ç¤ºç”Ÿæˆäº†3ä¸ªå€™é€‰
intelligent_step_1: "æ‰«ä¸€æ‰«" (confidence=0.7435)
intelligent_step_2: "å°ç¬¼å­" (confidence=0.7245)
intelligent_step_3: "é€šè®¯å½•" (confidence=0.7145)  // âœ… æ­£ç¡®å€™é€‰åœ¨è¿™é‡Œ
```

#### 2.2 ä½†æœ€ç»ˆè½¬æ¢ä¸ºV3æ­¥éª¤æ—¶å‡ºé”™
```rust
// æœ€ç»ˆæ‰§è¡Œçš„æ­¥éª¤
target='æ·»åŠ æœ‹å‹'  // âŒ å®Œå…¨ä¸ç›¸å…³ï¼
xpath=//*[@text='æ·»åŠ æœ‹å‹' or @content-desc='æ·»åŠ æœ‹å‹']
```

**é—®é¢˜ç‚¹**ï¼š
1. å€™é€‰ç”Ÿæˆæ­£ç¡®ï¼Œä½†è½¬æ¢åˆ°V3æ­¥éª¤æ—¶**æ•°æ®ä¸¢å¤±**
2. `æ™ºèƒ½åˆ†æå€™é€‰ â†’ V3æ­¥éª¤` çš„è½¬æ¢é€»è¾‘æœ‰bug
3. æ²¡æœ‰ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„xpathè¿›è¡Œå¤šå€™é€‰è¯„ä¼°

---

### é—®é¢˜ 3ï¼šå­å…ƒç´ æ–‡æœ¬åŒ¹é…è¯„åˆ†æœªç”Ÿæ•ˆ

#### 3.1 ä»£ç å·²å®ç°ä½†æœªè¢«è°ƒç”¨

`multi_candidate_evaluator.rs` ä¸­å·²ç»æœ‰å®Œæ•´çš„å­æ–‡æœ¬åŒ¹é…é€»è¾‘ï¼š

```rust
// ğŸ”¥ è¯„åˆ†é¡¹0: å­å…ƒç´ æ–‡æœ¬åŒ¹é…ï¼ˆ0-0.35åˆ†ï¼‰æœ€é«˜ä¼˜å…ˆçº§ï¼
if let Some(ref target_text) = criteria.target_text {
    let child_text_match = Self::check_child_text_match(
        elem, 
        target_text, 
        &criteria.xml_content
    );
    
    if child_text_match.is_complete {
        score += 0.35;  // âœ… å®Œå…¨åŒ¹é…åº”è¯¥å¾—æœ€é«˜åˆ†
    }
}
```

#### 3.2 ä½†åœ¨æ‰§è¡Œæµç¨‹ä¸­è¢«è·³è¿‡

```rust
// step_executor.rs:611
ğŸ”§ [ä¸´æ—¶é™çº§] å¤šå€™é€‰è¯„ä¼°æ¨¡å—é‡æ„ä¸­ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå€™é€‰å…ƒç´ 
```

**ç»“æœ**ï¼šå­æ–‡æœ¬åŒ¹é…çš„æ ¸å¿ƒä¼˜åŠ¿å®Œå…¨æ²¡æœ‰å‘æŒ¥ä½œç”¨

---

## ğŸ¯ 3. å®Œæ•´æ•°æ®æµåˆ†æ

### ç†æƒ³çš„æ•°æ®æµ

```
1. ã€å‰ç«¯é™æ€åˆ†æã€‘
   ç”¨æˆ·ç‚¹å‡»å¯è§†åŒ–å…ƒç´ 
   â†“
   æå–ï¼šboundsã€textã€xpathã€xml_snapshot
   â†“
   
2. ã€æ™ºèƒ½è‡ªåŠ¨é“¾åˆ†æã€‘
   è°ƒç”¨åç«¯æ™ºèƒ½åˆ†æAPI
   â†“
   Step 0: æ„å»º AnalysisContext
     - user_xpath
     - user_text
     - user_bounds
     - original_xml
   â†“
   Step 1-6: æ‰§è¡Œç­–ç•¥è¯„åˆ†
     Step 1: self_anchor (resource-id)
     Step 2: child_driven (å­æ–‡æœ¬åŒ¹é…) â† ğŸ”¥ å…³é”®
     Step 3: content_desc
     Step 4: region_scoped
     Step 5: neighbor_relative
     Step 6: xpath_fallback
   â†“
   ç”Ÿæˆ N ä¸ªç­–ç•¥å€™é€‰ (sorted by score)
   â†“
   
3. ã€Boundsé‡æ’åºã€‘
   ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„boundsé‡æ–°è¯„ä¼°å€™é€‰
   â†“
   æ£€æµ‹å¯ç‚¹å‡»å­å…ƒç´ 
   â†“
   
4. ã€è½¬æ¢ä¸ºV3æ­¥éª¤ã€‘
   ä¿ç•™ original_data {
     selected_xpath,
     original_xml,
     children_texts,
     element_bounds,
     ...
   }
   â†“
   
5. ã€çœŸæœºæ‰§è¡Œã€‘
   å¦‚æœXPathå¤±æ•ˆ â†’ ä½¿ç”¨ original_xml é‡æ–°åˆ†æ
   â†“
   å¤šå€™é€‰è¯„ä¼° â†’ é€‰æ‹©æœ€ä½³åŒ¹é…
```

### å½“å‰çš„æ•°æ®æµï¼ˆæ–­è£‚ç‚¹ï¼‰

```
1. ã€å‰ç«¯é™æ€åˆ†æã€‘âœ…
   ç”¨æˆ·ç‚¹å‡»
   â†“
   âŒ boundsé”™è¯¯
   âŒ textç¼ºå¤±
   âŒ xml_snapshotæœªä¿å­˜
   
2. ã€æ™ºèƒ½åˆ†æã€‘âš ï¸ éƒ¨åˆ†å·¥ä½œ
   ç”Ÿæˆäº†å€™é€‰
   â†“
   âŒ æœªä½¿ç”¨å­æ–‡æœ¬åŒ¹é…è¯„åˆ†
   âŒ Boundsé‡æ’åºåŸºäºé”™è¯¯æ•°æ®
   
3. ã€è½¬æ¢V3ã€‘âŒ æ•°æ®ä¸¢å¤±
   å€™é€‰ä¿¡æ¯ä¸¢å¤±
   â†“
   ç”Ÿæˆäº†é”™è¯¯çš„æ­¥éª¤
   
4. ã€çœŸæœºæ‰§è¡Œã€‘âŒ
   æ‰§è¡Œäº†é”™è¯¯çš„æ­¥éª¤
```

---

## âœ… 4. å®Œæ•´è§£å†³æ–¹æ¡ˆ

### ä¼˜å…ˆçº§ 1ï¼šä¿®å¤å‰ç«¯æ•°æ®æå–ï¼ˆç´§æ€¥ï¼‰

**ä½ç½®**ï¼šå‰ç«¯å¯è§†åŒ–é€‰æ‹©ç»„ä»¶

**éœ€è¦ä¿®å¤**ï¼š
1. ç²¾ç¡®å®šä½ï¼šç‚¹å‡»å…ƒç´ æ—¶ï¼Œæ‰¾åˆ°**æœ€å°å¯ç‚¹å‡»å…ƒç´ **
2. æ–‡æœ¬æå–ï¼šæå–å…ƒç´ åŠ**æ‰€æœ‰å­å­™èŠ‚ç‚¹çš„text/content-desc**
3. XMLå¿«ç…§ï¼šä¿å­˜å½“å‰å®Œæ•´XMLåˆ° `original_xml`
4. XPathç²¾ç¡®ï¼šç”ŸæˆåŸºäºboundsçš„ç²¾ç¡®XPath

**ç¤ºä¾‹ä»£ç **ï¼ˆä¼ªä»£ç ï¼‰ï¼š
```typescript
function onElementClick(clickedElement: XMLElement) {
  // 1. å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„å¯ç‚¹å‡»å…ƒç´ 
  const clickableParent = findClickableParent(clickedElement);
  
  // 2. æå–æ‰€æœ‰å­æ–‡æœ¬
  const children_texts = extractAllChildTexts(clickableParent);
  
  // 3. ç”Ÿæˆç²¾ç¡®XPathï¼ˆåŒ…å«boundsï¼‰
  const xpath = generatePreciseXPath(clickableParent);
  
  // 4. ä¿å­˜å®Œæ•´XMLå¿«ç…§
  const original_xml = currentXMLSnapshot;
  
  return {
    selected_xpath: xpath,
    element_bounds: clickableParent.bounds,
    element_text: clickableParent.text || children_texts[0],
    children_texts: children_texts,
    original_xml: original_xml,
    key_attributes: {
      'resource-id': clickableParent.resourceId,
      'class': clickableParent.className,
      'content-desc': clickableParent.contentDesc,
    }
  };
}
```

---

### ä¼˜å…ˆçº§ 2ï¼šä¿®å¤åç«¯å¤šå€™é€‰è¯„ä¼°ï¼ˆæ ¸å¿ƒï¼‰

#### ä¿®å¤ç‚¹ 1ï¼šå¯ç”¨ MultiCandidateEvaluator

**æ–‡ä»¶**ï¼š`src-tauri/src/exec/v3/helpers/step_executor.rs:611`

```rust
// âŒ å½“å‰ï¼ˆä¸´æ—¶é™çº§ï¼‰
ğŸ”§ [ä¸´æ—¶é™çº§] å¤šå€™é€‰è¯„ä¼°æ¨¡å—é‡æ„ä¸­ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå€™é€‰å…ƒç´ 

// âœ… åº”è¯¥æ”¹ä¸º
let criteria = EvaluationCriteria {
    target_text: Some(target_text),
    target_content_desc,
    original_bounds: original_data.element_bounds,
    original_resource_id: original_data.key_attributes.resource_id,
    children_texts: original_data.children_texts,
    prefer_last: false,
    selected_xpath: Some(original_data.selected_xpath),
    xml_content: Some(current_xml),  // ğŸ”¥ ä¼ é€’å®Œæ•´XML
};

// ä½¿ç”¨å¤šå€™é€‰è¯„ä¼°å™¨
if let Some(best) = MultiCandidateEvaluator::evaluate_candidates(
    candidate_refs, 
    &criteria
) {
    tracing::info!("âœ… æœ€ä½³å€™é€‰: text={:?}, score={:.3}", 
                   best.element.text, best.score);
    Ok(Some(best.element))
} else {
    // é™çº§é€»è¾‘
    Ok(candidate_elements.first().copied())
}
```

---

#### ä¿®å¤ç‚¹ 2ï¼šå®Œå–„å­æ–‡æœ¬åŒ¹é…ï¼ˆå·²å®ç°ï¼Œéœ€ç¡®ä¿è°ƒç”¨ï¼‰

**æ–‡ä»¶**ï¼š`src-tauri/src/exec/v3/element_matching/multi_candidate_evaluator.rs`

**å½“å‰å®ç°**ï¼ˆå·²æœ‰ï¼Œä½†éœ€ç¡®ä¿ `xml_content` è¢«ä¼ é€’ï¼‰ï¼š

```rust
fn check_child_text_match(
    elem: &UIElement,
    target_text: &str,
    xml_content: &Option<String>,  // ğŸ”¥ éœ€è¦å®Œæ•´XML
) -> ChildTextMatchResult {
    // ç­–ç•¥1: æ£€æŸ¥å…ƒç´ è‡ªèº«çš„text
    if let Some(ref elem_text) = elem.text {
        if elem_text == target_text {
            return ChildTextMatchResult {
                is_complete: true,
                is_partial: false,
                matched_text: Some(elem_text.clone()),
            };
        }
    }
    
    // ç­–ç•¥2: æ£€æŸ¥content-desc
    if let Some(ref elem_desc) = elem.content_desc {
        if elem_desc == target_text {
            return ChildTextMatchResult {
                is_complete: true,
                is_partial: false,
                matched_text: Some(elem_desc.clone()),
            };
        }
    }
    
    // ç­–ç•¥3: å¦‚æœæœ‰XMLï¼Œä»XMLä¸­æå–å­å…ƒç´ æ–‡æœ¬
    if let Some(xml) = xml_content {
        // TODO: å®ç°ä»XMLä¸­æå–å€™é€‰å…ƒç´ çš„æ‰€æœ‰å­å­™èŠ‚ç‚¹æ–‡æœ¬
        // ä½¿ç”¨ elem.bounds ç²¾ç¡®å®šä½å…ƒç´ åœ¨XMLä¸­çš„ä½ç½®
        // ç„¶åæå–è¯¥å…ƒç´ çš„æ‰€æœ‰å­å­™textå±æ€§
    }
    
    ChildTextMatchResult {
        is_complete: false,
        is_partial: false,
        matched_text: None,
    }
}
```

**éœ€è¦è¡¥å……**ï¼šç­–ç•¥3 çš„å®Œæ•´å®ç°ï¼ˆä½¿ç”¨XML + boundså®šä½ï¼‰

---

#### ä¿®å¤ç‚¹ 3ï¼šæ™ºèƒ½åˆ†æå€™é€‰è½¬æ¢é€»è¾‘

**æ–‡ä»¶**ï¼š`src-tauri/src/exec/v3/helpers/strategy_generation.rs`

**é—®é¢˜**ï¼šå€™é€‰è½¬æ¢æ—¶æ•°æ®ä¸¢å¤±

```rust
// å½“å‰ä»£ç ä½ç½®ï¼šstrategy_generation.rs ä¸­çš„è½¬æ¢å‡½æ•°

// âŒ é—®é¢˜ï¼šåªä½¿ç”¨äº†ç¬¬ä¸€ä¸ªå€™é€‰
let first_candidate = candidates.first()?;

// âœ… åº”è¯¥ï¼šä¿ç•™æ‰€æœ‰å€™é€‰ï¼Œä½¿ç”¨å¤šå€™é€‰è¯„ä¼°é€‰æ‹©æœ€ä½³
pub fn convert_candidates_to_v3_steps(
    candidates: Vec<StrategyCandidate>,
    original_params: &HashMap<String, Value>,
    current_xml: &str,  // ğŸ”¥ ä¼ é€’å½“å‰XML
) -> Vec<SingleStepSpecV3> {
    let mut steps = Vec::new();
    
    // å¦‚æœæœ‰ç”¨æˆ·é€‰æ‹©çš„xpathï¼Œä½¿ç”¨å¤šå€™é€‰è¯„ä¼°
    if let Some(selected_xpath) = extract_selected_xpath(original_params) {
        // 1. ä»å½“å‰XMLæå–æ‰€æœ‰åŒ¹é…xpathçš„å…ƒç´ 
        let xml_candidates = extract_elements_by_xpath(current_xml, &selected_xpath);
        
        // 2. æ„å»ºè¯„ä¼°æ ‡å‡†
        let criteria = EvaluationCriteria {
            target_text: extract_target_text(original_params),
            target_content_desc: extract_content_desc(original_params),
            original_bounds: extract_bounds(original_params),
            original_resource_id: extract_resource_id(original_params),
            children_texts: extract_children_texts(original_params),
            prefer_last: false,
            selected_xpath: Some(selected_xpath),
            xml_content: Some(current_xml.to_string()),
        };
        
        // 3. ä½¿ç”¨å¤šå€™é€‰è¯„ä¼°å™¨
        if let Some(best) = MultiCandidateEvaluator::evaluate_candidates(
            xml_candidates.iter().collect(),
            &criteria
        ) {
            // ä½¿ç”¨æœ€ä½³å€™é€‰ç”Ÿæˆæ­¥éª¤
            return vec![create_step_from_element(best.element, original_params)];
        }
    }
    
    // é™çº§ï¼šä½¿ç”¨æ™ºèƒ½åˆ†æç”Ÿæˆçš„å€™é€‰
    for (index, candidate) in candidates.iter().enumerate() {
        let step = create_step_from_candidate(candidate, index, original_params);
        steps.push(step);
    }
    
    steps
}
```

---

### ä¼˜å…ˆçº§ 3ï¼šå®Œå–„ original_data ç»“æ„

**æ–‡ä»¶**ï¼šå‰ç«¯æ­¥éª¤å¡ç‰‡æ•°æ®ç»“æ„

```typescript
interface OriginalData {
  // ğŸ”¥ æ ¸å¿ƒå­—æ®µï¼ˆå¿…é¡»ï¼‰
  selected_xpath: string;      // ç”¨æˆ·é€‰æ‹©çš„ç»å¯¹å…¨å±€XPath
  element_bounds: string;      // ç²¾ç¡®bounds
  element_text: string;        // å…ƒç´ æ–‡æœ¬
  target_content_desc: string; // content-desc
  
  // ğŸ”¥ å­å…ƒç´ ä¿¡æ¯ï¼ˆå¿…é¡»ï¼‰
  children_texts: string[];    // æ‰€æœ‰å­å­™èŠ‚ç‚¹çš„æ–‡æœ¬åˆ—è¡¨
  
  // ğŸ”¥ XMLå¿«ç…§ï¼ˆå¿…é¡»ï¼‰
  original_xml: string;        // é™æ€åˆ†ææ—¶çš„å®Œæ•´XMLå¿«ç…§
  xml_hash: string;           // XMLå“ˆå¸Œï¼ˆç”¨äºæ£€æµ‹é¡µé¢å˜åŒ–ï¼‰
  
  // å…³é”®å±æ€§
  key_attributes: {
    'resource-id': string;
    'class': string;
    'content-desc': string;
    'text': string;
  };
  
  // å…ƒæ•°æ®
  strategy_type: 'intelligent' | 'manual';
  confidence: number;
  extraction_timestamp: number;
  
  // æ•°æ®å®Œæ•´æ€§æ ‡è®°
  data_integrity: {
    has_user_xpath: boolean;
    has_original_xml: boolean;
    has_children_texts: boolean;
    has_strategy_info: boolean;
    extraction_timestamp: number;
  };
}
```

---

### ä¼˜å…ˆçº§ 4ï¼šä¿®å¤æ‰§è¡Œå¤±è´¥æ¢å¤é€»è¾‘

**æ–‡ä»¶**ï¼š`src-tauri/src/exec/v3/helpers/step_executor.rs`

**å½“XPathå¤±æ•ˆæ—¶çš„æ¢å¤æµç¨‹**ï¼š

```rust
async fn execute_with_recovery(
    step: &SingleStepSpecV3,
    current_xml: &str,
    original_data: &OriginalData,
) -> Result<Option<&UIElement>> {
    // 1. å°è¯•ä½¿ç”¨å½“å‰XMLæ‰§è¡Œ
    let result = execute_step_normal(step, current_xml).await;
    
    if result.is_ok() {
        return result;
    }
    
    // 2. å¤±è´¥æ¢å¤ï¼šä½¿ç”¨åŸå§‹XMLé‡æ–°åˆ†æ
    tracing::warn!("âš ï¸ æ‰§è¡Œå¤±è´¥ï¼Œå¯åŠ¨æ¢å¤æµç¨‹");
    
    if let Some(original_xml) = &original_data.original_xml {
        // 2.1 ä»åŸå§‹XMLæå–ç­–ç•¥å€™é€‰
        let original_candidates = intelligent_analysis_service::analyze(
            original_xml,
            &original_data.selected_xpath,
            &original_data.element_text,
        )?;
        
        // 2.2 ä»å½“å‰XMLæå–å…ƒç´ 
        let current_elements = extract_elements_by_xpath(
            current_xml,
            &original_data.selected_xpath,
        );
        
        // 2.3 ä½¿ç”¨å¤šå€™é€‰è¯„ä¼°å™¨æ‰¾åˆ°æœ€ä½³åŒ¹é…
        let criteria = EvaluationCriteria {
            target_text: Some(original_data.element_text.clone()),
            target_content_desc: Some(original_data.target_content_desc.clone()),
            original_bounds: Some(original_data.element_bounds.clone()),
            original_resource_id: original_data.key_attributes.resource_id.clone(),
            children_texts: original_data.children_texts.clone(),
            prefer_last: false,
            selected_xpath: Some(original_data.selected_xpath.clone()),
            xml_content: Some(current_xml.to_string()),
        };
        
        if let Some(best) = MultiCandidateEvaluator::evaluate_candidates(
            current_elements.iter().collect(),
            &criteria
        ) {
            tracing::info!("âœ… æ¢å¤æˆåŠŸï¼šæ‰¾åˆ°æœ€ä½³åŒ¹é… text={:?}", best.element.text);
            return Ok(Some(best.element));
        }
    }
    
    // 3. å®Œå…¨å¤±è´¥
    Err("æ¢å¤å¤±è´¥ï¼šæ— æ³•æ‰¾åˆ°åŒ¹é…å…ƒç´ ".into())
}
```

---

## ğŸ“Š 5. å®Œå–„çš„è¯„åˆ†ç³»ç»Ÿ

### æœ€ç»ˆè¯„åˆ†è§„åˆ™ï¼ˆæ€»åˆ† 1.0ï¼‰

```rust
pub fn score_candidate(
    elem: &UIElement,
    criteria: &EvaluationCriteria,
    index: usize,
    total: usize,
) -> (f32, Vec<String>) {
    let mut score = 0.0;
    let mut reasons = Vec::new();
    
    // ğŸ”¥ è¯„åˆ†é¡¹0: å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…ï¼ˆ0-0.35åˆ†ï¼‰ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘
    if let Some(ref target_text) = criteria.target_text {
        let child_match = Self::check_child_text_match(
            elem, 
            target_text, 
            &criteria.xml_content
        );
        
        if child_match.is_complete {
            score += 0.35;
            reasons.push(format!(
                "ğŸ”¥ğŸ”¥ğŸ”¥ å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…: '{}' (çˆ¶å®¹å™¨+å­æ–‡æœ¬æ¨¡å¼)", 
                target_text
            ));
        } else if child_match.is_partial {
            score += 0.25;
            reasons.push(format!(
                "ğŸŸ¡ å­å…ƒç´ æ–‡æœ¬éƒ¨åˆ†åŒ¹é…: '{}'", 
                target_text
            ));
        }
    }
    
    // ğŸ¯ è¯„åˆ†é¡¹1: XPathç»“æ„ç›¸ä¼¼åº¦ï¼ˆ0-0.25åˆ†ï¼‰
    if let Some(ref selected_xpath) = criteria.selected_xpath {
        if let Some(ref elem_xpath) = elem.xpath {
            let similarity = Self::calculate_xpath_similarity(
                selected_xpath, 
                elem_xpath
            );
            let xpath_score = similarity * 0.25;
            score += xpath_score;
            reasons.push(format!(
                "ğŸ“ XPathç›¸ä¼¼åº¦: {:.1}% (å¾—åˆ†: {:.2})", 
                similarity * 100.0, 
                xpath_score
            ));
        }
    }
    
    // ğŸ¯ è¯„åˆ†é¡¹2: è‡ªèº«æ–‡æœ¬å®Œå…¨åŒ¹é…ï¼ˆ0-0.2åˆ†ï¼‰
    if let Some(ref target_text) = criteria.target_text {
        if let Some(ref elem_text) = elem.text {
            if elem_text == target_text {
                score += 0.2;
                reasons.push(format!(
                    "âœ… è‡ªèº«æ–‡æœ¬å®Œå…¨åŒ¹é…: '{}'", 
                    target_text
                ));
            } else if elem_text.contains(target_text) {
                score += 0.1;
                reasons.push(format!(
                    "ğŸŸ¢ è‡ªèº«æ–‡æœ¬åŒ…å«: '{}'", 
                    target_text
                ));
            }
        }
    }
    
    // ğŸ¯ è¯„åˆ†é¡¹3: Content-descåŒ¹é…ï¼ˆ0-0.1åˆ†ï¼‰
    if let Some(ref target_desc) = criteria.target_content_desc {
        if let Some(ref elem_desc) = elem.content_desc {
            if elem_desc == target_desc {
                score += 0.1;
                reasons.push(format!(
                    "âœ… Content-descåŒ¹é…: '{}'", 
                    target_desc
                ));
            }
        }
    }
    
    // ğŸ¯ è¯„åˆ†é¡¹4: Resource-idåŒ¹é…ï¼ˆ0-0.05åˆ†ï¼‰
    if let Some(ref original_id) = criteria.original_resource_id {
        if let Some(ref elem_id) = elem.resource_id {
            if elem_id == original_id {
                score += 0.05;
                reasons.push(format!(
                    "âœ… Resource-idåŒ¹é…: '{}'", 
                    original_id
                ));
            }
        }
    }
    
    // ğŸ¯ è¯„åˆ†é¡¹5: Boundsç©ºé—´è·ç¦»ï¼ˆ0-0.05åˆ†ï¼‰
    if let (Some(ref orig_bounds), Some(ref elem_bounds)) = 
        (&criteria.original_bounds, &elem.bounds) {
        
        if let Ok(distance) = calculate_distance(orig_bounds, elem_bounds) {
            let spatial_score = if distance < 50.0 {
                0.05
            } else if distance < 100.0 {
                0.03
            } else if distance < 200.0 {
                0.01
            } else {
                0.0
            };
            
            score += spatial_score;
            reasons.push(format!(
                "ğŸ“ ç©ºé—´è·ç¦»: {:.0}px (å¾—åˆ†: {:.2})", 
                distance, 
                spatial_score
            ));
        }
    }
    
    (score, reasons)
}
```

### è¯„åˆ†æƒé‡è¯´æ˜

| è¯„åˆ†é¡¹ | æƒé‡ | åŸå›  |
|--------|------|------|
| å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é… | 0.35 | **Androidæ ¸å¿ƒæ¨¡å¼**ï¼šå¯ç‚¹å‡»çˆ¶å®¹å™¨+æ–‡æœ¬å­å…ƒç´  |
| XPathç»“æ„ç›¸ä¼¼åº¦ | 0.25 | ä¿è¯é€‰æ‹©ç›¸åŒå±‚çº§çš„å…ƒç´  |
| è‡ªèº«æ–‡æœ¬åŒ¹é… | 0.20 | ä¼ ç»Ÿç²¾ç¡®åŒ¹é… |
| Content-descåŒ¹é… | 0.10 | è¾…åŠ©ä¿¡æ¯ |
| Resource-idåŒ¹é… | 0.05 | ç¨³å®šæ€§æ ‡è¯† |
| Boundsç©ºé—´è·ç¦» | 0.05 | ä½ç½®ç›¸è¿‘æ€§ |
| **æ€»è®¡** | **1.00** | |

---

## ğŸ”„ 6. å®Œæ•´æ‰§è¡Œæµç¨‹ï¼ˆä¿®å¤åï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‰ç«¯é™æ€åˆ†æ                                              â”‚
â”‚    ç”¨æˆ·ç‚¹å‡» "é€šè®¯å½•" bounds=[45,1059][249,1263]              â”‚
â”‚    â†“                                                         â”‚
â”‚    æå–å®Œæ•´ä¿¡æ¯ï¼š                                             â”‚
â”‚    - selected_xpath: ç²¾ç¡®XPath                               â”‚
â”‚    - element_bounds: [45,1059][249,1263]                    â”‚
â”‚    - element_text: "é€šè®¯å½•"                                  â”‚
â”‚    - children_texts: ["é€šè®¯å½•"]                              â”‚
â”‚    - original_xml: å®Œæ•´XMLå¿«ç…§                               â”‚
â”‚    - key_attributes: {resource-id, class, ...}              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åç«¯æ™ºèƒ½åˆ†æ (Step 0-6)                                   â”‚
â”‚    Step 0: æ„å»º AnalysisContext                             â”‚
â”‚      - è§£æåŸå§‹XMLå¿«ç…§                                        â”‚
â”‚      - æå–ç”¨æˆ·é€‰æ‹©ä¸Šä¸‹æ–‡                                     â”‚
â”‚    â†“                                                         â”‚
â”‚    Step 1-6: ç­–ç•¥è¯„åˆ†                                        â”‚
â”‚      Step 2: child_driven (å­æ–‡æœ¬åŒ¹é…)                       â”‚
â”‚        å‘ç°ï¼šçˆ¶å…ƒç´ [45,1059][249,1263] clickable=true        â”‚
â”‚              å­å…ƒç´  text="é€šè®¯å½•"                            â”‚
â”‚        è¯„åˆ†ï¼š0.35 (æœ€é«˜åˆ†) â† ğŸ”¥ å…³é”®                         â”‚
â”‚    â†“                                                         â”‚
â”‚    ç”Ÿæˆå€™é€‰ï¼š                                                 â”‚
â”‚      1. "é€šè®¯å½•" (0.92åˆ†)                                    â”‚
â”‚      2. "æ‰«ä¸€æ‰«" (0.74åˆ†)                                    â”‚
â”‚      3. "å¾®ä¿¡æœ‹å‹" (0.71åˆ†)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Boundsé‡æ’åº + å­å…ƒç´ æ£€æµ‹                                  â”‚
â”‚    ä½¿ç”¨ç”¨æˆ·boundsé‡æ–°è¯„ä¼°å€™é€‰                                 â”‚
â”‚    â†“                                                         â”‚
â”‚    æ£€æµ‹åˆ°å¯ç‚¹å‡»å­å…ƒç´ åœ¨ç”¨æˆ·åŒºåŸŸå†…                              â”‚
â”‚    â†“                                                         â”‚
â”‚    æœ€ä½³å€™é€‰ç¡®è®¤ï¼š"é€šè®¯å½•" (0.95åˆ†)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è½¬æ¢ä¸ºV3æ­¥éª¤                                               â”‚
â”‚    ä¿ç•™å®Œæ•´ original_data {                                  â”‚
â”‚      selected_xpath: "...",                                 â”‚
â”‚      original_xml: "...",                                   â”‚
â”‚      children_texts: ["é€šè®¯å½•"],                             â”‚
â”‚      ...                                                    â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. çœŸæœºæ‰§è¡Œ                                                   â”‚
â”‚    å°è¯•ä½¿ç”¨XPathå®šä½                                          â”‚
â”‚    â†“                                                         â”‚
â”‚    å¦‚æœå¤±è´¥ â†’ ä½¿ç”¨ original_xml é‡æ–°åˆ†æ                      â”‚
â”‚    â†“                                                         â”‚
â”‚    å¤šå€™é€‰è¯„ä¼° â†’ é€‰æ‹©æœ€ä½³åŒ¹é…                                  â”‚
â”‚    â†“                                                         â”‚
â”‚    ç‚¹å‡»ï¼š"é€šè®¯å½•" [147,1161] âœ… æˆåŠŸ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ 7. å®æ–½æ¸…å•

### Phase 1: ç´§æ€¥ä¿®å¤ï¼ˆ1-2å¤©ï¼‰

- [ ] **å‰ç«¯**ï¼šä¿®å¤å…ƒç´ ç‚¹å‡»æ—¶çš„bounds/textæå–é€»è¾‘
- [ ] **åç«¯**ï¼šå¯ç”¨ `MultiCandidateEvaluator`ï¼ˆç§»é™¤ä¸´æ—¶é™çº§ï¼‰
- [ ] **æµ‹è¯•**ï¼šéªŒè¯"é€šè®¯å½•"æŒ‰é’®èƒ½å¦æ­£ç¡®è¯†åˆ«

### Phase 2: å®Œå–„åŠŸèƒ½ï¼ˆ3-5å¤©ï¼‰

- [ ] **å‰ç«¯**ï¼šå®ç°XMLå¿«ç…§ä¿å­˜åŠŸèƒ½
- [ ] **åç«¯**ï¼šå®Œå–„å­æ–‡æœ¬åŒ¹é…çš„XMLè§£æé€»è¾‘
- [ ] **åç«¯**ï¼šå®Œå–„æ™ºèƒ½åˆ†æå€™é€‰è½¬æ¢é€»è¾‘
- [ ] **æµ‹è¯•**ï¼šå…¨é¢æµ‹è¯•å„ç§UIæ¨¡å¼

### Phase 3: æ¶æ„ä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰

- [ ] **å‰ç«¯**ï¼šé‡æ„ `original_data` ç»“æ„ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
- [ ] **åç«¯**ï¼šå®ç°å®Œæ•´çš„å¤±è´¥æ¢å¤æœºåˆ¶
- [ ] **åç«¯**ï¼šä¼˜åŒ–è¯„åˆ†ç³»ç»Ÿæƒé‡
- [ ] **æ–‡æ¡£**ï¼šæ›´æ–°æ¶æ„æ–‡æ¡£å’ŒAPIæ–‡æ¡£

---

## ğŸ“ 8. å…³é”®ä»£ç æ–‡ä»¶æ¸…å•

### å‰ç«¯æ–‡ä»¶
```
src/components/
  â””â”€â”€ å¯è§†åŒ–é€‰æ‹©ç»„ä»¶ï¼ˆéœ€è¦ä¿®å¤ï¼‰
      - å…ƒç´ ç‚¹å‡»å¤„ç†
      - bounds/textæå–
      - XMLå¿«ç…§ä¿å­˜
```

### åç«¯æ–‡ä»¶
```
src-tauri/src/
â”œâ”€â”€ exec/v3/
â”‚   â”œâ”€â”€ helpers/
â”‚   â”‚   â”œâ”€â”€ step_executor.rs           â† ğŸ”¥ å¯ç”¨å¤šå€™é€‰è¯„ä¼°
â”‚   â”‚   â”œâ”€â”€ strategy_generation.rs     â† ğŸ”¥ ä¿®å¤å€™é€‰è½¬æ¢
â”‚   â”‚   â””â”€â”€ analysis_helpers.rs        â† éªŒè¯æ•°æ®å®Œæ•´æ€§
â”‚   â”œâ”€â”€ element_matching/
â”‚   â”‚   â””â”€â”€ multi_candidate_evaluator.rs  â† ğŸ”¥ å­æ–‡æœ¬åŒ¹é…é€»è¾‘
â”‚   â””â”€â”€ recovery_manager.rs            â† å¤±è´¥æ¢å¤
â””â”€â”€ services/
    â””â”€â”€ intelligent_analysis_service.rs  â† Step 0-6å¼•æ“
```

---

## ğŸš€ 9. é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œå¯¹äº"é€šè®¯å½•"æŒ‰é’®ï¼š

```
âœ… ç”¨æˆ·ç‚¹å‡»: "é€šè®¯å½•"
âœ… ç³»ç»Ÿè¯†åˆ«: "é€šè®¯å½•" (confidence=0.95)
âœ… æ‰§è¡Œç‚¹å‡»: "é€šè®¯å½•" æŒ‰é’®ä¸­å¿ƒ
âœ… ç»“æœ: æˆåŠŸæ‰“å¼€é€šè®¯å½•é¡µé¢

è¯„åˆ†è¯¦æƒ…:
  - å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…: 0.35 ğŸ”¥
  - XPathç»“æ„ç›¸ä¼¼åº¦: 0.25
  - è‡ªèº«æ–‡æœ¬åŒ¹é…: 0.20
  - Content-descåŒ¹é…: 0.10
  - Resource-idåŒ¹é…: 0.05
  - Boundsç©ºé—´è·ç¦»: 0.05
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ€»åˆ†: 0.95 / 1.00
```

---

## ğŸ‰ æ€»ç»“

è¿™ä¸ªé—®é¢˜æš´éœ²äº†ä¸‰ä¸ªæ ¸å¿ƒæ¶æ„ç¼ºé™·ï¼š

1. **å‰ç«¯æ•°æ®æå–ä¸ç²¾ç¡®** â†’ éœ€è¦é‡æ„å¯è§†åŒ–é€‰æ‹©é€»è¾‘
2. **åç«¯è¯„åˆ†ç³»ç»Ÿæœªå¯ç”¨** â†’ éœ€è¦ç§»é™¤ä¸´æ—¶é™çº§ä»£ç 
3. **æ•°æ®æµæ–­è£‚** â†’ éœ€è¦ç¡®ä¿ `original_data` å®Œæ•´ä¼ é€’

ä¿®å¤è¿™ä¸‰ä¸ªé—®é¢˜åï¼Œç³»ç»Ÿå°†èƒ½å¤Ÿæ­£ç¡®å¤„ç†æ‰€æœ‰ **"å¯ç‚¹å‡»çˆ¶å®¹å™¨+æ–‡æœ¬å­å…ƒç´ "** çš„UIæ¨¡å¼ï¼Œè¿™æ˜¯Androidåº”ç”¨æœ€å¸¸è§çš„æ¶æ„æ¨¡å¼ã€‚

**æ ¸å¿ƒä¼˜åŒ–**ï¼šå­å…ƒç´ æ–‡æœ¬åŒ¹é…ç»™äºˆ**æœ€é«˜æƒé‡ï¼ˆ0.35åˆ†ï¼‰**ï¼Œç¡®ä¿è¿™ç±»æŒ‰é’®å§‹ç»ˆèƒ½è¢«æ­£ç¡®è¯†åˆ«ã€‚
