让我详细分析 V2 架构的结构和组织： 

读取 [](file:///d%3A/rust/active-projects/%E5%B0%8F%E7%BA%A2%E4%B9%A6/employeeGUI/src-tauri/src/commands/run_step_v2.rs#1-1)，行 1 到 51

搜索 `V2|run_step_v2` (`**/src-tauri/src/commands/**`)、20 结果的文本

读取 [](file:///d%3A/rust/active-projects/%E5%B0%8F%E7%BA%A2%E4%B9%A6/employeeGUI/src-tauri/src/commands)

读取 [](file:///d%3A/rust/active-projects/%E5%B0%8F%E7%BA%A2%E4%B9%A6/employeeGUI/src-tauri/src/commands/mod.rs#1-1)，行 1 到 41

搜索 `run_step_v2|V2` (`**/src-tauri/src/main.rs`)、15 结果的文本

已在 代码库 中搜索 "V2 architecture legacy simple selection engine strategy"、2 结果

现在让我看一下支持 V2 架构的核心文件： 

搜索 `legacy.*selection|simple.*selection` (`**/src-tauri/src/services/**`)、4 结果的文本

读取 [](file:///d%3A/rust/active-projects/%E5%B0%8F%E7%BA%A2%E4%B9%A6/employeeGUI/src-tauri/src/services/legacy_simple_selection_engine.rs#1-1)，行 1 到 81

基于搜索和分析，这是 **V2 架构的完整概览**：

## 🏗️ V2 架构总览

### 📁 目录结构

```
src-tauri/src/commands/
├── run_step_v2.rs              # 🎯 V2 架构核心文件 (1968行)
├── step_execution.rs           # 统一步骤执行命令
├── intelligent_analysis.rs     # 智能分析命令
├── strategy_matching.rs        # 策略匹配命令
├── smart_selection.rs          # 智能选择系统命令
└── mod.rs                     # 命令模块导出

src-tauri/src/services/
├── legacy_simple_selection_engine.rs  # ⚠️ 已弃用的简化选择引擎
├── smart_script_executor.rs            # 智能脚本执行器
├── execution/                          # 执行相关服务
│   ├── matching/                       # 匹配策略
│   └── model/                          # 执行模型
└── ...

src-tauri/src/engine/
├── strategy_engine.rs          # 策略引擎
├── strategy_plugin.rs          # 策略插件系统
├── strategy_plugin_v2.rs       # V2 策略插件
├── xml_indexer.rs              # XML 索引器
└── gating.rs                   # 安全检查
```

## 🎯 V2 架构特点

### **1. 单文件巨石架构**
- **核心文件**: run_step_v2.rs (1968行代码)
- **特点**: 所有 V2 逻辑集中在一个文件中
- **包含**: 类型定义、执行逻辑、策略处理、安全检查

### **2. 三条执行链**
```rust
// V2 执行模式
pub enum StepRunMode {
    MatchOnly,      // 仅匹配，不执行
    Execute,        // 完整执行
    Static,         // 静态分析
}
```

### **3. 策略系统**
```rust
// V2 策略类型
pub enum StrategyKind {
    Simple,         // 简单匹配
    Enhanced,       // 增强匹配  
    Legacy,         // 遗留系统
    Intelligent,    // 智能分析
}
```

## 🔧 V2 核心组件分析

### **主要类型定义**
```rust
// V2 请求结构
pub struct RunStepRequestV2 {
    pub device_id: String,
    pub mode: StepRunMode,
    pub strategy: StrategyKind,
    pub step: serde_json::Value,
    // ... 其他字段
}

// V2 响应结构
pub struct StepResponseV2 {
    pub success: bool,
    pub message: String,
    pub candidates: Option<Vec<MatchCandidate>>,
    pub execution_time_ms: i64,
    // ... 其他字段
}
```

### **执行流程**
```
前端调用 run_step_v2 →
execute_v2_step() 处理 →
策略选择与匹配 →
安全检查 (SafetyGatekeeper) →
执行动作 →
返回结果
```

## 🏛️ V2 vs V3 架构对比

| 维度 | V2 架构 | V3 架构 |
|---|---|---|
| **文件组织** | 单文件巨石 (run_step_v2.rs) | 模块化目录 (`exec/v3/`) |
| **代码行数** | ~2000行单文件 | 分散在多个专业文件 |
| **类型系统** | 紧耦合在命令文件中 | 独立的 types.rs |
| **事件系统** | 基础日志 | 结构化事件流 (events.rs) |
| **执行模式** | 三种模式混合 | 清晰的单步/链式/静态分离 |
| **策略分析** | 简化版本 | 完整 Step 0-6 分析 |
| **扩展性** | 修改需要改动核心文件 | 模块化，易于扩展 |
| **测试性** | 难以单元测试 | 组件化，便于测试 |

## 📋 V2 架构的主要问题

### **1. 代码组织问题**
- 🚨 **巨石架构**: 单个文件 1968 行代码
- 🚨 **职责混杂**: 类型定义、业务逻辑、执行器都在一个文件
- 🚨 **难以维护**: 修改任何功能都需要编辑核心文件

### **2. 依赖混乱**
```rust
// V2 文件中混杂了多种依赖
use crate::engine::{FallbackController, XmlIndexer, SafetyGatekeeper};
use crate::engine::strategy_plugin::{StrategyRegistry, ExecutionEnvironment};
use crate::services::ui_reader_service::{get_ui_dump, UIElement};
// ... 大量其他依赖
```

### **3. 类型系统耦合**
- 类型定义与实现逻辑混合
- 难以在其他模块中复用类型
- 前端接口变更影响核心逻辑

## 🎯 V2 遗留系统

### **Legacy Components**
```rust
// 已弃用但仍存在的组件
legacy_simple_selection_engine.rs  // ⚠️ 简化选择引擎
strategy_plugin_v2.rs              // V2 策略插件  
xml_indexer.rs                     // XML 索引器（V2 类型）
```

### **Tauri 命令接口**
```rust
// 在 main.rs 中注册的 V2 命令
run_step_v2                        // V2 统一步骤执行
start_intelligent_analysis         // V2 智能分析入口
cancel_intelligent_analysis        // V2 取消分析操作
bind_analysis_result_to_step       // V2 手动绑定分析结果
```

## 🚀 迁移建议

### **从 V2 到 V3 的迁移路径**
```typescript
// V2 调用方式
await invoke('run_step_v2', {
  device_id: 'emulator-5554',
  mode: 'Execute',
  strategy: 'Intelligent',
  step: stepData
});

// V3 调用方式 (推荐)
await invoke('execute_chain_test_v3', {
  deviceId: 'emulator-5554',
  steps: [stepData],
  threshold: 0.72,
  dryRun: false
});
```

## 📊 V2 架构总结

**V2 架构的本质**:
- **命令式架构**: 以 Tauri 命令为中心的单文件实现
- **功能完整**: 虽然架构有问题，但功能相对完整
- **向后兼容**: 保留作为 V3 的回退选项
- **维护状态**: 处于维护模式，不再新增功能

**适用场景**:
- 现有功能的向后兼容
- V3 系统故障时的回退方案
- 简单的单步执行需求

V2 架构虽然存在明显的设计问题，但在过渡期仍然发挥着重要的稳定性作用！