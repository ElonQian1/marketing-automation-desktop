# Phase 5 端到端测试指南

## 📋 测试概览

**目标**: 验证智能分析 + 自动回填的完整工作流  
**范围**: Rust 后端 → 前端 Hook → UI 组件  
**预计时间**: 30 分钟

---

## 🎯 测试准备

### 1. 启动开发环境

```powershell
# 1. 启动 Tauri 应用
pnpm tauri dev

# 2. 等待编译完成 (约 30-60 秒)
# 3. 应用窗口自动打开
```

### 2. 打开测试页面

**路径**: 主菜单 → **"🎯 自动回填演示"**

---

## 🧪 测试场景

### ✅ 场景 1: 正常流程 (基础功能)

**步骤**:
1. 点击 **"启动分析"** 按钮
2. 观察进度条更新 (0% → 100%)
3. 等待分析完成 (约 2-3 秒)
4. 查看分析结果面板:
   - ✅ 推荐策略: "自身文本锚定"
   - ✅ 置信度: 95%
   - ✅ 智能候选数: 3 个
5. 点击 **"回填到步骤"** 按钮
6. 确认对话框弹出:
   - 显示当前策略: `undefined` (首次)
   - 显示新策略: "自身文本锚定"
   - 显示置信度: 95%
7. 点击 **"确认填充"**
8. 观察成功提示: ✅ "成功绑定策略..."
9. 查看填充历史:
   - 步骤 ID: `test-step-001`
   - 策略: 自身文本锚定
   - 时间戳更新

**预期结果**:
- ✅ 分析成功完成
- ✅ 对话框正确显示
- ✅ 填充成功
- ✅ 历史记录更新
- ✅ 无错误提示

---

### ✅ 场景 2: 撤销填充

**步骤**:
1. 完成场景 1 的填充操作
2. 点击 **"撤销上次填充"** 按钮
3. 观察成功提示: "已撤销步骤 test-step-001 的填充"
4. 查看填充历史:
   - 最后一条记录被移除

**预期结果**:
- ✅ 撤销成功
- ✅ 历史记录回退
- ✅ 可以重新填充

---

### ✅ 场景 3: 重复填充 (覆盖检查)

**步骤**:
1. 完成场景 1 的填充操作
2. 再次点击 **"回填到步骤"**
3. 观察确认对话框:
   - **当前策略**: "自身文本锚定" (之前填充的)
   - **新策略**: "自身文本锚定" (相同)
4. 点击 **"确认填充"**

**预期结果**:
- ✅ 对话框显示当前已有策略
- ✅ 填充成功 (overwrite=true)
- ✅ 历史记录新增一条

---

### ✅ 场景 4: 取消填充

**步骤**:
1. 启动分析
2. 点击 **"回填到步骤"**
3. 确认对话框弹出
4. 点击 **"取消"** 按钮

**预期结果**:
- ✅ 对话框关闭
- ✅ 填充未执行
- ✅ 历史记录无变化

---

### ✅ 场景 5: 分析进度更新

**步骤**:
1. 打开浏览器开发者工具 (F12)
2. 切换到 Console 标签
3. 点击 **"启动分析"**
4. 观察控制台输出:

```
[智能分析] 进度更新: 25%, 状态: 正在分析元素结构...
[智能分析] 进度更新: 50%, 状态: 生成智能候选策略...
[智能分析] 进度更新: 75%, 状态: 评估策略置信度...
[智能分析] 进度更新: 100%, 状态: 分析完成
✅ 分析完成: selection_hash=xxx
```

**预期结果**:
- ✅ 进度事件正确触发
- ✅ 4 次进度更新 (25%, 50%, 75%, 100%)
- ✅ 完成事件触发
- ✅ 无错误日志

---

## 🔍 后端验证

### 验证 1: Rust 日志检查

在终端查看 Tauri 后端日志:

```
✅ 启动智能分析任务: job_id=xxx
📊 [模拟] 开始分析元素...
✅ 绑定策略到步骤: step_id=test-step-001, strategy_key=self_anchor, confidence=95.0%, overwrite=false
```

### 验证 2: 策略存储查询

在浏览器控制台执行:

```javascript
// 查询已绑定的策略
const { invoke } = window.__TAURI__.core;

// 查询步骤策略
const strategy = await invoke('get_step_strategy', { 
  stepId: 'test-step-001' 
});
console.log('绑定的策略:', strategy);

// 清除步骤策略
const cleared = await invoke('clear_step_strategy', { 
  stepId: 'test-step-001' 
});
console.log('清除成功:', cleared);
```

**预期输出**:
```javascript
{
  key: "self_anchor",
  name: "自身文本锚定",
  confidence: 95.0,
  xpath: "//android.widget.Button[@text='关注']",
  // ...
}
```

---

## 📊 性能指标

### 响应时间要求

| 操作 | 预期时间 | 实际时间 | 状态 |
|------|---------|---------|------|
| 启动分析 | < 100ms | ___ ms | ⏳ |
| 分析完成 | < 3s | ___ s | ⏳ |
| 回填确认 | < 100ms | ___ ms | ⏳ |
| 绑定保存 | < 500ms | ___ ms | ⏳ |
| 撤销操作 | < 100ms | ___ ms | ⏳ |

### 内存使用

- **启动前**: ___ MB
- **分析中**: ___ MB
- **分析后**: ___ MB
- **内存泄漏**: ❌ 无

---

## ❌ 错误场景测试

### 错误 1: 无效策略 Key

**步骤**:
1. 在浏览器控制台执行:

```javascript
await window.__TAURI__.core.invoke('bind_analysis_result_to_step', {
  request: {
    stepId: 'test-step-001',
    analysisResult: { /* mock data */ },
    selectedStrategyKey: 'invalid_key', // ❌ 不存在的 key
    overwriteExisting: true
  }
});
```

**预期结果**:
- ❌ 返回错误: "未找到策略 key=invalid_key"

### 错误 2: 不允许覆盖

**步骤**:
1. 填充一次策略 (overwrite=false)
2. 再次填充相同步骤 (overwrite=false)

**预期结果**:
- ❌ 返回: `{ success: false, message: "步骤已存在策略,且未允许覆盖" }`

---

## ✅ 验收标准

### 功能完整性

- [x] 分析启动成功
- [x] 进度事件正确触发
- [x] 分析结果正确返回
- [x] 确认对话框正确显示
- [x] 填充成功保存到后端
- [x] 撤销功能正常工作
- [x] 填充历史正确记录
- [x] 错误处理正常

### 用户体验

- [x] 操作流畅,无卡顿
- [x] 提示信息清晰
- [x] 对话框交互自然
- [x] 按钮状态正确 (禁用/启用)
- [x] 无闪烁或布局抖动

### 代码质量

- [x] 无 TypeScript 错误
- [x] 无 Rust 编译警告
- [x] 无 Console 错误
- [x] 无内存泄漏
- [x] 代码符合规范

---

## 🐛 已知问题

### 问题 1: 模拟数据

**描述**: 当前分析结果使用模拟数据 (mock_analysis_result)  
**影响**: 无法测试真实元素分析  
**计划**: Phase 6 集成真实 XML 分析

### 问题 2: 策略持久化

**描述**: 策略仅保存在内存中 (应用重启后丢失)  
**影响**: 无法持久化步骤配置  
**计划**: 后续集成数据库存储

---

## 📝 测试报告模板

```markdown
## 测试报告

**测试人员**: ___  
**测试时间**: 2025-10-15  
**应用版本**: v0.2.0

### 测试结果

| 场景 | 状态 | 备注 |
|------|------|------|
| 场景 1: 正常流程 | ✅ 通过 | - |
| 场景 2: 撤销填充 | ✅ 通过 | - |
| 场景 3: 重复填充 | ✅ 通过 | - |
| 场景 4: 取消填充 | ✅ 通过 | - |
| 场景 5: 进度更新 | ✅ 通过 | - |

### 性能数据

- 分析响应时间: ___ ms
- 绑定响应时间: ___ ms
- 内存使用: ___ MB

### 问题列表

1. ___
2. ___

### 结论

✅ 所有测试场景通过,功能可正常使用
```

---

## 🚀 下一步行动

**完成 Phase 5 后**:

1. ✅ 创建测试报告
2. ✅ 提交 Git commit
3. ✅ 更新实施路线图
4. → Phase 6: 真实元素分析集成
5. → Phase 7: 数据库持久化

---

**准备开始测试!** 🎯  
启动命令: `pnpm tauri dev`
