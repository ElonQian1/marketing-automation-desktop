# Round 3｜查重策略（v1）

> 目标：同一“对象/人/文本”在可控窗口内只触达一次；既要稳健，也要能解释。

---

## 1) 三层查重
1. **评论级**（强去重）：
   - 键：`dedup_key = sha1(platform + ':' + comment_id)`；
   - 作用：同一评论只处理一次；
   - TTL：90 天（与业务保留期一致）。
2. **用户级**（窗口去重）：
   - 键：`user_key = sha1(platform + ':' + author_user_id)`；
   - 窗口：7 天内不重复触达（跨设备共享）。
3. **文本级**（近重复）：
   - 方式：对回复文本做相似度计算（余弦/SimHash）；
   - 阈值：相似度 ≥ 0.85 视为重复，换模板或延后。

---

## 2) 跨设备/跨账号策略
- 查重存储在**全局作用域**，所有设备与账号共享；
- 允许“白名单账号”绕过用户级查重（如售后专员），但必须记录原因与审批人。

---

## 3) 冲突与并发
- 出队前先读去重索引；
- EXECUTING 加锁时再次校验；
- 若命中：任务标记 `result_code=DUPLICATED` → `DONE`（带“去重签收”原因）。

---

## 4) 数据结构与审计
- 索引：`(dedup_key, created_at, expire_at, by_account)`；
- 审计：记录去重命中的来源任务、操作者（system/api/manual）、时间；
- 导出：可按天导出“去重统计”，用于解释为什么某些任务被跳过。

---

## 5) 例外与复触达
- 允许“复触达”场景（如用户明确邀请继续沟通）：
  - 需运营在 UI 勾选“允许复触达（48h）”，创建一条**临时豁免**；
  - 到时清除豁免，恢复正常查重。

---

## 6) 自检清单（DoD）
- 理论上同一评论不会出现两次执行记录；
- 同一用户在 7 天内最多被一个设备触达一次（除白名单豁免）；
- 回复文本相似度超阈值会被提示并换模板。

