# ğŸ¯ æ™ºèƒ½è‡ªåŠ¨é“¾åˆ†æäº§ç‰©è¯¦è§£

## ğŸ§  æ™ºèƒ½è‡ªåŠ¨é“¾çš„åˆ†æäº§ç‰©ç±»å‹

åŸºäºå¯¹ä»£ç çš„æ·±å…¥åˆ†æï¼Œæ™ºèƒ½è‡ªåŠ¨é“¾åŸºäºå‰ç«¯XMLå¯è§†åŒ–ç¼“å­˜è¿›è¡Œé‡æ–°åˆ†æåï¼Œä¼šäº§ç”Ÿä»¥ä¸‹ä¸°å¯Œçš„åˆ†æäº§ç‰©ï¼š

---

## ğŸ“¦ æ ¸å¿ƒåˆ†æäº§ç‰©

### **1. ç­–ç•¥å€™é€‰åˆ—è¡¨ (StrategyCandidate[])**

```typescript
// åç«¯ Rust è¿”å›çš„ç­–ç•¥å€™é€‰
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StrategyCandidate {
    pub strategy: String,           // "self_text", "child_text", "bounds", etc.
    pub confidence: f64,            // ç½®ä¿¡åº¦ 0.0-1.0
    pub reasoning: String,          // æ¨ç†è¿‡ç¨‹è¯´æ˜
    pub element_info: ElementInfo,  // å…ƒç´ å®šä½ä¿¡æ¯
    pub execution_params: serde_json::Value, // æ‰§è¡Œå‚æ•°
}

// å‰ç«¯æ¥æ”¶çš„ç­–ç•¥å€™é€‰æ ¼å¼
interface StrategyCandidate {
  key: string;                    // ç­–ç•¥å”¯ä¸€æ ‡è¯†
  name: string;                   // ç”¨æˆ·å‹å¥½åç§°
  confidence: number;             // ç½®ä¿¡åº¦
  xpath: string;                  // XPathè¡¨è¾¾å¼
  description?: string;           // ç­–ç•¥æè¿°
}
```

### **2. Step 0-6 åˆ†æè¯¦æƒ… (StepAnalysisDetail[])**

```rust
// æ¯ä¸ªæ­¥éª¤çš„è¯¦ç»†åˆ†æç»“æœ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StepAnalysisDetail {
    pub step_name: String,          // "SelfAnchor", "ChildAnchor", "BoundsMatch"ç­‰
    pub step_index: usize,          // 0-6 å¯¹åº”6ä¸ªåˆ†æå±‚æ¬¡
    pub candidates_found: usize,    // æ‰¾åˆ°çš„å€™é€‰æ•°é‡
    pub best_confidence: f64,       // æœ€ä½³ç½®ä¿¡åº¦
    pub execution_time_ms: u64,     // æ‰§è¡Œè€—æ—¶
    pub status: String,             // "success", "failure", "skipped"
}
```

### **3. ç½®ä¿¡åº¦è¯æ® (ConfidenceEvidence)**

```typescript
// å‰ç«¯ç½®ä¿¡åº¦è¯æ®ç»“æ„
export interface ConfidenceEvidence {
  textMatch?: number;              // æ–‡æœ¬åŒ¹é…å¾—åˆ† 0-1
  positionStability?: number;      // ä½ç½®ç¨³å®šæ€§ 0-1
  structuralContext?: number;      // ç»“æ„ä¸Šä¸‹æ–‡ 0-1
  attributeReliability?: number;   // å±æ€§å¯é æ€§ 0-1
  historicalSuccess?: number;      // å†å²æˆåŠŸç‡ 0-1
  breakdown?: {                    // è¯¦ç»†åˆ†è§£
    [key: string]: number;
  };
}
```

### **4. æ™ºèƒ½åˆ†æå®Œæ•´ç»“æœ (IntelligentAnalysisResult)**

```rust
// åç«¯å®Œæ•´åˆ†æç»“æœ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct IntelligentAnalysisResult {
    pub analysis_id: String,                    // åˆ†æID
    pub success: bool,                          // æ˜¯å¦æˆåŠŸ
    pub candidates: Vec<StrategyCandidate>,     // ç­–ç•¥å€™é€‰åˆ—è¡¨
    pub analysis_time_ms: u128,                 // åˆ†æè€—æ—¶
    pub step_details: Vec<StepAnalysisDetail>,  // æ­¥éª¤è¯¦æƒ…
    pub recommendations: Vec<String>,           // æ¨èå»ºè®®
    pub metadata: AnalysisMetadata,             // å…ƒæ•°æ®
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AnalysisMetadata {
    pub xml_hash: String,           // XMLå†…å®¹å“ˆå¸Œ
    pub xml_element_count: usize,   // XMLå…ƒç´ æ•°é‡
    pub device_info: String,        // è®¾å¤‡ä¿¡æ¯
    pub analysis_timestamp: String, // åˆ†ææ—¶é—´æˆ³
    pub engine_version: String,     // å¼•æ“ç‰ˆæœ¬
}
```

---

## ğŸ’¾ åˆ†æäº§ç‰©çš„ä¿å­˜ä½ç½®

### **1. å‰ç«¯å†…å­˜å­˜å‚¨ - StepCard Store**

```typescript
// src/store/stepcards.ts - æ­¥éª¤å¡ç‰‡çŠ¶æ€ç®¡ç†
export interface StepCard {
  id: string;                      // å¡ç‰‡ID
  jobId?: string;                  // ä½œä¸šID (è¿æ¥åç«¯åˆ†æ)
  elementUid: string;              // å…ƒç´ å”¯ä¸€æ ‡è¯†
  elementContext?: {               // å…ƒç´ ä¸Šä¸‹æ–‡
    xpath?: string;
    text?: string;
    bounds?: string;
    resourceId?: string;
    className?: string;
  };
  status: StepCardStatus;          // çŠ¶æ€: draft â†’ analyzing â†’ ready
  
  // ğŸ¯ æ ¸å¿ƒåˆ†æäº§ç‰©ä¿å­˜ä½ç½®
  strategy?: {
    primary: string;               // ä¸»è¦ç­–ç•¥
    backups: string[];             // å¤‡ç”¨ç­–ç•¥
    score: number;                 // æ•´ä½“è¯„åˆ†
    candidates?: Array<{           // ğŸ”‘ æ‰€æœ‰ç­–ç•¥å€™é€‰
      key: string;
      name: string;
      confidence: number;
      xpath: string;
      description?: string;
    }>;
  };
  
  confidence?: number;             // æ•´ä½“ç½®ä¿¡åº¦
  evidence?: ConfidenceEvidence;   // ğŸ”‘ ç½®ä¿¡åº¦è¯æ®
  meta?: StepCardMeta;             // æ‰©å±•å…ƒæ•°æ®
  actionType?: ActionType;         // æ“ä½œç±»å‹
  recommendedAction?: ActionType;  // æ¨èæ“ä½œ
}
```

### **2. XMLç¼“å­˜å…³è”å­˜å‚¨**

```typescript
// src/services/xml-cache-manager.ts
export interface XmlCacheEntry {
  cacheId: string;                 // ç¼“å­˜ID
  xmlContent: string;              // ğŸ”‘ åŸå§‹XMLå†…å®¹
  xmlHash?: string;                // XMLå“ˆå¸Œ
  parsedElements?: unknown[];      // ğŸ”‘ è§£æåçš„UIå…ƒç´ 
  
  // ğŸ¯ åˆ†æç»“æœå…³è”
  pageInfo: {
    appPackage: string;
    activityName: string;
    pageTitle: string;
    pageType: string;
    elementCount: number;
  };
  
  metadata?: {
    packageName?: string;
    activity?: string;
    resolution?: string;
    locale?: string;
  };
}

// æ­¥éª¤ä¸XMLçš„æ˜ å°„å…³ç³»
export interface StepXmlContext {
  stepId: string;                  // æ­¥éª¤ID
  xmlCacheId: string;              // å…³è”çš„XMLç¼“å­˜ID
  elementPath?: string;            // å…ƒç´ åœ¨XMLä¸­çš„è·¯å¾„
  selectionContext?: {             // é€‰æ‹©ä¸Šä¸‹æ–‡
    selectedBounds: unknown;
    searchCriteria: string;
    confidence: number;
  };
}
```

### **3. åç«¯æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨**

```rust
// src-tauri/src/commands/xml_cache.rs
// åç«¯æ–‡ä»¶ç³»ç»Ÿä¸­çš„XMLç¼“å­˜
fn get_debug_xml_dir() -> std::path::PathBuf {
    // é¡¹ç›®æ ¹ç›®å½•/debug_xml/
    // å­˜å‚¨æ ¼å¼: ui_dump_timestamp.xml
}

// åˆ†æç»“æœå¯èƒ½çš„å­˜å‚¨ä½ç½®ï¼ˆæ¨æµ‹ï¼‰
// debug_xml/
// â”œâ”€â”€ ui_dump_20231031_143022.xml     // åŸå§‹XML
// â”œâ”€â”€ analysis_results/               // åˆ†æç»“æœç›®å½•
// â”‚   â”œâ”€â”€ analysis_card123_strategies.json  // ç­–ç•¥åˆ†æç»“æœ
// â”‚   â”œâ”€â”€ analysis_card123_evidence.json    // ç½®ä¿¡åº¦è¯æ®
// â”‚   â””â”€â”€ analysis_card123_metadata.json    // åˆ†æå…ƒæ•°æ®
// â””â”€â”€ screenshots/                    // å…³è”æˆªå›¾
//     â””â”€â”€ ui_dump_20231031_143022.png
```

---

## ğŸ”„ æ•°æ®æµå‘å’Œå­˜å‚¨æ—¶æœº

### **åˆ†æäº§ç‰©çš„ç”Ÿæˆå’Œå­˜å‚¨æµç¨‹**

```mermaid
sequenceDiagram
    participant V as ğŸ¨å¯è§†åŒ–ç•Œé¢
    participant C as ğŸ’¾XMLç¼“å­˜
    participant H as ğŸ£useUnifiedSmartAnalysis
    participant S as ğŸ“‹StepCard Store
    participant R as ğŸ¦€åç«¯V3å¼•æ“
    participant F as ğŸ“æ–‡ä»¶ç³»ç»Ÿ

    V->>C: ä¿å­˜XMLåˆ°ç¼“å­˜
    Note over C: xmlCacheId + xmlContent
    
    H->>R: execute_chain_test_v3(xmlCacheId)
    R->>R: Step 0-6 ç­–ç•¥åˆ†æ
    Note over R: ä½¿ç”¨ç¼“å­˜çš„XMLå†…å®¹
    
    R-->>H: IntelligentAnalysisResult
    Note over R: ç­–ç•¥å€™é€‰ + ç½®ä¿¡åº¦ + å…ƒæ•°æ®
    
    H->>S: æ›´æ–°StepCard.strategy
    Note over S: candidates + confidence + evidence
    
    H->>S: æ›´æ–°StepCard.status = "ready"
    
    par å¯é€‰çš„æŒä¹…åŒ–
        S->>F: ä¿å­˜åˆ†æç»“æœåˆ°æ–‡ä»¶
        Note over F: analysis_results/*.json
    and ç¼“å­˜å…³è”
        S->>C: æ›´æ–°StepXmlContextæ˜ å°„
        Note over C: stepId â†” xmlCacheId
    end
```

### **å­˜å‚¨çš„åˆ†å±‚æ¶æ„**

1. **å†…å­˜å±‚** (æœ€å¿«è®¿é—®)
   - `StepCard Store`: æ­¥éª¤å¡ç‰‡çŠ¶æ€å’Œç­–ç•¥ç»“æœ
   - `XML Cache Manager`: XMLå†…å®¹å’Œè§£æç»“æœ

2. **æµè§ˆå™¨æŒä¹…åŒ–å±‚** (é¡µé¢åˆ·æ–°ä¿æŒ)
   - `IndexedDB`: XMLç¼“å­˜å’Œåˆ†æç»“æœ
   - `localStorage`: ç”¨æˆ·é…ç½®å’Œç®€å•çŠ¶æ€

3. **æ–‡ä»¶ç³»ç»Ÿå±‚** (è·¨ä¼šè¯ä¿æŒ)
   - `debug_xml/`: åŸå§‹XMLæ–‡ä»¶
   - `analysis_results/`: åˆ†æç»“æœJSONæ–‡ä»¶
   - `screenshots/`: å…³è”æˆªå›¾æ–‡ä»¶

---

## ğŸ¯ åˆ†æäº§ç‰©çš„å®é™…ä»·å€¼

### **ç­–ç•¥å¤šæ ·æ€§**
- **6å±‚åˆ†æ**: Step 0-6 æä¾›ä»ç›´æ¥åŒ¹é…åˆ°æ™ºèƒ½æ¨ç†çš„å®Œæ•´ç­–ç•¥é“¾
- **å¤šé‡å¤‡é€‰**: æ¯å±‚éƒ½å¯èƒ½äº§ç”Ÿå¤šä¸ªå€™é€‰ç­–ç•¥
- **ç½®ä¿¡åº¦æ’åº**: æŒ‰å¯é æ€§è‡ªåŠ¨æ’åºæ¨è

### **ä¸Šä¸‹æ–‡ä¿æŒ**
- **XMLä¸€è‡´æ€§**: åˆ†æåŸºäºç”¨æˆ·é€‰æ‹©æ—¶çš„ç¡®åˆ‡ç•Œé¢çŠ¶æ€
- **æ—¶é—´è¿½æº¯**: ä¿æŒå®Œæ•´çš„åˆ†æå†å²å’Œå†³ç­–è¿‡ç¨‹
- **é”™è¯¯æ¢å¤**: æ”¯æŒç­–ç•¥å¤±æ•ˆæ—¶çš„è‡ªåŠ¨å›é€€

### **è°ƒè¯•èƒ½åŠ›**
- **åˆ†æé€æ˜**: æ¯ä¸ªç­–ç•¥çš„æ¨ç†è¿‡ç¨‹éƒ½æœ‰è¯¦ç»†è®°å½•
- **æ€§èƒ½ç›‘æ§**: è®°å½•æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæ—¶é—´å’ŒæˆåŠŸç‡
- **é—®é¢˜å®šä½**: é€šè¿‡ç½®ä¿¡åº¦è¯æ®å¿«é€Ÿå®šä½é—®é¢˜åŸå› 

è¿™å¥—å®Œæ•´çš„åˆ†æäº§ç‰©ä½“ç³»ç¡®ä¿äº†**ä»å¯è§†åŒ–é€‰æ‹©åˆ°æ™ºèƒ½æ‰§è¡Œçš„å…¨é“¾è·¯å¯è¿½æº¯æ€§å’Œå¯é æ€§**ï¼