# 结构匹配模式门禁修复验证指南

本指南用于验证“结构匹配(Structural Matching, SM) 仅在步骤卡片显式选择结构模式时启用；智能模式不触发 SM；结构模式严格禁止回退”的修复是否生效。

## 背景与目标
- 之前问题：只要 inline/store 中存在 structural_signatures，就可能在智能模式下误触发 SM，并在失败后回退到传统匹配。
- 修复策略（已实现）：
  1) 前端仅在 matchingStrategy === 'structural' 时附带 structural_signatures；
  2) 后端仅在“显式结构模式”且“存在有效 structural_signatures”时启用 SM；
  3) 结构模式严格：SM 失败/为空，不允许回退；非结构模式直接走传统/智能流程，不尝试 SM。

## 环境与构建
- 不要重启 Tauri 开发进程（若已在跑）。
- Rust 后端验证：`cargo check`（代理已执行通过）。
- 前端验证：`npm run type-check`、`npm run lint`（代理已执行通过）。

## 前端关键路径（确认项）
- CompactStrategyMenu：确认点击“结构匹配”后会写入 { matchingStrategy: 'structural', structural_signatures }
- useV2StepTest：构建请求时总是传 matchingStrategy，但仅在结构模式下附带 structural_signatures
- StepExecutionGateway：inline.params 内仅在结构模式下注入 structural_signatures，且会透传 matchingStrategy

代码位置（只读复核）：
- src/components/strategy-selector/CompactStrategyMenu.tsx
- src/hooks/useV2StepTest.ts
- src/infrastructure/gateways/StepExecutionGateway.ts

## 后端关键路径（确认项）
- 结构签名合并：仅在“显式结构模式”时合并 store 中的 structural_signatures（否则忽略）
- SM 启用门禁：use_structural_matching = explicit_structural_mode && has_structural_sigs
- 日志项（示例，文案可能略有差异）：
  - 配置合并阶段：
    - 🏗️ [配置合并] 显式结构模式：合并保存的 structural_signatures
    - 🛑 [配置合并] 非结构模式：忽略Store中的 structural_signatures（防止误用）
  - 执行门禁阶段：
    - 🔎 [SM门禁] explicit_structural_mode=..., inline_has_structural=..., has_structural_sigs=...
    - ✅ [SM启用] 进入结构匹配模式（仅在 explicit_structural_mode=true 且 has_structural_sigs=true）
    - ⛔ [SM关闭] 非结构模式或缺失签名，使用传统匹配流程

代码位置（只读复核）：
- src-tauri/src/exec/v3/helpers/step_executor.rs

## 实机验证流程
场景入口：页面分析 → 可视化点选 → 生成步骤卡片 → 测试步骤

A) 智能模式验证（应不触发 SM）
1. 在步骤卡片中选择“智能/自动链/非结构模式”（非 'structural'）。
2. 如曾打开过结构匹配模态并生成了 structural_signatures，保持不删除（用于验证“忽略”逻辑）。
3. 点击“测试步骤”。
4. 观察后端日志：
   - 期待看到 ⛔ [SM关闭] 非结构模式或缺失签名，使用传统匹配流程；
   - 不应出现“进入结构匹配模式”相关日志；
   - 不应合并 store 内的 structural_signatures（会打印“非结构模式：忽略…”）。

B) 结构模式验证（应启用 SM 且不回退）
1. 在步骤卡片中明确选择“结构匹配”。
2. 确保步骤参数或 store 存在有效 structural_signatures（通过模态生成即可）。
3. 点击“测试步骤”。
4. 观察后端日志：
   - 期待看到 ✅ [SM启用] 进入结构匹配模式；
   - 如 SM 找不到元素或返回空结果，应直接结束并报错，不进行智能/传统回退（无回退相关日志）。

## 常见排查点
- 智能模式仍看到“进入结构匹配模式”：
  - 核查前端是否误把 structural_signatures 注入（useV2StepTest / StepExecutionGateway）
  - 核查后端门禁条件是否为 explicit_structural_mode && has_structural_sigs
- 结构模式未生效：
  - 检查步骤参数/store 是否确实包含 structural_signatures
  - 检查日志中合并阶段是否打印了“显式结构模式：合并…”

## 验收标准（必须全部满足）
- 智能模式下：从头到尾不进入 SM；不合并 store 的 structural_signatures。
- 结构模式下：进入 SM；SM 失败时不进行任何“智能/传统”回退。
- 构建质量门：Rust 编译通过、TS 类型检查通过、ESLint 通过。

## 变更摘要
- 前端：按 matchingStrategy 条件化传递 structural_signatures，并显式传递 matchingStrategy。
- 后端：仅在显式结构模式下合并/启用 SM；智能模式完全忽略结构签名；结构模式严格无回退。

> 完成以上两类场景的实机日志留存后，可将日志片段贴入 docs/ 或 report/ 目录以备回溯。