# XPathæ•°æ®æµé—®é¢˜å®Œæ•´è§£ç­”

## â“ **ä½ çš„é—®é¢˜**

> æ­¥éª¤å¡ç‰‡ä¿å­˜æ‰€é€‰æ‹©çš„å…ƒç´ xpathä»¥åŠåŸå§‹XMLç¼“å­˜ï¼Œè¿™äº›ä¿¡æ¯ä¿å­˜åœ¨å“ªé‡Œï¼Ÿæ˜¯å‰ç«¯ç¼“å­˜ï¼Œè¿˜æ˜¯åç«¯ç¼“å­˜ï¼Œè¿˜æ˜¯ç›´æ¥æ–‡ä»¶ï¼Ÿç„¶åä¸ºä»€ä¹ˆçœŸæœºæ‰§è¡Œçš„æ—¶å€™ï¼Œä¸¢å¤±äº†ï¼Ÿ

---

## ğŸ“ **æ•°æ®å­˜å‚¨ä½ç½®è¯¦è§£**

### **1ï¸âƒ£ å‰ç«¯å­˜å‚¨ï¼ˆæ ¸å¿ƒæ•°æ®ï¼‰**

#### **A. React Stateï¼ˆå†…å­˜ï¼Œè¿è¡Œæ—¶ï¼‰**
```typescript
// ä½ç½®: src/pages/SmartScriptBuilderPage.tsx
const [steps, setSteps] = useState<ExtendedSmartScriptStep[]>([
  {
    id: "step_1",
    step_type: "smart_tap",
    parameters: {
      xmlSnapshot: {
        xmlContent: "<hierarchy>...</hierarchy>",  // âœ… åŸå§‹XML
        xmlHash: "abc123...",
        timestamp: 1234567890,
        deviceInfo: {...},
        pageInfo: {...}
      },
      elementLocator: {
        elementPath: "//FrameLayout[@resource-id='xxx']/TextView",  // âœ… ç²¾ç¡®XPath
        selectedBounds: {...},
        additionalInfo: {
          xpath: "...",
          resourceId: "xxx",
          text: "æˆ‘",
          contentDesc: "ä¸ªäººä¸­å¿ƒ",
          className: "TextView"
        }
      }
    }
  }
]);
```

**ç‰¹ç‚¹**:
- âœ… å­˜å‚¨: æµè§ˆå™¨å†…å­˜
- âœ… ç”Ÿå‘½å‘¨æœŸ: é¡µé¢åˆ·æ–°åä¸¢å¤±
- âœ… è®¿é—®é€Ÿåº¦: æå¿«
- âœ… ç”¨é€”: è„šæœ¬ç¼–è¾‘ã€å®æ—¶æ“ä½œ

#### **B. localStorageï¼ˆæŒä¹…åŒ–ï¼Œæœ¬åœ°ï¼‰**
```typescript
// ä¿å­˜è„šæœ¬æ—¶
localStorage.setItem('smart_scripts', JSON.stringify({
  id: "script_1",
  name: "è‡ªåŠ¨åŒ–è„šæœ¬1",
  steps: steps  // å®Œæ•´çš„æ­¥éª¤æ•°æ®ï¼ˆå« xmlSnapshot, elementLocatorï¼‰
}));
```

**ç‰¹ç‚¹**:
- âœ… å­˜å‚¨: æµè§ˆå™¨æœ¬åœ°å­˜å‚¨
- âœ… ç”Ÿå‘½å‘¨æœŸ: æŒä¹…åŒ–ï¼ˆé™¤éæ‰‹åŠ¨æ¸…é™¤ï¼‰
- âœ… å¤§å°é™åˆ¶: 5-10MB
- âœ… ç”¨é€”: è„šæœ¬è‰ç¨¿ä¿å­˜ã€è·¨ä¼šè¯æ¢å¤

#### **C. XmlCacheManagerï¼ˆåŒå±‚ç¼“å­˜ï¼‰**
```typescript
// ä½ç½®: src/services/XmlCacheManager.ts
class XmlCacheManager {
  // å†…å­˜ç¼“å­˜ï¼ˆå¿«é€Ÿè®¿é—®ï¼‰
  private memoryCache = new Map<string, XmlSnapshot>();
  
  // IndexedDBï¼ˆæŒä¹…åŒ–ï¼Œå¤§å®¹é‡ï¼‰
  async saveToIndexedDB(xmlHash: string, xmlContent: string) {
    const db = await openDB('xml-cache-db');
    await db.put('xml-snapshots', {
      hash: xmlHash,
      content: xmlContent,
      timestamp: Date.now()
    });
  }
}
```

**ç‰¹ç‚¹**:
- âœ… å†…å­˜å±‚: æå¿«è®¿é—®ï¼Œé¡µé¢åˆ·æ–°åä¸¢å¤±
- âœ… IndexedDBå±‚: æŒä¹…åŒ–ï¼Œå®¹é‡å¤§ï¼ˆå‡ ç™¾MBï¼‰
- âœ… å»é‡ä¼˜åŒ–: ç›¸åŒXMLåªå­˜å‚¨ä¸€æ¬¡ï¼ˆé€šè¿‡hashï¼‰
- âœ… ç”¨é€”: XMLå¿«ç…§ç¼“å­˜ï¼Œé¿å…é‡å¤ä¼ è¾“

---

### **2ï¸âƒ£ åç«¯å­˜å‚¨ï¼ˆæ•°æ®åº“/æ–‡ä»¶ï¼Œå¯é€‰ï¼‰**

#### **A. æ•°æ®åº“ï¼ˆè„šæœ¬åˆ†äº«ï¼‰**
```rust
// å½“ç”¨æˆ·ç‚¹å‡»"ä¿å­˜å¹¶åˆ†äº«"æ—¶
struct SavedScript {
    id: String,
    name: String,
    owner: String,
    steps: Vec<SmartScriptStep>,  // å®Œæ•´æ­¥éª¤æ•°æ®ï¼ˆå« xmlSnapshot, elementLocatorï¼‰
    created_at: DateTime,
}

// ä¿å­˜åˆ°æ•°æ®åº“
db.insert("scripts", saved_script);
```

**ç‰¹ç‚¹**:
- âœ… å­˜å‚¨: åç«¯æ•°æ®åº“ï¼ˆSQLite/PostgreSQL/MySQLï¼‰
- âœ… ç”Ÿå‘½å‘¨æœŸ: æ°¸ä¹…å­˜å‚¨
- âœ… ç”¨é€”: è„šæœ¬åˆ†äº«ç»™å…¶ä»–ç”¨æˆ·ã€å›¢é˜Ÿåä½œ

#### **B. ä¸´æ—¶æ‰§è¡Œç¼“å­˜ï¼ˆæ— æŒä¹…åŒ–ï¼‰**
```rust
// æ‰§è¡Œæ—¶ä»å‰ç«¯æ¥æ”¶
async fn execute_step(step: StepPayload) {
    let original_data = step.parameters.get("original_data");
    // âœ… ä¸´æ—¶ä½¿ç”¨ï¼Œæ‰§è¡Œåé‡Šæ”¾
    // âŒ ä¸ä¿å­˜åˆ°ç£ç›˜æˆ–æ•°æ®åº“
}
```

**ç‰¹ç‚¹**:
- âŒ ä¸æŒä¹…åŒ–å­˜å‚¨
- âœ… æ¯æ¬¡æ‰§è¡Œä»å‰ç«¯æ¥æ”¶
- âœ… æ‰§è¡Œå®Œæˆåé‡Šæ”¾å†…å­˜
- âœ… ç”¨é€”: è¿è¡Œæ—¶å¤±è´¥æ¢å¤

---

### **3ï¸âƒ£ æ–‡ä»¶å­˜å‚¨ï¼ˆå¯¼å…¥/å¯¼å‡ºï¼‰**

#### **è„šæœ¬å¯¼å‡ºï¼ˆJSONæ–‡ä»¶ï¼‰**
```javascript
// å¯¼å‡ºè„šæœ¬åˆ°æ–‡ä»¶
const scriptData = {
  id: "script_1",
  name: "è‡ªåŠ¨åŒ–è„šæœ¬",
  steps: steps  // å®Œæ•´æ•°æ®ï¼ˆå« xmlSnapshot, elementLocatorï¼‰
};

const blob = new Blob([JSON.stringify(scriptData, null, 2)], { type: 'application/json' });
saveAs(blob, 'script_1.json');
```

**ç‰¹ç‚¹**:
- âœ… å­˜å‚¨: æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- âœ… æ ¼å¼: JSON
- âœ… ç”¨é€”: è„šæœ¬å¤‡ä»½ã€è·¨è®¾å¤‡ä¼ è¾“ã€ç‰ˆæœ¬æ§åˆ¶

---

## ğŸ’” **ä¸ºä»€ä¹ˆçœŸæœºæ‰§è¡Œæ—¶ä¸¢å¤±äº†ï¼Ÿ**

### **é—®é¢˜æ ¹å› **:

#### **âŒ ä¿®å¤å‰çš„æ•°æ®æµï¼ˆæœ‰é—®é¢˜ï¼‰**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ä¿å­˜ï¼ˆâœ… æ•°æ®å®Œæ•´ï¼‰                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ step.parameters = {                                          â”‚
â”‚   xmlSnapshot: {                                             â”‚
â”‚     xmlContent: "<å®Œæ•´XML>"  âœ…                              â”‚
â”‚   },                                                         â”‚
â”‚   elementLocator: {                                          â”‚
â”‚     elementPath: "//FrameLayout/TextView"  âœ…               â”‚
â”‚   }                                                          â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯è§„èŒƒåŒ–ï¼ˆâŒ æ•°æ®ä¸¢å¤±ï¼‰                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ buildBackendPayloadStep() {                                  â”‚
â”‚   return {                                                   â”‚
â”‚     parameters: step.parameters  // âŒ ç›´æ¥ä¼ é€’ï¼Œæ²¡æœ‰æå–    â”‚
â”‚   }                                                          â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ é—®é¢˜ï¼šåç«¯æœŸæœ›çš„ original_data ç»“æ„æ²¡æœ‰è¢«æ„é€ ï¼              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯æ¥æ”¶ï¼ˆâŒ æ•°æ®ç¼ºå¤±ï¼‰                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ let selected_xpath = params                                  â”‚
â”‚   .get("original_data")           // âŒ None                 â”‚
â”‚   .and_then(|od| od.get("selected_xpath"));  // âŒ None      â”‚
â”‚                                                              â”‚
â”‚ ç»“æœï¼šåç«¯æ‰¾ä¸åˆ° selected_xpath å’Œ original_xml              â”‚
â”‚       å¤±è´¥æ¢å¤é€»è¾‘æ— æ³•å¯åŠ¨                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **âœ… ä¿®å¤åçš„æ•°æ®æµï¼ˆå®Œæ•´ï¼‰**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ä¿å­˜ï¼ˆâœ… æ•°æ®å®Œæ•´ï¼‰                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ step.parameters = {                                          â”‚
â”‚   xmlSnapshot: {                                             â”‚
â”‚     xmlContent: "<å®Œæ•´XML>"  âœ…                              â”‚
â”‚   },                                                         â”‚
â”‚   elementLocator: {                                          â”‚
â”‚     elementPath: "//FrameLayout/TextView"  âœ…               â”‚
â”‚   }                                                          â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯è§„èŒƒåŒ–ï¼ˆâœ… æ•°æ®æå– + è½¬æ¢ï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ buildBackendPayloadStep() {                                  â”‚
â”‚   const enhancedParams = {                                   â”‚
â”‚     ...baseParams,                                           â”‚
â”‚     original_data: {  // âœ… æ–°æ„é€ çš„ç»“æ„                     â”‚
â”‚       original_xml: baseParams.xmlSnapshot?.xmlContent,      â”‚
â”‚       selected_xpath: baseParams.elementLocator?.elementPath,â”‚
â”‚       analysis_timestamp: baseParams.xmlSnapshot?.timestamp, â”‚
â”‚       element_features: {...}                                â”‚
â”‚     }                                                        â”‚
â”‚   };                                                         â”‚
â”‚   return { parameters: enhancedParams };                     â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯æ¥æ”¶ï¼ˆâœ… æ•°æ®å®Œæ•´ï¼‰                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ let selected_xpath = params                                  â”‚
â”‚   .get("original_data")           // âœ… Some({...})          â”‚
â”‚   .and_then(|od| od.get("selected_xpath"));  // âœ… Some("...")â”‚
â”‚                                                              â”‚
â”‚ let original_xml = params                                    â”‚
â”‚   .get("original_data")                                      â”‚
â”‚   .and_then(|od| od.get("original_xml"));  // âœ… Some("<...>")â”‚
â”‚                                                              â”‚
â”‚ ç»“æœï¼šåç«¯æˆåŠŸæ¥æ”¶ selected_xpath å’Œ original_xml            â”‚
â”‚       å¤±è´¥æ¢å¤é€»è¾‘å¯ä»¥æ­£å¸¸å¯åŠ¨                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **æ•°æ®ä¸¢å¤±çš„ä¸‰ä¸ªå…³é”®ç‚¹**:

#### **1. æ•°æ®ç»“æ„ä¸åŒ¹é…**
```typescript
// å‰ç«¯å­˜å‚¨æ ¼å¼
parameters: {
  elementLocator: {
    elementPath: "//FrameLayout/TextView"  // âœ… è¿™é‡Œæœ‰XPath
  }
}

// åç«¯æœŸæœ›æ ¼å¼
parameters: {
  original_data: {
    selected_xpath: "//FrameLayout/TextView"  // âŒ å‰ç«¯æ²¡ä¼ è¿™ä¸ªå­—æ®µ
  }
}
```

#### **2. ç¼ºå°‘æ•°æ®æ¡¥æ¥å±‚**
```typescript
// âŒ ä¿®å¤å‰ï¼šæ²¡æœ‰æ¡¥æ¥
buildBackendPayloadStep() {
  return { parameters: step.parameters };  // ç›´æ¥ä¼ é€’
}

// âœ… ä¿®å¤åï¼šæœ‰æ¡¥æ¥
buildBackendPayloadStep() {
  const enhancedParams = {
    ...baseParams,
    original_data: {  // ğŸŒ‰ æ¡¥æ¥å±‚ï¼šæå–å¹¶è½¬æ¢
      selected_xpath: baseParams.elementLocator?.elementPath,
      original_xml: baseParams.xmlSnapshot?.xmlContent
    }
  };
  return { parameters: enhancedParams };
}
```

#### **3. è§„èŒƒåŒ–ä¸å®Œæ•´**
```typescript
// âŒ ä¿®å¤å‰ï¼šåªå¤„ç†æ™ºèƒ½åˆ†ææ­¥éª¤
normalizeStepForBackend(step) {
  if (step.enableStrategySelector) {
    // æ„é€  original_data
  }
  // âŒ å…¶ä»–æ­¥éª¤æ²¡æœ‰å¤„ç†
  return step;
}

// âœ… ä¿®å¤åï¼šå¤„ç†æ‰€æœ‰æ­¥éª¤
normalizeStepForBackend(step) {
  if (step.enableStrategySelector) {
    // æ„é€  original_data
  }
  
  // âœ… é€šç”¨æ­¥éª¤ä¹Ÿæ„é€  original_data
  if (step.parameters?.xmlSnapshot || step.parameters?.elementLocator) {
    step.parameters.original_data = {...};
  }
  
  return step;
}
```

---

## ğŸ”§ **ä¿®å¤å†…å®¹æ€»ç»“**

### **ä¿®å¤çš„æ–‡ä»¶**:

| æ–‡ä»¶ | ä¿®å¤å†…å®¹ | å½±å“èŒƒå›´ |
|-----|---------|---------|
| `src/hooks/singleStepTest/utils.ts` | `buildBackendPayloadStep()` å¢å¼º | å•æ­¥æµ‹è¯• |
| `src/pages/SmartScriptBuilderPage/helpers/normalizeSteps.ts` | `normalizeStepForBackend()` å¢å¼º | è„šæœ¬æ‰§è¡Œ |
| `src-tauri/src/exec/v3/chain_engine.rs` | å¤±è´¥æ¢å¤é€»è¾‘ï¼ˆå·²å®Œæˆï¼‰ | åç«¯æ‰§è¡Œ |

### **æ ¸å¿ƒæ”¹è¿›**:

1. **æ•°æ®æå–**: ä» `xmlSnapshot` å’Œ `elementLocator` ä¸­æå–å…³é”®æ•°æ®
2. **æ•°æ®è½¬æ¢**: æ„é€ åç«¯æœŸæœ›çš„ `original_data` ç»“æ„
3. **å¤šé‡å›é€€**: æ”¯æŒå¤šç§æ•°æ®æ¥æºï¼ˆæ–°æ ¼å¼/æ—§æ ¼å¼/å…¼å®¹å­—æ®µï¼‰
4. **å‘åå…¼å®¹**: ä¸ç ´åç°æœ‰åŠŸèƒ½ï¼Œå¹³æ»‘å‡çº§

---

## ğŸ¯ **ç°åœ¨çš„å®Œæ•´é€»è¾‘**

### **1. é™æ€åˆ†æé˜¶æ®µ**
```
ç”¨æˆ·ç‚¹å‡»XMLå¯è§†åŒ–å…ƒç´ 
  â†“
è·å–ç²¾ç¡®XPath
  â†“
ä¿å­˜åˆ° step.parameters.elementLocator.elementPath âœ…
ä¿å­˜åˆ° step.parameters.xmlSnapshot.xmlContent âœ…
  â†“
å­˜å‚¨åˆ° React Stateï¼ˆå†…å­˜ï¼‰ âœ…
```

### **2. è§„èŒƒåŒ–é˜¶æ®µ**
```
å•æ­¥æµ‹è¯•æˆ–è„šæœ¬æ‰§è¡Œ
  â†“
è°ƒç”¨ buildBackendPayloadStep() æˆ– normalizeStepForBackend()
  â†“
æå–æ•°æ®:
  - xmlSnapshot.xmlContent â†’ original_data.original_xml âœ…
  - elementLocator.elementPath â†’ original_data.selected_xpath âœ…
  â†“
æ„é€ å®Œæ•´çš„ original_data ç»“æ„ âœ…
  â†“
å‘é€åˆ°åç«¯ âœ…
```

### **3. çœŸæœºæ‰§è¡Œé˜¶æ®µ**
```
åç«¯æ¥æ”¶ original_data âœ…
  â†“
å°è¯•1: ä½¿ç”¨ selected_xpath å®šä½
  æˆåŠŸ â†’ æ‰§è¡Œ âœ…
  å¤±è´¥ â†“
  â†“
å°è¯•2: ä½¿ç”¨å€™é€‰å€¼åŒ¹é…
  æˆåŠŸ â†’ æ‰§è¡Œ âœ…
  å¤±è´¥ â†“
  â†“
å°è¯•3: å¤±è´¥æ¢å¤ï¼ˆä½¿ç”¨ original_xml + selected_xpathï¼‰
  â€¢ ä» original_xml ä¸­æå–å…ƒç´ ç‰¹å¾ âœ…
  â€¢ åœ¨çœŸæœºXMLä¸­æœç´¢ç›¸ä¼¼å…ƒç´  âœ…
  â€¢ ç›¸ä¼¼åº¦ > 0.7 â†’ æ‰§è¡Œ âœ…
  â€¢ ç›¸ä¼¼åº¦ < 0.7 â†’ è¯¦ç»†è¯Šæ–­æŠ¥å‘Š âŒ
```

---

## ğŸ“‹ **æ•°æ®æµæ£€æŸ¥æ¸…å•**

### **å‰ç«¯æ£€æŸ¥**:
- [x] âœ… `xmlSnapshot.xmlContent` æœ‰å€¼
- [x] âœ… `elementLocator.elementPath` æœ‰å€¼
- [x] âœ… `buildBackendPayloadStep()` æ„é€  `original_data`
- [x] âœ… `normalizeStepForBackend()` æ„é€  `original_data`
- [x] âœ… `original_data.original_xml` æœ‰å€¼
- [x] âœ… `original_data.selected_xpath` æœ‰å€¼

### **åç«¯æ£€æŸ¥**:
- [x] âœ… `params.get("original_data")` è¿”å› `Some(...)`
- [x] âœ… `original_data.get("selected_xpath")` è¿”å› `Some(...)`
- [x] âœ… `original_data.get("original_xml")` è¿”å› `Some(...)`
- [x] âœ… å¤±è´¥æ¢å¤é€»è¾‘å¯ä»¥å¯åŠ¨
- [x] âœ… ç›¸ä¼¼åº¦åŒ¹é…ç®—æ³•æ­£å¸¸å·¥ä½œ

---

## ğŸ‰ **ç»“è®º**

### **é—®é¢˜å›ç­”**:

1. **æ•°æ®ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ**
   - âœ… **å‰ç«¯å†…å­˜**: React Stateï¼ˆè¿è¡Œæ—¶ï¼‰
   - âœ… **å‰ç«¯æŒä¹…åŒ–**: localStorageï¼ˆè‰ç¨¿ï¼‰ã€IndexedDBï¼ˆXMLç¼“å­˜ï¼‰
   - âœ… **åç«¯æ•°æ®åº“**: è„šæœ¬åˆ†äº«æ—¶ï¼ˆå¯é€‰ï¼‰
   - âœ… **æœ¬åœ°æ–‡ä»¶**: å¯¼å‡ºè„šæœ¬æ—¶ï¼ˆJSONï¼‰

2. **ä¸ºä»€ä¹ˆçœŸæœºæ‰§è¡Œæ—¶ä¸¢å¤±äº†ï¼Ÿ**
   - âŒ **ä¿®å¤å‰**: å‰ç«¯è§„èŒƒåŒ–æ—¶æ²¡æœ‰æ„é€  `original_data` ç»“æ„
   - âŒ **æ•°æ®ç»“æ„ä¸åŒ¹é…**: å‰ç«¯ `elementLocator.elementPath` vs åç«¯ `original_data.selected_xpath`
   - âŒ **ç¼ºå°‘æ¡¥æ¥å±‚**: æ²¡æœ‰æ•°æ®æå–å’Œè½¬æ¢é€»è¾‘
   - âœ… **ä¿®å¤å**: å·²å®Œå…¨è§£å†³

3. **ç°åœ¨çš„å®ç°æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ**
   - âœ… **å·²å®Œå…¨ä¿®å¤**ï¼
   - âœ… å‰ç«¯æ­£ç¡®ä¼ é€’ `original_data`
   - âœ… åç«¯æ­£ç¡®æ¥æ”¶å¹¶å¯åŠ¨å¤±è´¥æ¢å¤
   - âœ… æ”¯æŒå¤šç§æ•°æ®æ¥æºå’Œå‘åå…¼å®¹

### **ç³»ç»Ÿç°åœ¨çš„èƒ½åŠ›**:
- âœ… å®Œæ•´çš„æ•°æ®æµï¼ˆå‰ç«¯ â†’ åç«¯ï¼‰
- âœ… ä¸‰å±‚å¤±è´¥æ¢å¤ï¼ˆç²¾ç¡®XPath â†’ å€™é€‰å€¼ â†’ ç›¸ä¼¼åº¦åŒ¹é…ï¼‰
- âœ… UIå°å¹…å˜åŒ–æ—¶è‡ªåŠ¨é€‚åº”
- âœ… UIå¤§å¹…å˜åŒ–æ—¶è¯¦ç»†è¯Šæ–­
- âœ… å‘åå…¼å®¹æ—§æ ¼å¼æ•°æ®

**XPathå¤±è´¥æ¢å¤ç³»ç»Ÿå·²ç»å®Œå…¨ä¿®å¤å¹¶å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼** ğŸš€

