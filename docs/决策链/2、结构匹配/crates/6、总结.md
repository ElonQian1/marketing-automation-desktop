# 我们这套「结构匹配」的功能需求（无代码版）

## 1) 目标（做成什么）

* **稳定找回“同类卡片”**：在动态页面、换皮肤/AB 测试、不同机型下，可靠识别同一类内容卡片（尤其瀑布流/网格/列表）。
* **既能“找全”，也能“选一个执行”**：支持列出全部匹配卡片，或按策略选中目标卡片用于后续动作（tap 等）。
* **可解释、可调参、可降级**：匹配有分数与原因，阈值和权重可调；找不到时能优雅降级而不是“卡死”。

---

## 2) 输入与输出

**输入（一次 dump / 当前屏幕）**

* 页面 UI XML（包含每个节点的 bounds/class/text/属性）。
* 可选的**容器提示**（StepCard：container_xpath 或容器指纹）。
* 匹配规则/偏好：允许的布局类型、骨架规则、文本/字段约束、权重、早停策略、模式（Speed/Default/Robust）。
* 任务意图：**找全**或**只取一个**（first/last/random/precise）。

**输出**

* 命中的**容器**（若有）：id、bounds、识别到的布局类型。
* 命中的**卡片列表**：每个卡片的 bounds、综合分、分项分（几何/模板/骨架/字段）、剔除或通过的原因。
  -（可选）可视化诊断信息：列分布、模板命中高亮等。

---

## 3) 核心流程（一次 dump，含早停）

1. **容器限域**

   * 先定位装卡片的“列表/瀑布大容器”。找不到时按策略放宽（相似容器→全局）。
2. **几何（布局分类器）**

   * 依据位置与大小判断版式：多列瀑布 / 单列瀑布 / 网格 / 列表 / 走马灯 / Unknown。
   * 产出几何分 `S_geom`（Unknown 给中性分）。
   * *早停*：若配置已指定版式，可跳过此步。
3. **模板签名（重复性）**

   * 在容器内对若干卡片采样，提取分桶特征并形成指纹；统计 Top-K 高频模板。
   * 候选卡片与模板比对得 `S_tpl`。
   * *早停*：若仅“选一个”，可跳过以提速；若“找全”建议开启。
4. **骨架校验（结构规则）**

   * “必须有图片/文字”“图在上文在下”“深度/数量弹性±1”等，得 `S_struct`。
5. **字段/文本精调**

   * 空/非空一致、完全匹配、相似匹配；**支持“子元素文本必须=某值”**（可设为**硬约束**），得 `S_field`。
6. **合成评分 + 闸门 + 选择**

   * `S_total = w_geom*S_geom + w_tpl*S_tpl + w_struct*S_struct + w_field*S_field`。
   * 闸门：`唯一性==1 或 top-gap≥0.15；min_conf≥0.70`。
   * **找全**：保留所有过阈值项；**执行**：按策略（first/last/random/precise）选择 1 个。

---

## 4) 支持的布局类型（几何层）

* **WaterfallMulti**（多列瀑布）：列≥2、列宽近似、同列高度方差大。
* **MasonrySingle**（单列瀑布/变高列表）：列=1、宽≈容器宽、高度差大。
* **UniformGrid**（等高网格）：列≥2、行对齐、同列高度差小。
* **List**（单列信息流）：列=1、宽≈容器宽、高度差小/中。
* **Carousel**（走马灯/横滑）：横向滚动、y 带窄、x 等间距/吸附。
* **Unknown**：判断不清时给中性分，交由模板/骨架/字段主导结果。

---

## 5) 可配置项（由 StepCard/配置面板驱动）

* **容器定位**：container_xpath / 指纹 / 找不到时自动放宽。
* **允许的布局**：Auto 或指定类型（可多选）。
* **骨架规则**：是否必须“图上文下”、允许的层级弹性、必须包含哪些子类。
* **字段/文本**：哪些字段参与；哪些是“必须等于”；空/非空一致；相似匹配策略。
* **权重**：`w_geom / w_tpl / w_struct / w_field`；或切换模式（Speed/Default/Robust）。
* **早停策略**：

  * 跳过几何（已知版式）
  * 只取一个时跳过模板
  * 只跑骨架（极速/稳定场景）
* **阈值**：min_conf（默认 0.70）、top-gap（默认 0.15）。

---

## 6) 性能与鲁棒性要求

* **延迟预算**：一次 dump 内部处理尽量控制在几十毫秒级（采样+缓存+早停）。
* **缓存**：按 `xml_hash + container_id` 缓存模板与几何统计；滚动/小改动快速复用。
* **鲁棒性**：

  * 版式变化（AB/换皮肤）→ 模板签名和几何兜底；
  * 结构细抖动（深度/子数±1）→ 骨架弹性；
  * 文案变化 → 非关键字段降权，关键文本可设“必须等于”。
* **降级路径**：容器→相似容器→全局；模板不足→跳过模板；布局 Unknown→中性分。

---

## 7) 结果可解释与调试可视

* **分项分数**：对每个候选展示 `S_geom / S_tpl / S_struct / S_field / S_total`。
* **诊断信息**：

  * 几何：列数、宽度比例桶、高度方差（CV）、是否命中瀑布/网格等。
  * 模板：模板 hash、支持度、相似阈值（τ）、是否命中。
  * 骨架/字段：满足/不满足的具体规则与文案对比。
* **可视化（可选）**：列线 overlay、命中卡片高亮、剔除原因提示。

---

## 8) 使用场景

* **瀑布流“找全”**：提取屏内所有同类卡片（用于批操作/数据采集）。
* **点选执行**：根据 StepCard 的“first/last/random/precise”选择策略执行单卡动作。
* **弱约束检索**：只要求“同类外观”，不限定具体文本；
* **强约束命中**：指定“子元素文本必须=某值”，在同类集合中精准筛选。

---

## 9) 非功能性/治理

* **模块边界清晰**：独立“结构匹配”子系统（不与其他 engine 撞名），对外只暴露一个运行入口。
* **可移植**：纯算法内核不依赖特定平台；前后端通过命令/DTO 解耦。
* **可扩展**：可新增布局类型、签名特征、骨架 DSL 规则，而不影响现有接口。
* **可测试**：几何门/模板/骨架/字段/闸门各自可单测；端到端可用真实或模拟 XML。

---

### 一句话总括

> **容器限域 → 布局分类（几何）→ 模板签名（重复性）→ 骨架（硬规则）→ 字段/文本（精调）→ 评分合成 + 闸门 + 选择**
> 这套功能在“找全/选一”的两种任务下都稳、快、可解释，并能通过权重与早停灵活取舍性能与鲁棒性。
