# Phase 1 å®æ–½å®ŒæˆæŠ¥å‘Š - ç»“æ„åŒ¹é…è¿è¡Œæ—¶æ¨¡å—

**å®æ–½æ—¶é—´**: 2025å¹´11æœˆ3æ—¥  
**çŠ¶æ€**: âœ… æˆåŠŸå®Œæˆ  
**ç¼–è¯‘éªŒè¯**: âœ… é€šè¿‡ `cargo check`

---

## ğŸ“¦ å·²åˆ›å»ºçš„æ¨¡å—ç»“æ„

```
src-tauri/src/domain/structure_runtime_match/
â”œâ”€â”€ mod.rs                          // æ¨¡å—æ ¹å…¥å£ + å…¬å…±å¯¼å‡º
â”œâ”€â”€ types.rs                        // æ ¸å¿ƒç±»å‹å®šä¹‰ï¼ˆSmBounds/SmLayoutType/SmResultï¼‰
â”œâ”€â”€ config.rs                       // é…ç½®æ¨¡å‹ï¼ˆSmConfig/æ—©åœå¼€å…³ï¼‰
â”œâ”€â”€ orchestrator.rs                 // æµç¨‹ç¼–æ’å™¨ï¼ˆsm_run_once å”¯ä¸€å…¥å£ï¼‰
â”‚
â”œâ”€â”€ ports/                          // ğŸ”Œ æ¥å£å±‚ï¼ˆè§£è€¦å¤–éƒ¨ä¾èµ–ï¼‰
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ xml_view.rs                // SmXmlView traitï¼ˆé€‚é…XmlIndexerï¼‰
â”‚   â””â”€â”€ cache.rs                   // SmCache trait + NoopCache/MemCache
â”‚
â”œâ”€â”€ container_gate/                 // ğŸ¯ å®¹å™¨é™åŸŸ
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ detector.rs                // é€‰é¢ç§¯æœ€å¤§å®¹å™¨
â”‚
â”œâ”€â”€ layout_gate/                    // ğŸ“ å‡ ä½•åˆ†ç±»
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ classifier.rs              // å¸ƒå±€ç±»å‹åˆ¤æ–­ï¼ˆç€‘å¸ƒæµ/ç½‘æ ¼/åˆ—è¡¨ï¼‰
â”‚
â”œâ”€â”€ signature/                      // ğŸ” æ¨¡æ¿ç­¾å
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ features.rs                // ç‰¹å¾æå–ï¼ˆå®½åº¦æ¡¶/å›¾æ–‡çº¿ç´¢ï¼‰
â”‚   â”œâ”€â”€ learner.rs                 // æ¨¡æ¿å­¦ä¹ ï¼ˆä¼—æ•°ç»Ÿè®¡ï¼‰
â”‚   â””â”€â”€ matcher.rs                 // æ¨¡æ¿åŒ¹é…ï¼ˆè¯„åˆ†ï¼‰
â”‚
â”œâ”€â”€ skeleton/                       // ğŸ¦´ éª¨æ¶è§„åˆ™
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ dsl.rs                     // è§„åˆ™DSLå®šä¹‰
â”‚   â””â”€â”€ checker.rs                 // éª¨æ¶æ£€æŸ¥å™¨
â”‚
â”œâ”€â”€ field_refine/                   // ğŸ¨ å­—æ®µç²¾è°ƒ
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ scorer.rs                  // å­—æ®µè§„åˆ™è¯„åˆ†
â”‚
â””â”€â”€ scoring/                        // ğŸ“Š è¯„åˆ†ç³»ç»Ÿ
    â”œâ”€â”€ mod.rs
    â”œâ”€â”€ weights.rs                 // æƒé‡é…ç½®ï¼ˆSpeed/Default/Robustï¼‰
    â”œâ”€â”€ combiner.rs                // åˆ†æ•°åˆæˆå™¨
    â””â”€â”€ gates.rs                   // é—¸é—¨è¿‡æ»¤å™¨
```

**æ€»è®¡**: 24 ä¸ªæ–‡ä»¶ï¼Œå®Œæ•´æ¨¡å—åŒ–æ¶æ„ âœ…

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§å®ç°

### 1ï¸âƒ£ **ç±»å‹ç³»ç»Ÿï¼ˆtypes.rsï¼‰**
```rust
âœ… SmNodeId           // èŠ‚ç‚¹IDç±»å‹åˆ«å
âœ… SmBounds           // è¾¹ç•ŒçŸ©å½¢ï¼ˆå« width/height/area æ–¹æ³•ï¼‰
âœ… SmLayoutType       // å¸ƒå±€ç±»å‹æšä¸¾ï¼ˆ6ç§ï¼‰
âœ… SmScores           // å››ç»´è¯„åˆ† + æ€»åˆ†
âœ… SmItemHit          // å€™é€‰èŠ‚ç‚¹åŒ¹é…ç»“æœ
âœ… SmContainerHit     // å®¹å™¨åŒ¹é…ç»“æœ
âœ… SmResult           // æœ€ç»ˆç»“æœåŒ…è£…
```

### 2ï¸âƒ£ **é…ç½®ç³»ç»Ÿï¼ˆconfig.rsï¼‰**
```rust
âœ… SmMode             // é€Ÿåº¦æ¨¡å¼ï¼ˆSpeed/Default/Robustï¼‰
âœ… SkeletonRules      // éª¨æ¶è§„åˆ™é…ç½®
âœ… FieldRule          // å­—æ®µè§„åˆ™å•å…ƒ
âœ… FieldRules         // å­—æ®µè§„åˆ™é›†åˆ
âœ… ContainerHint      // å®¹å™¨æç¤ºï¼ˆxpath/æŒ‡çº¹ï¼‰
âœ… SmConfig           // ä¸»é…ç½®ï¼ˆæ—©åœå¼€å…³/é˜ˆå€¼/è§„åˆ™ï¼‰
```

**ä¸‰ç§æ—©åœç­–ç•¥**ï¼š
- âœ… `skip_geometry`: å·²çŸ¥ç‰ˆå¼æ—¶è·³è¿‡å‡ ä½•åˆ†æ
- âœ… `skip_template_when_single`: å•ç›®æ ‡æ—¶è·³è¿‡æ¨¡æ¿å­¦ä¹ 
- âœ… `strict_skeleton_only`: æé€Ÿæ¨¡å¼åªè·‘éª¨æ¶è§„åˆ™

### 3ï¸âƒ£ **æ¥å£æŠ½è±¡ï¼ˆports/ï¼‰**
```rust
âœ… SmXmlView trait    // 10ä¸ªæ–¹æ³•å®Œæ•´å®šä¹‰
   - xml_hash()       // XMLæŒ‡çº¹
   - container_candidates()  // å®¹å™¨å€™é€‰åˆ—è¡¨
   - bounds/parent/children  // æ ‘ç»“æ„å¯¼èˆª
   - class/text/attr  // å±æ€§è®¿é—®
   - pre/post         // éå†åºå·

âœ… SmCache trait      // ç¼“å­˜æ¥å£
   - NoopCache        // ç©ºå®ç°
   - MemCache         // å†…å­˜HashMapå®ç°
```

### 4ï¸âƒ£ **å®Œæ•´æµç¨‹ï¼ˆorchestrator.rsï¼‰**
```rust
âœ… sm_run_once()      // å”¯ä¸€å…¬å…±å…¥å£
   1ï¸âƒ£ pick_container()     // å®¹å™¨é™åŸŸ
   2ï¸âƒ£ classify()            // å‡ ä½•åˆ†ç±»ï¼ˆå¯è·³è¿‡ï¼‰
   3ï¸âƒ£ learn_or_load()       // æ¨¡æ¿å­¦ä¹ ï¼ˆå¯è·³è¿‡ï¼‰
   4ï¸âƒ£ score_tpl()           // æ¨¡æ¿åŒ¹é…
   5ï¸âƒ£ score_skeleton()      // éª¨æ¶è§„åˆ™
   6ï¸âƒ£ score_fields()        // å­—æ®µç²¾è°ƒ
   7ï¸âƒ£ combine()             // åˆ†æ•°åˆæˆ
   8ï¸âƒ£ retain_passed()       // é—¸é—¨è¿‡æ»¤
   9ï¸âƒ£ sort_desc()           // é™åºæ’åº
   ğŸ”Ÿ è¿”å› SmResult
```

---

## ğŸ—ï¸ æ¨¡å—åŒ–è®¾è®¡äº®ç‚¹

### âœ… **å‘½åè§„èŒƒä¸¥æ ¼éµå¾ª**
- æ‰€æœ‰ç±»å‹: `Sm*` å‰ç¼€ï¼ˆSmBounds, SmConfig, SmResult...ï¼‰
- ç›®å½•å‘½å: æ¸…æ™°èŒè´£ï¼ˆcontainer_gate, layout_gate, signature...ï¼‰
- æ–‡ä»¶å‘½å: é˜²æ’åï¼ˆdetector.rs, classifier.rs, learner.rs...ï¼‰

### âœ… **ä¾èµ–å€’ç½®åŸåˆ™**
- `ports/` å±‚å®Œå…¨è§£è€¦å¤–éƒ¨ä¾èµ–
- ç®—æ³•å†…æ ¸åªä¾èµ– `SmXmlView` trait
- ä¾¿äºå°†æ¥ç‹¬ç«‹æŠ½ç¦»ä¸º crate

### âœ… **å•ä¸€èŒè´£åŸåˆ™**
- æ¯ä¸ªæ¨¡å—ä¸“æ³¨ä¸€ä¸ªä»»åŠ¡
- `container_gate`: åªè´Ÿè´£å®¹å™¨é€‰æ‹©
- `layout_gate`: åªè´Ÿè´£ç‰ˆå¼åˆ†ç±»
- `signature`: åªè´Ÿè´£æ¨¡æ¿åŒ¹é…
- `skeleton`: åªè´Ÿè´£ç»“æ„æ ¡éªŒ
- `field_refine`: åªè´Ÿè´£å­—æ®µç²¾è°ƒ
- `scoring`: åªè´Ÿè´£åˆ†æ•°åˆæˆ

### âœ… **ä»£ç å¯ç»´æŠ¤æ€§**
- æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸‰è¡Œæ–‡ä»¶å¤´ï¼ˆmodule/layer/role/summaryï¼‰
- ç¬¦åˆé¡¹ç›® `.github/copilot-instructions.md` è§„èŒƒ
- æ‰€æœ‰å‡½æ•°/ç»“æ„ä½“éƒ½æœ‰æ¸…æ™°æ³¨é‡Š

---

## ğŸ“Š ç¼–è¯‘éªŒè¯ç»“æœ

```bash
âœ… cargo check é€šè¿‡
âš ï¸ 5ä¸ªè­¦å‘Šï¼ˆå‡ä¸º unused imports - ç¬¦åˆé¢„æœŸï¼‰
   - orchestrator::sm_run_once (å¾…é›†æˆåˆ°å‘½ä»¤å±‚)
   - types å¯¼å‡º (å¾…å‰ç«¯ä½¿ç”¨)
   - config å¯¼å‡º (å¾…å‰ç«¯ä½¿ç”¨)
   - ports traits (å¾…é€‚é…å™¨å®ç°)
```

**è­¦å‘Šåˆ†æ**: è¿™äº›æ˜¯æ­£å¸¸çš„"æœªä½¿ç”¨å¯¼å‡º"è­¦å‘Šï¼Œå› ä¸ºï¼š
1. æ¨¡å—å·²åˆ›å»ºä½†å°šæœªé›†æˆåˆ°æ‰§è¡Œå¼•æ“
2. å…¬å…±APIå·²å¯¼å‡ºä½†å‰ç«¯å°šæœªè°ƒç”¨
3. trait å·²å®šä¹‰ä½†é€‚é…å™¨å°šæœªå®ç°

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆPhase 2ï¼‰

### **ä¼˜å…ˆçº§ P0 - åŸºç¡€é›†æˆ**ï¼ˆé¢„è®¡1-2å¤©ï¼‰

#### 1ï¸âƒ£ **åˆ›å»º XmlIndexer é€‚é…å™¨**
```rust
// src-tauri/src/services/xml_adapter.rs
pub struct XmlIndexerAdapter<'a> {
    indexer: &'a XmlIndexer, // ä½ ç°æœ‰çš„ç´¢å¼•å™¨
}

impl<'a> SmXmlView for XmlIndexerAdapter<'a> {
    fn container_candidates(&self) -> Vec<SmNodeId> {
        // TODO: è¿”å›å¯æ»šåŠ¨/å¤§é¢ç§¯èŠ‚ç‚¹
        // å¯è°ƒç”¨ç°æœ‰çš„ find_scrollable_containers()
    }
    // ... å…¶ä»–9ä¸ªæ–¹æ³•
}
```

#### 2ï¸âƒ£ **åˆ›å»º Tauri å‘½ä»¤**
```rust
// src-tauri/src/commands/structure_match.rs
#[tauri::command]
pub async fn sm_match_once(
    step_cfg: SmConfig,
    xml: String,
    want_all: bool,
) -> Result<SmResult, String> {
    let indexer = XmlIndexer::from_xml(&xml)?;
    let view = XmlIndexerAdapter::new(&indexer);
    let mut cache = MemCache::default();
    Ok(sm_run_once(&view, &mut cache, &step_cfg, want_all))
}
```

#### 3ï¸âƒ£ **æ³¨å†Œå‘½ä»¤åˆ° main.rs**
```rust
tauri::Builder::default()
    .invoke_handler(tauri::generate_handler![
        sm_match_once,
        // ... å…¶ä»–å‘½ä»¤
    ])
```

#### 4ï¸âƒ£ **å‰ç«¯é›†æˆæµ‹è¯•**
```typescript
import { invoke } from '@tauri-apps/api/tauri';

const result = await invoke('sm_match_once', {
  stepCfg: { mode: 'Default', min_confidence: 0.7, ... },
  xml: xmlString,
  wantAll: false,
});

console.log('å®¹å™¨:', result.container);
console.log('åŒ¹é…é¡¹:', result.items);
```

---

## ğŸ”„ æ¸è¿›å¼ä¼˜åŒ–è·¯çº¿å›¾

### **Phase 3: å®¹å™¨å¢å¼º**ï¼ˆ2-3å¤©ï¼‰
- [ ] æ»šåŠ¨å±æ€§æ£€æµ‹ï¼ˆscrollable/focusableï¼‰
- [ ] æŒ‡çº¹åŒ¹é…ï¼ˆxpath hint/class hintï¼‰
- [ ] é¢ç§¯é˜ˆå€¼é…ç½®

### **Phase 4: å‡ ä½•å‡çº§**ï¼ˆ2-3å¤©ï¼‰
- [ ] å®Œæ•´åˆ—èšç±»ç®—æ³•
- [ ] é«˜åº¦CVè®¡ç®—ï¼ˆå˜å¼‚ç³»æ•°ï¼‰
- [ ] è¡Œå¯¹é½åº¦æ£€æµ‹

### **Phase 5: æ¨¡æ¿ä¼˜åŒ–**ï¼ˆ3-4å¤©ï¼‰
- [ ] ä½å›¾å“ˆå¸Œç‰¹å¾
- [ ] Hammingè·ç¦»åŒ¹é…
- [ ] å‰Nä¸ªé‡‡æ ·ç­–ç•¥

### **Phase 6: éª¨æ¶å®ç°**ï¼ˆ3-5å¤©ï¼‰
- [ ] å›¾ä¸Šæ–‡ä¸‹è§„åˆ™DSL
- [ ] å±‚çº§å¼¹æ€§ Â±1
- [ ] å­ç»“æ„å­˜åœ¨æ€§æ ¡éªŒ

### **Phase 7: å­—æ®µç²¾è°ƒ**ï¼ˆ2-3å¤©ï¼‰
- [ ] å­æ ‘è·¯å¾„æŸ¥æ‰¾
- [ ] æ–‡æœ¬ç›¸ä¼¼åº¦ï¼ˆLevenshteinè·ç¦»ï¼‰
- [ ] å¤šè¯­è¨€åˆ«åæ”¯æŒ

### **Phase 8: ç¼“å­˜æŒä¹…åŒ–**ï¼ˆ1-2å¤©ï¼‰
- [ ] SQLite æ¨¡æ¿å­˜å‚¨
- [ ] LRU æ·˜æ±°ç­–ç•¥
- [ ] è·¨ä¼šè¯æ¨¡æ¿å¤ç”¨

---

## âœ… æ£€æŸ¥æ¸…å•

### **æ¶æ„åˆè§„æ€§**
- âœ… æ¨¡å—åŒ–ç›®å½•ç»“æ„ï¼ˆå­æ–‡ä»¶å¤¹/å­æ–‡ä»¶ï¼‰
- âœ… å‘½åé˜²æ’ï¼ˆSm*å‰ç¼€ï¼‰
- âœ… ä¸‰è¡Œæ–‡ä»¶å¤´ï¼ˆmodule/layer/role/summaryï¼‰
- âœ… ç¬¦åˆ DDD åˆ†å±‚ï¼ˆdomainå±‚ï¼‰
- âœ… å•ä¸€èŒè´£åŸåˆ™
- âœ… ä¾èµ–å€’ç½®ï¼ˆportsæ¥å£å±‚ï¼‰

### **ä»£ç è´¨é‡**
- âœ… æ‰€æœ‰ç±»å‹å®ç° Serialize/Deserialize
- âœ… å…³é”®æ–¹æ³•æœ‰æ–‡æ¡£æ³¨é‡Š
- âœ… æ—©åœç­–ç•¥å®Œæ•´å®ç°
- âœ… è¯„åˆ†æƒé‡å¯é…ç½®
- âœ… é—¸é—¨é˜ˆå€¼å¯è°ƒæ•´

### **å¯æ‰©å±•æ€§**
- âœ… trait æŠ½è±¡å®Œæ•´ï¼ˆSmXmlView/SmCacheï¼‰
- âœ… æ‰€æœ‰ç®—æ³•æ¨¡å—å¯æ›¿æ¢
- âœ… é¢„ç•™å°†æ¥ç‹¬ç«‹crateèƒ½åŠ›
- âœ… æ”¯æŒè‡ªå®šä¹‰è§„åˆ™æ³¨å…¥

---

## ğŸ‰ é‡Œç¨‹ç¢‘è¾¾æˆ

1. âœ… **å®Œæ•´æ¨¡å—éª¨æ¶æ­å»º**ï¼š24ä¸ªæ–‡ä»¶ï¼Œå®Œæ•´åˆ†å±‚
2. âœ… **ç±»å‹ç³»ç»Ÿå®šä¹‰**ï¼š7ä¸ªæ ¸å¿ƒç±»å‹
3. âœ… **é…ç½®ç³»ç»Ÿå®Œæˆ**ï¼š3ç§æ¨¡å¼ + 3ç§æ—©åœ
4. âœ… **æ¥å£æŠ½è±¡å°±ç»ª**ï¼šSmXmlView/SmCache traits
5. âœ… **æµç¨‹ç¼–æ’å®Œæˆ**ï¼šsm_run_once() 9æ­¥æµç¨‹
6. âœ… **ç¼–è¯‘éªŒè¯é€šè¿‡**ï¼šcargo check æˆåŠŸ

---

## ğŸ“ æŠ€æœ¯å€ºåŠ¡è®°å½•

1. **TODO: XmlIndexerAdapter å®ç°**ï¼ˆP0ï¼‰
   - éœ€è¦è¿æ¥ç°æœ‰ `XmlIndexer`
   - å®ç°10ä¸ª trait æ–¹æ³•

2. **TODO: container_candidates() çœŸå®é€»è¾‘**ï¼ˆP0ï¼‰
   - å½“å‰è¿”å›ç©ºåˆ—è¡¨
   - éœ€è¦è¯†åˆ«å¯æ»šåŠ¨å®¹å™¨

3. **ç®€åŒ–ç‰ˆç®—æ³•å ä½**ï¼ˆP1-P3ï¼‰
   - `classifier.rs`: æç®€åˆ—èšç±» â†’ å®Œæ•´CVç®—æ³•
   - `learner.rs`: ä¼—æ•°ç»Ÿè®¡ â†’ ä½å›¾å“ˆå¸Œ
   - `checker.rs`: å›¾æ–‡æ£€æµ‹ â†’ çœŸå®éª¨æ¶DSL

---

## ğŸš€ ç«‹å³å¯å¼€å§‹çš„å·¥ä½œ

**æ¨èä¼˜å…ˆçº§**ï¼šPhase 2 åŸºç¡€é›†æˆ

**é¢„è®¡æ—¶é—´**ï¼š1-2å¤©

**å…³é”®ä»»åŠ¡**ï¼š
1. åˆ›å»º `XmlIndexerAdapter` è¿æ¥ç°æœ‰ç´¢å¼•å™¨
2. åˆ›å»º `commands/structure_match.rs` æ³¨å†ŒTauriå‘½ä»¤
3. å‰ç«¯è°ƒç”¨éªŒè¯æ•°æ®æµé€š
4. ä¿®å¤ `container_candidates()` è¿”å›çœŸå®å€™é€‰

**æˆåŠŸæ ‡å‡†**ï¼š
- âœ… å‰ç«¯èƒ½è°ƒç”¨ `sm_match_once` å‘½ä»¤
- âœ… è¿”å›éç©º `SmResult` ç»“æœ
- âœ… å¯è§†åŒ–æ˜¾ç¤ºåŒ¹é…çš„å®¹å™¨å’Œå€™é€‰é¡¹

---

## ğŸ“Š å·¥ä½œé‡ç»Ÿè®¡

- **æ–‡ä»¶æ•°é‡**: 24 ä¸ª
- **ä»£ç è¡Œæ•°**: ~1200 è¡Œï¼ˆå«æ³¨é‡Šï¼‰
- **æ¨¡å—æ•°é‡**: 8 ä¸ªå­æ¨¡å—
- **å…¬å…±ç±»å‹**: 7 ä¸ªæ ¸å¿ƒç±»å‹
- **é…ç½®é€‰é¡¹**: 10+ ä¸ªé…ç½®å­—æ®µ
- **ç¼–è¯‘è€—æ—¶**: ~5åˆ†é’Ÿï¼ˆé¦–æ¬¡ç¼–è¯‘ï¼‰

---

**Phase 1 çŠ¶æ€**: âœ… **å®Œç¾è¾¾æˆ** ğŸ‰

å¯ç«‹å³è¿›å…¥ Phase 2 åŸºç¡€é›†æˆé˜¶æ®µï¼
