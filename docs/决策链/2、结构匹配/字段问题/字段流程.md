我是点击 页面分析 按钮， 在可视化分析 点选我要的元素， 然后生成步骤卡片我是点击 页面分析 按钮， 在可视化分析 点选我要的元素， 然后生成步骤卡片


我是在 步骤卡片的 “静态策略”--“结构匹配”  打开“结构匹配”模态框，然后就默认配置 直接点击确定， 点击确定后，生成对应参数给后端使用， 然后测试我的 步骤卡片。

所以生成骨架 相关信息， 应该是  “结构匹配”这个模态框操作的事。 而不是生成步骤卡片的事，  因为步骤卡片 不一定采用 “结构匹配”
如果要跑  “结构匹配” 就要选择这个选项，然后保存参数到卡片内部

我  “结构匹配” 模态框读取出我所点选元素的 树dom元素，默认配置是整个树各个元素的字段是 空则匹配空， 非空则匹配非空的 原则，保存参数。
因为这才是最满足结构匹配的方式。匹配法则
脚本也适合随时打包发布给其他人使用。

你的流程是对的：**骨架/结构参数的生成与保存，应该发生在“结构匹配”模态框里**；StepCard 只是“是否采用结构匹配”的载体。下面给你一份“前端该怎么做”的落地指南（不破坏你现有字段打分，默认就走“空/非空”规则），点开模态框→一键保存→写入卡片内部就能跑，也便于随时打包发布。

---

## 一、交互流程（你已有的操作上补齐细节）

1. **页面分析** → 选中元素（卡片中任意子节点也行）。
2. 打开 **“结构匹配”模态框**（位于 StepCard 的“静态策略”里）。
3. 模态框**自动学习**并生成一份“结构快照（snapshot）”，界面展示：

   * 容器锚、卡片根、可点父路径
   * 骨架规则（图上文下等）
   * 字段规则（按你“空/非空即规则”自动生成）
   * （默认关闭）几何/模板签名两个开关
   * 完整性评分（Completeness Score）+ 预览命中数
4. 你可**直接用默认配置点“确定”** → 将快照**写入当前 StepCard 内部**。
5. 点击“测试匹配”，把卡片里的快照传给后端 `sm_match_once` → Overlay 显示分项分。
6. 需要发布时，StepCard 天然自包含这份快照，**不依赖外部引用**，随时可打包给别人用。

---

## 二、模态框里“自动学习”的默认策略（开箱即用）

> 目标：不打断你现有“空/非空计分”，但又比“Frame+index=0”更稳。

* **容器锚（必填）**
  自动找**最大可滚容器**；若你已有容器 bounds/xpath，优先使用；存 `container_xpath | fingerprint(scrollable/role/bounds_hint)`。

* **卡片根 & 可转换性（必填）**
  从你点选的节点**上溯**到“最小可点父”（常见是卡片根）；保存 `card_root.class/role` + `clickable_parent_path:"↑1"`。

* **骨架规则（默认启用）**
  生成 “**图在上、文在下**”/“必须有图/文”/“层级弹性±1” 这类**宽松硬规则**；这层对版式/皮肤不敏感。

* **字段规则（默认启用、符合你的“空/非空”哲学）**
  扫描卡片子树：

  * 原来 **有文本** → `presence_only=true`（存在即得分，不逼等于）
  * 原来 **为空** → 记录 `must_be_empty=true`（或 presence=false）
  * 只有当你在 UI 明确勾“必须等于某值”时，才写 `must_equal_text="..."`
    这样**完全兼容你现有字段权重**与细粒度。

* **几何（默认关闭）**
  仅作为**加分**（列宽/高度方差推断瀑布/网格/列表）；默认 `use_geometry=false` → 权重=0，不影响旧逻辑。

* **模板签名（默认关闭）**
  从容器里采样 Top-K“重复性指纹”，用于“找同类稳定召回”；默认 `use_template=false` → 权重=0。
  建议加“可刷新”标记（运行期皮肤变更时仅刷新模板到本地缓存，不改脚本）。

* **完整性评分**
  保存前计算 Completeness Score：

  * +0.30 容器锚；+0.25 卡片根+可点父；+0.20 祖先/列位/宽桶任一；+0.15 骨架；+0.10 ≥1 字段锚；
  * −0.20 若仅“Frame+index=0”。
    **<0.6 给黄条提示**：建议补一个祖先/字段锚再保存。

---

## 三、写入 StepCard 的**最小快照字段**（建议结构）

> 存在 StepCard 内部的 `static.strategy.structure`，发布即用，无外部依赖。

```json
{
  "matchMode": "structure",
  "structure_snapshot": {
    "container": {
      "xpath": "//RecyclerView[@scrollable='true']",
      "fingerprint": { "role": "RecyclerView", "scrollable": true, "bounds_hint": [0,320,1080,2280] }
    },
    "card_root": {
      "role": "FrameLayout",
      "class_contains": "card",
      "clickable_parent_path": "↑1"
    },
    "skeleton_rules": {
      "require_image_above_text": true,
      "allow_depth_flex": 1
    },
    "field_rules": {
      "rules": [
        { "class_contains": "title", "presence_only": true },
        { "class_contains": "desc",  "presence_only": true },
        { "class_contains": "badge", "must_be_empty": true }
      ]
    },
    "geometry": {
      "use": false,                       // 默认关闭 → 权重=0
      "expected_layout": ["WaterfallMulti","MasonrySingle"]
    },
    "template_signature": {
      "use": false,                       // 默认关闭 → 权重=0
      "refreshable": true,                // 运行期可刷新到本地缓存
      "topk": []                          // 关闭时可为空
    },
    "mode": "Default",
    "thresholds": { "min_confidence": 0.7, "top_gap": 0.15 },
    "locks": { "geometry": "soft", "template": "refreshable" }
  },
  "selectionPolicy": "first",
  "wantAll": false
}
```

> 你现有“字段打分（空/非空/等于）”依然是主力；几何/模板默认不参与打分。
> 未来你想更稳，再把 `geometry.use` 或 `template_signature.use` 打开即可。

---

## 四、模态框要做的三件事

1. **自动生成 + 可视预览**
   左侧列表展示：容器、卡片根、字段锚；右侧预览 Overlay 高亮候选数。
2. **校验 + 提示**
   显示 Completeness Score；<0.6 给出“建议至少添加一个祖先或字段锚”提示。
3. **保存即写入 StepCard**
   点击“确定”→ 覆盖写入当前 StepCard 的 `structure_snapshot`；不改变“经典匹配”的其他设置。

---

## 五、测试与发布

* **测试**：在模态框或 StepCard 里点“测试匹配”，把 `structure_snapshot` 原样传后端 `sm_match_once`，Overlay 展示 `geom/tpl/skeleton/field/total`。
* **发布**：StepCard 已自带 snapshot，**无需外链**；模板签名如设 `refreshable`，运行期皮肤变化时只刷新到本地缓存，不脏脚本。
* **日志**：打印阶段性信息（容器→候选→骨架→字段→评分/闸门），失败原因清晰可见。

---

## 六、为什么这套默认“更稳、又不打断现有逻辑”

* 你坚持的**“空/非空即规则”**仍然是核心；
* **骨架**让候选更“像同类卡片”；
* **几何/模板默认不参与打分**，所以**与你现有字段权重体系不冲突**；
* 真要提升鲁棒性，只需在模态框里**勾上**几何/模板即可，无需改旧步骤或权重。

---

如果你愿意，我可以把这个模态框的**表单项清单**和**校验流程**列成一张“前端开发 checklist”，你照着就能在现有 UI 中快速补齐。


（默认开启）几何/模板签名两个开关


是不是我原来的前端功能不够完善， 如果是，请帮我完善优化。
我希望保持 子文件夹/子文件， 模块化的完善这个功能。
