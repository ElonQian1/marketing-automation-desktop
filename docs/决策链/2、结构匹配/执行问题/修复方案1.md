# ç»“æ„åŒ¹é…â€”å®¹å™¨ä¸å‚æ•°æµä¿®å¤æ–¹æ¡ˆï¼ˆSM v1.1.0 ææ¡ˆï¼‰

> ç›®æ ‡ï¼šä¿®å¤ã€Œæ¨¡æ€æ¡†å±•ç¤ºæ­£ç¡®ï¼Œä½†ç‚¹å‡»ç¡®å®šåç”Ÿæˆçš„ç»“æ„å‚æ•°é”™è¯¯/ä¸¢å¤±ã€ä¸ã€Œcontainer_xpath å–é”™ï¼ˆ//FrameLayout å¯¼è‡´ container_id=0ï¼‰ã€ä¸¤ç±»é—®é¢˜ï¼›ç¡®ä¿é»˜è®¤ä¸æ”¹åŠ¨é…ç½®æ—¶ä¹Ÿèƒ½ç”Ÿæˆ**å¯ç”¨ä¸”ç¨³å®š**çš„ç»“æ„åŒ¹é…å‚æ•°ã€‚

---

## ä¸€ã€å¤ç°æ‘˜è¦ï¼ˆæ¥è‡ªä½ æä¾›çš„æ—¥å¿—ï¼‰

* å‰ç«¯ï¼š`âœ… [StructuralSnapshotGenerator] ... container_xpath: '//FrameLayout'`ï¼ˆ**é”™è¯¯**ï¼Œåº”å½“æ˜¯ RecyclerViewï¼‰ã€‚
* åç«¯ï¼š`ğŸ—ï¸ [V3 SM Integration] SMåŒ¹é…å®Œæˆ: container_id=0, æ‰¾åˆ° 0 ä¸ªåŒ¹é…` â†’ `âš ï¸ ç»“æ„åŒ¹é…å¤±è´¥ï¼ˆä¸¥æ ¼ç»“æ„æ¨¡å¼ï¼‰ï¼šSMåŒ¹é…æˆåŠŸä½†æ— æ³•è½¬æ¢ä¸ºUIElement`ã€‚
* ç»“è®ºï¼šå®¹å™¨è¯†åˆ«é”™è¯¯ â†’ å‘½ä¸­ Root â†’ å€™é€‰ 0/ä¸å¯è½¬ UIElementã€‚

---

## äºŒã€æ ¹å› å®šä½

1. **å®¹å™¨è¯†åˆ«ç­–ç•¥æœ‰ç¼ºé™·**ï¼šç›´æ¥ç”¨ç‚¹é€‰å…ƒç´ çš„ `class_name` ç”Ÿæˆ `//FrameLayout`ï¼›ä½†è¯¥å…ƒç´ æ˜¯**å¡ç‰‡æ ¹**ï¼ˆRecyclerView å­é¡¹ï¼‰ï¼ŒçœŸæ­£å®¹å™¨åº”æ˜¯å®ƒçš„**å¯æ»šåŠ¨ç¥–å…ˆ**ï¼ˆRecyclerViewï¼‰ã€‚
2. **æ¨¡æ€æ¡† â†’ æäº¤çš„å‚æ•°æµ**ï¼š

   * æ¨¡æ€æ¡†å±•ç¤ºçš„æ•°æ®æ¥è‡ªç¼“å­˜æˆ– XML å¿«ç…§ **æ˜¯æ­£ç¡®çš„**ï¼›
   * ä½†ç‚¹å‡»ã€Œç¡®å®šã€æ—¶ï¼Œé‡æ–°è·‘äº†ä¸€æ¬¡ç”Ÿæˆå™¨ï¼ˆä¸”**æœªå¸¦çˆ¶é“¾/ä¸Šä¸‹æ–‡**ï¼‰ï¼Œå¯¼è‡´ï¼š

     * `container_xpath` å›é€€æˆ `//FrameLayout`ï¼›
     * `field_rules`/`skeleton_rules` è¢«**é‡å»ºæˆ–æˆªæ–­**ï¼ˆæœªç”¨åˆ° UI ä¸­å·²ç¡®è®¤çš„é‚£ä»½ï¼‰ã€‚

---

## ä¸‰ã€ä¿®å¤æ€»è§ˆï¼ˆSM v1.1.0ï¼‰

* **A. å®¹å™¨è¯†åˆ«ç®—æ³•å‡çº§**ï¼šä»æ‰€é€‰å…ƒç´ ä¸Šæº¯ï¼Œæ‰¾åˆ°æœ€è¿‘çš„**å¯æ»šåŠ¨é›†åˆå®¹å™¨**ï¼ˆRecyclerView/ListView/GridView/ViewPager/â€¦ï¼‰ï¼›ç”Ÿæˆ `//{Class}[@scrollable='true']` å½¢å¼çš„ `container_xpath`ã€‚
* **B. å¡ç‰‡æ ¹ï¼ˆå¯ç‚¹çˆ¶ï¼‰ç¡®å®š**ï¼šåœ¨å®¹å™¨çš„**ç›´æ¥å­é¡¹**èŒƒå›´å†…ï¼Œå¯»æ‰¾æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„æœ€è¿‘ç¥–å…ˆä½œä¸º card_rootï¼š

  1. `clickable=true`ï¼ˆæˆ–ä¸€å±‚å­ä¸º `clickable=true` ä¸”è¦†ç›–æ•´å¡ï¼‰ï¼›
  2. æ·±åº¦ä¸è¶…è¿‡å®¹å™¨ +2ï¼›
  3. å…·å¤‡ã€Œä¸ŠåŠåŒºå¤§å›¾ + åº•éƒ¨ä¿¡æ¯æ ã€çš„éª¨æ¶ç‰¹å¾ï¼ˆå…è®¸ç±»åå·®å¼‚ FrameLayout/RelativeLayout/ConstraintLayoutï¼‰ã€‚
* **C. æäº¤å‚æ•°**ï¼šæ¨¡æ€æ¡†**ä¸å†é‡æ–°ç”Ÿæˆ**ï¼›æ”¹ä¸ºæäº¤**å½“å‰ UI çŠ¶æ€ï¼ˆç”¨æˆ·å¯è§ä¸”å¯ç¼–è¾‘çš„é‚£ä»½ï¼‰**ã€‚
* **D. å…ƒä¿¡æ¯è¡¥å……**ï¼šå¢åŠ  `algorithm_version`ã€`source_tag`ï¼Œä»¥åŠ `xml_cache_id` / `xml_snapshot_hash` ä¾¿äºåç«¯å›æº¯å’Œå¤ç›˜ã€‚
* **E. å¤±è´¥ä¿æŠ¤**ï¼š

  * å½“ `container_xpath` ä¸ºç©ºæˆ–è§£æåˆ° Root æ—¶ **ç¦æ­¢æäº¤**ï¼Œç»™å‡ºå¯è§†åŒ–æç¤ºï¼›
  * æ˜¾å¼åœ¨ç½‘å…³æ—¥å¿—æ‰“å°ï¼š`container.class/bounds/child_count`ï¼Œè¾…åŠ©æ’éšœã€‚

---

## å››ã€å…³é”®æ”¹åŠ¨ï¼ˆTypeScript ä¼ªä»£ç /ç¤ºä¾‹ï¼‰

> æ–‡ä»¶ï¼š`src/modules/structural-matching/services/structural-snapshot-generator.ts`

```ts
// 1) æ–°å¢ï¼šå®¹å™¨è¯†åˆ«ä¸ XPath ç”Ÿæˆ
const SCROLLABLE_CLASSES = new Set([
  'androidx.recyclerview.widget.RecyclerView',
  'android.widget.ListView',
  'android.widget.GridView',
  'androidx.viewpager.widget.ViewPager',
  'androidx.viewpager2.widget.ViewPager2',
]);

function isScrollableCollection(node: UIElementLike): boolean {
  const cls = node.class_name || node.className || '';
  const scrollable = `${node.scrollable}` === 'true';
  return scrollable && SCROLLABLE_CLASSES.has(cls);
}

function findScrollableAncestor(sel: UIElementLike, tree: XmlTree): UIElementLike | null {
  let cur: UIElementLike | null = sel;
  let guard = 0;
  while (cur && guard++ < 32) {
    if (isScrollableCollection(cur)) return cur;
    cur = tree.parentOf(cur.id);
  }
  return null;
}

function containerXPathOf(node: UIElementLike): string {
  const cls = node.class_name;
  return `//${cls}[@scrollable='true']`;
}

// 2) æ–°å¢ï¼šå¡ç‰‡æ ¹ï¼ˆå¯ç‚¹çˆ¶ï¼‰
const ROOT_CLASS_ALLOWLIST = new Set([
  'android.widget.FrameLayout',
  'android.view.ViewGroup',
  'android.widget.RelativeLayout',
  'androidx.constraintlayout.widget.ConstraintLayout',
]);

function findCardRootWithinContainer(sel: UIElementLike, container: UIElementLike, tree: XmlTree): UIElementLike {
  // ä»é€‰ä¸­å‘ä¸Šèµ°ï¼Œç›´åˆ°æˆä¸º container çš„ç›´æ¥å­é¡¹ï¼ˆæˆ–æ»¡è¶³ clickable=true ä¸”è¦†ç›–æ•´å¡ï¼‰
  let cur: UIElementLike = sel;
  let prev: UIElementLike | null = null;
  let depth = 0;
  while (cur && cur.id !== container.id && depth++ < 8) {
    const parent = tree.parentOf(cur.id);
    const isDirectChildOfContainer = parent && parent.id === container.id;
    const clickOk = cur.is_clickable === true || `${cur.clickable}` === 'true';
    const classOk = ROOT_CLASS_ALLOWLIST.has(cur.class_name);

    if (isDirectChildOfContainer && classOk && clickOk) return cur;

    prev = cur;
    cur = parent || cur; // é˜²å¾¡
    if (!parent) break;
  }
  // å…œåº•ï¼šè¿”å›æœ€é è¿‘å®¹å™¨çš„é‚£ä¸ªï¼ˆå³ prevï¼‰
  return prev || sel;
}

// 3) ç”Ÿæˆå¿«ç…§ï¼ˆä¿®å¤ç‰ˆï¼‰
export function generateSnapshotV110(args: {
  selectedElementId: string;
  xmlCacheId?: string;
  xmlSnapshot?: string; // åå¤‡
  sourceTag: 'PageAnalysisCache' | 'StepCardSnapshot';
}, stores: { xmlStore: XmlStore; }) {
  const tree = args.xmlCacheId
    ? stores.xmlStore.getTree(args.xmlCacheId)
    : stores.xmlStore.buildTreeFromSnapshot(args.xmlSnapshot!);

  const sel = tree.getById(args.selectedElementId);
  if (!sel) throw new Error('Selected element not found in XML');

  const container = findScrollableAncestor(sel, tree)
    ?? tree.findFirst(n => isScrollableCollection(n));
  if (!container) throw new Error('Scrollable container not found');

  const cardRoot = findCardRootWithinContainer(sel, container, tree);

  const snapshot: StructuralSnapshot = {
    meta: {
      algorithm_version: 'sm.v1.1.0',
      source_tag: args.sourceTag,
      xml_cache_id: args.xmlCacheId,
      xml_snapshot_hash: args.xmlSnapshot ? hash(args.xmlSnapshot) : undefined,
    },
    container: {
      xpath: containerXPathOf(container),
      class_name: container.class_name,
      scrollable: true,
      bounds: container.bounds,
    },
    root: {
      id: cardRoot.id,
      role: cardRoot.class_name,
      clickable: !!(cardRoot.is_clickable || `${cardRoot.clickable}` === 'true'),
      depth_from_container: tree.depth(cardRoot.id) - tree.depth(container.id),
      bounds: cardRoot.bounds,
    },
    skeleton_rules: buildSkeletonRules(cardRoot, tree),
    field_rules: buildFieldRules(cardRoot, { policy: 'empty_nonempty_only' }),
    click: { strategy: 'tap', prefer_root_click: true },
  };

  return snapshot;
}
```

> æ³¨æ„ï¼š`buildSkeletonRules` ä¸ `buildFieldRules` å¤ç”¨ä½ ç°æœ‰é€»è¾‘ï¼Œä»…è°ƒæ•´å…¥å‚ä¸º `cardRoot`ï¼›å­—æ®µç­–ç•¥é»˜è®¤ **åªåšç©º/éç©º** ä¸**è½»é‡ä¸€è‡´**ï¼Œé¿å…â€œæ–‡æ¡ˆç­‰å€¼â€å¸¦æ¥çš„ 0 å‘½ä¸­ã€‚

---

## äº”ã€æ¨¡æ€æ¡†æäº¤æµç¨‹ä¿®å¤

> æ–‡ä»¶ï¼š`src/modules/structural-matching/ui/components/structural-matching-modal/structural-matching-modal.tsx`

**é—®é¢˜**ï¼šç‚¹å‡»ã€Œç¡®å®šã€æ—¶åˆè°ƒç”¨ç”Ÿæˆå™¨ï¼Œä¸”ç¼ºå°‘çˆ¶é“¾/ä¸Šä¸‹æ–‡ â†’ ç”Ÿæˆäº†é”™è¯¯çš„ `container_xpath` ä¸ä¸¢å¤±çš„ `field_rules`ã€‚

**ä¿®å¤**ï¼š

1. æ¨¡æ€æ¡†åˆå§‹åŒ–æ—¶ç”Ÿæˆä¸€æ¬¡ `snapshot`ï¼ˆæˆ–ä»ç¼“å­˜/æ­¥éª¤å¡ç‰‡æ¢å¤ï¼‰ã€‚
2. ç”¨æˆ·åœ¨ UI ä¸Šçš„ä»»ä½•æ”¹åŠ¨ï¼Œéƒ½ä¿®æ”¹è¿™ä»½ **`snapshotState`**ã€‚
3. ç‚¹å‡»ã€Œç¡®å®šã€**ç›´æ¥æäº¤ `snapshotState`**ï¼›**ä¸è¦**é‡æ–°ç”Ÿæˆã€‚
4. å¦‚å¿…é¡»é‡å»ºï¼ˆä¾‹å¦‚ç”¨æˆ·ç‚¹ã€Œé‡ç®—ã€æŒ‰é’®ï¼‰ï¼Œ**åŠ¡å¿…**ä¼ å…¥ `xmlCacheId/xmlSnapshot` å¹¶ä½¿ç”¨ `generateSnapshotV110`ã€‚

ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```tsx
// state
const [snapshotState, setSnapshotState] = useState<StructuralSnapshot | null>(null);

useEffect(() => {
  const initial = generateSnapshotV110({
    selectedElementId,
    xmlCacheId,
    xmlSnapshot,
    sourceTag,
  }, { xmlStore });
  setSnapshotState(initial);
}, [selectedElementId, xmlCacheId]);

function onConfirm() {
  if (!snapshotState?.container?.xpath || snapshotState.container.xpath === '//*' || /\/\w*FrameLayout$/.test(snapshotState.container.xpath)) {
    toast.error('å®¹å™¨æœªè¯†åˆ«åˆ°å¯æ»šåŠ¨åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥æˆ–æ»šåŠ¨åˆ°åˆ—è¡¨åŒºåŸŸåé‡è¯•');
    return;
  }
  props.onSubmit(snapshotState); // ç›´æ¥ç”¨ UI ä¸­è¿™ä»½
}
```

---

## å…­ã€StepExecutionGateway ä¾§æ ¡éªŒä¸åŸ‹ç‚¹

> æ–‡ä»¶ï¼š`src/infrastructure/gateways/StepExecutionGateway.ts`

* æ‰“å°æäº¤ç»™åç«¯çš„å…³é”®å­—æ®µï¼š

```ts
logger.info('[V3è°ƒç”¨å‚æ•°è¯¦æƒ….container]', {
  xpath: snapshot.container?.xpath,
  class_name: snapshot.container?.class_name,
  bounds: snapshot.container?.bounds,
});
```

* è‹¥ `xpath` è§£åˆ° root æˆ–ç©ºï¼Œ**æ‹¦æˆª**å¹¶æç¤ºã€‚

---

## ä¸ƒã€åç«¯å…¼å®¹æ€§ï¼ˆRustï¼‰

* ç°çŠ¶ï¼šåç«¯æŠŠ `container_xpath` æ˜ å°„ä¸º `container_id`ï¼›`//FrameLayout` å‘½ä¸­å¤ªå¤šæ—¶ä¼šå›è½åˆ° 0ï¼ˆrootï¼‰ã€‚
* æ— éœ€å¤§æ”¹ï¼šå‰ç«¯ä¿®æ­£ä¸º RecyclerView è·¯å¾„åï¼Œèƒ½ç¨³å®šè½åˆ°æ­£ç¡®çš„å®¹å™¨ idã€‚
* å»ºè®®å®Œå–„æ—¥å¿—ï¼šæ‰“å° `container_xpath â†’ container_id â†’ node.class/bounds/child_count`ã€‚

---

## å…«ã€éªŒè¯æ¸…å•ï¼ˆåŸºäºä½ æä¾›çš„ XMLï¼‰

1. é€‰ä¸­ä»»æ„å¡ç‰‡å†…èŠ‚ç‚¹ï¼ˆä¾‹å¦‚ï¼šä½œè€…å TextViewï¼‰ã€‚
2. æ‰“å¼€ç»“æ„åŒ¹é…æ¨¡æ€æ¡† â†’ åˆå§‹åŒ–ç”Ÿæˆï¼š

   * `container.xpath == //androidx.recyclerview.widget.RecyclerView[@scrollable='true']`
   * `root.role âˆˆ {FrameLayout, ViewGroup, RelativeLayout, ConstraintLayout}` ä¸” `clickable=true`
   * `depth_from_container <= 2`
   * æœ‰ 6~8 æ¡ `skeleton_rules` ä¸ 5~9 æ¡ `field_rules`
3. æ— æ”¹åŠ¨ç‚¹å‡»ç¡®å®šï¼š

   * StepExecutionGateway æ‰“å°å®¹å™¨ä¿¡æ¯ï¼›
   * åç«¯æ—¥å¿—ï¼š`container_id > 0`ï¼Œå€™é€‰ â‰¥ 1ï¼Œä¸”èƒ½ `è½¬æ¢ä¸º UIElement`ã€‚
4. ä¿®æ”¹å­—æ®µç­–ç•¥ä¸ºç­‰å€¼/éç©ºåé‡è¯•ï¼ŒåŒ¹é…ç¨³å®šã€‚

---

## ä¹ã€å›å½’ä¸é£æ§

* UI æ‹¦æˆªéæ³•å®¹å™¨ä¸ç©ºè§„åˆ™æäº¤ï¼›
* æ–°è€å¿«ç…§æ ¼å¼å‘åå…¼å®¹ï¼ˆ`algorithm_version` æœªæä¾›æ—¶æŒ‰ v1.0 æ¨æ–­ï¼‰ï¼›
* æ”¯æŒ `xml_cache_id` ç¼ºå¤±æ—¶çš„å¿«ç…§é‡å»ºï¼›
* å¢å¼ºæ—¥å¿—ï¼Œä¾¿äºçº¿ä¸Šå®šä½ã€‚

---

## åã€åç»­å¯é€‰ä¼˜åŒ–

* è¯†åˆ«ã€Œé‡å¤é¡¹ç»“æ„ã€ï¼šåœ¨å®¹å™¨ä¸‹æŠ½æ · 3~5 ä¸ªå­é¡¹ï¼Œåšâ€œéª¨æ¶çº¦æŸæ±‚äº¤é›†â€ï¼Œç”Ÿæˆæ›´åŠ ç¨³å®šçš„å¡ç‰‡éª¨æ¶ï¼›
* é’ˆå¯¹ AB/å¹¿å‘Šæ’å¡ï¼Œå…è®¸ **skeleton å¯é€‰åˆ†æ”¯**ï¼ˆä¾‹å¦‚ï¼šåº•æ æœ‰/æ— ç‚¹èµå›¾æ ‡ï¼‰ã€‚

---

**ç»“è®º**ï¼šè½åœ°æœ¬ææ¡ˆåï¼Œæ¨¡æ€æ¡†â€œæ‰€è§å³æ‰€å¾—â€çš„ç»“æ„ç­¾åå°†è¢«**åŸæ ·æäº¤**åˆ°åç«¯ï¼›å®¹å™¨å°†ç¨³å®šè¯†åˆ«ä¸º RecyclerViewï¼Œ`container_id` ä¸å†ä¸º 0ï¼›é»˜è®¤å­—æ®µç­–ç•¥é‡‡ç”¨â€œç©º/éç©º + è½»ä¸€è‡´â€ï¼Œæå‡è·¨è®¾å¤‡/å¤šè¯­è¨€/AB å…¼å®¹æ€§ã€‚
