# 同构决策链模块化架构设计

## 📋 核心模块分工

### 1️⃣ 前端静态分析模块 (`StaticAnalysisEngine`)
**职责**: 采集固化证据包，生成可执行Plan
- `ElementAnalyzer`: 分析目标元素上下文
- `ContainerDetector`: 识别稳定容器锚点  
- `ChildAnchorExtractor`: 提取子树锚点
- `StructuralSignatureBuilder`: 构建结构签名
- `StrategyPlanGenerator`: 生成候选策略链
- `DecisionChainSerializer`: 序列化为步骤卡片

### 2️⃣ 后端真机复现模块 (`RuntimeExecutionEngine`)  
**职责**: 按Plan同构执行与评分
- `PlanDeserializer`: 解析步骤卡片Plan
- `VariantExecutor`: 执行单个策略变体
- `TriStateScorer`: 三态对比评分器
- `UniquenessValidator`: 双重唯一性验证
- `SafetyGatekeeper`: 容器/整屏拦截
- `FallbackController`: 受控回退管理

### 3️⃣ 共享评分模块 (`UnifiedScoringCore`)
**职责**: 前后端统一评分逻辑
- `EvidenceWeights`: 证据权重配置
- `TriStateComparator`: 匹配/缺失/不一致三态比较
- `ConfidenceCalculator`: 置信度计算
- `UniquenessChecker`: 唯一性双判逻辑

### 4️⃣ 数据传输模块 (`DecisionChainProtocol`)
**职责**: 标准化数据结构
- `StaticAnalysisContext`: 场景上下文
- `ChildAnchors`: 子树锚点集合
- `StrategyPlan`: 候选策略链
- `ExecutionResult`: 执行结果与日志

## 🔧 关键设计原则

### A. 同构性保证
- **相同的评分算法**: `UnifiedScoringCore`在前后端复用
- **相同的决策顺序**: Plan序列就是执行序列
- **相同的安全闸门**: 唯一性+容器拦截逻辑一致

### B. 可复现性
- **证据完备性**: 静态分析采集的证据包能完整还原决策依据
- **执行确定性**: 相同输入在相同条件下产生相同输出
- **可审计性**: 每步决策都有明确的reason code

### C. 模块独立性
- **接口标准化**: 模块间通过标准接口通信
- **功能内聚**: 每个模块职责单一明确
- **松耦合**: 可独立测试和替换

## 🚀 实现路线图

### Phase 1: 核心数据结构 (Week 1)
1. 定义`DecisionChainProtocol`标准数据结构
2. 实现`TriStateComparator`三态评分逻辑
3. 建立前后端共享的`UnifiedScoringCore`

### Phase 2: 静态分析引擎 (Week 2-3)  
1. `ElementAnalyzer`提取目标元素上下文
2. `ChildAnchorExtractor`处理父无字段问题
3. `StrategyPlanGenerator`生成排序候选链
4. `DecisionChainSerializer`固化为JSON

### Phase 3: 真机执行引擎 (Week 3-4)
1. `PlanDeserializer`解析Plan配方
2. `VariantExecutor`按顺序执行候选
3. `FallbackController`管理受控回退
4. `SafetyGatekeeper`实施安全拦截

### Phase 4: 集成测试 (Week 4-5)
1. 端到端验证同构性
2. 性能优化与容错处理
3. 日志体系与可观测性
4. 文档与最佳实践

## 📊 成功指标

### 技术指标
- **复现一致性**: ≥95%（相同Plan在相同环境下结果一致）
- **执行效率**: 单步执行时间≤200ms，总预算≤1200ms  
- **安全性**: 0容器误点，0整屏误点
- **稳定性**: ≥90%单跳命中率，≤10%需要回退

### 业务指标  
- **开发效率**: 新步骤卡片创建时间减少60%
- **维护成本**: 语言/版本变化适配工作量减少80%
- **故障率**: UI自动化相关故障减少70%
- **可调试性**: 问题定位时间减少50%

---

这套模块化设计确保了"静态分析如何想"与"真机如何判"完全对齐，是实现同构决策链的最优架构。