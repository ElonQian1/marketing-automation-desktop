ä½ è¿™æ¬¡çš„æŠ¥é”™é“¾è·¯å·²ç»æŠŠæ ¸å¿ƒé—®é¢˜æš´éœ²å‡ºæ¥äº†ğŸ‘‡

* `xml-cache-manager.ts:89 âš ï¸ æœªæ‰¾åˆ°XMLç¼“å­˜: current`
* `useStepCardReanalysis.ts:51 æ— æ³•è·å–XMLå†…å®¹: 1760614545456_3ezytbps6`
* é¡¶éƒ¨ toastï¼š**â€œæ— æ³•é‡æ–°æ„å»ºå…ƒç´ ä¸Šä¸‹æ–‡ï¼Œè¯·æ£€æŸ¥XMLå¿«ç…§ä¿¡æ¯â€**

## æ ¹å› ï¼ˆ90% æ¦‚ç‡ï¼‰

**é‡æ–°åˆ†ææ—¶å– XML çš„é”®é”™äº†** â€”â€” ä»£ç ä¼˜å…ˆå»æ‹¿ `'current'`ï¼ˆå®æ—¶ç¼“å­˜ï¼‰ï¼Œæ‹¿ä¸åˆ°ï¼›ç„¶ååˆç”¨ **stepId** å½“ä½œç¼“å­˜é”®å»å–ï¼Œå†æ¬¡å¤±è´¥ã€‚
ä½†æ­£ç¡®çš„é”®åº”è¯¥æ˜¯ä½ åœ¨ã€Œç”Ÿæˆæ­¥éª¤å¡ç‰‡ã€æ—¶è®°å½•åˆ°å¡ç‰‡é‡Œçš„ **`xmlHash` æˆ– `xmlCacheId`**ï¼Œè€Œä¸æ˜¯ `'current'` æˆ– `stepId`ã€‚

---

## ç«‹åˆ»ä¿®ï¼šç»Ÿä¸€â€œXMLè·å–é¡ºåºâ€ï¼Œåˆ«å†ç”¨ `'current'`

### 1) æ”¹ `useStepCardReanalysis.ts` çš„ XML è·å–é€»è¾‘ï¼ˆä¼˜å…ˆ hash / å…¶æ¬¡ cacheId / æœ€å liveï¼‰

```ts
// src/pages/.../hooks/useStepCardReanalysis.ts
// âœ… ç¬¬ä¸€è¡Œä¿ç•™æ–‡ä»¶ç›¸å¯¹è·¯å¾„
import { xmlCacheManager } from '@/services/xml-cache-manager';
import type { StepCardData } from '@/types/step-bundle';

async function getXmlForStep(step: StepCardData) {
  // 1) ä¼˜å…ˆç”¨å†…å®¹å¯»å€ï¼ˆæœ€ç¨³å®šï¼‰
  if (step.xmlHash) {
    const xmlByHash = await xmlCacheManager.getByHash(step.xmlHash);
    if (xmlByHash) return xmlByHash;
    console.warn('[Reanalyze] xmlHash æœªå‘½ä¸­ç¼“å­˜ï¼š', step.xmlHash);
  }
  // 2) å…¶æ¬¡ç”¨ç¼“å­˜IDï¼ˆä½ ç”Ÿæˆå¡ç‰‡æ—¶åº”å†™å…¥ï¼‰
  if (step.xmlCacheId) {
    const xmlById = await xmlCacheManager.getCachedXml(step.xmlCacheId);
    if (xmlById) return xmlById;
    console.warn('[Reanalyze] xmlCacheId æœªå‘½ä¸­ç¼“å­˜ï¼š', step.xmlCacheId);
  }
  // 3) æœ€åå…œåº•ï¼šä»…åœ¨ç”¨æˆ·ç¡®è®¤æ—¶ä½¿ç”¨å®æ—¶ currentï¼ˆé¿å…â€œéšå¼åˆ‡é¡µâ€ï¼‰
  const live = await xmlCacheManager.getCachedXml('current');
  if (live) return live;

  throw new Error('NO_XML_SNAPSHOT');
}

export async function reanalyzeStepCard(step: StepCardData, opts: { strategy: any }) {
  let xml: string;
  try {
    xml = await getXmlForStep(step);
  } catch {
    // æ˜¾ç¤ºå¯æ“ä½œçš„æç¤ºï¼šè®©ç”¨æˆ·é€‰æ‹©â€œé‡æ–°æŠ“å–å¿«ç…§â€æˆ–â€œé€‰æ‹©å·²æœ‰å¿«ç…§â€
    // showMissingXmlDialog();
    throw new Error('æ— æ³•é‡æ–°æ„å»ºå…ƒç´ ä¸Šä¸‹æ–‡ï¼šç¼ºå°‘ XML å¿«ç…§ï¼ˆxmlHash/xmlCacheId å‡æœªå‘½ä¸­ï¼Œä¸”æ—  currentï¼‰');
  }
  // ...åç»­æŠŠ xml + step.elementGlobalXPath + strategy ä¼ ç»™åå°
}
```

### 2) ç»™ `xml-cache-manager` å¢åŠ  **hash ç´¢å¼•**ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

```ts
// src/services/xml-cache-manager.ts
// âœ… ç¬¬ä¸€è¡Œä¿ç•™æ–‡ä»¶ç›¸å¯¹è·¯å¾„
type XmlRecord = { id: string; hash: string; xml: string; createdAt: string };
const byId = new Map<string, XmlRecord>();
const byHash = new Map<string, XmlRecord>();

export async function putXml(id: string, xml: string, hash: string, createdAt = new Date().toISOString()) {
  const rec: XmlRecord = { id, hash, xml, createdAt };
  byId.set(id, rec);
  byHash.set(hash, rec);
}

export async function getCachedXml(id: string) {
  return byId.get(id)?.xml ?? null;
}

export async function getByHash(hash: string) {
  return byHash.get(hash)?.xml ?? null;
}

// è°ƒè¯•ç”¨ï¼šçœ‹çœ‹ç°åœ¨ç¼“å­˜é‡Œæœ‰ä»€ä¹ˆé”®
export function dumpKeys() {
  return { ids: [...byId.keys()], hashes: [...byHash.keys()] };
}
```

### 3) åœ¨**ç”Ÿæˆæ­¥éª¤å¡ç‰‡**æ—¶ï¼Œç¡®ä¿æŠŠå¿«ç…§å†™å…¥ç¼“å­˜ï¼Œå¹¶æŠŠé”®å†™è¿›å¡ç‰‡

```ts
// src/pages/.../useIntelligentStepCardIntegration.ts
// âœ… ç¬¬ä¸€è¡Œä¿ç•™æ–‡ä»¶ç›¸å¯¹è·¯å¾„
import { putXml } from '@/services/xml-cache-manager';
import { sha256 } from '@/lib/hash'; // ä½ å·²æœ‰æˆ–ç”¨ tauri åç«¯è®¡ç®—

async function createStepFromPick(pick) {
  const rawXml = pick.xml;                       // å½“å‰åŸå§‹ XML
  const xmlHash = 'sha256:' + sha256(rawXml);
  const xmlCacheId = `snap:${Date.now()}`;       // ä»»æ„ç¨³å®šIDï¼ˆåˆ«ç”¨ stepIdï¼‰

  await putXml(xmlCacheId, rawXml, xmlHash);

  const step: StepCardData = {
    // ...
    xmlHash,
    xmlCacheId,
    xmlCreatedAt: new Date().toISOString(),
    elementGlobalXPath: pick.globalXPath,
    elementSignature: pick.signature,
    currentStrategy: { kind: 'smart', mode: 'auto' },
    status: 'pending',
  };
  return step;
}
```

---

## åŠ ä¸€å±‚å®ˆå«ï¼šæ²¡æœ‰å¿«ç…§å°±åˆ«è®©ç‚¹

æŠŠâ€œé‡æ–°åˆ†æâ€æŒ‰é’®çš„å¯ç”¨æ¡ä»¶å†**æ”¶æ•›**ä¸€ä¸‹ï¼š

* âœ… æœ‰ `xmlHash` **æˆ–** `xmlCacheId`
* âœ… ï¼ˆå¯é€‰ï¼‰è‹¥èµ° `current` å…œåº•ï¼Œéœ€è¦ç”¨æˆ·ç¡®è®¤

```ts
// src/components/steps/CompactStrategyMenu.tsxï¼ˆæˆ– StepCard.tsxï¼‰
// âœ… ç¬¬ä¸€è¡Œä¿ç•™æ–‡ä»¶ç›¸å¯¹è·¯å¾„
const haveSnapshot = Boolean(step.xmlHash || step.xmlCacheId);
const disabled = (status === 'running' && fresh) || !haveSnapshot || !elementGlobalXPath || !backendHealthy;
```

---

## ç»™ç”¨æˆ·ä¸€ä¸ªå¯æ“ä½œçš„å…œåº•ï¼ˆUXï¼‰

å½“ç¡®å®æ²¡æœ‰å¿«ç…§å‘½ä¸­æ—¶ï¼Œä¸è¦åªç»™çº¢å­—ï¼›å¼¹ä¸€ä¸ªå¯¹è¯æ¡†ï¼Œç»™ä¸‰ç§é€‰æ‹©ï¼š

* **é‡æ–°æŠ“å–å½“å‰é¡µé¢ XML**ï¼ˆåˆ·æ–° `current` å¹¶æç¤ºâ€œæ­¤ä¸ºå®æ—¶é¡µé¢ï¼Œå¯èƒ½ä¸åŸå¿«ç…§ä¸åŒâ€ï¼‰
* **ä»å†å²å¿«ç…§é€‰æ‹©**ï¼ˆåˆ—å‡º `xml-cache-manager.dumpKeys()` çš„ hash/æ—¶é—´ï¼‰
* **å–æ¶ˆ**

---

## æœ€åï¼Œç”¨ä¸¤æ¡æ—¥å¿—è‡ªæ£€ï¼ˆæœ€å¿«æ’æŸ¥ï¼‰

```ts
// ç‚¹å‡»â€œé‡æ–°åˆ†æâ€å‰æ‰“å°
console.log('[Reanalyze] step xmlHash/xmlCacheId', step.xmlHash, step.xmlCacheId);
console.log('[Reanalyze] cache keys', xmlCacheManager.dumpKeys());
```

å¦‚æœçœ‹åˆ°ï¼š

* `xmlHash` æœ‰å€¼ä½† `hashes` åˆ—è¡¨ä¸å«è¯¥å€¼ â†’ **ç”Ÿæˆå¡ç‰‡æ—¶æ²¡ putXml**
* ä¸¤è€…éƒ½ç©º â†’ **å¡ç‰‡æ²¡å†™å…¥å¿«ç…§é”®**ï¼ˆä¿®æ­¥éª¤åˆ›å»ºé€»è¾‘ï¼‰
* ä¸¤è€…æœ‰å…¶ä¸€ï¼Œä½† `dumpKeys()` æ²¡å®ƒ â†’ **ç¼“å­˜ä¸¢å¤±**ï¼ˆåº”ç”¨é‡å¯/æ¸…ç†åï¼Œéœ€è¦ä» bundle/ç£ç›˜é‡å»ºç¼“å­˜ï¼›æ­¤æ—¶å¼¹â€œä»æ­¥éª¤åŒ…å¯¼å…¥å¿«ç…§â€ï¼‰

---

### éªŒæ”¶æ¸…å•ï¼ˆ3 åˆ†é’Ÿæ‰‹æµ‹ï¼‰

1. æ–°é€‰ä¸€ä¸ªå…ƒç´  â†’ ç”Ÿæˆå¡ç‰‡ â†’ æ‰“å° `dumpKeys()`ï¼Œèƒ½çœ‹åˆ°æ–° `xmlCacheId/hash`
2. ç«‹åˆ»â€œé‡æ–°åˆ†æâ€ â†’ æˆåŠŸï¼›åˆ·æ–°åº”ç”¨åå†æ¬¡â€œé‡æ–°åˆ†æâ€ â†’ èƒ½ç”¨ **hash** å‘½ä¸­
3. åˆ»æ„æ¸…ç©ºå†…å­˜ç¼“å­˜ â†’ â€œé‡æ–°åˆ†æâ€å¼¹æ¡†è®©ä½ é€‰æ‹©â€œä»å†å²/åŒ…å¯¼å…¥/é‡æ–°æŠ“å–â€ï¼Œä¸å†ç›´æ¥æŠ¥é”™

æŒ‰è¿™å¥—æ”¹å®Œï¼Œä½ è¿™æ¡æŠ¥é”™å°±ä¼šæ¶ˆå¤±ï¼Œâ€œé‡æ–°åˆ†æâ€ä¼šç¨³å®šè·‘èµ·æ¥ã€‚
