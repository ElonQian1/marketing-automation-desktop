# 🔧 结构匹配按钮修复方案

## 问题分析

你的代码集成是**完全正确的**，但 Ant Design 的 Dropdown Menu 子菜单可能需要特定的配置才能正常工作。

## 🚀 快速修复方案

### 方案1: 确认 Ant Design 版本支持 (最可能)

检查你的 `package.json`:
```json
{
  "dependencies": {
    "antd": "^5.x.x"  // 确保是 5.x 版本
  }
}
```

如果是 Ant Design 5.x，子菜单的 `type` 应该是 `'group'` 而不是 `'submenu'`。

### 方案2: 使用嵌套 Menu 而不是 items 配置

当前代码使用的是 `items` 配置格式，可能不支持子菜单。改用传统的 `<Menu.SubMenu>` 组件：

```typescript
// 修改 getExecutionChainMenu() 返回 JSX 而不是配置对象
const getExecutionChainMenu = () => {
  return (
    <Menu>
      <Menu.Item key="intelligent_chain">
        {/* ... */}
      </Menu.Item>
      
      <Menu.Item key="single_step">
        {/* ... */}
      </Menu.Item>
      
      {/* 🔥 关键：使用 SubMenu 组件 */}
      <Menu.SubMenu
        key="static_strategy"
        title={
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            <span>📌</span>
            <div>
              <div>静态策略</div>
              <div style={{ fontSize: '11px', color: '#64748B' }}>
                用户保存/自建的固定策略
              </div>
            </div>
          </div>
        }
      >
        <Menu.Item 
          key="structural_matching"
          onClick={() => setStructuralMatchingVisible(true)}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            <span>🏗️</span>
            <div>
              <div>结构匹配</div>
              <div style={{ fontSize: '10px', color: '#64748B' }}>
                基于元素结构相似度匹配
              </div>
            </div>
          </div>
        </Menu.Item>
        
        <Menu.Item 
          key="xpath_recovery"
          onClick={() => console.log('🔧 XPath恢复功能待实现')}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
            <span>🔧</span>
            <div>
              <div>XPath恢复</div>
              <div style={{ fontSize: '10px', color: '#64748B' }}>
                智能恢复损坏的XPath
              </div>
            </div>
          </div>
        </Menu.Item>
      </Menu.SubMenu>
    </Menu>
  );
};

// 修改 Dropdown 使用方式
<Dropdown 
  menu={getExecutionChainMenu()}  // ❌ 如果这样不工作
  overlay={getExecutionChainMenu()}  // ✅ 改用 overlay（旧API）
  trigger={['click']}
>
  {/* ... */}
</Dropdown>
```

### 方案3: 临时绕过 - 添加直接按钮

如果子菜单始终无法工作，可以暂时添加一个直接的"结构匹配"按钮：

```typescript
// 在执行链按钮旁边添加
<Button
  size={size}
  onClick={() => setStructuralMatchingVisible(true)}
  style={{
    background: 'rgba(110, 139, 255, 0.1)',
    border: '1px solid rgba(110, 139, 255, 0.3)',
    color: 'rgb(248, 250, 252)',
    fontSize: '12px',
  }}
>
  🏗️ 结构匹配
</Button>
```

## 🔍 调试步骤

### 1. 检查 Ant Design 版本
```bash
npm list antd
```

### 2. 检查菜单是否正确渲染
在 `getExecutionChainMenu()` 返回前添加日志：

```typescript
const getExecutionChainMenu = () => {
  const executionChains = [/* ... */];
  
  const menuConfig = {
    items: executionChains.map(chain => {
      // ...
    })
  };
  
  // 🔍 调试日志
  console.log('📋 [Menu Config]', JSON.stringify(menuConfig, null, 2));
  
  return menuConfig;
};
```

### 3. 检查子菜单是否存在
在浏览器控制台执行：

```javascript
// 查看菜单DOM结构
document.querySelectorAll('.ant-dropdown-menu-submenu').forEach(el => {
  console.log('Found submenu:', el);
});
```

### 4. 强制触发子菜单
```javascript
// 手动触发 hover 事件
const submenu = document.querySelector('.ant-dropdown-menu-submenu');
if (submenu) {
  submenu.dispatchEvent(new MouseEvent('mouseenter', { bubbles: true }));
}
```

## ✅ 推荐的完整修复代码

我建议你采用 **方案2（使用 Menu.SubMenu 组件）**，这是最稳定的方式。

让我为你生成完整的修复代码：

### 修复后的 getExecutionChainMenu()

```typescript
const getExecutionChainMenu = () => {
  return (
    <Menu
      onClick={({ key }) => {
        // 处理非子菜单项的点击
        if (key === 'intelligent_chain' || key === 'single_step') {
          setSmartConfig(prev => ({ ...prev, executionChain: key as ExecutionChain }));
        }
      }}
      selectedKeys={[smartConfig.executionChain]}
    >
      {/* 智能·自动链 */}
      <Menu.Item key="intelligent_chain">
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', minWidth: '200px' }}>
          <span>🧠</span>
          <div style={{ flex: 1 }}>
            <div style={{ 
              fontWeight: smartConfig.executionChain === 'intelligent_chain' ? '600' : '400',
              color: smartConfig.executionChain === 'intelligent_chain' ? '#6E8BFF' : 'inherit'
            }}>
              智能·自动链
            </div>
            <div style={{ fontSize: '11px', color: '#64748B', marginTop: '2px' }}>
              Step1→Step6 动态决策，自动回退兜底
            </div>
          </div>
          {smartConfig.executionChain === 'intelligent_chain' && (
            <span style={{ color: '#10B981' }}>✅</span>
          )}
        </div>
      </Menu.Item>

      {/* 智能·单步 */}
      <Menu.Item key="single_step">
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', minWidth: '200px' }}>
          <span>🎯</span>
          <div style={{ flex: 1 }}>
            <div style={{ 
              fontWeight: smartConfig.executionChain === 'single_step' ? '600' : '400',
              color: smartConfig.executionChain === 'single_step' ? '#6E8BFF' : 'inherit'
            }}>
              智能·单步
            </div>
            <div style={{ fontSize: '11px', color: '#64748B', marginTop: '2px' }}>
              指定某一步强制使用
            </div>
          </div>
          {smartConfig.executionChain === 'single_step' && (
            <span style={{ color: '#10B981' }}>✅</span>
          )}
        </div>
      </Menu.Item>

      {/* 静态策略 - 子菜单 */}
      <Menu.SubMenu
        key="static_strategy"
        title={
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', minWidth: '200px' }}>
            <span>📌</span>
            <div style={{ flex: 1 }}>
              <div style={{ 
                fontWeight: smartConfig.executionChain === 'static_strategy' ? '600' : '400',
                color: smartConfig.executionChain === 'static_strategy' ? '#6E8BFF' : 'inherit'
              }}>
                静态策略
              </div>
              <div style={{ fontSize: '11px', color: '#64748B', marginTop: '2px' }}>
                用户保存/自建的固定策略
              </div>
            </div>
            {smartConfig.executionChain === 'static_strategy' && (
              <span style={{ color: '#10B981' }}>✅</span>
            )}
          </div>
        }
        popupClassName="execution-chain-submenu"
      >
        {/* 结构匹配 */}
        <Menu.Item 
          key="structural_matching"
          onClick={() => {
            console.log('📌 [ActionSelector] 选择静态策略: structural_matching');
            setStructuralMatchingVisible(true);
          }}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', minWidth: '180px' }}>
            <span>🏗️</span>
            <div style={{ flex: 1 }}>
              <div>结构匹配</div>
              <div style={{ fontSize: '10px', color: '#64748B', marginTop: '2px' }}>
                基于元素结构相似度匹配
              </div>
            </div>
          </div>
        </Menu.Item>

        {/* XPath恢复 */}
        <Menu.Item 
          key="xpath_recovery"
          onClick={() => {
            console.log('🔧 XPath恢复功能待实现');
          }}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', minWidth: '180px' }}>
            <span>🔧</span>
            <div style={{ flex: 1 }}>
              <div>XPath恢复</div>
              <div style={{ fontSize: '10px', color: '#64748B', marginTop: '2px' }}>
                智能恢复损坏的XPath
              </div>
            </div>
          </div>
        </Menu.Item>
      </Menu.SubMenu>
    </Menu>
  );
};
```

### 修改 Dropdown 调用

```typescript
<Dropdown 
  overlay={getExecutionChainMenu()}  // ← 改用 overlay
  trigger={['click']}
  placement="bottomLeft"
>
  <Button>...</Button>
</Dropdown>
```

## 📌 重要提示

如果使用 Ant Design 5.x，需要这样：

```typescript
<Dropdown 
  menu={{ items: getExecutionChainMenuItems() }}  // 使用 menu.items
  dropdownRender={(menu) => menu}  // 自定义渲染
  trigger={['click']}
>
  <Button>...</Button>
</Dropdown>
```

---

**需要我直接修改你的文件吗？**我可以帮你实现这个修复。