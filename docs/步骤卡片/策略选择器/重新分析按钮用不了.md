å…ˆç»™ä½ ä¸€ä¸ª**å®šä½â†’ä¿®å¤**çš„â€œçŸ­è·¯å¾„â€ã€‚ä½ ç°åœ¨çœ‹åˆ°çš„â€œğŸ”„ é‡æ–°åˆ†æâ€æ˜¯ç¦ç”¨æ€ï¼Œé€šå¸¸æ˜¯è¢«è¿™å‡ ç±»æ¡ä»¶**å¡ä½**äº†ï¼ˆåªè¦å‘½ä¸­ä»»ä¸€æ¡ï¼ŒæŒ‰é’®å°±ä¼šè¢« `disabled`ï¼‰ï¼š

### å¸¸è§å¡ç‚¹ï¼ˆå…ˆæ’æŸ¥è¿™ 6 æ¡ï¼‰

1. **çŠ¶æ€é”**ï¼šå½“å‰æ­¥éª¤ `status === 'analyzing'`ï¼ˆæˆ–æœ‰è¿›åº¦æ¡åœ¨è·‘ï¼‰ï¼ŒUI ä¼šç¦ç”¨é˜²æ­¢é‡å¤è§¦å‘ã€‚
2. **ç¼ºå…³é”®å­—æ®µ**ï¼š`xmlHash` / `elementGlobalXPath` / `currentStrategy` ä»»æ„ç¼ºå¤±ï¼Œåˆ¤ä¸ºä¸å¯é‡ç®—ã€‚
3. **æ²¡æŒ‚å›è°ƒ**ï¼š`<StepCard onReanalyze={...} />` æ²¡ä¼ æˆ–ä¼ äº†ä¸ªç©ºå‡½æ•°ï¼ŒUI æŒ‰â€œä¸å¯ç”¨â€ã€‚
4. **ç‰¹æ€§å¼€å…³å…³é—­**ï¼šå¦‚ `ENABLE_REANALYZE_BUTTON === false` æˆ–â€œåªåœ¨ ready æ—¶æ˜¾ç¤ºâ€ã€‚
5. **åç«¯ä¸åœ¨çº¿**ï¼šå¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆHTTP 5xx/è¶…æ—¶ï¼‰ï¼Œå‰ç«¯æŠŠæŒ‰é’®ç½®ç°ï¼›
6. **å¹¶å‘ä¿æŠ¤**ï¼šæœ‰â€œåŒä¸€ elementId é™åˆ¶åŒæ—¶åªå…è®¸è¿è¡Œ 1 ä¸ªâ€å¼€å…³ï¼Œä¸Šæ¬¡æ²¡æ­£ç¡® `finalize`ï¼Œå¯¼è‡´ä¸€ç›´è¢«è§†ä¸ºâ€œåœ¨è·‘â€ã€‚

> ä½ çš„ä»“åº“é‡Œå·²ç»æœ‰â€œæ­¥éª¤å¡ç‰‡é‡æ„å®Œæˆ / åˆ†æå‰åç«¯é›†æˆå®Œæˆâ€è¿™äº›æ–‡æ¡£å’Œè„šæœ¬ï¼Œè¯´æ˜é“¾è·¯åŸºæœ¬é½äº†ï¼Œåªå·®æŠŠ**é‡æ–°åˆ†æçš„å…¥å£**å½»åº•æ‰“é€šã€‚ä»“åº“æ ¹ç›®å½•å°±èƒ½çœ‹åˆ°è¿™äº›æ–‡ä»¶åï¼ˆæ¯”å¦‚ `STEP_CARD_REFACTOR_COMPLETED.md`ã€`Gitæäº¤æ‘˜è¦-æ™ºèƒ½åˆ†æå‰åç«¯é›†æˆå®Œæˆ.md` ç­‰ï¼‰ã€‚([GitHub][1])

---

## ä¸€æ¬¡æ€§æ‰“é€šâ€œé‡æ–°åˆ†æâ€çš„æœ€å°æ”¹åŠ¨ï¼ˆå‰ç«¯ 3 å¤„ + åç«¯ 1 ä¸ªè·¯ç”±ï¼‰

### 1) æŒ‰é’®â€œå¯ç‚¹â€åˆ¤å®šï¼ˆUIï¼‰

æŠŠç¦ç”¨æ¡ä»¶**åª**ä¿ç•™å¿…è¦çš„ä¸‰é¡¹ï¼š**ä¸åœ¨è·‘**ã€**å­—æ®µé½**ã€**åç«¯å¥åº·**ã€‚

```tsx
// StepCard.tsxï¼ˆç‰‡æ®µï¼‰
const needs = [
  !!xmlInfo?.xmlHash,
  !!elementGlobalXPath,
  !!currentStrategy,
];
const canClickReanalyze = status !== 'analyzing' && needs.every(Boolean) && backendHealthy;

<Button
  size="sm"
  variant="outline"
  onClick={handleReanalyze}
  disabled={!canClickReanalyze}
  className="gap-1"
>
  ğŸ”„ é‡æ–°åˆ†æ
</Button>
```

> å¦‚æœç°åœ¨ä½ çš„æŒ‰é’®æ˜¯ä¸€ç›´ `disabled`ï¼Œå¤§å¤šæ˜¯ `status` æ²¡ä» `'analyzing'` æ”¶å°¾å›åˆ° `'ready'`ï¼Œæˆ– `xmlHash/elementGlobalXPath` ä¸ºç©ºã€‚å…ˆåœ¨æ§åˆ¶å°çœ‹è¿™ä¿©å€¼ã€‚

### 2) æŒ‚ä¸ŠçœŸæ­£çš„å›è°ƒï¼ˆè°ƒç”¨æ™ºèƒ½åˆ†æåç«¯ï¼‰

æ–°å¢**å®¢æˆ·ç«¯ API**å°è£…ï¼ˆæˆ–å¤ç”¨ä½ å·²æœ‰çš„ analysis å®¢æˆ·ç«¯ï¼‰ï¼ŒæŠŠæ­¥éª¤æ‰€éœ€çš„â€œæœ€å°è‡ªæ´½ä¸Šä¸‹æ–‡â€å‘ç»™åç«¯ï¼š

```ts
// src/lib/analysisClient.ts
import axios from 'axios';
import type { StrategyChoice } from '@/types/step-bundle';

export async function reanalyzeStep(payload: {
  stepId: string;
  xmlHash: string;                 // ç”¨äºæœåŠ¡å™¨å–åŸå§‹XML
  elementGlobalXPath: string;
  strategy: StrategyChoice;        // smart.auto / smart.single-step / static
}) {
  const { data } = await axios.post('/api/analysis/reanalyze', payload);
  return data as {
    status: 'ready'|'defaulted'|'failed';
    locatorChosen?: { type: 'XPath'|'CSS'|'AccessibilityId'; value: string };
    metrics?: { confidence?: number; candidates?: number; latencyMs?: number };
    defaultedReason?: string;
  };
}

export async function healthcheck() {
  try { await axios.get('/api/analysis/health'); return true; } catch { return false; }
}
```

åœ¨ `StepCard` é‡Œç”¨å®ƒï¼š

```tsx
const [backendHealthy, setBackendHealthy] = useState(true);

useEffect(() => { healthcheck().then(setBackendHealthy); }, []);

async function handleReanalyze() {
  setStatus('analyzing');
  try {
    const res = await reanalyzeStep({
      stepId,
      xmlHash: xmlInfo!.xmlHash,
      elementGlobalXPath: elementGlobalXPath!,
      strategy: currentStrategy,
    });
    setStatus(res.status);
    setMetrics(res.metrics);
    setPreview(res.locatorChosen && {
      locatorType: res.locatorChosen.type,
      locator: res.locatorChosen.value,
    });
    setDefaultedReason(res.defaultedReason);
  } catch (e) {
    setStatus('failed');
  }
}
```

### 3) è§¦å‘å‰çš„â€œå…œåº•æ”¶å°¾â€

ç¡®ä¿**ä¸Šä¸€æ¬¡**åˆ†æè‹¥å¼‚å¸¸é€€å‡ºï¼Œèƒ½åœ¨å‰ç«¯æ”¶å°¾æŠŠ `status` æ”¹å›é `'analyzing'`ï¼Œå¦åˆ™æŒ‰é’®æ°¸è¿œç°ã€‚

```ts
// è¿›å…¥å¡ç‰‡æˆ–è·¯ç”±åˆ‡æ¢æ—¶åšä¸€æ¬¡çŠ¶æ€å›æ­£
useEffect(() => {
  if (status === 'analyzing' && progress === 0) {
    // ä¸Šæ¬¡å¯èƒ½ä¸­æ–­äº†ï¼Œå¤ä½åˆ° defaultedï¼Œå…è®¸é‡è¯•
    setStatus('defaulted');
    setDefaultedReason('ä¸Šæ¬¡åˆ†ææœªå®Œæˆï¼Œå·²å¤ä½ï¼Œå¯é‡æ–°åˆ†æ');
  }
}, []);
```

### 4) åç«¯æœ€å°è·¯ç”±ï¼ˆæŠŠ XML/å¿«ç…§â†’é‡ç®—â†’è¿”å›å®šä½å™¨ï¼‰

å¦‚æœä½ å·²ç»åœ¨â€œç‚¹é€‰å…ƒç´ æ—¶â€æœ‰ä¸€å¥—åˆ†ææµç¨‹ï¼Œé‚£ä¹ˆâ€œé‡æ–°åˆ†æâ€è·¯ç”±å¯ä»¥**ç›´æ¥å¤ç”¨**é‚£å¥—ï¼Œåªæ˜¯**æŠŠè¾“å…¥ä»â€œå®æ—¶æŠ“å–â€æ”¹ä¸ºâ€œæŒ‰ xmlHash å–å¿«ç…§**â€ã€‚

ä¼ªä»£ç ï¼š

```ts
// server/routes/analysis.tsï¼ˆNode/Rust ä»»æ„ï¼Œè¿™é‡Œç”¨ Node ä¸¾ä¾‹ï¼‰
app.post('/api/analysis/reanalyze', async (req, res) => {
  const { xmlHash, elementGlobalXPath, strategy } = req.body;

  // 1) æ‹¿åŸå§‹XMLï¼ˆæœ¬åœ°ç¼“å­˜/å¯¹è±¡å­˜å‚¨ï¼‰
  const xml = await loadXmlByHash(xmlHash);       // è‹¥ä¸ºç©º â†’ 404

  // 2) è·‘æ™ºèƒ½ç­–ç•¥ï¼ˆè‡ªåŠ¨é“¾ or å•æ­¥ or é™æ€ï¼‰
  const result = await runStrategy({ xml, elementGlobalXPath, strategy });

  // 3) å°è£…å“åº”ï¼ˆå®šä½å™¨ + ç½®ä¿¡åº¦ + å€™é€‰æ•° + è€—æ—¶ï¼‰
  return res.json({
    status: result.defaulted ? 'defaulted' : (result.ok ? 'ready' : 'failed'),
    locatorChosen: result.locator && { type: result.locator.type, value: result.locator.value },
    metrics: result.metrics,
    defaultedReason: result.defaultedReason,
  });
});
```

---

## æ€æ ·â€œåœ¨ git é‡ŒæŸ¥ä¸ºä»€ä¹ˆè¢«ç¦ç”¨â€ï¼Ÿ

**å°±åœ°æ’æŸ¥å‘½ä»¤**ï¼ˆåœ¨ä»“åº“æ ¹ç›®å½•ï¼‰ï¼š

```bash
# 1) æ‰¾åˆ°æ‰€æœ‰â€œé‡æ–°åˆ†æ / reanalyzeâ€ç›¸å…³æŒ‰é’®/æ ‡è¯†
git grep -nE "é‡æ–°åˆ†æ|reanaly|onReanalyze|canReanalyze|ENABLE_REANALYZE"

# 2) çœ‹è°ç»™å®ƒåŠ äº† disabled
git grep -nE "disabled\s*=\s*"

# 3) æŸ¥æ¡ä»¶æ¥æº
git grep -nE "status\s*===\s*'analyzing'|xmlHash|elementGlobalXPath|backendHealthy"

# 4) æœ€è¿‘æ”¹åŠ¨å†å²
git log -n 20 --pretty=oneline -- src | cat
```

**å…¸å‹ç»“æœè§£é‡Š**ï¼ˆä½ å¯èƒ½ä¼šçœ‹åˆ°ç±»ä¼¼å‡ ç§å†™æ³•ï¼‰ï¼š

* `disabled={status !== 'ready'}` â†’ åªå…è®¸ ready æ—¶ç‚¹ï¼ˆè¿‡ä¸¥ï¼Œæ”¹æˆä¸Šé¢â€œæœ€å°ä¸‰é¡¹â€åˆ¤å®šï¼‰
* `disabled={!xmlHash || !elementGlobalXPath}` â†’ å­—æ®µç¼ºï¼Œè¿½è¸ªæ˜¯è°æ²¡å†™è¿›å»
* `disabled={!backendHealthy}` â†’ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå…ˆ `curl /api/analysis/health` çœ‹åç«¯
* `disabled={isBusy(stepId)}` â†’ ä¸Šæ¬¡æ²¡ finalizeï¼Œä¿®å¤ finalize æˆ–åŠ å¤ä½é€»è¾‘

---

## ä¸€é”®éªŒè¯æµç¨‹ï¼ˆç‚¹ç‚¹å°±çŸ¥é“å¥½äº†æ²¡ï¼‰

1. æ‰“å¼€ä»»ä¸€æ­¥éª¤å¡ç‰‡ï¼Œç¡®è®¤æ ‡é¢˜å³ä¾§â€œXML èƒ¶å›Šâ€æ˜¾ç¤ºï¼ˆè¯´æ˜ `xmlHash` åœ¨ï¼‰ã€‚
2. å…³æ‰åå°åç«¯ï¼Œå†æ‰“å¼€ï¼Œç¡®ä¿ `backendHealthy` èƒ½æ„ŸçŸ¥å˜åŒ–ï¼ˆæŒ‰é’®ç½®ç°/å˜äº®ï¼‰ã€‚
3. ç‚¹â€œé‡æ–°åˆ†æâ€â†’ `status: analyzing` â†’ å‡ ç™¾ ms å†…å›åˆ° `ready/defaulted`ï¼Œé¢„è§ˆå®šä½å™¨ & ç½®ä¿¡åº¦åˆ·æ–°ã€‚
4. æ•…æ„åˆ æ‰ `elementGlobalXPath`ï¼ˆæˆ–ç”¨è°ƒè¯•å·¥å…·æ”¹ç©ºï¼‰ï¼ŒæŒ‰é’®åº”ç½®ç°ã€‚æ¢å¤åå¯ç‚¹ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æŠŠä¸Šé¢çš„**å‰ç«¯ç‰‡æ®µ**æ•´ç†æˆä¸‰ä¸ªå°è¡¥ä¸ï¼ˆ`analysisClient.ts`ã€`StepCard` çš„æŒ‰é’®é€»è¾‘ã€å¤ä½é€»è¾‘ï¼‰ï¼Œå†ç»™ä¸€ä¸ª**åç«¯æœ€å°è·¯ç”±**æ¨¡æ¿ï¼Œç›´æ¥è´´åˆ°ä½ çš„é¡¹ç›®é‡Œå°±èƒ½è·‘é€šâ€œé‡æ–°åˆ†æâ€ã€‚

[1]: https://github.com/ElonQian1/marketing-automation-desktop "GitHub - ElonQian1/marketing-automation-desktop: é€šç”¨è¥é”€è‡ªåŠ¨åŒ–å·¥å…·"
