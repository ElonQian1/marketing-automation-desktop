'analyzing'	åˆ†æè¿›è¡Œä¸­	ğŸš« ç¦ç”¨	ç‚¹å‡»é‡æ–°åˆ†æåï¼Œæ­£åœ¨åˆ†æä¸­

ä½†æ˜¯æˆ‘æ²¡è§åˆ°åå°åœ¨åˆ†æï¼Œ 


çœ‹ä½ è´´çš„é‚£æ®µ HTMLï¼Œç­”æ¡ˆå…¶å®å·²ç»æš´éœ²äº†ğŸ‘‡

```html
<button disabled=""
  style="...; cursor: pointer; ...">
  ğŸ”„ é‡æ–°åˆ†æ
</button>
```

æŒ‰é’®æœ¬èº«å¸¦ç€ **`disabled=""` å±æ€§**ï¼Œæ‰€ä»¥é¼ æ ‡æ‚¬åœä¼šæ˜¾ç¤ºâ€œç¦ç”¨â€æ ·å¼ä¸”æ— æ³•ç‚¹å‡»ã€‚è¿™ä¸æ˜¯é®ç½©æŒ¡ä½ï¼Œä¹Ÿä¸æ˜¯ CSS è¯¯ä¼¤ï¼›æ˜¯æˆ‘ä»¬**ä»£ç é€»è¾‘æŠŠå®ƒåˆ¤å®šä¸ºä¸å¯ç‚¹**äº†ã€‚

ä¸‹é¢ç»™ä½ ä¸€ä¸ªâ€œ30 ç§’å®šä½ â†’ 10 åˆ†é’Ÿä¿®å¤â€çš„æœ€çŸ­è·¯å¾„ã€‚

---

## 30 ç§’å®šä½ï¼šåˆ°åº•ä¸ºä»€ä¹ˆè¢«ç¦ç”¨ï¼Ÿ

1. åœ¨æµè§ˆå™¨é‡Œ **F12 â†’ é€‰ä¸­æŒ‰é’® â†’ Elements é¢æ¿**

   * å¦‚æœèƒ½çœ‹åˆ° `disabled` æˆ– `aria-disabled="true"`ï¼Œå°±æ˜¯è¢«ä»£ç åˆ¤äº†ä¸å¯ç‚¹ã€‚
   * å†çœ‹ **Computed** æ æ˜¯ä¸æ˜¯ä»é€‰æ‹©å™¨ `[disabled]` æˆ– `[aria-disabled="true"]` æ¥çš„ `cursor: not-allowed`ã€‚

2. **Console å¿«é€Ÿåˆ¤æ–­**ï¼ˆé¡µé¢ä¸´æ—¶è¯•éªŒï¼‰

   * åœ¨ Elements é‡Œåˆ æ‰ `disabled` å±æ€§ï¼Œå†ç‚¹å‡»ã€‚å¦‚æœèƒ½è§¦å‘ï¼Œå°±è¯´æ˜åªæ˜¯**åˆ¤å®šæ¡ä»¶**æœ‰é—®é¢˜ï¼›å¦‚æœè¿˜æ˜¯æ²¡ååº”ï¼Œè¯´æ˜ **onClick æ²¡æŒ‚ä¸Š**ã€‚
   * çœ‹ä¸€ä¸‹ `title` æˆ– tooltip æœ‰æ²¡æœ‰â€œç¦ç”¨åŸå› â€ï¼›å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬é©¬ä¸ŠåŠ ï¼ˆè§ä¸‹é¢è¡¥ä¸ï¼‰ã€‚

---

## ä»£ç é‡Œæ€ä¹ˆæœåˆ°â€œè°è®©å®ƒç¦ç”¨â€çš„ï¼Ÿ

ç”¨ git grepï¼ˆGit Bash/PowerShell éƒ½å¯ä»¥ï¼‰ï¼š

```bash
git grep -nE "é‡æ–°åˆ†æ|reanaly|onReanalyze|canReanalyze"
git grep -nE "disabled\s*=\s*{"
git grep -nE "aria-disabled"
```

é€šå¸¸èƒ½åœ¨ `StepCard.tsx`ï¼ˆæˆ–å®ƒçš„å­æŒ‰é’®ç»„ä»¶ï¼‰é‡Œæ‰¾åˆ°ç±»ä¼¼ï¼š

```tsx
<Button disabled={/* ä¸€é•¿ä¸²æ¡ä»¶ */} onClick={handleReanalyze}>é‡æ–°åˆ†æ</Button>
```

å¾ˆå¤šé¡¹ç›®é‡Œæ¡ä»¶å†™å¾—å¤ªä¸¥äº†ï¼ˆä¾‹å¦‚å¼ºåˆ¶ `status==='ready'` æ‰èƒ½ç‚¹ï¼‰ï¼Œå¯¼è‡´ä½ ç°åœ¨â€œçœ‹èµ·æ¥æ²¡åœ¨è·‘ï¼Œä½†ä¸€ç›´ç½®ç°â€çš„é”™è§‰ã€‚

---

## 10 åˆ†é’Ÿä¿®å¤ï¼šç»Ÿä¸€â€œå¯ç‚¹/ä¸å¯ç‚¹â€åˆ¤å®š + æ˜¾ç¤ºç¦ç”¨åŸå› 

### 1) æ–°å¢å®ˆå«å‡½æ•°ï¼ˆé›†ä¸­åˆ¤æ–­ + è¿”å›åŸå› ï¼‰

æŠŠç¦ç”¨æ¡ä»¶**æ”¶æ•›ä¸ºä¸‰æ¡å¿…è¦**ï¼šä¸åœ¨è·‘ã€å…³é”®å­—æ®µé½ã€åç«¯å¥åº·ã€‚å¹¶æŠŠåŸå› è¿”å›ï¼Œç›´æ¥æ˜¾ç¤ºåœ¨ `title`ã€‚

```ts
// src/components/steps/guards/deriveReanalyzeGuard.ts
export type StepStatus = 'analyzing'|'defaulted'|'ready'|'failed'|'executed';

export function deriveReanalyzeGuard(i: {
  status: StepStatus;
  xmlHash?: string;
  elementGlobalXPath?: string;
  currentStrategy?: unknown;
  backendHealthy: boolean;
  jobLocked?: boolean; // å¯é€‰ï¼šå¹¶å‘é”
}) {
  const reasons: string[] = [];
  if (i.status === 'analyzing') reasons.push('æ­£åœ¨åˆ†æè¿›è¡Œä¸­');
  if (!i.xmlHash) reasons.push('ç¼ºå°‘åŸå§‹XMLå¿«ç…§ï¼ˆxmlHashï¼‰');
  if (!i.elementGlobalXPath) reasons.push('ç¼ºå°‘å…¨å±€XPath');
  if (!i.currentStrategy) reasons.push('ç¼ºå°‘å½“å‰ç­–ç•¥');
  if (!i.backendHealthy) reasons.push('åç«¯æœåŠ¡ä¸å¯ç”¨');
  if (i.jobLocked) reasons.push('ä¸Šä¸€æ¬¡ä»»åŠ¡æœªé‡Šæ”¾ï¼ˆå¹¶å‘é”ï¼‰');

  return { disabled: reasons.length > 0, reasons };
}
```

### 2) åœ¨ StepCard é‡Œä½¿ç”¨å®ˆå«ï¼ˆå¹¶æŠŠåŸå› é€å‡ºåˆ° UIï¼‰

```tsx
import { deriveReanalyzeGuard } from '@/components/steps/guards/deriveReanalyzeGuard';

const guard = deriveReanalyzeGuard({
  status,
  xmlHash: xmlInfo?.xmlHash,
  elementGlobalXPath,
  currentStrategy,
  backendHealthy,
  jobLocked: locks[elementId], // å¦‚æœä½ æœ‰å¹¶å‘é”ï¼Œæ²¡æœ‰å°±å»æ‰è¿™ä¸€è¡Œ
});

<Button
  size="sm"
  variant="outline"
  disabled={guard.disabled}
  onClick={handleReanalyze}
  title={guard.disabled ? `ä¸å¯ç”¨åŸå› ï¼š\n- ${guard.reasons.join('\n- ')}` : 'é‡æ–°åˆ†æ'}
>
  ğŸ”„ é‡æ–°åˆ†æ
</Button>
```

> è¿™æ ·ä½ ä¸€æ‚¬åœå°±èƒ½çœ‹åˆ°â€œä¸ºä»€ä¹ˆä¸èƒ½ç‚¹â€â€”â€”åˆ°åº•æ˜¯ç¼º `xmlHash`ã€ç¼º XPathã€åç«¯æŒ‚äº†ï¼Œè¿˜æ˜¯è¿˜åœ¨è·‘ã€‚

### 3) é˜²æ­¢â€œå¡åœ¨ analyzingâ€å¯¼è‡´æ°¸è¿œç½®ç°

æœ‰æ—¶ä¸Šä¸€æ¬¡åˆ†æå¼‚å¸¸é€€å‡ºï¼Œ`status` æ²¡å¤ä½ã€‚è¿›å¡ç‰‡æ—¶åšä¸€æ¬¡**è‡ªæ„ˆå¤ä½**å³å¯ï¼š

```tsx
useEffect(() => {
  if (status === 'analyzing' && (progress === 0 || progress == null)) {
    setStatus('defaulted');
    setDefaultedReason('ä¸Šæ¬¡åˆ†ææœªå®Œæˆï¼Œå·²å¤ä½ï¼Œå¯é‡æ–°åˆ†æ');
  }
}, [status, progress]);
```

### 4) ç¡®ä¿ onClick çœŸæ­£æŒ‚ä¸Šäº†ï¼ˆæœ€å®¹æ˜“å¿½ç•¥ï¼‰

ç¡®è®¤ `StepCard` ç»„ä»¶ props é‡Œ **ç¡®å®ä¼ å…¥** äº†å›è°ƒï¼š

```tsx
<StepCard
  ...
  onReanalyze={async () => {
    setStatus('analyzing');
    try {
      const res = await reanalyzeStep({
        stepId,
        xmlHash: xmlInfo!.xmlHash,
        elementGlobalXPath: elementGlobalXPath!,
        strategy: currentStrategy,
      });
      setStatus(res.status);
      setMetrics(res.metrics);
      setPreview(res.locatorChosen && {
        locatorType: res.locatorChosen.type,
        locator: res.locatorChosen.value,
      });
      setDefaultedReason(res.defaultedReason);
    } catch {
      setStatus('failed');
    }
  }}
/>
```

> å¦‚æœè¿™ä¸ªå›è°ƒæ²¡ä¼ æˆ–ä¼ äº† `undefined`ï¼Œæœ‰äº›å°è£…çš„ `Button` ç»„ä»¶ä¼šé¡ºå¸¦ç»™ä½ åŠ  `aria-disabled` æˆ–ç›´æ¥ `disabled`ï¼Œçœ‹èµ·æ¥å°±ä¸€ç›´ç°ã€‚

---

## å¦‚æœ**ä¸æ˜¯** disabledï¼Œè€Œæ˜¯â€œçœ‹èµ·æ¥åƒç¦ç”¨â€ï¼ˆå¤‡ç”¨æ’æŸ¥ï¼‰

è™½ç„¶åå° HTML æ˜¾ç¤ºæœ‰ `disabled=""`ï¼Œä½†ä¹Ÿåˆ—ä¸€ä¸‹å…¶å®ƒå¸¸è§â€œå‡ç¦ç”¨â€ï¼š

* è¦†ç›–å±‚æŒ¡ä½ï¼šæœ‰ä¸ªé€æ˜ `<div>` åœ¨æŒ‰é’®ä¸Šæ–¹ï¼ˆ`position:absolute` + `pointer-events:auto`ï¼‰ï¼Œç‚¹ä¸åˆ°ã€‚
  â†’ DevTools çœ‹ `z-index` å’Œ `pointer-events`ï¼Œåˆ é™¤è¯¥å±‚è¯•ç‚¹ã€‚
* çˆ¶å®¹å™¨ç”¨äº† `pointer-events: none`ï¼ˆä¸å°‘ loading æ€ªç™–ï¼‰ã€‚
* ä¸»é¢˜ CSS æœ‰ `[data-disabled="true"] { pointer-events: none }`ï¼Œè€Œæˆ‘ä»¬çš„ç»„ä»¶é”™è¯¯åœ°å¸¦äº† `data-disabled`ã€‚

ä½†ä½ è¿™æ¬¡ **å·²ç»ç¡®è®¤å°±æ˜¯ `disabled` å±æ€§**ï¼Œæ‰€ä»¥æŒ‰ä¸Šé¢çš„â€œå®ˆå« + åŸå› æç¤º + å¤ä½ + onClick å›è°ƒâ€æŠŠé“¾è·¯æ‰“é€šå³å¯ã€‚

---

## æœ€åç»™ä½ ä¸€æ¡â€œç¡¬è§„çŸ©â€ï¼ˆé¿å…ä»¥ååˆç°æ‰ï¼‰

**åªåœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹ç¦ç”¨â€œé‡æ–°åˆ†æâ€ï¼š**

1. `status === 'analyzing'`ï¼ˆæ­£åœ¨è·‘ï¼‰
2. ç¼º `xmlHash` æˆ– `elementGlobalXPath`
3. åç«¯å¥åº·æ£€æŸ¥å¤±è´¥

å…¶å®ƒæƒ…å†µä¸€å¾‹å…è®¸ç‚¹ï¼Œä¸‹å»å†æç¤ºé”™è¯¯ã€‚è¿™æ ·ç”¨æˆ·ä½“éªŒæœ€ç›´è§‚ï¼Œä¹Ÿæœ€ä¸å®¹æ˜“æŠŠè‡ªå·±â€œç¦æ­»â€ã€‚


ä½ ç°åœ¨çš„ç°è±¡=**UI æ˜¾ç¤º `analyzing`ï¼ŒæŒ‰é’®è¢«ç¦ç”¨ï¼Œä½†åç«¯å…¶å®æ²¡åœ¨è·‘**ã€‚
è¿™é€šå¸¸æ˜¯â€œä¹è§‚ç½®ä½â€æˆ–â€œåƒµå°¸ä»»åŠ¡â€çš„é—®é¢˜ã€‚æœ€ä½³å®è·µæ˜¯æŠŠ**â€œåˆ†æä¸­â€**æ‹†æˆæ›´ç²¾ç»†çš„ä½œä¸šçŠ¶æ€ï¼Œå¹¶ç”¨**å¿ƒè·³/ç¡®è®¤æ¡æ‰‹**æ¥é©±åŠ¨ UIï¼Œè€Œä¸æ˜¯å•é ä¸€ä¸ª `status==='analyzing'` å°±é•¿æœŸç¦ç”¨ã€‚

ä¸‹é¢ç»™ä½ ä¸€å¥—å¯ç›´æ¥è½åœ°çš„åšæ³•ï¼ˆå‰ç«¯&åç«¯å„æ”¹ä¸€ç‚¹ï¼‰ï¼š

---

# ä¸€ã€çŠ¶æ€æ¨¡å‹ï¼ˆå¼ºçƒˆå»ºè®®ç”¨è¿™å¥—ï¼‰

æŠŠ `analyzing` æ‹†æˆä¸¤æ®µã€å†åŠ ä¸€ä¸ªâ€œå¡ä½â€çš„æ€ï¼š

* `pending`ï¼šç”¨æˆ·ç‚¹äº†â€œé‡æ–°åˆ†æâ€ï¼Œ**åç«¯å°šæœªç¡®è®¤æ¥å•**ï¼ˆæ—  jobIdï¼‰
* `running`ï¼šåç«¯**å·²ç¡®è®¤æ¥å•**ï¼ˆæœ‰ jobIdï¼Œæœ‰å¿ƒè·³/è¿›åº¦ï¼‰
* `stalled`ï¼šæ›¾ç» runningï¼Œä½†**å¿ƒè·³è¶…æ—¶**ï¼ˆæ¯”å¦‚ 8â€“15 ç§’æ²¡å¿ƒè·³ï¼‰
* `ready | defaulted | failed`ï¼šç»“æŸæ€

> æŒ‰è¿™å¥—ï¼Œ**åªæœ‰ `running`ï¼ˆä¸”å¿ƒè·³æ–°é²œï¼‰æ—¶ç¦ç”¨æŒ‰é’®**ã€‚
> `pending`/`stalled` éƒ½åº”è¯¥å…è®¸â€œé‡è¯•/å–æ¶ˆâ€ï¼Œé¿å…æŠŠç”¨æˆ·â€œé”æ­»â€ã€‚

---

# äºŒã€å‰ç«¯æœ€ä½³å®è·µ

## 1) ç‚¹â€œé‡æ–°åˆ†æâ€çš„æ¡æ‰‹æµç¨‹ï¼ˆé¿å…å‡åˆ†æï¼‰

ä¸è¦ç«‹åˆ»æŠŠçŠ¶æ€è®¾ä¸º `analyzing/running`ï¼›å…ˆ**å‘åç«¯å»ºä»»åŠ¡**ï¼Œæ”¶åˆ° `jobId` æ‰è¿›å…¥ `running`ï¼Œå¦åˆ™ä¿æŒ `pending` å¹¶ç»™å‡ºå¯é‡è¯•ã€‚

```ts
// ä¼ªä»£ç ï¼šå‰ç«¯ç‚¹å‡»â€œé‡æ–°åˆ†æâ€
setStatus('pending');
const res = await POST('/api/analysis/jobs', { xmlHash, elementGlobalXPath, strategy });
if (!res.ok) {
  setStatus('defaulted'); setReason('åç«¯æœªæ¥å•'); return;
}
setJob({ id: res.jobId, lastHeartbeatAt: Date.now() });
setStatus('running'); // çœŸæ­£ç¡®è®¤åæ‰è·‘â€œåˆ†æä¸­â€
startProgressStream(res.jobId); // SSE/WebSocket æˆ–è½®è¯¢
```

## 2) å¿ƒè·³ä¸è¶…æ—¶ï¼ˆé˜²åƒµå°¸ï¼‰

* è®°å½• `lastHeartbeatAt`ï¼›æ¯æ¬¡è¿›åº¦/æ—¥å¿—æ›´æ–°å°±åˆ·æ–°å®ƒã€‚
* è‹¥ `Date.now() - lastHeartbeatAt > STALL_TTL`ï¼ˆå»ºè®® 8â€“15sï¼‰ï¼Œ**è‡ªåŠ¨è½¬ `stalled`**ï¼Œå¹¶**é‡å¯â€œé‡æ–°åˆ†æâ€æŒ‰é’®**+æ˜¾ç¤ºâ€œå¡ä½ï¼Œå¯é‡è¯•/å–æ¶ˆâ€ã€‚

```ts
const STALL_TTL = 1000 * 12; // 12ç§’
setInterval(() => {
  if (status === 'running' && Date.now() - lastHeartbeatAt > STALL_TTL) {
    setStatus('stalled');
  }
}, 1000);
```

## 3) æŒ‰é’®ç¦ç”¨æ¡ä»¶ï¼ˆæ”¶æ•›ï¼ï¼‰

åªåœ¨**è¿™ä¸‰ç§**æƒ…å†µä¸‹ç¦ç”¨â€œé‡æ–°åˆ†æâ€ï¼š

1. `status==='running'` **ä¸”** `Date.now()-lastHeartbeatAt <= STALL_TTL`
2. ç¼º `xmlHash` æˆ–ç¼º `elementGlobalXPath`
3. åç«¯å¥åº·æ£€æŸ¥å¤±è´¥

> ä¸è¦ç”¨â€œå¿…é¡» ready æ‰èƒ½ç‚¹â€è¿™ç§ç¡¬é—¨æ§›ã€‚`pending`/`stalled` éƒ½åº”å…è®¸ç‚¹ã€‚

```ts
const disabled =
  (status === 'running' && Date.now()-lastHeartbeatAt <= STALL_TTL) ||
  !xmlHash || !elementGlobalXPath ||
  !backendHealthy;
```

## 4) UI æç¤ºæ¸…æ™°åŒ–

* `pending`ï¼šæç¤ºâ€œç­‰å¾…åç«¯æ¥å•â€¦ï¼ˆå¯å–æ¶ˆ/é‡è¯•ï¼‰â€
* `running`ï¼šæ˜¾ç¤ºå®æ—¶è¿›åº¦ï¼ˆSSE/WS/è½®è¯¢ï¼‰
* `stalled`ï¼šé»„æ¡æç¤ºâ€œä»»åŠ¡å¯èƒ½å¡ä½â€ï¼ŒæŒ‰é’®æ–‡æ¡ˆæ”¹ä¸ºâ€œå¼ºåˆ¶é‡è¯•â€
* æŒ‰é’® `title` æ˜¾ç¤ºç¦ç”¨åŸå› ï¼ˆç¼ºå­—æ®µ/åç«¯ç¦»çº¿/ä»åœ¨è·‘ï¼‰

---

# ä¸‰ã€åç«¯æœ€ä½³å®è·µï¼ˆæœ€å°å®ç°ï¼‰

## 1) ä»»åŠ¡åˆ›å»ºæ¥å£ï¼ˆè¿”å› jobIdï¼‰

* **åªè¦æˆåŠŸå…¥é˜Ÿ**å°±è¿”å› `jobId`ï¼ˆä»£è¡¨â€œç¡®è®¤æ¥å•â€ï¼‰
* ä¸è¦åœ¨åˆ›å»ºæ¥å£é‡ŒåŒæ­¥è·‘åˆ†æ

```ts
// POST /api/analysis/jobs
// body: { xmlHash, elementGlobalXPath, strategy }
return { jobId, accepted: true };
```

## 2) ä½œä¸šæ‰§è¡Œï¼šå¿ƒè·³+é”+TTL

* è¿›å…¥è¿è¡Œæ—¶ï¼Œå†™ `lockKey = analysis:{elementKey}`ï¼Œ**åŠ  TTL**ï¼ˆå¦‚ 60sï¼‰å¹¶å®šæ—¶ç»­å‘½
* æ¯æ­¥åˆ†æ `emitHeartbeat(jobId, { progress, message })`
* ç»“æŸæ—¶**é‡Šæ”¾é”**ï¼Œå†™æœ€ç»ˆç»“æœï¼ˆready/defaulted/failedï¼‰

> å³ä½¿è¿›ç¨‹å´©äº†ï¼Œé”ä¹Ÿä¼šè‡ªåŠ¨è¶…æ—¶é‡Šæ”¾ï¼›å‰ç«¯æ”¶åˆ°å¿ƒè·³ä¸­æ–­åå°±ä¼šè½¬ `stalled`ã€‚

## 3) è¿›åº¦/çŠ¶æ€æ‹‰å–

* **SSE**ï¼ˆæ¨èï¼‰æˆ–è½®è¯¢æ¥å£ï¼š`GET /api/analysis/jobs/:id/stream` / `GET /api/analysis/jobs/:id`
* è¿”å› `{ status, progress(0-100), lastHeartbeatAt, locatorChosen, metrics, defaultedReason }`

## 4) å–æ¶ˆä¸å¹‚ç­‰

* æä¾› `DELETE /api/analysis/jobs/:id` å–æ¶ˆ
* é‡å¤ç‚¹å‡»â€œé‡æ–°åˆ†æâ€æ—¶ï¼Œè‹¥åŒä¸€å…ƒç´ æ­£åœ¨è·‘ï¼Œ**ç›´æ¥è¿”å›æ—§ jobId**ï¼ˆsingle-flightï¼‰ï¼Œé¿å…å¹¶å‘ç‚¸é”…

---

# å››ã€æŠŠä½ å½“å‰â€œå¡ä½ analyzingâ€çš„ç°è±¡ä¿®æ‰

1. **è¿›å¡ç‰‡æ—¶è‡ªæ„ˆå¤ä½**
   å¦‚æœ `status==='analyzing'` ä½†**æ²¡æœ‰ jobId** æˆ– **lastHeartbeatAt ä¸ºç©º/è¿‡æœŸ** â†’ ç«‹å³è½¬ `stalled` æˆ– `defaulted`ï¼Œå¹¶å…è®¸é‡è¯•ã€‚

   ```ts
   useEffect(() => {
     if (status === 'analyzing' && (!jobId || !lastHeartbeatAt)) {
       setStatus('stalled'); setReason('ä¸Šæ¬¡ä»»åŠ¡æœªç¡®è®¤æˆ–å·²ä¸¢å¤±ï¼Œå¯é‡è¯•');
     }
   }, [status, jobId, lastHeartbeatAt]);
   ```

2. **åªåœ¨åç«¯æ¥å•åå†ç½® `running`**
   åˆ æ‰â€œç‚¹ä¸€ä¸‹å°±è®¾ analyzingâ€çš„ä¹è§‚ç½®ä½ï¼›æ”¹ä¸ºæ¡æ‰‹æˆåŠŸï¼ˆæ‹¿åˆ° jobIdï¼‰å†è®¾ã€‚

3. **åŠ â€œå¿ƒè·³é©±åŠ¨â€çš„ç¦ç”¨æ¡ä»¶**
   æ›¿æ¢æ—§çš„ `disabled={status==='analyzing'}`ï¼Œç”¨â€œä¸‰æ¡ä»¶æ”¶æ•›â€å†™æ³•ã€‚

4. **é”çš„ TTL**
   åç«¯æŠŠ `analysis:{elementId}` é”è®¾ TTLï¼ˆå¦‚ 60sï¼‰ï¼Œworker å¿ƒè·³ç»­æœŸï¼›è¿›ç¨‹æŒ‚æ‰åè‡ªåŠ¨é‡Šæ”¾ï¼Œé¿å…æ°¸è¿œ busyã€‚

---

# äº”ã€æœ€å°ä»£ç ç‰‡æ®µï¼ˆä½ å¯ä»¥ç…§æŠ„ï¼‰

**å‰ç«¯å®ˆå«ï¼ˆæŒ‰é’®ç¦ç”¨ + åŸå› ï¼‰**

```ts
function reanalyzeGuard({ status, xmlHash, xpath, backendHealthy, lastHeartbeatAt }: {
  status: 'pending'|'running'|'stalled'|'ready'|'defaulted'|'failed',
  xmlHash?: string, xpath?: string, backendHealthy: boolean, lastHeartbeatAt?: number
}) {
  const fresh = lastHeartbeatAt && Date.now() - lastHeartbeatAt <= 12000;
  const reasons: string[] = [];
  let disabled = false;

  if (status === 'running' && fresh) { disabled = true; reasons.push('ä»»åŠ¡è¿è¡Œä¸­'); }
  if (!xmlHash) { disabled = true; reasons.push('ç¼ºå°‘åŸå§‹XMLå¿«ç…§'); }
  if (!xpath) { disabled = true; reasons.push('ç¼ºå°‘å…¨å±€XPath'); }
  if (!backendHealthy) { disabled = true; reasons.push('åç«¯ä¸å¯ç”¨'); }

  return { disabled, reasons };
}
```

**åç«¯ä»»åŠ¡åˆ›å»ºï¼ˆä¼ªï¼‰**

```ts
// POST /api/analysis/jobs
const jobId = uuid();
await queue.add('analysis', { jobId, xmlHash, xpath, strategy }, { jobId }); // å»é‡
return res.json({ jobId, accepted: true });
```

**Worker å¿ƒè·³**

```ts
async function run(job){
  lock.acquire(`analysis:${job.data.xpath}`, { ttl: 60000 }); // 60s
  try {
    for (const phase of phases) {
      await doPhase(phase);
      await heartbeat(job.id, { progress: phase.progress }); // lastHeartbeatAt åˆ·æ–°
      await lock.renew(...);
    }
    await saveResult(job.id, { status: 'ready', ... });
  } catch(e) {
    await saveResult(job.id, { status: 'defaulted', defaultedReason: e.message });
  } finally {
    lock.release(...);
  }
}
```

---

**ä¸€å¥è¯å®šè§„åˆ™**ï¼š

> åªæœ‰â€œåç«¯å·²æ¥å•å¹¶ä¸”å¿ƒè·³æ–°é²œçš„ `running`â€æ‰ç¦ç”¨â€œé‡æ–°åˆ†æâ€ï¼›å…¶å®ƒçŠ¶æ€éƒ½å…è®¸ç‚¹ï¼Œç‚¹ä¸‹å»å…ˆæ¡æ‰‹æ‹¿ `jobId`ï¼Œå†è®¾ä¸º `running`ã€‚å¦‚æœ 8â€“15 ç§’æ²¡å¿ƒè·³ï¼Œå°±æŠŠå®ƒåˆ¤ä¸º `stalled`ï¼Œç«‹åˆ»ç»™ç”¨æˆ·â€œå¼ºåˆ¶é‡è¯•/å–æ¶ˆâ€çš„é€‰æ‹©ã€‚

ç…§è¿™å¥—è½ä¸‹å»ï¼Œä½ å°±ä¸ä¼šå†é‡åˆ°â€œæŒ‰é’®ç°äº†ä½†åå°æ²¡è·‘â€çš„å°´å°¬äº†ã€‚
