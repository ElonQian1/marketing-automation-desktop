

太好了！你这套“点选元素 → 生成步骤卡片 → 带上原始 XML 快照 & 全局 XPath → 可分享再复现”的设计是对的。我把你刚才说的现状整理成一个**落地清单 + 代码接线位**，你照着对就能把“策略选择器 + 快照复现 + 导入导出”跑顺。

# 步骤卡片要包含的关键信息（与你现有实现对齐）

最少这几项要落到卡片的数据里（便于复现与分享）：

* `xmlHash` / `xmlCacheId` / `xmlCreatedAt`：指向当时的原始 XML 快照
* `elementGlobalXPath`：点选元素的**全局 XPath**
* `elementSignature`：冗余签名（`resourceId`、`class`、`text/contentDesc`、`bounds`、`indexPath`…）用于 XPath 失效时**二次重定位**
* `currentStrategy`：`smart.auto | smart.single-step(step) | static(id)`
* `locatorChosen` + `metrics(confidence, candidates, latencyMs)`
* `action` + `actionParams`（点击/输入/滑动/断言等）
* `status` + `defaultedReason`

> 你提到已经有 `XmlSnapshot`、`XmlCacheManager`、`useIntelligentStepCardIntegration`，很好——把上面这些字段在**创建步骤**时写进去即可。

---

## 1) StepCard 组件：把快照 & 策略塞进来（紧凑 UI，不占空间）

给 `StepCard` 增加这些 props（不改变你已有布局，只加“标题栏按钮 + 一行信息”）：

```ts
// src/components/steps/StepCard.tsx（片段）
export interface StepCardProps {
  // …你已有的
  xmlInfo?: {
    xmlHash: string;          // "sha256:xxxx"
    xmlCacheId?: string;      // 你缓存管理器里的 key
    xmlCreatedAt?: string;    // ISO 字符串
  };
  elementGlobalXPath?: string;
  elementSignature?: {
    class?: string;
    resourceId?: string;
    text?: string | null;
    contentDesc?: string | null;
    bounds?: string;
    indexPath?: number[];
  };
  onReloadOriginalXml?: (xmlCacheId: string) => void; // “重新载入原始XML”
}
```

**标题栏右侧**放一个“策略菜单 + 工具图标”的**紧凑条**（不占大面积）：

* 策略菜单（弹出）：“智能·自动链 / 智能·单步(子菜单 Step1~6) / 静态策略”
* 小图标：🔄 重新分析、📋 候选、🔍 检查器
* 快照胶囊：显示 `xmlHash` 前 7 位 + 时间，点击“重新载入原始 XML”

```tsx
// 标题工具区（片段）
<div className="flex items-center gap-2">
  <StrategyMenu value={currentStrategy} staticOptions={staticOptions} onChange={onStrategyChange}/>
  <button title="重新分析" onClick={onReanalyze}>🔄</button>
  <button title="查看候选" onClick={openCandidates}>📋</button>
  <button title="元素检查器" onClick={onOpenElementInspector}>🔍</button>

  {xmlInfo?.xmlHash && (
    <button
      title={`原始XML ${xmlInfo.xmlCreatedAt ?? ""}`}
      onClick={() => xmlInfo?.xmlCacheId && onReloadOriginalXml?.(xmlInfo.xmlCacheId)}
      className="text-xs px-2 py-1 border rounded"
    >
      XML {xmlInfo.xmlHash.slice(7, 14)} • {xmlInfo.xmlCreatedAt?.slice(11, 16) ?? ""}
    </button>
  )}
</div>
```

**主体区域**默认只占**一行**：显示定位器预览 + 置信度细条。需要看详细候选/说明，再点“展开详情”（折叠区）。

---

## 2) 创建步骤时把“快照 + XPath + 策略”写进去

在你提到的 `useIntelligentStepCardIntegration`（或等效创建逻辑）里，创建 `StepCardData` 时写入：

```ts
// src/pages/UniversalFinder/.../useIntelligentStepCardIntegration.ts（片段）
const step: StepCardData = {
  stepId: genId(),
  index,
  status: "analyzing",             // 初始
  xmlHash: snapshot.sha256,        // 来自 XmlCacheManager
  xmlCreatedAt: snapshot.createdAt,
  elementGlobalXPath: selected.globalXPath,
  elementSignature: {
    class: selected.className,
    resourceId: selected.resourceId,
    text: selected.text,
    contentDesc: selected.contentDesc,
    bounds: selected.bounds,
    indexPath: selected.indexPath,
  },
  currentStrategy: { kind: "smart", mode: "auto" },   // 默认智能·自动链
  metrics: undefined,
  action: "tap",
  actionParams: {},
};
```

> 注意：如果你已有 `enableStrategySelector: true` 的开关，那么 UI 会立刻显示“策略菜单”，不需要再铺一个大面板。

---

## 3) 复现（Rehydrate）：优先 XPath，失败走签名近似匹配

在还原执行或“重新点选”时：

1. 按 `xmlCacheId/xmlHash` 拉取当时的原始 XML
2. `elementGlobalXPath` 命中→OK；失败→按 `elementSignature` 做**相似匹配**（resourceId/class/text/bounds/indexPath + 兄弟/父子/邻近文本启发式）
3. 给出候选（0..n），用户可重新点选并更新策略

> 你的 `XmlCacheManager` 已经在了；把“还原定位”逻辑封装成 `rehydrateLocate(xmlDoc, step)` 即可。

---

## 4) 导入/导出“步骤包”（可分享）

你刚刚已经放了 `types/step-bundle.ts` 和 `lib/step-bundle.ts`，只差 UI 触发点：

* **导出**：把 `manifest.json + snapshots/<hash>.xml.gz` 打成 zip（建议放到 Tauri 后端做 `sha256 + gzip`，更快更稳）
* **导入**：解包→校验 `manifest.schemaVersion`→将 `snapshots` 放入你的 XML 缓存目录→渲染步骤列表

**最小 UI 接口**（放到 Universal UI 顶栏）：

```tsx
<Button onClick={exportCurrentFlowAsBundle}>导出步骤包</Button>
<Button onClick={importBundleFromFile}>从步骤包导入</Button>
```

---

## 5) QA 冒烟清单（建议你立刻加 e2e）

1. 点选元素 → 生成卡片：标题栏看到“策略菜单+工具图标+XML胶囊”；主体只一行预览
2. 切换“智能·单步→Step3 邻近结构”：`status` 进入 analyzing，完成后 `ready` 且 `metrics` 刷新
3. 断网或后端关停：进入 `defaulted`，有红条提示“已用兜底”，点“重新分析”恢复
4. 导出步骤包；换机导入：能**重新载入原始XML**，XPath 命中或走签名匹配给候选
5. “保存为静态策略”后：策略菜单里能看到新静态项，切换后再次执行成功

---

## 6) 小优化（立等可得）

* **特性开关**：`ENABLE_STRATEGY_SELECTOR = true`（默认开启紧凑菜单）
* **不可逆脱敏**：对 XML 中手机号/昵称可选脱敏，manifest 里加 `maskRules`
* **性能**：XML 存 `sha256` 内容寻址 + `.xml.gz` 压缩；重复快照不重复存
* **版本与迁移**：写好 `schemaVersion` 和 `analyzerVersion`，后续变更可做迁移器

---

如果你愿意，我可以把上面**StepCard 的紧凑标题条 + 新增 props + 复现接口**整理成一份“最小补丁”给你（拷三段代码就能跑）。另外，如果你更喜欢**弹出式策略菜单**而不是卡片内大面板，我也给好了 `StrategyMenu` 子组件，接到标题栏就行。
