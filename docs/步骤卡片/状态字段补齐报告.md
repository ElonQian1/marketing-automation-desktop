# çŠ¶æ€å­—æ®µè¡¥é½æŠ¥å‘Š

> **æ—¥æœŸ**: 2024-01-XX  
> **æ¨¡å—**: `universal-ui/types`  
> **æ–‡ä»¶**: `intelligent-analysis-types.ts`  
> **ç›®æ ‡**: è¡¥é½ `IntelligentStepCard` ç¼ºå¤±çš„çŠ¶æ€å­—æ®µ

---

## âœ… å·²è¡¥é½çš„çŠ¶æ€å­—æ®µ

### 1ï¸âƒ£ UI çŠ¶æ€å­—æ®µï¼ˆæ–°å¢ï¼‰

```typescript
/** æ˜¯å¦æ­£åœ¨ä½¿ç”¨å…œåº•ç­–ç•¥ */
isFallbackActive?: boolean;

/** æ˜¯å¦å¯ä»¥å‡çº§åˆ°æ¨èç­–ç•¥ */
canUpgrade?: boolean;

/** æ˜¯å¦æ˜¾ç¤ºå‡çº§æŒ‰é’® */
showUpgradeButton?: boolean;
```

**ç”¨é€”**ï¼š
- `isFallbackActive`: é©±åŠ¨ `<UniversalFallbackBadge>` æ˜¾ç¤ºæ©™è‰²"æš‚ç”¨å…œåº•"å¾½æ ‡
- `canUpgrade`: æ§åˆ¶æ˜¯å¦æ˜¾ç¤º"å‡çº§åˆ°æ¨èç­–ç•¥"æŒ‰é’®
- `showUpgradeButton`: UI å±‚é¢æ§åˆ¶å‡çº§æŒ‰é’®å¯è§æ€§

**è®¡ç®—é€»è¾‘**ï¼š
```typescript
// ç¤ºä¾‹ï¼šåœ¨ StepCardSystem ä¸­è®¡ç®—
isFallbackActive = card.activeStrategy?.key === card.fallbackStrategy.key;
canUpgrade = card.recommendedStrategy && 
             card.recommendedStrategy.confidence >= card.smartThreshold &&
             card.activeStrategy?.key !== card.recommendedStrategy.key;
```

---

### 2ï¸âƒ£ æ‰§è¡Œé…ç½®å­—æ®µï¼ˆæ–°å¢ï¼‰

```typescript
/** æ˜¯å¦å…è®¸åç«¯å—æ§å›é€€ */
allowBackendFallback?: boolean;

/** å•æ¬¡å€™é€‰æ—¶é—´ç‰‡ï¼ˆæ¯«ç§’ï¼‰ */
candidateTimeoutMs?: number;

/** æ€»é¢„ç®—æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ */
totalBudgetMs?: number;
```

**ç”¨é€”**ï¼š
- `allowBackendFallback`: æ§åˆ¶åç«¯æ‰§è¡Œå¤±è´¥æ—¶æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢åˆ°å…œåº•ç­–ç•¥
- `candidateTimeoutMs`: å•ä¸ªå€™é€‰ç­–ç•¥çš„è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 3000msï¼‰
- `totalBudgetMs`: æ•´ä¸ªæ­¥éª¤çš„æ€»æ‰§è¡Œé¢„ç®—ï¼ˆé»˜è®¤ 10000msï¼‰

**é»˜è®¤å€¼å»ºè®®**ï¼š
```typescript
const DEFAULT_EXECUTION_CONFIG = {
  allowBackendFallback: true,
  candidateTimeoutMs: 3000,
  totalBudgetMs: 10000,
};
```

---

### 3ï¸âƒ£ æ‰§è¡Œå†å²å­—æ®µï¼ˆæ–°å¢ï¼‰

```typescript
/** ä¸Šæ¬¡æ‰§è¡Œç»“æœ */
lastExecutionResult?: StepExecutionResult;

/** æ‰§è¡Œå†å²ï¼ˆæœ€è¿‘Næ¬¡ï¼‰ */
executionHistory?: StepExecutionResult[];
```

**ç”¨é€”**ï¼š
- `lastExecutionResult`: å¿«é€Ÿè®¿é—®æœ€è¿‘ä¸€æ¬¡æ‰§è¡Œçš„ç»“æœ
- `executionHistory`: ä¿å­˜æœ€è¿‘ 5-10 æ¬¡æ‰§è¡Œè®°å½•ï¼Œç”¨äºè¶‹åŠ¿åˆ†æ

**æ•°æ®ç»“æ„**ï¼š
```typescript
interface StepExecutionResult {
  executionId: string;        // å”¯ä¸€ID
  success: boolean;           // æ˜¯å¦æˆåŠŸ
  executedAt: number;         // æ‰§è¡Œæ—¶é—´æˆ³
  duration: number;           // è€—æ—¶ï¼ˆmsï¼‰
  strategy: string;           // ç­–ç•¥åç§°
  strategyType?: 'smart' | 'fallback' | 'user'; // ç­–ç•¥ç±»å‹
  status?: 'success' | 'failed' | 'timeout' | 'skipped'; // è¯¦ç»†çŠ¶æ€
  error?: string;             // é”™è¯¯ä¿¡æ¯
  retryCount?: number;        // é‡è¯•æ¬¡æ•°
}
```

---

## ğŸ“Š å®Œæ•´å­—æ®µåˆ†ç±»è¡¨

| åˆ†ç±»             | å­—æ®µæ•° | è¯´æ˜                           |
| ---------------- | ------ | ------------------------------ |
| åŸºç¡€ä¿¡æ¯         | 3      | stepId, stepName, stepType     |
| å…ƒç´ ä¸Šä¸‹æ–‡       | 2      | elementContext, selectionHash  |
| åˆ†æçŠ¶æ€ï¼ˆæ ¸å¿ƒï¼‰ | 5      | analysisState, jobId, progress |
| å…¼å®¹å­—æ®µ         | 2      | pendingAnalysis, isAnalyzing   |
| ç­–ç•¥ä¿¡æ¯         | 7      | strategyMode, candidates, etc. |
| **UI çŠ¶æ€**      | **3**  | **æ–°å¢ï¼šisFallbackActive ç­‰**  |
| é…ç½®å¼€å…³         | 3      | autoFollowSmart, lockContainer |
| **æ‰§è¡Œé…ç½®**     | **3**  | **æ–°å¢ï¼šallowBackendFallback** |
| æ—¶é—´æˆ³           | 3      | createdAt, analyzedAt          |
| **æ‰§è¡Œå†å²**     | **2**  | **æ–°å¢ï¼šlastExecutionResult**  |
| **æ€»è®¡**         | **33** | **æ–°å¢ 8 ä¸ªå…³é”®çŠ¶æ€å­—æ®µ**      |

---

## ğŸ¯ æ–°å¢å­—æ®µçš„ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ˜¾ç¤º"æš‚ç”¨å…œåº•"å¾½æ ‡

```tsx
<UniversalFallbackBadge
  isFallbackActive={card.isFallbackActive}
  isAnalyzing={card.analysisState === 'analyzing'}
  fallbackStrategy={card.fallbackStrategy}
/>
```

### åœºæ™¯ 2ï¼šæ§åˆ¶å‡çº§æŒ‰é’®æ˜¾ç¤º

```tsx
{card.canUpgrade && card.showUpgradeButton && (
  <Button onClick={() => handleUpgrade(card.recommendedStrategy)}>
    å‡çº§åˆ°æ¨èç­–ç•¥
  </Button>
)}
```

### åœºæ™¯ 3ï¼šæ‰§è¡Œè¶…æ—¶æ§åˆ¶

```typescript
async function executeStep(card: IntelligentStepCard) {
  const timeout = card.candidateTimeoutMs || 3000;
  const totalBudget = card.totalBudgetMs || 10000;
  
  return await executeWithBudget(card, timeout, totalBudget);
}
```

### åœºæ™¯ 4ï¼šå±•ç¤ºæ‰§è¡Œå†å²

```tsx
<ExecutionHistoryList
  history={card.executionHistory || []}
  lastResult={card.lastExecutionResult}
/>
```

---

## âœ… éªŒè¯æ¸…å•

- [x] `isFallbackActive` å­—æ®µå·²æ·»åŠ ï¼ˆç”¨äºé©±åŠ¨å¾½æ ‡æ˜¾ç¤ºï¼‰
- [x] `canUpgrade` å­—æ®µå·²æ·»åŠ ï¼ˆç”¨äºæ§åˆ¶å‡çº§æŒ‰é’®ï¼‰
- [x] `showUpgradeButton` å­—æ®µå·²æ·»åŠ ï¼ˆUI å±‚æ§åˆ¶ï¼‰
- [x] `allowBackendFallback` å­—æ®µå·²æ·»åŠ ï¼ˆæ‰§è¡Œé…ç½®ï¼‰
- [x] `candidateTimeoutMs` å­—æ®µå·²æ·»åŠ ï¼ˆå•æ¬¡è¶…æ—¶ï¼‰
- [x] `totalBudgetMs` å­—æ®µå·²æ·»åŠ ï¼ˆæ€»é¢„ç®—ï¼‰
- [x] `lastExecutionResult` å­—æ®µå·²æ·»åŠ ï¼ˆæœ€è¿‘æ‰§è¡Œï¼‰
- [x] `executionHistory` å­—æ®µå·²æ·»åŠ ï¼ˆå†å²è®°å½•ï¼‰
- [x] `StepExecutionResult` ç±»å‹å·²æ›´æ–°ï¼ˆæ–°å¢ executionIdã€strategyTypeã€status ç­‰å­—æ®µï¼‰
- [x] æ‰€æœ‰æ–°å¢å­—æ®µéƒ½æœ‰ JSDoc æ³¨é‡Š
- [x] å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼ˆå…¼å®¹ç°æœ‰ä»£ç ï¼‰

---

## ğŸ“ è¿ç§»å»ºè®®

### å¯¹ç°æœ‰ä»£ç çš„å½±å“

**âœ… é›¶ç ´åæ€§**ï¼šæ‰€æœ‰æ–°å¢å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼ˆ`?:`ï¼‰ï¼Œä¸ä¼šå½±å“ç°æœ‰ä»£ç ç¼–è¯‘ã€‚

### æ¨èè¿ç§»æ­¥éª¤

1. **ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰**ï¼š
   - åœ¨ `StepCardSystem` ä¸­è®¡ç®— `isFallbackActive`ã€`canUpgrade`
   - åœ¨ `<UniversalFallbackBadge>` ä¸­ä½¿ç”¨è¿™äº›å­—æ®µ

2. **ç¬¬äºŒé˜¶æ®µï¼ˆ1-2 å¤©å†…ï¼‰**ï¼š
   - åœ¨æ­¥éª¤æ‰§è¡Œé€»è¾‘ä¸­ä½¿ç”¨ `allowBackendFallback`
   - é…ç½®é»˜è®¤çš„ `candidateTimeoutMs` å’Œ `totalBudgetMs`

3. **ç¬¬ä¸‰é˜¶æ®µï¼ˆ1 å‘¨å†…ï¼‰**ï¼š
   - è®°å½•æ‰§è¡Œç»“æœåˆ° `lastExecutionResult`
   - æ„å»º `executionHistory` æ•°ç»„ï¼ˆæœ€å¤šä¿ç•™ 10 æ¡ï¼‰

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶                                    | ä½œç”¨                       |
| --------------------------------------- | -------------------------- |
| `intelligent-analysis-types.ts`         | ç±»å‹å®šä¹‰ï¼ˆæœ¬æ¬¡æ›´æ–°ï¼‰       |
| `universal-fallback-badge.tsx`          | ä½¿ç”¨ `isFallbackActive`    |
| `universal-strategy-candidates-section` | å€™é€‰åˆ—è¡¨ï¼ˆæœªæ¥å¯æ˜¾ç¤ºå†å²ï¼‰ |
| `universal-publish-readiness-modal`     | å‘å¸ƒæ£€æŸ¥ï¼ˆå¯æ˜¾ç¤ºæ‰§è¡Œç»Ÿè®¡ï¼‰ |

---

## ğŸ‰ æ€»ç»“

**æ–°å¢å­—æ®µæ•°é‡**: 8 ä¸ª  
**ç±»å‹å®šä¹‰æ›´æ–°**: 2 ä¸ªï¼ˆIntelligentStepCardã€StepExecutionResultï¼‰  
**å…¼å®¹æ€§**: 100%ï¼ˆå…¨éƒ¨å¯é€‰å­—æ®µï¼‰  
**æ–‡æ¡£å®Œæ•´æ€§**: âœ…ï¼ˆæ‰€æœ‰å­—æ®µéƒ½æœ‰ JSDoc æ³¨é‡Šï¼‰  

**ä¸‹ä¸€æ­¥**ï¼š
1. åœ¨ `StepCardSystem` ä¸­å®ç°å­—æ®µè®¡ç®—é€»è¾‘
2. åœ¨æ‰§è¡Œå¼•æ“ä¸­è®°å½• `executionHistory`
3. åœ¨ UI ä¸­å±•ç¤ºæ‰§è¡Œå†å²å’Œç»Ÿè®¡ä¿¡æ¯
