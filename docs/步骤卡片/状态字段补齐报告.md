# 状态字段补齐报告

> **日期**: 2024-01-XX  
> **模块**: `universal-ui/types`  
> **文件**: `intelligent-analysis-types.ts`  
> **目标**: 补齐 `IntelligentStepCard` 缺失的状态字段

---

## ✅ 已补齐的状态字段

### 1️⃣ UI 状态字段（新增）

```typescript
/** 是否正在使用兜底策略 */
isFallbackActive?: boolean;

/** 是否可以升级到推荐策略 */
canUpgrade?: boolean;

/** 是否显示升级按钮 */
showUpgradeButton?: boolean;
```

**用途**：
- `isFallbackActive`: 驱动 `<UniversalFallbackBadge>` 显示橙色"暂用兜底"徽标
- `canUpgrade`: 控制是否显示"升级到推荐策略"按钮
- `showUpgradeButton`: UI 层面控制升级按钮可见性

**计算逻辑**：
```typescript
// 示例：在 StepCardSystem 中计算
isFallbackActive = card.activeStrategy?.key === card.fallbackStrategy.key;
canUpgrade = card.recommendedStrategy && 
             card.recommendedStrategy.confidence >= card.smartThreshold &&
             card.activeStrategy?.key !== card.recommendedStrategy.key;
```

---

### 2️⃣ 执行配置字段（新增）

```typescript
/** 是否允许后端受控回退 */
allowBackendFallback?: boolean;

/** 单次候选时间片（毫秒） */
candidateTimeoutMs?: number;

/** 总预算时间（毫秒） */
totalBudgetMs?: number;
```

**用途**：
- `allowBackendFallback`: 控制后端执行失败时是否自动切换到兜底策略
- `candidateTimeoutMs`: 单个候选策略的超时时间（默认 3000ms）
- `totalBudgetMs`: 整个步骤的总执行预算（默认 10000ms）

**默认值建议**：
```typescript
const DEFAULT_EXECUTION_CONFIG = {
  allowBackendFallback: true,
  candidateTimeoutMs: 3000,
  totalBudgetMs: 10000,
};
```

---

### 3️⃣ 执行历史字段（新增）

```typescript
/** 上次执行结果 */
lastExecutionResult?: StepExecutionResult;

/** 执行历史（最近N次） */
executionHistory?: StepExecutionResult[];
```

**用途**：
- `lastExecutionResult`: 快速访问最近一次执行的结果
- `executionHistory`: 保存最近 5-10 次执行记录，用于趋势分析

**数据结构**：
```typescript
interface StepExecutionResult {
  executionId: string;        // 唯一ID
  success: boolean;           // 是否成功
  executedAt: number;         // 执行时间戳
  duration: number;           // 耗时（ms）
  strategy: string;           // 策略名称
  strategyType?: 'smart' | 'fallback' | 'user'; // 策略类型
  status?: 'success' | 'failed' | 'timeout' | 'skipped'; // 详细状态
  error?: string;             // 错误信息
  retryCount?: number;        // 重试次数
}
```

---

## 📊 完整字段分类表

| 分类             | 字段数 | 说明                           |
| ---------------- | ------ | ------------------------------ |
| 基础信息         | 3      | stepId, stepName, stepType     |
| 元素上下文       | 2      | elementContext, selectionHash  |
| 分析状态（核心） | 5      | analysisState, jobId, progress |
| 兼容字段         | 2      | pendingAnalysis, isAnalyzing   |
| 策略信息         | 7      | strategyMode, candidates, etc. |
| **UI 状态**      | **3**  | **新增：isFallbackActive 等**  |
| 配置开关         | 3      | autoFollowSmart, lockContainer |
| **执行配置**     | **3**  | **新增：allowBackendFallback** |
| 时间戳           | 3      | createdAt, analyzedAt          |
| **执行历史**     | **2**  | **新增：lastExecutionResult**  |
| **总计**         | **33** | **新增 8 个关键状态字段**      |

---

## 🎯 新增字段的使用场景

### 场景 1：显示"暂用兜底"徽标

```tsx
<UniversalFallbackBadge
  isFallbackActive={card.isFallbackActive}
  isAnalyzing={card.analysisState === 'analyzing'}
  fallbackStrategy={card.fallbackStrategy}
/>
```

### 场景 2：控制升级按钮显示

```tsx
{card.canUpgrade && card.showUpgradeButton && (
  <Button onClick={() => handleUpgrade(card.recommendedStrategy)}>
    升级到推荐策略
  </Button>
)}
```

### 场景 3：执行超时控制

```typescript
async function executeStep(card: IntelligentStepCard) {
  const timeout = card.candidateTimeoutMs || 3000;
  const totalBudget = card.totalBudgetMs || 10000;
  
  return await executeWithBudget(card, timeout, totalBudget);
}
```

### 场景 4：展示执行历史

```tsx
<ExecutionHistoryList
  history={card.executionHistory || []}
  lastResult={card.lastExecutionResult}
/>
```

---

## ✅ 验证清单

- [x] `isFallbackActive` 字段已添加（用于驱动徽标显示）
- [x] `canUpgrade` 字段已添加（用于控制升级按钮）
- [x] `showUpgradeButton` 字段已添加（UI 层控制）
- [x] `allowBackendFallback` 字段已添加（执行配置）
- [x] `candidateTimeoutMs` 字段已添加（单次超时）
- [x] `totalBudgetMs` 字段已添加（总预算）
- [x] `lastExecutionResult` 字段已添加（最近执行）
- [x] `executionHistory` 字段已添加（历史记录）
- [x] `StepExecutionResult` 类型已更新（新增 executionId、strategyType、status 等字段）
- [x] 所有新增字段都有 JSDoc 注释
- [x] 字段都是可选的（兼容现有代码）

---

## 📝 迁移建议

### 对现有代码的影响

**✅ 零破坏性**：所有新增字段都是可选的（`?:`），不会影响现有代码编译。

### 推荐迁移步骤

1. **第一阶段（立即生效）**：
   - 在 `StepCardSystem` 中计算 `isFallbackActive`、`canUpgrade`
   - 在 `<UniversalFallbackBadge>` 中使用这些字段

2. **第二阶段（1-2 天内）**：
   - 在步骤执行逻辑中使用 `allowBackendFallback`
   - 配置默认的 `candidateTimeoutMs` 和 `totalBudgetMs`

3. **第三阶段（1 周内）**：
   - 记录执行结果到 `lastExecutionResult`
   - 构建 `executionHistory` 数组（最多保留 10 条）

---

## 🔗 相关文件

| 文件                                    | 作用                       |
| --------------------------------------- | -------------------------- |
| `intelligent-analysis-types.ts`         | 类型定义（本次更新）       |
| `universal-fallback-badge.tsx`          | 使用 `isFallbackActive`    |
| `universal-strategy-candidates-section` | 候选列表（未来可显示历史） |
| `universal-publish-readiness-modal`     | 发布检查（可显示执行统计） |

---

## 🎉 总结

**新增字段数量**: 8 个  
**类型定义更新**: 2 个（IntelligentStepCard、StepExecutionResult）  
**兼容性**: 100%（全部可选字段）  
**文档完整性**: ✅（所有字段都有 JSDoc 注释）  

**下一步**：
1. 在 `StepCardSystem` 中实现字段计算逻辑
2. 在执行引擎中记录 `executionHistory`
3. 在 UI 中展示执行历史和统计信息
