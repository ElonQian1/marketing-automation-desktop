
---

## 1. 项目速览（你需要知道的最少信息）

* 技术栈：**Tauri (Rust) + React + TypeScript + Zustand + Ant Design + Tailwind**
* 组织方式：**模块优先（feature 切片）+ 模块内分层**

  ```
  src/modules/<module>/
    ├─ domain/          # 纯规则与类型（禁止 IO/UI 依赖）
    ├─ application/     # 用例/编排（调用 domain + infrastructure）
    ├─ infrastructure/  # 适配器/IO 实现（Tauri/HTTP/本地）
    ├─ stores/          # Zustand（只依赖 application）
    ├─ hooks/           # UI 用 hooks（依赖 stores/application）
    ├─ ui/              # 组件（不直接碰 infra）
    └─ index.ts         # 门牌：只导出 public 契约、用例、必要 hooks
  ```
* 关键**唯一硬底线**：`domain/*` **禁止**依赖 `ui/services/api/hooks/pages`、React、axios、Tauri 等 IO/UI。
* “命名四件套”：

  1. **命名前缀**（易重名目录的文件/类型带模块前缀，如 `script-*/Script*`）；
  2. **门牌导出**（跨模块只从 `src/modules/<m>/index.ts` 取能力）；
  3. **别名**（例如 `@universal/*` 命中门牌）；
  4. **三行文件头**（路径/模块/分层/角色/摘要）。

---

## 2. 你的当下任务（最优先）

在 **Universal UI → 智能页面查找器** 的**可视化分析视图**里实现：

1. **点选元素**后，生成并展示**步骤卡片（StepCard）**；
2. 卡片展示该元素的**匹配策略**；
3. 支持在**手动静态策略 ↔ 智能策略**之间**切换**；
4. 在手动模式下，支持“一键**返回启用智能策略**”；
5. **整合现有旧实现**：

   * 旧手动策略包含 **“Xpath直接”**；
   * 旧智能策略有 6 种变体：`self-anchor | child-anchor | parent-clickable | region-scoped | neighbor-relative | index-fallback`。

> 目标：**今天**就能跑通闭环（旧智能不可用时，也要有兜底策略）。

---

## 3. 输入（你可假定存在/允许创建）

* 模块：`src/modules/universal-ui/**`
* 若别名未配置，先用相对路径；最后视情况补上 `@universal/*`。
* 可创建以下新文件（按步骤中的路径）并小步提交。

---

## 4. 执行步骤（照做即可）

### A. 建立统一契约（domain/public）

1. 新建：`src/modules/universal-ui/domain/public/selector/StrategyContracts.ts`

   * 定义：

     * `ElementDescriptor`（被选元素描述）
     * `ManualStrategy`（手动策略；可表达“Xpath直接”→ `selector.xpath`）
     * `SmartMatchVariant` + `SmartVariantParams`（覆盖 6 变体）
     * `SmartSelector` + `SmartStrategy`
     * `GenerateSmartStrategy`（用例接口）

### B. 建端口与用例（application）

2. 新建端口：`application/ports/StrategyProvider.ts`（`generate({element}) => Promise<SmartStrategy|null>`）
3. 新建用例：`application/usecases/GenerateSmartStrategyUseCase.ts`

   * 依次调用若干 provider：`LegacySmartProvider` →（未来可接 Remote/LLM）→ `HeuristicProvider(兜底)`
   * 都无结果时返回 `index-fallback`（`tag:nth-child(n)`）

### C. 衔接旧实现（infrastructure）

4. 新建：`infrastructure/adapters/LegacySmartProvider.ts`

   * 把**旧智能返回**转换为统一 `SmartStrategy`（含 `variant + params`）。旧服务不可用时返回 `null`。
5. 新建：`infrastructure/adapters/HeuristicProvider.ts`

   * 兜底生成 `index-fallback` 智能策略。
6. 新建（双向）适配器：`application/compat/LegacyManualAdapter.ts`

   * **旧“Xpath直接” ⇄ 新 `ManualStrategy`** 的互转（UI 展示/编辑 ↔ 旧存储/编辑器）。

### D. 状态与 Hook（stores/hooks）

7. 新建 store：`stores/inspectorStore.ts`（Zustand）

   * 状态：`element`、`mode('manual'|'smart')`、`current`、`lastManualSnapshot`、`lastSmartSnapshot`
   * 方法：`setElement`、`setManual`、`toManual`（回退或固化智能为手动）、`toSmart`（快照优先/否则调用用例）、`refreshSmart`
8. 新建 hook：`hooks/useStepStrategy.ts`（封装上面的读写，供 UI 使用）

### E. UI 接线（ui）

9. 新建组件：`ui/StepCard.tsx`

   * 顶部 `Switch` 切换（手动/智能）
   * **手动**：展示/编辑（至少支持 `Xpath直接` 输入框）+ “**返回启用智能策略**”（调用 `toSmart()`）
   * **智能**：展示 `css/xpath/score/rationale` + **变体标签/参数**（可建 `ui/partials/SmartVariantBadge.tsx`）+ “刷新智能”“采用为手动”
   * 注意：浅色容器增加 `.light-theme-force`，避免白底白字
10. 在“节点详情面板”（例如 `components/universal-ui/views/grid-view/panels/node-detail/NodeDetailPanel.tsx`）中：

    * 选中元素后组装 `ElementDescriptor` → `setElement(descriptor)`
    * 若 `descriptor.xpath` 存在，**默认设一个“Xpath直接”手动策略**：`setManual({ kind:'manual', name:'manual-xpath-direct', selector:{ xpath: descriptor.xpath } })`
    * 渲染 `<StepCard />`

### F. 门牌导出与别名（index.ts / tsconfig）

11. `src/modules/universal-ui/index.ts` **仅导出**：

    * `domain/public/selector/StrategyContracts`
    * `application/usecases/GenerateSmartStrategyUseCase`
    * `hooks/useStepStrategy`（如有）
12. （可选）`tsconfig.json` 增加别名：

    ```json
    "paths": { "@universal/*": ["src/modules/universal-ui/*"] }
    ```

---

## 5. 交付物（Commit/PR 要点）

* 代码：步骤 A–F 涉及的新文件与修改。
* 说明：在 PR 描述里用 3 行小结：

  1. **做了什么**（契约/用例/适配器/Store/StepCard/接线）
  2. **如何整合旧实现**（“Xpath直接”互转；6 变体映射 variant+params）
  3. **如何操作**（点选元素→出现卡片→切换→返回智能→刷新/采用为手动）

建议提交粒度（示例）：

* `feat(universal-ui): strategy contracts + provider ports + generate usecase`
* `feat(universal-ui): legacy-smart provider + heuristic fallback`
* `feat(universal-ui): legacy-manual adapter (xpath-direct ⇄ ManualStrategy)`
* `feat(universal-ui): inspector store + useStepStrategy hook`
* `feat(universal-ui): StepCard UI + SmartVariantBadge + panel wiring`
* `chore(universal-ui): index barrel exports (+ tsconfig alias)`

---

## 6. 验收标准（自测清单）

* [ ] 点选元素后，**步骤卡片可见**；
* [ ] **手动/智能**可相互切换；
* [ ] 手动模式点“**返回启用智能策略**”可成功回到智能；
* [ ] 智能模式可**刷新**、可**一键“采用为手动”**；
* [ ] “Xpath直接”能正确显示/编辑，并能与旧结构互转（如需）；
* [ ] 6 种变体能在卡片上看到**标签/关键参数**（旧智能不可用时显示兜底 `index-fallback`）；
* [ ] `domain/*` **未**引用 React/axios/Tauri 等 IO/UI；
* [ ] `index.ts` **只**导出 public 契约/用例/必要 hooks；
* [ ] `pnpm type-check && pnpm tauri dev` 可正常运行，无明显报错。

---

## 7. 出错与兜底策略

* 旧智能服务不可用/报错 → **不要中断**；启用 `HeuristicProvider` 返回 `index-fallback`，保证“返回启用智能策略/刷新智能”能工作。
* 缺少 `@universal/*` 别名 → **先用相对路径**，最后补别名。
* 不确定旧类型/函数的真实路径 → 在 `Legacy*Adapter` 里**先留占位实现**，标注 `// TODO: 改为真实 import`，保证今日功能闭环。

---

## 8. 注意事项

* 不新增强制“允许/禁止”跨模块规则；只遵守**唯一硬底线**。
* 易重名目录（`strategies/services/utils/…`）文件/类型**建议**带模块前缀，减少 AI 误改概率。
* UI 的浅色背景容器务必加 `.light-theme-force` 并使用 CSS 变量，避免白底白字。
* 提交尽量小步，每个 commit 都能编译通过；PR 描述清晰列出“如何操作/如何验证”。

---

## 9. 本地命令（常用）

```bash
pnpm install
pnpm tauri dev          # 启动开发
pnpm type-check         # TS 类型检查
pnpm build              # 构建
```

---

**一句话目标**：
把“策略”统一成**一个对 UI 透明的契约**，通过**用例**调用**旧智能/兜底**，由**Store/Hook**控制**切换与回退**，今天就让“**点选 → 卡片 → 切手动/智能 → 返回智能**”闭环跑起来。
