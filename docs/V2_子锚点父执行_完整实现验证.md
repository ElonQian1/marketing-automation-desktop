# å­é”šç‚¹â†’çˆ¶æ‰§è¡Œ V2 å®Œæ•´å®ç°éªŒè¯

## ğŸ¯ æ ¸å¿ƒåœºæ™¯æµ‹è¯•

### åœºæ™¯1: åº•éƒ¨å¯¼èˆª"æ”¶è—"æŒ‰é’®
**ç»“æ„ç‰¹ç‚¹**: å¯ç‚¹å‡»åœ¨LinearLayoutçˆ¶èŠ‚ç‚¹ï¼Œæ–‡æœ¬åœ¨TextViewå­èŠ‚ç‚¹

#### å‰ç«¯å‘é€çš„StepCardç»“æ„
```json
{
  "step_id": "tap_favorite_tab_1761222441420",
  "structured_selector": {
    "elementSelectors": {
      "targetNodeType": "LinearLayout",
      "anchorXpath": ".//TextView[@resource-id='content' and @text='æ”¶è—']",
      "parentConstraint": "[@clickable='true']",
      "containerXpath": "//*[@resource-id='bottom_navigation']",
      "i18nTextVariants": ["æ”¶è—", "Favorites", "Starred"]
    },
    "action": {
      "type": "tap"
    },
    "safety": {
      "min_confidence": 0.70,
      "require_uniqueness": true,
      "forbid_fullscreen_or_container": true
    }
  }
}
```

#### åç«¯ç”Ÿæˆçš„å¢å¼ºXPath
```xpath
//*[@resource-id='bottom_navigation']//LinearLayout[@clickable='true'][.//TextView[@resource-id='content' and (@text='æ”¶è—' or @text='Favorites' or @text='Starred')]]
```

#### é¢„æœŸæ‰§è¡Œæ—¥å¿—
```
ğŸ¯ selector_source=Inline
âœ… ä½¿ç”¨å¡ç‰‡å†…è”selector
ğŸ—ï¸ ç”Ÿæˆå­é”šç‚¹â†’çˆ¶æ‰§è¡ŒXPath: //*[@resource-id='bottom_navigation']//LinearLayout[@clickable='true'][.//TextView[@resource-id='content' and (@text='æ”¶è—' or @text='Favorites' or @text='Starred')]]
ğŸ” æœ€ç»ˆæœç´¢æ¡ä»¶: xpath=Some("//*[@resource-id='bottom_navigation']//LinearLayout[@clickable='true'][.//TextView[@resource-id='content' and (@text='æ”¶è—' or @text='Favorites' or @text='Starred')]]")
âœ… è‡ªæµ‹é€šè¿‡: è‡³å°‘æœ‰ä¸€ä¸ªselectorå­—æ®µéNone
ğŸ” åŒé‡å”¯ä¸€æ€§: æ€»å€™é€‰=1, é«˜è´¨é‡(â‰¥0.70)=1, Top1=0.950, Gap=1.000, å”¯ä¸€æ€§=1 (conf:true gap:true)  
âœ… è‡ªæµ‹é€šè¿‡: éå®¹å™¨/æ•´å±èŠ‚ç‚¹ class=Some("LinearLayout") bounds=(720,2200,1080,2400)
ğŸ¯ æ‰§è¡Œç‚¹å‡»: (900, 2300)
```

---

## ğŸ”¬ å…³é”®éªŒè¯ç‚¹

### 1. å­é”šç‚¹å­—æ®µè§£æéªŒè¯
```rust
// æ£€æŸ¥ç‚¹1: æ–°å¢å­—æ®µæ˜¯å¦æ­£ç¡®è§£æ
let target_node_type = element_selectors.get("targetNodeType").and_then(|v| v.as_str()).map(|s| s.to_string());
let anchor_xpath = element_selectors.get("anchorXpath").and_then(|v| v.as_str()).map(|s| s.to_string());
let parent_constraint = element_selectors.get("parentConstraint").and_then(|v| v.as_str()).map(|s| s.to_string());
let container_xpath = element_selectors.get("containerXpath").and_then(|v| v.as_str()).map(|s| s.to_string());

// éªŒè¯I18Nå˜ä½“æ•°ç»„è§£æ
let i18n_variants = element_selectors.get("i18nTextVariants")
    .and_then(|v| v.as_array())
    .map(|arr| arr.iter().filter_map(|v| v.as_str().map(|s| s.to_string())).collect::<Vec<String>>());
```

### 2. XPathç”Ÿæˆé€»è¾‘éªŒè¯
```rust
fn build_child_to_parent_xpath(
    container_xpath: &Option<String>,     // "//*[@resource-id='bottom_navigation']"
    target_node_type: &Option<String>,   // "LinearLayout"  
    parent_constraint: &Option<String>,  // "[@clickable='true']"
    anchor_xpath: &Option<String>,       // ".//TextView[@resource-id='content' and @text='æ”¶è—']"
    i18n_variants: &Option<Vec<String>>  // ["æ”¶è—","Favorites","Starred"]
) -> Option<String>

// é¢„æœŸè¾“å‡º:
// "//*[@resource-id='bottom_navigation']//LinearLayout[@clickable='true'][.//TextView[@resource-id='content' and (@text='æ”¶è—' or @text='Favorites' or @text='Starred')]]"
```

### 3. åŒé˜¶æ®µå®¹å™¨æ‹¦æˆªéªŒè¯
```rust
// åŒ¹é…é˜¶æ®µæ‹¦æˆª
let is_container = is_container_node(&candidate.class_name);
let is_fullscreen = is_fullscreen_node(&(candidate.bounds.left, candidate.bounds.top, candidate.bounds.right, candidate.bounds.bottom));

if is_container || is_fullscreen {
    return Err(format!("CONTAINER_BLOCKED: {}èŠ‚ç‚¹ä¸å…è®¸ç›´æ¥ç‚¹å‡»", block_type));
}

// Hit-Testé˜¶æ®µæ‹¦æˆª
if is_fullscreen_node(&(node_bounds.left, node_bounds.top, node_bounds.right, node_bounds.bottom)) {
    continue; // è·³è¿‡æ•´å±èŠ‚ç‚¹
}

if is_container_node(&class_name) {
    continue; // è·³è¿‡å®¹å™¨èŠ‚ç‚¹
}
```

### 4. åŒé‡å”¯ä¸€æ€§åˆ¤å®šéªŒè¯
```rust
// æ ‡å‡†1: é«˜ç½®ä¿¡åº¦å€™é€‰å”¯ä¸€
let is_unique_by_confidence = high_quality_matches == 1;

// æ ‡å‡†2: Top1-Top2ç½®ä¿¡åº¦é—´éš”è¶³å¤Ÿ
let is_unique_by_gap = confidence_gap >= 0.15;

// ä»»ä¸€æ»¡è¶³å³å¯æ‰§è¡Œ
let uniqueness = if is_unique_by_confidence || is_unique_by_gap { 1 } else { high_quality_matches.max(2) as i32 };
```

---

## ğŸ“‹ å®Œæ•´è‡ªæµ‹æ£€æŸ¥æ¸…å•

### âœ… å‰ç«¯å‘é€æ ¼å¼éªŒè¯
- [ ] `targetNodeType` å­—æ®µæ­£ç¡®åŒ…å«
- [ ] `anchorXpath` å­—æ®µåŒ…å«å­èŠ‚ç‚¹é€‰æ‹©æ¡ä»¶
- [ ] `parentConstraint` å­—æ®µåŒ…å«çˆ¶èŠ‚ç‚¹çº¦æŸ
- [ ] `containerXpath` å­—æ®µåŒ…å«åŒºåŸŸé™å®š
- [ ] `i18nTextVariants` æ•°ç»„åŒ…å«å¤šè¯­è¨€å˜ä½“

### âœ… åç«¯è§£æéªŒè¯
- [ ] å­é”šç‚¹å­—æ®µæˆåŠŸè§£æå¹¶è®°å½•æ—¥å¿—
- [ ] XPathç”Ÿæˆå™¨æ­£ç¡®æ‹¼æ¥å¤åˆé€‰æ‹©å™¨
- [ ] I18Næ–‡æœ¬å˜ä½“æ­£ç¡®è½¬æ¢ä¸º OR æ¡ä»¶

### âœ… æ‰§è¡Œæ—¶å®‰å…¨æ£€æŸ¥
- [ ] åŒé‡å”¯ä¸€æ€§åˆ¤å®šæ­£ç¡®å·¥ä½œ
- [ ] å®¹å™¨èŠ‚ç‚¹åœ¨åŒ¹é…é˜¶æ®µè¢«æ‹¦æˆª
- [ ] æ•´å±èŠ‚ç‚¹åœ¨åŒ¹é…é˜¶æ®µè¢«æ‹¦æˆª  
- [ ] åæ ‡å…œåº•æ—¶hit-testæ­£ç¡®æ‹’ç»å®¹å™¨

### âœ… æ—¥å¿—è¾“å‡ºéªŒè¯
- [ ] `selector_source=Inline` æ­£ç¡®æ˜¾ç¤º
- [ ] `ç”Ÿæˆå­é”šç‚¹â†’çˆ¶æ‰§è¡ŒXPath` æ—¥å¿—å‡ºç°
- [ ] `åŒé‡å”¯ä¸€æ€§` ç»Ÿè®¡ä¿¡æ¯æ­£ç¡®
- [ ] `è‡ªæµ‹é€šè¿‡: éå®¹å™¨/æ•´å±èŠ‚ç‚¹` éªŒè¯ä¿¡æ¯

---

## ğŸš€ ç«¯åˆ°ç«¯æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹1: æˆåŠŸåœºæ™¯
**è¾“å…¥**: åº•éƒ¨å¯¼èˆªæ”¶è—æŒ‰é’®çš„å­é”šç‚¹é…ç½®
**é¢„æœŸ**: ç”Ÿæˆæ­£ç¡®XPathï¼Œå”¯ä¸€æ€§é€šè¿‡ï¼Œå®¹å™¨æ£€æŸ¥é€šè¿‡ï¼ŒæˆåŠŸç‚¹å‡»

### æµ‹è¯•ç”¨ä¾‹2: å¤šè¯­è¨€åˆ‡æ¢åœºæ™¯  
**è¾“å…¥**: i18nTextVariantsåŒ…å«["æ”¶è—","Favorites"]
**é¢„æœŸ**: XPathåŒ…å«ORæ¡ä»¶ï¼Œè‹±æ–‡ç¯å¢ƒä¸‹ä¹Ÿèƒ½æ­£ç¡®åŒ¹é…

### æµ‹è¯•ç”¨ä¾‹3: å®¹å™¨æ‹¦æˆªåœºæ™¯
**è¾“å…¥**: é€‰æ‹©å™¨åŒ¹é…åˆ°ViewGroupå®¹å™¨
**é¢„æœŸ**: è¿”å›CONTAINER_BLOCKEDé”™è¯¯ï¼Œæ‹’ç»æ‰§è¡Œ

### æµ‹è¯•ç”¨ä¾‹4: éå”¯ä¸€æ€§åœºæ™¯
**è¾“å…¥**: é€‰æ‹©å™¨åŒ¹é…åˆ°å¤šä¸ªé«˜ç½®ä¿¡åº¦å€™é€‰
**é¢„æœŸ**: å”¯ä¸€æ€§æ£€æŸ¥å¤±è´¥ï¼Œè§¦å‘å›é€€æˆ–æŠ¥é”™

### æµ‹è¯•ç”¨ä¾‹5: åæ ‡å…œåº•åœºæ™¯
**è¾“å…¥**: æ‰€æœ‰é€‰æ‹©å™¨å¤±è´¥ï¼Œå¯ç”¨åæ ‡å…œåº•
**é¢„æœŸ**: Hit-Testæ‰¾åˆ°æœ€å°å¯äº¤äº’èŠ‚ç‚¹ï¼Œæ‹’ç»å®¹å™¨

---

## ğŸ’¡ å®ç°äº®ç‚¹æ€»ç»“

1. **æ¶æ„ä¼˜é›…**: åœ¨ç°æœ‰V2æ¡†æ¶å†…æ— ç¼é›†æˆå­é”šç‚¹â†’çˆ¶æ‰§è¡Œé€»è¾‘
2. **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰çš„text/xpath/resource-idé€‰æ‹©å™¨
3. **å®‰å…¨ç¬¬ä¸€**: åŒé˜¶æ®µå®¹å™¨æ‹¦æˆª + åŒé‡å”¯ä¸€æ€§ä¿è¯
4. **å¤šè¯­è¨€å‹å¥½**: I18Nå˜ä½“è‡ªåŠ¨è½¬æ¢ä¸ºORæ¡ä»¶
5. **å¯è§‚æµ‹æ€§å¼º**: å®Œæ•´çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•å’ŒéªŒè¯
6. **æ¸è¿›å¢å¼º**: å¯ä»¥é€æ­¥ä»ç®€å•é€‰æ‹©å™¨è¿ç§»åˆ°å¤åˆé€‰æ‹©å™¨

---

## ğŸ”§ å¿«é€Ÿé›†æˆæŒ‡å—

### æ­¥éª¤1: å‰ç«¯æ„å»ºå­é”šç‚¹é…ç½®
```typescript  
const structuredSelector = {
  elementSelectors: {
    targetNodeType: "LinearLayout",
    anchorXpath: ".//TextView[@resource-id='content' and @text='æ”¶è—']",
    parentConstraint: "[@clickable='true']", 
    containerXpath: "//*[@resource-id='bottom_navigation']",
    i18nTextVariants: ["æ”¶è—", "Favorites", "Starred"]
  }
};
```

### æ­¥éª¤2: å‘é€åˆ°V2å¼•æ“
```typescript
const request = {
  device_id: "device_123",
  mode: "StructuredSelector",
  strategy: "IntelligentSelector", 
  step: {
    step_id: "tap_favorite_tab",
    structured_selector: structuredSelector
  }
};
```

### æ­¥éª¤3: éªŒè¯æ‰§è¡Œæ—¥å¿—
æŸ¥æ‰¾å…³é”®æ—¥å¿—æ ‡è¯†ï¼š
- `ğŸ—ï¸ ç”Ÿæˆå­é”šç‚¹â†’çˆ¶æ‰§è¡ŒXPath`
- `ğŸ” åŒé‡å”¯ä¸€æ€§`
- `âœ… è‡ªæµ‹é€šè¿‡: éå®¹å™¨/æ•´å±èŠ‚ç‚¹`

---

è¿™å¥—å®ç°å®Œç¾è§£å†³äº†"çˆ¶æ— å­—æ®µã€å­æœ‰å­—æ®µ"çš„å®‰å“UIè‡ªåŠ¨åŒ–æ ¸å¿ƒéš¾é¢˜ï¼ŒåŒæ—¶ä¿æŒäº†é«˜åº¦çš„å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§ã€‚