# é€‰æ‹©æ¨¡å¼åˆ‡æ¢å®æ—¶ä¿å­˜ä¿®å¤

**æ—¥æœŸ**: 2025-10-29  
**é—®é¢˜**: åˆ‡æ¢"ç¬¬ä¸€ä¸ª"/"æœ€åä¸€ä¸ª"/"æ‰¹é‡å…¨éƒ¨"æ—¶ï¼Œé…ç½®æ²¡æœ‰å®æ—¶æ›´æ–°ï¼Œä»æ˜¯åˆå§‹åŒ–é€‰é¡¹  
**æ ¹æœ¬åŸå› **: ä¸match_directionç›¸åŒçš„Reacté—­åŒ…é—®é¢˜ï¼Œ`autoSaveConfig`æ•è·æ—§çŠ¶æ€  
**å½±å“æ–‡ä»¶**: `src/components/strategy-selector/CompactStrategyMenu.tsx`

---

## ğŸ› é—®é¢˜ç°è±¡

**ç”¨æˆ·åé¦ˆ**: "å¯ä»¥åˆ‡æ¢'ç¬¬ä¸€ä¸ª''ğŸ¯ æœ€åä¸€ä¸ª''ğŸ“‹ æ‰¹é‡å…¨éƒ¨'ï¼Œä½†æ˜¯å¥½åƒå‰ç«¯é…ç½®å‚æ•°ï¼Œæ²¡æœ‰å®æ—¶æ›´æ–°ï¼Œå®ƒè¿˜æ˜¯åˆå§‹åŒ–é€‰é¡¹ã€‚"

**å…·ä½“è¡¨ç°**:
1. ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢åˆ° `ğŸ¯ ç¬¬ä¸€ä¸ª`
2. ç•Œé¢æ˜¾ç¤ºå·²åˆ‡æ¢
3. ä½†åç«¯ä¿å­˜çš„å¯èƒ½è¿˜æ˜¯æ—§çš„æ¨¡å¼
4. ä¸‹æ¬¡æ‰§è¡Œæ—¶ä½¿ç”¨çš„æ˜¯é”™è¯¯çš„é…ç½®

---

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜ä»£ç ï¼ˆä¿®å¤å‰ï¼‰

```tsx
const [selectionMode, setSelectionMode] = useState<SelectionMode>('first');

const autoSaveConfig = async (mode: string) => {
  // âš ï¸ è¿™é‡Œçš„ batchConfig æ˜¯é—­åŒ…æ•è·çš„æ—§å€¼
  const batchConfigToSave = mode === 'all' ? batchConfig : null;
  
  await invoke('save_smart_selection_config', {
    stepId,
    selectionMode: mode,  // âœ… mode æ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œå€¼æ­£ç¡®
    batchConfig: batchConfigToSave  // âŒ ä½† batchConfig æ˜¯æ—§å€¼ï¼
  });
};

const handleSelectionModeClick = async ({ key }: { key: string }) => {
  switch (key) {
    case 'first':
      setSelectionMode('first');  // âœ… æ›´æ–°çŠ¶æ€
      await autoSaveConfig('first');  // âŒ ä½†é—­åŒ…ä¸­çš„ batchConfig è¿˜æ˜¯æ—§çš„
      break;
    case 'all':
      const newBatchConfig = { /* æ–°é…ç½® */ };
      setBatchConfig(newBatchConfig);  // âœ… æ›´æ–°çŠ¶æ€ï¼ˆå¼‚æ­¥ï¼‰
      await autoSaveConfig('all');  // âŒ ä½†è¿™é‡Œç«‹å³æ‰§è¡Œï¼Œç”¨çš„æ˜¯æ—§ batchConfig
      break;
  }
};
```

### ä¸ºä»€ä¹ˆä¼šå¤±è´¥ï¼Ÿ

è¿™æ˜¯**ä¸ match_direction å®Œå…¨ç›¸åŒçš„é—­åŒ…é—®é¢˜**ï¼š

```
ç”¨æˆ·ç‚¹å‡»"æ‰¹é‡å…¨éƒ¨"

1. setState(newBatchConfig) â†’ è§¦å‘é‡æ–°æ¸²æŸ“ï¼ˆå¼‚æ­¥ï¼‰
2. await autoSaveConfig('all') â†’ ç«‹å³æ‰§è¡Œ
   â†“
3. autoSaveConfig å†…éƒ¨ï¼š
   const batchConfigToSave = mode === 'all' ? batchConfig : null;
   â†‘ è¿™é‡Œçš„ batchConfig æ˜¯é—­åŒ…æ•è·çš„æ—§å€¼ âŒ
   
4. ä¿å­˜åˆ°åç«¯ï¼šæ—§çš„é…ç½® âŒ

ï¼ˆç¨åï¼‰æ¸²æŸ“2ï¼šbatchConfig æ›´æ–°ä¸ºæ–°å€¼
         ï¼ˆä½†å·²ç»å¤ªæ™šäº†ï¼Œä¿å­˜åŠ¨ä½œå·²å®Œæˆï¼‰
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**ä¸ä½¿ç”¨é—­åŒ…ä¸­çš„çŠ¶æ€ï¼Œç›´æ¥åœ¨ç‚¹å‡»å¤„ç†å™¨ä¸­ä½¿ç”¨å±€éƒ¨è®¡ç®—çš„æœ€æ–°å€¼**

### ä¿®å¤åçš„ä»£ç 

```tsx
const handleSelectionModeClick = async ({ key }: { key: string }) => {
  console.log('ğŸ¯ é€‰æ‹©æ¨¡å¼èœå•é¡¹è¢«ç‚¹å‡»:', key);
  
  localStorage.setItem('userSelectionMode', key);
  
  if (!stepId) {
    console.warn('âš ï¸ æ— stepIdï¼Œè·³è¿‡ä¿å­˜');
    return;
  }

  // ğŸ”¥ æ–°å¢ï¼šå†…è”ä¿å­˜å‡½æ•°ï¼Œä½¿ç”¨ä¼ å…¥çš„æœ€æ–°å€¼
  const saveConfigDirectly = async (mode: SelectionMode, batchCfg: BatchConfig | null) => {
    try {
      console.log('ğŸ“¤ ç›´æ¥ä¿å­˜é…ç½®:', { stepId, mode, batchConfig: batchCfg });

      // âœ… ä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œç¡®ä¿æ˜¯æœ€æ–°å€¼
      await invoke('save_smart_selection_config', {
        stepId: stepId,
        selectionMode: mode,
        batchConfig: batchCfg  // âœ… ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„æœ€æ–°é…ç½®
      });

      // åŒæ—¶ç”¨ selectorId ä¿å­˜ï¼ˆå…œåº•ï¼‰
      const state = useStepCardStore.getState();
      const canonicalId = state.aliasToCanonical[stepId];
      const card = canonicalId ? state.cards[canonicalId] : undefined;
      
      if (card?.elementUid) {
        await invoke('save_smart_selection_config', {
          stepId: card.elementUid,
          selectionMode: mode,
          batchConfig: batchCfg
        });
      }

      message.success(`å·²åˆ‡æ¢åˆ°: ${getModeLabel(mode)}`);
      console.log('âœ… é…ç½®ä¿å­˜æˆåŠŸ:', { mode, batchConfig: batchCfg });
    } catch (error) {
      console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);
      message.error(`ä¿å­˜å¤±è´¥: ${error}`);
    }
  };

  const getModeLabel = (mode: SelectionMode) => {
    switch (mode) {
      case 'first': return 'ğŸ¯ ç¬¬ä¸€ä¸ª';
      case 'last': return 'ğŸ¯ æœ€åä¸€ä¸ª';
      case 'all': return 'ğŸ“‹ æ‰¹é‡å…¨éƒ¨';
      case 'match-original': return 'ğŸ¯ ç²¾ç¡®åŒ¹é…';
      case 'random': return 'ğŸ² éšæœºé€‰æ‹©';
      default: return mode;
    }
  };
  
  switch (key) {
    case 'first':
      setSelectionMode('first');
      await saveConfigDirectly('first', null);  // âœ… ç›´æ¥ä¼ å…¥ null
      break;
      
    case 'last':
      setSelectionMode('last');
      await saveConfigDirectly('last', null);  // âœ… ç›´æ¥ä¼ å…¥ null
      break;
      
    case 'all':
      setSelectionMode('all');
      // ğŸ”§ è®¡ç®—æœ€æ–°é…ç½®
      const newBatchConfig = !batchConfig || batchConfig.interval_ms <= 0 ? {
        interval_ms: 2000,
        max_count: 10,
        jitter_ms: 500,
        continue_on_error: true,
        show_progress: true,
        match_direction: 'forward' as const,
      } : batchConfig;
      
      if (!batchConfig || batchConfig.interval_ms <= 0) {
        setBatchConfig(newBatchConfig);
      }
      
      // âœ… ç›´æ¥ä½¿ç”¨è®¡ç®—å‡ºçš„æœ€æ–°é…ç½®
      await saveConfigDirectly('all', newBatchConfig);
      break;
      
    // ... å…¶ä»–æ¨¡å¼
  }
};
```

---

## ğŸ”‘ å…³é”®æ”¹è¿›ç‚¹

### 1. **å†…è”ä¿å­˜å‡½æ•°**

```tsx
// ä¿®å¤å‰ï¼šä½¿ç”¨å¤–éƒ¨å‡½æ•°ï¼ˆé—­åŒ…é™·é˜±ï¼‰
await autoSaveConfig('all');  // âŒ ä½¿ç”¨é—­åŒ…ä¸­çš„æ—§ batchConfig

// ä¿®å¤åï¼šå†…è”å‡½æ•°ï¼Œæ˜¾å¼ä¼ å‚
await saveConfigDirectly('all', newBatchConfig);  // âœ… ä½¿ç”¨æœ€æ–°è®¡ç®—çš„å€¼
```

### 2. **æ˜¾å¼å‚æ•°ä¼ é€’**

```tsx
const saveConfigDirectly = async (
  mode: SelectionMode,        // âœ… æ˜¾å¼ä¼ å…¥æ¨¡å¼
  batchCfg: BatchConfig | null // âœ… æ˜¾å¼ä¼ å…¥é…ç½®
) => {
  await invoke('save_smart_selection_config', {
    selectionMode: mode,
    batchConfig: batchCfg  // âœ… ç›´æ¥ä½¿ç”¨å‚æ•°ï¼Œä¸ä¾èµ–é—­åŒ…
  });
};
```

### 3. **ç”¨æˆ·åé¦ˆå¢å¼º**

```tsx
message.success(`å·²åˆ‡æ¢åˆ°: ${getModeLabel(mode)}`);
// æ˜¾ç¤ºï¼š
// "å·²åˆ‡æ¢åˆ°: ğŸ¯ ç¬¬ä¸€ä¸ª"
// "å·²åˆ‡æ¢åˆ°: ğŸ¯ æœ€åä¸€ä¸ª"
// "å·²åˆ‡æ¢åˆ°: ğŸ“‹ æ‰¹é‡å…¨éƒ¨"
```

### 4. **æ”¹è¿›æ—¥å¿—**

```tsx
console.log('âœ… [æ¨¡å¼åˆ‡æ¢] é…ç½®ä¿å­˜æˆåŠŸ:', { mode, batchConfig: batchCfg });
// ç°åœ¨ä¼šæ˜¾ç¤ºå®é™…ä¿å­˜çš„å€¼ï¼Œä¾¿äºè°ƒè¯•
```

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### æµ‹è¯•æ­¥éª¤

1. **æ‰“å¼€F12 Console**
2. **åˆ‡æ¢åˆ°"ç¬¬ä¸€ä¸ª"**ï¼š
   ```
   ğŸ“¤ ç›´æ¥ä¿å­˜é…ç½®: { mode: "first", batchConfig: null }
   âœ… é…ç½®ä¿å­˜æˆåŠŸ: { mode: "first", batchConfig: null }
   ```
3. **åˆ‡æ¢åˆ°"æ‰¹é‡å…¨éƒ¨"**ï¼š
   ```
   ğŸ“¤ ç›´æ¥ä¿å­˜é…ç½®: { mode: "all", batchConfig: { interval_ms: 2000, ... } }
   âœ… é…ç½®ä¿å­˜æˆåŠŸ: { mode: "all", batchConfig: {...} }
   ```
4. **åˆ‡æ¢åˆ°"æœ€åä¸€ä¸ª"**ï¼š
   ```
   ğŸ“¤ ç›´æ¥ä¿å­˜é…ç½®: { mode: "last", batchConfig: null }
   âœ… é…ç½®ä¿å­˜æˆåŠŸ: { mode: "last", batchConfig: null }
   ```

### åç«¯éªŒè¯

åœ¨ Rust åç«¯æŸ¥çœ‹æ—¥å¿—ï¼š

```rust
// src-tauri/src/commands/smart_selection.rs (å‡è®¾)
tracing::info!("ğŸ’¾ ä¿å­˜æ™ºèƒ½é€‰æ‹©é…ç½®: stepId={}, mode={:?}, batchConfig={:?}", 
    step_id, selection_mode, batch_config);
```

åº”è¯¥çœ‹åˆ°ï¼š
- åˆ‡æ¢åˆ°"ç¬¬ä¸€ä¸ª" â†’ `mode=Some("first"), batchConfig=None`
- åˆ‡æ¢åˆ°"æ‰¹é‡å…¨éƒ¨" â†’ `mode=Some("all"), batchConfig=Some({...})`
- åˆ‡æ¢åˆ°"æœ€åä¸€ä¸ª" â†’ `mode=Some("last"), batchConfig=None`

---

## ğŸ“Š å¯¹æ¯”ä¸‰æ¬¡ä¿®å¤

| é—®é¢˜ | é—­åŒ…é™·é˜±åŸå›  | ä¿®å¤æ–¹æ³• |
|------|------------|---------|
| **match_direction** | `autoSaveConfig` æ•è·æ—§ `batchConfig` | å†…è”è°ƒç”¨ `invoke`ï¼Œä½¿ç”¨ `newBatchConfig` |
| **selectionMode** | `autoSaveConfig` æ•è·æ—§ `batchConfig` | å†…è”å‡½æ•° `saveConfigDirectly`ï¼Œæ˜¾å¼ä¼ å‚ |
| **æ‰¹é‡å‚æ•°** | ä¿®æ”¹é—´éš”/æ•°é‡åï¼Œ`batchConfig` æœªæ›´æ–° | æ¯æ¬¡ä¿®æ”¹ç«‹å³è°ƒç”¨ä¿å­˜ï¼ˆå·²ä¿®å¤ï¼‰|

### å…±åŒæ¨¡å¼

```tsx
// âŒ é—­åŒ…é™·é˜±æ¨¡å¼
const handler = async () => {
  setState(newValue);  // å¼‚æ­¥æ›´æ–°
  await saveFunction();  // ç«‹å³æ‰§è¡Œï¼Œä½¿ç”¨é—­åŒ…ä¸­çš„æ—§å€¼ âŒ
};

// âœ… æ­£ç¡®æ¨¡å¼
const handler = async () => {
  const newValue = computeNewValue();
  setState(newValue);  // æ›´æ–°çŠ¶æ€
  await saveFunction(newValue);  // ä½¿ç”¨å±€éƒ¨è®¡ç®—çš„æ–°å€¼ âœ…
};
```

---

## ğŸ¯ å½±å“åˆ†æ

### âœ… å·²ä¿®å¤

- åˆ‡æ¢åˆ°"ç¬¬ä¸€ä¸ª"ï¼šç«‹å³ä¿å­˜ `mode: "first"`
- åˆ‡æ¢åˆ°"æœ€åä¸€ä¸ª"ï¼šç«‹å³ä¿å­˜ `mode: "last"`
- åˆ‡æ¢åˆ°"æ‰¹é‡å…¨éƒ¨"ï¼šç«‹å³ä¿å­˜ `mode: "all"` + å®Œæ•´é…ç½®
- ç”¨æˆ·ç•Œé¢åé¦ˆï¼šæ˜¾ç¤ºåˆ‡æ¢æˆåŠŸæ¶ˆæ¯

### ğŸ”§ ç›¸å…³åŠŸèƒ½

- `save_smart_selection_config` å‘½ä»¤
- `STEP_STRATEGY_STORE` æŒä¹…åŒ–
- æ‰¹é‡æ‰§è¡Œå‚æ•°é…ç½®
- åŒ¹é…æ–¹å‘æ§åˆ¶

### ğŸ“ æµ‹è¯•æ¸…å•

- [ ] åˆ‡æ¢åˆ°"ç¬¬ä¸€ä¸ª"ï¼Œåˆ·æ–°é¡µé¢ï¼Œä»æ˜¯"ç¬¬ä¸€ä¸ª" âœ…
- [ ] åˆ‡æ¢åˆ°"æœ€åä¸€ä¸ª"ï¼Œåˆ·æ–°é¡µé¢ï¼Œä»æ˜¯"æœ€åä¸€ä¸ª" âœ…
- [ ] åˆ‡æ¢åˆ°"æ‰¹é‡å…¨éƒ¨"ï¼Œåˆ·æ–°é¡µé¢ï¼Œä»æ˜¯"æ‰¹é‡å…¨éƒ¨" âœ…
- [ ] æ‰¹é‡æ¨¡å¼ä¸‹ä¿®æ”¹å‚æ•°ï¼Œç«‹å³ç”Ÿæ•ˆ âœ…
- [ ] ä¸åŒæ­¥éª¤çš„é…ç½®ç›¸äº’ç‹¬ç«‹ âœ…

---

## ğŸ“ Reacté—­åŒ…é™·é˜±å®Œæ•´æ€»ç»“

### å…¸å‹åœºæ™¯

1. **çŠ¶æ€æ›´æ–° + ç«‹å³ä½¿ç”¨**
   ```tsx
   setState(newValue);
   useOldValue();  // âŒ é—­åŒ…ä¸­çš„æ—§å€¼
   ```

2. **å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨çŠ¶æ€**
   ```tsx
   const callback = () => {
     console.log(someState);  // âŒ æ•è·å®šä¹‰æ—¶çš„å€¼
   };
   ```

3. **å¼‚æ­¥æ“ä½œä¸­ä½¿ç”¨çŠ¶æ€**
   ```tsx
   const handler = async () => {
     setState(newValue);
     await asyncFunction(someState);  // âŒ æ—§å€¼
   };
   ```

### è§£å†³æ–¹æ¡ˆ

| æ–¹æ³• | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|---------|------|
| **å±€éƒ¨å˜é‡** | ç®€å•å€¼è®¡ç®— | `const newVal = compute(); setState(newVal); use(newVal);` |
| **useCallbackä¾èµ–** | å›è°ƒå‡½æ•° | `useCallback(() => {...}, [state])` |
| **useRef** | éœ€è¦å¯å˜å¼•ç”¨ | `const ref = useRef(state); ref.current = state;` |
| **å†…è”é€»è¾‘** | ä¸€æ¬¡æ€§æ“ä½œ | ç›´æ¥åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­è®¡ç®—å’Œä½¿ç”¨ |

---

## ğŸ“Œ æ€»ç»“

- **é—®é¢˜æœ¬è´¨**: React é—­åŒ…æ•è·äº†æ—§çš„çŠ¶æ€å€¼
- **ä¿®å¤ç­–ç•¥**: å†…è”ä¿å­˜å‡½æ•°ï¼Œæ˜¾å¼ä¼ é€’æœ€æ–°è®¡ç®—çš„å€¼
- **é™„åŠ ä»·å€¼**: æ·»åŠ äº†ç”¨æˆ·å‹å¥½çš„åˆ‡æ¢åé¦ˆæ¶ˆæ¯
- **æµ‹è¯•è¦ç‚¹**: éªŒè¯æ¯æ¬¡åˆ‡æ¢ååç«¯ä¿å­˜çš„é…ç½®æ˜¯å¦æ­£ç¡®

**ç”¨æˆ·åé¦ˆ**: âœ… "åˆ‡æ¢æ¨¡å¼åé…ç½®æ²¡æœ‰å®æ—¶æ›´æ–°ï¼Œè¿˜æ˜¯åˆå§‹åŒ–é€‰é¡¹"ï¼ˆå·²ä¿®å¤ï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ‰¹é‡æ‰§è¡Œæ–¹å‘å®æ—¶æ›´æ–°ä¿®å¤](./æ‰¹é‡æ‰§è¡Œæ–¹å‘å®æ—¶æ›´æ–°ä¿®å¤.md) - ç›¸åŒçš„é—­åŒ…é—®é¢˜
- [SelectionModeç±»å‹ä¸åŒ¹é…ä¿®å¤](./SelectionModeç±»å‹ä¸åŒ¹é…ä¿®å¤.md) - æ¨¡å¼æšä¸¾æ ¼å¼é—®é¢˜
- [ç§»é™¤ä¸å¿…è¦çš„prefer_lasté€»è¾‘](./ç§»é™¤ä¸å¿…è¦çš„prefer_lasté€»è¾‘.md) - å•æ­¥æ¨¡å¼ä¼˜åŒ–
