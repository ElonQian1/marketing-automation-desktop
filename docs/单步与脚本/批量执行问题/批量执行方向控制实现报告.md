# æ‰¹é‡æ‰§è¡Œæ–¹å‘æ§åˆ¶å®ç°æŠ¥å‘Š

## ğŸ“‹ èƒŒæ™¯

**é—®é¢˜**ï¼šæ‰¹é‡å…¨éƒ¨æ¨¡å¼æ‰§è¡Œé¡ºåºæ˜¯ä»æœ€åå¾€å‰ï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰ï¼Œä¸ç”¨æˆ·é¢„æœŸçš„ä»ä¸Šåˆ°ä¸‹ä¸ç¬¦ã€‚

**åŸå› **ï¼š
- `multi_candidate_evaluator.rs` ä¸­è®¾ç½®äº† `prefer_last: true`
- è®¾è®¡æ„å›¾æ˜¯é¿å…é€‰é”™åˆ—è¡¨ç¬¬ä¸€é¡¹ï¼ˆå¦‚æ ‡é¢˜ï¼‰
- ä½†åœ¨æ‰¹é‡æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡éƒ½é€‰æœ€åä¸€ä¸ªï¼Œå¯¼è‡´é€†åºæ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼šæ–°å¢ç”¨æˆ·å¯é…ç½®çš„"åŒ¹é…æ–¹å‘"å‚æ•°ï¼Œè®©ç”¨æˆ·é€‰æ‹©æ­£å‘/åå‘æ‰§è¡Œã€‚

---

## ğŸ¯ å®ç°æ–¹æ¡ˆ

### 1. æ•°æ®ç»“æ„æ‰©å±•

#### åç«¯ Rust (`batch_executor.rs`)
```rust
pub struct BatchExecutionConfig {
    pub max_count: usize,
    pub interval_ms: u64,
    pub continue_on_error: bool,
    pub show_progress: bool,
    pub match_direction: String,  // ğŸ†• "forward" | "backward"
    pub target_text: String,
    pub step_id: String,
}
```

**è§£æé€»è¾‘**ï¼š
- æ”¯æŒè›‡å½¢å‘½åï¼š`match_direction`
- å…¼å®¹é©¼å³°å‘½åï¼š`matchDirection`
- é»˜è®¤å€¼ï¼š`"forward"`ï¼ˆæ­£å‘ï¼‰

#### å‰ç«¯ TypeScript (`CompactStrategyMenu.tsx`)
```typescript
interface BatchConfig {
  interval_ms: number;
  max_count?: number;
  jitter_ms?: number;
  continue_on_error: boolean;
  show_progress: boolean;
  match_direction?: 'forward' | 'backward';  // ğŸ†•
}
```

---

### 2. æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ (`step_executor.rs`)

#### å‡½æ•°ç­¾åå˜æ›´
```rust
// ä¿®æ”¹å‰
fn evaluate_best_candidate<'a>(
    candidate_elements: Vec<&'a UIElement>,
    params: &serde_json::Value,
    ui_xml: &str,
    is_batch_mode: bool,  // âŒ å¸ƒå°”å€¼ä¸å¤Ÿçµæ´»
) -> Result<Option<&'a UIElement>, String>

// ä¿®æ”¹å
fn evaluate_best_candidate<'a>(
    candidate_elements: Vec<&'a UIElement>,
    params: &serde_json::Value,
    ui_xml: &str,
    match_direction: Option<&str>,  // âœ… æ”¯æŒ None/forward/backward
) -> Result<Option<&'a UIElement>, String>
```

#### prefer_last å†³ç­–é€»è¾‘
```rust
prefer_last: match match_direction {
    Some("forward") => false,   // æ­£å‘ï¼šä»ç¬¬ä¸€ä¸ªå¼€å§‹
    Some("backward") => true,   // åå‘ï¼šä»æœ€åä¸€ä¸ªå¼€å§‹
    _ => true,                  // å•æ­¥æ¨¡å¼ï¼šä¼˜å…ˆé€‰æ‹©æœ€åä¸€ä¸ªï¼ˆé¿å…åˆ—è¡¨æ ‡é¢˜ï¼‰
},
```

#### è°ƒç”¨ç‚¹æ›´æ–°
1. **å•æ­¥æ¨¡å¼**ï¼š
```rust
evaluate_best_candidate(candidates, params, ui_xml, None)
// match_direction = None â†’ prefer_last = true
```

2. **æ‰¹é‡æ¨¡å¼**ï¼š
```rust
evaluate_best_candidate(candidates, params, ui_xml, Some(&config.match_direction))
// match_direction = Some("forward") â†’ prefer_last = false
// match_direction = Some("backward") â†’ prefer_last = true
```

---

### 3. UI ç»„ä»¶å®ç°

#### é€‰æ‹©å™¨ä½ç½®
æ‰¹é‡é…ç½®é¢æ¿ä¸­ï¼Œæ”¾åœ¨"æ˜¾ç¤ºè¿›åº¦"åé¢ï¼š

```tsx
{/* ğŸ†• åŒ¹é…æ–¹å‘ */}
<div style={{ display: "flex", alignItems: "center", gap: "6px" }}>
  <span style={{ fontSize: "11px", color: "#94A3B8" }}>æ–¹å‘:</span>
  <select
    value={batchConfig.match_direction || 'forward'}
    onChange={async (e) => {
      const newDirection = e.target.value as 'forward' | 'backward';
      setBatchConfig({
        ...batchConfig,
        match_direction: newDirection
      });
      // ğŸ”¥ ç«‹å³ä¿å­˜é…ç½®
      if (selectionMode === 'all') {
        console.log('ğŸ”§ [åŒ¹é…æ–¹å‘ä¿®æ”¹] ä¿å­˜é…ç½®:', newDirection);
        await autoSaveConfig('all');
      }
    }}
    style={{
      height: "24px",
      fontSize: "11px",
      padding: "0 4px",
      border: "1px solid rgba(110, 139, 255, 0.3)",
      borderRadius: "3px",
      background: "rgba(0, 0, 0, 0.2)",
      color: "#F8FAFC",
      cursor: "pointer"
    }}
  >
    <option value="forward">â†“ æ­£å‘</option>
    <option value="backward">â†‘ åå‘</option>
  </select>
  <Tooltip title="æ­£å‘:ä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ | åå‘:ä»ä¸‹åˆ°ä¸Šæ‰§è¡Œ" placement="top">
    <span style={{ fontSize: "11px", color: "#6E8BFF", cursor: "help" }}>?</span>
  </Tooltip>
</div>
```

#### è‡ªåŠ¨ä¿å­˜
- é€‰æ‹©æ”¹å˜æ—¶ç«‹å³è°ƒç”¨ `autoSaveConfig('all')`
- é…ç½®ä¿å­˜åˆ° `STEP_STRATEGY_STORE`
- æ‰§è¡Œæ—¶ä» Store è¯»å–é…ç½®

---

## ğŸ”„ å®Œæ•´æ•°æ®æµ

```mermaid
graph LR
    A[ç”¨æˆ·é€‰æ‹©æ–¹å‘] --> B[CompactStrategyMenu.tsx]
    B --> C[autoSaveConfig]
    C --> D[save_smart_selection_config]
    D --> E[STEP_STRATEGY_STORE]
    
    F[ç”¨æˆ·ç‚¹å‡»æ‰§è¡Œ] --> G[StepExecutionGateway]
    G --> H[get_step_strategy]
    H --> E
    E --> I[è¿”å›é…ç½®]
    I --> J[execute_chain_test_v3]
    J --> K[step_executor.rs]
    K --> L[BatchExecutionConfig::from_params]
    L --> M[match_direction: forward/backward]
    M --> N[evaluate_best_candidate]
    N --> O{match_direction?}
    O -->|forward| P[prefer_last = false]
    O -->|backward| Q[prefer_last = true]
    O -->|None| Q
    P --> R[ä»ç¬¬ä¸€ä¸ªå¼€å§‹]
    Q --> S[ä»æœ€åä¸€ä¸ªå¼€å§‹]
```

---

## âœ… æµ‹è¯•å»ºè®®

### æ­£å‘æ¨¡å¼ï¼ˆforwardï¼‰
1. è®¾ç½®"æ–¹å‘: â†“ æ­£å‘"
2. æ‰§è¡Œæ‰¹é‡å…¨éƒ¨
3. **é¢„æœŸ**ï¼šä»ä¸Šåˆ°ä¸‹ä¾æ¬¡ç‚¹å‡»ï¼ˆç¬¬1ã€2ã€3...ï¼‰
4. **æ—¥å¿—éªŒè¯**ï¼š
```
[æ‰¹é‡æ‰§è¡Œ 1/10] æ‰¾åˆ°ç›®æ ‡: bounds=[754,348][943,422]
[æ‰¹é‡æ‰§è¡Œ 2/10] æ‰¾åˆ°ç›®æ ‡: bounds=[754,564][943,638]
[æ‰¹é‡æ‰§è¡Œ 3/10] æ‰¾åˆ°ç›®æ ‡: bounds=[754,789][943,863]
```

### åå‘æ¨¡å¼ï¼ˆbackwardï¼‰
1. è®¾ç½®"æ–¹å‘: â†‘ åå‘"
2. æ‰§è¡Œæ‰¹é‡å…¨éƒ¨
3. **é¢„æœŸ**ï¼šä»ä¸‹åˆ°ä¸Šä¾æ¬¡ç‚¹å‡»ï¼ˆç¬¬10ã€9ã€8...ï¼‰
4. **æ—¥å¿—éªŒè¯**ï¼š
```
[æ‰¹é‡æ‰§è¡Œ 1/10] æ‰¾åˆ°ç›®æ ‡: bounds=[754,2319][943,2393]
[æ‰¹é‡æ‰§è¡Œ 2/10] æ‰¾åˆ°ç›®æ ‡: bounds=[754,2103][943,2177]
[æ‰¹é‡æ‰§è¡Œ 3/10] æ‰¾åˆ°ç›®æ ‡: bounds=[754,1878][943,1952]
```

---

## ğŸ¨ UI æ•ˆæœ

### æ‰¹é‡é…ç½®é¢æ¿
```
ğŸ“‹ æ‰¹é‡æ‰§è¡Œé…ç½®

é—´éš”: [2000] ms  æœ€å¤§: [10]  â˜‘ é‡é”™ç»§ç»­  â˜‘ æ˜¾ç¤ºè¿›åº¦  æ–¹å‘: [â†“ æ­£å‘ â–¼] ?
```

### Tooltip æç¤º
```
æ­£å‘: ä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ
åå‘: ä»ä¸‹åˆ°ä¸Šæ‰§è¡Œ
```

---

## ğŸ—ï¸ æ¨¡å—åŒ–è®¾è®¡

### éµå¾ªé¡¹ç›®è§„èŒƒ
âœ… **å±‚æ¬¡åˆ†ç¦»**ï¼š
- å‰ç«¯ UI å±‚ï¼š`CompactStrategyMenu.tsx`
- å‰ç«¯åŸºç¡€è®¾æ–½ï¼š`StepExecutionGateway.ts`
- åç«¯åº”ç”¨å±‚ï¼š`step_executor.rs`
- åç«¯è¾…åŠ©å±‚ï¼š`batch_executor.rs`

âœ… **å‘½åè§„èŒƒ**ï¼š
- å‰ç«¯ä½¿ç”¨ `match_direction`ï¼ˆè›‡å½¢ï¼‰
- åç«¯å…¼å®¹ `match_direction` å’Œ `matchDirection`

âœ… **å‘åå…¼å®¹**ï¼š
- æ—§ç‰ˆæœ¬é…ç½®æ²¡æœ‰ `match_direction` æ—¶ï¼Œé»˜è®¤ä½¿ç”¨ `"forward"`
- å•æ­¥æ¨¡å¼ä¸å—å½±å“ï¼ˆ`match_direction = None`ï¼‰

---

## ğŸ“Š å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶
- `src-tauri/src/exec/v3/helpers/batch_executor.rs` - æ·»åŠ å­—æ®µå’Œè§£æ
- `src-tauri/src/exec/v3/helpers/step_executor.rs` - ä¿®æ”¹é€»è¾‘
- `src/components/strategy-selector/CompactStrategyMenu.tsx` - æ·»åŠ  UI æ§ä»¶

### ä¸å½±å“çš„åŠŸèƒ½
- âœ… å•æ­¥æ¨¡å¼æ‰§è¡Œ
- âœ… æ‰¹é‡ç¬¬ä¸€ä¸ªæ¨¡å¼
- âœ… æ™ºèƒ½åˆ†æå’Œç­–ç•¥ç”Ÿæˆ
- âœ… é…ç½®ä¿å­˜å’Œè¯»å–
- âœ… å…¶ä»–æ‰¹é‡å‚æ•°ï¼ˆé—´éš”ã€æ•°é‡ã€é‡é”™ç»§ç»­ç­‰ï¼‰

---

## ğŸ¯ ç”¨æˆ·ä»·å€¼

1. **çµæ´»æ€§**ï¼šç”¨æˆ·å¯æ ¹æ®å®é™…åœºæ™¯é€‰æ‹©æ‰§è¡Œé¡ºåº
2. **ç›´è§‚æ€§**ï¼šUI æ¸…æ™°æ˜¾ç¤º"æ­£å‘/åå‘"ï¼Œå¸¦ Tooltip è¯´æ˜
3. **æŒä¹…åŒ–**ï¼šé…ç½®è‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡ä½¿ç”¨æ— éœ€é‡æ–°è®¾ç½®
4. **å‘åå…¼å®¹**ï¼šæ—§ç‰ˆæœ¬æ•°æ®è‡ªåŠ¨è¡¥å……é»˜è®¤å€¼
5. **æ¨¡å—åŒ–**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

---

## ğŸ”® åç»­ä¼˜åŒ–æ–¹å‘

1. **å¯è§†åŒ–é¢„è§ˆ**ï¼šåœ¨ UI ä¸­æ˜¾ç¤ºæ‰§è¡Œé¡ºåºçš„ç®­å¤´æŒ‡ç¤º
2. **æ™ºèƒ½æ¨è**ï¼šæ ¹æ®å…ƒç´ ç±»å‹ï¼ˆå¦‚å…³æ³¨æŒ‰é’®ï¼‰è‡ªåŠ¨æ¨èæ–¹å‘
3. **å¿«æ·é”®**ï¼šæä¾›å¿«æ·é”®åˆ‡æ¢æ­£å‘/åå‘
4. **æ‰§è¡ŒåŠ¨ç”»**ï¼šæ‰§è¡Œæ—¶é«˜äº®æ˜¾ç¤ºå½“å‰å¤„ç†çš„å…ƒç´ 

---

**å®ç°æ—¥æœŸ**ï¼š2025-10-29  
**å®ç°è€…**ï¼šAI Assistant  
**ç‰ˆæœ¬**ï¼šv1.0
