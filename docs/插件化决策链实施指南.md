# åŒæ„å†³ç­–é“¾æ’ä»¶åŒ–ç³»ç»Ÿ - å®æ–½æŒ‡å—

## ğŸ¯ ä¸€å¥è¯æ€»ç»“

**å‰ç«¯é™æ€åˆ†æç”ŸæˆPlané…æ–¹ï¼Œåç«¯æŒ‰é…æ–¹æ’ä»¶åŒ–æ‰§è¡Œï¼Œé€šè¿‡ç»Ÿä¸€è¯„åˆ†ç®—æ³•ä¿è¯"æƒ³çš„"å’Œ"åšçš„"å®Œå…¨ä¸€è‡´ã€‚**

---

## ğŸ“‹ å¿«é€Ÿæ£€æŸ¥æ¸…å•ï¼ˆç…§åšå°±è¡Œï¼‰

### Phase 1: åŸºç¡€æ¶æ„ âœ… 
- [x] **Planå¥‘çº¦**: `src-tauri/src/shared/plan_schema.json` (ç‰ˆæœ¬åŒ–JSON Schema)
- [x] **ç­–ç•¥æ’ä»¶æ¥å£**: `strategy_plugin.rs` (ç»Ÿä¸€StrategyExecutor trait)
- [x] **ç­–ç•¥æ³¨å†Œè¡¨**: 8ä¸ªæ ¸å¿ƒæ’ä»¶è‡ªåŠ¨æ³¨å†Œ
- [x] **å®‰å…¨é—¸é—¨**: `gating.rs` (å”¯ä¸€æ€§åŒåˆ¤+å®¹å™¨æ‹¦æˆª+è½»æ ¡éªŒ)
- [x] **XMLç´¢å¼•å™¨**: `xml_indexer.rs` (æŒ‰id/class/textå»ºæ¡¶ï¼Œæå‡æœç´¢æ•ˆç‡)
- [x] **å›é€€æ§åˆ¶å™¨**: `FallbackController` (æŒ‰Plané¡ºåºå—æ§å›é€€)

### Phase 2: æ ¸å¿ƒæ‰§è¡Œå¼•æ“ âœ…
- [x] **ç»Ÿä¸€è¯„åˆ†**: `UnifiedScoringCore` (ä¸‰æ€è¯„åˆ†ï¼šåŒ¹é…/ç¼ºå¤±/ä¸ä¸€è‡´)
- [x] **æ‰§è¡Œç¯å¢ƒ**: `ExecutionEnvironment` (çœŸæœºä¸Šä¸‹æ–‡å°è£…)
- [x] **æ’ä»¶åŒ–å…¥å£**: `run_decision_chain_v2` (æ–°çš„Tauriå‘½ä»¤)
- [x] **å®Œæ•´æ•°æ®æµ**: ä»Planè§£æåˆ°ç­–ç•¥æ‰§è¡Œçš„å…¨Pipeline

### Phase 3: æµ‹è¯•éªŒè¯ âœ…
- [x] **é›†æˆæµ‹è¯•**: `decision_chain_test.rs` (è¦†ç›–å…³é”®ç»„ä»¶)
- [x] **Planæ ·ä¾‹**: å®Œæ•´çš„RegionTextToParentç¤ºä¾‹
- [x] **å¥åº·æ£€æŸ¥**: `get_decision_chain_stats` å‘½ä»¤

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨æ–°ç³»ç»Ÿ

### 1ï¸âƒ£ å‰ç«¯å‘é€Planï¼ˆæ–°æ ¼å¼ï¼‰

```javascript
const planV2 = {
  version: "v2",
  strategy: {
    selected: "RegionTextToParent#1",
    allow_backend_fallback: true,
    time_budget_ms: 1200,
    per_candidate_budget_ms: 180,
    require_uniqueness: true,
    min_confidence: 0.7,
    forbid_containers: true
  },
  context: {
    package: "com.app",
    activity: "MainActivity", 
    screen: {width: 1080, height: 2400, dpi: 480, orientation: "portrait"},
    absolute_xpath: "/hierarchy/android.widget.FrameLayout[1]/...",
    xml_hash: "abc123...",
    container_anchor: {
      by: "id",
      value: "com.app:id/bottom_navigation"
    },
    clickable_parent_hint: {up_levels: 1}
  },
  child_anchors: [
    {
      anchor_type: "text",
      equals: "æ”¶è—",
      i18n_alias: ["Favorites", "Starred"]
    }
  ],
  plan: [
    {
      id: "RegionTextToParent#1",
      kind: "RegionTextToParent", 
      scope: "regional",
      selectors: {
        parent: {class: "android.widget.LinearLayout", clickable: true},
        child: {text: {in_list: ["æ”¶è—", "Favorites", "Starred"]}}
      },
      checks: [{check_type: "child_text_contains_any", values: ["æ”¶", "Fav"]}],
      static_score: 0.92,
      explain: "å®¹å™¨å†…å­æ–‡æœ¬é”šç‚¹â†’çˆ¶æ‰§è¡Œ"
    }
    // ... æ›´å¤šå¤‡é€‰ç­–ç•¥æŒ‰ä¼˜å…ˆçº§æ’åº
  ]
};

// è°ƒç”¨æ–°çš„æ’ä»¶åŒ–æ¥å£
const result = await invoke('run_decision_chain_v2', {
  planJson: JSON.stringify(planV2)
});
```

### 2ï¸âƒ£ åç«¯è‡ªåŠ¨å¤„ç†ï¼ˆæ’ä»¶åŒ–Pipelineï¼‰

```rust
// ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

// 1. Planè§£æ+JSON SchemaéªŒè¯
let plan: DecisionChainPlan = serde_json::from_str(&plan_json)?;

// 2. æ„å»ºçœŸæœºæ‰§è¡Œç¯å¢ƒ
let env = ExecutionEnvironment { ui_xml, package, activity, ... };

// 3. è·å–ç­–ç•¥æ³¨å†Œè¡¨+XMLç´¢å¼•
let registry = StrategyRegistry::new(); // 8ä¸ªæ’ä»¶è‡ªåŠ¨æ³¨å†Œ
let indexer = XmlIndexer::build_from_xml(&ui_xml)?;

// 4. æ‰§è¡Œselectedç­–ç•¥
let executor = registry.get_executor("RegionTextToParent")?;
let matches = executor.find_matches(&env, &selected_variant)?;

// 5. å®‰å…¨é—¸é—¨éªŒè¯
let validated = SafetyGatekeeper::comprehensive_validation(&matches, &variant, 0.7, true)?;

// 6. æ‰§è¡ŒåŠ¨ä½œ
let result = executor.execute_action(&validated, &variant)?;

// 7. å¤±è´¥æ—¶æŒ‰Planè‡ªåŠ¨å›é€€
if !result.success && allow_fallback {
    FallbackController::execute_with_fallback(&env, &plan, &registry).await?;
}
```

---

## ğŸ§© å¦‚ä½•æ–°å¢ç­–ç•¥æ’ä»¶

### æ­¥éª¤1: åœ¨Schemaä¸­å£°æ˜æ–°ç­–ç•¥
```json
// plan_schema.json
"kind": {
  "enum": [
    "SelfId", "SelfDesc", "ChildToParent", "RegionTextToParent",
    "NewCustomStrategy"  // ğŸ‘ˆ æ–°å¢
  ]
}
```

### æ­¥éª¤2: å®ç°Executoræ’ä»¶
```rust
// æ–°å»º strategies/new_custom_strategy.rs
pub struct NewCustomStrategyExecutor;

impl StrategyExecutor for NewCustomStrategyExecutor {
    fn name(&self) -> &'static str { "NewCustomStrategy" }
    
    fn can_execute(&self, variant: &StrategyVariant) -> bool {
        matches!(variant.kind, VariantKind::NewCustomStrategy)
    }
    
    fn find_matches(&self, env: &ExecutionEnvironment, variant: &StrategyVariant) -> Result<MatchSet> {
        // å®ç°è‡ªå®šä¹‰åŒ¹é…é€»è¾‘
    }
    
    fn score_match(&self, evidence: &StaticEvidence, candidate: &UIElement) -> f32 {
        // ä½¿ç”¨ç»Ÿä¸€è¯„åˆ†å¼•æ“
        UnifiedScoringCore::calculate_tristate_score(evidence, candidate)
    }
    
    fn execute_action(&self, target: &MatchCandidate, variant: &StrategyVariant) -> Result<ExecutionResult> {
        // å®ç°è‡ªå®šä¹‰æ‰§è¡Œé€»è¾‘
    }
}
```

### æ­¥éª¤3: æ³¨å†Œåˆ°æ³¨å†Œè¡¨
```rust
// strategy_plugin.rs
fn register_builtin_strategies(&mut self) {
    // ... ç°æœ‰ç­–ç•¥
    self.register(Box::new(NewCustomStrategyExecutor)); // ğŸ‘ˆ æ–°å¢
}
```

---

## ğŸ›¡ï¸ å®‰å…¨ä¸æ€§èƒ½ä¿éšœ

### ä¸‰é‡å®‰å…¨é—¸é—¨
1. **å”¯ä¸€æ€§åŒåˆ¤**: é˜ˆå€¼å”¯ä¸€(confidenceâ‰¥0.7ä¸”count=1) OR é—´éš”å”¯ä¸€(Top1-Top2â‰¥0.15)
2. **å®¹å™¨æ‹¦æˆª**: è‡ªåŠ¨æ‹’ç»æ•´å±/å®¹å™¨ç±»èŠ‚ç‚¹
3. **è½»æ ¡éªŒ**: å‘½ä¸­åå†ç¡®è®¤clickable/enabled/å­æ ‘æ–‡æœ¬

### æ€§èƒ½ä¼˜åŒ–
- **XMLç´¢å¼•**: æŒ‰resource-id/class/textå»ºæ¡¶ï¼ŒO(1)æŸ¥æ‰¾
- **å®¹å™¨é™å®š**: ä¼˜å…ˆåœ¨å®¹å™¨å†…æœç´¢ï¼Œå‡å°‘æœç´¢é¢
- **æ—¶é—´é¢„ç®—**: æ€»é¢„ç®—1200msï¼Œå•ç­–ç•¥180msï¼Œè¶…æ—¶è‡ªåŠ¨å›é€€
- **æ™ºèƒ½å›é€€**: å¤±è´¥æ—¶æŒ‰Plané¡ºåºå¿«é€Ÿå°è¯•ï¼Œé¿å…å…¨é‡é‡è¯•

### å¯è§‚æµ‹æ€§
```json
// è¿”å›ç»“æ„åŒ–æ—¥å¿—
{
  "success": true,
  "used_variant": "RegionTextToParent#1", 
  "match_count": 3,
  "final_confidence": 0.87,
  "execution_time_ms": 156,
  "tap_coordinates": [200, 225],
  "fallback_chain": ["SelfId:FAILED:NoMatch"],
  "telemetry": {
    "xml_hash": "abc123...",
    "strategy_count": 5,
    "registry_plugins": 8
  }
}
```

---

## ğŸ”§ å¼€å‘ä¸è°ƒè¯•

### æœ¬åœ°æµ‹è¯•
```bash
# è¿è¡Œå†³ç­–é“¾æµ‹è¯•
cd src-tauri
cargo test decision_chain_test --nocapture

# æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€  
curl -X POST http://localhost:1420 \
  -H "Content-Type: application/json" \
  -d '{"cmd": "get_decision_chain_stats"}'
```

### è°ƒè¯•æŠ€å·§
1. **å¼€å¯è¯¦ç»†æ—¥å¿—**: `RUST_LOG=debug cargo run`
2. **PlanéªŒè¯**: ä½¿ç”¨JSON Schemaåœ¨çº¿éªŒè¯å™¨æ£€æŸ¥Planæ ¼å¼
3. **å•ç­–ç•¥æµ‹è¯•**: ä¸´æ—¶è®¾ç½®`allow_backend_fallback: false`åªæµ‹è¯•selected
4. **XMLæ£€æŸ¥**: ä¿å­˜ui_xmlåˆ°æ–‡ä»¶ï¼Œäººå·¥æ£€æŸ¥èŠ‚ç‚¹ç»“æ„

### å¸¸è§é—®é¢˜
- **"æœªæ‰¾åˆ°ç­–ç•¥æ‰§è¡Œå™¨"**: æ£€æŸ¥VariantKindæšä¸¾æ˜¯å¦åŒ¹é…æ’ä»¶åç§°
- **"å®‰å…¨é—¸é—¨æ‹’ç»"**: æ£€æŸ¥ç½®ä¿¡åº¦é˜ˆå€¼å’Œå”¯ä¸€æ€§æ¡ä»¶
- **"XMLç´¢å¼•æ„å»ºå¤±è´¥"**: æ£€æŸ¥XMLæ ¼å¼ï¼Œç¡®ä¿boundså±æ€§æ­£ç¡®

---

## ğŸ“Š è¿ç§»è·¯çº¿å›¾

### Week 1: åŸºç¡€éªŒè¯
- [x] âœ… éƒ¨ç½²æ’ä»¶åŒ–ç³»ç»Ÿ
- [ ] ğŸ”„ å‰ç«¯é€‚é…æ–°çš„Planæ ¼å¼
- [ ] ğŸ”„ é€‰æ‹©3-5ä¸ªå…¸å‹åœºæ™¯åšA/Bæµ‹è¯•

### Week 2: ç­–ç•¥å®Œå–„  
- [ ] ğŸ“‹ å®ç°RegionTextToParentå®Œæ•´ç‰ˆ
- [ ] ğŸ“‹ å®ç°ChildToParentæ’ä»¶
- [ ] ğŸ“‹ å®ç°RegionLocalIndexWithCheckæ’ä»¶

### Week 3: å…¨é‡åˆ‡æ¢
- [ ] ğŸ“‹ æ‰€æœ‰ç­–ç•¥æ’ä»¶å°±ç»ª
- [ ] ğŸ“‹ æ€§èƒ½å¯¹æ¯”ï¼ˆæ–°ç³»ç»Ÿ vs æ—§ç³»ç»Ÿï¼‰
- [ ] ğŸ“‹ ç°åº¦åˆ‡æ¢åˆ°æ–°ç³»ç»Ÿ

### Week 4: ç›‘æ§ä¼˜åŒ–
- [ ] ğŸ“‹ ç”Ÿäº§ç›‘æ§Dashboard
- [ ] ğŸ“‹ å¤±è´¥åˆ†æå’Œç­–ç•¥è°ƒä¼˜
- [ ] ğŸ“‹ å›¢é˜ŸåŸ¹è®­å’Œæ–‡æ¡£å®Œå–„

---

## ğŸ‰ æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- **ä¸€è‡´æ€§**: å‰åç«¯è¯„åˆ†åå·® < 5%
- **æ€§èƒ½**: å¹³å‡æ‰§è¡Œæ—¶é—´ â‰¤ 200ms
- **ç¨³å®šæ€§**: æˆåŠŸç‡ â‰¥ 95%  
- **å¯ç»´æŠ¤æ€§**: æ–°ç­–ç•¥å¼€å‘æ—¶é—´ â‰¤ 2å¤©

### ä¸šåŠ¡ä»·å€¼
- **å¼€å‘æ•ˆç‡**: æ­¥éª¤å¡ç‰‡åˆ›å»ºæ—¶é—´å‡å°‘ 60%
- **ç»´æŠ¤æˆæœ¬**: å¤šè¯­è¨€é€‚é…å·¥ä½œé‡å‡å°‘ 80%
- **æ•…éšœç‡**: UIè‡ªåŠ¨åŒ–æ•…éšœå‡å°‘ 70%
- **å›¢é˜Ÿæ•ˆèƒ½**: é—®é¢˜å®šä½æ—¶é—´å‡å°‘ 50%

---

## ğŸ’¡ å…³é”®è®¾è®¡äº®ç‚¹

1. **åŒæ„æ€§**: å‰åç«¯ä½¿ç”¨å®Œå…¨ç›¸åŒçš„è¯„åˆ†ç®—æ³•å’Œå†³ç­–é€»è¾‘
2. **å¯æ’æ‹”**: æ–°ç­–ç•¥åƒè£…æ’ä»¶ä¸€æ ·ç®€å•ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒå¼•æ“
3. **å¯æ¼”è¿›**: é€šè¿‡ç‰ˆæœ¬åŒ–å¥‘çº¦æ”¯æŒå¹³æ»‘å‡çº§
4. **é«˜æ€§èƒ½**: XMLç´¢å¼•+å®¹å™¨é™å®š+æ—¶é—´é¢„ç®—å¤šé‡ä¼˜åŒ–
5. **å¯è§‚æµ‹**: ç»“æ„åŒ–æ—¥å¿—+å¤±è´¥åˆ†ç±»+æ‰§è¡Œé“¾è·¯è¿½è¸ª
6. **å·¥ç¨‹åŒ–**: JSON SchemaéªŒè¯+è‡ªåŠ¨åŒ–æµ‹è¯•+å¥åº·æ£€æŸ¥

è¿™å¥—ç³»ç»Ÿè®©"é™æ€åˆ†æå¦‚ä½•æƒ³"ä¸"çœŸæœºå¦‚ä½•åš"**å®Œå…¨å¯¹é½**ï¼Œæ˜¯çœŸæ­£å·¥ç¨‹åŒ–çš„åŒæ„å†³ç­–é“¾å®ç°ï¼ ğŸš€