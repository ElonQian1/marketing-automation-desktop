# 步骤卡片评分显示修复报告

## 📋 问题描述

**用户反馈**：点选元素新建步骤卡片时，策略菜单中没有正确显示每一步的评分。

## 🔍 问题诊断

### 根本原因

`CompactStrategyMenu` 组件中使用了错误的 Zustand 订阅方式：

```ts
// ❌ 错误写法：只获取函数引用，不会触发重新渲染
const { getStepConfidence, setFinalScores } = useAnalysisStateStore();
```

这种写法导致：
1. ✅ 分析完成后，`fillCandidatesScores` 正确填充评分到 store
2. ✅ `buildStrategyMenu` 调用 `getStepConfidence` 查询评分
3. ❌ 但组件**不会重新渲染**，因为没有订阅 store 变化

### 数据流追踪

```
点选元素
  ↓
createStepCardQuick
  ↓
startAnalysis (useIntelligentAnalysis)
  ↓
后端智能分析
  ↓
analysis:done 事件
  ↓
fillCandidatesScores
  ↓
analysisStore.setFinalScores(scores) ← 评分已保存到 store
  ↓
stepScores 更新 ← 但 CompactStrategyMenu 没有订阅此变化！
  ↓
❌ 组件不重新渲染 → 菜单不显示评分
```

## ✅ 修复方案

### 代码修改

**文件**：`src/components/strategy-selector/CompactStrategyMenu.tsx`

```ts
// ✅ 正确写法：订阅 stepScores 变化
const { getStepConfidence, setFinalScores } = useAnalysisStateStore();

// 🔔 订阅 stepScores 变化以触发重新渲染
const stepScores = useAnalysisStateStore((state) => state.stepScores);

// 🔍 调试：打印评分数据
React.useEffect(() => {
  if (stepId && Object.keys(stepScores).length > 0) {
    console.log('🔍 [CompactStrategyMenu] 评分数据已更新:', {
      stepId,
      totalScores: Object.keys(stepScores).length,
      scores: Object.entries(stepScores).map(([key, score]) => ({
        key,
        confidence: `${Math.round(score.confidence * 100)}%`
      }))
    });
  }
}, [stepId, stepScores]);
```

### 修复原理

1. **订阅 store 变化**：`useAnalysisStateStore((state) => state.stepScores)` 会在 `stepScores` 更新时触发重新渲染
2. **保持函数引用**：`getStepConfidence` 和 `setFinalScores` 仍然通过解构获取
3. **自动刷新 UI**：评分更新后，组件重新渲染，`buildStrategyMenu` 调用最新的 `getStepConfidence` 获取评分

## 🎯 测试验证

### 测试步骤

1. 在界面上点选一个元素（例如按钮、文本、卡片）
2. 创建步骤卡片（应该自动触发智能分析）
3. 等待分析完成（观察进度条，约 2-5 秒）
4. 点击步骤卡片标题栏的 **"🧠 智能·单步"** 下拉菜单
5. 验证菜单中的评分显示

### 预期结果

菜单应该显示如下：

```
🧠 智能·单步 ▼
  ├─ 🔄 刷新所有评分
  ├─ ──────────────────
  ├─ Step1 - 卡片子树评分（推荐）  [荐] 85%  ← 显示评分
  ├─ Step2 - 叶子上下文评分（推荐）  [荐] 78%  ← 显示评分
  ├─ Step3 - 自锚定  45%
  ├─ Step4 - 子元素驱动  38%
  ├─ Step5 - 区域约束  32%
  ├─ Step6 - XPath兜底  25%
  ├─ Step7 - 索引兜底  18%
  └─ Step8 - 应急兜底  10%
```

### 调试日志检查

打开浏览器控制台（F12），应该看到：

```
💾 [智能分析] 填充候选项评分: { smartCount: 8, staticCount: 1 }
✅ [智能分析] 已填充评分: [ { key: 'card_subtree_scoring', conf: '85%' }, ... ]
🔍 [CompactStrategyMenu] 评分数据已更新: { stepId: 'xxx', totalScores: 9, scores: [...] }
🔍 [菜单显示] Step1 - 卡片子树评分: { candidateKey: 'card_subtree_scoring', confidence: 0.85, ... }
```

## 📊 技术细节

### 涉及文件

1. **修改**：`src/components/strategy-selector/CompactStrategyMenu.tsx`
   - 添加 `stepScores` 订阅
   - 添加调试日志

2. **已有功能**（无需修改）：
   - `src/hooks/useIntelligentAnalysis.ts`：`fillCandidatesScores` 填充评分
   - `src/components/strategy-selector/menus/strategy-menu-builder.tsx`：`buildStrategyMenu` 显示评分
   - `src/stores/analysis-state-store.ts`：`getStepConfidence` 查询评分

### 评分数据流

```ts
// 1. 分析完成，填充评分
fillCandidatesScores(result: AnalysisResult) {
  const scores = allCandidates.map(candidate => ({
    stepId: candidate.key,  // 例如: 'card_subtree_scoring'
    confidence: candidate.confidence,  // 例如: 0.85
    ...
  }));
  analysisStore.setFinalScores(scores);  // 保存到 store
}

// 2. Store 更新
setFinalScores(scores) {
  scores.forEach(score => {
    state.stepScores[score.stepId] = {  // key: 'card_subtree_scoring'
      confidence: score.confidence,      // value: 0.85
      ...
    };
  });
}

// 3. 组件订阅并重新渲染
const stepScores = useAnalysisStateStore((state) => state.stepScores);  // 触发重新渲染

// 4. 菜单构建时查询评分
const confidence = getStepConfidence('card_subtree_scoring');  // 返回: 0.85
const confidencePercent = toPercentInt01(0.85);  // 返回: 85
```

## ✨ 额外功能

本次修复还包含之前实现的 **点击评分刷新所有步骤** 功能：

1. **刷新入口**：
   - 策略菜单顶部的 "🔄 刷新所有评分" 按钮
   - 任意步骤的评分徽章（点击触发刷新）

2. **刷新逻辑**：
   - 使用最新的 XML 缓存
   - 重新运行智能分析
   - 自动更新所有步骤的评分

3. **相关文件**：
   - `src/components/strategy-selector/utils/refresh-all-scores.ts`：刷新逻辑
   - `src/components/StrategyScoreBadge.tsx`：评分徽章点击支持

## 🎉 修复完成

### 检查清单

- ✅ 添加 `stepScores` 订阅
- ✅ 添加调试日志
- ✅ TypeScript 类型检查通过（无新增错误）
- ✅ 符合项目架构规范（DDD 分层）
- ✅ 不影响现有功能

### 下一步

**测试人员**：按照上述测试步骤验证功能

**开发人员**：如需调试，可在控制台查看日志输出

---

**修复时间**：2024-01-XX  
**修复人员**：GitHub Copilot  
**相关文档**：`点击评分刷新所有步骤功能实现报告.md`
