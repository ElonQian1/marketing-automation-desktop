# ğŸ”— ä¸‰æ¡æ‰§è¡Œé“¾ä¸æ™ºèƒ½é€‰æ‹©è”åŠ¨æ¶æ„è¯¦è§£

## ğŸ¯ æ‰§è¡Œé“¾æ¶æ„æ¦‚è¿°

æœ¬é¡¹ç›®æ„å»ºäº†ä¸€ä¸ª**ä¸‰å±‚å¼æ‰§è¡Œæ¶æ„**ï¼Œæ¯å±‚éƒ½æ”¯æŒæ™ºèƒ½é€‰æ‹©åŠŸèƒ½ï¼Œå½¢æˆäº†å®Œæ•´çš„è‡ªåŠ¨åŒ–æ‰§è¡Œç”Ÿæ€ï¼š

```mermaid
graph TD
    A[ç”¨æˆ·è„šæœ¬/æ­¥éª¤] --> B[æ‰§è¡Œé“¾è·¯ç”±å™¨]
    
    B --> C1[æ™ºèƒ½å•æ­¥æ‰§è¡Œé“¾]
    B --> C2[æ™ºèƒ½è‡ªåŠ¨é“¾æ‰§è¡Œé“¾] 
    B --> C3[é™æ€ç­–ç•¥æ‰§è¡Œé“¾]
    
    C1 --> D[æ™ºèƒ½é€‰æ‹©å¼•æ“]
    C2 --> D[æ™ºèƒ½é€‰æ‹©å¼•æ“]
    C3 --> D[æ™ºèƒ½é€‰æ‹©å¼•æ“]
    
    D --> E[ADBè®¾å¤‡æ“ä½œå±‚]
    E --> F[Androidè®¾å¤‡]
    
    style C1 fill:#e1f5fe
    style C2 fill:#e8f5e8
    style C3 fill:#fff3e0
    style D fill:#f3e5f5
```

## ğŸš€ ä¸‰æ¡æ‰§è¡Œé“¾è¯¦è§£

### 1ï¸âƒ£ æ™ºèƒ½å•æ­¥æ‰§è¡Œé“¾ (`execute_single_step_test_v3`)

**ç‰¹ç‚¹**: æ­¥è¿›å¼æ‰§è¡Œï¼Œç²¾ç¡®æ§åˆ¶
**é€‚ç”¨åœºæ™¯**: è°ƒè¯•ã€éªŒè¯ã€ç²¾ç¡®æ“ä½œ

```rust
// å‘½ä»¤å…¥å£
#[tauri::command]
pub async fn execute_single_step_test_v3(
    step: SingleStepSpecV3,
) -> Result<Value, String>

// æ”¯æŒçš„åŠ¨ä½œç±»å‹
enum SingleStepAction {
    Tap,
    SmartTap,
    SmartFindElement,
    // âš ï¸ TODO: éœ€è¦æ·»åŠ  SmartSelection
}
```

**ä¸æ™ºèƒ½é€‰æ‹©çš„è”åŠ¨**:
```typescript
// å‰ç«¯è°ƒç”¨ç¤ºä¾‹
const singleStepResult = await invoke('execute_single_step_test_v3', {
  envelope: { deviceId: 'device1' },
  step: {
    stepId: 'step-1',
    action: 'SmartSelection',  // ğŸ”¥ æ–°å¢æ™ºèƒ½é€‰æ‹©åŠ¨ä½œ
    params: {
      smartSelection: {
        mode: 'first',
        targetText: 'å…³æ³¨',
        minConfidence: 0.8
      }
    }
  }
});
```

### 2ï¸âƒ£ æ™ºèƒ½è‡ªåŠ¨é“¾æ‰§è¡Œé“¾ (`execute_chain_test_v3`)

**ç‰¹ç‚¹**: å…¨è‡ªåŠ¨æ‰¹é‡æ‰§è¡Œï¼Œæ™ºèƒ½çŸ­è·¯
**é€‚ç”¨åœºæ™¯**: å®Œæ•´æµç¨‹è‡ªåŠ¨åŒ–ã€æ‰¹é‡æ“ä½œ

```rust
// å‘½ä»¤å…¥å£
#[tauri::command]
pub async fn execute_chain_test_v3(
    spec: ChainSpecV3,
) -> Result<Value, String>

// é“¾å¼æ‰§è¡Œè§„æ ¼
enum ChainSpecV3 {
    ByRef { analysis_id, threshold, mode },  // ä»ç¼“å­˜è¯»å–
    ByInline { ordered_steps, threshold },   // å†…è”æ­¥éª¤
}
```

**ä¸æ™ºèƒ½é€‰æ‹©çš„è”åŠ¨**:
```typescript
// æ‰¹é‡å…³æ³¨åœºæ™¯
const chainResult = await invoke('execute_chain_test_v3', {
  envelope: { deviceId: 'device1' },
  spec: {
    orderedSteps: [
      // æ­¥éª¤1: æ™ºèƒ½é€‰æ‹©æ‰€æœ‰å…³æ³¨æŒ‰é’®
      {
        stepId: 'batch-follow',
        action: 'SmartSelection',
        params: {
          smartSelection: {
            mode: 'all',           // é€‰æ‹©æ‰€æœ‰åŒ¹é…å…ƒç´ 
            targetText: 'å…³æ³¨',
            batchConfig: {
              intervalMs: 2000,    // æ‰¹é‡æ‰§è¡Œé—´éš”
              maxCount: 10,        // æœ€å¤šå…³æ³¨10ä¸ª
              continueOnError: true
            }
          }
        }
      }
    ]
  }
});
```

### 3ï¸âƒ£ é™æ€ç­–ç•¥æ‰§è¡Œé“¾ (`execute_static_strategy_test_v3`)

**ç‰¹ç‚¹**: åŸºäºé¢„å®šä¹‰è§„åˆ™çš„å¿«é€Ÿæ‰§è¡Œ
**é€‚ç”¨åœºæ™¯**: é«˜é¢‘å›ºå®šæ“ä½œã€æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯

```rust
// å‘½ä»¤å…¥å£
#[tauri::command]
pub async fn execute_static_strategy_test_v3(
    spec: StaticSpecV3,
) -> Result<Value, String>

// é™æ€ç­–ç•¥è§„æ ¼
enum StaticSpecV3 {
    ByRef { script_id, static_step_id },
    ByInline { strategy_actions },
}
```

**ä¸æ™ºèƒ½é€‰æ‹©çš„è”åŠ¨**:
```typescript
// é¢„å®šä¹‰æ™ºèƒ½é€‰æ‹©ç­–ç•¥
const staticResult = await invoke('execute_static_strategy_test_v3', {
  envelope: { deviceId: 'device1' },
  spec: {
    strategyActions: [
      {
        type: 'SmartSelection',
        preset: 'xiaohongshu-batch-follow',  // é¢„å®šä¹‰å°çº¢ä¹¦å…³æ³¨ç­–ç•¥
        params: {
          mode: 'first-three',              // é¢„å®šä¹‰é€‰æ‹©æ¨¡å¼
          safeguards: {
            maxPerSession: 20,              // æ¯æ¬¡æœ€å¤šå…³æ³¨20ä¸ª
            cooldownMs: 5000               // å†·å´æ—¶é—´
          }
        }
      }
    ]
  }
});
```

## ğŸ§  æ™ºèƒ½é€‰æ‹©å¼•æ“é›†æˆç‚¹

### æ ¸å¿ƒæ¶æ„
```rust
// æ™ºèƒ½é€‰æ‹©å¼•æ“ - è¢«ä¸‰æ¡æ‰§è¡Œé“¾å…±äº«
pub struct SmartSelectionEngine {
    // å€™é€‰å…ƒç´ è§£æä¸åŒ¹é…
    parse_xml_and_find_candidates(),
    
    // å››ç§é€‰æ‹©ç­–ç•¥å®ç°
    execute_match_original_strategy(),  // ç²¾ç¡®æŒ‡çº¹åŒ¹é…
    execute_positional_strategy(),      // ä½ç½®é€‰æ‹© (first/last)
    execute_random_strategy(),          // éšæœºé€‰æ‹©
    execute_batch_strategy(),           // æ‰¹é‡æ“ä½œ
}
```

### é›†æˆæ¨¡å¼

#### 1. ä½œä¸ºSingleStepActioné›†æˆ
```rust
// â— å½“å‰ç¼ºå¤±ï¼Œéœ€è¦æ·»åŠ 
enum SingleStepAction {
    // ... ç°æœ‰åŠ¨ä½œ
    SmartSelection,  // ğŸ”¥ æ–°å¢æ™ºèƒ½é€‰æ‹©åŠ¨ä½œ
}
```

#### 2. ä½œä¸ºç‹¬ç«‹Tauriå‘½ä»¤è°ƒç”¨
```typescript
// ç°æœ‰æ–¹å¼ï¼šç›´æ¥è°ƒç”¨æ™ºèƒ½é€‰æ‹©å‘½ä»¤
const result = await invoke('execute_smart_selection', {
  deviceId,
  protocol: smartSelectionProtocol
});
```

#### 3. é€šè¿‡æ‰§è¡Œé“¾é—´æ¥è°ƒç”¨
```typescript
// æ¨èæ–¹å¼ï¼šé€šè¿‡æ‰§è¡Œé“¾ç»Ÿä¸€è°ƒç”¨
const result = await invoke('execute_single_step_test_v3', {
  envelope: { deviceId },
  step: {
    action: 'SmartSelection',
    params: { smartSelection: protocol }
  }
});
```

## ğŸ”€ è”åŠ¨æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·ç•Œé¢
    participant R as æ‰§è¡Œé“¾è·¯ç”±å™¨
    participant S1 as æ™ºèƒ½å•æ­¥é“¾
    participant S2 as æ™ºèƒ½è‡ªåŠ¨é“¾
    participant S3 as é™æ€ç­–ç•¥é“¾
    participant SE as æ™ºèƒ½é€‰æ‹©å¼•æ“
    participant A as ADBæ“ä½œå±‚
    
    U->>R: æ‰§è¡Œè¯·æ±‚ (å«æ™ºèƒ½é€‰æ‹©æ­¥éª¤)
    
    alt å•æ­¥æ‰§è¡Œ
        R->>S1: execute_single_step_v3
        S1->>SE: è°ƒç”¨æ™ºèƒ½é€‰æ‹©å¼•æ“
    else é“¾å¼æ‰§è¡Œ
        R->>S2: execute_chain_v3
        S2->>SE: æ‰¹é‡è°ƒç”¨æ™ºèƒ½é€‰æ‹©å¼•æ“
    else é™æ€æ‰§è¡Œ
        R->>S3: execute_static_v3
        S3->>SE: é¢„è®¾ç­–ç•¥è°ƒç”¨æ™ºèƒ½é€‰æ‹©
    end
    
    SE->>A: è·å–UI dump + è§£æå€™é€‰å…ƒç´ 
    A->>SE: è¿”å›å€™é€‰å…ƒç´ åˆ—è¡¨
    SE->>SE: åº”ç”¨é€‰æ‹©ç­–ç•¥ (first/last/random/all)
    SE->>A: æ‰§è¡Œæ‰¹é‡ç‚¹å‡»
    A->>U: è¿”å›æ‰§è¡Œç»“æœ
```

## ğŸ“Š ä½¿ç”¨åœºæ™¯å¯¹æ¯”

| æ‰§è¡Œé“¾ | æ™ºèƒ½é€‰æ‹©ä½¿ç”¨æ–¹å¼ | é€‚ç”¨åœºæ™¯ | æ€§èƒ½ç‰¹ç‚¹ |
|--------|----------------|----------|----------|
| **æ™ºèƒ½å•æ­¥** | ç²¾ç¡®æ§åˆ¶å•æ¬¡æ™ºèƒ½é€‰æ‹© | è°ƒè¯•éªŒè¯ã€ç²¾ç¡®æ“ä½œ | æ…¢ä½†å‡†ç¡® |
| **æ™ºèƒ½è‡ªåŠ¨é“¾** | æ‰¹é‡æ™ºèƒ½é€‰æ‹© + æµç¨‹è‡ªåŠ¨åŒ– | å®Œæ•´å·¥ä½œæµç¨‹ | å¹³è¡¡æ•ˆç‡ä¸å‡†ç¡®æ€§ |
| **é™æ€ç­–ç•¥** | é¢„å®šä¹‰æ™ºèƒ½é€‰æ‹©æ¨¡æ¿ | é«˜é¢‘é‡å¤æ“ä½œ | å¿«é€Ÿä½†å›ºå®š |

## ğŸ› ï¸ å½“å‰æ¶æ„ç¼ºå£ä¸æ”¹è¿›å»ºè®®

### âŒ å½“å‰é—®é¢˜

1. **ç±»å‹å®šä¹‰ä¸ä¸€è‡´**
   ```rust
   // ç¼ºå¤±ï¼šSingleStepAction ä¸­æ²¡æœ‰ SmartSelection
   enum SingleStepAction {
       // ... å…¶ä»–åŠ¨ä½œ
       // âŒ SmartSelection, // éœ€è¦æ·»åŠ 
   }
   ```

2. **è°ƒç”¨è·¯å¾„åˆ†è£‚**
   - ç›´æ¥è°ƒç”¨ï¼š`invoke('execute_smart_selection')`  
   - é—´æ¥è°ƒç”¨ï¼š`invoke('execute_single_step_v3')` (ä¸æ”¯æŒSmartSelectionåŠ¨ä½œ)

3. **å‚æ•°æ ¼å¼å·®å¼‚**
   - æ™ºèƒ½é€‰æ‹©åè®®ï¼š`SmartSelectionProtocol`
   - æ­¥éª¤å‚æ•°ï¼š`StepAction.params.smartSelection`

### âœ… æ”¹è¿›æ–¹æ¡ˆ

#### 1. ç»Ÿä¸€ç±»å‹å®šä¹‰
```rust
// src-tauri/src/exec/v3/types.rs
enum SingleStepAction {
    // ... ç°æœ‰åŠ¨ä½œ
    SmartSelection,  // ğŸ†• æ·»åŠ æ™ºèƒ½é€‰æ‹©åŠ¨ä½œ
}

enum StaticAction {
    // ... ç°æœ‰åŠ¨ä½œ  
    SmartSelection,  // ğŸ†• é™æ€ç­–ç•¥ä¹Ÿæ”¯æŒæ™ºèƒ½é€‰æ‹©
}
```

#### 2. ç»Ÿä¸€å‚æ•°æ ¼å¼
```typescript
// å‰ç«¯ç±»å‹ç»Ÿä¸€
interface StepAction {
  kind: 'smart_selection';
  params: {
    smartSelection: SmartSelectionProtocol;  // å¤ç”¨ç°æœ‰åè®®
  };
}
```

#### 3. æ‰§è¡Œé“¾é›†æˆ
```rust
// åœ¨å„æ‰§è¡Œé“¾ä¸­æ·»åŠ æ™ºèƒ½é€‰æ‹©å¤„ç†
match action {
    SingleStepAction::SmartSelection => {
        let protocol = extract_smart_selection_protocol(params)?;
        let result = smart_selection_engine.execute(device_id, protocol).await?;
        Ok(result)
    }
    // ... å…¶ä»–åŠ¨ä½œ
}
```

## ğŸ¯ æœ€ç»ˆè”åŠ¨æ•ˆæœ

### ç”¨æˆ·ä½“éªŒ
```typescript
// ğŸš€ ç»Ÿä¸€çš„è°ƒç”¨æ–¹å¼
const singleStepResult = await executeSingleStep({
  action: 'SmartSelection',
  params: { mode: 'first', targetText: 'å…³æ³¨' }
});

const chainResult = await executeChain({
  steps: [
    { action: 'SmartSelection', params: { mode: 'all', targetText: 'å…³æ³¨' }},
    { action: 'Wait', params: { waitMs: 2000 }},
    { action: 'SmartSelection', params: { mode: 'first', targetText: 'ç‚¹èµ' }}
  ]
});

const staticResult = await executeStatic({
  preset: 'xiaohongshu-engagement-boost',  // é¢„å®šä¹‰ç­–ç•¥
  params: { intensity: 'moderate' }
});
```

### å¼€å‘ä½“éªŒ
- âœ… **ç±»å‹å®‰å…¨**: ç»Ÿä¸€çš„TypeScriptç±»å‹å®šä¹‰
- âœ… **ä»£ç å¤ç”¨**: æ™ºèƒ½é€‰æ‹©å¼•æ“è¢«ä¸‰æ¡é“¾å…±äº«
- âœ… **çµæ´»é…ç½®**: æ”¯æŒå†…è”å‚æ•°å’Œé¢„è®¾ç­–ç•¥
- âœ… **ç»Ÿä¸€ç›‘æ§**: æ‰€æœ‰æ‰§è¡Œé“¾å…±äº«äº‹ä»¶ç³»ç»Ÿ

---

## ğŸš€ æ€»ç»“

**ä¸‰æ¡æ‰§è¡Œé“¾ + æ™ºèƒ½é€‰æ‹© = å®Œæ•´è‡ªåŠ¨åŒ–ç”Ÿæ€ç³»ç»Ÿ**

- **æ™ºèƒ½å•æ­¥é“¾**: ä¸ºæ™ºèƒ½é€‰æ‹©æä¾›ç²¾ç¡®æ§åˆ¶èƒ½åŠ›
- **æ™ºèƒ½è‡ªåŠ¨é“¾**: ä¸ºæ™ºèƒ½é€‰æ‹©æä¾›æ‰¹é‡æµç¨‹åŒ–èƒ½åŠ›  
- **é™æ€ç­–ç•¥é“¾**: ä¸ºæ™ºèƒ½é€‰æ‹©æä¾›é«˜æ€§èƒ½æ¨¡æ¿åŒ–èƒ½åŠ›
- **æ™ºèƒ½é€‰æ‹©å¼•æ“**: ä¸ºä¸‰æ¡é“¾æä¾›ç»Ÿä¸€çš„å¤šå…ƒç´ æ™ºèƒ½åŒ¹é…èƒ½åŠ›

è¿™ç§æ¶æ„è®¾è®¡å®ç°äº†**"ä¸€ä¸ªå¼•æ“ï¼Œä¸‰ç§è°ƒç”¨æ–¹å¼"**çš„ä¼˜é›…æ¨¡å¼ï¼Œæ—¢ä¿è¯äº†ä»£ç å¤ç”¨ï¼Œåˆæ»¡è¶³äº†ä¸åŒåœºæ™¯çš„æ€§èƒ½å’Œæ§åˆ¶éœ€æ±‚ï¼ ğŸŠ