# 批量全部功能测试指南

## 🎯 测试目标

验证 **"智能自动链 + 批量全部"** 能否正确执行批量点击所有关注按钮。

---

## 📋 测试步骤

### 1️⃣ **打开开发者工具**

按 `F12` 打开浏览器开发者工具，查看 Console 日志。

### 2️⃣ **选择配置**

在步骤卡片的策略菜单中：
1. **执行链**: 选择 `🧠 智能自动链`
2. **选择模式**: 选择 `📋 批量全部`
3. **批量配置**: 
   - 间隔时间: 2000ms
   - 最大数量: 10

### 3️⃣ **检查前端保存日志**

**应该立即看到**以下日志（在选择"批量全部"后）：

```javascript
✅ 正确的日志：
🔍 [CompactStrategyMenu] autoSaveConfig 调用: { 
  stepId: "step_1761384262983", 
  mode: "all", 
  hasStepId: true, 
  batchConfig: {...} 
}
📤 [CompactStrategyMenu] 准备调用后端保存: {...}
✅ [CompactStrategyMenu] 自动保存配置成功: {...}
```

```javascript
❌ 错误的日志（说明保存失败）：
⚠️ [CompactStrategyMenu] 无stepId，跳过保存
// 或
❌ [CompactStrategyMenu] 保存配置失败: ...
```

**同时应该看到成功提示**：
```
✅ 已保存智能选择配置: all
```

### 4️⃣ **检查后端保存日志**

在 Console 中搜索 `save_smart_selection_config`，**应该看到**：

```log
✅ 正确的日志：
📥 [save_smart_selection_config] 收到保存请求: step_id=step_1761384262983, mode=all, batch_config=Some({...})
✅ 保存智能选择配置成功: step_id=step_1761384262983, mode=all, batch_config=Some({...}), store_size=1
```

```log
❌ 错误的日志（说明后端没收到调用）：
（完全没有 save_smart_selection_config 相关日志）
```

### 5️⃣ **执行步骤**

点击步骤卡片的 ▶️ 播放按钮。

### 6️⃣ **检查执行日志**

搜索 `通过Store查询`，**应该看到**：

```log
✅ 正确的执行流程：
🔍 通过Store查询选择器: step_1761384262983
✅ Store命中策略候选  ← 关键！说明找到了配置
🎯 使用智能选择引擎
📋 执行批量策略 - 候选数: 7
点击元素 1/7: bounds=[...]
等待 2000ms
点击元素 2/7: bounds=[...]
等待 2000ms
...
```

```log
❌ 错误的执行流程（说明配置未保存）：
🔍 通过Store查询选择器: step_1761384262983
⚠️ Store未找到策略: step_1761384262983  ← 问题！
🎯 启用坐标兜底模式
执行坐标: (875, 1770)  ← 只点一个位置
```

---

## 🔍 问题诊断

### 问题1: 前端没有调用保存

**症状**：
- Console 中没有 `autoSaveConfig 调用` 日志
- 没有看到 `✅ 已保存智能选择配置` 提示

**原因**：
- `stepId` 为空
- `handleSelectionModeClick` 没有正确调用 `await autoSaveConfig()`

**解决方案**：
```typescript
// 检查 CompactStrategyMenu 组件
console.log('🔍 stepId:', stepId);  // 确认 stepId 不为空

// 检查 handleSelectionModeClick 是否是 async
const handleSelectionModeClick = async ({ key }: { key: string }) => {
  // ... 
  await autoSaveConfig('all');  // 必须有 await
};
```

### 问题2: 后端没有收到保存请求

**症状**：
- 前端有 `📤 准备调用后端保存` 日志
- 但后端没有 `📥 收到保存请求` 日志

**原因**：
- 命令名称错误
- 命令未在 `main.rs` 中注册
- Tauri 版本不匹配

**解决方案**：
```rust
// 检查 main.rs
.invoke_handler(tauri::generate_handler![
    save_smart_selection_config,  // 确认已注册
    // ...
])
```

### 问题3: 保存成功但执行时找不到

**症状**：
- 前端和后端都有保存成功的日志
- 但执行时 `⚠️ Store未找到策略`

**原因**：
- 保存的 `step_id` 和执行时的 `step_id` 不一致
- Store 被清空了

**解决方案**：
```log
// 对比日志中的 step_id
保存时: step_id=step_1761384262983
执行时: step_id=step_1761384262983  ← 必须完全一致！
```

---

## ✅ 成功标准

### 完整的成功日志链条

```log
1. 选择"批量全部"
   → 🔍 [CompactStrategyMenu] autoSaveConfig 调用
   → 📤 准备调用后端保存
   
2. 后端保存
   → 📥 [save_smart_selection_config] 收到保存请求
   → ✅ 保存智能选择配置成功: store_size=1
   
3. 前端保存完成
   → ✅ [CompactStrategyMenu] 自动保存配置成功
   → 用户看到: ✅ 已保存智能选择配置: all
   
4. 点击播放按钮
   → 🔍 通过Store查询选择器: step_xxx
   → ✅ Store命中策略候选
   → 🎯 使用智能选择引擎
   → 📋 执行批量策略 - 候选数: 7
   
5. 批量执行
   → 点击元素 1/7: bounds=[786,1733,965,1806]
   → 等待 2000ms
   → 点击元素 2/7: bounds=[786,1544,965,1617]
   → 等待 2000ms
   → ...
   → ✅ 批量执行完成: 成功 7/7
```

---

## 🐛 调试命令

### 查看当前 Store 内容

在前端 Console 执行：

```javascript
// 查询特定步骤的策略
const { invoke } = await import('@tauri-apps/api/core');
const strategy = await invoke('get_step_strategy', { stepId: 'step_1761384262983' });
console.log('Store中的策略:', strategy);
```

### 手动保存配置

```javascript
const { invoke } = await import('@tauri-apps/api/core');
await invoke('save_smart_selection_config', {
  stepId: 'step_1761384262983',
  selectionMode: 'all',
  batchConfig: {
    interval_ms: 2000,
    max_count: 10,
    jitter_ms: 500,
    continue_on_error: true,
    show_progress: true
  }
});
console.log('✅ 手动保存成功');
```

### 清除配置

```javascript
const { invoke } = await import('@tauri-apps/api/core');
await invoke('clear_step_strategy', { stepId: 'step_1761384262983' });
console.log('✅ 配置已清除');
```

---

## 📝 总结

**关键检查点**：
1. ✅ stepId 不为空
2. ✅ 前端成功调用 `save_smart_selection_config`
3. ✅ 后端收到保存请求并成功保存
4. ✅ Store 中能查询到策略
5. ✅ 执行时不触发坐标兜底
6. ✅ 真机上点击了所有关注按钮

**如果还是失败**：
1. 截图日志发给我
2. 提供 `step_id` 的值
3. 说明在哪一步失败了
