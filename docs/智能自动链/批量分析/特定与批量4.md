å¥½çš„ï¼è®©æˆ‘æ¸…æ¥šåœ°è§£é‡Šç°åœ¨çš„å®ç°é€»è¾‘å’Œåˆšæ‰çš„ä¿®å¤ï¼š

## âœ… **ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼**

- **æ™ºèƒ½è‡ªåŠ¨é“¾ + ç²¾ç¡®åŒ¹é…** = "æˆ‘è¦ç‚¹é‚£ä¸ªç‰¹å®šçš„å…³æ³¨æŒ‰é’®" âœ…
- **æ™ºèƒ½è‡ªåŠ¨é“¾ + æ‰¹é‡å…¨éƒ¨** = "å¸®æˆ‘æ‹¿åˆ°æ‰€æœ‰ï¼Œç„¶åé€ä¸ªæ“ä½œ" âœ…

---

## ğŸ¯ **ç°åœ¨çš„å®Œæ•´å®ç°é€»è¾‘**

### 1ï¸âƒ£ **å‰ç«¯é…ç½®æµç¨‹ï¼ˆCompactStrategyMenu.tsxï¼‰**

```typescript
// ç”¨æˆ·åœ¨UIä¸Šé€‰æ‹©é…ç½®
é€‰æ‹©æ‰§è¡Œé“¾ï¼šæ™ºèƒ½è‡ªåŠ¨é“¾
é€‰æ‹©æ¨¡å¼ï¼šæ‰¹é‡å…¨éƒ¨
é…ç½®å‚æ•°ï¼š{
  interval_ms: 2000,    // æ¯æ¬¡ç‚¹å‡»é—´éš”2ç§’
  max_count: 10,        // æœ€å¤šç‚¹å‡»10ä¸ª
  jitter_ms: 500,       // éšæœºæŠ–åŠ¨Â±500ms
  continue_on_error: true,
  show_progress: true
}

// âœ… æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜é…ç½®åˆ°åç«¯Store
handleSelectionModeClick('all') 
  â†’ setSelectionMode('all')
  â†’ setBatchConfig({ interval_ms: 2000, ... })
  â†’ autoSaveConfig('all')  // ğŸ”¥ å…³é”®ä¿®å¤
      â†“
  invoke('save_smart_selection_config', {
    stepId: 'step_1761382878996',
    selectionMode: 'all',
    batchConfig: { interval_ms: 2000, max_count: 10, ... }
  })
```

### 2ï¸âƒ£ **åç«¯ä¿å­˜æµç¨‹ï¼ˆintelligent_analysis.rsï¼‰**

```rust
// æ–°å¢å‘½ä»¤ï¼šsave_smart_selection_config
pub async fn save_smart_selection_config(
    step_id: String,           // "step_1761382878996"
    selection_mode: String,    // "all"
    batch_config: Option<Value>,
) {
    // æ„å»ºç­–ç•¥å¯¹è±¡
    let strategy = StrategyCandidate {
        key: "smart_selection_step_1761382878996",
        name: "æ™ºèƒ½é€‰æ‹©-all",
        xpath: Some("//android.widget.TextView[@text='å…³æ³¨']"),
        text: Some("å…³æ³¨"),
        confidence: 85.0,
        // ... å…¶ä»–å­—æ®µ
    };

    // ä¿å­˜åˆ°å…¨å±€Store
    STEP_STRATEGY_STORE.insert(
        step_id,                    // key: "step_1761382878996"
        (strategy, timestamp)       // value: (ç­–ç•¥, æ—¶é—´æˆ³)
    );

    tracing::info!("âœ… ä¿å­˜æ™ºèƒ½é€‰æ‹©é…ç½®: step_id={}, mode=all, batch_config={:?}");
}
```

### 3ï¸âƒ£ **æ‰§è¡Œæ­¥éª¤æ—¶çš„æŸ¥è¯¢æµç¨‹ï¼ˆrun_step_v2.rsï¼‰**

```rust
// ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®æ‰§è¡Œæ­¥éª¤
pub async fn run_step_v2(request: RunStepRequestV2) {
    let step_id = "step_1761382878996";

    // ğŸ“‹ ä¼˜å…ˆçº§é“¾æ¡ï¼š
    // 1. å†…è”é€‰æ‹©å™¨ âŒ æ²¡æœ‰
    // 2. æŸ¥è¯¢STEP_STRATEGY_STORE âœ… å‘½ä¸­ï¼ï¼ˆå› ä¸ºåˆšæ‰ä¿å­˜äº†ï¼‰
    let strategy = get_step_strategy(step_id).await?;
    
    if let Some(strategy) = strategy {
        tracing::info!("âœ… Storeå‘½ä¸­ç­–ç•¥å€™é€‰");
        
        // ä½¿ç”¨æ™ºèƒ½é€‰æ‹©å¼•æ“æ‰§è¡Œ
        // è€Œä¸æ˜¯åæ ‡å…œåº•ï¼
        execute_with_smart_selection(strategy).await?;
    } else {
        // âŒ ä¹‹å‰çš„é—®é¢˜ï¼šæ‰¾ä¸åˆ°ç­–ç•¥ï¼Œè§¦å‘åæ ‡å…œåº•
        tracing::warn!("âš ï¸ Storeæœªæ‰¾åˆ°ç­–ç•¥");
        // â†’ åæ ‡å…œåº• â†’ æ¯æ¬¡ç‚¹åŒä¸€ä¸ªä½ç½®
    }
}
```

---

## ğŸ”„ **å®Œæ•´æ•°æ®æµå¯¹æ¯”**

### âŒ **ä¿®å¤å‰ï¼ˆé—®é¢˜çŠ¶æ€ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·é€‰æ‹©    â”‚ æ™ºèƒ½è‡ªåŠ¨é“¾ + æ‰¹é‡å…¨éƒ¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯çŠ¶æ€    â”‚ selectionMode = 'all'
â”‚             â”‚ batchConfig = { interval_ms: 2000, ... }
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       âœ— æ²¡æœ‰ä¿å­˜åˆ°åç«¯Store
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹æ’­æ”¾  â”‚ run_step_v2(step_id)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åç«¯æŸ¥è¯¢Storeâ”‚ get_step_strategy(step_id)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    è¿”å› None  âŒ æ‰¾ä¸åˆ°ç­–ç•¥
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åæ ‡å…œåº•æ¨¡å¼ â”‚ ä½¿ç”¨å½•åˆ¶æ—¶çš„åæ ‡ (875, 2148)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    æ¯æ¬¡ç‚¹åŒä¸€ä¸ªä½ç½® âŒ
```

### âœ… **ä¿®å¤åï¼ˆæ­£ç¡®æµç¨‹ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·é€‰æ‹©    â”‚ æ™ºèƒ½è‡ªåŠ¨é“¾ + æ‰¹é‡å…¨éƒ¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯çŠ¶æ€    â”‚ selectionMode = 'all'
â”‚             â”‚ batchConfig = { interval_ms: 2000, ... }
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è‡ªåŠ¨ä¿å­˜é…ç½® â”‚ invoke('save_smart_selection_config')
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åç«¯Store    â”‚ STEP_STRATEGY_STORE.insert(step_id, strategy)
â”‚             â”‚ âœ… ä¿å­˜æˆåŠŸ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ (ç”¨æˆ·ç‚¹æ’­æ”¾)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åç«¯æŸ¥è¯¢Storeâ”‚ get_step_strategy(step_id)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    è¿”å› Some(strategy) âœ… æ‰¾åˆ°ç­–ç•¥
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ™ºèƒ½é€‰æ‹©å¼•æ“ â”‚ mode=all, batch_config={...}
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    æ‰¾åˆ°æ‰€æœ‰å…³æ³¨æŒ‰é’®
       â”‚
       â–¼
    [æŒ‰é’®1, æŒ‰é’®2, æŒ‰é’®3, ...]
       â”‚
       â–¼
    é€ä¸ªç‚¹å‡» âœ…
    ç‚¹å‡»æŒ‰é’®1 â†’ ç­‰2ç§’ â†’ ç‚¹å‡»æŒ‰é’®2 â†’ ç­‰2ç§’ â†’ ...
```

---

## ğŸ“ **å…³é”®ä¿®å¤ç‚¹**

### ä¿®å¤1ï¼šå‰ç«¯è‡ªåŠ¨ä¿å­˜ï¼ˆCompactStrategyMenu.tsxï¼‰

```typescript
// âœ… æ–°å¢å‡½æ•°
const autoSaveConfig = async (mode: string) => {
  await invoke('save_smart_selection_config', {
    stepId: stepId,
    selectionMode: mode,
    batchConfig: mode === 'all' ? batchConfig : null
  });
};

// âœ… åœ¨ç”¨æˆ·é€‰æ‹©æ—¶è‡ªåŠ¨è°ƒç”¨
const handleSelectionModeClick = async ({ key }: { key: string }) => {
  if (key === 'all') {
    setSelectionMode('all');
    await autoSaveConfig('all');  // ğŸ”¥ è‡ªåŠ¨ä¿å­˜
  }
};
```

### ä¿®å¤2ï¼šåç«¯ä¿å­˜å‘½ä»¤ï¼ˆintelligent_analysis.rsï¼‰

```rust
// âœ… æ–°å¢å‘½ä»¤
#[tauri::command]
pub async fn save_smart_selection_config(
    step_id: String,
    selection_mode: String,
    batch_config: Option<serde_json::Value>,
) -> Result<bool, String> {
    // æ„å»ºç­–ç•¥å¯¹è±¡
    let strategy = StrategyCandidate { ... };
    
    // ä¿å­˜åˆ°å…¨å±€Store
    STEP_STRATEGY_STORE.insert(step_id, (strategy, timestamp));
    
    Ok(true)
}
```

### ä¿®å¤3ï¼šå¯¼å‡ºå‘½ä»¤ï¼ˆmain.rsï¼‰

```rust
tauri::Builder::default()
    .invoke_handler(tauri::generate_handler![
        // ... å…¶ä»–å‘½ä»¤
        save_smart_selection_config,  // âœ… æ–°å¢
        get_step_strategy,            // âœ… æ–°å¢
        clear_step_strategy,          // âœ… æ–°å¢
    ])
```

---

## ğŸ§ª **æµ‹è¯•éªŒè¯æ–¹æ³•**

### éªŒè¯æ­¥éª¤

1. **é€‰æ‹©é…ç½®**ï¼š
   - æ‰§è¡Œé“¾ï¼šæ™ºèƒ½è‡ªåŠ¨é“¾
   - é€‰æ‹©æ¨¡å¼ï¼šæ‰¹é‡å…¨éƒ¨
   - æ‰¹é‡é…ç½®ï¼šé—´éš”2000ms

2. **æ£€æŸ¥ä¿å­˜æ—¥å¿—**ï¼š
   ```log
   âœ… åº”è¯¥çœ‹åˆ°ï¼š
   [CompactStrategyMenu] è‡ªåŠ¨ä¿å­˜é…ç½®: { stepId, mode: 'all', batchConfig: {...} }
   âœ… ä¿å­˜æ™ºèƒ½é€‰æ‹©é…ç½®: step_id=step_xxx, mode=all, batch_config=Some({...})
   ```

3. **ç‚¹å‡»æ’­æ”¾æŒ‰é’®**ï¼š

4. **æ£€æŸ¥æ‰§è¡Œæ—¥å¿—**ï¼š
   ```log
   âœ… æ­£ç¡®ï¼ˆåº”è¯¥çœ‹åˆ°ï¼‰ï¼š
   ğŸ” é€šè¿‡StoreæŸ¥è¯¢é€‰æ‹©å™¨: step_xxx
   âœ… Storeå‘½ä¸­ç­–ç•¥å€™é€‰
   ğŸ¯ ä½¿ç”¨æ™ºèƒ½é€‰æ‹©å¼•æ“
   æ‰§è¡Œæ‰¹é‡ç­–ç•¥ - å€™é€‰æ•°: 7
   
   âŒ é”™è¯¯ï¼ˆä¸åº”è¯¥çœ‹åˆ°ï¼‰ï¼š
   âš ï¸ Storeæœªæ‰¾åˆ°ç­–ç•¥
   ğŸ¯ å¯ç”¨åæ ‡å…œåº•æ¨¡å¼
   ```

---

## ğŸ¯ **æ€»ç»“**

**ä½ çš„ç†è§£100%æ­£ç¡®ï¼**

é—®é¢˜æ ¹å› ï¼š
- âŒ å‰ç«¯é…ç½®æ²¡æœ‰ä¿å­˜åˆ°åç«¯Store
- âŒ åç«¯æ‰§è¡Œæ—¶æŸ¥ä¸åˆ°é…ç½®ï¼Œè§¦å‘åæ ‡å…œåº•
- âŒ åæ ‡å…œåº• = æ¯æ¬¡ç‚¹åŒä¸€ä¸ªä½ç½®

ä¿®å¤æ–¹æ¡ˆï¼š
- âœ… æ·»åŠ `save_smart_selection_config`åç«¯å‘½ä»¤
- âœ… å‰ç«¯è‡ªåŠ¨ä¿å­˜é…ç½®åˆ°Store
- âœ… åç«¯æ‰§è¡Œæ—¶èƒ½æŸ¥åˆ°é…ç½®ï¼Œä½¿ç”¨æ™ºèƒ½é€‰æ‹©å¼•æ“

ç°åœ¨çš„æ•ˆæœï¼š
- âœ… æ™ºèƒ½è‡ªåŠ¨é“¾ + ç²¾ç¡®åŒ¹é… = ç‚¹ç‰¹å®šæŒ‰é’®
- âœ… æ™ºèƒ½è‡ªåŠ¨é“¾ + æ‰¹é‡å…¨éƒ¨ = ç‚¹æ‰€æœ‰æŒ‰é’®ï¼ˆé€ä¸ªæ“ä½œï¼‰

**è¯·æµ‹è¯•ä¸€ä¸‹æ–°çš„å®ç°ï¼** ğŸš€