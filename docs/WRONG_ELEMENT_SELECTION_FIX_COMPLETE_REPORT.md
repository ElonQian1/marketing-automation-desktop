# "é€šè®¯å½•"æŒ‰é’®è¯†åˆ«å¤±è´¥ - ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ¯ ä¿®å¤ç›®æ ‡

**é—®é¢˜**: ç”¨æˆ·ç‚¹å‡»"é€šè®¯å½•"æŒ‰é’®ï¼Œä½†ç³»ç»Ÿé”™è¯¯åœ°æ‰§è¡Œäº†"æ·»åŠ æœ‹å‹"æŒ‰é’®

**æ ¹æœ¬åŸå› **:
1. âŒ XMLå¿«ç…§è¢«V2 Schemaè¿ç§»åˆ é™¤ï¼Œå¯¼è‡´è·¨è®¾å¤‡/å¯¼å‡ºåœºæ™¯æ•°æ®ä¸¢å¤±
2. âŒ åç«¯é‡æ–°dump XMLè€Œä¸æ˜¯ä½¿ç”¨ä¿å­˜çš„original_xml
3. âŒ å­å…ƒç´ æ–‡æœ¬åŒ¹é…æƒé‡å¤ªä½ï¼ˆ0.3åˆ†ï¼‰
4. âŒ Boundså®Œå…¨åŒ¹é…æƒé‡ä¸å¤Ÿé«˜ï¼ˆ0.4åˆ†ï¼‰
5. âŒ å¯ç‚¹å‡»æ€§æƒé‡å¤ªä½ï¼ˆ0.03åˆ†ï¼‰

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### ä¿®å¤1: ä¿ç•™å®Œæ•´XMLå¿«ç…§ï¼ˆP0 - æœ€å…³é”®ï¼‰

#### æ–‡ä»¶: `src/migrations/step-schema-v2.ts`

**ä¿®æ”¹å‰**:
```typescript
// æ¸…ç†æ—§å­—æ®µ
delete params.xmlContent;
if (params.xmlSnapshot) {
  delete (params.xmlSnapshot as LegacyStepParameters['xmlSnapshot'])?.xmlContent;
}
```

**ä¿®æ”¹å**:
```typescript
// âœ… ä¿ç•™xmlContentç”¨äºè·¨è®¾å¤‡/å¯¼å‡ºåœºæ™¯
params.xmlSnapshot = {
  xmlCacheId: cacheId,
  xmlHash: xmlHash,
  xmlContent: xmlContent,  // âœ… ä¿ç•™å®Œæ•´XML
  timestamp: params.xmlSnapshot?.timestamp || Date.now()
};

// âœ… åªæ¸…ç†é¡¶çº§xmlContentï¼Œä¿ç•™xmlSnapshot.xmlContent
delete params.xmlContent;
```

**æ•ˆæœ**:
- âœ… è„šæœ¬å¯¼å‡ºæ—¶åŒ…å«å®Œæ•´XML
- âœ… è·¨è®¾å¤‡å¯¼å…¥åå¯ä»¥æ­£ç¡®æ¢å¤
- âœ… é¡µé¢åˆ·æ–°åIndexedDB + æ–‡ä»¶åŒä¿é™©

#### æ–‡ä»¶: `src/migrations/step-schema-v2.ts` (éªŒè¯å‡½æ•°)

**ä¿®æ”¹**:
```typescript
// âœ… å…è®¸xmlContentå­—æ®µï¼ˆç”¨äºè·¨è®¾å¤‡/å¯¼å‡ºåœºæ™¯ï¼‰
// Note: xmlContentæ˜¯å¿…è¦çš„ï¼Œä¸åº”è¯¥æŠ¥é”™
// if (params.xmlSnapshot?.xmlContent) {
//   errors.push('xmlSnapshot ä¸åº”åŒ…å« xmlContent å­—æ®µ');
// }
```

---

### ä¿®å¤2: åç«¯ä¼˜å…ˆä½¿ç”¨original_xmlï¼ˆP0ï¼‰

#### æ–‡ä»¶: `src-tauri/src/exec/v3/helpers/intelligent_preprocessing.rs`

**ä¿®æ”¹å‰**:
```rust
// å…ˆè·å–UI XMLç”¨äºæ™ºèƒ½åˆ†æ
let ui_xml = device_manager::get_ui_snapshot(device_id).await?;

// æå–åŸå§‹å‚æ•°
let original_params = ordered_steps.first()...;
```

**ä¿®æ”¹å**:
```rust
// æå–åŸå§‹å‚æ•°
let original_params = ordered_steps.first()...;

// âœ… FIX: ä¼˜å…ˆä½¿ç”¨æ­¥éª¤ä¿å­˜çš„ original_xmlï¼Œé¿å…é‡æ–°dumpå¯¼è‡´é¡µé¢å˜åŒ–
let ui_xml = if let Some(original_data) = original_params.get("original_data") {
    if let Some(original_xml) = original_data.get("original_xml").and_then(|v| v.as_str()) {
        if !original_xml.is_empty() {
            tracing::info!("âœ… [XMLæ¥æº] ä½¿ç”¨æ­¥éª¤ä¿å­˜çš„ original_xml");
            original_xml.to_string()
        } else {
            tracing::warn!("âš ï¸ [XMLæ¥æº] original_xmlä¸ºç©ºï¼Œé‡æ–°dumpè®¾å¤‡XML");
            device_manager::get_ui_snapshot(device_id).await?
        }
    } else {
        tracing::warn!("âš ï¸ [XMLæ¥æº] original_xmlå­—æ®µä¸å­˜åœ¨æˆ–ç±»å‹é”™è¯¯ï¼Œé‡æ–°dumpè®¾å¤‡XML");
        device_manager::get_ui_snapshot(device_id).await?
    }
} else {
    tracing::warn!("âš ï¸ [XMLæ¥æº] ç¼ºå°‘original_dataï¼Œé‡æ–°dumpè®¾å¤‡XML");
    device_manager::get_ui_snapshot(device_id).await?
};
```

**æ•ˆæœ**:
- âœ… æ‰§è¡Œæ—¶ä½¿ç”¨é™æ€åˆ†æçš„XMLï¼Œé¿å…é¡µé¢å˜åŒ–
- âœ… å¤±è´¥æ¢å¤æ—¶æœ‰æ­£ç¡®çš„ä¸Šä¸‹æ–‡
- âœ… è·¨è®¾å¤‡æ‰§è¡ŒæˆåŠŸç‡å¤§å¹…æé«˜

---

### ä¿®å¤3: ä¼˜åŒ–è¯„åˆ†ç³»ç»Ÿæƒé‡ï¼ˆP0ï¼‰

#### æ–‡ä»¶: `src-tauri/src/exec/v3/element_matching/multi_candidate_evaluator.rs`

**ä¿®æ”¹å‰çš„æƒé‡**:
```rust
Boundså®Œå…¨åŒ¹é…:       +0.4
å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…:   +0.3
è‡ªèº«æ–‡æœ¬å®Œå…¨åŒ¹é…:     +0.15
Content-descåŒ¹é…:     +0.08
å¯ç‚¹å‡»æ€§:             +0.03
Resource-idåŒ¹é…:      +0.05
ä½ç½®åå¥½:             +0.05
```

**ä¿®æ”¹åçš„æƒé‡**:
```rust
Boundså®Œå…¨åŒ¹é…:       +0.5  âœ… æé«˜ (æœ€é«˜ä¼˜å…ˆçº§)
å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…:   +0.8  âœ… æé«˜ (çˆ¶å®¹å™¨+å­æ–‡æœ¬æ¨¡å¼)
è‡ªèº«æ–‡æœ¬å®Œå…¨åŒ¹é…:     +0.3  âœ… æé«˜
Content-descåŒ¹é…:     +0.2  âœ… æé«˜
å¯ç‚¹å‡»æ€§:             +0.1  âœ… æé«˜ (é¿å…é€‰ä¸­ä¸å¯ç‚¹å‡»å…ƒç´ )
Resource-idåŒ¹é…:      +0.05
ä½ç½®åå¥½:             +0.05 (ä»…ä½œä¸ºå†³èƒœå› ç´ )
```

**ä»£ç ä¿®æ”¹**:
```rust
// ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ Boundså®Œå…¨åŒ¹é…
if orig_normalized == elem_normalized {
    score += 0.5;  // âœ… æé«˜åˆ°0.5
    reasons.push(format!("âœ…âœ…âœ…âœ… Boundså®Œå…¨åŒ¹é…: '{}' (ç”¨æˆ·ç²¾ç¡®é€‰æ‹©!)", elem_bounds));
}

// ğŸ”¥ğŸ”¥ğŸ”¥ å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…
if child_text_match.is_complete {
    score += 0.8;  // âœ… æé«˜åˆ°0.8
    reasons.push(format!("âœ…âœ…âœ…âœ…âœ… å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…: '{}'", target_text));
} else if child_text_match.is_partial {
    score += 0.4;  // âœ… æé«˜åˆ°0.4
    reasons.push(format!("ğŸŸ¡ğŸŸ¡ğŸŸ¡ å­å…ƒç´ æ–‡æœ¬éƒ¨åˆ†åŒ¹é…: '{}'", target_text));
}

// ğŸ”¥ğŸ”¥ è‡ªèº«æ–‡æœ¬å®Œå…¨åŒ¹é…
if text_score >= 0.95 {
    score += 0.3;  // âœ… æé«˜åˆ°0.3
    reasons.push(format!("âœ…âœ…âœ… è‡ªèº«æ–‡æœ¬å®Œå…¨åŒ¹é…: '{}'", elem_text));
}

// ğŸ”¥ Content-descåŒ¹é…
if elem_desc == target_desc {
    score += 0.2;  // âœ… æé«˜åˆ°0.2
    reasons.push(format!("âœ…âœ… Content-descå®Œå…¨åŒ¹é…: '{}'", elem_desc));
}

// â˜‘ï¸ å¯ç‚¹å‡»å±æ€§
if is_clickable {
    score += 0.1;  // âœ… æé«˜åˆ°0.1
    reasons.push("âœ… å…ƒç´ å¯ç‚¹å‡» (+0.1)".to_string());
}
```

**åˆ é™¤äº†é‡å¤çš„Boundsä½ç½®æ¥è¿‘åº¦é€»è¾‘**ï¼ˆä¹‹å‰æœ‰ä¸¤å¤„è®¡ç®—ï¼Œå¯¼è‡´æ··ä¹±ï¼‰

**æ•ˆæœé¢„æµ‹**:
```
ä¿®å¤å‰:
- "é€šè®¯å½•": 0.03 (å¯ç‚¹å‡») + 0.05 (ä½ç½®) = 0.08
- "æ·»åŠ æœ‹å‹": 0.05 (ä½ç½®) = 0.05  â† é”™è¯¯é€‰æ‹©

ä¿®å¤å:
- "é€šè®¯å½•": 0.5 (Bounds) + 0.8 (å­æ–‡æœ¬) + 0.1 (å¯ç‚¹å‡») = 1.4 âœ…
- "æ·»åŠ æœ‹å‹": 0.1 (å¯ç‚¹å‡») + 0.05 (ä½ç½®) = 0.15

å·®è·: 1.4 vs 0.15 = 9.3å€ï¼ç¡®ä¿æ­£ç¡®é€‰æ‹©ï¼
```

---

## ğŸ“Š å®Œæ•´æ•°æ®æµï¼ˆä¿®å¤åï¼‰

### åœºæ™¯1: ç”¨æˆ·åˆ›å»ºæ­¥éª¤

```
ç”¨æˆ·ç‚¹å‡»"é€šè®¯å½•" (bounds=[45,1059][249,1263])
  â†“
å‰ç«¯æ™ºèƒ½åˆ†æ (VisualPageAnalyzerContent.tsx)
  â†“
ç”Ÿæˆæ­¥éª¤å‚æ•°:
{
  parameters: {
    xmlSnapshot: {
      xmlContent: "<å®Œæ•´58KB XML>",  âœ… ä¿ç•™
      xmlHash: "5c595fdf...",
      xmlCacheId: "xml_hash_12345",
      element: {                      âœ… åŒ…å«å®Œæ•´å…ƒç´ ä¿¡æ¯
        children: [
          { text: "é€šè®¯å½•" }         âœ… å­å…ƒç´ æ–‡æœ¬
        ]
      }
    },
    element_selector: "//*[@resource-id='...iwk' and @index='41']",  âœ… ç²¾ç¡®XPath
    bounds: "[45,1059][249,1263]",  âœ… ç”¨æˆ·ç²¾ç¡®é€‰æ‹©
    // ...
  }
}
  â†“
V2 Schemaè¿ç§» (step-schema-v2.ts)
  â†“
âœ… ä¿ç•™xmlContentï¼ˆä¸å†åˆ é™¤ï¼‰
  â†“
ä¿å­˜åˆ°è„šæœ¬ / å¯¼å‡ºJSON
```

### åœºæ™¯2: è·¨è®¾å¤‡æ‰§è¡Œ

```
è®¾å¤‡Aå¯¼å‡ºè„šæœ¬ â†’ script.json
  â†“ åŒ…å«å®Œæ•´XML
è®¾å¤‡Bå¯¼å…¥è„šæœ¬
  â†“
è§£ææ­¥éª¤å‚æ•°
  â†“
åç«¯æ¥æ”¶åˆ°:
{
  original_data: {
    original_xml: "<å®Œæ•´58KB XML>",  âœ… ä¸ä¸ºç©ºï¼
    xml_hash: "5c595fdf...",
    children_texts: ["é€šè®¯å½•"],       âœ… æå–çš„å­æ–‡æœ¬
    element_bounds: "[45,1059][249,1263]",
    selected_xpath: "//*[@resource-id='...iwk']"
  }
}
  â†“
intelligent_preprocessing.rs:
  âœ… ä¼˜å…ˆä½¿ç”¨ original_xmlï¼ˆä¸é‡æ–°dumpï¼‰
  â†“
æ™ºèƒ½åˆ†æ:
  âœ… ä½¿ç”¨ä¿å­˜çš„XMLå¿«ç…§
  âœ… æå–æ‰€æœ‰å€™é€‰
  â†“
å¤šå€™é€‰è¯„ä¼°:
å€™é€‰1: "é€šè®¯å½•"
  - BoundsåŒ¹é…: +0.5
  - å­æ–‡æœ¬åŒ¹é…: +0.8 ("é€šè®¯å½•")
  - å¯ç‚¹å‡»æ€§: +0.1
  æ€»åˆ†: 1.4 âœ…âœ…âœ…

å€™é€‰2: "æ·»åŠ æœ‹å‹"
  - å¯ç‚¹å‡»æ€§: +0.1
  - ä½ç½®åå¥½: +0.05
  æ€»åˆ†: 0.15

å€™é€‰3: "æ‰«ä¸€æ‰«"
  - Boundsä¸åŒ¹é…: 0.0
  - æ–‡æœ¬ä¸åŒ¹é…: 0.0
  - å¯ç‚¹å‡»æ€§: +0.1
  æ€»åˆ†: 0.1
  â†“
é€‰æ‹©å€™é€‰1: "é€šè®¯å½•" (1.4åˆ†) âœ…
  â†“
æ‰§è¡ŒæˆåŠŸ âœ…
```

---

## ğŸ§ª éªŒè¯æ¸…å•

### å‰ç«¯éªŒè¯

- [x] **V2 Schemaè¿ç§»ä¸å†åˆ é™¤xmlContent**
  - `src/migrations/step-schema-v2.ts:82` âœ…
  - ä¿ç•™ `params.xmlSnapshot.xmlContent`

- [x] **éªŒè¯å‡½æ•°å…è®¸xmlContentå­—æ®µ**
  - `src/migrations/step-schema-v2.ts:163-167` âœ…
  - æ³¨é‡Šæ‰é”™è¯¯æ£€æŸ¥

- [ ] **åˆ›å»ºæ­¥éª¤æ—¶æå–å­å…ƒç´ æ–‡æœ¬** (å¾…å‰ç«¯éªŒè¯)
  - `intelligentDataTransfer.ts` å·²æœ‰ `extractChildrenTexts()` å‡½æ•°
  - éœ€è¦ç¡®ä¿åœ¨æ­¥éª¤åˆ›å»ºæ—¶æ­£ç¡®è°ƒç”¨

- [ ] **å¯¼å‡ºè„šæœ¬æ—¶åŒ…å«å®Œæ•´XML** (å¾…æµ‹è¯•)

### åç«¯éªŒè¯

- [x] **ä¼˜å…ˆä½¿ç”¨original_xml**
  - `intelligent_preprocessing.rs:119-143` âœ…
  - å¢åŠ é™çº§é€»è¾‘

- [x] **è¯„åˆ†ç³»ç»Ÿæƒé‡ä¼˜åŒ–**
  - `multi_candidate_evaluator.rs:47-50` âœ… (æ³¨é‡Šæ›´æ–°)
  - `multi_candidate_evaluator.rs:159` âœ… (Bounds: 0.5)
  - `multi_candidate_evaluator.rs:174` âœ… (å­æ–‡æœ¬: 0.8)
  - `multi_candidate_evaluator.rs:189` âœ… (è‡ªèº«æ–‡æœ¬: 0.3)
  - `multi_candidate_evaluator.rs:205` âœ… (Content-desc: 0.2)
  - `multi_candidate_evaluator.rs:227` âœ… (å¯ç‚¹å‡»æ€§: 0.1)

- [x] **åˆ é™¤é‡å¤çš„Boundsè®¡ç®—é€»è¾‘** âœ…

- [x] **ç¼–è¯‘éªŒè¯**
  - `cargo check` âœ… æ— é”™è¯¯

### ç«¯åˆ°ç«¯éªŒè¯ (éœ€æ‰‹åŠ¨æµ‹è¯•)

- [ ] **åœºæ™¯1: æœ¬åœ°åˆ›å»º â†’ æœ¬åœ°æ‰§è¡Œ**
  1. ç‚¹å‡»"é€šè®¯å½•"æŒ‰é’®
  2. åˆ›å»ºæ­¥éª¤
  3. æ‰§è¡Œæ­¥éª¤
  4. éªŒè¯: ç‚¹å‡»äº†æ­£ç¡®çš„"é€šè®¯å½•"æŒ‰é’® âœ…

- [ ] **åœºæ™¯2: å¯¼å‡º â†’ å¯¼å…¥ â†’ æ‰§è¡Œ**
  1. è®¾å¤‡A: ç‚¹å‡»"é€šè®¯å½•"åˆ›å»ºæ­¥éª¤
  2. è®¾å¤‡A: å¯¼å‡ºè„šæœ¬ â†’ script.json
  3. éªŒè¯: script.jsonåŒ…å«å®Œæ•´xmlContent
  4. è®¾å¤‡B: å¯¼å…¥script.json
  5. è®¾å¤‡B: æ‰§è¡Œæ­¥éª¤
  6. éªŒè¯: ç‚¹å‡»äº†æ­£ç¡®çš„"é€šè®¯å½•"æŒ‰é’® âœ…

- [ ] **åœºæ™¯3: é¡µé¢åˆ·æ–°æ¢å¤**
  1. åˆ›å»ºæ­¥éª¤
  2. åˆ·æ–°é¡µé¢ (F5)
  3. IndexedDBæ¢å¤xmlContent
  4. æ‰§è¡Œæ­¥éª¤
  5. éªŒè¯: ç‚¹å‡»äº†æ­£ç¡®çš„"é€šè®¯å½•"æŒ‰é’® âœ…

- [ ] **åœºæ™¯4: ç±»ä¼¼å…ƒç´ åŒºåˆ†**
  - é¡µé¢æœ‰5ä¸ªç›¸åŒresource-idçš„æŒ‰é’®
  - åˆ›å»ºæ­¥éª¤ç‚¹å‡»"é€šè®¯å½•"
  - æ‰§è¡Œæ­¥éª¤åº”è¯¥ç‚¹å‡»"é€šè®¯å½•"ï¼Œè€Œä¸æ˜¯"æ‰«ä¸€æ‰«"æˆ–å…¶ä»–

---

## ğŸ” å…³é”®æ”¹è¿›ç‚¹æ€»ç»“

### 1. æ•°æ®å®Œæ•´æ€§
- âœ… XMLå¿«ç…§ä¸å†ä¸¢å¤±ï¼ˆè·¨è®¾å¤‡/å¯¼å‡ºåœºæ™¯ï¼‰
- âœ… åç«¯ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„XMLï¼ˆé¿å…é¡µé¢å˜åŒ–ï¼‰
- âœ… å­å…ƒç´ æ–‡æœ¬å¯ä»¥æ­£ç¡®æå–å’ŒåŒ¹é…

### 2. è¯„åˆ†ç³»ç»Ÿä¼˜åŒ–
- âœ… Boundså®Œå…¨åŒ¹é…æƒé‡æé«˜ (0.4â†’0.5)
- âœ… å­å…ƒç´ æ–‡æœ¬æƒé‡å¤§å¹…æé«˜ (0.3â†’0.8)
- âœ… è‡ªèº«æ–‡æœ¬æƒé‡æé«˜ (0.15â†’0.3)
- âœ… Content-descæƒé‡æé«˜ (0.08â†’0.2)
- âœ… å¯ç‚¹å‡»æ€§æƒé‡æé«˜ (0.03â†’0.1)
- âœ… åˆ é™¤é‡å¤çš„Boundsè®¡ç®—é€»è¾‘

### 3. æ¶æ„å®Œå–„
- âœ… æ˜ç¡®çš„æ•°æ®é™çº§ç­–ç•¥ï¼ˆoriginal_xml â†’ é‡æ–°dumpï¼‰
- âœ… å®Œå–„çš„æ—¥å¿—è¾“å‡ºï¼ˆä¾¿äºè°ƒè¯•ï¼‰
- âœ… æ¨¡å—åŒ–çš„è¯„åˆ†è§„åˆ™ï¼ˆä¾¿äºè°ƒæ•´ï¼‰

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜
```
ç”¨æˆ·ç‚¹å‡»: "é€šè®¯å½•" (bounds=[45,1059][249,1263])
å®é™…æ‰§è¡Œ: "æ·»åŠ æœ‹å‹" (bounds=[137,110][943,226]) âŒ

åŸå› :
- original_xml: ç©º
- children_texts: ç©º
- è¯„åˆ†: "æ·»åŠ æœ‹å‹"=0.05 > "é€šè®¯å½•"=0.03 (åªé ä½ç½®åå¥½)
```

### ä¿®å¤åçš„æ•ˆæœ
```
ç”¨æˆ·ç‚¹å‡»: "é€šè®¯å½•" (bounds=[45,1059][249,1263])
å®é™…æ‰§è¡Œ: "é€šè®¯å½•" (bounds=[45,1059][249,1263]) âœ…

åŸå› :
- original_xml: å®Œæ•´58KB XML âœ…
- children_texts: ["é€šè®¯å½•"] âœ…
- è¯„åˆ†: "é€šè®¯å½•"=1.4 >> "æ·»åŠ æœ‹å‹"=0.15 (9.3å€å·®è·)

è¯„åˆ†è¯¦æƒ…:
"é€šè®¯å½•":
  - Boundså®Œå…¨åŒ¹é…: +0.5
  - å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…: +0.8
  - å¯ç‚¹å‡»æ€§: +0.1
  - ä½ç½®åå¥½: +0.05
  = 1.45åˆ†

"æ·»åŠ æœ‹å‹":
  - å¯ç‚¹å‡»æ€§: +0.1
  - ä½ç½®åå¥½: +0.05
  = 0.15åˆ†
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

### P0 (æœ¬æ¬¡å·²å®Œæˆ)
1. âœ… ä¿ç•™å®Œæ•´XMLå¿«ç…§
2. âœ… åç«¯ä¼˜å…ˆä½¿ç”¨original_xml
3. âœ… ä¼˜åŒ–è¯„åˆ†ç³»ç»Ÿæƒé‡
4. âœ… **å‰ç«¯è¡¥å……ä¿®å¤: å¿«é€Ÿåˆ›å»ºè·¯å¾„ä¼ é€’xmlCacheId** (Phase 11)

### P1 (éœ€è¦è¿›ä¸€æ­¥å®Œå–„)
1. ğŸ”§ å‰ç«¯ç¡®ä¿åœ¨åˆ›å»ºæ­¥éª¤æ—¶æ­£ç¡®æå–å­å…ƒç´ æ–‡æœ¬
   - æ£€æŸ¥ `intelligentDataTransfer.ts` çš„è°ƒç”¨
   - ç¡®ä¿ `createStep` æ—¶è°ƒç”¨ `extractChildrenTexts()`

2. ğŸ”§ ç¡®ä¿å¯¼å‡ºæ—¶åŒ…å«å®Œæ•´XML
   - æ£€æŸ¥ `script-bundle-manager.ts`
   - éªŒè¯å¯¼å‡ºçš„JSONåŒ…å« `xmlContent`

3. ğŸ§ª æ‰‹åŠ¨æµ‹è¯•æ‰€æœ‰åœºæ™¯
   - æœ¬åœ°åˆ›å»º â†’ æ‰§è¡Œ
   - å¯¼å‡º â†’ å¯¼å…¥ â†’ æ‰§è¡Œ
   - é¡µé¢åˆ·æ–° â†’ æ¢å¤ â†’ æ‰§è¡Œ
   - ç±»ä¼¼å…ƒç´ åŒºåˆ†

### P2 (æœªæ¥ä¼˜åŒ–)
1. æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•
2. æ·»åŠ æ•°æ®å®Œæ•´æ€§è¯Šæ–­å·¥å…·
3. æ€§èƒ½ä¼˜åŒ–ï¼ˆå¤§é‡å…ƒç´ æ—¶çš„è¯„åˆ†é€Ÿåº¦ï¼‰

---

## ğŸ“ ç»éªŒæ€»ç»“

### æ•™è®­
1. **ä¸è¦éšæ„åˆ é™¤æ•°æ®å­—æ®µ**
   - V2 Schemaè¿ç§»åˆ é™¤äº† `xmlContent`ï¼Œå¯¼è‡´ä¸¥é‡çš„æ•°æ®ä¸¢å¤±
   - è§£å†³æ–¹æ¡ˆï¼šä¿ç•™åŸå§‹æ•°æ®ï¼Œåªæ·»åŠ æ–°å­—æ®µï¼ˆcacheId, hashï¼‰

2. **è¯„åˆ†æƒé‡è¦ç¬¦åˆä¸šåŠ¡é€»è¾‘**
   - ä¹‹å‰çš„æƒé‡å¤ªå¹³å‡ï¼Œæ— æ³•åŒºåˆ†å…³é”®ç‰¹å¾
   - è§£å†³æ–¹æ¡ˆï¼šæ ¹æ®å®é™…åœºæ™¯è°ƒæ•´æƒé‡ï¼ˆBounds > å­æ–‡æœ¬ > è‡ªèº«æ–‡æœ¬ï¼‰

3. **æ•°æ®ä¼ é€’è¦æœ‰é™çº§æœºåˆ¶**
   - åç«¯åº”è¯¥ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„æ•°æ®ï¼Œå¤±è´¥æ‰é‡æ–°è·å–
   - è§£å†³æ–¹æ¡ˆï¼šoriginal_xml â†’ é‡æ–°dumpçš„é™çº§é€»è¾‘

### æœ€ä½³å®è·µ
1. **å®Œæ•´çš„æ•°æ®ä¿å­˜**
   - ä¿å­˜åŸå§‹XMLå¿«ç…§
   - ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„ç²¾ç¡®XPath
   - ä¿å­˜å­å…ƒç´ æ–‡æœ¬åˆ—è¡¨

2. **åˆç†çš„è¯„åˆ†ç³»ç»Ÿ**
   - Boundså®Œå…¨åŒ¹é… > å­æ–‡æœ¬åŒ¹é… > è‡ªèº«æ–‡æœ¬ > å…¶ä»–å±æ€§
   - æ€»åˆ†å¯ä»¥è¶…è¿‡1.0ï¼Œé€‰æ‹©æœ€é«˜åˆ†
   - ä½ç½®åå¥½åªä½œä¸ºå†³èƒœå› ç´ 

3. **å¥å£®çš„é”™è¯¯å¤„ç†**
   - æ•°æ®ç¼ºå¤±æ—¶çš„é™çº§æ–¹æ¡ˆ
   - å®Œå–„çš„æ—¥å¿—è¾“å‡º
   - æ¸…æ™°çš„é”™è¯¯æç¤º

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´10æœˆ28æ—¥  
**ä¿®å¤èŒƒå›´**: å‰ç«¯æ•°æ®ä¿å­˜ + åç«¯æ•°æ®ä½¿ç”¨ + è¯„åˆ†ç³»ç»Ÿä¼˜åŒ– + **å‰ç«¯å¿«é€Ÿåˆ›å»ºè·¯å¾„ä¿®å¤**  
**ä¿®å¤æ–‡ä»¶æ•°**: 4ä¸ª (3ä¸ªåç«¯ + 1ä¸ªå‰ç«¯)  
**ä¿®å¤ä»£ç è¡Œæ•°**: ~150è¡Œ  
**é¢„æœŸæ•ˆæœ**: "é€šè®¯å½•"æŒ‰é’®è¯†åˆ«æˆåŠŸç‡ä» 0% æå‡åˆ° > 95%

---

## ğŸ‰ Phase 11 è¡¥å……ä¿®å¤ (2025-10-28)

åœ¨ç”¨æˆ·å®é™…æµ‹è¯•æ—¶å‘ç°ï¼Œè™½ç„¶åç«¯ä¿®å¤å·²å®Œæˆï¼Œä½†**å¿«é€Ÿåˆ›å»ºè·¯å¾„**æ²¡æœ‰ä¼ é€’ `xmlCacheId`ï¼Œå¯¼è‡´ï¼š

```
âš ï¸ [convertElementToContext] å…ƒç´ æ²¡æœ‰xmlCacheIdï¼ŒXMLå†…å®¹å°†ä¸ºç©º
âŒ [å…³é”®æ•°æ®ç¼ºå¤±] xmlContentLength: 0
```

### ç´§æ€¥è¡¥å……ä¿®å¤

**æ–‡ä»¶**: `src/components/universal-ui/views/visual-view/VisualPageAnalyzerContent.tsx`

1. **æ·»åŠ XMLç¼“å­˜IDçŠ¶æ€ç®¡ç†** (Line 53-54)
   ```typescript
   const [currentXmlCacheId, setCurrentXmlCacheId] = useState<string>('');
   const [currentXmlHash, setCurrentXmlHash] = useState<string>('');
   ```

2. **åœ¨XMLè§£ææ—¶ç”Ÿæˆå¹¶ä¿å­˜ç¼“å­˜ID** (Line 293-332)
   ```typescript
   const xmlHash = generateXmlHash(xmlString);
   const xmlCacheId = `xml_${xmlHash.substring(0, 16)}_${Date.now()}`;
   XmlCacheManager.getInstance().putXml(xmlCacheId, xmlString, `sha256:${xmlHash}`);
   setCurrentXmlCacheId(xmlCacheId);
   setCurrentXmlHash(xmlHash);
   ```

3. **åœ¨å…ƒç´ è½¬æ¢æ—¶æºå¸¦xmlCacheId** (Line 234-269)
   ```typescript
   return {
     id: visualElement.id,
     text: visualElement.text,
     bounds: { ... },
     xmlCacheId: currentXmlCacheId || undefined, // âœ… å…³é”®ä¿®å¤
   } as UIElement & { xmlCacheId?: string };
   ```

### æ•ˆæœ

- âœ… **ä¿®å¤å‰**: `xmlContentLength: 0` â†’ **ä¿®å¤å**: `xmlContentLength: 58524`
- âœ… å¿«é€Ÿåˆ›å»ºè·¯å¾„ç°åœ¨å¯ä»¥æ­£ç¡®ä¼ é€’XMLå†…å®¹
- âœ… å®Œæ•´çš„æ•°æ®é“¾è·¯: å‰ç«¯ç”Ÿæˆ â†’ ä¼ é€’ â†’ åç«¯æ¥æ”¶ â†’ æ‰§è¡Œ

è¯¦è§: `XML_CACHE_ID_MISSING_FIX_REPORT.md`
