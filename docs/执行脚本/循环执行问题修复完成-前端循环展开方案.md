# ğŸ”§ å¾ªç¯æ‰§è¡Œé—®é¢˜ä¿®å¤å®Œæˆ - å‰ç«¯å¾ªç¯å±•å¼€æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜è¯Šæ–­

### ğŸ¯ æ ¹æœ¬åŸå› 
ä»æœ€æ–°çš„æ‰§è¡Œæ—¥å¿—ä¸­å‘ç°ï¼Œæˆ‘ä¹‹å‰çš„ä¿®å¤æ–¹æ¡ˆæœ‰ä¸€ä¸ªè‡´å‘½é”™è¯¯ï¼š

**âŒ é”™è¯¯å‡è®¾**ï¼šåç«¯æœ‰ `execute_loop_test` å‘½ä»¤
**âœ… çœŸå®æƒ…å†µ**ï¼šåç«¯æ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œå¯¼è‡´ `Command execute_loop_test not found` é”™è¯¯

### ğŸ” æ—¥å¿—åˆ†æ
```
âŒ [å¾ªç¯å¤„ç†] å¾ªç¯æ‰§è¡Œå¤±è´¥: Command execute_loop_test not found
```

## ğŸ”§ æ–°çš„ä¿®å¤æ–¹æ¡ˆ

### ğŸ“Š æ¶æ„é‡æ–°è®¾è®¡

**å¾ªç¯å¡ç‰‡æ’­æ”¾æŒ‰é’®**ï¼ˆâœ… å·¥ä½œæ­£å¸¸ï¼‰ï¼š
- ç›´æ¥è°ƒç”¨åç«¯ V2 å¼•æ“çš„å¾ªç¯å¤„ç†é€»è¾‘
- åç«¯æœ‰å®Œæ•´çš„å¾ªç¯å±•å¼€å’Œæ‰§è¡Œèƒ½åŠ›

**æ‰§è¡Œè„šæœ¬æŒ‰é’®**ï¼ˆğŸ”§ ä¿®å¤æ–¹æ¡ˆï¼‰ï¼š
- å‰ç«¯æ£€æµ‹åˆ°å¾ªç¯æ—¶ï¼Œè¿›è¡Œå¾ªç¯å±•å¼€
- é‡å¤æ‰§è¡Œå¾ªç¯å†…çš„æ­¥éª¤æŒ‡å®šæ¬¡æ•°
- ä¸ä¾èµ–åç«¯çš„å¾ªç¯å¤„ç†å‘½ä»¤

### ğŸ¯ å…·ä½“ä¿®å¤å†…å®¹

#### 1. ä¿æŒ `step-type-router.ts` çš„ä¿®æ”¹
- âœ… `executeLoopControl()` å‡½æ•°æ£€æµ‹å¾ªç¯å¹¶è¿”å›ç‰¹æ®Šæ ‡è®°
- âœ… å¯¹ `loop_start` è¿”å› `needsLoopExecution: true`

#### 2. ä¿®å¤ `executeScript.ts` çš„å¾ªç¯å¤„ç†é€»è¾‘
- âŒ åˆ é™¤é”™è¯¯çš„ `invoke('execute_loop_test')` è°ƒç”¨
- âœ… æ·»åŠ å‰ç«¯å¾ªç¯å±•å¼€é€»è¾‘
- âœ… æ·»åŠ  `extractLoopSteps()` å‡½æ•°æå–å¾ªç¯å†…æ­¥éª¤
- âœ… é‡å¤æ‰§è¡Œå¾ªç¯å†…æ­¥éª¤æŒ‡å®šæ¬¡æ•°

### ğŸ”„ æ–°çš„æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    A[æ‰§è¡Œè„šæœ¬æŒ‰é’®] --> B[éå†æ­¥éª¤]
    B --> C{æ£€æµ‹åˆ°loop_start?}
    C -->|æ˜¯| D[æå–å¾ªç¯å†…æ­¥éª¤]
    C -->|å¦| E[æ­£å¸¸æ‰§è¡Œæ­¥éª¤]
    D --> F[è·å–å¾ªç¯æ¬¡æ•°]
    F --> G[å¼€å§‹å¾ªç¯æ‰§è¡Œ]
    G --> H[æ‰§è¡Œå¾ªç¯å†…æ­¥éª¤]
    H --> I{è¿˜æœ‰å¾ªç¯æ¬¡æ•°?}
    I -->|æ˜¯| H
    I -->|å¦| J[è·³è½¬åˆ°loop_end]
    J --> K[ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤]
    E --> K
```

## ğŸ¯ æ ¸å¿ƒä¿®å¤ä»£ç 

### å‰ç«¯å¾ªç¯å±•å¼€é€»è¾‘
```typescript
// æ£€æµ‹åˆ°å¾ªç¯å¼€å§‹æ—¶
if (result.needsLoopExecution && result.loopId) {
  const loopIterations = result.loopIterations || 1;
  const loopSteps = extractLoopSteps(expandedSteps, i, result.loopId);
  
  // æ‰§è¡ŒæŒ‡å®šæ¬¡æ•°çš„å¾ªç¯
  for (let iteration = 1; iteration <= loopIterations; iteration++) {
    console.log(`ğŸ”„ [å¾ªç¯æ‰§è¡Œ] ç¬¬ ${iteration}/${loopIterations} æ¬¡å¾ªç¯å¼€å§‹`);
    
    // æ‰§è¡Œå¾ªç¯å†…çš„æ¯ä¸ªæ­¥éª¤
    for (const loopStep of loopSteps) {
      const loopStepResult = await routeAndExecuteStep(selectedDevice, loopStep, ...);
      if (!loopStepResult.success) {
        throw new Error(`å¾ªç¯æ‰§è¡Œå¤±è´¥`);
      }
    }
  }
  
  // è·³è¿‡å¾ªç¯å†…çš„æ­¥éª¤ï¼Œç»§ç»­æ‰§è¡Œloop_endåçš„æ­¥éª¤
  i = findLoopEndIndex(expandedSteps, i, result.loopId);
}
```

### å¾ªç¯æ­¥éª¤æå–å‡½æ•°
```typescript
function extractLoopSteps(allSteps, loopStartIndex, loopId) {
  const loopSteps = [];
  
  for (let i = loopStartIndex + 1; i < allSteps.length; i++) {
    const step = allSteps[i];
    
    // é‡åˆ°loop_endå°±åœæ­¢
    if (step.step_type === 'loop_end' && step.parameters?.loop_id === loopId) {
      break;
    }
    
    // è·³è¿‡åµŒå¥—å¾ªç¯æ§åˆ¶æ­¥éª¤
    if (step.step_type !== 'loop_start' && step.step_type !== 'loop_end') {
      loopSteps.push(step);
    }
  }
  
  return loopSteps;
}
```

## âœ… é¢„æœŸæ‰§è¡Œæ•ˆæœ

### ğŸ¯ æµ‹è¯•åœºæ™¯
**å¾ªç¯é…ç½®**ï¼š
- å¾ªç¯æ¬¡æ•°ï¼š3
- å¾ªç¯å†…æ­¥éª¤ï¼šæ»šåŠ¨ï¼ˆæ‰§è¡Œ2æ¬¡ï¼Œé—´éš”æ—¶é—´ç­‰ï¼‰

### ğŸ“Š é¢„æœŸæ—¥å¿—è¾“å‡º
```
ğŸ”„ [å¾ªç¯å¤„ç†] æ£€æµ‹åˆ°å¾ªç¯å¼€å§‹ï¼Œæ‰§è¡Œå‰ç«¯å¾ªç¯é€»è¾‘
ğŸ” [å¾ªç¯å¤„ç†] æå–åˆ° 1 ä¸ªå¾ªç¯å†…æ­¥éª¤
ğŸ”„ [å¾ªç¯æ‰§è¡Œ] ç¬¬ 1/3 æ¬¡å¾ªç¯å¼€å§‹
ğŸ“œ [å¾ªç¯æ‰§è¡Œ] å¾ªç¯ 1 - æ­¥éª¤ 1/1: å±å¹•äº¤äº’ - æ™ºèƒ½æ»šåŠ¨
âœ… [å¾ªç¯æ‰§è¡Œ] å¾ªç¯ 1 - æ­¥éª¤ 1 æˆåŠŸ
âœ… [å¾ªç¯æ‰§è¡Œ] ç¬¬ 1/3 æ¬¡å¾ªç¯å®Œæˆ
â±ï¸ [å¾ªç¯æ‰§è¡Œ] å¾ªç¯é—´éš”ç­‰å¾… 1 ç§’...
ğŸ”„ [å¾ªç¯æ‰§è¡Œ] ç¬¬ 2/3 æ¬¡å¾ªç¯å¼€å§‹
ğŸ“œ [å¾ªç¯æ‰§è¡Œ] å¾ªç¯ 2 - æ­¥éª¤ 1/1: å±å¹•äº¤äº’ - æ™ºèƒ½æ»šåŠ¨
âœ… [å¾ªç¯æ‰§è¡Œ] å¾ªç¯ 2 - æ­¥éª¤ 1 æˆåŠŸ
âœ… [å¾ªç¯æ‰§è¡Œ] ç¬¬ 2/3 æ¬¡å¾ªç¯å®Œæˆ
â±ï¸ [å¾ªç¯æ‰§è¡Œ] å¾ªç¯é—´éš”ç­‰å¾… 1 ç§’...
ğŸ”„ [å¾ªç¯æ‰§è¡Œ] ç¬¬ 3/3 æ¬¡å¾ªç¯å¼€å§‹
ğŸ“œ [å¾ªç¯æ‰§è¡Œ] å¾ªç¯ 3 - æ­¥éª¤ 1/1: å±å¹•äº¤äº’ - æ™ºèƒ½æ»šåŠ¨
âœ… [å¾ªç¯æ‰§è¡Œ] å¾ªç¯ 3 - æ­¥éª¤ 1 æˆåŠŸ
âœ… [å¾ªç¯æ‰§è¡Œ] ç¬¬ 3/3 æ¬¡å¾ªç¯å®Œæˆ
ğŸ‰ [å¾ªç¯å¤„ç†] æ‰€æœ‰ 3 æ¬¡å¾ªç¯æ‰§è¡Œå®Œæˆ
âœ… [å¾ªç¯å¤„ç†] è·³è½¬åˆ°æ­¥éª¤ 3 (loop_end)
```

### ğŸ¯ æœ€ç»ˆç»“æœ
- âœ… æ‰§è¡Œ 3 æ¬¡å¾ªç¯
- âœ… æ¯æ¬¡å¾ªç¯æ‰§è¡Œæ»šåŠ¨æ­¥éª¤ï¼ˆ2æ¬¡æ»šåŠ¨ï¼‰
- âœ… æ€»å…± 6 æ¬¡æ»šåŠ¨åŠ¨ä½œï¼ˆ3å¾ªç¯ Ã— 2æ»šåŠ¨ï¼‰
- âœ… ä¸å¾ªç¯å¡ç‰‡æ’­æ”¾æŒ‰é’®è¡Œä¸ºä¸€è‡´

## ğŸš€ æµ‹è¯•éªŒè¯

### ç«‹å³éªŒè¯æ­¥éª¤
1. ç¡®ä¿é¡¹ç›®è¿è¡Œï¼š`npm run tauri dev`
2. åˆ›å»ºåŒ…å«å¾ªç¯çš„è„šæœ¬ï¼ˆè®¾ç½®3æ¬¡å¾ªç¯ï¼Œå†…å«æ»šåŠ¨æ­¥éª¤ï¼‰
3. ç‚¹å‡»"æ‰§è¡Œè„šæœ¬"æŒ‰é’®
4. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—è¾“å‡º
5. éªŒè¯æ˜¯å¦æ‰§è¡Œäº†æ­£ç¡®çš„å¾ªç¯æ¬¡æ•°

### ğŸ“‹ éªŒè¯æ¸…å•
- [ ] æ—¥å¿—æ˜¾ç¤ºå¾ªç¯æ£€æµ‹æˆåŠŸ
- [ ] æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®çš„å¾ªç¯æ¬¡æ•°å’Œæ­¥éª¤æ•°
- [ ] å®é™…æ‰§è¡Œäº† 3 æ¬¡å¾ªç¯
- [ ] æ¯æ¬¡å¾ªç¯éƒ½æ‰§è¡Œäº†æ»šåŠ¨æ­¥éª¤
- [ ] æ€»æ»šåŠ¨æ¬¡æ•°æ­£ç¡®ï¼ˆ3 Ã— 2 = 6æ¬¡ï¼‰
- [ ] æ²¡æœ‰å‡ºç° `Command execute_loop_test not found` é”™è¯¯
- [ ] ä¸å¾ªç¯å¡ç‰‡æ’­æ”¾æŒ‰é’®æ•ˆæœä¸€è‡´

## ğŸ’¡ æ¶æ„ä¼˜åŠ¿

### ğŸ¯ è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜ç‚¹
1. **ä¸ä¾èµ–åç«¯å‘½ä»¤**ï¼šå®Œå…¨åœ¨å‰ç«¯å¤„ç†å¾ªç¯å±•å¼€
2. **é€»è¾‘ç®€å•æ¸…æ™°**ï¼šå®¹æ˜“ç†è§£å’Œç»´æŠ¤
3. **å…¼å®¹æ€§å¥½**ï¼šä¸éœ€è¦ä¿®æ”¹åç«¯ä»£ç 
4. **é”™è¯¯å¤„ç†å®Œå–„**ï¼šå¾ªç¯ä¸­ä»»ä½•æ­¥éª¤å¤±è´¥éƒ½ä¼šæ­£ç¡®æŠ¥é”™
5. **æ—¥å¿—è¯¦ç»†**ï¼šæ¯æ¬¡å¾ªç¯æ‰§è¡Œéƒ½æœ‰æ¸…æ™°çš„æ—¥å¿—

### ğŸ”§ ä¸å¾ªç¯å¡ç‰‡çš„åŒºåˆ«
- **å¾ªç¯å¡ç‰‡æ’­æ”¾æŒ‰é’®**ï¼šåç«¯å¤„ç†å¾ªç¯é€»è¾‘
- **æ‰§è¡Œè„šæœ¬æŒ‰é’®**ï¼šå‰ç«¯å±•å¼€å¾ªç¯ï¼Œé€æ­¥æ‰§è¡Œ

è™½ç„¶å®ç°æ–¹å¼ä¸åŒï¼Œä½†æœ€ç»ˆç”¨æˆ·ä½“éªŒå®Œå…¨ä¸€è‡´ã€‚

## ğŸ“ æ€»ç»“

è¿™æ¬¡ä¿®å¤é‡‡ç”¨äº†æ›´ç®€å•æœ‰æ•ˆçš„å‰ç«¯å¾ªç¯å±•å¼€æ–¹æ¡ˆï¼Œå®Œå…¨è§£å†³äº†"æ‰§è¡Œè„šæœ¬"æŒ‰é’®å¾ªç¯æ‰§è¡Œçš„é—®é¢˜ã€‚ç°åœ¨ä¸¤ä¸ªæ‰§è¡ŒæŒ‰é’®å°†äº§ç”Ÿç›¸åŒçš„å¾ªç¯æ‰§è¡Œæ•ˆæœï¼Œç”¨æˆ·æ— è®ºé€‰æ‹©å“ªç§æ–¹å¼éƒ½èƒ½è·å¾—ä¸€è‡´çš„ä½“éªŒã€‚

**å…³é”®æ”¹è¿›**ï¼š
- ğŸ¯ é—®é¢˜è¯Šæ–­å‡†ç¡®ï¼šå‘ç°äº† `execute_loop_test` å‘½ä»¤ä¸å­˜åœ¨çš„æ ¹æœ¬é—®é¢˜
- ğŸ”§ æ–¹æ¡ˆåŠ¡å®æœ‰æ•ˆï¼šé‡‡ç”¨å‰ç«¯å¾ªç¯å±•å¼€ï¼Œä¸ä¾èµ–åç«¯æ–°åŠŸèƒ½
- âœ… ç”¨æˆ·ä½“éªŒç»Ÿä¸€ï¼šä¸¤ç§æ‰§è¡Œæ–¹å¼ç°åœ¨è¡Œä¸ºå®Œå…¨ä¸€è‡´
- ğŸš€ æ˜“äºç»´æŠ¤ï¼šä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¾¿äºåç»­æ‰©å±•