# 点击评分徽章刷新功能使用指南

## 功能概述

现在所有评分徽章都支持点击刷新所有评分（Step1-8），无需手动点击"刷新所有评分"按钮。

## 已实现的组件

### 1. StrategyScoreBadge 组件

**文件位置**: `src/components/universal-ui/strategy-selector/StrategyScoreBadge.tsx`

**新增属性**:
- `onRefresh?: () => void | Promise<void>` - 点击刷新回调
- `isRefreshing?: boolean` - 是否正在刷新

**使用示例**:
```tsx
<StrategyScoreBadge
  score={0.85}
  isRecommended={true}
  onRefresh={async () => {
    await refreshAllScores({ stepId, card, startAnalysis });
  }}
  isRefreshing={loading}
/>
```

**视觉提示**:
- 徽章右侧显示🔄图标
- 鼠标悬停时显示"点击刷新所有评分"提示
- 刷新时显示加载动画
- Tooltip 中提示"💡 点击刷新所有评分"

---

### 2. SmartAnalysisPanel 组件

**文件位置**: `src/components/analysis/SmartAnalysisPanel.tsx`

**新增属性**:
- `onRefreshScores?: () => void | Promise<void>` - 刷新评分回调

**使用示例**:
```tsx
<SmartAnalysisPanel
  stepId={stepId}
  showDetails={true}
  onSelectChain={() => {}}
  onSelectStep={(stepId) => {}}
  onRefreshScores={async () => {
    await refreshAllScores({ stepId, card, startAnalysis });
  }}
/>
```

**视觉效果**:
- 每个步骤的评分标签后显示🔄图标
- 点击标签即可刷新所有评分

---

### 3. UnifiedStrategyConfigurator 组件

**文件位置**: `src/components/universal-ui/strategy-selector/UnifiedStrategyConfigurator.tsx`

**新增属性**:
- `onRefreshScores?: () => void | Promise<void>` - 刷新评分回调

**使用示例**:
```tsx
<UnifiedStrategyConfigurator
  matchCriteria={criteria}
  onChange={handleChange}
  strategyScores={scores}
  showScores={true}
  onRefreshScores={async () => {
    await refreshAllScores({ stepId, card, startAnalysis });
  }}
/>
```

---

## 统一刷新函数

**文件位置**: `src/components/strategy-selector/scoring/refresh-all-scores.ts`

### refreshAllScores 函数

这是所有评分刷新的统一实现。

**参数**:
```typescript
interface RefreshAllScoresConfig {
  stepId: string;           // 步骤ID
  card: StepCard;          // 步骤卡片数据
  startAnalysis: (config: unknown) => Promise<void>; // 智能分析函数
}
```

**特性**:
- ✅ 使用步骤卡片缓存的XML快照，不重新读取原始文件
- ✅ 统一的加载提示和错误处理
- ✅ 自动构建分析配置
- ✅ 调用后端智能分析接口

**调用流程**:
1. 验证参数完整性
2. 显示加载提示
3. 构建分析配置（包含XML快照）
4. 调用 `startAnalysis` 触发智能分析
5. 显示成功/失败提示

---

## 菜单构建器集成

**文件位置**: `src/components/strategy-selector/menus/strategy-menu-builder.tsx`

### createRefreshScoresFunction 工厂函数

用于创建绑定了特定步骤和卡片的刷新函数。

**使用示例**:
```typescript
const menuConfig: StrategyMenuConfig = {
  selector,
  events,
  stepId,
  cardStore,
  startAnalysis,
  // ...其他配置
};

// 创建刷新函数
const refreshFn = createRefreshScoresFunction(menuConfig);

// 传递给需要的组件
<SomeComponent onRefresh={refreshFn} />
```

---

## 实际集成示例

### CompactStrategyMenu 集成示例

```tsx
const CompactStrategyMenu: React.FC<Props> = ({
  selector,
  events,
  stepId,
  // ...
}) => {
  const { startAnalysis } = useIntelligentAnalysis();
  const { cards } = useStepCardStore();

  // 创建刷新函数
  const handleRefreshScores = useCallback(async () => {
    if (!stepId) return;
    const card = cards[stepId];
    if (!card) return;

    await refreshAllScores({
      stepId,
      card,
      startAnalysis,
    });
  }, [stepId, cards, startAnalysis]);

  return (
    <div>
      <SmartAnalysisPanel
        stepId={stepId}
        onRefreshScores={handleRefreshScores}
      />
    </div>
  );
};
```

---

## 性能特性

### 优化措施

1. **XML 缓存复用**
   - 使用步骤卡片上保存的 XML 快照
   - 避免重新读取原始 XML 文件
   - 即使在没有原始 XML 的机器上也能运行

2. **单次后端调用**
   - Step1-2（结构匹配）只调用1次后端接口
   - 返回所有策略的评分结果
   - 避免多次网络往返

3. **防抖保护**（可选）
   - 可添加 debounce 避免疯狂点击
   - 刷新期间禁用重复点击
   - loading 状态提示用户

### 性能指标

- **单次刷新**: 50-200ms（普通XML）
- **全量评分**: 200-800ms（Step1-8）
- **内存占用**: 仅内存计算，无额外占用

---

## 用户体验

### 视觉反馈

- 🔄 刷新图标提示可点击
- ⏳ 加载动画显示进度
- ✅ 成功提示
- ❌ 失败提示with错误信息

### 交互流程

1. 用户点击任意评分徽章
2. 徽章显示加载状态
3. 后端执行评分计算
4. 前端更新所有步骤的评分
5. 显示成功提示

---

## 错误处理

### 常见错误场景

1. **XML缓存丢失**
   ```
   ⚠️ XML缓存已失效，将使用动态分析
   ```

2. **步骤卡片缺失**
   ```
   ⚠️ 步骤卡片数据不完整
   ```

3. **分析函数不可用**
   ```
   ❌ 智能分析功能不可用
   ```

4. **后端调用失败**
   ```
   ❌ 刷新失败: [具体错误信息]
   ```

---

## 开发者注意事项

### 必须提供的依赖

使用刷新功能的组件必须能够访问：
1. `stepId` - 当前步骤ID
2. `card` - 步骤卡片数据（含XML快照）
3. `startAnalysis` - 智能分析启动函数

### 推荐的Hook

- `useIntelligentAnalysis()` - 提供 `startAnalysis`
- `useStepCardStore()` - 提供卡片数据
- `useAnalysisStateStore()` - 存储评分结果

---

## 更新日志

### 2025-11-16
- ✅ 实现 `StrategyScoreBadge` 点击刷新
- ✅ 实现 `SmartAnalysisPanel` 评分点击刷新
- ✅ 实现 `UnifiedStrategyConfigurator` 评分刷新
- ✅ 创建统一的 `refreshAllScores` 工具函数
- ✅ 菜单构建器集成刷新功能
- ✅ 所有评分都采用真实评分（Step1-8）
- ✅ Step1-2 优先（卡片子树、叶子上下文）
