# V3 离线模式卡顿修复报告 (Final)

## 1. 问题复盘

用户反馈在离线（无设备）状态下分析 XML 快照时，虽然最终能显示分数，但中间会出现 **15秒的严重卡顿** 和超时警告。

### 根因分析

1.  **V3 引擎的强设备依赖**：
    *   虽然我在上一轮修复中让前端传递了虚拟设备 ID (`offline_snapshot_mode`)，但 **Rust 后端** 的 V3 执行引擎 (`IntelligentAnalysisBackendV3`) 在收到请求后，依然尝试去连接这个“虚拟设备”以获取 UI 快照。
    *   后端日志显示：`❌ ADB Shell会话建立失败 - 设备: offline_snapshot_mode, 错误: 发送测试命令失败`。
    *   这个连接尝试导致了 **TCP 超时 (os error 10060)**，从而引发了前端的长时间等待。

2.  **回退机制的副作用**：
    *   V3 失败后，前端捕获错误并回退到 V2。
    *   V2 成功执行并返回了结果。
    *   但是，由于 V3 的超时等待，用户体验已经极差（卡顿 15 秒）。

## 2. 最终修复方案

**策略调整：智能路由 (Smart Routing)**

不再尝试欺骗 V3 后端（传递虚拟 ID），而是直接在前端进行**智能分流**：

*   **修改前**：所有请求优先走 V3 -> V3 失败 -> 降级 V2。
*   **修改后**：
    *   检查 `selectedDevice?.id` 是否存在。
    *   **有设备**：走 V3 引擎（高性能，支持动态执行）。
    *   **无设备 (离线/快照)**：**直接走 V2 引擎**（纯静态分析，无需 ADB）。

### 代码变更

文件：`src/modules/universal-ui/hooks/use-intelligent-analysis-workflow.ts`

```typescript
// 🚀 [智能路由] 仅在有真实设备连接时使用 V3 引擎
// 离线/快照分析强制使用 V2 引擎，避免 V3 尝试连接 ADB 导致超时和报错
const canUseV3 = currentExecutionVersion === "v3" && selectedDevice?.id;

if (canUseV3) {
  // ... V3 逻辑 ...
} else {
  if (currentExecutionVersion === "v3") {
    console.log("🔌 [Workflow] 离线/快照模式：自动切换到 V2 引擎以避免 ADB 连接");
  }
  // ... V2 逻辑 (直接执行，无延迟) ...
}
```

## 3. 预期效果

1.  **零卡顿**：点击分析后，因为直接调用 V2（纯内存计算），结果应在 **100ms 内** 立即返回。
2.  **无报错**：不再会有 "ADB 连接失败" 或 "分析超时" 的错误日志。
3.  **评分完整**：由于没有了超时和状态切换的干扰，评分数据将一次性完整渲染。

## 4. 评分合理性确认

再次确认用户提到的评分数据：
*   **结构分 (0.95)**：正确。系统识别出了卡片结构。
*   **文本分 (0.00)**：正确。透明层无文本。

请用户重新测试，现在的体验应该是“秒开”且丝滑的。
