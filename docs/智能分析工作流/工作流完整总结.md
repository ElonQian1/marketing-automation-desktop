# 步骤卡片智能分析工作流 - 完整总结

## 🎯 核心需求理解

### 业务背景
- **步骤卡片 = 脚本的可复用、可分享策略单元**
- **脚本要跨用户共享**，接收方应能直接使用
- **策略质量很重要**，但不能阻塞工作流程

### 关键约束
1. ✅ 卡片生成后**立即可用**（不能有等待状态）
2. ✅ 支持**先用默认值，后台分析**的模式
3. ✅ 发布/共享时**优先携带最新分析**
4. ✅ 其他用户可基于**元素信息+XML快照**重新分析

## 🔄 完整工作流设计

### 1. 本地创建流程
```
点选元素 → 立即生成卡片(兜底策略) → 后台智能分析 → 分析完成回填
    ↓              ↓                    ↓              ↓
  0.1秒         可直接使用            显示分析进度    自动/手动升级策略
```

### 2. 分析状态管理
```typescript
type AnalysisState = 
  | 'pending_analysis'    // 分析中 - 蓝色进度条
  | 'analysis_completed'  // 已完成 - 琥珀色"发现更优策略"
  | 'analysis_failed'     // 分析失败 - 红色"重试"
  | 'analysis_stale'      // 已过期 - 灰色"重新分析"
```

### 3. 发布/共享闸门
```
准备发布 → 检查分析状态 → 两种选择：
                         ├─ 先完成分析再发布(推荐)
                         └─ 立即发布(带兜底+快照)
```

## 📋 数据结构设计

### StepCard 核心字段
```typescript
interface StepCard {
  // 基础信息
  id: string;
  snapshotId: string;        // XML快照ID
  selectionHash: string;     // 元素选择签名
  
  // 当前策略
  activeStrategyKey: string;
  activeStrategyKind: 'static' | 'smart';
  isFallbackActive: boolean; // 是否使用兜底策略
  
  // 分析状态
  analysisState: AnalysisState;
  analysisJobId?: string;
  analyzedAt?: string;
  
  // 分析结果(完成后回填)
  smartCandidates?: StrategySummary[];
  staticCandidates?: StrategySummary[];
  recommendedKey?: string;
  recommendedConfidence?: number;
  
  // 行为配置
  autoFollowSmart: boolean;  // 智能跟随开关
}
```

### 脚本包结构
```
/script_bundle/
  script.json              # 脚本元数据
  steps/<STEP_ID>/
    step.json             # 步骤卡片数据
    analysis.json         # 分析结果
    snapshot.xml          # XML快照
    preview.png           # 可视化预览(可选)
```

## 🎨 UI 展示方案

### 步骤卡片状态展示

#### 1. 分析中状态
```
┌─ 步骤卡片 ─────────────────────────┐
│ 🔵 智能分析进行中... 63% | 预计2s    │
│    暂用兜底策略，可继续录制         │
├─────────────────────────────────┤
│ 当前策略: XPath直接 [兜底策略]      │
│ 选择器: //button[@text="确认"]      │
│ [预览高亮] [手动编辑]              │
└─────────────────────────────────┘
```

#### 2. 分析完成状态
```
┌─ 步骤卡片 ─────────────────────────┐
│ 🟡 发现更优策略(86%) [一键升级]     │
├─────────────────────────────────┤
│ 当前策略: XPath直接 [兜底策略]      │
│ 推荐策略: 智能匹配-自我锚点(86%)    │
│ 候选策略: 3个可选                  │
│ □ 智能跟随 (自动应用高置信度策略)   │
└─────────────────────────────────┘
```

#### 3. 分析失败状态
```
┌─ 步骤卡片 ─────────────────────────┐
│ 🔴 分析失败: 超时/上下文不足 [重试]  │
├─────────────────────────────────┤
│ 当前策略: XPath直接 [兜底策略]      │
│ 状态: 可正常使用，建议重试分析       │
└─────────────────────────────────┘
```

### 发布准备度检查

```
┌─ 准备发布脚本 ─────────────────────┐
│ 📊 分析完成度: 8/10 步骤             │
│ ✅ 步骤1-8: 已完成智能分析           │
│ ⏳ 步骤9: 分析中(预计30s)           │
│ ❌ 步骤10: 分析失败                 │
├─────────────────────────────────┤
│ [先完成分析再发布] [立即发布]        │
│ ⚠️ 立即发布将使用兜底策略           │
└─────────────────────────────────┘
```

## 🛠️ 核心接口设计

### Tauri命令
```rust
// 全量分析脚本的所有步骤
#[tauri::command]
async fn run_full_analysis(script_id: String) -> Result<Progress<Event>, Error>

// 准备脚本包(检查完成度)
#[tauri::command] 
async fn prepare_script_bundle(
    script_id: String, 
    allow_incomplete: bool
) -> Result<BundlePath, Error>

// 导入脚本包
#[tauri::command]
async fn import_script_bundle(bundle_path: String) -> Result<String, Error>
```

### 前端Hook
```typescript
// 步骤分析管理
export function useStepAnalysis(stepId: string) {
  const { analysisState, progress, error } = useAnalysisState(stepId);
  const { startAnalysis, retryAnalysis } = useAnalysisActions(stepId);
  const { upgradeToSmart, toggleAutoFollow } = useStrategyActions(stepId);
  
  return {
    state: analysisState,
    progress,
    error,
    actions: {
      startAnalysis,
      retryAnalysis, 
      upgradeToSmart,
      toggleAutoFollow
    }
  };
}

// 脚本发布准备
export function usePublishReadiness(scriptId: string) {
  const readiness = useScriptReadiness(scriptId);
  const { runFullAnalysis } = useScriptAnalysis(scriptId);
  
  return {
    completedSteps: readiness.completed,
    pendingSteps: readiness.pending,
    failedSteps: readiness.failed,
    completionRate: readiness.rate,
    actions: {
      runFullAnalysis,
      publishWithFallback: () => prepareBundle(scriptId, true),
      publishComplete: () => prepareBundle(scriptId, false)
    }
  };
}
```

## 🚀 实施优势

### 1. 用户体验友好
- ✅ **立即响应** - 点选元素后0.1秒生成可用卡片
- ✅ **非阻塞** - 可继续录制其他步骤，不用等待分析
- ✅ **进度可见** - 分析过程清晰展示，降低焦虑
- ✅ **智能升级** - 分析完成后可一键应用更优策略

### 2. 脚本共享完善
- ✅ **质量保证** - 发布时检查分析完成度
- ✅ **完整传递** - 包含XML快照和完整分析结果
- ✅ **环境适配** - 接收方可基于快照重新分析
- ✅ **开箱即用** - 其他用户拿到后直接可用

### 3. 开发友好
- ✅ **渐进实施** - 基于现有StepCard组件扩展
- ✅ **状态驱动** - 通过状态控制UI展示，无需新组件
- ✅ **数据完整** - 包含重新分析所需的所有信息
- ✅ **向后兼容** - 现有脚本仍可正常工作

## 📈 关键指标

### 性能指标
- 卡片生成响应时间: < 0.1秒
- 兜底策略生成成功率: > 95%
- 智能分析完成率: > 85%
- 分析结果置信度: > 0.8时自动升级

### 用户体验指标  
- 分析过程透明度: 实时进度+预估时间
- 策略升级接受率: 跟踪用户是否采用推荐策略
- 脚本共享成功率: 接收方直接使用vs重新分析比例

## 🎯 核心价值

这个设计完美平衡了**效率与质量**：

1. **效率优先** - 不阻塞用户工作流，立即可用
2. **质量保证** - 后台智能优化，持续提升策略质量  
3. **共享友好** - 完整的分析结果随脚本传播
4. **灵活适配** - 支持不同环境的重新分析

**一句话总结：让步骤卡片成为"可立即使用、持续优化、完美共享"的智能策略单元。**