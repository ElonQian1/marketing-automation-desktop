# æ™ºèƒ½åˆ†æå·¥ä½œæµ - ç»„ä»¶æ¶æ„è¯´æ˜

> æ›´æ–°æ—¶é—´: 2025-10-15  
> ç‰ˆæœ¬: v2.0 - é‡æ„åçš„æ¸…æ™°æ¶æ„

---

## ğŸ“ æ¶æ„åŸåˆ™

**åˆ†å±‚è®¾è®¡ - UIä¸é€»è¾‘åˆ†ç¦»**:
- **UIå±‚** (Presentation Layer) - åªè´Ÿè´£å±•ç¤ºå’Œç”¨æˆ·äº¤äº’
- **é€»è¾‘å±‚** (Application Layer) - è´Ÿè´£ä¸šåŠ¡æµç¨‹ã€çŠ¶æ€ç®¡ç†ã€åç«¯äº¤äº’

---

## ğŸ¯ æ ¸å¿ƒç»„ä»¶æ¶æ„

### 1. ElementSelectionPopoverï¼ˆä¸»å…¥å£ï¼‰
**ä½ç½®**: `src/components/universal-ui/element-selection/ElementSelectionPopover.tsx`  
**èŒè´£**: å…ƒç´ é€‰æ‹©æ°”æ³¡çš„ä¸»å…¥å£ç»„ä»¶  
**ç‰¹æ€§**:
- âœ… å®Œæ•´çš„å…ƒç´ é€‰æ‹©åŠŸèƒ½
- âœ… é›†æˆæ™ºèƒ½åˆ†æï¼ˆé€šè¿‡ `useStrategyAnalysis` Hookï¼‰
- âœ… ç­–ç•¥åˆ†ææ¨¡æ€æ¡†
- âœ… å…ƒç´ å‘ç°åŠŸèƒ½

**ä½¿ç”¨åœºæ™¯**: è„šæœ¬æ„å»ºå™¨ä¸­çš„å…ƒç´ ç‚¹é€‰

---

### 2. IntelligentAnalysisPopoverUIï¼ˆæ™ºèƒ½åˆ†æUIå±‚ï¼‰
**ä½ç½®**: `src/modules/universal-ui/ui/components/intelligent-analysis-popover-ui.tsx`  
**åŸå**: ~~UniversalEnhancedElementPopover~~  
**èŒè´£**: æ™ºèƒ½åˆ†æç›¸å…³çš„æ°”æ³¡æŒ‰é’®å’ŒçŠ¶æ€å±•ç¤ºï¼ˆçº¯UIç»„ä»¶ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**:
```typescript
interface IntelligentAnalysisPopoverUIProps {
  state: 'idle' | 'analyzing' | 'analyzed' | 'failed';  // æ˜¾ç¤ºçŠ¶æ€
  analysisProgress: number;                              // è¿›åº¦æ¡
  elementContext: ElementSelectionContext;               // å…ƒç´ ä¸Šä¸‹æ–‡
  
  // ç”¨æˆ·äº¤äº’äº‹ä»¶ï¼ˆç”±çˆ¶ç»„ä»¶å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰
  onStartAnalysis?: () => void;        // ğŸ§  æ™ºèƒ½åˆ†æ
  onDirectConfirm?: () => void;        // âœ… ç›´æ¥ç¡®å®š
  onConfirmWithoutWaiting?: () => void; // ä¸ç­‰äº†ï¼Œç›´æ¥ç¡®å®š
  onCancel?: () => void;
  onHide?: () => void;
  onToggleLockContainer?: (locked: boolean) => void;  // ğŸ“ é”å®šå®¹å™¨
  onPreviewXPath?: () => void;                        // é¢„è§ˆXPath
}
```

**UIçŠ¶æ€å±•ç¤º**:
| çŠ¶æ€ | æŒ‰é’®å¸ƒå±€ | ä¿¡æ¯æ˜¾ç¤º |
|------|---------|---------|
| **idle** | ğŸ§  æ™ºèƒ½åˆ†æ + âœ… ç›´æ¥ç¡®å®š + ğŸ” å‘ç°å…ƒç´  + âŒ å–æ¶ˆ | å…ƒç´ åŸºæœ¬ä¿¡æ¯ |
| **analyzing** | â¹ å–æ¶ˆåˆ†æ + âœ… ä¸ç­‰äº†,ç¡®å®š | è¿›åº¦æ¡ + å½“å‰æ­¥éª¤ |
| **analyzed** | âœ… ä½¿ç”¨æ¨è + ğŸ”§ æŸ¥çœ‹è¯¦æƒ… + ğŸ“‹ ç›´æ¥ç¡®å®š | æ¨èç­–ç•¥ + ç½®ä¿¡åº¦ |
| **failed** | ğŸ”„ é‡è¯•åˆ†æ + âœ… ç›´æ¥ç¡®å®š | é”™è¯¯ä¿¡æ¯ |

**è®¾è®¡ç‰¹ç‚¹**:
- âœ… çº¯UIç»„ä»¶ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- âœ… æ‰€æœ‰äº¤äº’é€šè¿‡å›è°ƒå‡½æ•°ä¼ é€’ç»™çˆ¶ç»„ä»¶
- âœ… å“åº”å¼å¸ƒå±€ï¼Œæ”¯æŒä¸åŒçŠ¶æ€çš„UIåˆ‡æ¢
- âœ… æä¾›è¾…åŠ©åŠŸèƒ½ï¼ˆé”å®šå®¹å™¨ã€XPathé¢„è§ˆï¼‰

---

### 3. IntelligentAnalysisControllerï¼ˆæ™ºèƒ½åˆ†æé€»è¾‘å±‚ï¼‰
**ä½ç½®**: `src/modules/universal-ui/components/intelligent-analysis-controller.tsx`  
**åŸå**: ~~EnhancedElementSelectionPopover~~  
**èŒè´£**: æ™ºèƒ½åˆ†æçš„ä¸šåŠ¡é€»è¾‘æ§åˆ¶å™¨

**æ ¸å¿ƒåŠŸèƒ½**:
```typescript
interface IntelligentAnalysisControllerProps {
  elementContext: ElementSelectionContext;
  state: PopoverState;
  currentJob?: AnalysisJob;  // å½“å‰åˆ†æä»»åŠ¡
  
  // ä¸šåŠ¡é€»è¾‘å›è°ƒ
  onStartAnalysis?: () => void;
  onDirectConfirm?: () => void;
  onCancelAnalysis?: () => void;
  onUseRecommended?: (strategy: StrategyCandidate) => void;
  onViewStrategyDetails?: () => void;
}
```

**æ ¸å¿ƒèŒè´£**:
1. **çŠ¶æ€ç®¡ç†**
   - ç®¡ç†åˆ†æå·¥ä½œæµçŠ¶æ€æœºï¼ˆidle â†’ analyzing â†’ completed/failedï¼‰
   - è·Ÿè¸ªå½“å‰åˆ†æä»»åŠ¡ï¼ˆAnalysisJobï¼‰

2. **åç«¯é›†æˆ** (å¾…å®ç°)
   ```typescript
   // åº”è¯¥è°ƒç”¨çš„Tauriå‘½ä»¤
   await invoke('start_analysis', { snapshotId, elementCtxJson, stepId });
   await invoke('cancel_analysis', { jobId });
   await invoke('bind_analysis_result_to_step', { stepId, resultJson });
   ```

3. **äº‹ä»¶ç›‘å¬** (å¾…å®ç°)
   ```typescript
   // ç›‘å¬åç«¯äº‹ä»¶
   await listen('analysis:progress', handleProgress);
   await listen('analysis:done', handleDone);
   await listen('analysis:error', handleError);
   ```

4. **é˜²ä¸²æ‰°æœºåˆ¶**
   ```typescript
   // ä¸‰é‡æ ¡éªŒ
   if (jobId !== currentJobId) return;
   if (result.selectionHash !== currentSelectionHash) return;
   if (stepId && result.stepId !== stepId) return;
   ```

5. **åè°ƒUIå±‚**
   - å†…éƒ¨ä½¿ç”¨ `IntelligentAnalysisPopoverUI` å±•ç¤º
   - å¤„ç†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åæ›´æ–°UIçŠ¶æ€

**è®¾è®¡ç‰¹ç‚¹**:
- âœ… å°è£…æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
- âœ… ç®¡ç†ä¸åç«¯çš„äº¤äº’ï¼ˆå½“å‰ä½¿ç”¨æ¨¡æ‹Ÿï¼‰
- âœ… å®ç°é˜²ä¸²æ‰°å’Œå®‰å…¨æœºåˆ¶
- âœ… åè°ƒUIå±‚çš„å±•ç¤º

---

## ğŸ”„ ç»„ä»¶åä½œå…³ç³»

```
ElementSelectionPopover (ä¸»å…¥å£)
    â”œâ”€ useStrategyAnalysis Hook (åˆ†æé€»è¾‘)
    â””â”€ StrategyAnalysisModal (ç­–ç•¥è¯¦æƒ…)

IntelligentAnalysisController (é€»è¾‘æ§åˆ¶å™¨)
    â”œâ”€ çŠ¶æ€ç®¡ç† (state machine)
    â”œâ”€ åç«¯äº¤äº’ (Tauri commands)
    â”œâ”€ äº‹ä»¶ç›‘å¬ (analysis:progress/done/error)
    â””â”€ IntelligentAnalysisPopoverUI (UIå±•ç¤º)
             â”œâ”€ æŒ‰é’®å¸ƒå±€ (æ ¹æ®çŠ¶æ€åˆ‡æ¢)
             â”œâ”€ è¿›åº¦æ˜¾ç¤º
             â””â”€ ç”¨æˆ·äº¤äº’ (é€šè¿‡å›è°ƒ)
```

---

## ğŸ“¦ å¯¼å‡ºå’Œä½¿ç”¨

### ä» `@modules/universal-ui` å¯¼å…¥

```typescript
// æ™ºèƒ½åˆ†ææ§åˆ¶å™¨ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰
import { 
  IntelligentAnalysisController,
  type IntelligentAnalysisControllerProps 
} from '@modules/universal-ui';

// æ™ºèƒ½åˆ†æUIç»„ä»¶ï¼ˆUIå±•ç¤ºå±‚ï¼‰
import { 
  IntelligentAnalysisPopoverUI,
  type IntelligentAnalysisPopoverUIProps 
} from '@modules/universal-ui';

// ç±»å‹å®šä¹‰
import type {
  ElementSelectionContext,
  AnalysisJob,
  StrategyCandidate
} from '@modules/universal-ui';
```

### ä½¿ç”¨ç¤ºä¾‹

**åœºæ™¯1: ä½¿ç”¨æ§åˆ¶å™¨ï¼ˆæ¨èï¼‰**
```typescript
// å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ + UI
<IntelligentAnalysisController
  elementContext={context}
  state="idle"
  onStartAnalysis={handleStart}
  onDirectConfirm={handleConfirm}
  onUseRecommended={handleApply}
/>
```

**åœºæ™¯2: åªä½¿ç”¨UIå±‚ï¼ˆè‡ªå·±ç®¡ç†é€»è¾‘ï¼‰**
```typescript
// åªè¦UIå±•ç¤ºï¼Œä¸šåŠ¡é€»è¾‘è‡ªå·±å¤„ç†
<IntelligentAnalysisPopoverUI
  state={myState}
  analysisProgress={myProgress}
  elementContext={context}
  onStartAnalysis={() => {
    // è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘
  }}
  onDirectConfirm={() => {
    // è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘
  }}
/>
```

---

## ğŸš« å·²åˆ é™¤çš„ç»„ä»¶

### ~~EnhancedSelectionPopover~~ (æ›¿ä»£å…ƒç´ åŠŸèƒ½)
**ä½ç½®**: ~~`src/components/universal-ui/element-selection/enhanced-popover/`~~  
**åŸå› **: ä¸ä¸»åŠŸèƒ½é‡å¤ï¼Œå·²åˆ é™¤  
**æ›¿ä»£æ–¹æ¡ˆ**: ä½¿ç”¨ `ElementSelectionPopover` + `ElementDiscoveryModal`

---

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§ç»„ä»¶è¿ç§»

**æ—§ä»£ç **:
```typescript
import { EnhancedElementSelectionPopover } from '@modules/universal-ui';

<EnhancedElementSelectionPopover
  elementContext={context}
  state="idle"
  onStartAnalysis={handleStart}
/>
```

**æ–°ä»£ç **:
```typescript
import { IntelligentAnalysisController } from '@modules/universal-ui';

<IntelligentAnalysisController
  elementContext={context}
  state="idle"
  onStartAnalysis={handleStart}
/>
```

**æ—§ä»£ç **:
```typescript
import { UniversalEnhancedElementPopover } from '@modules/universal-ui';

<UniversalEnhancedElementPopover
  state="analyzing"
  analysisProgress={50}
  onDirectConfirm={handleConfirm}
/>
```

**æ–°ä»£ç **:
```typescript
import { IntelligentAnalysisPopoverUI } from '@modules/universal-ui';

<IntelligentAnalysisPopoverUI
  state="analyzing"
  analysisProgress={50}
  onDirectConfirm={handleConfirm}
/>
```

---

## ğŸ“ å‘½åè§„èŒƒ

### æ–‡ä»¶å‘½å
- âœ… **UIç»„ä»¶**: `*-ui.tsx` - çº¯å±•ç¤ºç»„ä»¶
- âœ… **æ§åˆ¶å™¨**: `*-controller.tsx` - ä¸šåŠ¡é€»è¾‘ç»„ä»¶
- âœ… **Hook**: `use-*.ts` - è‡ªå®šä¹‰Hook
- âœ… **ç±»å‹**: `*-types.ts` - ç±»å‹å®šä¹‰

### ç»„ä»¶å‘½å
- âœ… **UIç»„ä»¶**: `ComponentNameUI` - æ˜ç¡®æ˜¯UIå±‚
- âœ… **æ§åˆ¶å™¨**: `ComponentNameController` - æ˜ç¡®æ˜¯é€»è¾‘å±‚
- âŒ **é¿å…**: `Enhanced*`, `Universal*`, `Advanced*` - è¯­ä¹‰æ¨¡ç³Š

### å¯¼å‡ºå‘½å
- âœ… **å‘½åå¯¼å‡º**: `export { IntelligentAnalysisPopoverUI }`
- âœ… **ç±»å‹å¯¼å‡º**: `export type { IntelligentAnalysisPopoverUIProps }`
- âœ… **é»˜è®¤å¯¼å‡º**: ä»…ç”¨äºä¸»ç»„ä»¶

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### èŒè´£æ¸…æ™°
- âœ… UIå±‚åªå…³æ³¨å±•ç¤º
- âœ… é€»è¾‘å±‚åªå…³æ³¨ä¸šåŠ¡
- âœ… ä¸¤è€…æ¾è€¦åˆï¼Œæ˜“äºç»´æŠ¤

### å¯æµ‹è¯•æ€§
- âœ… UIç»„ä»¶å¯ç‹¬ç«‹æµ‹è¯•ï¼ˆStorybookï¼‰
- âœ… ä¸šåŠ¡é€»è¾‘å¯å•å…ƒæµ‹è¯•
- âœ… æ¨¡æ‹Ÿåç«¯æ˜“äºé›†æˆæµ‹è¯•

### å¯æ‰©å±•æ€§
- âœ… å¯ç‹¬ç«‹æ›¿æ¢UIå±‚ï¼ˆæ¢è®¾è®¡ï¼‰
- âœ… å¯ç‹¬ç«‹å‡çº§é€»è¾‘å±‚ï¼ˆåŠ åŠŸèƒ½ï¼‰
- âœ… å¯è½»æ¾æ·»åŠ æ–°çš„åˆ†æç­–ç•¥

### ä»£ç å¤ç”¨
- âœ… UIç»„ä»¶å¯ç”¨äºå…¶ä»–åœºæ™¯
- âœ… ä¸šåŠ¡é€»è¾‘å¯è¢«å…¶ä»–UIå¤ç”¨
- âœ… ç±»å‹å®šä¹‰ç»Ÿä¸€å…±äº«

---

## ğŸ”® æœªæ¥è§„åˆ’

### çŸ­æœŸï¼ˆ2å‘¨å†…ï¼‰
- [ ] å®ç°çœŸå®çš„Tauriåç«¯é›†æˆ
- [ ] å®ç°ä¸‰é‡é˜²ä¸²æ‰°æœºåˆ¶
- [ ] æ·»åŠ å–æ¶ˆåˆ†æåŠŸèƒ½

### ä¸­æœŸï¼ˆ1ä¸ªæœˆå†…ï¼‰
- [ ] å®ç°æ­¥éª¤å¡è‡ªåŠ¨å›å¡«
- [ ] å®ç°è‡ªåŠ¨å‡çº§ç­–ç•¥
- [ ] æ·»åŠ é”å®šå®¹å™¨åŠŸèƒ½
- [ ] å®Œå–„é”™è¯¯å¤„ç†å’Œé‡è¯•

### é•¿æœŸï¼ˆ3ä¸ªæœˆå†…ï¼‰
- [ ] æ·»åŠ å¯è§‚æµ‹æ€§åŸ‹ç‚¹
- [ ] å®ç°é…ç½®å’Œç°åº¦ç³»ç»Ÿ
- [ ] ä¼˜åŒ–æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
- [ ] å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç‚¹é€‰å…ƒç´ æ°”æ³¡.md](./ç‚¹é€‰å…ƒç´ æ°”æ³¡.md) - åˆç‰ˆè®¾è®¡
- [ç‚¹é€‰å…ƒç´ æ°”æ³¡ å»ºè®®2.md](./ç‚¹é€‰å…ƒç´ æ°”æ³¡%20å»ºè®®2.md) - æ”¹è¿›å»ºè®®
- [ç‚¹é€‰å…ƒç´ æ°”æ³¡3æ•´ç†.md](./ç‚¹é€‰å…ƒç´ æ°”æ³¡3æ•´ç†.md) - å®Œæ•´æµç¨‹
- [ç‚¹é€‰å…ƒç´ æ°”æ³¡4å®Œå–„.md](./ç‚¹é€‰å…ƒç´ æ°”æ³¡4å®Œå–„.md) - å®ç°å¯¹æ¯”
- [å®Œæ•´æ€§ä¸å†—ä½™éªŒè¯æŠ¥å‘Š.md](./å®Œæ•´æ€§ä¸å†—ä½™éªŒè¯æŠ¥å‘Š.md) - éªŒè¯æŠ¥å‘Š

---

## âœ… æ€»ç»“

**é‡æ„æˆæœ**:
- âœ… åˆ é™¤äº†é‡å¤çš„ `EnhancedSelectionPopover` ç»„ä»¶
- âœ… é‡å‘½åä¸ºè¯­ä¹‰æ¸…æ™°çš„ `IntelligentAnalysisPopoverUI` (UIå±‚)
- âœ… é‡å‘½åä¸ºè¯­ä¹‰æ¸…æ™°çš„ `IntelligentAnalysisController` (é€»è¾‘å±‚)
- âœ… å»ºç«‹äº†æ¸…æ™°çš„åˆ†å±‚æ¶æ„
- âœ… æ›´æ–°äº†æ‰€æœ‰å¯¼å…¥å¼•ç”¨
- âœ… å®Œå–„äº†æ–‡æ¡£æ³¨é‡Š

**è®¾è®¡ä¼˜åŠ¿**:
- UIä¸é€»è¾‘åˆ†ç¦»ï¼ŒèŒè´£æ˜ç¡®
- å‘½åæ¸…æ™°ï¼Œä¸ä¼šäº§ç”Ÿæ­§ä¹‰
- æ˜“äºæµ‹è¯•ã€ç»´æŠ¤å’Œæ‰©å±•
- ä¸ºåç»­åŠŸèƒ½å®ç°æ‰“ä¸‹åšå®åŸºç¡€

**ä¸‹ä¸€æ­¥**:
1. å®ç°çœŸå®çš„Tauriåç«¯é›†æˆ
2. å®Œå–„é˜²ä¸²æ‰°å’Œå®‰å…¨æœºåˆ¶
3. å®ç°æ­¥éª¤å¡å›å¡«å’Œè‡ªåŠ¨å‡çº§
4. æŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
