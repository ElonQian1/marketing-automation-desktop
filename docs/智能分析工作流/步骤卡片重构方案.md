# 智能分析步骤卡片重构方案

## 📋 重构总结

基于现有 `StepCard` 组件，通过**渐进式增强**的方式添加智能分析功能，避免大规模重构。

## 🏗️ 架构设计

### 核心组件结构

```
AnalysisStepCard (新)
├── StepCard (现有，保持不变)
├── AnalysisStatusSection (新) - 分析状态展示区域
├── useStepCardAnalysis (新) - 分析状态管理Hook
└── types/AnalysisStepCard (新) - 相关类型定义
```

### 分析状态机

```
idle (空闲) → pending (分析中) → completed/failed/cancelled
```

## 🎨 UI 状态展示

### 1. 分析中状态 (`pending`)

```tsx
┌─────────────────────────────────────┐
│ 🔄 智能分析进行中              [停止] │
│ ████████████░░░░░░░░░░ 60%          │
│ 正在生成相对锚点... (4/7)            │
└─────────────────────────────────────┘
```

### 2. 分析完成状态 (`completed`)

#### 高置信度 (≥82%)
```tsx
┌─────────────────────────────────────┐
│ 🏆 发现推荐策略           [成功] 86% │
│ 自我定位策略: 基于元素自身唯一性特征   │
│ [一键升级] [查看详情]                │
└─────────────────────────────────────┘
```

#### 低置信度 (<82%)
```tsx
┌─────────────────────────────────────┐
│ ⚠️ 发现可选策略           [警告] 65% │
│ 区域限定策略: 基于容器边界相对位置     │
│ [应用策略] [查看详情]                │
└─────────────────────────────────────┘
```

### 3. 分析失败状态 (`failed`)
```tsx
┌─────────────────────────────────────┐
│ ⚠️ 智能分析失败                     │
│ 无法生成智能策略，将使用默认策略 [重试] │
└─────────────────────────────────────┘
```

## 🔧 使用方式

### 基础用法

```tsx
import { AnalysisStepCard } from '@/modules/universal-ui/ui/AnalysisStepCard';

<AnalysisStepCard
  title="匹配策略"
  stepId="step-001"
  selectionHash="abc123"
  enableAnalysis={true}
  analysisConfig={{
    autoFollowSmart: true
  }}
/>
```

### 高级用法 - 自定义分析操作

```tsx
<AnalysisStepCard
  title="智能步骤"
  enableAnalysis={true}
  analysis={{
    analysisState: 'completed',
    recommendedStrategy: {
      name: '自我定位策略',
      confidence: 86,
      description: '基于元素resource-id定位'
    }
  }}
  analysisActions={{
    onQuickUpgrade: async () => {
      // 自定义升级逻辑
      await applyStrategy();
    },
    onViewAnalysisDetails: () => {
      // 打开详情模态框
      setModalOpen(true);
    }
  }}
/>
```

## 📊 数据流和防串扰

### 1. 分析任务绑定

```typescript
// 从气泡创建步骤卡片时
const stepCard = await createStepCard({
  elementContext,
  analysisJobId: 'job-123',
  selectionHash: 'element-abc123'
});

// Hook自动绑定任务
useStepCardAnalysis({
  stepId: stepCard.id,
  selectionHash: 'element-abc123'
});
```

### 2. 结果防串扰校验

```typescript
// 后端分析完成后
const analysisResult = {
  jobId: 'job-123',
  selectionHash: 'element-abc123',
  stepId: 'step-001',
  result: { /* 分析结果 */ }
};

// Hook内部校验
if (analysisResult.selectionHash === currentSelectionHash && 
    analysisResult.stepId === currentStepId) {
  setAnalysisResult(analysisResult.result);
}
```

## 🚀 迁移计划

### 阶段1: 基础组件完成 ✅
- [x] 类型定义 (`AnalysisStepCard.ts`)
- [x] 状态Hook (`useStepCardAnalysis.ts`) 
- [x] 状态展示组件 (`AnalysisStatusSection.tsx`)
- [x] 增强卡片组件 (`AnalysisStepCard.tsx`)

### 阶段2: Tauri后端集成 ⏳
- [ ] 实现 `start_analysis` 命令
- [ ] 实现 `cancel_analysis` 命令  
- [ ] 实现 `bind_analysis_result_to_step` 命令
- [ ] 添加防串扰 `selection_hash` 计算

### 阶段3: 气泡-卡片联动 ⏳
- [ ] 气泡"直接确定"时自动创建 `AnalysisStepCard`
- [ ] 分析结果自动回填到对应卡片
- [ ] 实现自动升级逻辑 (confidence ≥ 82%)

### 阶段4: 企业级特性 📋
- [ ] 可观测性埋点
- [ ] 错误分类和重试策略
- [ ] 性能监控和优化

## 💡 优势

1. **向后兼容**: 现有 `StepCard` 无需修改
2. **渐进式**: 可以逐步启用分析功能  
3. **可复用**: Hook和组件可在多处使用
4. **类型安全**: 完整的TypeScript支持
5. **可测试**: 状态逻辑与UI分离

## 🎯 下一步

1. **后端集成**: 连接真实的Tauri分析命令
2. **气泡联动**: 完善创建卡片时的分析绑定
3. **用户测试**: 验证交互体验和性能
4. **文档完善**: 补充API文档和使用指南

这个方案保持了现有架构的稳定性，同时为智能分析功能提供了完整的UI支持。