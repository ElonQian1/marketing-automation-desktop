# 🚀 步骤卡片新功能快速使用指南

> 5分钟快速上手新增的4个关键功能组件

---

## 📦 安装/导入

```tsx
// 方式1：单独导入
import {
  UniversalFallbackBadge,
  UniversalStrategyCandidatesSection,
  UniversalStrategyModeSelector,
  UniversalPublishReadinessModal
} from '@/modules/universal-ui';

// 方式2：使用完整集成示例
import { UniversalEnhancedStepCardIntegration } from '@/modules/universal-ui';
```

---

## 1️⃣ "暂用兜底"徽标 - 最简使用

```tsx
import { UniversalFallbackBadge } from '@/modules/universal-ui';

// 在步骤卡片头部添加
<div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
  <h4>{stepCard.stepName}</h4>
  
  {/* 添加徽标 */}
  <UniversalFallbackBadge
    isFallbackActive={stepCard.activeStrategy?.key === stepCard.fallbackStrategy.key}
    fallbackName={stepCard.fallbackStrategy.name}
    isAnalyzing={stepCard.analysisState === 'analyzing'}
  />
</div>
```

**效果**：
- ✅ 使用兜底策略时显示橙色徽标
- ✅ 分析中时显示旋转动画
- ✅ 鼠标悬浮显示详细说明

---

## 2️⃣ 候选策略展示区 - 最简使用

```tsx
import { UniversalStrategyCandidatesSection } from '@/modules/universal-ui';

// 在步骤卡片的高级选项中添加
{stepCard.analysisState === 'analysis_completed' && (
  <UniversalStrategyCandidatesSection
    smartCandidates={stepCard.smartCandidates}
    activeStrategyKey={stepCard.activeStrategy?.key || ''}
    recommendedKey={stepCard.recommendedStrategy?.key}
    onApplyStrategy={(key) => {
      // 应用选中的策略
      console.log('应用策略:', key);
      // TODO: 调用后端API切换策略
    }}
  />
)}
```

**效果**：
- ✅ 显示Top-3智能候选策略
- ✅ 推荐策略有特殊标识（⚡智能推荐）
- ✅ 当前激活策略高亮显示
- ✅ 点击"应用此策略"按钮切换策略

---

## 3️⃣ 策略模式切换器 - 最简使用

```tsx
import { UniversalStrategyModeSelector } from '@/modules/universal-ui';
import type { StrategyMode } from '@/modules/universal-ui';

// 在步骤卡片的高级选项中添加
const [currentMode, setCurrentMode] = useState<StrategyMode>('intelligent');

<UniversalStrategyModeSelector
  currentMode={currentMode}
  onModeChange={(mode) => {
    setCurrentMode(mode);
    console.log('切换模式:', mode);
    // TODO: 更新后端状态
  }}
  smartCandidates={stepCard.smartCandidates}
  displayMode="compact"  // 或 "detailed"
/>
```

**三种模式**：
1. **intelligent（智能匹配）** - 完整决策链，支持回退
2. **smart_variant（智能-单步固定）** - 选一条，不回退
3. **static_user（用户自建静态）** - 手写XPath/CSS

---

## 4️⃣ 发布准备度闸门 - 最简使用

```tsx
import { UniversalPublishReadinessModal } from '@/modules/universal-ui';

const [showPublishModal, setShowPublishModal] = useState(false);
const [allSteps, setAllSteps] = useState<IntelligentStepCard[]>([...]);

// 在发布按钮点击时
<Button onClick={() => setShowPublishModal(true)}>
  发布脚本
</Button>

// 添加模态框
<UniversalPublishReadinessModal
  visible={showPublishModal}
  onClose={() => setShowPublishModal(false)}
  steps={allSteps}
  onPublish={() => {
    // 直接发布（使用当前状态）
    console.log('直接发布');
    // TODO: 调用发布API
    setShowPublishModal(false);
  }}
  onCompleteAnalysisAndPublish={async () => {
    // 一键完成分析后再发布
    console.log('开始补齐分析...');
    // TODO: 并发调用分析API
    await Promise.all(
      allSteps
        .filter(s => s.analysisState === 'idle')
        .map(s => analyzeStep(s.stepId))
    );
    console.log('分析完成，发布成功');
    setShowPublishModal(false);
  }}
/>
```

**效果**：
- ✅ 显示完成度进度条
- ✅ 列出待完成步骤
- ✅ 提供两种发布选项
- ✅ 智能按钮状态（根据完成度变化）

---

## 🎯 完整集成示例

如果你想一次性使用所有功能，可以直接使用集成示例组件：

```tsx
import { UniversalEnhancedStepCardIntegration } from '@/modules/universal-ui';
import type { IntelligentStepCard, StrategyMode } from '@/modules/universal-ui';

const YourStepCard: React.FC<{ stepCard: IntelligentStepCard }> = ({ stepCard }) => {
  const handleApplyStrategy = (key: string) => {
    // 应用策略
    console.log('应用策略:', key);
  };

  const handleModeChange = (mode: StrategyMode) => {
    // 切换模式
    console.log('切换模式:', mode);
  };

  const handleCancelAnalysis = () => {
    // 取消分析
    console.log('取消分析');
  };

  const handleRetryAnalysis = async () => {
    // 重试分析
    console.log('重试分析');
  };

  const handleQuickUpgrade = async () => {
    // 一键升级
    console.log('一键升级');
  };

  return (
    <UniversalEnhancedStepCardIntegration
      stepCard={stepCard}
      onApplyStrategy={handleApplyStrategy}
      onModeChange={handleModeChange}
      onCancelAnalysis={handleCancelAnalysis}
      onRetryAnalysis={handleRetryAnalysis}
      onQuickUpgrade={handleQuickUpgrade}
    />
  );
};
```

**这个组件包含了所有4个新功能**：
- ✅ 顶部分析状态条
- ✅ "暂用兜底"徽标
- ✅ 策略模式切换器
- ✅ 候选策略展示区

---

## 🎨 查看演示效果

访问演示页面查看所有组件的实际效果：

```tsx
import { UniversalAnalysisComponentsDemo } from '@/modules/universal-ui';

// 在路由中添加
{
  path: '/analysis-components-demo',
  element: <UniversalAnalysisComponentsDemo />
}
```

演示页面包含：
- 所有组件的使用示例
- 不同状态的展示
- 交互效果演示
- 代码使用说明

---

## ⚠️ 注意事项

### 1. 类型安全

确保使用正确的类型：

```tsx
import type { 
  IntelligentStepCard,
  StrategyMode,
  StrategyCandidate
} from '@/modules/universal-ui';
```

### 2. 样式一致性

所有组件已内置 `light-theme-force` 类，无需额外处理白底白字问题。

### 3. 数据准备

确保步骤卡片数据包含必要字段：

```tsx
const stepCard: IntelligentStepCard = {
  stepId: 'step_1',
  stepName: '点击联系人',
  stepType: 'tap',
  analysisState: 'analysis_completed',  // 必需
  smartCandidates: [...],                // 必需
  fallbackStrategy: {...},               // 必需
  activeStrategy: {...},                 // 必需
  // ... 其他字段
};
```

### 4. 后端集成

组件已准备好，但需要连接真实后端API：

- `start_analysis(stepId)` - 启动分析
- `cancel_analysis(jobId)` - 取消分析
- `apply_strategy(stepId, strategyKey)` - 应用策略
- `switch_mode(stepId, mode)` - 切换模式

---

## 📚 更多资源

- 📖 完整文档：`docs/智能分析工作流/步骤卡片缺失功能补充完成报告.md`
- 🎯 分析报告：`docs/智能分析工作流/步骤卡片重复冗余与样式问题分析报告.md`
- 💡 集成示例：`src/modules/universal-ui/ui/components/universal-enhanced-step-card-integration.tsx`
- 🎭 演示页面：`src/modules/universal-ui/pages/universal-analysis-components-demo.tsx`

---

## ✅ 快速检查清单

在使用前确认：

- [ ] 已导入所需组件
- [ ] 步骤卡片数据结构完整
- [ ] 实现了所有回调函数
- [ ] 添加了错误处理
- [ ] 测试了所有状态切换
- [ ] 检查了样式一致性

**开始使用吧！** 🚀
