# 快速启动指南 - 智能分析后端集成

> 🎯 目标: 30分钟内完成基础后端集成  
> 📖 详细文档: [Tauri后端集成实施指南](./Tauri后端集成实施指南.md)

---

## ⚡ 快速开始 (5步)

### Step 1: 创建后端模块 (5分钟)

```bash
# 创建文件
touch src-tauri/src/commands/intelligent_analysis.rs
```

**复制代码**: 从 [实施指南 Phase 1.1](./Tauri后端集成实施指南.md#11-创建后端模块) 复制完整代码

### Step 2: 更新 Cargo.toml (1分钟)

```toml
# src-tauri/Cargo.toml
[dependencies]
sha1 = "0.10"
uuid = { version = "1.0", features = ["v4", "serde"] }
lazy_static = "1.4"
```

### Step 3: 注册模块和命令 (3分钟)

**文件1**: `src-tauri/src/commands/mod.rs`

```rust
pub mod intelligent_analysis; // ✅ 新增
pub use intelligent_analysis::*; // ✅ 新增
```

**文件2**: `src-tauri/src/main.rs`

```rust
.invoke_handler(tauri::generate_handler![
    // ... 现有命令 ...
    
    // ✅ 新增
    commands::start_intelligent_analysis,
    commands::cancel_intelligent_analysis,
    commands::bind_analysis_result_to_step,
])
```

### Step 4: 前端替换模拟逻辑 (10分钟)

**文件**: `src/modules/universal-ui/components/intelligent-analysis-controller.tsx`

找到 `handleStartAnalysis` 函数,替换为:

```typescript
const handleStartAnalysis = useCallback(async () => {
  try {
    const { invoke } = await import('@tauri-apps/api');
    
    const config = {
      elementContext: {
        snapshotId: elementContext.snapshotId,
        elementPath: elementContext.elementPath,
        elementText: elementContext.elementText,
        elementBounds: elementContext.elementBounds,
        elementType: elementContext.elementType,
        keyAttributes: elementContext.keyAttributes,
        containerInfo: elementContext.containerInfo,
      },
      lockContainer: localLockContainer,
      enableSmartCandidates: true,
      enableStaticCandidates: true,
    };
    
    const response = await invoke('start_intelligent_analysis', { config });
    console.log('✅ 分析任务已启动', response);
    
    onStartAnalysis?.();
  } catch (error) {
    console.error('❌ 启动分析失败', error);
  }
}, [elementContext, localLockContainer, onStartAnalysis]);
```

### Step 5: 添加事件监听 (10分钟)

在 `IntelligentAnalysisController` 中添加:

```typescript
useEffect(() => {
  if (!visible) return;
  
  const setupListeners = async () => {
    const { listen } = await import('@tauri-apps/api/event');
    
    // 进度事件
    const unlistenProgress = await listen('analysis:progress', (event) => {
      const { jobId, progress, currentStep } = event.payload;
      if (currentJob?.jobId !== jobId) return;
      
      console.log('进度:', progress, currentStep);
      // 更新UI...
    });
    
    // 完成事件 (带三重校验)
    const unlistenDone = await listen('analysis:done', (event) => {
      const { jobId, selectionHash, result } = event.payload;
      
      // 🔒 三重校验
      if (currentJob?.jobId !== jobId) return;
      
      const currentHash = calculateSelectionHash(elementContext);
      if (currentHash !== selectionHash) return;
      
      if (currentJob.stepId && result.stepId && 
          currentJob.stepId !== result.stepId) return;
      
      // ✅ 通过校验
      console.log('分析完成', result);
      // 处理结果...
    });
    
    // 错误事件
    const unlistenError = await listen('analysis:error', (event) => {
      console.error('分析错误', event.payload);
    });
    
    return () => {
      unlistenProgress();
      unlistenDone();
      unlistenError();
    };
  };
  
  setupListeners();
}, [visible, currentJob, elementContext]);
```

---

## 🧪 测试验证 (5分钟)

### 1. 启动开发模式

```bash
pnpm tauri dev
```

### 2. 浏览器控制台测试

```javascript
// 测试后端命令
const { invoke } = window.__TAURI__.tauri;

const config = {
  elementContext: {
    snapshotId: 'test-123',
    elementPath: '/hierarchy/android.widget.Button[0]',
    elementText: '确定',
  },
  lockContainer: false,
  enableSmartCandidates: true,
  enableStaticCandidates: true
};

invoke('start_intelligent_analysis', { config })
  .then(res => console.log('✅ 启动成功', res))
  .catch(err => console.error('❌ 启动失败', err));
```

### 3. 监听事件

```javascript
const { listen } = window.__TAURI__.event;

await listen('analysis:progress', (e) => {
  console.log('📊 进度:', e.payload);
});

await listen('analysis:done', (e) => {
  console.log('✅ 完成:', e.payload);
});
```

---

## ✅ 验收标准

- [ ] Tauri 开发模式成功启动
- [ ] 浏览器控制台可以调用 `start_intelligent_analysis`
- [ ] 可以接收到 `analysis:progress` 事件
- [ ] 可以接收到 `analysis:done` 事件
- [ ] 前端 UI 显示分析进度
- [ ] 分析完成后显示结果
- [ ] 三重校验正常工作 (切换元素时旧结果被忽略)

---

## 🐛 常见问题

### Q1: 编译错误 `sha1` 找不到

**解决**: 确保已在 `Cargo.toml` 中添加依赖

```toml
sha1 = "0.10"
```

### Q2: TypeScript 类型错误

**解决**: 确保已导入类型

```typescript
import type { 
  AnalysisJobConfig, 
  AnalysisJobResponse,
  AnalysisProgressEvent,
  AnalysisDoneEvent,
} from '../types/intelligent-analysis-types';
```

### Q3: 事件监听器未触发

**解决**: 检查 jobId 是否匹配

```typescript
console.log('期望的 jobId:', currentJob?.jobId);
console.log('收到的 jobId:', event.payload.jobId);
```

### Q4: selection_hash 不匹配

**解决**: 确保前后端计算逻辑一致,检查:
- snapshot_id
- element_path
- 属性排序

---

## 📚 下一步

完成基础集成后,继续:

1. **实现步骤卡自动回填** - [实施指南 Phase 4](./Tauri后端集成实施指南.md#phase-4-步骤卡集成)
2. **接入真实策略生成服务** - 替换 mock 数据
3. **优化错误处理** - 添加重试机制
4. **性能优化** - 添加缓存和批量分析

---

## 📖 完整文档

- 📘 [Tauri后端集成实施指南](./Tauri后端集成实施指南.md) - 完整代码和详细说明
- 📗 [组件架构说明](./组件架构说明.md) - 架构设计原则
- 📙 [完整性与冗余验证报告](./完整性与冗余验证报告.md) - 当前实现状态

---

**准备好开始了吗? 🚀 打开终端开始 Step 1!**
