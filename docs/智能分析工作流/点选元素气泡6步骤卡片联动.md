结论：**你的分类体系是准确、清晰、可落地的**。
我只做两点小完善——**命名更标准化**、**运行语义再钉死**——这样开发、测试、发布都更顺手。

---

# ✅ 策略分类（保留你原意，略微标准化）

| 对外名称                       | 内部键名（建议）                                         | 生成方式                       | 回退                    | 备注                  |
| -------------------------- | ------------------------------------------------ | -------------------------- | --------------------- | ------------------- |
| **智能匹配（推荐）**               | `mode: "intelligent"`                            | 算法生成**完整决策链**（Step1→Step6） | ✅ 受控回退（按 Plan 顺序，小预算） | 等价“组合器/ensemble”总选项 |
| **智能-单步固定**（你说的“智能分析手动步骤”） | `mode: "manual"`, `active.kind: "smart_variant"` | 从智能分析中**挑一条**              | ❌ 不回退                 | 仅执行该变体，配“轻校验”       |
| **用户自建静态**                 | `mode: "manual"`, `active.kind: "static_user"`   | 用户手写 / 由向导拼装               | ❌ 不回退                 | 可加入/置顶到智能候选         |

> 小提示：如果要支持 Web 场景，**“CSS选择器（仅Web）”**请在 UI 文案注明“仅Web”；Android 原生推荐 XPath/UiSelector/Hybrid 表达式，避免误解。

---

# 🧠 运行语义（钉死边界，避免歧义）

1. **智能匹配**

* 执行顺序：**推荐 →（必要时）按 Plan 回退**；每条候选有**单次时间片**（如 150–200ms），总预算（如 ~1200ms），**命中即停**。
* 候选优先级：`自我锚点 > 区域+文本上溯 > 区域内局部索引+轻校验 > 邻居相对 > 全局索引（最后）`。
* UI：显示“**推荐：{策略名}（置信度%）**”；保留“查看 Plan / 一键改用某条”。

2. **智能-单步固定**

* 只跑选中的**那一条**，**不回退**；
* 执行前做**轻校验**（唯一性=1、clickable/enabled、子树含关键词等），失败则立即返回，并提示“**改回智能匹配**”或“**重算**”。

3. **用户自建静态**

* 和“单步固定”同语义；
* 可选择“**加入智能候选**（可置顶 pinned）”，让组合器在智能模式下优先/较早尝试这条；
* 建议带**环境约束**（package/activity/locale/sdk/dpi）与**轻校验**，运行更稳。

---

# 🎛️ UI 结构（可直接对照实现）

```
┌─ 步骤卡片 · 策略选择 ────────────────────────┐
│ ● 智能匹配（推荐）                          │
│   - 推荐：区域+文本上溯（93%）              │
│   - [查看候选链 Plan]  [改用此推荐]         │
│                                             │
│ ○ 智能-单步固定（从分析结果里选一条）       │
│   ○ Step1 自我锚点（95分）                  │
│   ○ Step2 子树锚点（87分）                  │
│   ○ Step3 区域限定（82分）                  │
│   ○ Step4 邻居相对（76分）                  │
│   ○ Step5 局部索引（65分）                  │
│   ○ Step6 全局索引（40分）                  │
│   （提示：单步固定不回退，失败会直接报错）  │
│                                             │
│ ○ 用户自建静态                              │
│   ○ 自定义XPath: …                          │
│   ○ 自定义CSS（仅Web）: …                   │
│   ○ 组合策略: ID + 文本验证                 │
│   ○ [新建静态策略…]                         │
└─────────────────────────────────────────────┘
```

**卡片顶部状态条**（配合发布/共享）：

* 分析中：蓝色“智能分析进行中… 63%｜预计 2s（暂用兜底策略可执行）”
* 分析完成：琥珀“发现更优策略：xxx（86%）｜一键切换”
* 失败：红色“分析失败：超时/上下文不足｜重试”
* 过期：灰/黄“分析可能过期（快照/环境变）｜重新分析”

---

# 📦 发布/共享（配套规则）

* **默认带“最新分析”发布**：包内包含

  * `StepCard`（含 `mode`, `active`, `plan`, `recommended` 等）
  * 元素摘要 + **XML 快照** + （可选）截图预览
  * 用户静态策略放入 `strategy_library/*.strategy.json`，含 `version`/`constraints`/`checks`
* **未完成也允许发**：接收方基于**卡片 + 快照**一键重算；
* **信任与版本**：外来 `static_user` 策略默认 `untrusted`，首次运行需确认；发现高版本可“对比后升级”。

---

# ⚙️ 默认配置（开箱就好用）

* 智能匹配：`allow_backend_fallback=true`；`time_budget_ms≈1200`；`per_candidate_ms≈180`；`max_candidates≈4`
* 单步固定/用户静态：`strict_mode=true`（不回退），但**总做轻校验**
* 评分权重：`唯一属性 +100`，`content-desc +95`，`文本等值 +70`，`区域限定 +30`，`结构 +20~40`，`局部索引 -15（加轻校验 +10）`，`全局索引 -60`
* 统一硬约束：**唯一性=1** 才能执行动作

---

# 🔍 质量与可观测

* 记录：`used_variant`、尝试次数、匹配数、dump/匹配/点击耗时、回退轨迹
* 策略库记分板：各策略**在线成功率/平均耗时/回退率**，反哺评分与推荐
* 过期判定：`analyzed_at` 超期 / 引擎权重版本变更 / 环境指纹变化 → “分析可能过期”

---

# 🪪 命名建议（避免“增强版”）

* “智能-单步固定”（代替“智能分析的手动步骤”）
* “用户自建静态”（保留）
* 对外统一叫**“匹配模式”**（模式=智能/手动），对内用 `mode` + `active.kind` 区分来源

---

## 总结

* 你的三类非常合理：**智能匹配（组合器）**、**智能-单步固定**、**用户自建静态**。
* 关键区别是**是否回退**与**来源**；共享同一份 Plan 与快照，发布可开箱即用。
* 按上面的键名/语义/UI 文案落地，团队实现会更顺、后续维护也更稳。
