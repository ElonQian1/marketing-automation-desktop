没问题。下面把**“点选元素 → 生成步骤卡片后，智能分析尚未完成”**的整套处理方式、卡片样式展示与是否需要重构的建议，浓缩成一份可直接交给前端/后端/产品一起对齐的说明。

---

# 一、卡片生成后的工作流（结论版）

**目标**：卡片可立即使用（兜底策略），同时**后台完成智能分析并回填**，保证脚本可共享与可复用。

1. **建卡即可用**

* 立刻写入：**XML快照**、**绝对XPath**、**激活策略=兜底**（如“容器内局部索引+轻校验”或“绝对XPath”）。
* 标记：`analysis_state = pending_analysis`，并启动分析任务（带 `selection_hash`）。

2. **分析进行中（后台）**

* 不阻塞脚本继续录制/调试。
* 卡片顶部显示“分析中…进度/ETA”，当前策略带徽标“**暂用兜底**”。

3. **分析完成 → 回填**

* 回填：候选集合（含评分/理由/命中数）与**推荐策略**。
* 若开启“**智能跟随**”且推荐置信度 ≥ 阈值（建议 0.82）：**自动切换**为推荐策略；否则显示“**发现更优 → 一键升级**”。

4. **分析失败或过期**

* 失败：`analysis_state = analysis_failed`，卡片提示“可重试”；兜底继续可用。
* 过期（可选）：快照/环境/权重版本改变 → 显示“分析可能过期 → 重新分析”。

5. **发布/共享**

* **默认建议**等全部步骤 `analysis_completed` 后再发布（包内自带最新分析，接收方“开箱即用”）。
* 如仍有 `pending/failed`：允许发布，但包内包含**兜底策略 + 元素信息 + XML快照**，接收方可一键重算。

---

# 二、卡片现在/应有的样式（状态驱动渲染）

> 样式建议：不做“大改版”，只在现有 StepCard 上加“**状态条 + 徽标 + 候选区**”，整体保持你的设计语言。

## 顶部状态条（按 `analysis_state` 呈现）

* **pending_analysis（蓝）**：
  “智能分析进行中… 63%｜预计 2s（**暂用兜底策略**可执行）”
* **analysis_completed（琥珀）**（且未自动升级）：
  “发现更优策略：区域+文本上溯（86%）｜**一键升级**”
* **analysis_failed（红）**：
  “智能分析失败：超时/上下文不足｜**重试分析**”
* **analysis_stale（灰/黄，可选）**：
  “分析可能过期（快照/环境变化）｜**重新分析**”

## 主体信息区

* **当前激活策略**（名称、命中/耗时；若是兜底显示徽标“**暂用兜底**”）
* **匹配模式**：

  * **智能匹配（组合）**｜推荐：xxx（93%）｜[查看Plan]
  * 或 **手动固定**（智能-单步/用户自建静态）
* **候选区（分析完成后显示）**：Top-3 候选的“分数/命中/理由/预览/设为激活”
* **行为开关**：智能跟随（on/off）、允许后端受控回退（on/off）
* **来源信息**：元素摘要、XML快照时间戳（便于排查）

---

# 三、是否重构“新版本”？——**不需要新版本**，采用“状态驱动”的小改造

**结论**：不要新起“版本组件”，在现有 StepCard 组件里**补齐状态与字段**即可，保守、安全、回滚简单。

### 最小改造清单

1. **新增字段**（后端/前端共享）：

   * `analysis_state: 'pending_analysis' | 'analysis_completed' | 'analysis_failed' | 'analysis_stale'`
   * `analysis_job_id?`、`progress?`、`eta_ms?`、`analyzed_at?`
   * `plan[]`、`recommended_key?`、`recommended_confidence?`
   * `matching_mode: 'intelligent' | 'manual'`
   * `active_strategy: { key, kind: 'smart_variant'|'static_builtin'|'static_user', params… }`
   * `is_fallback_active: boolean`、`auto_follow_smart: boolean`
   * `selection_hash`、`snapshot_id`

2. **事件与防串扰**

   * 订阅 `analysis:progress/done/error`；
   * 回填前校验：`jobId + selection_hash + （若有）stepId` 三重匹配；
   * 切换所选元素/删除卡片/关闭气泡时发送 `cancel_analysis(jobId)`。

3. **UI 交互**

   * 顶部状态条 & CTA（重试、一键升级、重新分析）；
   * 候选区仅在 `analysis_completed` 时展开；
   * 兜底策略加“暂用”徽标与说明；
   * 发布弹窗加“准备度核对”（完成度/一键补齐分析/仍要发布）。

4. **后端执行**

   * **智能匹配**：先跑推荐，失败在**小预算**内按 Plan 回退；
   * **手动固定**：只跑该条（轻校验），不中即返回；
   * dump 复用与选择器预编译，保证匹配耗时远小于 dump。

---

# 四、发布/共享前的“准备度闸门”（强烈建议）

**发布弹窗**展示：

* 已完成分析：8/10
* 待完成：2（列表显示 step 名称）
* 按钮：

  * **一键完成分析后再发布**（并发补齐，完成即继续）
  * **直接发布（带兜底/快照，接收方可重算）**

> 这样你既保证**质量默认达标**，又保留**快速流转**的灵活性。

---

# 五、默认策略与阈值（开箱即用）

* `auto_follow_smart = true`，`recommended_confidence ≥ 0.82` 自动切换；
* 智能匹配回退预算：`time_budget_ms ≈ 1200`、`per_candidate_ms ≈ 180`、`max_candidates ≈ 4`；
* 评分规则：`唯一属性 +100`、`content-desc +95`、`文本等值 +70`、`区域限定 +30`、`结构 +20~40`、`局部索引 -15（加轻校验 +10）`、`全局索引 -60`；
* 硬约束：**唯一性=1** 才能执行动作。

---

# 六、验收（DoD）

1. 建卡后立刻可用（兜底），卡片显示“分析中…”。
2. 分析完成：回填 Plan 与推荐，支持**一键升级**或**自动跟随**。
3. 分析失败：卡片提示可**重试**，兜底仍可用。
4. 发布前有**准备度核对**，支持“一键完成分析再发布”。
5. 导入包：若含未完成的步骤，接收方可基于**卡片+快照**一键分析。
6. 事件防串扰：切换元素/删除卡片/关闭气泡后，旧结果不回填。

---

# 七、给产品/研发的“一句话”

> **卡片=脚本的一条可复用策略单元**：建卡即能跑（兜底），分析在后台补齐并回填；默认发布时携带**最新分析**，保证共享可用；一切以**状态驱动**呈现，无需新版本组件。

如果你愿意，我可以把**发布弹窗的“准备度核对”UI 草图**和**后端 `run_full_analysis/prepare_script_bundle` 命令骨架**补上，直接就能接线开发。
