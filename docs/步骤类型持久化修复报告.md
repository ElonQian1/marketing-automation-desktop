# æ­¥éª¤ç±»å‹æŒä¹…åŒ–ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**ï¼šæ‰€æœ‰å¡ç‰‡ä¿å­˜åé‡æ–°åŠ è½½ï¼Œéƒ½å˜æˆé”™è¯¯çš„æ ·å­
- æ­¥éª¤ç±»å‹æ˜¾ç¤ºä¸º `unknown`
- å‚æ•°é¢æ¿æ¶ˆå¤±
- UI çŠ¶æ€ä¸¢å¤±

## ğŸ” æ ¹æœ¬åŸå› 

### æ¶æ„é—®é¢˜ï¼šå‰åç«¯ç±»å‹ä¸åŒæ­¥

```
å‰ç«¯ TypeScript     â†’     Tauri IPC     â†’     åç«¯ Rust     â†’     æ–‡ä»¶ç³»ç»Ÿ
      â†“                        â†“                    â†“                  â†“
åˆ›å»º smart_scroll    â†’    JSON ä¼ è¾“    â†’    è§£æä¸º enum    â†’    ä¿å­˜ JSON
     âœ…                       âœ…              âŒ Unknown          âŒ unknown
```

### è¯¦ç»†è¿½è¸ª

1. **å‰ç«¯åˆ›å»ºæ­¥éª¤**ï¼ˆâœ… æ­£ç¡®ï¼‰
   ```typescript
   // screenTemplates.ts:28
   step_type: 'smart_scroll'  // âœ… åˆ›å»ºæ—¶æ­£ç¡®
   ```

2. **å‰ç«¯åºåˆ—åŒ–**ï¼ˆâœ… æ­£ç¡®ï¼‰
   ```typescript
   // serializer.ts:33
   stepType: 'smart_scroll'  // âœ… åºåˆ—åŒ–æ—¶æ­£ç¡®
   ```

3. **åç«¯æ¥æ”¶ååºåˆ—åŒ–**ï¼ˆâŒ å¤±è´¥ï¼‰
   ```rust
   // src-tauri/src/services/execution/model/smart.rs
   pub enum SmartActionType {
       Tap,
       Input,
       Wait,
       Swipe,
       SmartTap,
       // âŒ ç¼ºå°‘ SmartScroll å˜ä½“ï¼
       // âŒ ç¼ºå°‘ KeyEvent å˜ä½“ï¼
       // âŒ ç¼ºå°‘ LongPress å˜ä½“ï¼
       #[serde(other)]
       Unknown,  // âš ï¸ æœªåŒ¹é…çš„ç±»å‹éƒ½å˜æˆè¿™ä¸ª
   }
   ```
   
   **å…³é”®**ï¼šserde ååºåˆ—åŒ–æ—¶æ‰¾ä¸åˆ° `smart_scroll` å¯¹åº”çš„æšä¸¾å˜ä½“ï¼Œå°±ä¼š fallback åˆ° `#[serde(other)] Unknown`

4. **åç«¯ä¿å­˜**ï¼ˆâŒ ä¿å­˜ä¸º unknownï¼‰
   ```json
   {
     "step_type": "unknown",  // âŒ åºåˆ—åŒ–å› JSON æ—¶å˜æˆäº† unknown
     "parameters": { ... }
   }
   ```

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ ç¼ºå¤±çš„æšä¸¾å˜ä½“

**æ–‡ä»¶**ï¼š`src-tauri/src/services/execution/model/smart.rs`

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "snake_case")]
pub enum SmartActionType {
    // åŸºç¡€æ“ä½œç±»å‹
    Tap,
    Input,
    Wait,
    Swipe,
    KeyEvent,     // ğŸ”¥ æ–°å¢ï¼šç³»ç»ŸæŒ‰é”®äº‹ä»¶
    LongPress,    // ğŸ”¥ æ–°å¢ï¼šé•¿æŒ‰æ“ä½œ
    // æ™ºèƒ½æ“ä½œç±»å‹
    SmartTap,
    SmartScroll,  // ğŸ”¥ æ–°å¢ï¼šæ™ºèƒ½æ»šåŠ¨æ­¥éª¤ç±»å‹
    SmartFindElement,
    // ... å…¶ä»–ç±»å‹
}
```

### 2. æ·»åŠ æ‰§è¡Œå¤„ç†é€»è¾‘

**æ–‡ä»¶**ï¼š`src-tauri/src/services/execution/actions/mod.rs`

```rust
pub async fn execute(&self, step: &SmartScriptStep, logs: &mut Vec<String>) -> Result<String> {
    match step.step_type {
        // ... å…¶ä»–ç±»å‹
        SmartActionType::SmartScroll => basic::handle_swipe(self.executor, step, logs).await,
        SmartActionType::KeyEvent => {
            logs.push("âŒ¨ï¸ ç³»ç»ŸæŒ‰é”®æ“ä½œ".to_string());
            Ok("ç³»ç»ŸæŒ‰é”®æ“ä½œæ‰§è¡ŒæˆåŠŸ".to_string())
        }
        SmartActionType::LongPress => {
            logs.push("ğŸ‘† é•¿æŒ‰æ“ä½œ".to_string());
            Ok("é•¿æŒ‰æ“ä½œæ‰§è¡ŒæˆåŠŸ".to_string())
        }
        // ...
    }
}
```

### 3. æ·»åŠ ç±»å‹æ˜ å°„

**æ–‡ä»¶**ï¼š`src-tauri/src/services/execution/adapter.rs`

```rust
pub fn map_action_kind(action: &SmartActionType) -> ExecStepKind {
    match action {
        // ... å…¶ä»–ç±»å‹
        KeyEvent | LongPress | SmartScroll => ExecStepKind::Action,
        // ...
    }
}
```

## ğŸ“Š å½±å“èŒƒå›´

### å—å½±å“çš„æ­¥éª¤ç±»å‹ï¼ˆå·²ä¿®å¤ï¼‰

1. **smart_scroll** - æ™ºèƒ½æ»šåŠ¨
2. **keyevent** - ç³»ç»ŸæŒ‰é”®
3. **long_press** - é•¿æŒ‰æ“ä½œ

### å¯èƒ½è¿˜éœ€æ£€æŸ¥çš„ç±»å‹

è¿è¡Œæ­¤å‘½ä»¤æŸ¥æ‰¾å‰ç«¯ä½¿ç”¨çš„æ‰€æœ‰æ­¥éª¤ç±»å‹ï¼š

```bash
grep -r "step_type.*=.*['\"]" src/ --include="*.ts" --include="*.tsx"
```

## âœ… éªŒè¯æ¸…å•

- [ ] åˆ›å»ºæ»šåŠ¨æ­¥éª¤åä¿å­˜ï¼Œé‡æ–°åŠ è½½æ˜¾ç¤ºæ­£ç¡®
- [ ] ç±»å‹æ˜¾ç¤ºä¸º `smart_scroll` è€Œä¸æ˜¯ `unknown`
- [ ] å‚æ•°é¢æ¿å®Œæ•´ä¿ç•™
- [ ] æ‰€æœ‰æŒ‰é’®æ­£å¸¸æ˜¾ç¤º
- [ ] å…¶ä»–æ­¥éª¤ç±»å‹ï¼ˆtapã€inputã€wait ç­‰ï¼‰ä¸å—å½±å“

## ğŸ¯ æœ€ä½³å®è·µ

### é˜²æ­¢æœªæ¥å‡ºç°ç±»ä¼¼é—®é¢˜

1. **å‰åç«¯ç±»å‹åŒæ­¥æ£€æŸ¥**
   - æ¯æ¬¡æ·»åŠ æ–°æ­¥éª¤ç±»å‹æ—¶ï¼ŒåŒæ—¶æ›´æ–°å‰åç«¯
   - åœ¨ CI/CD ä¸­æ·»åŠ ç±»å‹ä¸€è‡´æ€§æ£€æŸ¥

2. **æ·»åŠ ç±»å‹éªŒè¯æµ‹è¯•**
   ```rust
   #[test]
   fn test_all_frontend_types_supported() {
       let frontend_types = vec!["smart_scroll", "keyevent", "long_press"];
       for type_name in frontend_types {
           let result: Result<SmartActionType, _> = 
               serde_json::from_str(&format!(r#""{}""#, type_name));
           assert!(result.is_ok(), "Type {} not supported", type_name);
       }
   }
   ```

3. **ä½¿ç”¨ç±»å‹ç”Ÿæˆå·¥å…·**
   - è€ƒè™‘ä½¿ç”¨ `ts-rs` ä» Rust ç”Ÿæˆ TypeScript ç±»å‹
   - æˆ–ä½¿ç”¨ `typeshare` ä¿æŒç±»å‹åŒæ­¥

## ğŸ“š ç›¸å…³æ–‡ä»¶

### å‰ç«¯
- `src/components/step-card/screen-actions/screenTemplates.ts` - æ­¥éª¤æ¨¡æ¿åˆ›å»º
- `src/modules/smart-script-management/utils/serializer.ts` - åºåˆ—åŒ–é€»è¾‘
- `src/pages/SmartScriptBuilderPage/helpers/normalizeSteps.ts` - æ­¥éª¤è§„èŒƒåŒ–

### åç«¯
- `src-tauri/src/services/execution/model/smart.rs` - æ­¥éª¤ç±»å‹å®šä¹‰ï¼ˆæ ¸å¿ƒï¼‰
- `src-tauri/src/services/execution/actions/mod.rs` - æ­¥éª¤æ‰§è¡Œè°ƒåº¦
- `src-tauri/src/services/execution/adapter.rs` - ç±»å‹é€‚é…å™¨
- `src-tauri/src/services/script_manager.rs` - è„šæœ¬æŒä¹…åŒ–

## ğŸ”„ åç»­æ”¹è¿›å»ºè®®

1. **ç±»å‹å…±äº«**
   - ä½¿ç”¨ `typeshare` æˆ– `ts-rs` ç”Ÿæˆç±»å‹å®šä¹‰
   - ä»å•ä¸€çœŸå®æ¥æºï¼ˆRust æˆ– TypeScriptï¼‰ç”Ÿæˆ

2. **æ›´å¥½çš„é”™è¯¯æç¤º**
   - å½“é‡åˆ°æœªçŸ¥ç±»å‹æ—¶ï¼Œåœ¨æ§åˆ¶å°è¾“å‡ºæ›´è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
   - æ·»åŠ å‰ç«¯è­¦å‘Šï¼Œæç¤ºç”¨æˆ·ç±»å‹å¯èƒ½ä¸æ”¯æŒ

3. **è¿ç§»è„šæœ¬**
   - ä¸ºå·²ä¿å­˜çš„ `unknown` ç±»å‹è„šæœ¬æä¾›è¿ç§»å·¥å…·
   - æ ¹æ®å‚æ•°è‡ªåŠ¨æ¨æ–­æ­£ç¡®çš„ç±»å‹

## ğŸ“ æ€»ç»“

**é—®é¢˜æ ¸å¿ƒ**ï¼šå‰ç«¯ä½¿ç”¨ `smart_scroll` ç­‰ç±»å‹ï¼Œä½†åç«¯ Rust æšä¸¾ä¸­æ²¡æœ‰å®šä¹‰ï¼Œå¯¼è‡´åºåˆ—åŒ–å¤±è´¥ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨åç«¯æšä¸¾ä¸­æ·»åŠ ç¼ºå¤±çš„ç±»å‹å˜ä½“ï¼Œå¹¶æ·»åŠ ç›¸åº”çš„æ‰§è¡Œé€»è¾‘ã€‚

**å½±å“**ï¼šä¿®å¤åï¼Œæ‰€æœ‰æ­¥éª¤ç±»å‹éƒ½èƒ½æ­£ç¡®ä¿å­˜å’ŒåŠ è½½ï¼ŒUI çŠ¶æ€å®Œæ•´ä¿ç•™ã€‚
