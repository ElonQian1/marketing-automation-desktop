# æœ€ç»ˆåˆ é™¤å†³ç­–ä¸å®‰å…¨æ¸…å•

## ğŸ“Š å®Œæ•´ä¾èµ–åˆ†ææ€»ç»“

### 1. ç»„ä»¶ä½¿ç”¨çŠ¶æ€çŸ©é˜µ

| ç»„ä»¶ | è¡Œæ•° | è¢«è°ä½¿ç”¨ | çŠ¶æ€ | å†³ç­– |
|------|------|----------|------|------|
| **EnhancedStepCard.tsx** | 284 | âŒ æ— å¼•ç”¨ï¼ˆå·²é‡å®šå‘ï¼‰ | åºŸå¼ƒ | âœ… **åˆ é™¤** |
| **NewStepCard.tsx** | 288 | âŒ æ— å¼•ç”¨ï¼ˆå­¤ç«‹ï¼‰ | å­¤ç«‹ | âœ… **åˆ é™¤** |
| **ActionParams.tsx** | 280 | âŒ åªè¢«NewStepCardä½¿ç”¨ | å­¤ç«‹ | âš ï¸ **æå–ååˆ é™¤** |
| **ActionBar.tsx** | 100 | âŒ åªè¢«NewStepCardä½¿ç”¨ | å­¤ç«‹ | âœ… **åˆ é™¤** |
| **ActionParamsPanel.tsx** | 836 | âœ… DraggableStepCard | ç”Ÿäº§ | âœ… **ä¿ç•™å¹¶å¢å¼º** |
| **useStepCardStateMachine.ts** | 305 | âš ï¸ åªè¢«NewStepCardä½¿ç”¨ | å­¤ç«‹ | âš ï¸ **è¯„ä¼°åå†³å®š** |

### 2. DraggableStepCard æ‰§è¡Œç³»ç»Ÿåˆ†æ

#### æ£€æŸ¥ç»“æœ

```bash
grepæœç´¢ "useSingleStepTest|useV2StepTest|StepExecutionGateway|useStepCardStateMachine"
  åœ¨ src/components/DraggableStepCard.tsx
  â†’ âŒ æ— åŒ¹é…

ç»“è®º: DraggableStepCard ä¸ä½¿ç”¨ä»»ä½•å†…ç½®æ‰§è¡ŒHook
```

#### DraggableStepCard çš„æ‰§è¡Œæœºåˆ¶

```tsx
// src/components/DraggableStepCard.tsx
// âš ï¸ æ²¡æœ‰å¯¼å…¥æ‰§è¡Œç›¸å…³çš„Hook

import { ActionParamsPanel } from "./action-system/ActionParamsPanel";
import type { ActionType, ActionParams } from "../types/action-types";

// âŒ æ²¡æœ‰ï¼š
// import { useV2StepTest } from '../hooks/useV2StepTest';
// import { useStepCardStateMachine } from '../hooks/useStepCardStateMachine';

// æ¨æ–­: DraggableStepCard ä¸åŒ…å«æ‰§è¡Œé€»è¾‘
// æ‰§è¡Œç”±å¤–éƒ¨çˆ¶ç»„ä»¶ï¼ˆå¦‚ StepCardSystemï¼‰è´Ÿè´£
```

### 3. useStepCardStateMachine çš„å‘½è¿

#### 3.1 å½“å‰ä½¿ç”¨æƒ…å†µ

```bash
grepç»“æœæ˜¾ç¤º:
  - âœ… è¢« NewStepCard.tsx ä½¿ç”¨
  - âŒ æ— å…¶ä»–ç”Ÿäº§ä»£ç ä½¿ç”¨
  - âœ… V3æ¶æ„æ ¸å¿ƒç»„ä»¶
```

#### 3.2 å†³ç­–çŸ©é˜µ

| åœºæ™¯ | å†³ç­– | ç†ç”± |
|------|------|------|
| **åœºæ™¯A: é¡¹ç›®å·²å…¨é¢ä½¿ç”¨V3** | âœ… ä¿ç•™ | ç”Ÿäº§ä¾èµ– |
| **åœºæ™¯B: NewStepCardæ˜¯å”¯ä¸€ä½¿ç”¨è€…** | âš ï¸ è¯„ä¼°åˆ é™¤ | å­¤ç«‹æ¨¡å— |
| **åœºæ™¯C: è®¡åˆ’è¿ç§»åˆ°V3** | âœ… ä¿ç•™ | æœªæ¥ä¾èµ– |

#### 3.3 æœ€ç»ˆå»ºè®®

```
âœ… ä¿ç•™ useStepCardStateMachine.ts (305è¡Œ)

ç†ç”±:
1. V3æ¶æ„æ ¸å¿ƒç»„ä»¶
2. StepExecutionGatewayä¾èµ–
3. æœªæ¥å¯èƒ½è¿ç§»DraggableStepCardåˆ°V3
4. åˆ é™¤æ”¶ç›Šå°ï¼ˆ305è¡Œï¼‰ï¼Œä¿ç•™é£é™©ä½
```

### 4. å®‰å…¨åˆ é™¤æ¸…å•ï¼ˆPhase 1 - ç«‹å³æ‰§è¡Œï¼‰

#### 4.1 ç¡®å®šåˆ é™¤ï¼ˆ571è¡Œï¼‰

```bash
# æ–‡ä»¶åˆ é™¤æ¸…å•
src/components/enhanced-step-card/EnhancedStepCard.tsx       # 284è¡Œ
src/components/stepCards/NewStepCard.tsx                     # 288è¡Œ

# æ€»è®¡: 572è¡Œ
```

#### 4.2 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

```typescript
// 1. src/modules/action-system/index.ts
// åˆ é™¤ç¬¬19è¡Œ
- export * from '../../components/enhanced-step-card/EnhancedStepCard';

// 2. src/components/stepCards/index.ts
// åˆ é™¤ç¬¬7-10è¡Œ
- export { NewStepCard } from './NewStepCard';
- export type { NewStepCardProps } from './NewStepCard';
```

### 5. ActionParams æå–è®¡åˆ’ï¼ˆPhase 2 - éœ€è¦å¼€å‘ï¼‰

#### 5.1 æå–é€šç”¨é…ç½®ç»„ä»¶

```tsx
// æ–°å»º: src/shared/components/CommonExecutionParams.tsx (~80è¡Œ)

export interface CommonExecutionParamsProps {
  value: {
    useSelector: boolean;
    allowAbsolute: boolean;
    confidenceThreshold: number;
    retries: number;
    verifyAfter: boolean;
  };
  onChange: (params: CommonExecutionParamsProps['value']) => void;
}

export const CommonExecutionParams: React.FC<CommonExecutionParamsProps> = ({
  value, onChange
}) => {
  return (
    <Card title="æ‰§è¡Œé…ç½®" size="small">
      <Space direction="vertical">
        <Switch 
          checked={value.useSelector}
          onChange={(checked) => onChange({ ...value, useSelector: checked })}
        >
          é€‰æ‹©å™¨ä¼˜å…ˆ
        </Switch>
        <Switch 
          checked={value.allowAbsolute}
          onChange={(checked) => onChange({ ...value, allowAbsolute: checked })}
        >
          åæ ‡å…œåº•
        </Switch>
        <div>
          <Text>ç½®ä¿¡åº¦é˜ˆå€¼</Text>
          <InputNumber
            value={value.confidenceThreshold}
            min={0.1}
            max={1.0}
            step={0.05}
            onChange={(val) => onChange({ ...value, confidenceThreshold: val || 0.8 })}
          />
        </div>
        <div>
          <Text>é‡è¯•æ¬¡æ•°</Text>
          <InputNumber
            value={value.retries}
            min={0}
            max={5}
            onChange={(val) => onChange({ ...value, retries: val || 0 })}
          />
        </div>
        <Switch 
          checked={value.verifyAfter}
          onChange={(checked) => onChange({ ...value, verifyAfter: checked })}
        >
          æ‰§è¡ŒåéªŒè¯
        </Switch>
      </Space>
    </Card>
  );
};
```

#### 5.2 é›†æˆåˆ° ActionParamsPanel

```tsx
// ä¿®æ”¹: src/components/action-system/ActionParamsPanel.tsx

import { CommonExecutionParams } from '../../shared/components/CommonExecutionParams';

export const ActionParamsPanel: React.FC<Props> = ({ action, onChange }) => {
  const [executionConfig, setExecutionConfig] = useState({
    useSelector: true,
    allowAbsolute: false,
    confidenceThreshold: 0.8,
    retries: 0,
    verifyAfter: false
  });

  return (
    <Space direction="vertical">
      {/* âœ… æ–°å¢ï¼šé€šç”¨æ‰§è¡Œé…ç½® */}
      <CommonExecutionParams
        value={executionConfig}
        onChange={setExecutionConfig}
      />
      
      {/* åŸæœ‰å‚æ•°æ§ä»¶ */}
      {renderTypeSpecificParams()}
      
      {/* CoordinateSelectorç­‰ */}
    </Space>
  );
};
```

#### 5.3 åˆ é™¤ ActionParams å’Œ ActionBar

```bash
# Phase 2 æ‰§è¡Œååˆ é™¤
src/components/stepCards/ActionParams.tsx     # 280è¡Œ
src/components/stepCards/ActionBar.tsx        # 100è¡Œ

# ä¿®æ”¹å¯¼å‡º
src/components/stepCards/index.ts
  - åˆ é™¤: export { ActionParams } from './ActionParams';
  - åˆ é™¤: export type { ActionParamsProps } from './ActionParams';
  - åˆ é™¤: export { ActionBar } from './ActionBar';
  - åˆ é™¤: export type { ActionBarProps } from './ActionBar';
```

### 6. æ‰§è¡Œæ­¥éª¤

#### Phase 1: ç«‹å³å®‰å…¨åˆ é™¤ï¼ˆä½é£é™©ï¼‰

```bash
# æ­¥éª¤1: åˆ é™¤åºŸå¼ƒç»„ä»¶
rm src/components/enhanced-step-card/EnhancedStepCard.tsx
rm src/components/stepCards/NewStepCard.tsx

# æ­¥éª¤2: ä¿®æ”¹å¯¼å‡ºæ–‡ä»¶
# ç¼–è¾‘ src/modules/action-system/index.ts
#   åˆ é™¤ç¬¬19è¡Œ: export * from '../../components/enhanced-step-card/EnhancedStepCard';

# ç¼–è¾‘ src/components/stepCards/index.ts
#   åˆ é™¤ç¬¬7-10è¡Œ: NewStepCardå¯¼å‡º

# æ­¥éª¤3: ç±»å‹æ£€æŸ¥
npm run type-check

# æ­¥éª¤4: Gitæäº¤
git add -A
git commit -m "refactor: åˆ é™¤åºŸå¼ƒçš„EnhancedStepCardå’Œå­¤ç«‹çš„NewStepCard (572è¡Œ)"
```

#### Phase 2: æå–å¹¶é›†æˆï¼ˆéœ€è¦å¼€å‘ï¼‰

```bash
# æ­¥éª¤1: åˆ›å»ºé€šç”¨é…ç½®ç»„ä»¶
# æ–°å»º src/shared/components/CommonExecutionParams.tsx

# æ­¥éª¤2: é›†æˆåˆ° ActionParamsPanel
# ä¿®æ”¹ src/components/action-system/ActionParamsPanel.tsx

# æ­¥éª¤3: åˆ é™¤æ—§ç»„ä»¶
rm src/components/stepCards/ActionParams.tsx
rm src/components/stepCards/ActionBar.tsx

# æ­¥éª¤4: ä¿®æ”¹å¯¼å‡º
# ç¼–è¾‘ src/components/stepCards/index.ts

# æ­¥éª¤5: ç±»å‹æ£€æŸ¥å’Œæµ‹è¯•
npm run type-check

# æ­¥éª¤6: Gitæäº¤
git commit -m "refactor: æå–é€šç”¨æ‰§è¡Œé…ç½®ï¼Œåˆ é™¤ActionParamså’ŒActionBar (380è¡Œ)"
```

### 7. é£é™©è¯„ä¼°

#### Phase 1 é£é™©ï¼ˆæä½ï¼‰

| é£é™©é¡¹ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|------|------|----------|
| åˆ é™¤åºŸå¼ƒç»„ä»¶ç ´åæ„å»º | ä½ | ä½ | ç±»å‹æ£€æŸ¥ |
| åˆ é™¤å­¤ç«‹ç»„ä»¶å½±å“æœªçŸ¥åŠŸèƒ½ | æä½ | ä½ | grepéªŒè¯æ— å¼•ç”¨ |

#### Phase 2 é£é™©ï¼ˆä¸­ï¼‰

| é£é™©é¡¹ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|------|------|----------|
| é€šç”¨é…ç½®æå–ä¸å®Œæ•´ | ä¸­ | ä¸­ | è¯¦ç»†å¯¹æ¯”æ–‡æ¡£ |
| é›†æˆåˆ°ActionParamsPanelç ´åUI | ä½ | ä¸­ | é€æ­¥é›†æˆ+æµ‹è¯• |
| ä¸¢å¤±é…ç½®åŠŸèƒ½ | ä½ | é«˜ | ä¿ç•™æ‰€æœ‰5ä¸ªé…ç½®é¡¹ |

### 8. æ”¶ç›Šè®¡ç®—

#### Phase 1 æ”¶ç›Š

```
åˆ é™¤ä»£ç : 572è¡Œ
ä¿®æ”¹å¯¼å‡º: 2å¤„
å‡€æ”¶ç›Š: ~570è¡Œ
ç»´æŠ¤æˆæœ¬é™ä½: 2ä¸ªåºŸå¼ƒç»„ä»¶
```

#### Phase 2 æ”¶ç›Š

```
æ–°å¢ä»£ç : ~80è¡Œ (CommonExecutionParams)
ä¿®æ”¹ä»£ç : ~50è¡Œ (é›†æˆåˆ°ActionParamsPanel)
åˆ é™¤ä»£ç : 380è¡Œ (ActionParams + ActionBar)
å‡€æ”¶ç›Š: ~250è¡Œ
åŠŸèƒ½å¢å¼º: ActionParamsPanelè·å¾—5ä¸ªé€šç”¨é…ç½®
```

#### æ€»æ”¶ç›Š

```
æ€»åˆ é™¤: 952è¡Œ
æ€»æ–°å¢: ~130è¡Œ
å‡€æ”¶ç›Š: ~820è¡Œ
ç»´æŠ¤æˆæœ¬é™ä½: 4ä¸ªç»„ä»¶
æ¶æ„æ”¹è¿›: é€šç”¨é…ç½®é›†ä¸­ç®¡ç†
```

### 9. ä¿ç•™ç»„ä»¶æ¸…å•

#### å¿…é¡»ä¿ç•™

```
âœ… src/components/action-system/ActionParamsPanel.tsx (836è¡Œ)
   ç†ç”±: ç”Ÿäº§ä½¿ç”¨ï¼Œéœ€è¦å¢å¼º

âœ… src/hooks/useStepCardStateMachine.ts (305è¡Œ)
   ç†ç”±: V3æ¶æ„æ ¸å¿ƒï¼Œæœªæ¥å¯èƒ½è¿ç§»

âœ… src/infrastructure/gateways/StepExecutionGateway.ts
   ç†ç”±: V3æ‰§è¡Œå¼•æ“
```

#### æ–°å¢ç»„ä»¶

```
âœ… src/shared/components/CommonExecutionParams.tsx (~80è¡Œ)
   ç†ç”±: æå–çš„é€šç”¨é…ç½®ç»„ä»¶
```

### 10. éªŒè¯æ£€æŸ¥æ¸…å•

#### Phase 1 éªŒè¯

```
â–¡ EnhancedStepCard.tsx å·²åˆ é™¤
â–¡ NewStepCard.tsx å·²åˆ é™¤
â–¡ action-system/index.ts å¯¼å‡ºå·²æ¸…ç†
â–¡ stepCards/index.ts å¯¼å‡ºå·²æ¸…ç†
â–¡ npm run type-check é€šè¿‡
â–¡ æ— æ„å»ºé”™è¯¯
â–¡ Gitæäº¤å®Œæˆ
```

#### Phase 2 éªŒè¯

```
â–¡ CommonExecutionParams.tsx å·²åˆ›å»º
â–¡ 5ä¸ªé€šç”¨é…ç½®å®Œæ•´å®ç°
â–¡ ActionParamsPanel å·²é›†æˆ
â–¡ ActionParams.tsx å·²åˆ é™¤
â–¡ ActionBar.tsx å·²åˆ é™¤
â–¡ stepCards/index.ts å¯¼å‡ºå·²æ¸…ç†
â–¡ npm run type-check é€šè¿‡
â–¡ UIåŠŸèƒ½æµ‹è¯•é€šè¿‡
â–¡ Gitæäº¤å®Œæˆ
```

---

## ğŸ¯ æ€»ç»“

### ç«‹å³æ‰§è¡Œï¼ˆPhase 1ï¼‰

```bash
åˆ é™¤: EnhancedStepCard.tsx (284è¡Œ) + NewStepCard.tsx (288è¡Œ)
ä¿®æ”¹: 2ä¸ªå¯¼å‡ºæ–‡ä»¶
æ”¶ç›Š: ~570è¡Œ
é£é™©: æä½
```

### åç»­æ‰§è¡Œï¼ˆPhase 2 - éœ€è¦å¼€å‘ï¼‰

```bash
æ–°å¢: CommonExecutionParams.tsx (~80è¡Œ)
ä¿®æ”¹: ActionParamsPanel.tsx (+50è¡Œé›†æˆä»£ç )
åˆ é™¤: ActionParams.tsx (280è¡Œ) + ActionBar.tsx (100è¡Œ)
æ”¶ç›Š: ~250è¡Œ
é£é™©: ä¸­ï¼ˆéœ€è¦æµ‹è¯•ï¼‰
```

### æœ€ç»ˆæˆæœ

```
æ€»åˆ é™¤: 952è¡Œå†—ä½™ä»£ç 
æ€»æ–°å¢: ~130è¡Œé«˜è´¨é‡ä»£ç 
å‡€æ”¶ç›Š: ~820è¡Œ
æ¶æ„æ”¹è¿›: é€šç”¨é…ç½®é›†ä¸­ç®¡ç†ï¼Œæ¶ˆé™¤é‡å¤å®ç°
ç»´æŠ¤æˆæœ¬é™ä½: 4ä¸ªåºŸå¼ƒ/å­¤ç«‹ç»„ä»¶
```
