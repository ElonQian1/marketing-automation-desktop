# 决策链按钮丢失 - 序列化调试指南

## 📋 问题现状

决策链配置按钮（🧠 智能·自动链、🎯 第一个、👆 点击）在保存脚本后重新打开时**完全消失**。

## 🔍 根因分析

经过代码分析发现，问题的根本原因是：

### 1. **组件渲染条件**
`CompactStrategyMenu` 组件的渲染依赖于两个字段：

```typescript
// 在 DraggableStepCard.tsx 第683行
{step.enableStrategySelector && step.strategySelector && (() => {
  // ... 渲染 CompactStrategyMenu
})()}
```

### 2. **字段来源**
这两个字段是步骤对象的**顶级字段**：
- `step.strategySelector` - 包含智能分析结果、候选元素、选中策略等
- `step.enableStrategySelector` - 控制组件是否显示

### 3. **序列化机制**
根据代码分析，这些字段**应该**被保存到 `extensions` 中：

```typescript
// UniversalScriptSerializer.extractOtherFields()
const knownFields = new Set([
  'id', 'step_type', 'type', 'name', 'description', 'enabled', 'order', 'status',
  'parameters', 'params', 'conditions', 'error_handling', 'ui_state',
  'loopId', 'loop_id', 'loopName', 'loop_name', 'loopLevel', 'loop_level',
  'inLoop', 'in_loop', 'parentLoopId', 'parent_loop_id', 'loopConfig', 'loop_config',
  'smartAnalysis', 'smart_analysis'
]);

// strategySelector 和 enableStrategySelector 不在此列表中
// 因此应该被自动提取到 extensions
```

```typescript
// 序列化时
const extensions: Record<string, any> = {};
for (const [key, value] of Object.entries(step)) {
  if (!knownFields.has(key)) {
    extensions[key] = value; // strategySelector 应该在这里被保存
  }
}
```

```typescript
// 反序列化时
if (stepData.extensions) {
  Object.assign(step, stepData.extensions); // 应该恢复 strategySelector
}
```

## 🐛 需要验证的问题

**理论上序列化机制应该能自动保存和恢复这些字段，但实际上没有工作。**

可能的原因：
1. ❓ `strategySelector` 对象太大或包含不可序列化的内容（如函数）
2. ❓ 某个中间环节（后端保存/读取）丢弃了 `extensions` 字段
3. ❓ 序列化器在某些步骤类型下没有保留 `extensions`
4. ❓ 数据库或文件存储限制了字段大小

## 🔬 调试步骤

我已经在序列化器中添加了调试日志，现在需要进行测试：

### 步骤 1：创建包含决策链的步骤

1. 打开应用（确保是最新编译的版本）
2. 创建一个新步骤（tap 或 smart_tap）
3. 点击"智能分析我按钮"触发智能分析
4. 在分析结果中选择一个元素
5. 配置决策链按钮（例如选择"🧠 智能·自动链"模式）
6. **打开浏览器开发者工具的控制台**（F12）

### 步骤 2：保存脚本并观察日志

点击"保存脚本"，然后在控制台中查找以下日志：

```
📋 [DataTransformer] 提取扩展字段（包含决策链相关）: {
  hasStrategySelector: true/false,
  hasEnableStrategySelector: true/false,
  strategySelector: {...},
  enableStrategySelector: true/false,
  extensionsKeys: [...]
}
```

**关键检查点：**
- ✅ `hasStrategySelector` 应该是 `true`
- ✅ `hasEnableStrategySelector` 应该是 `true`
- ✅ `strategySelector` 应该包含数据（不是 `undefined`）
- ✅ `extensionsKeys` 应该包含 `'strategySelector'` 和 `'enableStrategySelector'`

### 步骤 3：重新加载脚本并观察日志

关闭脚本，然后重新打开同一个脚本，查找以下日志：

```
📋 [DataTransformer] 恢复扩展字段（包含决策链相关）: {
  hasStrategySelector: true/false,
  hasEnableStrategySelector: true/false,
  strategySelector: {...},
  enableStrategySelector: true/false,
  stepId: "...",
  stepName: "..."
}
```

**关键检查点：**
- ✅ 这个日志是否出现？
- ✅ `hasStrategySelector` 和 `hasEnableStrategySelector` 是否都是 `true`？
- ✅ `strategySelector` 的数据是否完整？

### 步骤 4：检查步骤对象

在重新加载后，在控制台中手动检查步骤对象：

```javascript
// 获取第一个步骤卡片的数据
const stepCard = document.querySelector('[data-step-id]');
// 或者在 React DevTools 中检查 DraggableStepCard 组件的 props
```

检查：
- `step.enableStrategySelector` 的值
- `step.strategySelector` 的值

## 📊 预期结果

### 场景 A：日志显示字段被正确提取但没有恢复

**症状：**
- 保存时的日志显示 `hasStrategySelector: true`
- 重新加载时**没有**恢复日志
- 或者恢复日志显示 `hasStrategySelector: false`

**结论：** `extensions` 字段在存储或读取过程中丢失了（后端问题）

**解决方案：** 需要检查 Rust 后端的脚本保存/读取逻辑

### 场景 B：日志显示字段被提取和恢复，但组件仍然不显示

**症状：**
- 保存时的日志显示 `hasStrategySelector: true`
- 重新加载时的日志也显示 `hasStrategySelector: true`
- 但按钮仍然不显示

**结论：** 数据被正确保存和恢复，但有其他问题（可能是数据结构变化、组件状态等）

**解决方案：** 需要进一步检查：
1. 恢复的 `strategySelector` 数据结构是否正确
2. `DraggableStepCard` 的渲染逻辑是否有其他阻塞条件

### 场景 C：日志根本不出现

**症状：**
- 保存和重新加载时都没有看到任何相关日志

**结论：** 
1. 步骤根本没有 `strategySelector` 字段（上游问题）
2. 或者序列化器没有被正确调用

**解决方案：** 检查 `CompactStrategyMenu` 是否真的设置了这些字段

## 🎯 下一步

请按照上述步骤进行测试，并将以下信息反馈给我：

1. **保存时的日志输出**（完整的 JSON 对象）
2. **重新加载时的日志输出**（完整的 JSON 对象）
3. **按钮是否显示**
4. **任何其他相关的错误或警告**

根据你提供的日志，我将能够准确定位问题并提供针对性的修复方案。

## 🔧 临时解决方案

在调试期间，如果需要紧急使用，可以：

1. **不要关闭脚本** - 在当前会话中继续编辑
2. **使用浏览器的"不要刷新"** - 避免丢失内存中的数据
3. **导出脚本JSON** - 手动备份配置

---

**重要提示：** 调试日志已经添加到代码中，但需要重新编译才能生效。如果项目正在热重载运行，只需等待自动编译完成即可。
