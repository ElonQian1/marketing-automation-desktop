# æ™ºèƒ½æ»šåŠ¨å‚æ•°å®æ—¶æ›´æ–°ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨æ™ºèƒ½è„šæœ¬æ„å»ºå™¨ä¸­ï¼Œæ™ºèƒ½æ»šåŠ¨æ­¥éª¤çš„å‚æ•°é…ç½®é¢æ¿èƒ½å¤Ÿæ­£ç¡®åˆ‡æ¢æ–¹å‘ï¼ˆå‘ä¸Š/å‘ä¸‹/å‘å·¦/å‘å³ï¼‰ã€è·ç¦»ã€æ—¶é•¿ç­‰å‚æ•°ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **æµ‹è¯•æŒ‰é’®é—®é¢˜**ï¼šç‚¹å‡»å¡ç‰‡ä¸Šçš„"æµ‹è¯•"æŒ‰é’®æ—¶ï¼Œæ‰§è¡Œçš„è¿˜æ˜¯åˆå§‹åŒ–æ—¶çš„å‚æ•°ï¼ˆé€šå¸¸æ˜¯å‘ä¸‹æ»šåŠ¨ï¼‰
2. **æ‰§è¡Œè„šæœ¬æ­£å¸¸**ï¼šç‚¹å‡»"æ‰§è¡Œè„šæœ¬"æŒ‰é’®æ—¶ï¼Œèƒ½å¤Ÿè·å–åˆ°æ­£ç¡®çš„æ›´æ–°åå‚æ•°
3. **å‚æ•°ä¸åŒæ­¥**ï¼šè¯´æ˜å‚æ•°é…ç½®é¢æ¿çš„å®æ—¶æ›´æ–°æ²¡æœ‰æ­£ç¡®ä¼ é€’åˆ°æ­¥éª¤å¯¹è±¡ä¸­

## ğŸ” æ ¹å› åˆ†æ

é€šè¿‡ä»£ç åˆ†æï¼Œå‘ç°äº†å‚æ•°ä¼ é€’é“¾è·¯ä¸­çš„å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

### 1. ActionParamsPanel å¾ªç¯ä¾èµ–é—®é¢˜

**ä½ç½®**ï¼š`src/components/action-system/ActionParamsPanel.tsx`

**é—®é¢˜**ï¼š
- `useEffect` ä¸­çš„å‚æ•°åŒæ­¥é€»è¾‘å¯èƒ½é€ æˆå¾ªç¯ä¾èµ–
- ç¼ºå°‘å‚æ•°å˜åŒ–çš„çœŸå®æ€§æ£€æµ‹ï¼Œå¯¼è‡´ä¸å¿…è¦çš„æ›´æ–°

### 2. DraggableStepCard actionType è®¡ç®—é—®é¢˜

**ä½ç½®**ï¼š`src/components/DraggableStepCard.tsx`

**é—®é¢˜**ï¼š
- `actionType` è®¡ç®—æ—¶ä½¿ç”¨ç©ºå‚æ•°å¯¹è±¡ `{}`ï¼Œå¯¼è‡´å‚æ•°é…ç½®é¢æ¿æ— æ³•è·å–å½“å‰å€¼
- ç¼ºå°‘ `step.parameters` ä¾èµ–ï¼Œå‚æ•°å˜åŒ–æ—¶ä¸ä¼šé‡æ–°è®¡ç®—

### 3. å‚æ•°ä¼ é€’é“¾è·¯ç¼ºå¤±

**ä½ç½®**ï¼š`src/pages/SmartScriptBuilderPage/components/StepListPanel.tsx` å’Œ `src/components/EnhancedDraggableStepsContainer.tsx`

**é—®é¢˜**ï¼š
- `StepListPanel` ä¸­ç¼ºå°‘ `handleUpdateStepParameters` å‡½æ•°
- `EnhancedDraggableStepsContainer` æ¥å£ä¸­ç¼ºå°‘ `onUpdateStepParameters` å±æ€§
- å‚æ•°æ›´æ–°å›è°ƒæ²¡æœ‰æ­£ç¡®ä¼ é€’åˆ°ç»„ä»¶é“¾ä¸­

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¼˜åŒ– ActionParamsPanel å‚æ•°åŒæ­¥æœºåˆ¶

```typescript
// ğŸ”„ ä½¿ç”¨ useRef æ¥è·Ÿè¸ªä¸Šæ¬¡çš„å¤–éƒ¨å‚æ•°ï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°
const lastExternalParamsRef = React.useRef<ActionParams>({});

// ğŸ”„ åŒæ­¥å¤–éƒ¨å‚æ•°å˜åŒ–åˆ°å†…éƒ¨çŠ¶æ€ï¼ˆä¼˜åŒ–ï¼šé¿å…å¾ªç¯ä¾èµ–ï¼‰
React.useEffect(() => {
  const externalParams = initialParams || action.params || {};
  const lastParams = lastExternalParamsRef.current;
  
  // åªæœ‰å½“å¤–éƒ¨å‚æ•°çœŸæ­£å‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°å†…éƒ¨çŠ¶æ€
  const hasRealChange = JSON.stringify(externalParams) !== JSON.stringify(lastParams);
  if (hasRealChange) {
    console.log('ğŸ”„ [ActionParamsPanel] å¤–éƒ¨å‚æ•°å˜åŒ–ï¼ŒåŒæ­¥åˆ°å†…éƒ¨çŠ¶æ€:', {
      action: action.type,
      oldParams: lastParams,
      newParams: externalParams
    });
    setParams(externalParams);
    lastExternalParamsRef.current = externalParams;
  }
}, [initialParams, action.params, action.type]);
```

### 2. ä¿®å¤ DraggableStepCard actionType è®¡ç®—

```typescript
const mappedType = typeMapping[step.step_type];
if (mappedType) {
  return {
    type: mappedType,
    params: step.parameters as ActionParams // ğŸ”‘ ä½¿ç”¨å®é™…å‚æ•°ï¼Œç¡®ä¿å‚æ•°é…ç½®é¢æ¿èƒ½è·å–åˆ°å½“å‰å€¼
  };
}
return null;
}, [step.step_type, step.parameters]); // ğŸ”‘ æ·»åŠ step.parametersä¾èµ–ï¼Œç¡®ä¿å‚æ•°å˜åŒ–æ—¶é‡æ–°è®¡ç®—
```

### 3. å®Œå–„å‚æ•°ä¼ é€’é“¾è·¯

#### 3.1 StepListPanel ä¸­æ·»åŠ å‚æ•°æ›´æ–°å¤„ç†

```typescript
// ğŸ”‘ å…³é”®ä¿®å¤ï¼šæ›´æ–°æ­¥éª¤å‚æ•°
const handleUpdateStepParameters = (stepId: string, parameters: Record<string, unknown>) => {
  console.log('ğŸ”„ [StepListPanel] æ›´æ–°æ­¥éª¤å‚æ•°:', { stepId, parameters });
  setSteps(prev => prev.map(s => (s.id === stepId ? { ...s, parameters } : s)));
};
```

#### 3.2 EnhancedDraggableStepsContainer æ¥å£æ‰©å±•

```typescript
export interface EnhancedDraggableStepsContainerProps {
  // ... å…¶ä»–å±æ€§
  /** ğŸ”‘ æ­¥éª¤å‚æ•°æ›´æ–°å›è°ƒ */
  onUpdateStepParameters?: (stepId: string, parameters: Record<string, unknown>) => void;
}
```

#### 3.3 å‚æ•°æ›´æ–°å›è°ƒä¼ é€’

```typescript
// EnhancedDraggableStepsContainer ä¸­ä¼˜å…ˆä½¿ç”¨å¤–éƒ¨å›è°ƒ
const handleUpdateStepParameters = (stepId: string, parameters: any) => {
  console.log('ğŸ”„ [EnhancedContainer] å¤„ç†æ­¥éª¤å‚æ•°æ›´æ–°:', { stepId, parameters });
  
  // ä¼˜å…ˆä½¿ç”¨å¤–éƒ¨ä¼ å…¥çš„å›è°ƒ
  if (onUpdateStepParameters) {
    onUpdateStepParameters(stepId, parameters);
    return;
  }

  // å…œåº•ï¼šå†…éƒ¨å¤„ç†é€»è¾‘
  // ... åŸæœ‰é€»è¾‘
};
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### å‚æ•°ä¼ é€’é“¾è·¯

```
ActionParamsPanel (å‚æ•°é…ç½®)
    â†“ onChange(updatedParams)
DraggableStepCard (handleParametersChange)
    â†“ onUpdateStepParameters(stepId, params)
DraggableStepsContainer (ä¼ é€’å›è°ƒ)
    â†“ onUpdateStepParameters
EnhancedDraggableStepsContainer (å¤„ç†æ›´æ–°)
    â†“ onUpdateStepParameters(stepId, parameters)
StepListPanel (handleUpdateStepParameters)
    â†“ setSteps(æ›´æ–°æ­¥éª¤å‚æ•°)
SmartScriptBuilder (æ­¥éª¤çŠ¶æ€ç®¡ç†)
```

### é¢„æœŸæ”¹è¿›

1. **æµ‹è¯•æŒ‰é’®åŒæ­¥**ï¼šç‚¹å‡»æµ‹è¯•æŒ‰é’®æ—¶èƒ½å¤Ÿä½¿ç”¨æœ€æ–°çš„å‚æ•°é…ç½®
2. **å®æ—¶åé¦ˆ**ï¼šå‚æ•°é…ç½®é¢æ¿çš„æ›´æ”¹èƒ½å¤Ÿç«‹å³åæ˜ åˆ°æ­¥éª¤å¯¹è±¡ä¸­
3. **ä¸€è‡´æ€§ä¿è¯**ï¼šæµ‹è¯•æŒ‰é’®å’Œæ‰§è¡Œè„šæœ¬ä½¿ç”¨ç›¸åŒçš„å‚æ•°æº

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `src/components/action-system/ActionParamsPanel.tsx` - å‚æ•°é…ç½®é¢æ¿
- `src/components/DraggableStepCard.tsx` - æ­¥éª¤å¡ç‰‡ç»„ä»¶
- `src/components/EnhancedDraggableStepsContainer.tsx` - å¢å¼ºæ­¥éª¤å®¹å™¨
- `src/pages/SmartScriptBuilderPage/components/StepListPanel.tsx` - æ­¥éª¤åˆ—è¡¨é¢æ¿
- `src/components/StepTestButton.tsx` - æµ‹è¯•æŒ‰é’®ç»„ä»¶

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºæ™ºèƒ½æ»šåŠ¨æ­¥éª¤**
   - æ·»åŠ ä¸€ä¸ªæ™ºèƒ½æ»šåŠ¨æ­¥éª¤ï¼ˆé»˜è®¤å‘ä¸‹æ»šåŠ¨ï¼‰
   
2. **ä¿®æ”¹å‚æ•°é…ç½®**
   - æ‰“å¼€å‚æ•°é…ç½®é¢æ¿
   - åˆ‡æ¢æ»šåŠ¨æ–¹å‘ï¼ˆå¦‚æ”¹ä¸ºå‘ä¸Šï¼‰
   - ä¿®æ”¹è·ç¦»å’Œæ—¶é•¿å‚æ•°
   
3. **éªŒè¯æµ‹è¯•æŒ‰é’®**
   - ç‚¹å‡»æ­¥éª¤å¡ç‰‡ä¸Šçš„"æµ‹è¯•"æŒ‰é’®
   - ç¡®è®¤æ‰§è¡Œçš„æ˜¯ä¿®æ”¹åçš„å‚æ•°ï¼ˆå‘ä¸Šæ»šåŠ¨ï¼‰
   
4. **éªŒè¯æ‰§è¡Œè„šæœ¬**
   - ç‚¹å‡»"æ‰§è¡Œè„šæœ¬"æŒ‰é’®
   - ç¡®è®¤æ‰§è¡Œçš„å‚æ•°ä¸æµ‹è¯•æŒ‰é’®ä¸€è‡´

### æœŸæœ›ç»“æœ

- âœ… æµ‹è¯•æŒ‰é’®ä½¿ç”¨å®æ—¶æ›´æ–°çš„å‚æ•°
- âœ… æ‰§è¡Œè„šæœ¬ä½¿ç”¨å®æ—¶æ›´æ–°çš„å‚æ•°  
- âœ… å‚æ•°é…ç½®é¢æ¿çš„æ›´æ”¹ç«‹å³ç”Ÿæ•ˆ
- âœ… æ§åˆ¶å°æ˜¾ç¤ºå‚æ•°æ›´æ–°æ—¥å¿—

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è°ƒè¯•æ—¥å¿—**ï¼šå¢åŠ äº†å‚æ•°æ›´æ–°çš„æ§åˆ¶å°æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•å’ŒéªŒè¯
2. **å‘åå…¼å®¹**ï¼šæ‰€æœ‰ä¿®æ”¹éƒ½ä¿æŒå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„å‚æ•°æ›´æ–°å’Œé‡å¤æ¸²æŸ“

## ï¿½ æ‰§è¡Œæ¬¡æ•°å‚æ•°ä¿®å¤è¡¥å……ï¼ˆ2025å¹´10æœˆ29æ—¥ï¼‰

### ğŸ› æ–°å‘ç°çš„é—®é¢˜

ç”¨æˆ·åé¦ˆï¼šåœ¨å‘ä¸‹æ»šåŠ¨å‚æ•°é…ç½®ä¸­è®¾ç½®äº†æ‰§è¡Œæ¬¡æ•°ä¸º2æ¬¡ï¼Œä½†ç‚¹å‡»æµ‹è¯•æŒ‰é’®åªæ‰§è¡Œäº†1æ¬¡ï¼ˆåˆå§‹åŒ–é»˜è®¤å€¼ï¼‰ã€‚

### ğŸ” æ ¹å› åˆ†æ

é€šè¿‡è¿›ä¸€æ­¥è°ƒè¯•å‘ç°äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

#### 1. normalizeStepForExecution å‚æ•°ä¸¢å¤±

**ä½ç½®**ï¼š`src/hooks/singleStepTest/utils.ts`

**é—®é¢˜**ï¼šæ™ºèƒ½æ»šåŠ¨è½¬æ¢ä¸º swipe æ—¶ï¼Œåªä¿ç•™äº†åæ ‡å’Œæ—¶é•¿å‚æ•°ï¼Œä¸¢å¤±äº† `repeat_count`ã€`wait_between`ã€`wait_duration` ç­‰é‡è¦å‚æ•°ã€‚

**ä¿®å¤å‰**ï¼š
```typescript
parameters: {
  ...p,
  start_x, start_y, end_x, end_y,
  duration: speed > 0 ? speed : 300,
},
```

**ä¿®å¤å**ï¼š
```typescript
parameters: {
  ...p, // ğŸ”‘ å…³é”®ä¿®å¤ï¼šä¿ç•™æ‰€æœ‰åŸå§‹å‚æ•°
  start_x, start_y, end_x, end_y,
  duration: speed > 0 ? speed : 300,
  // ğŸ”‘ ç¡®ä¿é‡è¦å‚æ•°è¢«ä¿ç•™
  repeat_count: p.repeat_count || 1,
  wait_between: p.wait_between || false,
  wait_duration: p.wait_duration || 500,
},
```

#### 2. V2æµ‹è¯•ç³»ç»Ÿç¼ºå°‘é‡å¤æ‰§è¡Œæ”¯æŒ

**ä½ç½®**ï¼š`src/hooks/useV2StepTest.ts`

**é—®é¢˜**ï¼šV2æµ‹è¯•ç³»ç»Ÿæ²¡æœ‰å¤„ç† `repeat_count` å‚æ•°ï¼Œå§‹ç»ˆåªæ‰§è¡Œä¸€æ¬¡ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `executeStep` å‡½æ•°ä¸­æ·»åŠ é‡å¤æ‰§è¡Œé€»è¾‘ï¼š

```typescript
// ğŸ”‘ è·å–é‡å¤æ‰§è¡Œå‚æ•°
const params = step.parameters || {};
const repeatCount = Number(params.repeat_count) || 1;
const waitBetween = params.wait_between === true;
const waitDuration = Number(params.wait_duration) || 500;

// ğŸ”„ é‡å¤æ‰§è¡Œé€»è¾‘
for (let i = 0; i < repeatCount; i++) {
  console.log(`ğŸ”„ [V2æµ‹è¯•] æ‰§è¡Œç¬¬ ${i + 1}/${repeatCount} æ¬¡`);
  
  // æ‰§è¡Œæ­¥éª¤
  const response = await gateway.executeStep(request);
  lastResponse = response;

  // å¦‚æœéœ€è¦é—´éš”ç­‰å¾…ä¸”ä¸æ˜¯æœ€åä¸€æ¬¡
  if (waitBetween && i < repeatCount - 1) {
    await new Promise(resolve => setTimeout(resolve, waitDuration));
  }
}
```

### ğŸ”§ ä¿®å¤æ•ˆæœ

#### åŠŸèƒ½å¢å¼º

1. **å‚æ•°å®Œæ•´ä¿ç•™**ï¼šæ™ºèƒ½æ»šåŠ¨æ ‡å‡†åŒ–è¿‡ç¨‹ä¸­ä¸å†ä¸¢å¤±é‡å¤æ‰§è¡Œå‚æ•°
2. **é‡å¤æ‰§è¡Œæ”¯æŒ**ï¼šæµ‹è¯•æŒ‰é’®ç°åœ¨èƒ½å¤Ÿæ ¹æ®é…ç½®æ‰§è¡Œå¤šæ¬¡
3. **é—´éš”ç­‰å¾…æ”¯æŒ**ï¼šæ”¯æŒæ¯æ¬¡æ‰§è¡Œä¹‹é—´çš„ç­‰å¾…é—´éš”
4. **è¯¦ç»†æ—¥å¿—**ï¼šæä¾›æ¯æ¬¡æ‰§è¡Œçš„è¯¦ç»†æ—¥å¿—åé¦ˆ

#### ç”¨æˆ·ä½“éªŒ

- âœ… è®¾ç½®æ‰§è¡Œæ¬¡æ•°ä¸º2æ¬¡ï¼Œæµ‹è¯•æŒ‰é’®æ‰§è¡Œ2æ¬¡
- âœ… å¯ç”¨é—´éš”ç­‰å¾…ï¼Œæ¯æ¬¡æ‰§è¡Œä¹‹é—´æœ‰å»¶è¿Ÿ
- âœ… æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„æ‰§è¡Œè¿›åº¦æ—¥å¿—
- âœ… æµ‹è¯•ç»“æœåŒ…å«æ‰€æœ‰æ‰§è¡Œæ¬¡æ•°çš„ä¿¡æ¯

### ğŸ“Š æµ‹è¯•éªŒè¯æ›´æ–°

#### æ–°å¢æµ‹è¯•æ­¥éª¤

5. **éªŒè¯æ‰§è¡Œæ¬¡æ•°**
   - è®¾ç½®æ‰§è¡Œæ¬¡æ•°ä¸º2æ¬¡æˆ–3æ¬¡
   - ç‚¹å‡»æµ‹è¯•æŒ‰é’®
   - ç¡®è®¤å®é™…æ‰§è¡Œäº†è®¾å®šçš„æ¬¡æ•°
   
6. **éªŒè¯é—´éš”ç­‰å¾…**
   - å¯ç”¨"æ¯æ¬¡æ‰§è¡Œé—´éš”ç­‰å¾…"
   - è®¾ç½®é—´éš”æ—¶é•¿ï¼ˆå¦‚1000msï¼‰
   - è§‚å¯Ÿæ¯æ¬¡æ‰§è¡Œä¹‹é—´æ˜¯å¦æœ‰ç­‰å¾…

#### æœŸæœ›ç»“æœæ›´æ–°

- âœ… æµ‹è¯•æŒ‰é’®æŒ‰é…ç½®çš„æ¬¡æ•°é‡å¤æ‰§è¡Œ
- âœ… é—´éš”ç­‰å¾…åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æ§åˆ¶å°æ˜¾ç¤ºæ‰§è¡Œè¿›åº¦å’Œæ—¥å¿—
- âœ… æµ‹è¯•ç»“æœæ¶ˆæ¯åŒ…å«æ‰§è¡Œæ¬¡æ•°ä¿¡æ¯

### ğŸ”— ä¿®æ”¹æ–‡ä»¶è¡¥å……

- `src/hooks/singleStepTest/utils.ts` - å‚æ•°æ ‡å‡†åŒ–å‡½æ•°
- `src/hooks/useV2StepTest.ts` - V2æµ‹è¯•æ‰§è¡Œé€»è¾‘

## ğŸ¯ æ€»ç»“

æ­¤æ¬¡ä¿®å¤è§£å†³äº†æ™ºèƒ½æ»šåŠ¨æ­¥éª¤å‚æ•°é…ç½®å®æ—¶æ›´æ–°çš„é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š

1. **å‚æ•°å®æ—¶åŒæ­¥**ï¼šç¡®ä¿äº†æµ‹è¯•æŒ‰é’®å’Œæ‰§è¡Œè„šæœ¬ä½¿ç”¨ç›¸åŒçš„å‚æ•°æº
2. **æ‰§è¡Œæ¬¡æ•°æ”¯æŒ**ï¼šä¿®å¤äº†é‡å¤æ‰§è¡Œå‚æ•°è¢«å¿½ç•¥çš„é—®é¢˜
3. **å®Œæ•´åŠŸèƒ½è¦†ç›–**ï¼šæ”¯æŒæ–¹å‘ã€è·ç¦»ã€æ—¶é•¿ã€æ‰§è¡Œæ¬¡æ•°ã€é—´éš”ç­‰å¾…ç­‰æ‰€æœ‰å‚æ•°

é€šè¿‡ä¼˜åŒ–å‚æ•°ä¼ é€’é“¾è·¯ã€åŒæ­¥æœºåˆ¶å’Œæ‰§è¡Œé€»è¾‘ï¼Œå…¨é¢æå‡äº†ç”¨æˆ·ä½“éªŒå’ŒåŠŸèƒ½çš„ä¸€è‡´æ€§ã€‚ç°åœ¨ç”¨æˆ·å¯ä»¥ï¼š
- å®æ—¶ä¿®æ”¹æ»šåŠ¨å‚æ•°å¹¶ç«‹å³åœ¨æµ‹è¯•ä¸­ç”Ÿæ•ˆ
- é…ç½®å¤šæ¬¡æ‰§è¡Œå’Œé—´éš”ç­‰å¾…
- è·å¾—è¯¦ç»†çš„æ‰§è¡Œåé¦ˆå’Œæ—¥å¿—ä¿¡æ¯