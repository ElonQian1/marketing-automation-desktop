# 🚀 循环卡片自动角色切换 - 快速测试指南

## 📍 当前状态

✅ **功能已实现并集成**：
- 循环拖拽管理器已添加到 `DraggableStepsContainer`
- 自动角色切换逻辑已实现
- 调试日志已启用
- 测试页面已创建并集成到应用菜单

## 🧪 立即测试步骤

### 方法 1：使用专门的测试页面（推荐）

1. **启动应用**：
   ```bash
   npm run tauri dev
   ```

2. **打开测试页面**：
   - 在左侧菜单中找到 **"🔄 循环卡片拖拽测试"**
   - 点击进入专门的测试页面

3. **执行测试**：
   
   **测试 A：手动触发角色切换**
   - 点击 **"手动颠倒循环顺序（触发自动修复）"** 按钮
   - 观察循环卡片是否自动交换角色
   - 查看调试日志区域的实时输出

   **测试 B：拖拽测试**
   - 拖拽 **"循环结束"** 卡片到 **"循环开始"** 卡片前面
   - 观察是否自动交换角色：结束→开始，开始→结束
   - 查看状态面板和调试日志

4. **验证结果**：
   - ✅ **状态面板**显示正确的循环顺序
   - ✅ **调试日志**显示处理过程
   - ✅ **卡片**显示正确的角色（开始/结束）

### 方法 2：在实际脚本构建器中测试

1. **创建循环**：
   - 进入 **"智能脚本构建器"**
   - 点击 **"创建循环"** 按钮

2. **拖拽测试**：
   - 拖拽循环结束卡片到开始卡片前面
   - 观察自动角色切换

## 🔍 预期行为

### 成功的标志：

1. **调试日志输出**：
   ```
   🔄 [DraggableStepsContainer] 循环步骤数据: {...}
   🎯 [DragEnd] 拖拽完成: {...}
   🔄 [DragEnd] 循环步骤被拖拽，启动角色切换检查...
   🔄 [LoopDragManager] checkAndSwitchRoles 被调用
   🔄 [LoopDragManager] 检测到需要角色切换: [...]
   ```

2. **视觉变化**：
   - 原 "循环结束" 卡片显示为 "循环开始"
   - 原 "循环开始" 卡片显示为 "循环结束"
   - 卡片图标和样式正确更新

3. **状态同步**：
   - 两个卡片的执行状态保持联动
   - 开始测试时，两个卡片都显示运行状态

## 🐛 如果没有效果，检查这些：

### 1. 检查浏览器控制台

打开开发者工具，查看是否有：
- ✅ 调试日志输出（如上所示）
- ❌ 错误信息或异常

### 2. 验证数据结构

在控制台中执行：
```javascript
// 查看当前步骤数据
console.log('当前步骤:', window.steps);

// 查看循环配对
console.log('循环配对:', window.loopPairs);
```

### 3. 检查是否正确触发

确认：
- 拖拽的确实是循环步骤（step_type: 'loop_start' 或 'loop_end'）
- 两个循环步骤有相同的 loop_id
- 拖拽导致了位置变化（结束步骤在开始步骤前面）

### 4. 手动验证逻辑

在控制台中执行：
```javascript
// 导入服务
import { LoopPairingService } from './src/modules/loop-control/domain/loop-pairing-service';
import { LoopRoleSwitchService } from './src/modules/loop-control/domain/loop-role-switch-service';

// 测试配对查找
const pairs = LoopPairingService.findAllPairs(yourSteps);
console.log('找到的循环配对:', pairs);

// 测试角色切换
const result = LoopRoleSwitchService.autoSwitchRoles(yourSteps);
console.log('角色切换结果:', result);
```

## 🎯 问题排查清单

- [ ] 应用是否正常启动？
- [ ] 测试页面是否正常显示？
- [ ] 能否看到循环开始和结束卡片？
- [ ] 拖拽是否正常工作？
- [ ] 浏览器控制台是否有调试日志？
- [ ] 浏览器控制台是否有错误信息？
- [ ] 循环卡片是否有相同的 loop_id？

## 📞 下一步行动

**如果测试成功** ✅：
- 可以关闭调试日志（将 debug: true 改为 debug: false）
- 开始在实际场景中使用功能
- 进行更复杂的多循环测试

**如果测试失败** ❌：
- 提供控制台截图和错误信息
- 说明具体的操作步骤和期望行为
- 描述实际看到的行为

---

## 🔧 代码修改总结

为了解决你提到的问题，我已经：

1. ✅ **增强了调试能力**：添加详细的日志输出
2. ✅ **创建了专门的测试页面**：可以独立验证功能
3. ✅ **优化了拖拽触发逻辑**：只对循环步骤执行角色切换
4. ✅ **集成到开发菜单**：方便快速访问和测试

现在你可以准确地看到功能是否正常工作，以及在哪个环节出现了问题！