# 卡片保存后样式丢失问题 - 诊断指南

## 🔍 问题现象

**用户报告**：所有卡片保存后重新加载，都变成错误的样子

### 具体表现

**保存前**：
- ⚙️ 参数配置按钮高亮
- 完整的参数配置面板（滑动方向、距离、时长等）
- 类型显示正确：`smart_scroll`

**加载后**：
- ❌ ⚙️ 参数配置按钮消失
- ❌ 参数配置面板消失
- ❌ 类型变成：`unknown`
- ❌ 坐标错误

---

## 📊 根因分析

### 1. JSON 文件检查结果

查看最新保存的脚本文件 `script_1761818935588.json`：

```json
{
  "id": "step_scroll_1761818831155_387",
  "step_type": "unknown",  // ❌ 错误！应该是 "smart_scroll"
  "name": "屏幕交互 - 智能滚动",
  "parameters": {
    "direction": "down",
    "distance": 600,
    // ... 其他参数
  },
  "enabled": true,
  "order": 1
  // ❌ 缺少 ui_state 字段！
}
```

### 2. 关键问题

1. **`step_type` 丢失**：
   - 创建时是 `'smart_scroll'`
   - 保存后变成 `'unknown'`

2. **`ui_state` 丢失**：
   - 缺少 `ui_state.showParams` 字段
   - 导致参数面板状态丢失

3. **坐标信息可能丢失**

---

## 🧪 诊断步骤

### 步骤 1：验证序列化日志

**操作**：创建滚动卡片 → 保存脚本

**查看控制台**，应该看到：
```
📝 [StepSerializer] 序列化步骤: {
  stepId: "step_scroll_xxx",
  stepName: "屏幕交互 - 智能滚动",
  originalStepType: "smart_scroll",  // 检查这个是否正确
  hasParameters: true,
  parametersKeys: [...]
}
```

**如果 `originalStepType` 是 `undefined` 或 `unknown`**：
- 说明步骤对象本身的 `step_type` 或 `type` 字段就是错误的
- 需要检查步骤创建逻辑

### 步骤 2：检查步骤对象

在保存前，打开浏览器控制台执行：

```javascript
// 获取当前所有步骤
const steps = useStepStore.getState().steps;
console.log('当前步骤:', steps);

// 检查第一个步骤
console.log('第一个步骤详情:', JSON.stringify(steps[0], null, 2));
```

**检查输出**：
```javascript
{
  "id": "step_scroll_xxx",
  "step_type": "???",  // 检查这个值
  "type": "???",        // 检查这个值
  "name": "屏幕交互 - 智能滚动",
  "ui_state": {  // 检查是否存在
    "showParams": true
  },
  "parameters": {
    "direction": "down",
    "start_x": 540,  // 检查坐标是否存在
    "start_y": 1260
  }
}
```

### 步骤 3：检查 Store 数据源

可能存在多个 Store，需要确认保存时使用的是哪个：

```javascript
// 可能的 Store
console.log('useStepStore:', useStepStore.getState().steps);
console.log('useStepCardStore:', useStepCardStore.getState().steps);
```

---

## 🔧 可能的修复方向

### 方向 1：步骤创建时 `step_type` 未设置

**文件**：`src/components/step-card/screen-actions/screenTemplates.ts`

**检查**：
```typescript
export function createScrollStepTemplate(direction: ScrollDirection, overrides?: Record<string, any>): ExtendedSmartScriptStep {
  return {
    id: genId('step_scroll'),
    step_type: 'smart_scroll', // ✅ 确认这行存在
    name: `屏幕交互 - 智能滚动`,
    // ...
  };
}
```

### 方向 2：序列化时 `step_type` 被覆盖

**文件**：`src/modules/smart-script-management/utils/serializer.ts`

**检查** `serializeStep` 方法：
```typescript
const originalStepType = step.step_type || step.type;

// 如果 step.step_type 和 step.type 都是 undefined
// originalStepType 就会是 undefined
// 然后被序列化为 "unknown"
```

**可能原因**：
- 传入的 `step` 对象的 `step_type` 字段丢失
- 可能在某个中间步骤被转换或复制时丢失

### 方向 3：UI 状态未保存到 `ui_state`

**需要检查**：
1. `DraggableStepCard` 中的 `showParams` 状态是否保存到 step 对象
2. 序列化器是否正确保存 `ui_state`

---

## 💡 临时解决方案

在修复前，可以手动修改保存的 JSON 文件：

1. 打开 `src-tauri/data/scripts/script_xxx.json`
2. 修改每个步骤的 `step_type`：
   ```json
   {
     "step_type": "smart_scroll",  // 手动改为正确的类型
     "ui_state": {  // 手动添加 UI 状态
       "showParams": true
     }
   }
   ```
3. 保存文件
4. 重新打开脚本

---

## 🎯 下一步行动

**立即测试**：
1. 创建一个滚动卡片
2. 打开浏览器控制台
3. 执行上述诊断命令
4. 保存脚本
5. 查看序列化日志
6. **截图或复制控制台的完整输出**

**提供给我**：
- 序列化日志
- 步骤对象的完整 JSON
- 保存的脚本文件内容

这样我就能定位到具体是哪个环节出了问题！
