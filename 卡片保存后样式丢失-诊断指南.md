# å¡ç‰‡ä¿å­˜åæ ·å¼ä¸¢å¤±é—®é¢˜ - è¯Šæ–­æŒ‡å—

## ğŸ” é—®é¢˜ç°è±¡

**ç”¨æˆ·æŠ¥å‘Š**ï¼šæ‰€æœ‰å¡ç‰‡ä¿å­˜åé‡æ–°åŠ è½½ï¼Œéƒ½å˜æˆé”™è¯¯çš„æ ·å­

### å…·ä½“è¡¨ç°

**ä¿å­˜å‰**ï¼š
- âš™ï¸ å‚æ•°é…ç½®æŒ‰é’®é«˜äº®
- å®Œæ•´çš„å‚æ•°é…ç½®é¢æ¿ï¼ˆæ»‘åŠ¨æ–¹å‘ã€è·ç¦»ã€æ—¶é•¿ç­‰ï¼‰
- ç±»å‹æ˜¾ç¤ºæ­£ç¡®ï¼š`smart_scroll`

**åŠ è½½å**ï¼š
- âŒ âš™ï¸ å‚æ•°é…ç½®æŒ‰é’®æ¶ˆå¤±
- âŒ å‚æ•°é…ç½®é¢æ¿æ¶ˆå¤±
- âŒ ç±»å‹å˜æˆï¼š`unknown`
- âŒ åæ ‡é”™è¯¯

---

## ğŸ“Š æ ¹å› åˆ†æ

### 1. JSON æ–‡ä»¶æ£€æŸ¥ç»“æœ

æŸ¥çœ‹æœ€æ–°ä¿å­˜çš„è„šæœ¬æ–‡ä»¶ `script_1761818935588.json`ï¼š

```json
{
  "id": "step_scroll_1761818831155_387",
  "step_type": "unknown",  // âŒ é”™è¯¯ï¼åº”è¯¥æ˜¯ "smart_scroll"
  "name": "å±å¹•äº¤äº’ - æ™ºèƒ½æ»šåŠ¨",
  "parameters": {
    "direction": "down",
    "distance": 600,
    // ... å…¶ä»–å‚æ•°
  },
  "enabled": true,
  "order": 1
  // âŒ ç¼ºå°‘ ui_state å­—æ®µï¼
}
```

### 2. å…³é”®é—®é¢˜

1. **`step_type` ä¸¢å¤±**ï¼š
   - åˆ›å»ºæ—¶æ˜¯ `'smart_scroll'`
   - ä¿å­˜åå˜æˆ `'unknown'`

2. **`ui_state` ä¸¢å¤±**ï¼š
   - ç¼ºå°‘ `ui_state.showParams` å­—æ®µ
   - å¯¼è‡´å‚æ•°é¢æ¿çŠ¶æ€ä¸¢å¤±

3. **åæ ‡ä¿¡æ¯å¯èƒ½ä¸¢å¤±**

---

## ğŸ§ª è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1ï¼šéªŒè¯åºåˆ—åŒ–æ—¥å¿—

**æ“ä½œ**ï¼šåˆ›å»ºæ»šåŠ¨å¡ç‰‡ â†’ ä¿å­˜è„šæœ¬

**æŸ¥çœ‹æ§åˆ¶å°**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ“ [StepSerializer] åºåˆ—åŒ–æ­¥éª¤: {
  stepId: "step_scroll_xxx",
  stepName: "å±å¹•äº¤äº’ - æ™ºèƒ½æ»šåŠ¨",
  originalStepType: "smart_scroll",  // æ£€æŸ¥è¿™ä¸ªæ˜¯å¦æ­£ç¡®
  hasParameters: true,
  parametersKeys: [...]
}
```

**å¦‚æœ `originalStepType` æ˜¯ `undefined` æˆ– `unknown`**ï¼š
- è¯´æ˜æ­¥éª¤å¯¹è±¡æœ¬èº«çš„ `step_type` æˆ– `type` å­—æ®µå°±æ˜¯é”™è¯¯çš„
- éœ€è¦æ£€æŸ¥æ­¥éª¤åˆ›å»ºé€»è¾‘

### æ­¥éª¤ 2ï¼šæ£€æŸ¥æ­¥éª¤å¯¹è±¡

åœ¨ä¿å­˜å‰ï¼Œæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// è·å–å½“å‰æ‰€æœ‰æ­¥éª¤
const steps = useStepStore.getState().steps;
console.log('å½“å‰æ­¥éª¤:', steps);

// æ£€æŸ¥ç¬¬ä¸€ä¸ªæ­¥éª¤
console.log('ç¬¬ä¸€ä¸ªæ­¥éª¤è¯¦æƒ…:', JSON.stringify(steps[0], null, 2));
```

**æ£€æŸ¥è¾“å‡º**ï¼š
```javascript
{
  "id": "step_scroll_xxx",
  "step_type": "???",  // æ£€æŸ¥è¿™ä¸ªå€¼
  "type": "???",        // æ£€æŸ¥è¿™ä¸ªå€¼
  "name": "å±å¹•äº¤äº’ - æ™ºèƒ½æ»šåŠ¨",
  "ui_state": {  // æ£€æŸ¥æ˜¯å¦å­˜åœ¨
    "showParams": true
  },
  "parameters": {
    "direction": "down",
    "start_x": 540,  // æ£€æŸ¥åæ ‡æ˜¯å¦å­˜åœ¨
    "start_y": 1260
  }
}
```

### æ­¥éª¤ 3ï¼šæ£€æŸ¥ Store æ•°æ®æº

å¯èƒ½å­˜åœ¨å¤šä¸ª Storeï¼Œéœ€è¦ç¡®è®¤ä¿å­˜æ—¶ä½¿ç”¨çš„æ˜¯å“ªä¸ªï¼š

```javascript
// å¯èƒ½çš„ Store
console.log('useStepStore:', useStepStore.getState().steps);
console.log('useStepCardStore:', useStepCardStore.getState().steps);
```

---

## ğŸ”§ å¯èƒ½çš„ä¿®å¤æ–¹å‘

### æ–¹å‘ 1ï¼šæ­¥éª¤åˆ›å»ºæ—¶ `step_type` æœªè®¾ç½®

**æ–‡ä»¶**ï¼š`src/components/step-card/screen-actions/screenTemplates.ts`

**æ£€æŸ¥**ï¼š
```typescript
export function createScrollStepTemplate(direction: ScrollDirection, overrides?: Record<string, any>): ExtendedSmartScriptStep {
  return {
    id: genId('step_scroll'),
    step_type: 'smart_scroll', // âœ… ç¡®è®¤è¿™è¡Œå­˜åœ¨
    name: `å±å¹•äº¤äº’ - æ™ºèƒ½æ»šåŠ¨`,
    // ...
  };
}
```

### æ–¹å‘ 2ï¼šåºåˆ—åŒ–æ—¶ `step_type` è¢«è¦†ç›–

**æ–‡ä»¶**ï¼š`src/modules/smart-script-management/utils/serializer.ts`

**æ£€æŸ¥** `serializeStep` æ–¹æ³•ï¼š
```typescript
const originalStepType = step.step_type || step.type;

// å¦‚æœ step.step_type å’Œ step.type éƒ½æ˜¯ undefined
// originalStepType å°±ä¼šæ˜¯ undefined
// ç„¶åè¢«åºåˆ—åŒ–ä¸º "unknown"
```

**å¯èƒ½åŸå› **ï¼š
- ä¼ å…¥çš„ `step` å¯¹è±¡çš„ `step_type` å­—æ®µä¸¢å¤±
- å¯èƒ½åœ¨æŸä¸ªä¸­é—´æ­¥éª¤è¢«è½¬æ¢æˆ–å¤åˆ¶æ—¶ä¸¢å¤±

### æ–¹å‘ 3ï¼šUI çŠ¶æ€æœªä¿å­˜åˆ° `ui_state`

**éœ€è¦æ£€æŸ¥**ï¼š
1. `DraggableStepCard` ä¸­çš„ `showParams` çŠ¶æ€æ˜¯å¦ä¿å­˜åˆ° step å¯¹è±¡
2. åºåˆ—åŒ–å™¨æ˜¯å¦æ­£ç¡®ä¿å­˜ `ui_state`

---

## ğŸ’¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

åœ¨ä¿®å¤å‰ï¼Œå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ä¿å­˜çš„ JSON æ–‡ä»¶ï¼š

1. æ‰“å¼€ `src-tauri/data/scripts/script_xxx.json`
2. ä¿®æ”¹æ¯ä¸ªæ­¥éª¤çš„ `step_type`ï¼š
   ```json
   {
     "step_type": "smart_scroll",  // æ‰‹åŠ¨æ”¹ä¸ºæ­£ç¡®çš„ç±»å‹
     "ui_state": {  // æ‰‹åŠ¨æ·»åŠ  UI çŠ¶æ€
       "showParams": true
     }
   }
   ```
3. ä¿å­˜æ–‡ä»¶
4. é‡æ–°æ‰“å¼€è„šæœ¬

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³æµ‹è¯•**ï¼š
1. åˆ›å»ºä¸€ä¸ªæ»šåŠ¨å¡ç‰‡
2. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
3. æ‰§è¡Œä¸Šè¿°è¯Šæ–­å‘½ä»¤
4. ä¿å­˜è„šæœ¬
5. æŸ¥çœ‹åºåˆ—åŒ–æ—¥å¿—
6. **æˆªå›¾æˆ–å¤åˆ¶æ§åˆ¶å°çš„å®Œæ•´è¾“å‡º**

**æä¾›ç»™æˆ‘**ï¼š
- åºåˆ—åŒ–æ—¥å¿—
- æ­¥éª¤å¯¹è±¡çš„å®Œæ•´ JSON
- ä¿å­˜çš„è„šæœ¬æ–‡ä»¶å†…å®¹

è¿™æ ·æˆ‘å°±èƒ½å®šä½åˆ°å…·ä½“æ˜¯å“ªä¸ªç¯èŠ‚å‡ºäº†é—®é¢˜ï¼
