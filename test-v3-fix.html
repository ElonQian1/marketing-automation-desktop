<!DOCTYPE html>
<html>
<head>
    <title>V3 ChainSpecV3 ä¿®å¤æµ‹è¯•</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>V3 ChainSpecV3 å­—æ®µåä¿®å¤æµ‹è¯•</h1>
    <div id="log" style="white-space: pre-wrap; font-family: monospace; background: #f0f0f0; padding: 10px; margin: 10px 0;"></div>
    <button onclick="runTest()">æµ‹è¯•ä¿®å¤</button>

    <script type="module">
        // ç®€å•çš„V3æ‰§è¡Œæµ‹è¯•
        async function testV3Fix() {
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•V3 ChainSpecV3å­—æ®µåä¿®å¤...');
            
            try {
                const { invoke } = await import('@tauri-apps/api/core');
                
                // æ„å»ºæµ‹è¯•å‚æ•° - ä½¿ç”¨camelCaseå­—æ®µåï¼ˆåº”è¯¥ä¸ä¿®å¤åçš„Rustä»£ç åŒ¹é…ï¼‰
                const envelope = {
                    deviceId: 'test_device',
                    app: {
                        package: 'com.xingin.xhs',
                        activity: null
                    },
                    snapshot: {
                        analysisId: 'test_analysis',
                        screenHash: null,
                        xmlCacheId: null
                    },
                    executionMode: 'relaxed'
                };

                // æµ‹è¯• ChainSpecV3::ByRef æ ¼å¼ï¼ˆcamelCaseï¼‰
                const spec = {
                    analysisId: 'step_execution_test_123',  // camelCase
                    threshold: 0.7,
                    mode: 'dryrun'  // snake_caseå€¼
                };

                console.log('ğŸ“‹ å‘é€ä¿®å¤åçš„å‚æ•°æ ¼å¼:', { 
                    envelope, 
                    spec, 
                    note: 'analysisIdä½¿ç”¨camelCaseï¼Œåº”è¯¥ä¸Rust #[serde(rename)]åŒ¹é…'
                });

                // è°ƒç”¨V3æ‰§è¡Œå‘½ä»¤
                const result = await invoke('execute_chain_test_v3', {
                    envelope,
                    spec
                });

                console.log('âœ… ä¿®å¤æµ‹è¯•æˆåŠŸï¼ChainSpecV3ååºåˆ—åŒ–æ­£å¸¸');
                console.log('ğŸ“‹ æ‰§è¡Œç»“æœ:', result);
                return { success: true, result };
                
            } catch (error) {
                console.error('âŒ ä¿®å¤æµ‹è¯•å¤±è´¥:', error);
                
                // åˆ†æé”™è¯¯
                if (error && typeof error === 'string') {
                    if (error.includes('data did not match any variant')) {
                        console.log('ğŸ” ä»ç„¶å­˜åœ¨æšä¸¾å˜ä½“åŒ¹é…é—®é¢˜');
                        console.log('å¯èƒ½éœ€è¦æ£€æŸ¥Rustä»£ç ä¸­çš„å­—æ®µé‡å‘½åæ˜¯å¦æ­£ç¡®');
                    } else if (error.includes('ChainSpecV3ååºåˆ—åŒ–å¤±è´¥')) {
                        console.log('ğŸ” ååºåˆ—åŒ–å¤±è´¥ï¼Œå­—æ®µåå¯èƒ½ä»æœ‰é—®é¢˜');
                    } else {
                        console.log('ğŸ” æ‰§è¡Œé˜¶æ®µé”™è¯¯ï¼Œååºåˆ—åŒ–å¯èƒ½å·²æˆåŠŸ');
                    }
                }
                
                return { success: false, error };
            }
        }

        // æŒ‚è½½æµ‹è¯•å‡½æ•°åˆ°å…¨å±€
        window.runTest = async function() {
            const logDiv = document.getElementById('log');
            const originalLog = console.log;
            const originalError = console.error;

            // é‡å®šå‘æ§åˆ¶å°è¾“å‡ºåˆ°é¡µé¢
            console.log = (...args) => {
                logDiv.textContent += args.join(' ') + '\n';
                originalLog(...args);
            };
            console.error = (...args) => {
                logDiv.textContent += 'âŒ ' + args.join(' ') + '\n';
                originalError(...args);
            };

            try {
                logDiv.textContent = '';
                const result = await testV3Fix();
                if (result.success) {
                    logDiv.textContent += '\nğŸ‰ æµ‹è¯•æˆåŠŸï¼å­—æ®µåä¿®å¤æœ‰æ•ˆï¼\n';
                } else {
                    logDiv.textContent += '\nğŸ’” æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥\n';
                }
            } catch (error) {
                logDiv.textContent += '\nğŸ’¥ æµ‹è¯•å¼‚å¸¸: ' + error + '\n';
            }

            // æ¢å¤æ§åˆ¶å°
            console.log = originalLog;
            console.error = originalError;
        };

        console.log('ğŸ“‹ V3ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>