# TXT 导入记录功能测试指南

## 🎯 功能概述

已完成 TXT 文件导入记录系统，实现：
- ✅ 每个导入的 TXT 文件持久化记录
- ✅ 显示号码总数、成功导入数、重复数
- ✅ 文件图标展示
- ✅ 删除功能（支持归档删除）

## 📁 测试文件位置

已生成 5 个测试文件在：`docs/通讯录测试文件/`

| 文件名 | 号码数量 | 说明 |
|--------|---------|------|
| test_contacts_1.txt | 15 | 正常号码 |
| test_contacts_2.txt | 20 | 正常号码 + 重复号码 |
| test_contacts_3.txt | 10 | 包含无效号码 |
| test_contacts_4.txt | 30 | 大量号码 |
| test_contacts_5.txt | 5 | 少量号码测试 |

## 🧪 测试步骤

### 1. 进入联系人导入页面
1. 启动应用（开发服务器已运行）
2. 点击左侧菜单 "联系人导入向导"

### 2. 导入单个 TXT 文件
1. 在 "导入 TXT 到号码池" 卡片中
2. 点击 "选择TXT文件" 或 "选择文件夹"
3. 选择测试文件：`docs/通讯录测试文件/test_contacts_1.txt`
4. 点击 "开始导入"

**预期结果**：
- ✅ 导入成功提示
- ✅ 号码池增加 15 条记录
- ✅ 下方显示 "TXT 导入记录" 区域

### 3. 验证导入记录显示

**检查项**：
1. **文件卡片显示**：
   - 📄 文件图标（蓝色）
   - 文件名：`test_contacts_1.txt`
   - 文件路径显示

2. **统计信息显示**：
   ```
   总号码数: 15
   成功导入: 15
   重复号码: 0
   ```

3. **状态标签**：
   - 成功：绿色 "成功" 标签
   - 部分成功：橙色 "部分成功" 标签

4. **时间戳**：显示导入时间

### 4. 测试多文件导入
1. 点击 "选择文件夹"
2. 选择整个 `docs/通讯录测试文件/` 文件夹
3. 点击 "开始导入"

**预期结果**：
- ✅ 显示 5 个文件卡片
- ✅ 每个文件独立显示统计
- ✅ 重复号码正确识别（test_contacts_2.txt 应该有重复）

### 5. 测试删除功能

#### 普通删除（仅删除记录）
1. 点击某个文件卡片右上角的 "🗑️" 按钮
2. 在确认对话框中选择 "仅删除记录"
3. 确认删除

**预期结果**：
- ✅ 记录从列表消失
- ✅ 号码池中的号码**保留**（状态不变）

#### 归档删除（删除记录+标记号码为已删除）
1. 点击另一个文件卡片的删除按钮
2. 在确认对话框中勾选 "同时归档号码"
3. 确认删除

**预期结果**：
- ✅ 记录从列表消失
- ✅ 关联的号码状态变为 "deleted"
- ✅ 这些号码不再出现在可用号码池中

### 6. 验证数据库持久化

#### 重启应用测试
1. 关闭应用窗口
2. 重新启动开发服务器
3. 再次进入联系人导入页面

**预期结果**：
- ✅ 之前导入的记录仍然显示
- ✅ 统计数据正确
- ✅ 删除的记录不再出现

#### 查看数据库
```powershell
# 使用 SQLite 工具查看
sqlite3 "d:\rust\active-projects\小红书\employeeGUI\src-tauri\data\contacts.db"

# 查询导入记录
SELECT * FROM txt_import_records ORDER BY created_at DESC;

# 查看关联的号码
SELECT * FROM contact_numbers WHERE phone_number IN (
  SELECT phone_number FROM txt_import_records_numbers
);
```

## 🐛 已知问题和注意事项

### ⚠️ 重复号码检测逻辑
- **当前行为**：基于电话号码的完全匹配
- **影响**：不同格式的相同号码（如 `138****` vs `138****`）会被视为不同号码

### ⚠️ 错误处理
- 无效号码会被跳过并计入错误
- 文件读取失败会显示错误消息
- 部分成功的导入会显示 "部分成功" 状态

### ⚠️ 性能考虑
- 大文件（>1000号码）导入可能需要几秒钟
- UI 在导入期间会显示加载状态

## 📊 测试验收标准

### ✅ 必须通过的测试
1. 单文件导入成功并显示记录
2. 多文件批量导入所有文件都有记录
3. 统计数据准确（总数、成功数、重复数）
4. 删除功能正常工作
5. 应用重启后记录仍然存在
6. 归档删除正确标记号码状态

### ⚠️ 可选测试
1. 导入超大文件（>5000号码）
2. 并发导入多个文件
3. 文件名包含特殊字符
4. 文件路径包含中文字符

## 🔧 调试建议

### 如果记录不显示
1. 检查浏览器控制台是否有错误
2. 验证 `list_txt_import_records` 命令返回数据
3. 检查数据库表是否有数据

### 如果统计数据不正确
1. 查看导入命令的返回结果
2. 检查 `create_txt_import_record` 调用参数
3. 验证数据库记录的值

### 如果删除失败
1. 检查 `delete_txt_import_record` 命令
2. 验证 `cascade_archive` 参数传递
3. 查看数据库事务是否正确执行

## 📝 代码修改摘要

### 后端修改
- ✅ 修复了 `contact_numbers.rs` 中的函数调用参数
- ✅ 添加了临时值生命周期管理
- ✅ 正确记录导入统计到 `txt_import_records` 表

### 前端修改
- ✅ 创建了 `TxtImportRecordsList.tsx` 组件
- ✅ 集成到 `ContactImportWorkbench.tsx`
- ✅ 添加了刷新机制（通过 `refreshCounter`）

### 数据库
- ✅ `txt_import_records` 表已创建
- ✅ 字段映射正确

## 🎉 完成标志

当以下所有项都通过时，功能开发完成：

- [x] 编译无错误
- [ ] 导入单文件显示记录
- [ ] 导入多文件所有记录显示
- [ ] 统计数据准确
- [ ] 删除功能工作
- [ ] 归档删除正确标记号码
- [ ] 重启后数据持久化
- [ ] UI 响应流畅无卡顿

---

**测试时间预估**：15-20 分钟  
**测试人员**：开发者自测 + 用户验收
