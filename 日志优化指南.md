# 🔇 日志优化指南

## 问题分析

从你的日志看到以下冗余：

### 1. **高频重复日志**（每次渲染都打印）

```javascript
// ❌ 每次渲染打印 7 次
VisualElementView.tsx:521 🔄 [VisualElementView] 检测到Hook包含菜单元素
VisualElementView.tsx:527 📊 [VisualElementView] 数据源选择结果

// ❌ 每次渲染打印
PagePreview.tsx:125 🔍 PagePreview 坐标系诊断（v2）

// ❌ 每次状态更新打印多次
CompactStrategyMenu.tsx:167 🎯 [CompactStrategyMenu] 数据检查
```

### 2. **多路径重复事件**（同一事件多个组件监听）

```javascript
// 同一进度更新被打印 7 次
intelligent-analysis-backend.ts:194 📊 [BackendService] 收到分析进度更新
useIntelligentAnalysisAdapter.ts:91 📊 [Adapter] 收到进度更新
devTracer.ts:42 [EVT] analysis:progress
wire-global-events.ts:124 ⚠️ [GlobalWire] progress事件找不到卡片
```

## ✅ 立即优化方案

### 方案 1：使用日志过滤器（推荐）

在控制台执行以下命令（临时生效）：

```javascript
// 1. 设置日志级别为 WARN（只显示警告和错误）
logger.setLevel(LogLevel.WARN)

// 2. 静音指定组件的调试日志
logger.mute('[VisualElementView]', 'PagePreview', '[CompactStrategyMenu]')

// 3. 只看关键数据流
logger.setLevel(LogLevel.INFO)
logger.mute('📊', '🔄', '🔍', '数据检查', '坐标系诊断')
```

### 方案 2：修改 localStorage（持久生效）

在控制台执行：

```javascript
// 只显示关键信息
localStorage.setItem('LOG_LEVEL', 'CRITICAL')

// 或保留警告和错误
localStorage.setItem('LOG_LEVEL', 'WARN')

// 刷新页面生效
location.reload()
```

## 🔥 关键数据流日志（保留这些）

### 前端发送数据检查：

```javascript
// ✅ 必须看这个！验证 xmlFileName 格式
usePageFinderModal.ts:312 ✅ [usePageFinderModal] XML已保存到缓存: {
  xmlCacheId,
  xmlFileName,  // 🔥 关键！应该是 "ui_dump_xxx.xml" 格式
  xmlContentLength
}

// ✅ 验证元素携带正确的 xmlCacheId
UniversalPageFinderModal.tsx:482 ✅ [UniversalPageFinderModal] 附加xmlCacheId到元素: {
  xmlCacheId  // 🔥 应该与上面的 xmlFileName 一致
}

// ✅ 验证缓存获取成功
useIntelligentStepCardIntegration.ts:100 ✅ [convertElementToContext] 从缓存获取XML成功: {
  xmlCacheId,
  xmlContentLength  // 🔥 应该 > 50000
}
```

### 后端接收数据检查（Rust 控制台）：

```rust
// ✅ 检查后端是否收到 XML
INFO: 📋 原始参数: {..., "original_xml": "<hierarchy>...", ...}
INFO: ✅ [数据完整性] original_xml 长度: 59220 bytes

// ✅ 检查多候选评估分数
INFO: [1] 评分: 0.980 | text=Some("通讯录")
```

## 🐛 你的日志问题

### 问题：xmlCacheId 格式错误

```javascript
// ❌ 当前日志（错误）
xmlCacheId: 'xml_PD94bWwgdmVyc2lv_1761628466736'

// ✅ 应该是（正确）
xmlCacheId: 'ui_dump_e0d909c3_20251028_030232.xml'
```

**原因**：后端没有返回 `xml_file_name` 字段，或返回为空

### 解决步骤：

#### 1. 添加临时调试日志

在 `usePageFinderModal.ts` 第 305 行后添加：

```typescript
const xmlCacheId = result.xmlFileName || `xml_${snapshot.xmlHash.substring(0, 16)}_${Date.now()}`;

// 🔥 临时调试：打印后端返回的原始数据
console.log('🔥🔥🔥 [DEBUG] 后端返回数据:', {
  hasXmlFileName: !!result.xmlFileName,
  xmlFileName: result.xmlFileName,
  xmlFileNameType: typeof result.xmlFileName,
  xmlFileNameLength: result.xmlFileName?.length,
  fallbackUsed: !result.xmlFileName,
  actualCacheId: xmlCacheId
});
```

#### 2. 检查后端 Rust 代码

找到 `analyze_universal_ui_page` 函数，确保返回了 `xml_file_name` 字段：

```rust
// src-tauri/src/api/universal_ui_handler.rs
pub struct UniversalPageCaptureResult {
    pub xml_content: String,
    pub xml_file_name: String,  // 🔥 必须有这个字段！
    pub xml_relative_path: String,
    pub xml_absolute_path: String,
    // ...
}
```

#### 3. 验证修复

重新运行后，查看日志应该显示：

```javascript
🔥🔥🔥 [DEBUG] 后端返回数据: {
  hasXmlFileName: true,
  xmlFileName: 'ui_dump_e0d909c3_20251028_030232.xml',
  xmlFileNameType: 'string',
  xmlFileNameLength: 43,
  fallbackUsed: false,
  actualCacheId: 'ui_dump_e0d909c3_20251028_030232.xml'
}
```

## 📝 日志优化最佳实践

### 1. **分层日志**

```typescript
// 🔥 关键数据（始终显示）
logger.critical('[Module]', '关键操作', data);

// ❌ 错误
logger.error('[Module]', '操作失败', error);

// ⚠️ 警告
logger.warn('[Module]', '潜在问题', warning);

// ℹ️ 信息（生产环境可关闭）
logger.info('[Module]', '状态更新', data);

// 🔍 调试（默认关闭）
logger.debug('[Module]', '详细数据', data);
```

### 2. **去重机制**

```typescript
// 自动去重：1 秒内相同日志只打印一次
logger.info('[Module]', '状态更新', data);
```

### 3. **条件日志**

```typescript
// 只在开发环境打印
if (import.meta.env.DEV) {
  console.log('🔍 [Debug]', data);
}
```

## 🎯 快速诊断命令

### 在浏览器控制台执行：

```javascript
// 1. 只看关键错误
logger.setLevel(3); // ERROR
logger.clearMuted();

// 2. 只看 XML 相关日志
logger.setLevel(1); // INFO
logger.mute('VisualElementView', 'PagePreview', 'CompactStrategyMenu', 'progress事件');

// 3. 查看所有日志（调试模式）
logger.setLevel(0); // DEBUG
logger.clearMuted();

// 4. 恢复默认
logger.setLevel(1); // INFO
logger.mute('数据源选择', '坐标系诊断', '数据检查');
```

## 🔍 下一步操作

1. **立即执行**：在控制台运行 `logger.mute('VisualElementView', 'PagePreview')` 减少噪音
2. **添加调试日志**：在 `usePageFinderModal.ts` 添加 `🔥🔥🔥 [DEBUG]` 日志
3. **重新测试**：采集页面并查看 `xmlFileName` 是否正确
4. **检查后端**：如果前端没收到，去 Rust 代码检查返回值

---

## 附录：常见问题

### Q1: 如何永久减少日志？

在 `src/main.tsx` 或 `src/App.tsx` 顶部添加：

```typescript
import { logger, LogLevel } from '@/utils/logger-filter';

// 生产环境只显示警告和错误
if (import.meta.env.PROD) {
  logger.setLevel(LogLevel.WARN);
}

// 开发环境静音冗余日志
if (import.meta.env.DEV) {
  logger.mute(
    '[VisualElementView]',
    'PagePreview 坐标系诊断',
    '[CompactStrategyMenu] 数据检查'
  );
}
```

### Q2: 如何找到产生日志的代码位置？

点击日志前面的文件名和行号（如 `VisualElementView.tsx:521`）会直接跳转到代码。

### Q3: 如何临时启用某个组件的日志？

```javascript
// 取消静音
logger.unmute('[VisualElementView]')

// 刷新页面重新触发
```
