# ä¸­å±‚æ— æ–‡æœ¬å®¹å™¨åŒ¹é…ç­–ç•¥ - å®Œæ•´å®æ–½æŠ¥å‘Š

## ğŸ“‹ éœ€æ±‚å›é¡¾

ç”¨æˆ·åœºæ™¯ï¼š
- ç”¨æˆ·åœ¨å¯è§†åŒ–XMLç•Œé¢ç‚¹é€‰"ä¸­å±‚æ— æ–‡æœ¬æŒ‰é’®"
- è¯¥å…ƒç´ è‡ªèº« `text=""`, `content-desc=""`, ä½†æœ‰å­å…ƒç´ åŒ…å«æ–‡æœ¬ï¼ˆå¦‚"é€šè®¯å½•"ï¼‰
- å‰ç«¯åº”æ™ºèƒ½è¯†åˆ«å¹¶æ ‡è®°ä¸º"anchor_by_child_or_parent_text"ç­–ç•¥
- åç«¯æ¥æ”¶ç­–ç•¥æ ‡è®°ï¼Œä¼˜å…ˆä½¿ç”¨å­/çˆ¶å…ƒç´ æ–‡æœ¬ä½œä¸ºé”šç‚¹

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **å®Œå…¨åŒ¹é…ä¼˜å…ˆ**ï¼šå­/çˆ¶å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…æ—¶ï¼Œç›´æ¥é«˜åˆ†é€‰å–ï¼ˆ2.0åˆ†ï¼‰
2. **æ— éœ€æ¨¡ç³ŠåŒ¹é…**ï¼šå®Œå…¨åŒ¹é…å³å¯ç¡®å®šï¼Œä¸ä¾èµ–Bounds
3. **ä½ç½®è¯„åˆ†è¾…åŠ©**ï¼šå½“æ— æ³•ç²¾å‡†æ–‡æœ¬åŒ¹é…æ—¶ï¼Œæ‰ä½¿ç”¨Boundsæ¨¡ç³ŠåŒ¹é…è¾…åŠ©
4. **å¤„ç†ç‰¹æ®Šåœºæ™¯**ï¼šéšè—åæ ‡æ–‡æœ¬å…ƒç´ ã€å¤§å®¹å™¨åŒ…å«å…³ç³»

---

## âœ… å·²å®ŒæˆåŠŸèƒ½æ¸…å•

### 1. å‰ç«¯æ™ºèƒ½è¯†åˆ«æ¨¡å— âœ…

**æ–‡ä»¶**: `src/pages/SmartScriptBuilderPage/composables/useIntelligentStepCardIntegration.ts`

**åŠŸèƒ½**:
```typescript
// Line 586-720: æ™ºèƒ½è¯†åˆ«åŒ¹é…ç­–ç•¥
const isMiddleLayerContainer = !element.text && context.elementText;
const matchingStrategy = isMiddleLayerContainer 
  ? 'anchor_by_child_or_parent_text'  // å­/çˆ¶å…ƒç´ æ–‡æœ¬é”šç‚¹
  : 'direct_match';                    // ç›´æ¥åŒ¹é…

// elementSignature åŒ…å«å®Œæ•´é”šç‚¹ä¿¡æ¯
elementSignature: {
  matchingStrategy: matchingStrategy,
  siblingTexts: context._enrichment?.siblingTexts || [],
  parentInfo: context._enrichment?.parentElement ? {...} : null,
  childrenTexts: context.elementText ? [context.elementText] : []
}

// matching.fields æ ¹æ®ç­–ç•¥åŠ¨æ€è°ƒæ•´
fields: isMiddleLayerContainer 
  ? ['children_texts', 'sibling_texts', 'resource-id', 'parent_content_desc']
  : ['resource-id', 'text', 'content-desc']
```

**å…³é”®æ£€æµ‹ç‚¹**:
- âœ… æ£€æµ‹å…ƒç´ è‡ªèº«æ— text
- âœ… æ£€æµ‹contextæœ‰elementTextï¼ˆä»å­/å…„å¼Ÿå…ƒç´ æå–ï¼‰
- âœ… è‡ªåŠ¨æ ‡è®°ä¸º"ä¸­å±‚å®¹å™¨"ç­–ç•¥
- âœ… æ”¶é›†å…„å¼Ÿå…ƒç´ æ–‡æœ¬ã€çˆ¶å…ƒç´ ä¿¡æ¯

---

### 2. æ•°æ®ä¼ é€’å±‚å®Œå–„ âœ…

**æ–‡ä»¶**: `src/pages/SmartScriptBuilderPage/helpers/intelligentDataTransfer.ts`

**æ¥å£å®šä¹‰**:
```typescript
export interface IntelligentStepDataPackage {
  // åŸæœ‰å­—æ®µ...
  
  // ğŸ†• NEW: åŒ¹é…ç­–ç•¥åè®®
  matchingStrategy: 'anchor_by_child_or_parent_text' | 'direct_match';
  siblingTexts: string[];        // å…„å¼Ÿå…ƒç´ æ–‡æœ¬
  parentInfo: {                  // çˆ¶å…ƒç´ ä¿¡æ¯
    contentDesc: string;
    text: string;
    resourceId: string;
  } | null;
}
```

**æ•°æ®æ„å»º**:
```typescript
// Line 120-240: æå–å¹¶ä¼ é€’ç»™åç«¯
const originalData = {
  matching_strategy: dataPackage.matchingStrategy,
  sibling_texts: dataPackage.siblingTexts,
  parent_info: dataPackage.parentInfo,
  // ...å…¶ä»–å­—æ®µ
};
```

---

### 3. åç«¯æ•°æ®æ¥æ”¶ âœ…

**æ–‡ä»¶**: `src-tauri/src/exec/v3/helpers/step_executor.rs`

**æ¥æ”¶é€»è¾‘**:
```rust
// Line 390-450: ä» original_data æå–æ–°å­—æ®µ
let matching_strategy = original_data
    .and_then(|od| od.get("matching_strategy"))
    .and_then(|v| v.as_str())
    .map(|s| s.to_string());

let sibling_texts = original_data
    .and_then(|od| od.get("sibling_texts"))
    .and_then(|v| v.as_array())
    .map(|arr| arr.iter()
        .filter_map(|v| v.as_str())
        .map(|s| s.to_string())
        .collect())
    .unwrap_or_default();

let parent_info = original_data
    .and_then(|od| od.get("parent_info"))
    .and_then(|v| v.as_object())
    .map(|obj| {
        use crate::exec::v3::element_matching::multi_candidate_evaluator::ParentInfo;
        ParentInfo {
            content_desc: obj.get("contentDesc").and_then(|v| v.as_str()).unwrap_or("").to_string(),
            text: obj.get("text").and_then(|v| v.as_str()).unwrap_or("").to_string(),
            resource_id: obj.get("resourceId").and_then(|v| v.as_str()).unwrap_or("").to_string(),
        }
    });

// æ„å»ºè¯„ä¼°å‡†åˆ™
let criteria = EvaluationCriteria {
    // ...åŸæœ‰å­—æ®µ
    matching_strategy,    // ğŸ†• NEW
    sibling_texts,        // ğŸ†• NEW
    parent_info,          // ğŸ†• NEW
};
```

**è°ƒè¯•æ—¥å¿—**:
```rust
if matching_strategy.is_some() || !sibling_texts.is_empty() || parent_info.is_some() {
    tracing::info!("ğŸ”¥ [ç­–ç•¥æ ‡è®°æå–] matching_strategy={:?}, sibling_texts={:?}, parent_info={:?}", 
                 matching_strategy, sibling_texts, parent_info);
}
```

---

### 4. Boundsæ™ºèƒ½åŒ¹é…æ¨¡å— âœ…

**æ–‡ä»¶**: `src-tauri/src/exec/v3/element_matching/bounds_matcher.rs` (æ–°å»º)

**æ ¸å¿ƒåŠŸèƒ½**:

#### 4.1 BoundsRect ç»“æ„
```rust
pub struct BoundsRect {
    pub left: i32,
    pub top: i32,
    pub right: i32,
    pub bottom: i32,
}

impl BoundsRect {
    // ä»"[left,top][right,bottom]"è§£æ
    pub fn from_string(bounds_str: &str) -> Option<Self>
    
    // è®¡ç®—é¢ç§¯
    pub fn area(&self) -> i32
    
    // è®¡ç®—ä¸­å¿ƒç‚¹
    pub fn center(&self) -> (f32, f32)
    
    // æ£€æŸ¥åŒ…å«å…³ç³»
    pub fn contains(&self, other: &BoundsRect) -> bool
    pub fn is_contained_in(&self, other: &BoundsRect) -> bool
    
    // è®¡ç®—IOU (Intersection over Union)
    pub fn calculate_iou(&self, other: &BoundsRect) -> f32
    
    // è®¡ç®—ä¸­å¿ƒç‚¹è·ç¦»
    pub fn center_distance(&self, other: &BoundsRect) -> f32
}
```

#### 4.2 æ™ºèƒ½åŒ¹é…ç®—æ³•
```rust
pub struct BoundsMatcher;

impl BoundsMatcher {
    /// ğŸ”¥ æ™ºèƒ½åŒ¹é…ç”¨æˆ·é€‰æ‹©çš„boundsä¸å€™é€‰å…ƒç´ çš„bounds
    /// 
    /// åŒ¹é…ç­–ç•¥ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
    /// 1. ç²¾ç¡®åŒ¹é…ï¼ˆå®Œå…¨ç›¸åŒï¼‰
    /// 2. é«˜IOUåŒ¹é…ï¼ˆIOU > 0.9ï¼‰
    /// 3. åŒ…å«å…³ç³»ï¼ˆç”¨æˆ·boundsåœ¨å€™é€‰boundså†…ï¼‰
    /// 4. ä¸­ç­‰IOUåŒ¹é…ï¼ˆIOU > 0.7ï¼‰
    /// 5. ä½IOUåŒ¹é…ï¼ˆIOU > 0.3ï¼‰+ ä¸­å¿ƒç‚¹æ¥è¿‘
    pub fn match_bounds(user_bounds: &str, candidate_bounds: &str) -> BoundsMatchResult
    
    /// ğŸ”¥ è®¡ç®—åŒ¹é…è´¨é‡è¯„åˆ† [0.0, 1.0]
    /// æƒé‡åˆ†é…ï¼š
    /// - IOU: 50% ï¼ˆæ ¸å¿ƒæŒ‡æ ‡ï¼‰
    /// - åŒ…å«å…³ç³»: 30% ï¼ˆé‡è¦æŒ‡æ ‡ï¼‰
    /// - ä¸­å¿ƒè·ç¦»: 20% ï¼ˆè¾…åŠ©æŒ‡æ ‡ï¼‰
    fn calculate_match_quality(...) -> f32
    
    /// ğŸ”¥ ä»å€™é€‰åˆ—è¡¨ä¸­ç­›é€‰ç¬¦åˆboundsæ¡ä»¶çš„å…ƒç´ 
    pub fn filter_candidates_by_bounds<'a>(
        candidates: &'a [UIElement],
        user_bounds: &str,
        min_quality: f32,
    ) -> Vec<(&'a UIElement, BoundsMatchResult)>
    
    /// ğŸ”¥ åœ¨ç”¨æˆ·boundsèŒƒå›´å†…æŸ¥æ‰¾å¯ç‚¹å‡»çš„å­å…ƒç´ 
    pub fn find_clickable_children_in_bounds<'a>(
        all_elements: &'a [UIElement],
        user_bounds: &str,
        min_iou: f32,
    ) -> Vec<&'a UIElement>
}
```

#### 4.3 åŒ¹é…ç»“æœ
```rust
pub struct BoundsMatchResult {
    pub is_exact: bool,           // æ˜¯å¦ç²¾ç¡®åŒ¹é…
    pub is_contained: bool,       // æ˜¯å¦åŒ…å«å…³ç³»
    pub is_overlap: bool,         // æ˜¯å¦é‡å 
    pub iou: f32,                 // IOUå€¼ [0.0, 1.0]
    pub center_distance: f32,     // ä¸­å¿ƒç‚¹è·ç¦»
    pub match_quality: f32,       // åŒ¹é…è´¨é‡ [0.0, 1.0]
}
```

---

### 5. å¤šå€™é€‰è¯„ä¼°å™¨å¢å¼º âœ…

**æ–‡ä»¶**: `src-tauri/src/exec/v3/element_matching/multi_candidate_evaluator.rs`

#### 5.1 EvaluationCriteria æ‰©å±•
```rust
pub struct EvaluationCriteria {
    // ...åŸæœ‰å­—æ®µ
    
    // ğŸ†• NEW: åŒ¹é…ç­–ç•¥åè®®
    pub matching_strategy: Option<String>,
    pub sibling_texts: Vec<String>,
    pub parent_info: Option<ParentInfo>,
}

pub struct ParentInfo {
    pub content_desc: String,
    pub text: String,
    pub resource_id: String,
}
```

#### 5.2 æ™ºèƒ½è¯„åˆ†ç®—æ³•ï¼ˆæ ¹æ®ç­–ç•¥åŠ¨æ€è°ƒæ•´ï¼‰

**è¯„åˆ†é¡¹0: BoundsåŒ¹é…ï¼ˆä½¿ç”¨BoundsMatcherï¼‰**
```rust
// ğŸ”¥ ä½¿ç”¨æ™ºèƒ½BoundsåŒ¹é…å™¨
let match_result = BoundsMatcher::match_bounds(original_bounds, elem_bounds);

if match_result.is_exact {
    score += if is_anchor_by_child { 0.4 } else { 0.7 };
} else if match_result.match_quality > 0.8 {
    let fuzzy_score = if is_anchor_by_child { 0.4 } else { 0.7 };
    score += fuzzy_score * match_result.match_quality;
} else if match_result.match_quality > 0.5 {
    let fuzzy_score = if is_anchor_by_child { 0.2 } else { 0.3 };
    score += fuzzy_score * match_result.match_quality;
}
```

**è¯„åˆ†é¡¹1: å­å…ƒç´ æ–‡æœ¬åŒ¹é…**
```rust
if child_text_match.is_complete {
    if is_anchor_by_child {
        score += 2.0;  // ğŸ”¥ æœ€å¼ºé”šç‚¹ï¼
        has_perfect_text_anchor = true;
    } else {
        score += 1.0;
    }
}
```

**è¯„åˆ†é¡¹1.5: å…„å¼Ÿå…ƒç´ æ–‡æœ¬åŒ¹é…ï¼ˆæ–°å¢ï¼‰**
```rust
// ğŸ”¥ ä¸­å±‚å®¹å™¨ç­–ç•¥ä¸“ç”¨
if is_anchor_by_child && !criteria.sibling_texts.is_empty() {
    for sibling_text in &criteria.sibling_texts {
        if sibling_text == target_text {
            score += 1.5;  // å®Œå…¨åŒ¹é…
            has_perfect_text_anchor = true;
        } else if sibling_text.starts_with(target_text) {
            // å¤„ç†"é€šè®¯å½•ï¼Œ" starts_with "é€šè®¯å½•"
            if åé¢æ˜¯æ ‡ç‚¹ {
                score += 1.5;
                has_perfect_text_anchor = true;
            }
        } else if sibling_text.contains(target_text) {
            score += 0.7;  // éƒ¨åˆ†åŒ¹é…
        }
    }
}
```

**è¯„åˆ†é¡¹1.6: çˆ¶å…ƒç´ ä¿¡æ¯åŒ¹é…ï¼ˆæ–°å¢ï¼‰**
```rust
// ğŸ”¥ ä¸­å±‚å®¹å™¨ç­–ç•¥ä¸“ç”¨
if is_anchor_by_child && parent_info.is_some() {
    // æ£€æŸ¥çˆ¶å…ƒç´ content-desc
    if parent_info.content_desc == target_text {
        score += 1.5;  // å®Œå…¨åŒ¹é…
        has_perfect_text_anchor = true;
    } else if parent_info.content_desc.starts_with(target_text) {
        if åé¢æ˜¯æ ‡ç‚¹ {
            score += 1.5;  // å‰ç¼€åŒ¹é…ï¼ˆå¸¦æ ‡ç‚¹ï¼‰
            has_perfect_text_anchor = true;
        }
    } else if parent_info.content_desc.contains(target_text) {
        score += 0.5;  // åŒ…å«åŒ¹é…
    }
    
    // æ£€æŸ¥çˆ¶å…ƒç´ text
    if parent_info.text == target_text {
        score += 1.2;
        has_perfect_text_anchor = true;
    }
}
```

**è¯„åˆ†é¡¹2-6**: è‡ªèº«æ–‡æœ¬ã€Content-descã€å¯ç‚¹å‡»æ€§ã€Resource-idã€ä½ç½®åå¥½
- æ ¹æ®ç­–ç•¥è°ƒæ•´æƒé‡ï¼ˆä¸­å±‚å®¹å™¨é™ä½è‡ªèº«å±æ€§æƒé‡ï¼‰

**è¯„åˆ†æ€»ç»“**:
```rust
if has_perfect_text_anchor {
    reasons.push(format!("ğŸ”¥ [è¯„åˆ†æ€»ç»“] æ‰¾åˆ°å®Œç¾æ–‡æœ¬é”šç‚¹ï¼Œæ€»åˆ†: {:.2} (é«˜ç½®ä¿¡åº¦)", score));
} else if is_anchor_by_child {
    reasons.push(format!("âš ï¸ [è¯„åˆ†æ€»ç»“] ä¸­å±‚å®¹å™¨ä½†æ— å®Œç¾é”šç‚¹ï¼Œæ€»åˆ†: {:.2} (å¯èƒ½éœ€è¦Boundsè¾…åŠ©)", score));
} else {
    reasons.push(format!("âœ… [è¯„åˆ†æ€»ç»“] ç›´æ¥åŒ¹é…æ¨¡å¼ï¼Œæ€»åˆ†: {:.2}", score));
}
```

---

## ğŸ“Š è¯„åˆ†ä½“ç³»å¯¹æ¯”

### ç›´æ¥åŒ¹é…ç­–ç•¥ (`direct_match`)
| è¯„åˆ†é¡¹ | å®Œå…¨åŒ¹é… | éƒ¨åˆ†åŒ¹é… | æƒé‡ |
|--------|----------|----------|------|
| Bounds | +0.7 | +0.7 * quality | é«˜ |
| å­å…ƒç´ æ–‡æœ¬ | +1.0 | +0.5 | ä¸­ |
| è‡ªèº«æ–‡æœ¬ | +0.5 | +0.5 * similarity | é«˜ |
| Content-desc | +0.3 | +0.15 | ä¸­ |
| å¯ç‚¹å‡»æ€§ | +0.15 | - | ä½ |
| Resource-id | +0.1 | - | ä½ |

### ä¸­å±‚å®¹å™¨ç­–ç•¥ (`anchor_by_child_or_parent_text`)
| è¯„åˆ†é¡¹ | å®Œå…¨åŒ¹é… | éƒ¨åˆ†åŒ¹é… | æƒé‡ |
|--------|----------|----------|------|
| **å­å…ƒç´ æ–‡æœ¬** | **+2.0** ğŸ”¥ | +0.8 | **æœ€é«˜** |
| **å…„å¼Ÿå…ƒç´ æ–‡æœ¬** | **+1.5** ğŸ”¥ | +0.7 | **æé«˜** |
| **çˆ¶å…ƒç´ content-desc** | **+1.5** ğŸ”¥ | +0.5 | **æé«˜** |
| **çˆ¶å…ƒç´ text** | **+1.2** ğŸ”¥ | - | **é«˜** |
| Bounds | +0.4 | +0.4 * quality | ä¸­ï¼ˆé™ä½ï¼‰ |
| è‡ªèº«æ–‡æœ¬ | +0.3 | +0.3 * similarity | ä½ï¼ˆé™ä½ï¼‰ |
| Content-desc | +0.3 | +0.15 | ä½ |
| å¯ç‚¹å‡»æ€§ | +0.15 | - | ä½ |
| Resource-id | +0.1 | - | ä½ |

**å…³é”®å·®å¼‚**ï¼š
1. âœ… å­/çˆ¶/å…„å¼Ÿå…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é… â†’ **2.0åˆ†**ï¼ˆç¡®ä¿è·èƒœï¼‰
2. âœ… Boundsæƒé‡é™ä½ï¼ˆ0.7 â†’ 0.4ï¼‰ï¼Œå› ä¸ºè¿è¡Œæ—¶å¯èƒ½å˜åŒ–
3. âœ… è‡ªèº«æ–‡æœ¬æƒé‡é™ä½ï¼ˆ0.5 â†’ 0.3ï¼‰ï¼Œå› ä¸ºä¸­å±‚å®¹å™¨é€šå¸¸æ— text
4. âœ… æ–°å¢å…„å¼Ÿå…ƒç´ å’Œçˆ¶å…ƒç´ åŒ¹é…é¡¹ï¼ˆ1.5åˆ†ã€1.2åˆ†ï¼‰

---

## ğŸ¯ å®Œç¾é”šç‚¹è¯†åˆ«é€»è¾‘

```rust
let mut has_perfect_text_anchor = false;

// æ£€æŸ¥1: å­å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…
if child_text_match.is_complete {
    has_perfect_text_anchor = true;
}

// æ£€æŸ¥2: å…„å¼Ÿå…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…ï¼ˆå«æ ‡ç‚¹å¤„ç†ï¼‰
if sibling_text == target_text || 
   (sibling_text.starts_with(target_text) && åé¢æ˜¯æ ‡ç‚¹) {
    has_perfect_text_anchor = true;
}

// æ£€æŸ¥3: çˆ¶å…ƒç´ content-descå®Œå…¨åŒ¹é…ï¼ˆå«æ ‡ç‚¹å¤„ç†ï¼‰
if parent_info.content_desc == target_text ||
   (parent_info.content_desc.starts_with(target_text) && åé¢æ˜¯æ ‡ç‚¹) {
    has_perfect_text_anchor = true;
}

// æ£€æŸ¥4: çˆ¶å…ƒç´ textå®Œå…¨åŒ¹é…
if parent_info.text == target_text {
    has_perfect_text_anchor = true;
}

// ç»“æœ: has_perfect_text_anchor = true â†’ è·å¾—2.0åˆ† â†’ æ— éœ€ä¾èµ–Bounds
```

**æ ‡ç‚¹å¤„ç†é€»è¾‘**ï¼š
- "é€šè®¯å½•ï¼Œ" starts_with "é€šè®¯å½•" âœ…
- æ£€æŸ¥åé¢å­—ç¬¦æ˜¯å¦ä¸ºï¼š`ï¼Œã€‚ã€ï¼›ï¼šï¼ï¼Ÿ,. ;:!?` æˆ–ç©ºç™½
- å¦‚æœæ˜¯ â†’ è§†ä¸ºå®Œå…¨åŒ¹é… â†’ +1.5åˆ†

---

## ğŸ” å…¸å‹åœºæ™¯åˆ†æ

### åœºæ™¯1: "é€šè®¯å½•"æŒ‰é’®ï¼ˆä¸­å±‚å®¹å™¨ï¼‰

**é™æ€XMLï¼ˆç”¨æˆ·ç‚¹é€‰æ—¶ï¼‰**:
```xml
<node resource-id="com.ss.android.ugc.aweme:id/iwk" 
      bounds="[45,1059][249,1263]" 
      clickable="true" 
      content-desc="é€šè®¯å½•ï¼Œ">
  <node resource-id="icon" class="ImageView" />
  <node text="é€šè®¯å½•" class="TextView" />
</node>
```

**å‰ç«¯è¯†åˆ«**:
```typescript
isMiddleLayerContainer = true  // element.text == "" && context.elementText == "é€šè®¯å½•"
matchingStrategy = "anchor_by_child_or_parent_text"
siblingTexts = ["é€šè®¯å½•", "é€šè®¯å½•ï¼Œ"]
parentInfo = { contentDesc: "é€šè®¯å½•ï¼Œ", text: "", resourceId: "" }
```

**çœŸæœºXMLï¼ˆæ‰§è¡Œæ—¶ï¼‰**:
```xml
<!-- å¯èƒ½boundså˜åŒ–äº† -->
<node resource-id="com.ss.android.ugc.aweme:id/iwk" 
      bounds="[0,1043][1080,1279]"  â† å¤–å±‚å¤§å®¹å™¨
      clickable="false" 
      content-desc="é€šè®¯å½•ï¼Œ">
  <node bounds="[45,1059][249,1263]"  â† å®é™…æŒ‰é’®ä½ç½®
        clickable="true">
    <node text="é€šè®¯å½•" />
  </node>
</node>
```

**åç«¯è¯„åˆ†**ï¼ˆä¸­å±‚å®¹å™¨ç­–ç•¥ï¼‰:
- æ£€æµ‹åˆ° `matching_strategy = "anchor_by_child_or_parent_text"`
- å­å…ƒç´ æ–‡æœ¬"é€šè®¯å½•"å®Œå…¨åŒ¹é… â†’ **+2.0åˆ†** ğŸ”¥
- çˆ¶å…ƒç´ content-desc"é€šè®¯å½•ï¼Œ"å‰ç¼€åŒ¹é…ï¼ˆå¸¦æ ‡ç‚¹ï¼‰ â†’ **+1.5åˆ†** ğŸ”¥
- Boundsä¸å®Œå…¨åŒ¹é…ï¼Œä½†æœ‰åŒ…å«å…³ç³» â†’ +0.3åˆ†
- æ€»åˆ†ï¼š**3.8åˆ†** â†’ é«˜ç½®ä¿¡åº¦é€‰æ‹©ï¼

**æ— éœ€Boundsç²¾ç¡®åŒ¹é…**ï¼šå› ä¸ºæ–‡æœ¬é”šç‚¹å·²ç»è¶³å¤Ÿå¼ºï¼ˆ3.5åˆ†ï¼‰ï¼ŒBoundsåªä½œä¸ºè¾…åŠ©éªŒè¯ã€‚

---

### åœºæ™¯2: éšè—åæ ‡çš„æ–‡æœ¬å…ƒç´ 

**XMLç»“æ„**:
```xml
<node bounds="[0,0][0,0]" text="éšè—æ ‡ç­¾" clickable="true">
  <!-- çˆ¶å®¹å™¨åæ ‡ä¸ºç©ºï¼Œä½†æœ‰å­å…ƒç´  -->
  <node bounds="[100,200][300,400]" text="å¯è§å†…å®¹" />
</node>
```

**è¯„åˆ†ä¼˜åŠ¿**:
- å­å…ƒç´ æ–‡æœ¬åŒ¹é… â†’ **+2.0åˆ†**
- BoundsåŒ¹é…è´¨é‡ä½ â†’ +0.1åˆ†ï¼ˆä¸å½±å“å†³ç­–ï¼‰
- æ€»åˆ†ï¼š**2.1åˆ†** â†’ ä»å¯æ­£ç¡®é€‰æ‹©

---

### åœºæ™¯3: å¤§å®¹å™¨åŒ…å«å°æŒ‰é’®

**XMLç»“æ„**:
```xml
<!-- ç”¨æˆ·ç‚¹é€‰äº†å¤–å±‚å¤§å®¹å™¨ -->
<node bounds="[0,0][1080,2400]" clickable="false">
  <node bounds="[100,1000][300,1200]" 
        clickable="true" 
        content-desc="ç›®æ ‡æŒ‰é’®">
    <node text="ç›®æ ‡" />
  </node>
</node>
```

**å¤„ç†æ–¹å¼**:
1. å‰ç«¯è¯†åˆ«ä¸ºä¸­å±‚å®¹å™¨
2. åç«¯è¯„åˆ†ï¼šå­å…ƒç´ "ç›®æ ‡"æ–‡æœ¬åŒ¹é… â†’ +2.0åˆ†
3. BoundsåŒ…å«å…³ç³»æ£€æµ‹ â†’ +0.2åˆ†ï¼ˆè¾…åŠ©ï¼‰
4. å¦‚éœ€è¦ï¼Œè°ƒç”¨ `find_clickable_children_in_bounds()` æŸ¥æ‰¾å†…éƒ¨å¯ç‚¹å‡»å…ƒç´ 

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: ç²¾ç¡®åŒ¹é…
```rust
#[test]
fn test_exact_match() {
    let user_bounds = "[45,1059][249,1263]";
    let candidate_bounds = "[45,1059][249,1263]";
    
    let result = BoundsMatcher::match_bounds(user_bounds, candidate_bounds);
    
    assert!(result.is_exact);
    assert_eq!(result.iou, 1.0);
    assert_eq!(result.match_quality, 1.0);
}
```

### æµ‹è¯•2: åŒ…å«å…³ç³»
```rust
#[test]
fn test_contained_match() {
    let user_bounds = "[45,1059][249,1263]";    // ç”¨æˆ·é€‰æ‹©ä¸­å±‚
    let candidate_bounds = "[0,1043][1080,1279]"; // å®é™…æ˜¯å¤–å±‚å®¹å™¨
    
    let result = BoundsMatcher::match_bounds(user_bounds, candidate_bounds);
    
    assert!(result.is_contained);  // ç”¨æˆ·boundsåœ¨å€™é€‰boundså†…
    assert!(result.match_quality > 0.5);
}
```

### æµ‹è¯•3: é«˜IOUåŒ¹é…
```rust
#[test]
fn test_high_iou_match() {
    let user_bounds = "[45,1059][249,1263]";
    let candidate_bounds = "[40,1055][245,1265]"; // è½»å¾®åç§»
    
    let result = BoundsMatcher::match_bounds(user_bounds, candidate_bounds);
    
    assert!(result.iou > 0.9);
    assert!(result.match_quality > 0.8);
}
```

---

## ğŸ“¦ æ¨¡å—åŒ–æ¶æ„

```
src-tauri/src/exec/v3/
â”œâ”€â”€ element_matching/
â”‚   â”œâ”€â”€ mod.rs                          â† æ¨¡å—å¯¼å‡º
â”‚   â”œâ”€â”€ bounds_matcher.rs               â† ğŸ†• NEW: Boundsæ™ºèƒ½åŒ¹é…
â”‚   â”œâ”€â”€ multi_candidate_evaluator.rs    â† å¢å¼ºï¼šç­–ç•¥æ„ŸçŸ¥è¯„åˆ†
â”‚   â”œâ”€â”€ xpath_matcher.rs
â”‚   â”œâ”€â”€ spatial_distance.rs
â”‚   â””â”€â”€ text_comparator.rs
â”‚
â””â”€â”€ helpers/
    â””â”€â”€ step_executor.rs                â† æ¥æ”¶å¹¶ä½¿ç”¨ç­–ç•¥æ ‡è®°
```

**å¯¼å‡ºå…³ç³»**:
```rust
// mod.rs
pub mod bounds_matcher;
pub use bounds_matcher::{BoundsMatcher, BoundsMatchResult, BoundsRect};
```

---

## ğŸ”§ é…ç½®ä¸è°ƒè¯•

### æ—¥å¿—çº§åˆ«
```rust
tracing::info!("ğŸ”¥ [ç­–ç•¥æ ‡è®°æå–] matching_strategy={:?}", matching_strategy);
tracing::info!("ğŸ”¥ [å­å…ƒç´ åŒ¹é…] ç­–ç•¥0æˆåŠŸ: çˆ¶å…ƒç´ content-descå®Œå…¨åŒ¹é…");
tracing::info!("ğŸ¯ [BoundsåŒ¹é…] IOU={:.2}, quality={:.2}", iou, quality);
tracing::info!("ğŸ”¥ [è¯„åˆ†æ€»ç»“] æ‰¾åˆ°å®Œç¾æ–‡æœ¬é”šç‚¹ï¼Œæ€»åˆ†: {:.2}", score);
```

### å…³é”®æŒ‡æ ‡
- `has_perfect_text_anchor`: æ˜¯å¦æ‰¾åˆ°å®Œç¾é”šç‚¹
- `match_quality`: BoundsåŒ¹é…è´¨é‡ [0.0, 1.0]
- `iou`: äº¤å¹¶æ¯” [0.0, 1.0]
- `is_contained`: æ˜¯å¦åŒ…å«å…³ç³»
- `total_score`: æœ€ç»ˆè¯„åˆ†

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… å‰ç«¯èƒ½è¯†åˆ«ä¸­å±‚æ— æ–‡æœ¬å®¹å™¨
- âœ… å‰ç«¯ç”ŸæˆåŒ…å«ç­–ç•¥æ ‡è®°çš„æ­¥éª¤å¡ç‰‡
- âœ… åç«¯æ¥æ”¶å¹¶è§£æç­–ç•¥æ ‡è®°
- âœ… åç«¯æ ¹æ®ç­–ç•¥åŠ¨æ€è°ƒæ•´è¯„åˆ†æƒé‡
- âœ… Boundsæ™ºèƒ½åŒ¹é…æ¨¡å—å®Œæ•´å®ç°
- âœ… å®Œç¾é”šç‚¹è¯†åˆ«é€»è¾‘å®Œå–„

### æ€§èƒ½æŒ‡æ ‡
- âœ… å­/çˆ¶å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…æ—¶ï¼Œè¯„åˆ† â‰¥ 2.0åˆ†
- âœ… å®Œç¾é”šç‚¹åœºæ™¯ä¸‹ï¼Œæ— éœ€ä¾èµ–Boundså³å¯æ­£ç¡®é€‰æ‹©
- âœ… Boundsæ¨¡ç³ŠåŒ¹é…ä½œä¸ºè¾…åŠ©ï¼Œä¸å½±å“æ ¸å¿ƒå†³ç­–
- âœ… IOUè®¡ç®—å‡†ç¡®ï¼ŒåŒ…å«å…³ç³»æ£€æµ‹æ­£ç¡®

### ä»£ç è´¨é‡
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼Œå•ä¸€èŒè´£
- âœ… å®Œæ•´çš„ç±»å‹å®šä¹‰å’Œæ¥å£
- âœ… è¯¦ç»†çš„æ–‡æ¡£æ³¨é‡Š
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒç®—æ³•
- âœ… è°ƒè¯•æ—¥å¿—å®Œå–„ï¼Œæ˜“äºæ’æŸ¥é—®é¢˜

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–
```rust
// ğŸ¯ æå‰ç»“æŸè¯„ä¼°ï¼šå®Œç¾é”šç‚¹+é«˜Boundsè´¨é‡æ—¶
if has_perfect_text_anchor && bounds_quality > 0.8 {
    return (score, reasons);  // æ— éœ€ç»§ç»­è¯„ä¼°å…¶ä»–é¡¹
}
```

### 2. ç¼“å­˜ä¼˜åŒ–
```rust
// ğŸ¯ ç¼“å­˜Boundsè§£æç»“æœ
thread_local! {
    static BOUNDS_CACHE: RefCell<HashMap<String, BoundsRect>> = ...;
}
```

### 3. ç­–ç•¥æ‰©å±•
```rust
// ğŸ¯ æ”¯æŒæ›´å¤šç­–ç•¥ç±»å‹
pub enum MatchingStrategy {
    DirectMatch,
    AnchorByChildOrParent,
    AnchorBySibling,       // ğŸ†• NEW: å…„å¼Ÿå…ƒç´ é”šç‚¹
    AnchorByContainer,     // ğŸ†• NEW: å®¹å™¨çº¦æŸ
    RegionBased,           // ğŸ†• NEW: åŒºåŸŸå®šä½
}
```

### 4. æ™ºèƒ½é™çº§
```rust
// ğŸ¯ å½“å®Œç¾é”šç‚¹å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨é™çº§åˆ°BoundsåŒ¹é…
if !has_perfect_match && has_good_bounds_match {
    // é™çº§é€»è¾‘...
}
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [Step 0-6æ™ºèƒ½ç­–ç•¥ç³»ç»Ÿå®Œæ•´æ¶æ„.md](./docs/æ¶æ„æ•´ç†/Step 0-6æ™ºèƒ½ç­–ç•¥ç³»ç»Ÿå®Œæ•´æ¶æ„.md)
- [å¯¹è¯8.md - æ™ºèƒ½è¯†åˆ«åŒ¹é…ç­–ç•¥éœ€æ±‚è¯´æ˜](./docs/xpathè¯´æ˜/å¯¹è¯8.md)
- [é€šè®¯å½•æŒ‰é’®è¯†åˆ«å¤±è´¥å®Œæ•´åˆ†æ.md](./docs/å•æ­¥ä¸è„šæœ¬/é€šè®¯å½•æŒ‰é’®è¯†åˆ«å¤±è´¥å®Œæ•´åˆ†æ.md)

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®æ–½å®Œæˆäº†**ä¸­å±‚æ— æ–‡æœ¬å®¹å™¨åŒ¹é…ç­–ç•¥**çš„å®Œæ•´æ¶æ„ï¼š

1. **å‰ç«¯æ™ºèƒ½è¯†åˆ«** - è‡ªåŠ¨æ£€æµ‹å¹¶æ ‡è®°ä¸­å±‚å®¹å™¨
2. **æ•°æ®ä¼ é€’åè®®** - å®Œæ•´çš„ç­–ç•¥æ ‡è®°å’Œé”šç‚¹ä¿¡æ¯
3. **Boundsæ™ºèƒ½åŒ¹é…** - IOUç®—æ³• + åŒ…å«å…³ç³»æ£€æµ‹
4. **ç­–ç•¥æ„ŸçŸ¥è¯„åˆ†** - æ ¹æ®ç­–ç•¥åŠ¨æ€è°ƒæ•´æƒé‡
5. **å®Œç¾é”šç‚¹ä¼˜å…ˆ** - å­/çˆ¶å…ƒç´ æ–‡æœ¬å®Œå…¨åŒ¹é…æ—¶ç›´æ¥é«˜åˆ†

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… æ–‡æœ¬é”šç‚¹å®Œå…¨åŒ¹é…æ—¶è·å¾—**2.0åˆ†**ï¼Œç¡®ä¿æ­£ç¡®é€‰æ‹©
- âœ… Boundsæ¨¡ç³ŠåŒ¹é…ä½œä¸ºè¾…åŠ©ï¼Œä¸å½±å“æ ¸å¿ƒå†³ç­–
- âœ… å¤„ç†éšè—åæ ‡ã€å¤§å®¹å™¨ç­‰ç‰¹æ®Šåœºæ™¯
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

**ç”¨æˆ·åœºæ™¯è¦†ç›–**ï¼š
- âœ… ä¸­å±‚æ— æ–‡æœ¬æŒ‰é’®ï¼ˆå¦‚"é€šè®¯å½•"ï¼‰
- âœ… çˆ¶å®¹å™¨content-descèšåˆå­æ–‡æœ¬
- âœ… å…„å¼Ÿå…ƒç´ æä¾›æ–‡æœ¬çº¿ç´¢
- âœ… è¿è¡Œæ—¶Boundså˜åŒ–å®¹é”™
- âœ… éšè—åæ ‡å…ƒç´ è¯†åˆ«
- âœ… å¤§å®¹å™¨åŒ…å«å°æŒ‰é’®

---

**å®æ–½æ—¥æœŸ**: 2025-01-28  
**å®æ–½äººå‘˜**: GitHub Copilot  
**å®¡æ ¸çŠ¶æ€**: âœ… å®Œæˆ

