# 结构匹配功能集成指南

## 📦 已完成组件

### 核心模块
- ✅ `src/modules/structural-matching/` - 完整的结构匹配模块
- ✅ `src/components/step-card/StructuralMatchingIntegration.tsx` - 集成组件
- ✅ `src/components/step-card/structural-matching-manager.tsx` - 全局管理器

### ActionSelector 增强
- ✅ 静态策略菜单添加子选项
  - 🏗️ 结构匹配
  - 🔧 XPath恢复

---

## 🚀 快速集成示例

### 方式1: 使用 Context（推荐）

在App根组件中包裹Provider：

```tsx
import { StructuralMatchingProvider } from '@/components/step-card/structural-matching-manager';

function App() {
  return (
    <StructuralMatchingProvider>
      {/* 你的应用组件 */}
    </StructuralMatchingProvider>
  );
}
```

在ActionSelector或步骤卡片中使用：

```tsx
import { useStructuralMatching } from '@/components/step-card/structural-matching-manager';

const { openStructuralMatching } = useStructuralMatching();

// 当用户点击"结构匹配"菜单项时
onClick: () => {
  openStructuralMatching({
    stepId: currentStepId,
    selectedElement: currentSelectedElement,
    initialConfig: stepData.structuralConfig,
    onSave: (config) => {
      // 保存配置到步骤数据
      updateStepData(stepId, {
        ...stepData,
        structuralConfig: config
      });
    }
  });
}
```

### 方式2: 直接使用组件

```tsx
import { StructuralMatchingIntegration } from '@/components/step-card/StructuralMatchingIntegration';

<StructuralMatchingIntegration
  stepId={step.id}
  selectedElement={selectedElement}
  initialConfig={step.structuralConfig}
  onSave={(config) => {
    updateStep(step.id, { structuralConfig: config });
  }}
  showTriggerButton={true}
  triggerButtonText="🏗️ 配置结构匹配"
/>
```

---

## 🔧 在ActionSelector中的集成点

文件：`src/components/step-card/ActionSelector.tsx`

### 当前状态
第637-639行已添加结构匹配子菜单项：

```tsx
children: [
  { key: 'structural_matching', label: '结构匹配', icon: '🏗️', desc: '基于元素结构相似度匹配' },
  { key: 'xpath_recovery', label: 'XPath恢复', icon: '🔧', desc: '智能恢复损坏的XPath' },
]
```

### 需要添加的代码

在第668行（`onClick: () => {`）添加逻辑：

```tsx
onClick: () => {
  if (sub.key === 'structural_matching') {
    // 需要从父组件传入的数据
    const { stepId, selectedElement, structuralConfig, onUpdateConfig } = props;
    
    openStructuralMatching({
      stepId,
      selectedElement,
      initialConfig: structuralConfig,
      onSave: onUpdateConfig
    });
  } else if (sub.key === 'xpath_recovery') {
    // XPath恢复逻辑（暂未实现）
    console.log('XPath恢复功能开发中');
  }
}
```

---

## 📝 步骤数据结构扩展

需要在步骤数据中添加 `structuralConfig` 字段：

```typescript
interface StepData {
  // ... 现有字段
  
  /**
   * 结构匹配配置（可选）
   */
  structuralConfig?: StructuralMatchingConfig;
}
```

---

## 🎯 执行流程

1. **配置阶段**
   - 用户选中元素
   - 点击"静态策略 → 结构匹配"
   - 配置字段权重、匹配模式、阈值
   - 保存到步骤数据

2. **执行阶段**
   - 执行引擎检测到 `structuralConfig` 存在
   - 调用后端Tauri命令 `evaluate_structural_match`
   - 传入配置和候选元素列表
   - 后端计算每个元素的结构相似度得分
   - 返回得分 ≥ 阈值的元素

---

## ⚡ 下一步TODO

### 高优先级
1. ✅ ActionSelector添加props：`stepId`, `selectedElement`, `structuralConfig`, `onUpdateConfig`
2. ✅ 在ActionSelector中集成 `useStructuralMatching` Hook
3. ⏳ 创建Tauri命令 `evaluate_structural_match`
4. ⏳ 在执行引擎中添加结构匹配分支逻辑

### 中优先级
5. ⏳ 添加配置预设模板（笔记卡片、视频卡片、直播卡片）
6. ⏳ 实现配置的导入导出
7. ⏳ 添加历史配置记录

### 低优先级
8. ⏳ 优化UI交互体验
9. ⏳ 添加更多评分规则选项
10. ⏳ 国际化支持

---

## 🧪 测试清单

- [ ] 打开结构匹配模态框
- [ ] 调整字段权重和匹配模式
- [ ] 实时预览评分变化
- [ ] 保存配置到步骤数据
- [ ] 重新打开模态框，配置正确加载
- [ ] 执行步骤时使用结构匹配
- [ ] 小红书笔记卡片实际测试

---

**当前进度**: 40% (前端完成，后端Tauri命令待实现，执行集成待完成)
